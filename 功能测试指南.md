# 鹅数通功能测试指南

**测试时间**: 2025年10月21日  
**测试版本**: v1.0.1（已部署）  
**测试重点**: 验证最新部署的3个云函数修复效果

---

## 🎯 测试目标

本次测试主要验证以下**关键修复**:

1. ✅ **currentBatchId undefined 错误修复**（production-entry）
2. ✅ **出栏批次过滤优化**（health-management）
3. ✅ **任务健康记录自动联动**（breeding-todo）

---

## 📋 测试前准备

### 1. 清除缓存（必须）⚠️

```
步骤：
1. 打开微信开发者工具
2. 点击菜单：工具 → 清除缓存 → 清除全部缓存
3. 关闭微信开发者工具
4. 重新打开微信开发者工具
5. 重新编译运行小程序
```

**为什么必须清除缓存？**
- 云函数已部署新版本
- 前端需要重新调用才能使用新逻辑
- 旧的数据缓存可能导致测试不准确

### 2. 准备测试数据

**测试批次信息**:
```
批次号: TEST-20251021（或自动生成）
品种: 狮头鹅
数量: 1000只
日龄: 1日龄
```

---

## 🧪 关键测试用例

### 测试 1：批次加载修复验证 ⭐⭐⭐

**目的**: 验证 currentBatchId undefined 错误已修复

**测试步骤**:
```
1. 清除缓存并重新启动小程序
2. 登录小程序
3. 点击底部 Tab "健康管理"
4. 观察页面加载情况
```

**预期结果** ✅:
- [ ] 页面正常加载，不出现白屏
- [ ] **不出现** "Setting data field "currentBatchId" to undefined is invalid" 错误
- [ ] 批次列表正常显示
- [ ] 如果有批次，显示第一个批次的健康数据
- [ ] 批次编号、品种、日龄、数量正确显示

**如果失败**:
```
1. 检查云开发控制台，确认 production-entry 已部署
2. 检查部署时间是否是最新的
3. 查看云函数日志是否有错误
4. 重新清除缓存后再试
```

---

### 测试 2：出栏批次过滤验证 ⭐⭐⭐

**目的**: 验证完全出栏的批次不再显示在健康页面

**测试步骤**:
```
步骤 1: 创建测试批次
1. 进入"生产管理" → "入栏登记"
2. 填写批次信息：
   - 批次号：TEST-EXIT-001
   - 数量：500只
   - 品种：狮头鹅
   - 日龄：1日龄
3. 提交入栏记录

步骤 2: 部分出栏
1. 进入"生产管理" → "出栏登记"  
2. 选择批次：TEST-EXIT-001
3. 填写出栏数量：200只
4. 提交出栏记录
5. 进入"健康管理"页面
6. 检查批次是否显示

步骤 3: 完全出栏
1. 再次进入"生产管理" → "出栏登记"
2. 选择批次：TEST-EXIT-001
3. 填写出栏数量：300只（剩余全部）
4. 提交出栏记录
5. 进入"健康管理"页面
6. 检查批次是否显示
```

**预期结果** ✅:
- [ ] **部分出栏后**: 批次仍显示在健康页面
- [ ] 显示剩余数量：300只
- [ ] **完全出栏后**: 批次**不再显示**在健康页面
- [ ] 批次筛选器中也不包含该批次
- [ ] 出栏记录仍然保留（可在出栏记录列表查看）

**如果失败**:
```
可能原因1: health-management 云函数未部署
→ 检查云开发控制台部署状态

可能原因2: 出栏数量计算错误
→ 查看云函数日志，检查出栏数量累计逻辑

可能原因3: 缓存未清除
→ 重新清除缓存后再试
```

---

### 测试 3：任务健康记录自动联动验证 ⭐⭐⭐

**目的**: 验证完成疫苗任务时自动创建健康记录

**测试步骤**:
```
步骤 1: 创建新批次（如果没有）
1. 进入"生产管理" → "入栏登记"
2. 创建批次（1日龄）
3. 等待批次创建完成

步骤 2: 查看待办任务
1. 进入"养殖任务"页面
2. 选择刚创建的批次
3. 查看当前日龄的待办任务
4. 找到一个疫苗任务（例如："首次疫苗接种"）

步骤 3: 完成疫苗任务
1. 点击疫苗任务
2. 点击"完成任务"
3. 填写疫苗信息：
   - 疫苗名称：小鹅瘟疫苗
   - 接种数量：与批次数量一致
   - 接种方式：皮下注射
   - 兽医姓名：张兽医
   - 备注：（可选）
4. 提交

步骤 4: 验证健康记录
1. 进入"健康管理"页面
2. 查看该批次的健康记录列表
3. 查找最新的预防记录
```

**预期结果** ✅:
- [ ] 任务标记为已完成 ✅
- [ ] **自动创建**了一条预防类型的健康记录
- [ ] 健康记录内容包含：
  - 记录类型：预防（prevention）
  - 疫苗名称：小鹅瘟疫苗
  - 接种数量：与填写的数量一致
  - 操作人：当前用户
  - 关联任务ID：存在且正确
- [ ] 记录标记为自动创建：`autoCreated: true`
- [ ] 创建来源：`creationSource: 'task'`
- [ ] 设置了7天后的跟进提醒

**如果失败**:
```
可能原因1: breeding-todo 云函数未部署
→ 检查云开发控制台部署状态

可能原因2: 云函数执行错误
→ 查看云函数日志，检查 createVaccineRecord 函数

可能原因3: 数据库权限问题
→ 检查 health_records 集合权限设置
```

---

### 测试 4：完整业务流程测试 ⭐⭐

**目的**: 验证整个数据流转闭环

**测试步骤**:
```
流程: 入栏 → 任务 → 健康 → 出栏

1. 创建入栏记录
   - 批次号：FLOW-TEST-001
   - 数量：1000只
   - 品种：狮头鹅
   - 日龄：1日龄
   
2. 验证自动生成内容
   - 检查养殖任务：应该自动生成任务清单
   - 检查健康记录：应该有初始健康检查记录
   
3. 完成养殖任务
   - 完成一个疫苗任务
   - 验证自动创建健康记录
   
4. 手动添加健康记录
   - 添加一条健康检查记录
   - 填写患病、死亡数据
   
5. 查看健康统计
   - 健康率应该正确计算
   - 患病数、死亡数正确显示
   
6. 物料使用
   - 添加饲料使用记录
   - 关联到该批次
   
7. 创建出栏记录
   - 出栏500只
   - 验证存栏数量更新为500
   
8. 查看财务统计
   - 成本统计包含物料成本
   - 收入包含出栏收入
   
9. 完全出栏
   - 再出栏500只
   - 验证批次不再显示在健康页面
```

**预期结果** ✅:
- [ ] 每个步骤都成功完成
- [ ] 数据在各模块间正确流转
- [ ] 统计数据准确
- [ ] 完全出栏后批次正确过滤

---

## 📊 测试记录表

### 关键测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 批次加载（无 currentBatchId 错误） | ⬜ 通过 / ⬜ 失败 | |
| 出栏批次过滤（完全出栏不显示） | ⬜ 通过 / ⬜ 失败 | |
| 任务健康记录联动（自动创建） | ⬜ 通过 / ⬜ 失败 | |
| 完整业务流程 | ⬜ 通过 / ⬜ 失败 | |

### 发现的问题

| 问题ID | 问题描述 | 严重程度 | 是否需修复 |
|--------|----------|----------|------------|
| | | 高/中/低 | 是/否 |
| | | | |
| | | | |

---

## 🔍 调试技巧

### 1. 查看云函数日志

```
步骤：
1. 打开云开发控制台
   https://console.cloud.tencent.com/tcb
   
2. 点击"云函数" → 选择云函数名称
   
3. 点击"日志"标签
   
4. 查看最近的调用记录和错误信息
```

### 2. 微信开发者工具调试

```
步骤：
1. 打开"调试器"面板（Console）
   
2. 查看网络请求
   - 点击 Network 标签
   - 筛选 cloud.callFunction
   - 查看请求参数和响应
   
3. 查看 AppData
   - 点击 AppData 标签
   - 查看页面数据状态
```

### 3. 数据库数据验证

```
步骤：
1. 打开云开发控制台
   
2. 点击"数据库"
   
3. 选择相关集合查看数据
   - prod_batch_entries: 批次信息
   - health_records: 健康记录
   - prod_batch_exits: 出栏记录
   - breeding_tasks: 养殖任务
```

---

## ✅ 测试通过标准

### 最低标准（快速上线）

**必须通过**:
- [x] 批次加载无 currentBatchId 错误
- [x] 完全出栏批次不显示
- [x] 疫苗任务自动创建健康记录
- [x] 完整流程能走通

**可以接受的小问题**:
- UI显示细节问题（不影响功能）
- 性能略慢（但在可接受范围）
- 提示文案不完美

### 理想标准（完整测试）

**全部通过**:
- [x] 所有关键测试用例
- [x] 完整业务流程
- [x] 边界情况测试
- [x] 异常情况处理
- [x] 性能测试
- [x] 兼容性测试

---

## 📞 问题处理

### 如果所有测试都通过 ✅

**恭喜！可以进入下一阶段**:
1. 进行性能测试
2. 进行兼容性测试（iOS/Android）
3. 准备审核材料
4. 提交微信审核

### 如果发现问题 ⚠️

**处理流程**:
1. 记录问题详情（截图、日志）
2. 定位问题原因（前端/云函数/数据库）
3. 修复问题
4. 重新部署（如果是云函数问题）
5. 重新测试

**常见问题参考**: [部署指南.md](./部署指南.md) 的"问题排查"章节

---

## 🎉 测试完成后

**更新项目状态**:
- 更新测试清单
- 记录测试结果
- 标记完成的里程碑
- 规划下一步工作

**参考文档**:
- [测试清单.md](./测试清单.md) - 完整测试用例
- [下一步行动指南.md](./下一步行动指南.md) - 后续计划

---

**测试开始时间**: ________  
**测试完成时间**: ________  
**测试人员**: ________  
**测试结论**: ⬜ 通过 / ⬜ 需修复

---

**文档版本**: v1.0  
**最后更新**: 2025年10月21日

