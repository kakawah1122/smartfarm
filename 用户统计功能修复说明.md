# ç”¨æˆ·ç»Ÿè®¡åŠŸèƒ½ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·ç®¡ç†é¡µé¢é¡¶éƒ¨çš„ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºçš„æ•°æ®éƒ½æ˜¯ 0ï¼Œæ²¡æœ‰æ­£ç¡®ç»Ÿè®¡ï¼š
- æ€»ç”¨æˆ·æ•°ï¼š0ï¼ˆå®é™…åº”è¯¥æ˜¾ç¤º1ï¼‰
- æ´»è·ƒç”¨æˆ·ï¼š0ï¼ˆå®é™…åº”è¯¥æ˜¾ç¤º1ï¼‰
- ç®¡ç†å‘˜ï¼š0ï¼ˆå®é™…åº”è¯¥æ˜¾ç¤º1ï¼‰
- 30å¤©æ´»è·ƒï¼š0ï¼ˆå®é™…åº”è¯¥æ˜¾ç¤º1ï¼‰

## ğŸ” é—®é¢˜åŸå› 

å‰ç«¯è°ƒç”¨äº† `get_user_stats` æ¥å£ï¼Œä½†äº‘å‡½æ•°ä¸­**æ²¡æœ‰å®ç°è¿™ä¸ªåŠŸèƒ½**ï¼Œå¯¼è‡´ï¼š
1. äº‘å‡½æ•°è¿”å›é”™è¯¯æˆ–ç©ºæ•°æ®
2. å‰ç«¯æ— æ³•è·å–ç»Ÿè®¡æ•°æ®
3. ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤ºé»˜è®¤å€¼ 0

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ ç»Ÿè®¡æ¥å£

**æ–‡ä»¶ï¼š** `cloudfunctions/user-management/index.js`

åœ¨äº‘å‡½æ•°çš„ switch è¯­å¥ä¸­æ·»åŠ ï¼š

```javascript
case 'get_user_stats':
  return await getUserStats(event, wxContext)
```

### 2. å®ç°ç»Ÿè®¡åŠŸèƒ½

æ·»åŠ  `getUserStats` å‡½æ•°ï¼Œç»Ÿè®¡ä»¥ä¸‹æ•°æ®ï¼š

```javascript
async function getUserStats(event, wxContext) {
  const openid = wxContext.OPENID
  
  if (!await validateAdminPermission(openid)) {
    throw new Error('æ— æƒé™æŸ¥çœ‹ç”¨æˆ·ç»Ÿè®¡')
  }
  
  try {
    // 1. æ€»ç”¨æˆ·æ•°
    const totalUsersResult = await db.collection('wx_users').count()
    const totalUsers = totalUsersResult.total
    
    // 2. æ´»è·ƒç”¨æˆ·æ•°ï¼ˆçŠ¶æ€ä¸º activeï¼‰
    const activeUsersResult = await db.collection('wx_users')
      .where({ status: 'active' })
      .count()
    const activeUsers = activeUsersResult.total
    
    // 3. ç®¡ç†å‘˜æ•°é‡ï¼ˆåŒ…å«æ–°æ—§è§’è‰²ä½“ç³»ï¼‰
    const adminUsersResult = await db.collection('wx_users')
      .where({
        role: db.command.in(['manager', 'super_admin', 'admin'])
      })
      .count()
    const adminUsers = adminUsersResult.total
    
    // 4. 30å¤©å†…æ´»è·ƒçš„ç”¨æˆ·æ•°
    const thirtyDaysAgo = new Date()
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
    
    const recentActiveUsersResult = await db.collection('wx_users')
      .where({
        lastLoginTime: db.command.gte(thirtyDaysAgo)
      })
      .count()
    const recentActiveUsers = recentActiveUsersResult.total
    
    return {
      success: true,
      data: {
        totalUsers: totalUsers,
        activeUsers: activeUsers,
        adminUsers: adminUsers,
        recentActiveUsers: recentActiveUsers
      }
    }
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ç»Ÿè®¡å¤±è´¥:', error)
    // è¿”å›é»˜è®¤å€¼ï¼Œé¿å…é¡µé¢æŠ¥é”™
    return {
      success: true,
      data: {
        totalUsers: 0,
        activeUsers: 0,
        adminUsers: 0,
        recentActiveUsers: 0
      }
    }
  }
}
```

## ğŸ“Š ç»Ÿè®¡æŒ‡æ ‡è¯´æ˜

| æŒ‡æ ‡ | ç»Ÿè®¡é€»è¾‘ | è¯´æ˜ |
|------|---------|------|
| **æ€»ç”¨æˆ·æ•°** | `wx_users` é›†åˆçš„æ€»è®°å½•æ•° | åŒ…æ‹¬æ‰€æœ‰çŠ¶æ€çš„ç”¨æˆ· |
| **æ´»è·ƒç”¨æˆ·** | `status = 'active'` çš„ç”¨æˆ·æ•° | è´¦æˆ·çŠ¶æ€ä¸ºæ¿€æ´»çš„ç”¨æˆ· |
| **ç®¡ç†å‘˜** | `role` ä¸º `manager`ã€`super_admin`ã€`admin` çš„ç”¨æˆ·æ•° | åŒ…å«æ–°æ—§è§’è‰²ä½“ç³»çš„ç®¡ç†ç±»è§’è‰² |
| **30å¤©æ´»è·ƒ** | `lastLoginTime` åœ¨æœ€è¿‘30å¤©å†…çš„ç”¨æˆ·æ•° | æœ€è¿‘30å¤©æœ‰ç™»å½•è®°å½•çš„ç”¨æˆ· |

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šå¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼ˆæ¨èï¼‰

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. æ‰¾åˆ° `cloudfunctions/user-management` æ–‡ä»¶å¤¹
3. å³é”®ç‚¹å‡»è¯¥æ–‡ä»¶å¤¹
4. é€‰æ‹© **"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"**
5. ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œéƒ¨ç½²

```bash
# è¿›å…¥äº‘å‡½æ•°ç›®å½•
cd cloudfunctions/user-management

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
npm install

# ä½¿ç”¨ wx-server-sdk éƒ¨ç½²
# ï¼ˆéœ€è¦å…ˆé…ç½®å¥½å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼‰
```

## ğŸ” éªŒè¯æ­¥éª¤

éƒ¨ç½²å®Œæˆåï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤éªŒè¯ï¼š

1. **æ‰“å¼€å°ç¨‹åº**
   - ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•

2. **è¿›å…¥ç”¨æˆ·ç®¡ç†**
   - ä¸ªäººä¸­å¿ƒ â†’ äººå‘˜ç®¡ç†

3. **æ£€æŸ¥ç»Ÿè®¡æ•°æ®**
   - âœ… æ€»ç”¨æˆ·æ•°ï¼šåº”è¯¥æ˜¾ç¤º 1ï¼ˆæˆ–å®é™…ç”¨æˆ·æ•°ï¼‰
   - âœ… æ´»è·ƒç”¨æˆ·ï¼šåº”è¯¥æ˜¾ç¤º 1ï¼ˆå¦‚æœä½ çš„è´¦æˆ·æ˜¯ active çŠ¶æ€ï¼‰
   - âœ… ç®¡ç†å‘˜ï¼šåº”è¯¥æ˜¾ç¤º 1ï¼ˆä½ æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼‰
   - âœ… 30å¤©æ´»è·ƒï¼šåº”è¯¥æ˜¾ç¤º 1ï¼ˆå¦‚æœæœ€è¿‘30å¤©ç™»å½•è¿‡ï¼‰

4. **æµ‹è¯•åˆ›å»ºæ–°ç”¨æˆ·**
   - ä½¿ç”¨é‚€è¯·ç åˆ›å»ºæ–°ç”¨æˆ·
   - è¿”å›ç”¨æˆ·ç®¡ç†é¡µé¢
   - ç¡®è®¤ç»Ÿè®¡æ•°æ®æ­£ç¡®å¢åŠ 

## ğŸ“ ç»Ÿè®¡æ•°æ®æ›´æ–°æ—¶æœº

ç»Ÿè®¡æ•°æ®åœ¨ä»¥ä¸‹æ—¶æœºæ›´æ–°ï¼š

| æ“ä½œ | æ›´æ–°çš„ç»Ÿè®¡ |
|------|-----------|
| é¡µé¢åŠ è½½ | æ‰€æœ‰ç»Ÿè®¡æ•°æ® |
| åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆä½¿ç”¨é‚€è¯·ç ï¼‰ | æ€»ç”¨æˆ·æ•° +1<br>æ´»è·ƒç”¨æˆ· +1 |
| ä¿®æ”¹ç”¨æˆ·è§’è‰²ä¸ºç®¡ç†å‘˜ | ç®¡ç†å‘˜ +1 |
| ä¿®æ”¹ç”¨æˆ·è§’è‰²ä¸ºæ™®é€šç”¨æˆ· | ç®¡ç†å‘˜ -1 |
| ç”¨æˆ·ç™»å½• | 30å¤©æ´»è·ƒï¼ˆå¦‚æœé¦–æ¬¡ç»Ÿè®¡åˆ°ï¼‰ |
| ç¦ç”¨ç”¨æˆ· | æ´»è·ƒç”¨æˆ· -1 |
| å¯ç”¨ç”¨æˆ· | æ´»è·ƒç”¨æˆ· +1 |

**æ³¨æ„ï¼š** ç»Ÿè®¡æ•°æ®ä¸æ˜¯å®æ—¶è‡ªåŠ¨æ›´æ–°çš„ï¼Œéœ€è¦åˆ·æ–°é¡µé¢æˆ–åˆ‡æ¢é€‰é¡¹å¡æ‰ä¼šé‡æ–°åŠ è½½ã€‚

## ğŸ¯ è§’è‰²ä½“ç³»å…¼å®¹

ç»Ÿè®¡åŠŸèƒ½åŒæ—¶æ”¯æŒæ–°æ—§è§’è‰²ä½“ç³»ï¼š

### ç®¡ç†å‘˜ç»Ÿè®¡åŒ…å«ï¼š
- âœ… `super_admin` - è¶…çº§ç®¡ç†å‘˜ï¼ˆæ–°ï¼‰
- âœ… `manager` - ç»ç†ï¼ˆæ–°ï¼‰
- âœ… `admin` - ç®¡ç†å‘˜ï¼ˆæ—§ï¼‰

### æ™®é€šç”¨æˆ·ç»Ÿè®¡åŒ…å«ï¼š
- âœ… `employee` - å‘˜å·¥ï¼ˆæ–°ï¼‰
- âœ… `veterinarian` - å…½åŒ»ï¼ˆæ–°ï¼‰
- âœ… `user` - æ™®é€šç”¨æˆ·ï¼ˆæ—§ï¼‰
- âœ… `operator` - æ“ä½œå‘˜ï¼ˆæ—§ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™è¦æ±‚

åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹ç”¨æˆ·ç»Ÿè®¡æ•°æ®ï¼š
- âœ… è¶…çº§ç®¡ç†å‘˜ï¼ˆsuper_adminï¼‰
- âœ… ç»ç†ï¼ˆmanagerï¼‰
- âœ… æ—§çš„ç®¡ç†å‘˜ï¼ˆadminï¼‰
- âŒ å‘˜å·¥ï¼ˆemployeeï¼‰
- âŒ å…½åŒ»ï¼ˆveterinarianï¼‰

### 2. æ€§èƒ½è€ƒè™‘

å½“ç”¨æˆ·æ•°é‡è¾ƒå¤§æ—¶ï¼ˆ>1000ï¼‰ï¼Œç»Ÿè®¡æŸ¥è¯¢å¯èƒ½è¾ƒæ…¢ï¼š
- å»ºè®®æ·»åŠ ç´¢å¼•ï¼š`status`ã€`role`ã€`lastLoginTime`
- è€ƒè™‘ä½¿ç”¨ç¼“å­˜æœºåˆ¶
- å¯ä»¥è®¾ç½®å®šæ—¶ä»»åŠ¡é¢„è®¡ç®—ç»Ÿè®¡æ•°æ®

### 3. æ•°æ®å­—æ®µä¾èµ–

ç»Ÿè®¡åŠŸèƒ½ä¾èµ–ä»¥ä¸‹å­—æ®µï¼š
- `status` - ç”¨æˆ·çŠ¶æ€ï¼ˆå¿…éœ€ï¼‰
- `role` - ç”¨æˆ·è§’è‰²ï¼ˆå¿…éœ€ï¼‰
- `lastLoginTime` - æœ€åç™»å½•æ—¶é—´ï¼ˆå¯é€‰ï¼Œ30å¤©æ´»è·ƒç»Ÿè®¡éœ€è¦ï¼‰

### 4. é”™è¯¯å¤„ç†

å¦‚æœç»Ÿè®¡æŸ¥è¯¢å¤±è´¥ï¼š
- å‡½æ•°ä¼šæ•è·é”™è¯¯å¹¶è®°å½•æ—¥å¿—
- è¿”å›é»˜è®¤å€¼ 0ï¼Œé¿å…é¡µé¢å´©æºƒ
- ç”¨æˆ·å¯ä»¥åˆ·æ–°é¡µé¢é‡è¯•

## ğŸ”§ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

ä¸ºäº†æå‡ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½ï¼Œå»ºè®®åœ¨äº‘æ•°æ®åº“ä¸­åˆ›å»ºç´¢å¼•ï¼š

### åœ¨å¾®ä¿¡äº‘å¼€å‘æ§åˆ¶å°æ“ä½œï¼š

1. è¿›å…¥"äº‘å¼€å‘" â†’ "æ•°æ®åº“"
2. é€‰æ‹© `wx_users` é›†åˆ
3. ç‚¹å‡»"ç´¢å¼•ç®¡ç†"
4. æ·»åŠ ä»¥ä¸‹ç´¢å¼•ï¼š

| å­—æ®µå | ç´¢å¼•ç±»å‹ | è¯´æ˜ |
|--------|---------|------|
| `status` | å•å­—æ®µç´¢å¼• | ä¼˜åŒ–æ´»è·ƒç”¨æˆ·ç»Ÿè®¡ |
| `role` | å•å­—æ®µç´¢å¼• | ä¼˜åŒ–ç®¡ç†å‘˜ç»Ÿè®¡ |
| `lastLoginTime` | å•å­—æ®µç´¢å¼• | ä¼˜åŒ–30å¤©æ´»è·ƒç»Ÿè®¡ |

**åˆ›å»ºå‘½ä»¤ï¼ˆäº‘å‡½æ•°æ–¹å¼ï¼‰ï¼š**

```javascript
// åœ¨äº‘å‡½æ•°ä¸­æ‰§è¡Œï¼ˆä»…éœ€æ‰§è¡Œä¸€æ¬¡ï¼‰
await db.collection('wx_users').createIndex({
  name: 'status_index',
  fields: [{ fieldName: 'status', direction: '1' }]
})

await db.collection('wx_users').createIndex({
  name: 'role_index',
  fields: [{ fieldName: 'role', direction: '1' }]
})

await db.collection('wx_users').createIndex({
  name: 'lastLoginTime_index',
  fields: [{ fieldName: 'lastLoginTime', direction: '-1' }]
})
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç»Ÿè®¡æ•°æ®ä»ç„¶æ˜¾ç¤º 0

**å¯èƒ½åŸå› ï¼š**
- äº‘å‡½æ•°æœªé‡æ–°éƒ¨ç½²
- ç”¨æˆ·æ•°æ®åº“å­—æ®µç¼ºå¤±
- æƒé™ä¸è¶³

**è§£å†³æ–¹æ³•ï¼š**
1. ç¡®è®¤äº‘å‡½æ•°å·²éƒ¨ç½²æˆåŠŸ
2. æ£€æŸ¥äº‘å‡½æ•°æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
3. ç¡®è®¤ç”¨æˆ·è®°å½•æœ‰ `status` å’Œ `role` å­—æ®µ
4. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•

### é—®é¢˜2ï¼š30å¤©æ´»è·ƒæ˜¾ç¤º 0

**å¯èƒ½åŸå› ï¼š**
- ç”¨æˆ·è®°å½•æ²¡æœ‰ `lastLoginTime` å­—æ®µ
- `lastLoginTime` æ ¼å¼ä¸æ­£ç¡®

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ç”¨æˆ·è®°å½•æ˜¯å¦æœ‰ `lastLoginTime` å­—æ®µ
2. ç¡®ä¿ç™»å½•æ—¶æ›´æ–° `lastLoginTime`ï¼š
```javascript
await db.collection('wx_users')
  .where({ _openid: openid })
  .update({
    data: {
      lastLoginTime: new Date()
    }
  })
```

### é—®é¢˜3ï¼šç®¡ç†å‘˜ç»Ÿè®¡ä¸æ­£ç¡®

**å¯èƒ½åŸå› ï¼š**
- è§’è‰²å€¼ä¸åœ¨ç»Ÿè®¡èŒƒå›´å†…
- æ•°æ®åº“ä¸­è§’è‰²å­—æ®µæ‹¼å†™é”™è¯¯

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥ç”¨æˆ·çš„ `role` å­—æ®µå€¼
2. ç¡®è®¤æ˜¯å¦ä¸ºï¼š`super_admin`ã€`manager` æˆ– `admin`
3. å¦‚æœ‰å…¶ä»–ç®¡ç†ç±»è§’è‰²ï¼Œæ·»åŠ åˆ°ç»Ÿè®¡æŸ¥è¯¢ä¸­

## ğŸ“Š é¢„æœŸç»“æœ

ä¿®å¤åï¼Œç»Ÿè®¡å¡ç‰‡åº”è¯¥æ˜¾ç¤ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1      1      1      1             â”‚
â”‚æ€»ç”¨æˆ·æ•° æ´»è·ƒç”¨æˆ· ç®¡ç†å‘˜  30å¤©æ´»è·ƒ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **æ€»ç”¨æˆ·æ•° = 1**ï¼šä½ çš„è¶…çº§ç®¡ç†å‘˜è´¦æˆ·
- **æ´»è·ƒç”¨æˆ· = 1**ï¼šè´¦æˆ·çŠ¶æ€ä¸º active
- **ç®¡ç†å‘˜ = 1**ï¼šä½ æ˜¯è¶…çº§ç®¡ç†å‘˜
- **30å¤©æ´»è·ƒ = 1**ï¼šæœ€è¿‘ç™»å½•è¿‡ï¼ˆå¦‚æœæœ‰ lastLoginTime è®°å½•ï¼‰

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¿®å¤å®ç°äº†å®Œæ•´çš„ç”¨æˆ·ç»Ÿè®¡åŠŸèƒ½ï¼š

âœ… **æ·»åŠ äº† `get_user_stats` æ¥å£**  
âœ… **å®ç°äº†4ä¸ªç»Ÿè®¡æŒ‡æ ‡çš„è®¡ç®—**  
âœ… **å…¼å®¹æ–°æ—§è§’è‰²ä½“ç³»**  
âœ… **åŒ…å«é”™è¯¯å¤„ç†æœºåˆ¶**  
âœ… **æ€§èƒ½ä¼˜åŒ–å»ºè®®**

éƒ¨ç½²åï¼Œç”¨æˆ·ç®¡ç†é¡µé¢çš„ç»Ÿè®¡æ•°æ®å°†æ­£ç¡®æ˜¾ç¤ºï¼

---

*ä¿®å¤æ—¶é—´ï¼š2025-11-06*  
*ç‰ˆæœ¬ï¼šv1.0*

