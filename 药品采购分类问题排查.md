# 药品采购分类问题排查指南

## 用户问题

用户发现财务记录中有两条看起来一样的记录：
1. **其他费用** - 药品采购 - 浆膜清 - 供应商 - 2件 - ¥240
2. **治疗用药** - 浆膜清 - 治疗 - 2件 - ¥240

## 问题分析

### 1. 这两条记录不是重复

这是正常的业务流程，记录了药品从采购到使用的完整链路：

```
采购阶段（现金流）：买药 → 花钱240元 → 记录"药品采购"
   ↓
库存阶段：药品入库，等待使用
   ↓
使用阶段（成本确认）：治疗用药 → 消耗2件 → 记录"治疗用药"
```

**类比**：
- 您去超市买了一袋米（采购），花了50元
- 回家煮饭用了这袋米（使用），成本50元
- 这两个事件都要记录，但不是重复

### 2. 成本不会重复计算

虽然财务记录列表显示两条，但在**成本统计**时：

#### 在 `getCostBreakdownByDateRange`（成本分解统计）中：
```javascript
// cloudfunctions/finance-management/reimbursement-handler.js 第845-895行
if (category === '药品' || category === 'medicine' || category === '营养品') {
  // 药品采购不计入成本分解统计，避免与治疗用药重复计算
  // breakdown.medicalCost += amount  // 已注释，避免重复计算
}
```

**结果**：
- ❌ 采购记录：不计入medicalCost
- ✅ 使用记录：计入medicalCost

#### 在 `getCostSumByDateRange`（总成本统计）中：
- 这个函数统计的是**现金流**，需要包含所有支出（包括采购）

### 3. 问题：药品采购被归类为"其他费用"

**正确的分类**：
- 应该显示为：**医疗费用** - 药品采购 - 浆膜清...
- 实际显示为：**其他费用** - 药品采购 - 浆膜清... ❌

## 问题原因

后端代码逻辑是正确的（`finance-management/index.js` 第1084-1089行）：
```javascript
const category = material.data.category || material.data.type || ''
if (category === '饲料') {
  costType = 'feed'
} else if (category === '药品' || category === 'medicine' || category === '营养品') {
  costType = 'health'  // 应该被设置为health
}
```

但实际显示为"其他费用"，说明：
1. **数据库中的category字段值不对**
2. 或者查询materialId失败了

## 排查步骤

### 步骤1：检查物料信息

在微信开发者工具的数据库中，查询 `prod_materials` 集合：

```javascript
db.collection('prod_materials')
  .where({ name: '浆膜清' })
  .get()
```

**检查返回的数据**：
```javascript
{
  "_id": "...",
  "name": "浆膜清",
  "category": "???",  // ← 检查这个字段的值是什么
  "unitPrice": 120,
  ...
}
```

**可能的问题**：
- ❌ `category: "其他"` - 不对！
- ❌ `category: "药物"` - 不对！（应该是"药品"）
- ❌ `category: "Medicine"` - 首字母大写，不匹配！
- ❌ `category: undefined` 或没有这个字段
- ✅ `category: "药品"` - 正确
- ✅ `category: "medicine"` - 正确
- ✅ `category: "营养品"` - 正确

### 步骤2：检查采购记录

查询 `prod_material_records` 集合：

```javascript
db.collection('prod_material_records')
  .where({ 
    type: 'purchase',
    materialId: '上一步查到的_id'
  })
  .get()
```

**检查**：
- `materialId` 字段是否正确
- `category` 字段（如果有）的值是什么

### 步骤3：修复数据

如果发现 `category` 字段值不对，需要修复：

```javascript
// 在数据库管理工具中执行
db.collection('prod_materials')
  .where({ name: '浆膜清' })
  .update({
    data: {
      category: '药品'  // 修改为正确的值
    }
  })
```

### 步骤4：重新部署云函数

修复数据后，重新部署云函数让修复生效：

在微信开发者工具中：
1. 右键 `cloudfunctions/finance-management`
2. 选择"上传并部署：云端安装依赖"

### 步骤5：测试

1. 清除小程序缓存
2. 重新进入财务记录页面
3. 检查"药品采购"是否正确显示为"医疗费用"

## 前端分类逻辑

前端的类型映射（`miniprogram/packageFinance/finance/finance.ts` 第464-470行）：

```typescript
const typeMap: any = {
  'feed': '饲料成本',
  'health': '医疗费用',  // ← 后端应该返回这个
  'labor': '其他费用',
  'facility': '设施成本',
  'other': '其他费用',   // ← 现在返回的是这个
  'loss': '损失费用',
  'death_loss': '死亡损失',
  'treatment': '治疗用药'
}
```

## 标准的物料分类值

为了确保正确识别，物料的 `category` 字段应该使用以下标准值：

| 分类 | category值 | 说明 |
|------|-----------|------|
| 饲料 | `饲料` | 全小程序统一使用 |
| 药品 | `药品` 或 `medicine` 或 `营养品` | 三个值都可以识别 |
| 其他 | `其他` | 或其他任意值，都会归为"其他费用" |

## 总结

1. **两条记录不是重复**：
   - 采购记录 = 现金流（什么时候花钱）
   - 使用记录 = 成本确认（什么时候用掉）

2. **成本不会重复计算**：
   - 在成本统计中，药品采购已被排除
   - 只有治疗用药才计入成本

3. **分类显示错误**：
   - 需要检查数据库中 `prod_materials` 集合的 `category` 字段
   - 确保药品的category值为 `"药品"`、`"medicine"` 或 `"营养品"`

4. **修复步骤**：
   - 查询数据库 → 修复category字段 → 重新部署云函数 → 测试

## 建议改进

### 1. 在前端添加category验证

在物料管理页面，创建/编辑物料时，使用下拉选择而不是手动输入category：

```javascript
const categoryOptions = [
  { label: '饲料', value: '饲料' },
  { label: '药品', value: '药品' },
  { label: '营养品', value: '营养品' },
  { label: '其他', value: '其他' }
]
```

### 2. 在财务记录中显示来源

修改显示格式，让用户更容易区分：

```
医疗费用
├─ 💰 药品采购 - 浆膜清 - 2件 - ¥240 (现金流)
└─ 💊 治疗用药 - 浆膜清 - 2件 - ¥240 (成本确认)
```

### 3. 添加数据库索引

确保 `prod_materials` 集合有 `category` 索引：

```javascript
db.collection('prod_materials').createIndex({
  keys: { category: 1 }
})
```

