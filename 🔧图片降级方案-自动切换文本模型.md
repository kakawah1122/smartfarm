# 🔧 图片降级方案 - 自动切换文本模型

## 🔍 新问题发现

根据最新日志，发现了两个关键问题：

### 1. 图片下载失败
```
方法1下载失败: downloadFile:fail -503003 storage file not exists.
获得临时链接: (null)
错误: Cannot read properties of null (reading 'replace')
```

**原因分析**：
- 云存储中的图片文件不存在（可能已过期或被删除）
- `getTempFileURL`返回null
- axios尝试访问null URL导致错误

### 2. GLM-4V-Flash不支持纯文本
```
包含图片: false
错误码: 1210 "API调用参数有误"
```

**原因分析**：
- GLM-4V-Flash是**视觉专用模型**
- 不支持无图片的纯文本调用
- 即使图片处理失败，仍尝试用视觉模型调用

## ✅ 解决方案

### 智能降级策略

```
有图片 → health_diagnosis_vision → GLM-4V-Flash（视觉模型）
                ↓ 
           图片处理失败
                ↓
      自动切换任务类型和模型
                ↓
无图片 → health_diagnosis → SiliconFlow-Qwen（文本模型）
```

## 📝 代码修改

### 1. 图片处理失败检测

```javascript
if (images && images.length > 0) {
  try {
    processedMessages = await manager.processMessagesWithImages(messages, images, modelsToTry[0])
    
    // ✅ 检查是否真的包含了图片
    const hasImageContent = processedMessages.some(msg => 
      Array.isArray(msg.content) && 
      msg.content.some(item => item.type === 'image_url')
    )
    
    if (hasImageContent) {
      usedVision = true
      console.log('图片处理完成，已加入消息')
    } else {
      // ⚠️ 图片处理失败，自动降级
      console.warn('⚠️ 图片处理失败，降级为纯文本诊断')
      actualTaskType = 'health_diagnosis'  // 切换任务类型
      // 重新获取纯文本模型配置
      const textModelMapping = TASK_MODEL_MAPPING[actualTaskType]
      modelsToTry.length = 0  // 清空原来的视觉模型
      modelsToTry.push(textModelMapping.primary)  // siliconflow-qwen
      modelsToTry.push(...textModelMapping.fallback)  // glm-4-free, deepseek-chat
    }
  } catch (error) {
    // 同样的降级处理
  }
}
```

### 2. 增强错误检查

```javascript
// 检查临时URL是否有效
if (!tempURL) {
  throw new Error(`获取临时链接失败: ${fileInfo.errmsg || '未知错误'}`)
}
```

## 🚀 部署步骤

### 1. 上传云函数（必须）

在微信开发者工具中：

1. **打开项目** `/Users/kakawah/Documents/鹅数通`

2. **部署 ai-multi-model 云函数**：
   - 右键点击 `cloudfunctions/ai-multi-model` 文件夹
   - 选择 **"上传并部署：云端安装依赖"**
   - 等待上传完成（约1-2分钟）

### 2. 重新上传图片（建议）

之前上传的图片可能已过期，建议：

1. **清除旧图片**：点击图片右上角的删除按钮
2. **重新拍摄或选择图片**：
   - 确保图片清晰
   - 图片大小<500KB
   - 最多上传2张
3. **立即提交**：上传后尽快提交诊断

### 3. 测试流程

#### 场景1：正常的图片诊断
1. 上传1-2张新图片
2. 输入症状
3. 提交诊断
4. **预期**：使用GLM-4V-Flash成功诊断

#### 场景2：图片失败的降级诊断
1. 如果图片处理失败
2. **预期日志**：
```
⚠️ 图片处理失败，降级为纯文本诊断
切换任务类型: health_diagnosis_vision → health_diagnosis
使用纯文本模型: siliconflow-qwen, glm-4-free, deepseek-chat
尝试模型 1/3: siliconflow-qwen
```
3. **预期结果**：使用文本模型成功返回诊断

#### 场景3：纯文本诊断
1. 不上传图片
2. 只输入症状
3. **预期**：直接使用siliconflow-qwen文本模型

## 📊 预期效果

### 成功日志（带图片）
```
开始处理2张图片...
====== 开始处理图片 ======
图片格式策略: Base64 Data URI（智谱AI要求）
✅ 图片1 转换成功，大小: 245.6KB
✅ 图片2 转换成功，大小: 312.8KB
图片处理完成，已加入消息
尝试模型 1/1: glm-4v-flash
====== 调用智谱AI ======
包含图片: true
智谱AI调用成功!
```

### 成功日志（降级后）
```
开始处理2张图片...
所有图片处理失败，使用纯文本诊断
⚠️ 图片处理失败，降级为纯文本诊断
切换任务类型: health_diagnosis_vision → health_diagnosis
使用纯文本模型: siliconflow-qwen, glm-4-free, deepseek-chat
尝试模型 1/3: siliconflow-qwen
====== 调用 SiliconFlow API ======
包含图片: false
SiliconFlow API 调用成功!
```

## ⚠️ 图片文件过期问题

### 为什么图片会"不存在"？

可能的原因：
1. **测试时间跨度大**：几小时前上传的图片用于现在的测试
2. **云存储配置**：可能有文件生命周期策略
3. **FileID错误**：上传时记录的FileID与实际不符

### 建议的前端优化（可选）

**未来改进**：在前端检测图片是否仍然有效

```typescript
// 在提交前验证图片
async validateImages(fileIDs: string[]) {
  const result = await wx.cloud.getTempFileURL({
    fileList: fileIDs
  })
  
  const validImages = result.fileList.filter(item => 
    item.status === 0 && item.tempFileURL
  ).map(item => item.fileID)
  
  if (validImages.length < fileIDs.length) {
    wx.showToast({
      title: `${fileIDs.length - validImages.length}张图片已过期，请重新上传`,
      icon: 'none'
    })
  }
  
  return validImages
}
```

## 🎯 完成检查清单

- [x] 修复图片处理失败时的降级逻辑
- [x] 添加临时URL有效性检查
- [x] 实现自动切换任务类型和模型
- [ ] **待办**：在微信开发者工具中上传云函数
- [ ] **待办**：重新上传图片进行测试
- [ ] **待办**：验证两种场景（带图片 / 降级纯文本）

## 🔍 问题排查

### 如果仍然报错

1. **查看完整日志**：
   - 确认是否看到"降级为纯文本诊断"
   - 确认是否切换到了文本模型
   - 查看文本模型调用结果

2. **检查图片**：
   - 重新上传全新的图片
   - 立即提交，不要等待
   - 确认图片在云存储中确实存在

3. **测试纯文本模式**：
   - 暂时不上传图片
   - 只用文本症状测试
   - 确认基础功能正常

## 📚 技术细节

### 模型切换流程

```
初始状态: 
  taskType = 'health_diagnosis'
  images = [fileID1, fileID2]
  
↓ 检测到图片

actualTaskType = 'health_diagnosis_vision'
modelsToTry = ['glm-4v-flash']

↓ 处理图片

图片处理失败? → 是
  ↓
actualTaskType = 'health_diagnosis'  // ✅ 切换回去
modelsToTry = ['siliconflow-qwen', 'glm-4-free', 'deepseek-chat']  // ✅ 切换模型列表
  ↓
使用纯文本模型进行诊断
```

### 关键代码位置

- **降级逻辑**：`cloudfunctions/ai-multi-model/index.js` 第819-870行
- **图片下载**：`cloudfunctions/ai-multi-model/index.js` 第177-249行
- **任务映射**：`cloudfunctions/ai-multi-model/index.js` 第120-130行

---

**请立即部署云函数，然后重新上传图片测试！**

