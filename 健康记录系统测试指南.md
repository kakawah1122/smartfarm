# 健康记录系统测试指南

## 功能概述

健康记录系统已完整实现，具备以下核心功能：
1. **健康记录表单** - 添加生病记录、治疗手段、治愈或死亡结果
2. **死亡记录管理** - 自动创建死亡记录并计入存栏折损
3. **批次关联** - 基于已有存栏批次进行健康管理
4. **数据统计** - 健康率、死亡率、异常数量统计

## 测试流程

### 第一步：部署云函数
在微信开发者工具中：
1. 右键点击 `cloudfunctions/health-management` 文件夹
2. 选择"上传并部署（云端安装依赖）"
3. 等待部署完成

### 第二步：创建测试数据
确保你有一些入栏记录作为测试基础：
1. 进入"生产管理" → "入栏管理"
2. 点击"新增入栏记录"创建几个测试批次
3. 记录批次号，用于健康记录测试

### 第三步：测试健康记录功能

#### 3.1 基本健康记录
1. 进入"健康管理"页面
2. 点击"新增健康记录"按钮
3. 填写表单：
   - **选择批次**：选择已有的存栏批次
   - **记录日期**：选择今天或任意日期
   - **位置**：输入"1号鹅舍"
   - **受影响数量**：输入"5"（小于批次总数）
   - **症状描述**：可使用快速标签或手动输入
   - **严重程度**：选择合适级别
   - **治疗方案**：可使用快速按钮或手动输入
   - **治疗结果**：先选择"治疗中"
4. 点击"提交健康记录"

#### 3.2 治愈记录测试
1. 创建一个健康记录，治疗结果选择"已治愈"
2. 提交后查看健康页面统计数据更新

#### 3.3 死亡记录测试（关键功能）
1. 创建新的健康记录
2. **治疗结果选择"死亡"**
3. 系统会显示"死亡数量"字段
4. 输入死亡数量（如：2羽）
5. 提交记录
6. **验证结果**：
   - 健康页面应显示新的健康记录
   - 异常个体数量应增加
   - 进入"生产管理"页面查看存栏数量是否减少

### 第四步：验证存栏数量计算

#### 4.1 计算逻辑验证
假设原有批次：100羽
- 创建死亡记录：5羽死亡
- 生产页面存栏应显示：95羽

#### 4.2 多次死亡测试
1. 对同一批次创建多个死亡记录
2. 验证存栏数量累计扣减
3. 确保不会出现负数

### 第五步：数据统计验证

#### 5.1 健康页面统计
检查以下数据是否正确：
- **健康率**：应根据实际情况计算
- **异常个体**：所有受影响鹅只的总数
- **本月记录**：当月健康记录总数

#### 5.2 生产页面存栏
确认"入栏管理"中的存栏数量已扣除死亡数量

## 测试场景示例

### 场景1：完整的病症处理流程
```
1. 批次：QY-20241215（白鹅苗，100羽）
2. 第1天：发现10羽食欲不振 → 创建健康记录（治疗中）
3. 第3天：其中2羽死亡 → 创建死亡记录
4. 第7天：剩余8羽治愈 → 更新为治愈状态
5. 最终：存栏减少2羽，健康记录完整
```

### 场景2：批量死亡处理
```
1. 批次：QY-20241214（灰鹅苗，50羽）
2. 严重疫病：30羽受影响，15羽死亡
3. 系统应正确：
   - 记录健康问题
   - 创建死亡记录
   - 扣减存栏数量（50→35）
```

## 常见问题解决

### Q1: 批次列表为空
**原因**：没有活跃的存栏批次
**解决**：先创建入栏记录，确保有正数存栏

### Q2: 存栏数量未更新
**原因**：云函数未正确部署或数据库权限问题
**解决**：
1. 重新部署health-management云函数
2. 重新部署production-dashboard云函数
3. 检查云数据库权限

### Q3: 死亡数量超出限制
**系统自动验证**：
- 死亡数量不能超过受影响数量
- 死亡数量不能超过批次剩余存栏
- 数值必须为正数

## 数据库结构

系统会自动创建以下集合：

### health_records（健康记录）
```json
{
  "_id": "H241215001",
  "batchNumber": "QY-20241215",
  "recordDate": "2024-12-15",
  "location": "1号鹅舍",
  "affectedCount": 5,
  "symptoms": "食欲不振、精神萎靡",
  "severity": "mild",
  "treatment": "隔离观察、抗生素治疗",
  "result": "death",
  "deathCount": 2,
  "createTime": "2024-12-15T10:30:00Z"
}
```

### death_records（死亡记录）
```json
{
  "_id": "D241215001",
  "healthRecordId": "H241215001",
  "batchNumber": "QY-20241215", 
  "deathDate": "2024-12-15",
  "deathCount": 2,
  "deathReason": "食欲不振、精神萎靡",
  "createTime": "2024-12-15T10:30:00Z"
}
```

## 成功标准

✅ **功能完整性**：
- 能正常创建健康记录
- 死亡记录自动生成
- 存栏数量正确扣减

✅ **数据一致性**：
- 健康统计准确
- 生产页面数据同步
- 批次关联正确

✅ **用户体验**：
- 界面风格统一（TDesign）
- 表单验证完善
- 错误提示友好

## 后续优化建议

1. **批量操作**：支持一次性处理多个批次
2. **历史追溯**：查看批次完整的健康历史
3. **报表功能**：生成月度/季度健康报告
4. **预警系统**：死亡率超标自动提醒
5. **兽医建议**：集成专业治疗建议库

---

测试完成后，请反馈发现的任何问题，我会及时进行修复和优化。
