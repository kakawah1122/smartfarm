# æŠ¥é”€åŠŸèƒ½æ•°æ®åº“é…ç½®æŒ‡å—

## ğŸš¨ é—®é¢˜è¯Šæ–­

å¦‚æœæäº¤æŠ¥é”€ç”³è¯·æ—¶ä¸€ç›´æ˜¾ç¤º"æäº¤ä¸­"ï¼Œé€šå¸¸æ˜¯ä»¥ä¸‹åŸå› ï¼š

1. âŒ æ•°æ®åº“é›†åˆ `finance_cost_records` æœªåˆ›å»º
2. âŒ é›†åˆæƒé™é…ç½®ä¸æ­£ç¡®
3. âŒ ç¼ºå°‘å¿…è¦çš„ç´¢å¼•
4. âŒ äº‘å‡½æ•° `finance-management` æœªéƒ¨ç½²

---

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰

### æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“é›†åˆ

1. ç™»å½•[å¾®ä¿¡äº‘å¼€å‘æ§åˆ¶å°](https://console.cloud.tencent.com/)
2. é€‰æ‹©ä½ çš„ç¯å¢ƒ â†’ è¿›å…¥"æ•°æ®åº“"æ¨¡å—
3. ç‚¹å‡»"æ·»åŠ é›†åˆ"

#### åˆ›å»º `finance_cost_records` é›†åˆ

**é›†åˆåç§°**ï¼š`finance_cost_records`

**æƒé™è®¾ç½®**ï¼šé€‰æ‹©"æ‰€æœ‰ç”¨æˆ·å¯è¯»ã€åˆ›å»ºè€…å¯è¯»å†™"
- å…»æ®–åœºæˆå‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è´¢åŠ¡è®°å½•
- åªèƒ½ä¿®æ”¹è‡ªå·±åˆ›å»ºçš„è®°å½•
- æŠ¥é”€åŠŸèƒ½éœ€è¦æ‰€æœ‰å‘˜å·¥éƒ½èƒ½æäº¤

---

### æ­¥éª¤2ï¼šé…ç½®æ•°æ®åº“ç´¢å¼•

åœ¨ `finance_cost_records` é›†åˆä¸­ï¼Œç‚¹å‡»"ç´¢å¼•ç®¡ç†" â†’ "æ·»åŠ ç´¢å¼•"

#### ç´¢å¼•1ï¼šç”¨æˆ·æŠ¥é”€è®°å½•æŸ¥è¯¢
```json
{
  "_openid": 1,
  "isReimbursement": 1,
  "createTime": -1
}
```
- ç´¢å¼•åç§°ï¼š`idx_user_reimbursement`
- ç´¢å¼•å±æ€§ï¼šéå”¯ä¸€
- ç”¨é€”ï¼šå‘˜å·¥æŸ¥çœ‹è‡ªå·±çš„æŠ¥é”€è®°å½•

#### ç´¢å¼•2ï¼šå¾…å®¡æ‰¹æŠ¥é”€æŸ¥è¯¢
```json
{
  "isReimbursement": 1,
  "reimbursement.status": 1,
  "createTime": -1
}
```
- ç´¢å¼•åç§°ï¼š`idx_pending_reimbursement`
- ç´¢å¼•å±æ€§ï¼šéå”¯ä¸€
- ç”¨é€”ï¼šç®¡ç†å‘˜æŸ¥çœ‹å¾…å®¡æ‰¹çš„æŠ¥é”€åˆ—è¡¨

#### ç´¢å¼•3ï¼šæ—¥æœŸå’Œç±»å‹æŸ¥è¯¢
```json
{
  "date": 1,
  "recordType": 1,
  "isDeleted": 1
}
```
- ç´¢å¼•åç§°ï¼š`idx_date_type`
- ç´¢å¼•å±æ€§ï¼šéå”¯ä¸€
- ç”¨é€”ï¼šæŒ‰æ—¥æœŸèŒƒå›´ç»Ÿè®¡è´¢åŠ¡æ•°æ®

#### ç´¢å¼•4ï¼šç”¨æˆ·ç‰¹å®šçŠ¶æ€æŠ¥é”€
```json
{
  "_openid": 1,
  "reimbursement.status": 1,
  "createTime": -1
}
```
- ç´¢å¼•åç§°ï¼š`idx_user_status`
- ç´¢å¼•å±æ€§ï¼šéå”¯ä¸€
- ç”¨é€”ï¼šæŸ¥è¯¢ç”¨æˆ·ç‰¹å®šçŠ¶æ€çš„æŠ¥é”€

---

### æ­¥éª¤3ï¼šæ£€æŸ¥äº‘å‡½æ•°éƒ¨ç½²çŠ¶æ€

#### 3.1 åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š

1. æ‰“å¼€é¡¹ç›®
2. å³é”®ç‚¹å‡» `cloudfunctions/finance-management` æ–‡ä»¶å¤¹
3. é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
4. ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

#### 3.2 éªŒè¯éƒ¨ç½²ï¼š

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ äº‘å‡½æ•° â†’ æŸ¥çœ‹ `finance-management` æ˜¯å¦å­˜åœ¨

---

### æ­¥éª¤4ï¼šéªŒè¯é…ç½®æ˜¯å¦æˆåŠŸ

#### åœ¨å°ç¨‹åºä¸­æµ‹è¯•ï¼š

1. è¿›å…¥"ä¸ªäººä¸­å¿ƒ"
2. ç‚¹å‡»"æ–°å»ºæŠ¥é”€ç”³è¯·"
3. å¡«å†™è¡¨å•å¹¶æäº¤
4. å¦‚æœæˆåŠŸï¼Œåº”è¯¥æ˜¾ç¤º"æŠ¥é”€ç”³è¯·å·²æäº¤"

#### æŸ¥çœ‹æ•°æ®åº“éªŒè¯ï¼š

1. åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ `finance_cost_records`
2. åº”è¯¥èƒ½çœ‹åˆ°æ–°å¢çš„æŠ¥é”€è®°å½•
3. è®°å½•åº”åŒ…å«ï¼š
   - `recordType: 'reimbursement'`
   - `isReimbursement: true`
   - `reimbursement` å¯¹è±¡

---

## ğŸ“Š æ•°æ®ç»“æ„ç¤ºä¾‹

æŠ¥é”€è®°å½•åœ¨ `finance_cost_records` é›†åˆä¸­çš„ç»“æ„ï¼š

```javascript
{
  _id: "RMB1699123456789",
  _openid: "oABC123...",
  
  // åŸºç¡€è´¢åŠ¡å­—æ®µ
  costType: "other",
  amount: 200,
  description: "è´­ä¹°é¥²æ–™",
  date: "2025-11-06",
  operator: "å¼ ä¸‰",
  
  // æŠ¥é”€æ ‡è¯†
  recordType: "reimbursement",
  isReimbursement: true,
  
  // æŠ¥é”€è¯¦ç»†ä¿¡æ¯
  reimbursement: {
    type: "feed",              // æŠ¥é”€ç±»å‹ï¼šé¥²æ–™é‡‡è´­
    typeName: "é¥²æ–™é‡‡è´­",
    
    applicant: {
      openid: "oABC123...",
      name: "å¼ ä¸‰",
      role: "employee",
      phone: "138****8888"
    },
    
    status: "pending",         // çŠ¶æ€ï¼šå¾…å®¡æ‰¹
    approver: null,
    approvalTime: null,
    rejectionReason: null,
    
    vouchers: [                // å‡­è¯å›¾ç‰‡
      {
        fileId: "cloud://...",
        fileName: "å‡­è¯1.jpg",
        fileType: "image",
        uploadTime: "2025-11-06T10:30:00.000Z"
      }
    ],
    
    detail: "",                // è¯¦ç»†è¯´æ˜ï¼ˆå·²ç§»é™¤è¯¥å­—æ®µï¼‰
    remark: ""
  },
  
  createTime: "2025-11-06T10:30:00.000Z",
  updateTime: "2025-11-06T10:30:00.000Z",
  isDeleted: false
}
```

---

## ğŸ¯ æŠ¥é”€ç±»å‹é…ç½®ï¼ˆå…»æ®–åœºæ™¯ï¼‰

ç³»ç»Ÿå·²é…ç½®ä»¥ä¸‹æŠ¥é”€ç±»å‹ï¼š

| ä»£ç  | åç§° | è¯´æ˜ |
|------|------|------|
| `feed` | é¥²æ–™é‡‡è´­ | è´­ä¹°é¥²æ–™äº§ç”Ÿçš„è´¹ç”¨ |
| `medicine` | å…½è¯é‡‡è´­ | è´­ä¹°å…½è¯ã€æ¶ˆæ¯’å‰‚ç­‰è¯å“è´¹ç”¨ |
| `vaccine` | é˜²ç–«è´¹ç”¨ | ç–«è‹—æ¥ç§ã€é˜²ç–«æ£€æŸ¥ç­‰è´¹ç”¨ |
| `equipment` | è®¾å¤‡ç»´ä¿® | å…»æ®–è®¾å¤‡ç»´ä¿®ã€ä¿å…»è´¹ç”¨ |
| `transport` | è¿è¾“è´¹ç”¨ | è¿è¾“é¥²æ–™ã€ç¦½ç±»ç­‰äº§ç”Ÿçš„è´¹ç”¨ |
| `utilities` | æ°´ç”µè´¹ | å…»æ®–åœºæ°´ç”µè´¹ç”¨ |
| `labor` | åŠ³åŠ¡è´¹ç”¨ | ä¸´æ—¶å·¥ã€å¤–åŒ…æœåŠ¡ç­‰åŠ³åŠ¡è´¹ç”¨ |
| `other` | å…¶ä»–è´¹ç”¨ | å…¶ä»–ç±»å‹çš„æŠ¥é”€ |

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæäº¤æ—¶ä¸€ç›´æ˜¾ç¤º"æäº¤ä¸­"

**åŸå› **ï¼š
- é›†åˆæœªåˆ›å»º
- æƒé™é…ç½®é”™è¯¯
- äº‘å‡½æ•°æœªéƒ¨ç½²

**è§£å†³**ï¼šæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤1-3ä¾æ¬¡æ£€æŸ¥

---

### é—®é¢˜2ï¼šæç¤º"æ— æƒé™æ“ä½œ"

**åŸå› **ï¼šé›†åˆæƒé™è®¾ç½®é”™è¯¯

**è§£å†³**ï¼š
1. è¿›å…¥äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ `finance_cost_records`
2. ç‚¹å‡»"æƒé™è®¾ç½®"
3. é€‰æ‹©"æ‰€æœ‰ç”¨æˆ·å¯è¯»ã€åˆ›å»ºè€…å¯è¯»å†™"
4. ä¿å­˜

---

### é—®é¢˜3ï¼šæäº¤æˆåŠŸä½†æ‰¾ä¸åˆ°è®°å½•

**åŸå› **ï¼šæŸ¥è¯¢æ¡ä»¶ä¸æ­£ç¡®

**è§£å†³**ï¼š
åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢æ—¶ï¼Œä½¿ç”¨è¿‡æ»¤æ¡ä»¶ï¼š
```javascript
{
  "_openid": "å½“å‰ç”¨æˆ·openid",
  "isReimbursement": true
}
```

---

### é—®é¢˜4ï¼šç®¡ç†å‘˜çœ‹ä¸åˆ°å¾…å®¡æ‰¹æŠ¥é”€

**åŸå› **ï¼šç´¢å¼•æœªé…ç½®æˆ–æŸ¥è¯¢æ¡ä»¶é”™è¯¯

**è§£å†³**ï¼š
1. ç¡®è®¤ç´¢å¼•2å·²åˆ›å»º
2. æŸ¥è¯¢æ¡ä»¶ï¼š
```javascript
{
  "isReimbursement": true,
  "reimbursement.status": "pending"
}
```

---

## ğŸ“± éƒ¨ç½²äº‘å‡½æ•°å‘½ä»¤ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½¿ç”¨å‘½ä»¤è¡Œéƒ¨ç½²ï¼š

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/kaka/Documents/Sync/å°ç¨‹åº/é¹…æ•°é€š

# éƒ¨ç½²finance-managementäº‘å‡½æ•°
npx @cloudbase/cli functions:deploy finance-management
```

---

## âœ¨ å®Œæˆæ£€æŸ¥æ¸…å•

é…ç½®å®Œæˆåï¼Œè¯·é€é¡¹æ£€æŸ¥ï¼š

- [ ] åˆ›å»ºäº† `finance_cost_records` é›†åˆ
- [ ] æƒé™è®¾ç½®ä¸º"æ‰€æœ‰ç”¨æˆ·å¯è¯»ã€åˆ›å»ºè€…å¯è¯»å†™"
- [ ] åˆ›å»ºäº†4ä¸ªç´¢å¼•ï¼ˆidx_user_reimbursementã€idx_pending_reimbursementã€idx_date_typeã€idx_user_statusï¼‰
- [ ] éƒ¨ç½²äº† `finance-management` äº‘å‡½æ•°
- [ ] åœ¨å°ç¨‹åºä¸­æµ‹è¯•æäº¤æŠ¥é”€æˆåŠŸ
- [ ] åœ¨æ•°æ®åº“ä¸­èƒ½çœ‹åˆ°æ–°å¢çš„æŠ¥é”€è®°å½•

---

## ğŸ‰ é…ç½®å®Œæˆ

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼ŒæŠ¥é”€åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼

**é¢„è®¡é…ç½®æ—¶é—´**ï¼š10-15åˆ†é’Ÿ

---

## ç›¸å…³æ–‡æ¡£

- [æŠ¥é”€ç³»ç»Ÿæ•°æ®åº“è®¾è®¡](./docs/design/reimbursement-database-design.md)
- [æŠ¥é”€ç´¢å¼•é…ç½®](./docs/database/reimbursement-index-setup.md)
- [è´¢åŠ¡ç®¡ç†äº‘å‡½æ•°è®¾è®¡](./docs/design/finance-management-cloud-function.md)
- [æ•°æ®åº“å®Œæ•´é…ç½®æŒ‡å—](./DATABASE_CONFIG_GUIDE.md)

---

**æ›´æ–°æ—¶é—´**ï¼š2025å¹´11æœˆ6æ—¥  
**é€‚ç”¨é¡¹ç›®**ï¼šé¹…æ•°é€šæ™ºæ…§å…»é¹…å°ç¨‹åº

