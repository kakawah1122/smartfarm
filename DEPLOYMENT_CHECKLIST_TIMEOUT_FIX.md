# ⚡ AI诊断超时修复 - 快速部署清单

## 📅 部署时间
**2025-10-24**

---

## 🎯 本次修复内容

### 核心问题
- ❌ 前端显示 `ESOCKETTIMEDOUT` 超时错误
- ❌ 云函数虽然成功执行，但前端收不到结果
- ❌ 用户体验差，不知道任务是否还在处理

### 核心修复
- ✅ 调整云函数超时配置（ai-diagnosis: 5秒，process-ai-diagnosis: 60秒）
- ✅ 增强前端错误处理和日志
- ✅ 添加JSON解析兜底逻辑
- ✅ 优化超时错误提示

---

## ✅ 部署步骤（5分钟）

### 1️⃣ 部署云函数（3分钟）

在微信开发者工具中：

#### ai-diagnosis 云函数
```bash
1. 右键点击 cloudfunctions/ai-diagnosis
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成（约1分钟）
```

**验证：**
- ✅ 部署日志显示"部署成功"
- ✅ 配置信息显示 timeout: 5秒

---

#### process-ai-diagnosis 云函数
```bash
1. 右键点击 cloudfunctions/process-ai-diagnosis
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成（约1分钟）
```

**验证：**
- ✅ 部署日志显示"部署成功"
- ✅ 配置信息显示 timeout: 60秒

---

### 2️⃣ 编译前端代码（1分钟）

```bash
1. 点击微信开发者工具顶部的 "编译" 按钮
2. 确保编译成功，无错误提示
```

**验证：**
- ✅ 控制台无TypeScript编译错误
- ✅ 控制台无其他警告

---

### 3️⃣ 快速测试（1分钟）

#### 测试1：纯文本诊断（必测）
```bash
1. 进入 packageAI/ai-diagnosis 页面
2. 选择批次（如果需要）
3. 填写症状描述：例如"精神萎靡，腹泻，食欲不振"
4. 点击"开始诊断"
```

**预期结果：**
- ✅ 立即显示"诊断已提交，处理中..."（<2秒）
- ✅ 3-5秒后显示诊断结果
- ✅ 无超时错误

**如果失败：**
- 检查云函数是否正确部署
- 查看控制台日志
- 查看云函数调用日志

---

#### 测试2：图片诊断（可选）
```bash
1. 进入 packageAI/ai-diagnosis 页面
2. 点击上传图片，选择1-2张图片
3. 填写症状描述
4. 点击"开始诊断"
```

**预期结果：**
- ✅ 立即显示"诊断已提交..."（<2秒）
- ✅ 15-25秒后显示诊断结果
- ✅ 诊断结果包含图片分析
- ✅ 无超时错误

---

## 🔍 验证清单

### 云函数配置
- [ ] ai-diagnosis timeout = 5秒
- [ ] process-ai-diagnosis timeout = 60秒
- [ ] ai-diagnosis 部署成功
- [ ] process-ai-diagnosis 部署成功

### 前端功能
- [ ] 编译无错误
- [ ] 纯文本诊断正常
- [ ] 图片诊断正常
- [ ] 超时错误提示友好
- [ ] 日志输出详细

### 用户体验
- [ ] 提交诊断快速响应（<2秒）
- [ ] 轮询等待提示友好
- [ ] 诊断结果显示正确
- [ ] 错误提示清晰易懂

---

## 🐛 常见问题排查

### 问题1：前端仍然显示超时错误

**可能原因：**
- 云函数未正确部署
- 环境变量未配置
- 网络连接问题

**排查步骤：**
```bash
1. 查看微信开发者工具 → 云开发 → 云函数列表
2. 确认 ai-diagnosis 和 process-ai-diagnosis 部署时间为最新
3. 点击云函数查看超时配置
4. 查看控制台日志，确认调用的云函数名称
5. 检查通义千问 API Key 是否配置（QWEN_API_KEY）
```

---

### 问题2：诊断任务一直处于"处理中"

**可能原因：**
- process-ai-diagnosis 未被触发
- AI模型调用失败
- 数据库权限问题

**排查步骤：**
```bash
1. 查看云函数调用日志（微信开发者工具 → 云开发 → 云函数）
2. 查找 process-ai-diagnosis 的调用记录
3. 查看日志中的错误信息
4. 检查 health_ai_diagnosis 集合中任务的状态字段
5. 手动调用 process-ai-diagnosis 测试：
   wx.cloud.callFunction({
     name: 'process-ai-diagnosis',
     data: { diagnosisId: '任务ID' }
   })
```

---

### 问题3：诊断结果显示"格式错误"

**可能原因：**
- AI返回的不是标准JSON
- JSON解析失败
- 数据库字段类型不匹配

**排查步骤：**
```bash
1. 查看控制台日志中的 "结果类型" 和 "结果内容"
2. 查看云函数日志中AI返回的原始内容
3. 检查 process-ai-diagnosis 中的JSON解析逻辑
4. 检查数据库中 result 字段的实际内容
5. 如果是字符串，前端会自动尝试JSON.parse()
```

---

## 📊 性能指标

### 目标性能

| 操作 | 目标时间 | 当前状态 |
|------|----------|----------|
| 提交诊断任务 | <2秒 | ✅ 已优化 |
| 纯文本诊断 | 3-5秒 | ✅ 符合预期 |
| 图片诊断（qwen-vl-max） | 15-25秒 | ✅ 符合预期 |
| 图片诊断（qwen-vl-plus） | 10-15秒 | ✅ 符合预期 |
| 轮询间隔 | 1秒/次 | ✅ 配置正确 |
| 最大轮询次数 | 120次（2分钟） | ✅ 配置正确 |

---

### 成本控制

| 诊断类型 | 模型 | 成本/次 | 每日预算 | 每日可诊断次数 |
|----------|------|---------|----------|----------------|
| 纯文本（常规） | qwen-long | ~0.4分 | 10元 | 2500次 |
| 纯文本（复杂） | qwen-plus | ~0.8分 | 10元 | 1250次 |
| 图片诊断（顶级） | qwen-vl-max | ~1.5分 | 10元 | 666次 |
| 图片诊断（标准） | qwen-vl-plus | ~1分 | 10元 | 1000次 |

**混合场景（每日预算10元）：**
- 500次图片诊断（qwen-vl-max） + 1250次文本诊断（qwen-long）
- 或全部使用免费模型 qwen-long（100万tokens免费额度）

---

## 📱 用户操作指引

### 正常诊断流程

```
1. 进入AI诊断页面
   ↓
2. 选择批次（可选）
   ↓
3. 填写症状信息
   - 选择症状标签
   - 填写详细描述
   - 上传症状图片（可选，最多2张）
   ↓
4. 点击"开始诊断"
   ↓
5. 等待2秒，看到"诊断已提交，处理中..."
   ↓
6. 等待3-25秒（根据是否有图片）
   ↓
7. 查看诊断结果
   - 主要诊断
   - 鉴别诊断
   - 治疗建议
   - 用药方案
   ↓
8. 采纳建议（可选）
   - 创建治疗记录
   - 或记录死亡信息
```

---

### 异常情况处理

#### 情况1：网络超时
```
提示："连接超时，服务器响应超时，请稍后重试。提示：诊断任务可能仍在后台处理。"

处理方式：
1. 等待30秒后刷新页面
2. 进入"诊断历史"页面查看任务状态
3. 如果任务仍在处理，等待完成
4. 如果任务失败，重新提交
```

#### 情况2：诊断结果为空
```
可能原因：
- AI模型返回格式错误
- JSON解析失败

处理方式：
1. 查看控制台日志
2. 联系技术支持
3. 提供诊断任务ID
```

---

## 🔗 相关文档

- **完整修复报告**: `AI_DIAGNOSIS_TIMEOUT_FIX.md`
- **通义千问配置**: `QWEN_AI_CONFIG_COMPLETE.md`
- **快速开始**: `QWEN_QUICK_START.md`
- **最终清理**: `QWEN_FINAL_CLEANUP.md`

---

## ✅ 部署确认

部署完成后，请在下方打勾确认：

- [ ] ai-diagnosis 云函数已部署
- [ ] process-ai-diagnosis 云函数已部署
- [ ] 前端代码已编译
- [ ] 纯文本诊断测试通过
- [ ] 图片诊断测试通过（可选）
- [ ] 超时处理测试通过
- [ ] 用户体验良好

**签名：** _______________
**时间：** _______________

---

**🎉 部署完成！系统现已优化，可以稳定处理AI诊断请求。**

