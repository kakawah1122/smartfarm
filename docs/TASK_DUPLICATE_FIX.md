# 任务重复问题修复指南

## 问题描述

系统之前的设计中，每个用户都会创建自己的任务副本，导致一个批次的任务数量会随着参与用户数量而成倍增加。例如：
- 第1日龄应该只有3个任务
- 但如果有10个用户参与，就会有30个任务
- 用户在健康管理页面看到大量重复的任务

## 根本原因

1. **任务创建时带有 `userId` 字段**：每个用户创建入栏记录时，都会为自己创建一套完整的任务
2. **任务查询时过滤 `userId`**：`getTodos` 函数使用 `userId: openid` 进行过滤
3. **任务删除时只删除自己的**：`fixBatchTasks` 只删除当前用户的任务

## 已修复内容

### 1. 云函数修改

#### `breeding-todo/index.js`
- ✅ `getTodos` 函数：移除了 `userId: openid` 查询条件
- ✅ `getWeeklyTodos` 函数：移除了 `userId: openid` 查询条件
- ✅ `createMissingTasks` 函数：将 `userId` 改为 `createdBy`，并移除删除时的userId过滤

#### `production-entry/index.js`
- ✅ `createBatchTodos` 函数：将 `userId` 改为 `createdBy`（仅用于记录创建者）
- ✅ `fixBatchTasks` 函数：删除任务时移除了 `userId` 过滤

### 2. 设计变更

**新设计**：
- 一个批次只有一套任务，所有用户共享
- `createdBy` 字段仅用于记录任务是由哪个用户创建的批次产生的，不用于查询过滤
- 任务完成状态记录在任务本身的 `completed` 字段中
- 任务完成人记录在 `completedBy` 字段中

## 修复步骤

### 步骤1：部署更新的云函数

```bash
# 在微信开发者工具中，右键点击以下云函数并选择"上传并部署：云端安装依赖"
1. breeding-todo
2. production-entry
```

### 步骤2：清理重复任务

有两种方法清理重复任务：

#### 方法A：使用 fixBatchTasks 修复（推荐）

对每个受影响的批次执行修复：

```javascript
// 在云开发控制台，选择 production-entry 云函数，点击"测试"
{
  "action": "fixBatchTasks",
  "batchId": "YOUR_BATCH_ID"  // 替换为实际批次ID
}
```

这会：
1. 删除该批次的所有任务（包括重复的）
2. 重新创建一套标准的任务

#### 方法B：使用清理脚本（彻底清理）

1. 在云开发控制台创建一个临时云函数（例如命名为 `cleanup-tasks`）
2. 复制 `scripts/clean-duplicate-tasks.js` 的内容
3. 取消注释删除代码部分（第51-63行）
4. 执行云函数
5. 删除该临时云函数

### 步骤3：验证修复结果

```javascript
// 在云开发控制台 - 数据库 - task_batch_schedules 集合中查询
{
  "batchId": "YOUR_BATCH_ID",
  "dayAge": 1
}
```

**预期结果**：
- 第1日龄应该只有 **3个任务**（不是30个或更多）
- 每个任务的 `taskId` 应该是唯一的

### 步骤4：测试小程序

1. 重新编译小程序
2. 进入"健康管理"页面
3. 选择受影响的批次
4. 查看"预防管理" → "进行中"标签
5. 确认任务数量正常（第1日龄应该只有3个任务）

## 常见问题

### Q1: 为什么之前要为每个用户创建任务？

A: 这是早期设计的遗留问题。最初可能是想让每个用户有独立的任务视图，但这导致了任务重复和数据冗余。

### Q2: 修复后，多个用户如何协作？

A: 修复后，所有用户共享同一批次的任务：
- 任何用户都可以看到该批次的所有任务
- 任何有权限的用户都可以完成任务
- 任务完成后，`completedBy` 字段会记录完成人

### Q3: 如果一个批次有多个负责人怎么办？

A: 这正是新设计的优势：
- 多个用户可以协作完成同一批次的任务
- 不会产生重复任务
- 每个任务的完成情况都是实时同步的

### Q4: 旧的 `userId` 字段怎么办？

A: 
- 已改名为 `createdBy`
- 仅用于记录是谁创建了这个批次（从而产生了这些任务）
- 查询任务时不再使用这个字段

## 预防措施

为了避免将来再次出现类似问题：

1. **不要恢复 `userId` 查询**：在任何任务查询中都不要使用 `userId` 或 `createdBy` 作为过滤条件
2. **批次级别的任务**：始终记住任务是批次级别的，不是用户级别的
3. **定期检查**：定期在数据库中检查是否有重复任务

## 数据库索引建议

为了提高查询性能，建议在 `task_batch_schedules` 集合中添加以下索引：

```javascript
// 在云开发控制台 - 数据库 - task_batch_schedules - 索引 中添加

// 索引1：批次和日龄查询
{
  "batchId": 1,
  "dayAge": 1,
  "completed": 1
}

// 索引2：批次和目标日期查询
{
  "batchId": 1,
  "targetDate": 1,
  "category": 1
}
```

## 总结

修复完成后，系统的任务管理将更加清晰和高效：
- ✅ 每个批次只有一套任务
- ✅ 所有用户共享同一批次的任务
- ✅ 任务数量恢复正常
- ✅ 多用户协作更加流畅

如果遇到问题，请参考本文档的常见问题部分，或联系技术支持。

