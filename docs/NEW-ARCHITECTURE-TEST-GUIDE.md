# 🚀 新架构测试指南

## 📋 测试准备

### ✅ 已完成的准备工作
1. **云函数部署** - 6个新云函数已全部上传
2. **路由配置** - cloud-adapter.ts 已启用新架构（USE_NEW_ARCHITECTURE = true）
3. **兼容性保证** - 前端代码无需修改，自动路由到新云函数

### 🔧 测试环境配置
```javascript
// miniprogram/utils/cloud-adapter.ts
const USE_NEW_ARCHITECTURE = true; // ✅ 已启用
```

---

## 🧪 功能测试清单

### 1. 健康记录模块（health-records）
- [ ] **创建健康记录**
  - 页面：健康管理 > 健康检查 > 新增记录
  - 验证：记录成功保存，列表显示新记录
  
- [ ] **查看健康记录列表**
  - 页面：健康管理 > 健康记录
  - 验证：列表正常加载，分页功能正常

- [ ] **更新健康记录**
  - 操作：点击记录 > 编辑
  - 验证：修改后数据正确保存

- [ ] **删除健康记录**
  - 操作：长按记录 > 删除
  - 验证：记录被软删除，不再显示

### 2. 治疗管理模块（health-treatment）
- [ ] **创建治疗记录**
  - 页面：健康管理 > 治疗管理 > 新增治疗
  - 验证：治疗方案保存，费用记录同步

- [ ] **查看治疗列表**
  - 页面：健康管理 > 治疗记录
  - 验证：进行中/已完成记录分类正确

- [ ] **更新治疗进度**
  - 操作：治疗记录 > 更新进度
  - 验证：状态变更，时间记录准确

- [ ] **记录治疗结果**
  - 操作：完成治疗 > 填写结果
  - 验证：治愈/死亡统计更新

- [ ] **查看治愈记录**
  - 页面：健康管理 > 治愈记录
  - 验证：治愈列表显示正确

### 3. 死亡记录模块（health-death）
- [ ] **创建死亡记录**
  - 页面：健康管理 > 死亡登记
  - 验证：死亡数量更新，财务损失计算

- [ ] **查看死亡列表**
  - 页面：健康管理 > 死亡记录
  - 验证：列表显示，统计数据准确

- [ ] **批量死亡处理**
  - 操作：批量登记死亡
  - 验证：批次数量正确更新

### 4. 异常诊断模块（health-abnormal）
- [ ] **创建异常记录**
  - 页面：健康管理 > 异常登记
  - 验证：异常标记成功

- [ ] **查看异常列表**
  - 页面：健康管理 > 异常记录
  - 验证：异常分类正确

- [ ] **处理异常**
  - 操作：异常记录 > 处理
  - 验证：状态更新为已处理

### 5. 预防管理模块（health-prevention）
- [ ] **创建预防记录**
  - 页面：健康管理 > 预防保健 > 新增
  - 验证：疫苗/消毒记录保存

- [ ] **查看预防计划**
  - 页面：预防管理 > 今日任务
  - 验证：任务列表显示正确

- [ ] **完成预防任务** ⭐ 重点测试
  - 操作：预防任务 > 完成
  - 验证：任务标记完成，费用同步到财务

- [ ] **预防效果评估**
  - 页面：预防管理 > 效果分析
  - 验证：统计数据准确

### 6. 健康概览模块（health-overview）
- [ ] **查看健康概览**
  - 页面：首页 > 健康概览卡片
  - 验证：统计数据实时更新

- [ ] **批次健康对比**
  - 页面：健康管理 > 批次对比
  - 验证：多批次数据对比正确

- [ ] **获取批次完整数据** ⭐ 重点测试
  - 页面：健康管理 > 批次详情
  - 验证：跨模块数据聚合正确

### 7. AI诊断模块（ai-diagnosis）
- [ ] **查看诊断历史**
  - 页面：健康管理 > AI诊断 > 历史记录
  - 验证：历史记录加载正常

- [ ] **AI诊断功能**
  - 页面：健康管理 > AI诊断 > 新建诊断
  - 验证：诊断结果返回正常

---

## 🔍 重点测试场景

### 场景1：跨模块数据同步
1. 创建治疗记录（health-treatment）
2. 记录死亡结果（health-death）
3. 查看健康概览（health-overview）
4. **验证**：死亡数量、治疗统计、财务记录同步更新

### 场景2：预防任务完整流程
1. 查看今日预防任务（health-prevention）
2. 完成疫苗接种任务
3. 查看财务记录
4. **验证**：任务完成、费用记录、审计日志都正确

### 场景3：批次数据聚合
1. 选择特定批次
2. 查看批次完整数据（health-overview）
3. **验证**：健康、治疗、预防、异常数据都正确聚合

### 场景4：权限验证
1. 使用不同角色账号测试
2. 尝试创建/修改/删除操作
3. **验证**：权限控制正常工作

---

## 📊 性能测试

### 测试工具
```bash
# 运行路由测试脚本
node scripts/test-new-architecture.js
```

### 关键指标监控
| 指标 | 目标值 | 测试方法 |
|-----|--------|----------|
| **响应时间** | <500ms | 记录各操作耗时 |
| **并发处理** | 10个请求/秒 | 同时操作多个功能 |
| **错误率** | <1% | 统计失败请求 |
| **内存使用** | <128MB | 云函数监控面板 |

---

## ⚠️ 已知注意事项

### 1. 数据兼容性
- 新旧数据格式已做兼容处理
- 如遇到数据显示异常，检查字段映射

### 2. 缓存处理
- 切换架构后可能需要清除缓存
- 操作：设置 > 清除缓存

### 3. 错误处理
- 新架构有统一错误码
- 注意观察错误提示是否友好

---

## 🐛 问题排查

### 常见问题及解决方案

#### 问题1：功能无响应
- **原因**：路由配置错误
- **解决**：检查 cloud-adapter.ts 的 ACTION_FUNCTION_MAP

#### 问题2：权限错误
- **原因**：权限验证逻辑变更
- **解决**：确认用户角色和权限设置

#### 问题3：数据不同步
- **原因**：跨模块调用失败
- **解决**：检查云函数间调用权限

#### 问题4：性能未提升
- **原因**：冷启动或首次加载
- **解决**：多次测试取平均值

---

## 📝 测试记录模板

```markdown
### 测试日期：2024-XX-XX
### 测试人员：XXX
### 测试环境：开发环境/测试环境

#### 功能测试结果
- [x] 健康记录模块 - ✅ 通过
- [x] 治疗管理模块 - ✅ 通过
- [ ] 死亡记录模块 - ⚠️ 问题：XXX
- [ ] 异常诊断模块 - 测试中...

#### 性能测试结果
- 平均响应时间：XXXms
- 错误率：X%
- 用户体验：流畅/一般/卡顿

#### 发现的问题
1. 问题描述：XXX
   - 复现步骤：XXX
   - 预期结果：XXX
   - 实际结果：XXX

#### 优化建议
1. XXX
2. XXX
```

---

## 🚀 部署计划

### 阶段1：测试环境验证（当前）
- [x] 启用新架构
- [ ] 完成功能测试
- [ ] 修复发现的问题

### 阶段2：预发布环境
- [ ] 部署到预发布环境
- [ ] 邀请内测用户测试
- [ ] 性能监控和优化

### 阶段3：生产环境灰度
- [ ] 10%流量切换
- [ ] 监控24小时
- [ ] 逐步扩大到50%、100%

### 阶段4：全面切换
- [ ] 100%流量使用新架构
- [ ] 保留旧云函数1周备用
- [ ] 确认稳定后下线旧云函数

---

## 💡 测试建议

1. **循序渐进**：先测试单个模块，再测试跨模块功能
2. **记录详细**：发现问题立即记录，包括操作步骤
3. **多场景覆盖**：正常流程、异常流程、边界条件都要测试
4. **性能对比**：记录新旧架构的性能差异
5. **用户体验**：关注响应速度和操作流畅性

---

## 📞 支持信息

如遇到问题，请记录以下信息：
- 错误截图
- 操作步骤
- 错误日志（开发者工具 > Console）
- 网络请求（开发者工具 > Network）
- 云函数日志（云开发控制台）

祝测试顺利！🎉
