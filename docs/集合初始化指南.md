# task_templates 集合初始化指南

## 问题描述
当您看到以下错误时，说明 `task_templates` 集合还未创建：
```
collection.get:fail -502005 database collection not exists
```

## 解决方案

### 方法一：自动初始化（推荐）

1. **上传初始化云函数**
   - 在微信开发者工具中
   - 右键点击 `cloudfunctions/init-collections` 文件夹
   - 选择"上传并部署：云端安装依赖"

2. **页面会自动初始化**
   - 当您访问"任务管理"页面时
   - 如果检测到集合不存在，会自动调用初始化函数
   - 初始化成功后会显示提示

### 方法二：手动创建集合

1. **登录云开发控制台**
   - 打开微信开发者工具
   - 点击"云开发"按钮
   - 进入"数据库"页面

2. **创建集合**
   - 点击"新建集合"
   - 集合名称：`task_templates`
   - 权限设置：选择"自定义安全规则"

3. **设置权限规则**
   ```json
   {
     "read": "doc._openid == auth.openid",
     "write": false
   }
   ```

4. **创建索引（可选但推荐）**
   - 索引1：`_openid`（升序）+ `createTime`（降序）
   - 索引2：`_openid`（升序）+ `templateName`（升序）
   - 索引3：`_openid`（升序）+ `isDeleted`（升序）

### 方法三：通过云函数批量初始化

如果您想一次性初始化所有缺失的集合：

1. **调用检查函数**
   ```javascript
   wx.cloud.callFunction({
     name: 'init-collections',
     data: { action: 'check_collections' }
   })
   ```

2. **查看缺失的集合**
   控制台会显示哪些集合缺失

3. **手动创建缺失的集合**
   按照方法二的步骤创建每个缺失的集合

## 集合结构说明

`task_templates` 集合用于存储用户自定义的养殖任务模板：

```javascript
{
  _id: String,           // 自动生成的ID
  _openid: String,       // 用户的openid
  templateName: String,  // 模板名称
  description: String,   // 模板描述
  tasks: Array,         // 任务列表
  isDeleted: Boolean,   // 是否已删除
  createTime: Date,     // 创建时间
  updateTime: Date      // 更新时间
}
```

## 任务结构示例

```javascript
tasks: [
  {
    id: String,           // 任务ID
    dayAge: Number,       // 日龄
    title: String,        // 任务标题
    description: String,  // 任务描述
    type: String,         // 任务类型
    category: String,     // 任务分类
    priority: String,     // 优先级（high/medium/low）
    dosage: String,       // 用量说明
    duration: Number,     // 持续天数
    materials: String,    // 所需材料
    notes: String,        // 备注
    estimatedTime: Number // 预计用时（分钟）
  }
]
```

## 常见问题

### Q: 为什么会出现集合不存在的错误？
A: 这是因为 `task_templates` 是一个新功能，需要在数据库中创建相应的集合。

### Q: 初始化后会有什么影响？
A: 初始化只是创建一个空集合，不会影响现有数据。默认模板仍然从代码中读取。

### Q: 可以删除初始化记录吗？
A: 可以，初始化记录会自动标记为已删除（isDeleted: true），不会影响正常使用。

### Q: 如何查看是否初始化成功？
A: 在云开发控制台的数据库页面，应该能看到 `task_templates` 集合。
