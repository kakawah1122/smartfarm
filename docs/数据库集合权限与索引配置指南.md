# 数据库集合权限与索引配置指南

## 一、命名规范

### 1.1 集合命名规则
- ✅ 使用小写字母和下划线：`wx_users`、`health_records`
- ✅ 使用模块前缀 + 功能描述
- ❌ 禁止使用驼峰命名：`userManagement`、`getUserInfo`
- ❌ 禁止使用拼音或中文命名

### 1.2 模块前缀规范
| 模块 | 前缀 | 示例 |
|------|------|------|
| 用户管理 | `wx_` 或 `user_` | `wx_users`、`user_notifications` |
| 生产管理 | `prod_` | `prod_batch_entries` |
| 健康管理 | `health_` | `health_records` |
| 财务管理 | `finance_` | `finance_cost_records` |
| 任务管理 | `task_` | `task_templates` |
| 系统管理 | `sys_` | `sys_audit_logs` |
| 知识库 | `knowledge_` | `knowledge_articles` |
| 文件管理 | `file_` | `file_dynamic_records` |

## 二、权限配置规范 ⭐ 重要

### 2.1 权限选项说明
微信云数据库提供 5 个权限选项，**这些选项是互斥的单选项**，每个集合只能选择一个：

1. **所有用户可读，仅创建者可读写**
2. **仅创建者可读写**
3. **所有用户可读**
4. **所有用户不可读写**
5. **自定义安全规则**

### 2.2 按模块配置权限

#### 用户管理模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `wx_users` | 自定义安全规则 | `{"read": "doc._openid == auth.openid", "write": false}` |
| `wx_user_invites` | 自定义安全规则 | `{"read": "doc.inviter == auth.openid \|\| doc.invitee == auth.openid", "write": false}` |
| `user_notifications` | 自定义安全规则 | `{"read": "doc._openid == auth.openid", "write": false}` |
| `user_notification_settings` | 仅创建者可读写 | - |

#### 生产管理模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `prod_batch_entries` | 自定义安全规则 | `{"read": "doc.userId == auth.openid", "write": "doc.userId == auth.openid"}` |
| `prod_batch_exits` | 自定义安全规则 | `{"read": "doc.userId == auth.openid", "write": "doc.userId == auth.openid"}` |
| `prod_materials` | 所有用户可读 | - |
| `prod_material_records` | 自定义安全规则 | `{"read": "doc.userId == auth.openid", "write": "doc.userId == auth.openid"}` |
| `prod_inventory_logs` | 自定义安全规则 | `{"read": "doc._openid == auth.openid", "write": false}` |
| `feed_usage_records` | 自定义安全规则 | `{"read": "doc.userId == auth.openid", "write": "doc.userId == auth.openid"}` |

#### 健康管理模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `health_records` | 所有用户可读，仅创建者可读写 | - |
| `health_prevention_records` | 仅创建者可读写 | - |
| `health_treatment_records` | 仅创建者可读写 | - |
| `health_ai_diagnosis` | 仅创建者可读写 | - |
| `health_death_records` | 仅创建者可读写 | - |
| `health_alerts` | 自定义安全规则 | `{"read": "doc._openid == auth.openid", "write": false}` |
| `health_vaccine_plans` | 所有用户可读 | - |

#### 财务管理模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `finance_cost_records` | 所有用户可读，仅创建者可读写 | - |
| `finance_revenue_records` | 所有用户可读，仅创建者可读写 | - |
| `finance_reports` | 自定义安全规则 | `{"read": true, "write": false}` |
| `finance_summaries` | 自定义安全规则 | `{"read": true, "write": false}` |
| `finance_analysis_history` | 仅创建者可读写 | - |

#### 任务管理模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `task_batch_schedules` | 仅创建者可读写 | - |
| `task_completions` | 仅创建者可读写 | - |
| `task_records` | 仅创建者可读写 | - |
| `task_templates` | 自定义安全规则 | `{"read": "doc._openid == auth.openid", "write": false}` |

#### 系统管理模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `sys_audit_logs` | 所有用户不可读写 | - |
| `sys_ai_cache` | 所有用户不可读写 | - |
| `sys_ai_usage` | 所有用户不可读写 | - |
| `sys_approval_logs` | 自定义安全规则 | `{"read": "doc._openid == auth.openid \|\| auth.openid in doc.approvers", "write": false}` |
| `sys_cleanup_logs` | 所有用户不可读写 | - |
| `sys_configurations` | 所有用户不可读写 | - |
| `sys_overview_stats` | 自定义安全规则 | `{"read": true, "write": false}` |
| `sys_notifications` | 自定义安全规则 | `{"read": true, "write": false}` |
| `sys_permissions` | 所有用户不可读写 | - |
| `sys_roles` | 所有用户不可读写 | - |
| `sys_storage_statistics` | 所有用户不可读写 | - |

#### 知识库模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `knowledge_articles` | 所有用户可读 | - |

#### 文件管理模块
| 集合名称 | 权限配置 | 权限规则 |
|---------|---------|---------|
| `file_dynamic_records` | 仅创建者可读写 | - |
| `file_static_records` | 所有用户可读 | - |

## 三、索引配置规范

### 3.1 索引命名规则
- 格式：`字段1_字段2_字段3`
- 示例：`_openid_createTime`、`status_updateTime`

### 3.2 通用索引配置

#### 基础索引（所有集合都应该有）
```json
{
  "name": "_openid_createTime",
  "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]
}
```

#### 按模块的索引配置

##### 用户管理模块
```json
// wx_users
[
  { "name": "_openid", "keys": [{ "field": "_openid", "direction": "1" }] },
  { "name": "username", "keys": [{ "field": "username", "direction": "1" }], "unique": true },
  { "name": "role_status", "keys": [
    { "field": "role", "direction": "1" },
    { "field": "status", "direction": "1" }
  ]}
]

// user_notifications
[
  { "name": "_openid_createTime", "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]},
  { "name": "_openid_isRead_createTime", "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "isRead", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]}
]
```

##### 生产管理模块
```json
// prod_batch_entries
[
  { "name": "userId_createTime", "keys": [
    { "field": "userId", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]},
  { "name": "batchCode", "keys": [{ "field": "batchCode", "direction": "1" }], "unique": true },
  { "name": "status_createTime", "keys": [
    { "field": "status", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]}
]
```

##### 健康管理模块
```json
// health_records
[
  { "name": "_openid_createTime", "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]},
  { "name": "animalId_recordDate", "keys": [
    { "field": "animalId", "direction": "1" },
    { "field": "recordDate", "direction": "-1" }
  ]},
  { "name": "type_status_createTime", "keys": [
    { "field": "type", "direction": "1" },
    { "field": "status", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]}
]
```

##### 财务管理模块
```json
// finance_cost_records
[
  { "name": "_openid_createTime", "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]},
  { "name": "category_recordDate", "keys": [
    { "field": "category", "direction": "1" },
    { "field": "recordDate", "direction": "-1" }
  ]},
  { "name": "batchId_category", "keys": [
    { "field": "batchId", "direction": "1" },
    { "field": "category", "direction": "1" }
  ]}
]
```

##### 任务管理模块
```json
// task_templates
[
  { "name": "_openid_createTime", "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "createTime", "direction": "-1" }
  ]},
  { "name": "_openid_templateName", "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "templateName", "direction": "1" }
  ]},
  { "name": "_openid_isDeleted", "keys": [
    { "field": "_openid", "direction": "1" },
    { "field": "isDeleted", "direction": "1" }
  ]}
]

// task_batch_schedules
[
  { "name": "batchId_dayAge", "keys": [
    { "field": "batchId", "direction": "1" },
    { "field": "dayAge", "direction": "1" }
  ]},
  { "name": "batchId_status_dayAge", "keys": [
    { "field": "batchId", "direction": "1" },
    { "field": "status", "direction": "1" },
    { "field": "dayAge", "direction": "1" }
  ]}
]
```

### 3.3 索引优化原则

1. **最左匹配原则**：复合索引遵循最左匹配
2. **选择性原则**：高选择性字段放前面
3. **覆盖索引**：尽量让索引包含查询所需的所有字段
4. **限制数量**：每个集合索引不超过 5 个
5. **定期审查**：定期检查索引使用情况，删除无用索引

## 四、字段设计规范

### 4.1 通用字段
每个集合都应包含以下通用字段：

| 字段名 | 类型 | 说明 | 是否必需 |
|--------|------|------|----------|
| `_id` | String | 自动生成的唯一ID | 自动生成 |
| `_openid` | String | 创建者的openid | 云函数必须手动设置 |
| `createTime` | Date | 创建时间 | 必需 |
| `updateTime` | Date | 更新时间 | 必需 |
| `isDeleted` | Boolean | 软删除标记 | 建议 |

### 4.2 字段命名规范
- ✅ 使用小写字母和下划线：`user_name`、`created_at`
- ✅ 时间字段统一：`createTime`、`updateTime`、`deleteTime`
- ✅ 布尔字段使用 `is` 前缀：`isDeleted`、`isActive`
- ❌ 禁止使用缩写：`del`、`upd`

### 4.3 字段类型规范
| 场景 | 推荐类型 | 示例 |
|------|---------|------|
| ID | String | `_id`、`userId` |
| 时间 | Date/ServerDate | `createTime` |
| 金额 | Number | `amount`、`price` |
| 状态 | String | `status: 'active'` |
| 标记 | Boolean | `isDeleted: false` |
| 数组 | Array | `tags: ['tag1', 'tag2']` |

## 五、操作规范

### 5.1 集合创建流程

1. **在云开发控制台创建集合**
   - 登录云开发控制台
   - 进入数据库页面
   - 点击"新建集合"
   - 输入集合名称（必须符合命名规范）

2. **设置权限**
   - 选择合适的权限选项
   - 如需自定义规则，选择"自定义安全规则"
   - 粘贴对应的权限规则JSON

3. **创建索引**
   - 点击集合名称进入详情
   - 选择"索引管理"标签
   - 点击"新建索引"
   - 配置索引字段和排序方向

### 5.2 权限设置步骤

1. **选择权限模式**
   - 在集合详情页面
   - 点击"权限设置"
   - 选择合适的权限选项（单选）

2. **自定义规则设置**
   - 如果选择"自定义安全规则"
   - 点击"修改"按钮
   - 粘贴规则JSON
   - 点击"确定"保存

### 5.3 注意事项

⚠️ **重要提醒**：
1. 云函数创建记录时必须手动添加 `_openid` 字段
2. 客户端 `add()` 会自动添加 `_openid`，云函数不会
3. 所有写操作应该通过云函数进行
4. 定期检查和优化索引使用情况
5. 软删除优于硬删除

## 六、集合初始化检查清单

创建新集合时，请按以下清单检查：

- [ ] 集合名称符合命名规范
- [ ] 已设置正确的权限规则
- [ ] 已创建必要的索引
- [ ] 包含通用字段（createTime、updateTime等）
- [ ] 在 `shared-config/collections.js` 中添加集合名称
- [ ] 云函数使用配置文件引用集合
- [ ] 文档化集合结构和用途

## 七、示例：task_templates 集合完整配置

### 集合名称
`task_templates`

### 权限配置
选择：自定义安全规则
```json
{
  "read": "doc._openid == auth.openid",
  "write": false
}
```

### 索引配置
1. **索引1**：`_openid_createTime`
   - _openid（升序）
   - createTime（降序）

2. **索引2**：`_openid_templateName`
   - _openid（升序）
   - templateName（升序）

3. **索引3**：`_openid_isDeleted_createTime`
   - _openid（升序）
   - isDeleted（升序）
   - createTime（降序）

### 文档结构
```javascript
{
  _id: "自动生成",
  _openid: "用户openid",
  templateName: "模板名称",
  description: "模板描述",
  tasks: [
    {
      id: "任务ID",
      dayAge: 1,
      title: "任务标题",
      description: "任务描述",
      type: "vaccine",
      category: "疫苗接种",
      priority: "high",
      dosage: "1ml/只",
      duration: 3,
      materials: "疫苗、注射器",
      notes: "注意事项",
      estimatedTime: 30
    }
  ],
  isDeleted: false,
  createTime: "2025-01-16T08:00:00.000Z",
  updateTime: "2025-01-16T08:00:00.000Z"
}
```
