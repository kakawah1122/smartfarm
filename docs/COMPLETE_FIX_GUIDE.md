# 任务重复问题 - 完整修复指南

## 问题描述
批次任务显示数量不正确（例如第2日龄显示24个任务，实际应该只有3个）

## 解决方案：清除重建

### 第一步：部署更新的云函数 ⚠️ 必须先做

#### 1.1 打开微信开发者工具
确保你已经打开项目

#### 1.2 部署云函数
依次右键点击以下云函数，选择"上传并部署：云端安装依赖"：

1. **breeding-todo** 云函数
   - 在左侧云函数列表中找到 `cloudfunctions/breeding-todo`
   - 右键点击 → "上传并部署：云端安装依赖"
   - 等待部署完成（右下角会有提示）

2. **production-entry** 云函数
   - 找到 `cloudfunctions/production-entry`
   - 右键点击 → "上传并部署：云端安装依赖"
   - 等待部署完成

**重要**：这一步必须完成，否则重新创建的任务还会有问题！

---

### 第二步：清理旧数据

#### 方法A：使用清理脚本（推荐）

1. 在云开发控制台创建临时云函数：
   - 点击"云开发" → "云函数"
   - 点击"新建云函数"
   - 命名为 `temp-clean-batch`

2. 替换 `index.js` 内容：
   - 打开 `scripts/clean-and-rebuild-batch.js`
   - 复制全部内容
   - 粘贴到新建的云函数的 `index.js` 中

3. 修改批次号：
   - 在代码第14行，修改：
   ```javascript
   const BATCH_NUMBER = 'QY-20251103'  // 改为你的批次号
   ```

4. 部署并执行：
   - 右键点击 `temp-clean-batch` → "上传并部署：云端安装依赖"
   - 部署完成后，点击"测试"
   - 查看控制台输出，确认清理成功

5. 删除临时云函数：
   - 右键点击 `temp-clean-batch` → "删除云函数"

#### 方法B：手动清理（如果方法A不work）

1. 在云开发控制台 → 数据库

2. 找到批次ID：
   - 打开 `production_batch_entries` 集合
   - 查询：`{"batchNumber": "QY-20251103"}`
   - **记录 `_id` 字段的值**（例如：`abc123def456`）

3. 依次删除以下集合中的相关数据：

   **task_batch_schedules** (任务)
   ```json
   {"batchId": "你的批次_id"}
   ```
   点击"删除查询结果"

   **task_completions** (任务完成记录)
   ```json
   {"batchId": "你的批次_id"}
   ```
   
   **health_records** (健康记录)
   ```json
   {"batchId": "你的批次_id"}
   ```
   
   **health_prevention_records** (预防记录)
   ```json
   {"batchId": "你的批次_id"}
   ```
   
   **health_treatment_records** (治疗记录)
   ```json
   {"batchId": "你的批次_id"}
   ```
   
   **death_records** (死亡记录)
   ```json
   {"batchId": "你的批次_id"}
   ```

4. 最后删除批次本身：
   - 在 `production_batch_entries` 集合
   - 找到该批次记录
   - 点击删除

---

### 第三步：重新创建入栏记录

#### 3.1 清除小程序缓存
1. 在微信开发者工具中
2. 点击"清缓存" → "清除数据缓存"
3. 重新编译

#### 3.2 创建新的入栏记录
1. 打开小程序
2. 进入"生产管理"
3. 点击"新增入栏记录"
4. 填写信息：
   - 批次号：`QY-20251103`（或新的批次号）
   - 品种、供应商、数量等
   - **入栏日期很重要**：会影响任务的日龄计算
5. 点击"确认入栏"

#### 3.3 等待任务创建
- 创建入栏记录后，系统会自动创建所有日龄的任务
- 这个过程可能需要几秒钟

---

### 第四步：验证任务创建

#### 4.1 在数据库中验证

1. 打开云开发控制台 → 数据库
2. 查询 `task_batch_schedules` 集合
3. 按批次和日龄查询：
   ```json
   {
     "batchNumber": "QY-20251103",
     "dayAge": 2
   }
   ```
4. **应该只显示3条记录**：
   - 小鹅瘟疫苗第一针
   - 开口药第一天
   - 弱苗特殊护理

#### 4.2 在小程序中验证

1. 进入"健康管理中心"
2. 选择批次 `QY-20251103`
3. 查看"预防管理" → "即将到来"标签
4. 查看第2日龄的任务
5. **应该只显示3个任务**

#### 4.3 预期结果

各日龄的任务数量（前几天）：
- 第1日龄：3个任务
- 第2日龄：3个任务
- 第3日龄：2个任务
- 第4日龄：2个任务
- 第5日龄：3个任务
- 第6日龄：3个任务
- ...

---

### 第五步：测试任务功能

#### 5.1 查看任务详情
- 点击任何一个任务
- 应该显示完整的任务信息
- 包括：标题、描述、用量、日龄等

#### 5.2 完成任务
- 选择一个任务
- 点击"完成任务"
- 填写完成信息
- 确认任务标记为已完成

#### 5.3 多用户测试（如果有多个用户）
- 用不同账号登录
- 都应该看到同样的任务列表
- 任何人完成任务后，其他人也能看到完成状态

---

## 常见问题

### Q1: 部署云函数失败
**A**: 检查网络连接，或者尝试：
- 关闭微信开发者工具
- 重新打开项目
- 再次尝试部署

### Q2: 清理脚本执行失败
**A**: 使用方法B手动清理，虽然繁琐但更可靠

### Q3: 重新创建后任务还是很多
**A**: 确认第一步的云函数是否已正确部署：
- 在云开发控制台 → 云函数
- 查看 `breeding-todo` 和 `production-entry` 的最后更新时间
- 应该是最近几分钟内

### Q4: 任务数量对不上
**A**: 
1. 检查入栏日期是否正确
2. 确认数据库中没有重复的批次记录
3. 查看云函数日志是否有错误

### Q5: 其他批次也有问题怎么办
**A**: 
- 对每个有问题的批次重复上述步骤
- 或者用清理脚本修改批次号后执行多次

---

## 核心修复内容

本次修复的核心问题：

### 之前的问题
```javascript
// ❌ 错误：每个用户都创建自己的任务副本
const tasksResult = await db.collection('task_batch_schedules').where({
  batchId,
  dayAge,
  userId: openid  // 这导致每个用户都有一套任务
}).get()
```

### 修复后
```javascript
// ✅ 正确：所有用户共享批次任务
const tasksResult = await db.collection('task_batch_schedules').where({
  batchId,
  dayAge
  // 不再使用 userId 过滤
}).get()
```

### 新的任务模型
- 一个批次只有一套任务
- 所有用户共享这套任务
- 任务完成人记录在 `completedBy` 字段
- `createdBy` 字段仅记录批次创建者

---

## 完成确认

完成上述所有步骤后，你应该看到：

✅ 云函数已更新部署  
✅ 旧数据已清理干净  
✅ 新批次已创建  
✅ 任务数量正确（第2日龄只有3个）  
✅ 任务详情完整显示  
✅ 可以正常完成任务  

如果还有任何问题，请提供：
- 批次号
- 具体哪个日龄有问题
- 截图或错误信息

我会继续协助你！

