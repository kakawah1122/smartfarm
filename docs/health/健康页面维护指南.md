# 健康管理中心维护指南

> 聚焦健康管理中心首页（`miniprogram/pages/health/`），整理数据流、云函数、样式规范与测试要点，便于后续维护与扩展。

## 1. 页面与模块概览

- **核心页面**：`health.ts` / `health.wxml` / `health.scss`
- **辅助模块**：
  - `modules/health-data-loader.ts`：缓存与批量数据加载
  - `modules/health-stats-calculator.ts`：统计计算与展示映射
  - `modules/health-watchers.ts`：实时数据监听封装
- **关联云函数**：`health-management`、`production-entry`、`ai-diagnosis`

## 2. 数据流转与调度

### 2.1 页面生命周期

1. `onLoad`
   - 初始化 30 天时间范围
   - 加载批次列表（`production-entry.getActiveBatches`）
   - 根据批次模式调用 `loadHealthData`
2. `onShow`
   - 启动实时监听，仅在 `health_page_need_refresh` 标记存在时静默刷新
3. `onHide`/`onUnload`
   - 释放监听器与定时器

### 2.2 数据加载策略

- **全部批次模式**：
  - `get_all_batches_health_summary`
  - `calculate_batch_treatment_costs`（批量 API，单次返回全部批次）
  - `get_health_records_by_status`（异常、隔离）
  - 统一计算健康率、治愈率等指标
- **单个批次模式**：`Promise.all`并行加载概览、预防、治疗数据
- **防抖与并发控制**：
  - `loadHealthData` 默认 300ms 防抖
  - `isLoadingData` 标记避免重复并发

### 2.3 实时监听

- 监听集合：`health_records`、`health_death_records`、`health_treatment_records`
- 封装模块：`createWatcherManager` + `startDataWatcher`（可配置是否监听治疗记录）
- 监听触发后：清空缓存 `clearAllHealthCache()` → 1000ms 延迟刷新
- `_backgroundRefreshAllBatches` 支持差异对比：健康率变化 < 0.01% 时跳过 `setData`

## 3. 云函数与数据库规范

| 功能 | 云函数 Action | 说明 |
|------|---------------|------|
| 批次健康汇总 | `get_all_batches_health_summary` | 返回批次数量、在养数、死亡数等 |
| 批量治疗统计 | `calculate_batch_treatment_costs` | 单次调用覆盖所有批次，避免 N 次循环调用 |
| 异常/隔离统计 | `get_health_records_by_status` | `batchId: 'all'` 时按状态聚合 |
| 批次列表 | `production-entry.getActiveBatches` | 包含批次号、日龄、存栏数 |
| 诊疗历史 | `ai-diagnosis.get_diagnosis_history` | 近 7 天记录 + 修正信息 |

**规范要点**：

- 尽量使用批量 API，避免循环发起云函数
- 数据库查询前明确 `field`、`limit`，遵守云开发 20MB 限制
- `health-data-loader` 使用 `wx.storageSync` 做 5 分钟持久化缓存：
  - `CACHE_PREFIX = 'health_cache_'`
  - `clearAllHealthCache` 在监听与手动刷新时统一清理

## 4. UI 与样式规范

- 样式统一采用 SCSS 变量管理：
  - 间距：`$spacing-xs ~ $spacing-2xl`
  - 圆角：`$radius-xs ~ $radius-round`
  - 字号：`$font-xs ~ $font-3xl`
  - 阴影：`$shadow-sm`、`$shadow-base`、`$shadow-brand-*`
- 组件遵循 **TDesign 小程序组件规范**：
  - Tab、Tag、Button 等使用 `tdesign-miniprogram`
  - 配色通过 `--td-brand-color`、`--td-text-color-*` 自定义
- 推荐做法：
  - 避免魔术数字，统一使用变量
  - 同类组件（统计卡片、按钮）保持`padding / border-radius / box-shadow`一致
  - 新增样式前查找是否已存在相同变量或混入

## 5. 性能与体验指标

- 云函数调用：
  - 全部批次模式：4 次（汇总 + 批量治疗 + 异常 + 隔离）
  - 单个批次模式：最多 3 次（概览 / 预防 / 治疗）
- 页面加载目标：首屏 < **1.5s**；Tab 切换 < **300ms**
- `setData` 使用路径更新，避免大对象整体替换
- 背景刷新采用“差异对比 + 静默更新”，确保界面无闪烁

## 6. 测试与验证清单

| 场景 | 核心检查 |
|------|-----------|
| 首次进入 | 健康率一次性展示，数值稳定不跳动 |
| 批次切换 | 防抖生效，无多次重复加载 |
| 实时数据 | 新增/修改记录后监听触发，数据同步更新 |
| 从其他页面返回 | 仅在 `health_page_need_refresh` 为真时刷新 |
| 诊疗管理 Tab | AI 诊断列表展示正常，诊断详情弹窗图片加载成功 |
| 样式检查 | 关键卡片、按钮、列表使用统一变量，无硬编码数值 |

## 7. 维护建议

1. **代码修改**：
   - 调整云函数时同步更新批量 API 的入参与返回值
   - 避免在页面内新建重复的统计或格式化逻辑
2. **缓存管理**：
   - 当云函数模型或数据结构变化时，调用 `clearAllHealthCache`
3. **样式演进**：
   - 高频数值（8/12/16/24rpx 等）优先替换为变量
   - 逐步构建公共 mixin，以适配更多页面
4. **合规**：
   - 主包尺寸控制 < 2MB，必要时将健康页面拆入分包
   - 遵守微信小程序 setData 体积与频率限制

## 8. 参考资料

- `OPTIMIZATION_SUMMARY.md` —— 历次性能优化摘要
- `docs/diagnosis/诊断历史维护指南.md` —— 诊断历史数据与修正规则
- 微信官方文档：
  - [云开发数据库规范](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/database/)
  - [实时数据推送 Watcher](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-client-api/database/collection.watch.html)
- TDesign 小程序组件库：[https://tdesign.tencent.com/miniprogram](https://tdesign.tencent.com/miniprogram)

---

> 如需扩展健康相关功能，请优先复用现有模块，保持批量 API、一致的样式变量与差异化刷新策略。这样能够最大化继承当前的性能与稳定性。 

