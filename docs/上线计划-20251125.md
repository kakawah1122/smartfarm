# 鹅数通小程序上线计划

**制定日期**：2025-11-25  
**版本**：云函数拆分优化版

---

## 一、项目合规审查结果

### 1.1 包大小审查

| 包名 | 当前大小 | 限制 | 状态 |
|------|----------|------|------|
| 主包（pages/） | 2.0M | 2M | ⚠️ 临界值 |
| packageHealth | 1.1M | 2M | ✅ 合规 |
| packageUser | 888K | 2M | ✅ 合规 |
| packageFinance | 528K | 2M | ✅ 合规 |
| packageProduction | 448K | 2M | ✅ 合规 |
| packageAI（独立分包） | 232K | 2M | ✅ 合规 |

**主包优化建议**：主包已达 2M 临界值，后续新增功能应优先放入分包。

### 1.2 云函数调度审查

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 路由统一性 | ✅ | 所有调用通过 safeCloudCall 自动路由 |
| 避免双重调用 | ✅ | 前端直接调用目标云函数 |
| 模块化拆分 | ✅ | health-management 已拆分为 8 个模块 |
| 集合名称规范 | ⚠️ | 2334 处使用 COLLECTIONS，少量硬编码待修复 |

### 1.3 数据库规范审查

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 前端直接操作数据库 | ✅ | 无，全部通过云函数 |
| 使用 COLLECTIONS 常量 | ✅ | 2334 处使用 |
| 权限设置 | 待验证 | 上线前需在控制台确认 |

### 1.4 代码质量审查

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 组件懒加载 | ✅ | 已配置 lazyCodeLoading |
| 分包预加载 | ✅ | 已配置 preloadRule |
| 废弃代码清理 | ✅ | 已完成全面清理 |

### 1.5 项目清理记录（2025-11-25）

**已清理的脚本**（15个）：
- auto-migrate-cloud-calls.js、clean-css-important.js
- cleanup-health-management.js、diagnose-cost-issue.js
- final-architecture-test.js、find-remaining-health-management-calls.js
- fix-any-safe-batch2.js、fix-collections-paths.js
- fix-main-package-size.js、migrate-health-pages.js
- migrate-to-smart-cloud-call.js、test-new-architecture.js 等

**已清理的文档**（50+个）：
- 所有日期标记的临时修复文档
- 测试指南、迁移状态、优化报告文档
- docs/archive/ 整个归档目录

**已清理的目录**：
- backups/（项目备份）
- cloudfunctions-backup-20251123-180126/（云函数备份）
- miniprogram-optimization/（优化计划）

**保留的必要文档**（12个）：
| 文档 | 用途 |
|------|------|
| README.md | 项目说明 |
| 项目开发规范.md | 开发规范 |
| docs/上线计划-20251125.md | 上线计划 |
| docs/微信小程序上线完整指引.md | 上线指引 |
| docs/用户服务协议.md | 法律合规 |
| docs/用户隐私保护指引.md | 隐私合规 |
| docs/health/健康页面维护指南.md | 维护指南 |
| docs/diagnosis/诊断历史维护指南.md | 维护指南 |
| docs/数据库集合*.md | 数据库配置参考 |

---

## 二、上线前准备清单

### 2.1 云函数部署清单

需要部署的云函数（按优先级排序）：

**优先级 1 - 核心模块**：
- [ ] `health-treatment` - 治疗管理
- [ ] `health-death` - 死亡记录
- [ ] `health-abnormal` - 异常诊断
- [ ] `health-records` - 健康记录
- [ ] `health-prevention` - 预防保健
- [ ] `health-overview` - 健康概览

**优先级 2 - 支撑模块**：
- [ ] `health-cost` - 成本计算
- [ ] `ai-diagnosis` - AI 诊断
- [ ] `process-ai-diagnosis` - AI 诊断处理

**优先级 3 - 其他模块**：
- [ ] `production-entry` - 生产入库
- [ ] `production-exit` - 生产出库
- [ ] `production-material` - 物料管理
- [ ] `finance-management` - 财务管理
- [ ] `user-core` - 用户核心
- [ ] `user-permission` - 用户权限

**保留但不更新**：
- `health-management` - 已废弃，保留作为备份转发层

### 2.2 数据库权限配置

需要在云开发控制台确认以下集合权限：

| 集合 | 推荐权限 |
|------|----------|
| `health_treatment_records` | 所有用户可读，仅创建者可读写 |
| `health_death_records` | 所有用户可读，仅创建者可读写 |
| `health_abnormal_records` | 所有用户可读，仅创建者可读写 |
| `health_ai_diagnosis` | 仅创建者可读写 |
| `prod_batch_entries` | 自定义（使用 userId 字段） |
| `finance_cost_records` | 所有用户可读，仅管理端可写 |

### 2.3 功能验证清单

| 模块 | 验证项 | 状态 |
|------|--------|------|
| 健康管理 | 治愈记录列表加载 | 待测试 |
| 健康管理 | 死亡记录列表加载 | 待测试 |
| 健康管理 | 异常记录列表加载 | 待测试 |
| 诊疗管理 | 创建治疗记录 | 待测试 |
| 诊疗管理 | 完成治疗（治愈/死亡） | 待测试 |
| AI 诊断 | 提交诊断并获取结果 | 待测试 |
| 生产管理 | 入库/出库操作 | 待测试 |
| 财务管理 | 成本分析 | 待测试 |

---

## 三、发布策略

### 3.1 云函数发布

```
发布顺序：
1. 部署所有新模块化云函数
2. 在测试环境验证功能
3. 验证通过后，标记为正式版本
```

### 3.2 小程序发布

| 阶段 | 范围 | 时长 | 监控指标 |
|------|------|------|----------|
| 体验版 | 开发团队 | 1-2 天 | 功能正确性 |
| 灰度 10% | 少量用户 | 1 天 | 错误率 < 1% |
| 灰度 50% | 半数用户 | 1 天 | 响应时间 < 3s |
| 全量发布 | 所有用户 | - | 持续监控 |

### 3.3 发布时间建议

- **最佳发布时间**：工作日上午 10:00-11:00
- **避免发布时间**：周五下午、节假日
- **预留回滚时间**：发布后 2 小时内保持在线

---

## 四、回滚方案

### 4.1 云函数回滚

```bash
# 在云开发控制台操作
1. 进入云函数管理
2. 选择需要回滚的云函数
3. 切换到历史版本
4. 点击"回滚到此版本"
```

### 4.2 小程序回滚

```
1. 进入微信公众平台
2. 进入"版本管理"
3. 找到上一个稳定版本
4. 点击"回退"
```

### 4.3 回滚触发条件

- 云函数错误率 > 5%
- 核心功能不可用
- 数据异常或丢失
- 用户大量投诉

---

## 五、监控与告警

### 5.1 监控指标

| 指标 | 阈值 | 告警级别 |
|------|------|----------|
| 云函数调用错误率 | > 1% | 警告 |
| 云函数调用错误率 | > 5% | 紧急 |
| 云函数响应时间 | > 3s | 警告 |
| 云函数响应时间 | > 10s | 紧急 |
| 数据库操作失败率 | > 0.5% | 警告 |

### 5.2 告警通知

- **微信通知**：发送到开发者微信
- **邮件通知**：发送到团队邮箱
- **电话通知**：紧急情况

---

## 六、上线后检查

### 6.1 发布后 30 分钟内

- [ ] 检查云函数调用日志
- [ ] 检查数据库操作日志
- [ ] 验证核心功能可用
- [ ] 查看用户反馈

### 6.2 发布后 2 小时内

- [ ] 检查错误率趋势
- [ ] 检查响应时间趋势
- [ ] 确认无异常后解除待命状态

### 6.3 发布后 24 小时内

- [ ] 全面检查各模块功能
- [ ] 收集用户反馈
- [ ] 总结发布经验

---

## 七、已完成的优化

### 7.1 云函数架构优化

✅ **前端路由优化**：
- `safeCloudCall` 自动路由 health-management 调用到新云函数
- 减少一次云函数调用，降低延迟 100-500ms

✅ **模块化拆分**：
| 原云函数 | 拆分后 |
|----------|--------|
| health-management | health-treatment |
| | health-death |
| | health-abnormal |
| | health-records |
| | health-prevention |
| | health-overview |
| | health-cost |

### 7.2 代码清理

✅ 删除废弃文件：
- `cloudfunctions/health-management/index.old.js`
- `cloudfunctions/health-management/index.backup.js`

### 7.3 分包配置

✅ 已配置：
- 组件懒加载 (`lazyCodeLoading`)
- 分包预加载 (`preloadRule`)
- 独立分包 (`packageAI`)

---

## 八、深度审查报告（2025-11-25）

### 8.1 云函数架构审查

| 检查项 | 结果 | 说明 |
|--------|------|------|
| 云函数数量 | 29个 | 精简后的模块化架构 |
| 路由映射完整性 | ✅ | 所有 action 已映射到对应云函数 |
| 路由表一致性 | ✅ | safe-cloud-call.ts 和 cloud-api.ts 已同步 |
| 统一调用入口 | ✅ | 所有调用通过 safeCloudCall 路由 |

### 8.2 数据库集合审查

| 检查项 | 结果 | 说明 |
|--------|------|------|
| COLLECTIONS 使用 | ✅ | 所有云函数使用 COLLECTIONS 常量 |
| 硬编码检查 | ✅ | 无硬编码集合名称 |
| 前端直接访问 | ✅ | 前端不直接操作数据库 |

### 8.3 代码一致性审查

**修复的问题**：
1. 路由表添加缺失的 action：
   - `update_prevention_effectiveness`、`updatePreventionEffectiveness`
   - `update_diagnosis_status`、`get_diagnosis_stats`、`get_pending_diagnosis_count`
2. TypeScript 类型错误修复（cloud-api.ts）
3. 统一 health-cloud-router.ts 使用 safeCloudCall

**删除的冗余代码**：
- `role-migration` 云函数和页面（未上线不需要迁移）
- `task-migration` 云函数
- health-cloud-router.ts 中重复的映射表

### 8.4 最终云函数列表（29个）

```
业务核心（8个）：
├── health-treatment      # 治疗管理
├── health-death          # 死亡记录
├── health-abnormal       # 异常诊断
├── health-records        # 健康记录
├── health-prevention     # 预防保健
├── health-overview       # 健康概览
├── health-cost           # 成本计算
└── health-management     # 路由兼容层（保留）

AI 模块（4个）：
├── ai-diagnosis          # AI诊断
├── process-ai-diagnosis  # AI诊断处理
├── ai-multi-model        # AI多模型
└── ai-learning-cases     # AI学习案例

生产管理（4个）：
├── production-entry      # 生产入库
├── production-exit       # 生产出库
├── production-material   # 物料管理
└── production-dashboard  # 生产仪表盘

用户管理（6个）：
├── user-core             # 用户核心
├── user-management       # 用户管理
├── user-permission       # 用户权限
├── user-approval         # 用户审批
├── login                 # 登录
└── register              # 注册

其他模块（7个）：
├── finance-management    # 财务管理
├── breeding-todo         # 养殖待办
├── lifecycle-management  # 生命周期
├── knowledge-management  # 知识库
├── dynamic-file-manager  # 文件管理
├── weather               # 天气
└── shared-utils          # 共享工具
```

---

## 九、待优化项（后续版本）

| 优化项 | 优先级 | 说明 |
|--------|--------|------|
| 主包瘦身 | 高 | 当前 2.0M，建议减少到 1.5M 以下 |
| pages/health 代码拆分 | 中 | 4717 行代码，可拆分为组件 |

---

**审核人**：  
**批准人**：  
**发布日期**：
