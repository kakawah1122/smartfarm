# 数据库集合总览

## 集合统计
- **总集合数**：37个（已废弃3个）
- **模块数**：10个
- **命名规范**：模块前缀_功能描述

## 完整集合列表（按模块分组）

### 📱 用户管理模块（4个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `wx_users` | 用户基础信息 | 仅创建者可读，禁止写入 | _openid, username |
| `wx_user_invites` | 用户邀请关系 | 邀请双方可读，禁止写入 | inviter_invitee |
| `user_notifications` | 用户通知消息 | 仅创建者可读，禁止写入 | _openid_isRead_createTime |
| `user_roles` | 用户角色定义 | 所有用户可读 | code |

> ⚠️ 已废弃：`user_notification_settings`（未使用）

### 🏭 生产管理模块（6个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `prod_batch_entries` | 入栏记录 | userId字段权限 | batchCode, userId_createTime |
| `prod_batch_exits` | 出栏记录 | userId字段权限 | batchId_createTime |
| `prod_materials` | 物料信息 | 所有用户可读 | materialCode |
| `prod_material_records` | 物料使用记录 | userId字段权限 | userId_materialId |
| `prod_inventory_logs` | 库存日志 | 仅创建者可读，禁止写入 | _openid_createTime |
| `feed_usage_records` | 投喂记录 | userId字段权限 | batchId_recordDate |

### 🏥 健康管理模块（5个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `health_records` | 健康记录 | 所有用户可读，仅创建者可写 | animalId_recordDate |
| `health_prevention_records` | 预防记录 | 仅创建者可读写 | _openid_createTime |
| `health_treatment_records` | 治疗记录（含治愈信息） | 仅创建者可读写 | _openid_status |
| `health_ai_diagnosis` | AI诊断记录 | 仅创建者可读写 | _openid_createTime |
| `health_death_records` | 死亡记录 | 仅创建者可读写 | _openid_createTime |

### 💰 财务管理模块（5个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `finance_cost_records` | 成本记录 | 所有用户可读，仅创建者可写 | category_recordDate |
| `finance_revenue_records` | 收入记录 | 所有用户可读，仅创建者可写 | category_recordDate |
| `finance_reports` | 财务报表 | 所有用户可读，禁止写入 | reportDate |
| `finance_summaries` | 财务汇总 | 所有用户可读，禁止写入 | summaryDate |
| `finance_analysis_history` | 分析历史 | 仅创建者可读写 | _openid_createTime |

### ✅ 任务管理模块（4个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `task_batch_schedules` | 批次任务计划 | 仅创建者可读写 | batchId_dayAge |
| `task_completions` | 任务完成记录 | 仅创建者可读写 | taskId_completedAt |
| `task_records` | 任务记录 | 仅创建者可读写 | _openid_createTime |
| `task_templates` | 任务模板 | 仅创建者可读，禁止写入 | _openid_templateName |

### ⚙️ 系统管理模块（9个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `sys_audit_logs` | 审计日志 | 所有用户不可读写 | operatorId_operationTime |
| `sys_ai_cache` | AI缓存 | 所有用户不可读写 | cacheKey |
| `sys_ai_usage` | AI使用记录 | 所有用户不可读写 | userId_usageDate |
| `sys_approval_logs` | 审批日志 | 审批相关方可读 | recordId_status |
| `sys_cleanup_logs` | 清理日志 | 所有用户不可读写 | cleanupDate |
| `sys_configurations` | 系统配置 | 所有用户不可读写 | configKey |
| `sys_overview_stats` | 概览统计 | 所有用户可读，禁止写入 | statDate |
| `sys_permissions` | 权限配置 | 所有用户不可读写 | roleId |
| `sys_storage_statistics` | 存储统计 | 所有用户不可读写 | statDate |

> ⚠️ 已废弃：`sys_roles`（已被 `user_roles` 替代）、`sys_notifications`（未使用）

### 📚 知识库模块（1个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `knowledge_articles` | 知识文章 | 所有用户可读 | category_publishDate |

### 📁 文件管理模块（2个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `file_dynamic_records` | 动态文件记录 | 仅创建者可读写 | _openid_fileType |
| `file_static_records` | 静态文件记录 | 所有用户可读 | fileType_uploadDate |

### 💰 价格管理模块（1个）
| 集合名称 | 说明 | 权限类型 | 主要索引 |
|---------|------|---------|---------|
| `goose_prices` | 鹅价格记录 | 所有用户可读，仅创建者可写 | date_updateTime |

## 权限类型统计

| 权限类型 | 数量 | 占比 |
|---------|------|------|
| 仅创建者可读写 | 12 | 26.7% |
| 所有用户可读，仅创建者可写 | 4 | 8.9% |
| 所有用户可读，禁止写入 | 8 | 17.8% |
| 仅创建者可读，禁止写入 | 5 | 11.1% |
| userId字段权限 | 3 | 6.7% |
| 邀请关系权限 | 1 | 2.2% |
| 审批日志权限 | 1 | 2.2% |
| 所有用户不可读写 | 8 | 17.8% |
| 其他 | 3 | 6.7% |

## 索引配置原则

### 通用索引（必需）
- `_openid_createTime`：用户数据时间排序
- `status_createTime`：状态筛选
- `isDeleted`：软删除标记

### 业务索引（按需）
- `batchId`：批次相关查询
- `category`：分类筛选
- `recordDate`：日期范围查询
- 唯一索引：`batchCode`、`username`等

## 配置优先级

### 🔴 高优先级（立即配置）
1. wx_users - 用户系统核心
2. prod_batch_entries - 生产核心
3. health_records - 健康核心
4. finance_cost_records - 财务核心
5. task_templates - 任务核心

### 🟡 中优先级（尽快配置）
- user_notifications
- health_treatment_records
- task_batch_schedules
- finance_revenue_records

### 🟢 低优先级（按需配置）
- sys_* 系统集合
- knowledge_articles
- file_* 文件集合

## 注意事项

⚠️ **重要提醒**：
1. **云函数必须手动设置 `_openid` 字段**
2. **客户端自动添加 `_openid`，云函数不会**
3. **所有写操作应通过云函数进行**
4. **优先使用软删除而非硬删除**
5. **定期检查索引使用情况**

## 快速检查命令

在项目根目录运行：
```bash
node scripts/check-collections-status.js
```

查看集合配置状态和缺失项。
