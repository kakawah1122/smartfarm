# å¥åº·ç®¡ç†é¡µé¢æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

## ä¸€ã€é—®é¢˜è¯Šæ–­æ€»ç»“

### ğŸ”´ æ ¸å¿ƒé—®é¢˜

1. **å¡ç‰‡æ•°æ®æ˜¾ç¤ºå…¨éƒ¨ä¸º 0**
2. **ä¸€æ¬¡ç‚¹å‡»è§¦å‘ 8+ ä¸ªäº‘å‡½æ•°è°ƒç”¨**
3. **é¡µé¢åŠ è½½é€Ÿåº¦æ…¢ï¼ˆ3-5ç§’ï¼‰**

### ğŸ” æ ¹æœ¬åŸå› 

1. **æ‰¹æ¬¡æŸ¥è¯¢é—®é¢˜**ï¼š
   - ä½¿ç”¨ `userId` å­—æ®µæŸ¥è¯¢ï¼Œä½†æŸäº›æ‰¹æ¬¡å¯èƒ½åªæœ‰ `_openid`
   - å·²ä¿®å¤ï¼šæ·»åŠ  OR æ¡ä»¶æ”¯æŒä¸¤ç§å­—æ®µ

2. **æ‰¹æ¬¡è¿‡æ»¤è¿‡ä¸¥**ï¼š
   - åŸé€»è¾‘ï¼šåªä¿ç•™ `totalExited < quantity` çš„æ‰¹æ¬¡
   - é—®é¢˜ï¼šæ–°æ‰¹æ¬¡ï¼ˆtotalExited=0, quantity=10ï¼‰ä¹Ÿä¼šè¢«è¿‡æ»¤
   - å·²ä¿®å¤ï¼šä¿ç•™æ‰€æœ‰æœªå‡ºæ çš„æ–°æ‰¹æ¬¡

3. **äº‘å‡½æ•°è°ƒç”¨è¿‡å¤š**ï¼š
   - é¡µé¢åŠ è½½ï¼š8+ ä¸ªäº‘å‡½æ•°å¹¶å‘è°ƒç”¨
   - è¿åå°ç¨‹åºäº‘å¼€å‘æœ€ä½³å®è·µï¼ˆå»ºè®® 3-4 ä¸ªï¼‰

4. **æ•°æ®é‡å¤æŸ¥è¯¢**ï¼š
   - æ‰¹æ¬¡åˆ—è¡¨è¢«å¤šæ¬¡æŸ¥è¯¢
   - æ²¡æœ‰æœ‰æ•ˆçš„è·¨å‡½æ•°æ•°æ®å…±äº«

---

## äºŒã€å·²å®æ–½çš„ä¿®å¤

### âœ… ä¿®å¤1ï¼šä¼˜åŒ–æ‰¹æ¬¡æŸ¥è¯¢ï¼ˆOR æ¡ä»¶ï¼‰

**æ–‡ä»¶**ï¼š`/cloudfunctions/health-management/index.js`

**ä½ç½®**ï¼šç¬¬ 2263-2267 è¡Œ

```javascript
// âœ… ä¿®å¤ï¼šåŒæ—¶æ”¯æŒ userId å’Œ _openid å­—æ®µ
const allBatchesResult = await db.collection(COLLECTIONS.PROD_BATCH_ENTRIES)
  .where(_.or([
    { userId: wxContext.OPENID },
    { _openid: wxContext.OPENID }
  ]))
  .get()
```

### âœ… ä¿®å¤2ï¼šä¼˜åŒ–æ‰¹æ¬¡è¿‡æ»¤é€»è¾‘

**æ–‡ä»¶**ï¼š`/cloudfunctions/health-management/index.js`

**ä½ç½®**ï¼šç¬¬ 2303-2327 è¡Œ

```javascript
// âœ… ä¼˜åŒ–æ‰¹æ¬¡è¿‡æ»¤é€»è¾‘ï¼Œé¿å…è¿‡åº¦è¿‡æ»¤
const batches = allBatchesResult.data.filter(record => {
  // 1. å¿…é¡»æœªåˆ é™¤
  const isNotDeleted = record.isDeleted !== true
  if (!isNotDeleted) {
    console.log(`[æ‰¹æ¬¡è¿‡æ»¤-åˆ é™¤] ${record.batchNumber}: å·²åˆ é™¤`)
    return false
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦å®Œå…¨å‡ºæ 
  const totalExited = exitQuantityMap[record.batchNumber] || 0
  const quantity = record.quantity || 0
  
  // âœ… ä¿®å¤ï¼šåªè¦ quantity > 0 ä¸”æœ‰å‰©ä½™ï¼Œå°±ä¿ç•™
  const hasRemaining = quantity > 0 && totalExited < quantity
  
  // âœ… ä¿®å¤ï¼šå¦‚æœæ²¡æœ‰å‡ºæ è®°å½•ï¼Œä¹Ÿä¿ç•™ï¼ˆæ–°æ‰¹æ¬¡ï¼‰
  const isNewBatch = totalExited === 0
  
  const shouldKeep = hasRemaining || isNewBatch
  
  return shouldKeep
})
```

**ä¿®å¤æ•ˆæœ**ï¼š
- âœ… ä¿ç•™æ‰€æœ‰æœªå‡ºæ çš„æ–°æ‰¹æ¬¡
- âœ… åªè¦æœ‰å‰©ä½™æ•°é‡å°±ä¿ç•™
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•

### âœ… ä¿®å¤3ï¼šæ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—

**æ–‡ä»¶**ï¼š`/cloudfunctions/health-management/index.js`

**ä½ç½®**ï¼š
- getAllBatchesHealthSummaryï¼šç¬¬ 2261-2273, 2324, 2329 è¡Œ
- getDashboardSnapshotï¼šç¬¬ 2563, 2575-2582 è¡Œ

**æ—¥å¿—è¾“å‡º**ï¼š
```
[getAllBatchesHealthSummary] å¼€å§‹æŸ¥è¯¢æ‰¹æ¬¡ï¼Œopenid: xxx
[getAllBatchesHealthSummary] æŸ¥è¯¢åˆ°æ‰¹æ¬¡æ•°é‡: X
[getAllBatchesHealthSummary] ç¬¬ä¸€ä¸ªæ‰¹æ¬¡ç¤ºä¾‹: {...}
[æ‰¹æ¬¡è¿‡æ»¤] QY-20251113: quantity=10, totalExited=0, isNewBatch=true, ä¿ç•™=true
[getAllBatchesHealthSummary] è¿‡æ»¤åçš„æ‰¹æ¬¡æ•°é‡: X
[getDashboardSnapshot] æ‰¹æ¬¡æ•°é‡: X
[getDashboardSnapshot] æå–çš„ batchIds: [...]
```

---

## ä¸‰ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### ğŸ“Š å½“å‰æ€§èƒ½åˆ†æ

#### é¡µé¢åŠ è½½æµç¨‹ï¼ˆonLoadï¼‰

```
onLoad
â”œâ”€ loadAvailableBatches()                    â‘  getActiveBatches (production-entry)
â”œâ”€ loadHealthData()
â”‚  â””â”€ loadAllBatchesData()
â”‚     â”œâ”€ _fetchAllBatchesHealthData()        â‘¡ get_dashboard_snapshot (health-management)
â”‚     â””â”€ getPreventionDashboard()            â‘¢ getPreventionDashboard (health-management)
â””â”€ loadTabData('treatment')
   â””â”€ loadTreatmentData()
      â”œâ”€ get_pending_diagnosis_count          â‘£ ai-diagnosis
      â”œâ”€ calculate_treatment_cost             â‘¤ health-management
      â”œâ”€ get_abnormal_records                 â‘¥ health-management
      â””â”€ get_diagnosis_history                â‘¦ ai-diagnosis
```

**é—®é¢˜**ï¼š**æœ€å¤š 7 ä¸ªäº‘å‡½æ•°è°ƒç”¨**

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- æ€»è€—æ—¶ï¼š3-5 ç§’
- ç½‘ç»œè¯·æ±‚ï¼š7 æ¬¡
- æ•°æ®ä¼ è¾“ï¼š~30KB

### ğŸ¯ ä¼˜åŒ–ç­–ç•¥

#### ç­–ç•¥Aï¼šåˆ›å»ºèšåˆäº‘å‡½æ•°ï¼ˆæ¨è â­â­â­â­â­ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… äº‘å‡½æ•°è°ƒç”¨ä» 7 ä¸ªå‡å°‘åˆ° 1 ä¸ª
- âœ… å‡å°‘ç½‘ç»œå¾€è¿”æ—¶é—´ï¼ˆRTTï¼‰
- âœ… åœ¨äº‘ç«¯å¹¶è¡ŒæŸ¥è¯¢ï¼Œæ€§èƒ½æ›´å¥½
- âœ… å‡å°‘å®¢æˆ·ç«¯ä»£ç å¤æ‚åº¦

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦æ–°å¢äº‘å‡½æ•°
- âš ï¸ éœ€è¦ä¿®æ”¹å‰ç«¯è°ƒç”¨ä»£ç 

**å®æ–½æ­¥éª¤**ï¼š

1. **æ–°å¢äº‘å‡½æ•° action**ï¼š`get_health_dashboard_complete`

2. **äº‘å‡½æ•°å®ç°**ï¼ˆè§ä¸‹æ–¹ä»£ç ï¼‰

3. **å‰ç«¯è°ƒç”¨ä¼˜åŒ–**ï¼š
```typescript
// health.ts - ä¼˜åŒ–å
async loadHealthData() {
  const result = await wx.cloud.callFunction({
    name: 'health-management',
    data: {
      action: 'get_health_dashboard_complete',
      batchId: this.data.currentBatchId
    }
  })
  
  // ç›´æ¥è®¾ç½®æ‰€æœ‰æ•°æ®
  this.setData({
    availableBatches: result.data.batches,
    'treatmentData.stats': result.data.stats,
    'monitoringData.abnormalList': result.data.abnormalRecords
  })
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- äº‘å‡½æ•°è°ƒç”¨ï¼š7 â†’ 1
- æ€»è€—æ—¶ï¼š3-5s â†’ 1-1.5s
- ç”¨æˆ·ä½“éªŒï¼šæ˜¾è‘—æå‡

---

#### ç­–ç•¥Bï¼šä¼˜åŒ–ç°æœ‰ä»£ç ï¼ˆæ¸è¿›å¼ä¼˜åŒ– â­â­â­ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€æ–°å¢äº‘å‡½æ•°
- âœ… æ”¹åŠ¨è¾ƒå°ï¼Œé£é™©ä½

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¼˜åŒ–æ•ˆæœæœ‰é™ï¼ˆ7 â†’ 5 ä¸ªäº‘å‡½æ•°ï¼‰

**ä¼˜åŒ–ç‚¹**ï¼š

1. **åˆå¹¶é‡å¤æŸ¥è¯¢**ï¼š
```typescript
// åŸæ¥ï¼šæ‰¹æ¬¡åˆ—è¡¨æŸ¥è¯¢ 2 æ¬¡
loadAvailableBatches()  // â‘  getActiveBatches
loadHealthData()        // â‘¡ get_dashboard_snapshot (å†…éƒ¨ä¹ŸæŸ¥æ‰¹æ¬¡)

// ä¼˜åŒ–ï¼šå…±äº«æ‰¹æ¬¡æ•°æ®
async loadHealthData() {
  // ä½¿ç”¨ loadAvailableBatches çš„ç»“æœ
  const batches = this.data.availableBatches
  // ...
}
```

2. **å»¶è¿Ÿéå…³é”®æ•°æ®åŠ è½½**ï¼š
```typescript
// è¯Šæ–­å†å²ä¸æ˜¯å…³é”®æ•°æ®ï¼Œå¯ä»¥å»¶è¿ŸåŠ è½½
async loadTreatmentData() {
  // å…³é”®æ•°æ®ç«‹å³åŠ è½½
  await Promise.all([
    this.loadPendingDiagnosis(),
    this.loadTreatmentCost()
  ])
  
  // éå…³é”®æ•°æ®å»¶è¿ŸåŠ è½½
  setTimeout(() => {
    this.loadDiagnosisHistory()
  }, 500)
}
```

3. **ä½¿ç”¨ç¼“å­˜**ï¼š
```typescript
const CACHE_KEY = 'health_dashboard_data'
const CACHE_DURATION = 5 * 60 * 1000  // 5åˆ†é’Ÿ

async loadHealthData() {
  // æ£€æŸ¥ç¼“å­˜
  const cached = wx.getStorageSync(CACHE_KEY)
  if (cached && (Date.now() - cached.fetchedAt) < CACHE_DURATION) {
    this.setData(cached.data)
    return
  }
  
  // åŠ è½½æ•°æ®å¹¶ç¼“å­˜
  const data = await this.fetchData()
  wx.setStorageSync(CACHE_KEY, {
    data,
    fetchedAt: Date.now()
  })
  this.setData(data)
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- äº‘å‡½æ•°è°ƒç”¨ï¼š7 â†’ 5
- æ€»è€—æ—¶ï¼š3-5s â†’ 2-3s

---

## å››ã€æ¨èå®æ–½æ–¹æ¡ˆ

### ğŸš€ åˆ†é˜¶æ®µå®æ–½

#### ç¬¬ä¸€é˜¶æ®µï¼šç«‹å³ä¿®å¤ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- [x] ä¿®å¤æ‰¹æ¬¡æŸ¥è¯¢ OR æ¡ä»¶
- [x] ä¼˜åŒ–æ‰¹æ¬¡è¿‡æ»¤é€»è¾‘
- [x] æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—

**é¢„æœŸæ•ˆæœ**ï¼šè§£å†³å¡ç‰‡æ˜¾ç¤º 0 çš„é—®é¢˜

---

#### ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆæ¨èï¼‰

**æ–¹æ¡ˆ1ï¼šåˆ›å»ºèšåˆäº‘å‡½æ•°ï¼ˆä¼˜å…ˆ â­â­â­â­â­ï¼‰**

1. **æ–°å¢äº‘å‡½æ•°**ï¼ˆè§ä¸‹æ–¹ä»£ç ï¼‰
2. **ä¿®æ”¹å‰ç«¯è°ƒç”¨**
3. **æµ‹è¯•éªŒè¯**

**å·¥ä½œé‡**ï¼š2-3 å°æ—¶

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… äº‘å‡½æ•°è°ƒç”¨ï¼š7 â†’ 1
- âœ… åŠ è½½æ—¶é—´ï¼š50% â†“
- âœ… ç”¨æˆ·ä½“éªŒï¼šæ˜¾è‘—æå‡

---

**æ–¹æ¡ˆ2ï¼šæ¸è¿›å¼ä¼˜åŒ–ï¼ˆå¤‡é€‰ â­â­â­ï¼‰**

1. **åˆå¹¶é‡å¤æŸ¥è¯¢**
2. **å»¶è¿Ÿéå…³é”®æ•°æ®**
3. **å®Œå–„ç¼“å­˜æœºåˆ¶**

**å·¥ä½œé‡**ï¼š1-2 å°æ—¶

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… äº‘å‡½æ•°è°ƒç”¨ï¼š7 â†’ 5
- âœ… åŠ è½½æ—¶é—´ï¼š30% â†“

---

#### ç¬¬ä¸‰é˜¶æ®µï¼šé•¿æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**
2. **äº‘å‡½æ•°å¹¶å‘é™åˆ¶**
3. **ç›‘æ§å’Œå‘Šè­¦**

---

## äº”ã€å®æ–½ä»£ç 

### ğŸ“¦ æ–°å¢èšåˆäº‘å‡½æ•°

**æ–‡ä»¶**ï¼š`/cloudfunctions/health-management/index.js`

```javascript
/**
 * è·å–å¥åº·ç®¡ç†é¢æ¿å®Œæ•´æ•°æ®ï¼ˆèšåˆç‰ˆï¼‰
 * âœ… ä¸€æ¬¡è°ƒç”¨è¿”å›æ‰€æœ‰å¿…è¦æ•°æ®ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
 * @param {Object} event - äº‹ä»¶å‚æ•°
 * @param {string} event.batchId - æ‰¹æ¬¡IDï¼ˆ'all' æˆ–å…·ä½“æ‰¹æ¬¡IDï¼‰
 * @param {Object} wxContext - å¾®ä¿¡ä¸Šä¸‹æ–‡
 * @returns {Promise<Object>} å®Œæ•´çš„å¥åº·é¢æ¿æ•°æ®
 */
async function getHealthDashboardComplete(event, wxContext) {
  try {
    const { batchId = 'all' } = event || {}
    
    console.log('[getHealthDashboardComplete] å¼€å§‹è·å–å®Œæ•´æ•°æ®, batchId:', batchId)
    
    const startTime = Date.now()
    
    // âœ… å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼ˆå‡å°‘æ€»è€—æ—¶ï¼‰
    const [
      batchSummaryResult,
      pendingDiagnosisResult,
      treatmentStatsResult,
      abnormalRecordsResult,
      diagnosisHistoryResult
    ] = await Promise.all([
      // 1. æ‰¹æ¬¡æ±‡æ€»ï¼ˆåŒ…å«æ‰¹æ¬¡åˆ—è¡¨å’Œå¥åº·æ•°æ®ï¼‰
      getAllBatchesHealthSummary({}, wxContext),
      
      // 2. å¾…å¤„ç†è¯Šæ–­æ•°
      db.collection(COLLECTIONS.HEALTH_AI_DIAGNOSIS)
        .where({
          _openid: wxContext.OPENID,
          isDeleted: false,
          hasTreatment: false,
          ...(batchId && batchId !== 'all' ? { batchId } : {})
        })
        .count(),
      
      // 3. æ²»ç–—ç»Ÿè®¡
      calculateTreatmentCost({ 
        batchId: batchId === 'all' ? undefined : batchId 
      }, wxContext),
      
      // 4. å¼‚å¸¸è®°å½•
      getAbnormalRecords({ 
        batchId: batchId === 'all' ? undefined : batchId,
        limit: 50 
      }, wxContext),
      
      // 5. è¯Šæ–­å†å²
      getDiagnosisHistory({ 
        batchId: batchId === 'all' ? undefined : batchId,
        limit: 10,
        page: 1
      }, wxContext)
    ])
    
    // âœ… ç»„è£…è¿”å›æ•°æ®
    const batches = batchSummaryResult.data?.batches || []
    const treatmentStats = treatmentStatsResult.data || {}
    
    const endTime = Date.now()
    console.log(`[getHealthDashboardComplete] å®Œæˆï¼Œè€—æ—¶: ${endTime - startTime}ms`)
    
    return {
      success: true,
      data: {
        // æ‰¹æ¬¡ä¿¡æ¯
        batches,
        totalBatches: batches.length,
        
        // ç»Ÿè®¡æ•°æ®
        stats: {
          pendingDiagnosis: pendingDiagnosisResult.total || 0,
          ongoingTreatment: treatmentStats.ongoingCount || 0,
          ongoingAnimalsCount: treatmentStats.ongoingAnimalsCount || 0,
          recoveredCount: treatmentStats.totalCuredAnimals || 0,
          deadCount: treatmentStats.deadCount || treatmentStats.totalDiedAnimals || 0,
          totalTreatmentCost: treatmentStats.totalCost || 0,
          cureRate: treatmentStats.cureRate || 0
        },
        
        // è¯¦ç»†æ•°æ®
        abnormalRecords: abnormalRecordsResult.data?.records || [],
        diagnosisHistory: diagnosisHistoryResult.data?.records || [],
        
        // å…ƒæ•°æ®
        fetchedAt: Date.now(),
        version: '1.0.0',
        performanceMs: endTime - startTime
      }
    }
  } catch (error) {
    console.error('[getHealthDashboardComplete] é”™è¯¯:', error)
    return {
      success: false,
      error: error.message,
      message: 'è·å–å¥åº·é¢æ¿æ•°æ®å¤±è´¥'
    }
  }
}

// åœ¨ exports.main ä¸­æ·»åŠ è·¯ç”±
exports.main = async (event, context) => {
  const wxContext = cloud.getWXContext()
  const { action } = event

  try {
    switch (action) {
      // ... å…¶ä»– actions ...
      
      case 'get_health_dashboard_complete':
        return await getHealthDashboardComplete(event, wxContext)
      
      // ... å…¶ä»– actions ...
    }
  } catch (error) {
    // ...
  }
}
```

### ğŸ“± å‰ç«¯è°ƒç”¨ä¼˜åŒ–

**æ–‡ä»¶**ï¼š`/miniprogram/pages/health/health.ts`

```typescript
/**
 * åŠ è½½å¥åº·æ•°æ®ï¼ˆä¼˜åŒ–ç‰ˆ - ä½¿ç”¨èšåˆäº‘å‡½æ•°ï¼‰
 */
async loadHealthDataOptimized() {
  if (this.isLoadingData) return
  this.isLoadingData = true
  
  try {
    wx.showLoading({ title: 'åŠ è½½ä¸­...' })
    
    // âœ… ä¸€æ¬¡è°ƒç”¨è·å–æ‰€æœ‰æ•°æ®
    const result = await wx.cloud.callFunction({
      name: 'health-management',
      data: {
        action: 'get_health_dashboard_complete',
        batchId: this.data.currentBatchId
      }
    })
    
    if (!result.result?.success) {
      throw new Error(result.result?.message || 'åŠ è½½å¤±è´¥')
    }
    
    const data = result.result.data
    
    console.log('[loadHealthData] æ•°æ®åŠ è½½å®Œæˆï¼Œè€—æ—¶:', data.performanceMs + 'ms')
    
    // âœ… ç›´æ¥è®¾ç½®æ‰€æœ‰æ•°æ®
    this.setData({
      // æ‰¹æ¬¡æ•°æ®
      availableBatches: data.batches,
      
      // ç»Ÿè®¡æ•°æ®ï¼ˆæ›´æ–°å¡ç‰‡ï¼‰
      'treatmentData.stats': {
        pendingDiagnosis: data.stats.pendingDiagnosis,
        ongoingTreatment: data.stats.ongoingTreatment,
        recoveredCount: data.stats.recoveredCount,
        deadCount: data.stats.deadCount,
        totalTreatmentCost: data.stats.totalTreatmentCost,
        cureRate: data.stats.cureRate,
        ongoingAnimalsCount: data.stats.ongoingAnimalsCount
      },
      
      // è¯¦ç»†æ•°æ®
      'monitoringData.abnormalList': data.abnormalRecords,
      'treatmentData.diagnosisHistory': data.diagnosisHistory,
      
      loading: false
    })
    
    // âœ… ç¼“å­˜æ•°æ®ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
    try {
      wx.setStorageSync('health_dashboard_cache', {
        data,
        fetchedAt: Date.now(),
        batchId: this.data.currentBatchId
      })
    } catch (_) {}
    
  } catch (error: any) {
    console.error('[loadHealthData] åŠ è½½å¤±è´¥:', error)
    wx.showToast({
      title: error.message || 'åŠ è½½å¤±è´¥',
      icon: 'error'
    })
  } finally {
    wx.hideLoading()
    this.isLoadingData = false
  }
},

/**
 * åŠ è½½å¥åº·æ•°æ®ï¼ˆå¸¦ç¼“å­˜æ£€æŸ¥ï¼‰
 */
async loadHealthData() {
  // âœ… æ£€æŸ¥ç¼“å­˜
  try {
    const cached = wx.getStorageSync('health_dashboard_cache')
    if (cached 
        && cached.batchId === this.data.currentBatchId
        && (Date.now() - cached.fetchedAt) < 5 * 60 * 1000  // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
    ) {
      console.log('[loadHealthData] ä½¿ç”¨ç¼“å­˜æ•°æ®')
      this.setData({
        availableBatches: cached.data.batches,
        'treatmentData.stats': cached.data.stats,
        'monitoringData.abnormalList': cached.data.abnormalRecords,
        'treatmentData.diagnosisHistory': cached.data.diagnosisHistory
      })
      return
    }
  } catch (_) {}
  
  // âœ… ç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°åŠ è½½
  await this.loadHealthDataOptimized()
}
```

---

## å…­ã€æµ‹è¯•éªŒè¯

### ğŸ§ª æµ‹è¯•è®¡åˆ’

#### æµ‹è¯•1ï¼šåŠŸèƒ½æµ‹è¯•

**ç›®æ ‡**ï¼šéªŒè¯æ•°æ®æ­£ç¡®æ€§

**æ­¥éª¤**ï¼š
1. æ¸…ç†æ‰€æœ‰ç¼“å­˜
2. è¿›å…¥å¥åº·ç®¡ç†ä¸­å¿ƒ
3. æ£€æŸ¥å¡ç‰‡æ•°æ®æ˜¯å¦æ­£ç¡®ï¼š
   - å¾…å¤„ç† â‰¥ 0
   - æ²»ç–—ä¸­ â‰¥ 0
   - æ²»æ„ˆæ•° â‰¥ 0
   - æ­»äº¡æ•° â‰¥ 0
4. åˆ‡æ¢æ‰¹æ¬¡ï¼ŒéªŒè¯æ•°æ®æ›´æ–°
5. ä¸‹æ‹‰åˆ·æ–°ï¼ŒéªŒè¯æ•°æ®åˆ·æ–°

**é¢„æœŸç»“æœ**ï¼šâœ… æ‰€æœ‰æ•°æ®æ˜¾ç¤ºæ­£ç¡®

---

#### æµ‹è¯•2ï¼šæ€§èƒ½æµ‹è¯•

**ç›®æ ‡**ï¼šéªŒè¯åŠ è½½é€Ÿåº¦

**æ­¥éª¤**ï¼š
1. æ¸…ç†ç¼“å­˜
2. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…· Performance é¢æ¿
3. åˆ·æ–°å¥åº·ç®¡ç†é¡µé¢
4. è®°å½•ä»¥ä¸‹æŒ‡æ ‡ï¼š
   - äº‘å‡½æ•°è°ƒç”¨æ¬¡æ•°
   - æ€»åŠ è½½æ—¶é—´
   - é¦–å±æ¸²æŸ“æ—¶é—´

**é¢„æœŸç»“æœ**ï¼š
- äº‘å‡½æ•°è°ƒç”¨ï¼šâ‰¤ 2 æ¬¡
- æ€»åŠ è½½æ—¶é—´ï¼š< 1.5 ç§’
- é¦–å±æ¸²æŸ“ï¼š< 1 ç§’

---

#### æµ‹è¯•3ï¼šå…¼å®¹æ€§æµ‹è¯•

**ç›®æ ‡**ï¼šéªŒè¯å¤šåœºæ™¯å…¼å®¹æ€§

**åœºæ™¯**ï¼š
1. å…¨éƒ¨æ‰¹æ¬¡æ¨¡å¼
2. å•æ‰¹æ¬¡æ¨¡å¼
3. åˆ‡æ¢æ‰¹æ¬¡
4. æ–°å»ºæ‰¹æ¬¡ååˆ·æ–°
5. åˆ›å»ºæ²»ç–—è®°å½•ååˆ·æ–°

**é¢„æœŸç»“æœ**ï¼šâœ… æ‰€æœ‰åœºæ™¯æ­£å¸¸å·¥ä½œ

---

## ä¸ƒã€é£é™©è¯„ä¼°

### âš ï¸ æ½œåœ¨é£é™©

1. **æ•°æ®ä¸ä¸€è‡´**ï¼š
   - é£é™©ï¼šèšåˆæŸ¥è¯¢å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
   - ç¼“è§£ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰

2. **ç¼“å­˜å¤±æ•ˆ**ï¼š
   - é£é™©ï¼šç¼“å­˜æ•°æ®è¿‡æœŸå¯¼è‡´æ˜¾ç¤ºæ—§æ•°æ®
   - ç¼“è§£ï¼š5åˆ†é’Ÿç¼“å­˜æœ‰æ•ˆæœŸ + æ‰‹åŠ¨åˆ·æ–°

3. **äº‘å‡½æ•°è¶…æ—¶**ï¼š
   - é£é™©ï¼šå¹¶è¡ŒæŸ¥è¯¢è¿‡å¤šå¯¼è‡´è¶…æ—¶
   - ç¼“è§£ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆ10ç§’ï¼‰

---

## å…«ã€æ€»ç»“

### âœ… å·²å®Œæˆ

1. âœ… ä¿®å¤æ‰¹æ¬¡æŸ¥è¯¢ OR æ¡ä»¶
2. âœ… ä¼˜åŒ–æ‰¹æ¬¡è¿‡æ»¤é€»è¾‘
3. âœ… æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—

### ğŸš€ æ¨èå®æ–½

1. **åˆ›å»ºèšåˆäº‘å‡½æ•°**ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
2. **å‰ç«¯è°ƒç”¨ä¼˜åŒ–**ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
3. **å®Œå–„ç¼“å­˜æœºåˆ¶**ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

### ğŸ“ˆ é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| äº‘å‡½æ•°è°ƒç”¨ | 7 ä¸ª | 1 ä¸ª | **85% â†“** |
| æ€»åŠ è½½æ—¶é—´ | 3-5s | 1-1.5s | **50-70% â†“** |
| ç”¨æˆ·ä½“éªŒ | ä¸€èˆ¬ | ä¼˜ç§€ | **æ˜¾è‘—æå‡** |

---

## ä¹ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

1. **é‡æ–°éƒ¨ç½²äº‘å‡½æ•°**
2. **æµ‹è¯•æ‰¹æ¬¡æŸ¥è¯¢ä¿®å¤**
3. **éªŒè¯å¡ç‰‡æ•°æ®æ­£ç¡®æ€§**

### åç»­ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

1. **å®æ–½èšåˆäº‘å‡½æ•°**
2. **å‰ç«¯ä»£ç ä¼˜åŒ–**
3. **æ€§èƒ½æµ‹è¯•éªŒè¯**

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-11-16
**ä½œè€…**ï¼šCascade AI Assistant
