# 性能优化实施方案（2025-01-17）

## 一、当前问题分析

### 1.1 云函数调用问题
| 页面 | 调用次数 | 问题 | 影响 |
|-----|---------|------|------|
| health.ts | 40次 | 重复调用getActiveBatches | 性能浪费 |
| treatment-record.ts | 17次 | 串行请求多 | 加载缓慢 |
| breeding-todo.ts | 14次 | 无缓存机制 | 重复请求 |

### 1.2 主要问题
1. **RequestOptimizer未使用**：已创建但完全没有使用
2. **批次信息重复获取**：getActiveBatches被调用10+次
3. **无缓存策略**：相同数据反复请求
4. **串行请求**：可并行的请求串行执行

## 二、优化方案

### 2.1 立即优化（P0）

#### A. 使用CloudFunctionManager统一管理
```typescript
// 替换前
const result = await wx.cloud.callFunction({
  name: 'production-entry',
  data: { action: 'getActiveBatches' }
})

// 替换后
import { cloudManager } from '@/utils/cloud-function-manager'
const result = await cloudManager.call({
  name: 'production-entry',
  data: { action: 'getActiveBatches' },
  cache: true // 自动缓存10分钟
})
```

#### B. 批次信息全局缓存
- 首次加载缓存10分钟
- 切换批次时更新缓存
- 减少90%的重复调用

#### C. 并行请求优化
```typescript
// 替换前（串行）
const result1 = await callFunction1()
const result2 = await callFunction2()
const result3 = await callFunction3()

// 替换后（并行）
const [result1, result2, result3] = await cloudManager.batchCall([
  { name: 'func1', data: {} },
  { name: 'func2', data: {} },
  { name: 'func3', data: {} }
])
```

### 2.2 关键优化点

#### 1. health.ts页面优化
- **问题**：40个云函数调用，getActiveBatches重复10次
- **方案**：
  - 使用CloudFunctionManager缓存批次信息
  - 合并loadAllBatchesTodayTasks等方法的批次查询
  - 预期减少：30个云函数调用

#### 2. 数据预热策略
```typescript
// 在app.ts中预热常用数据
App({
  async onLaunch() {
    // 预热批次和用户信息
    await cloudManager.warmup()
  }
})
```

#### 3. 请求队列优化
- 最大并发：3个
- 优先级队列：重要请求优先
- 自动重试：失败自动重试1次

### 2.3 缓存策略

| 数据类型 | 缓存时间 | 更新时机 |
|---------|---------|---------|
| 批次信息 | 10分钟 | 切换批次 |
| 用户信息 | 30分钟 | 权限变更 |
| 统计数据 | 5分钟 | 数据变更 |
| 任务列表 | 2分钟 | 完成任务 |

## 三、实施步骤

### Step 1：引入CloudFunctionManager（5分钟）
```bash
# 已创建 /miniprogram/utils/cloud-function-manager.ts
```

### Step 2：修改health.ts（10分钟）
1. 导入cloudManager
2. 替换重复的getActiveBatches调用
3. 合并可并行的请求

### Step 3：优化其他高频页面（15分钟）
- treatment-record.ts
- breeding-todo.ts
- index.ts

## 四、预期效果

### 4.1 性能提升
| 指标 | 当前 | 优化后 | 提升 |
|------|------|--------|------|
| **云函数调用** | 213次 | <100次 | -53% |
| **页面加载** | 2-3秒 | <1秒 | -60% |
| **重复请求** | 80% | <20% | -75% |
| **并发控制** | 无限制 | 3个 | 稳定性↑ |

### 4.2 用户体验提升
- ✅ 页面切换更流畅
- ✅ 数据加载更快
- ✅ 减少loading时间
- ✅ 降低服务器压力

## 五、监控指标

### 5.1 性能监控
```typescript
// 添加性能监控
const startTime = Date.now()
await cloudManager.call({ ... })
const duration = Date.now() - startTime
console.log(`[Performance] API调用耗时: ${duration}ms`)
```

### 5.2 关键指标
- API调用次数
- 缓存命中率
- 平均响应时间
- 错误率

## 六、注意事项

### 6.1 不破坏现有功能
- ✅ 所有改动向后兼容
- ✅ 保留原有业务逻辑
- ✅ 增加容错处理

### 6.2 遵循项目规范
- ✅ 使用TypeScript类型
- ✅ 遵循命名规范
- ✅ 添加必要注释
- ✅ 保持代码风格一致

## 七、回滚方案

如果出现问题，可以快速回滚：
1. 注释掉cloudManager引用
2. 恢复原有wx.cloud.callFunction调用
3. 清除缓存

## 八、长期优化建议

### 8.1 后端优化
- 实现GraphQL聚合查询
- 添加服务端缓存
- 优化数据库查询

### 8.2 前端优化
- 实现虚拟列表
- 添加骨架屏
- 图片懒加载

### 8.3 架构优化
- 考虑使用Redis缓存
- 实现WebSocket实时通信
- 添加CDN加速
