# 前端页面重构指引

> 目标：在不改动现有 UI 与业务逻辑的前提下，逐步将传统 `Page({...})` 页面迁移为类型完善、结构清晰的实现，持续提升代码可维护性与合规性。

## 一、适用范围

- 仍使用传统 `Page({...})` 结构的业务页面（含 packageHealth、packageProduction、packageUser 等模块）。
- 重点关注高频访问、数据流复杂的页面，例如健康模块的记录列表与详情页。
- 已完成示例：
  - `packageHealth/cured-records-list/cured-records-list.ts`
  - `packageHealth/death-record-detail/death-record-detail.ts`

## 二、迁移前准备

1. **基线确认**：
   - 采集页面核心流程的截图或录屏，标记关键交互点。
   - 梳理现有数据来源（云函数、数据库集合、utils 方法）。
2. **风险评估**：
   - 确认页面是否涉及批量写入、权限校验、复杂降级逻辑。
   - 标记需重点回归的功能（例如治愈记录的降级查询、死亡记录的修正流程）。

## 三、迁移步骤

1. **类型定义补全**
   - 为 `data`、事件参数、云函数返回值等补充 TypeScript 接口。
   - 优先定义业务语义一致的接口，如 `CuredRecord`、`DeathRecord`、`CorrectionForm` 等。
2. **结构封装**
   - 将页面配置提炼为 `const pageConfig = { ... }`，再调用 `Page(pageConfig)`。
   - 以 `WechatMiniprogram.Page.Options<PageData, PageCustom>` 指定数据与自定义方法类型，消除 `this` 推断问题。
   - 对内部辅助函数（格式化、数组处理等）保持纯函数，易于复用。
3. **逻辑保持**
   - 迁移过程中严禁修改现有 UI、样式、文案与业务流程。
   - 调用链、错误提示、`wx.showToast` 内容需保持一致，必要时通过单元测试或手测核对。
4. **异常处理统一**
   - 使用 `logger` 输出错误信息，遵循“前端 `logger` / 云函数 `debugLog`”规则。
   - 对 Promise/async 调用增加 `try/catch`，保证降级与兜底逻辑按旧行为执行。

## 四、验证与回归

- **自测用例**（示例）：
  1. 治愈记录列表：云函数返回成功、失败、降级查询三种场景。
  2. 死亡记录详情：图片列表为空/存在、AI 修正成功/失败、确认诊断流程。
- **对照基线**：逐步对比迁移前后页面截图或录屏，确认 UI 未产生差异。
- **日志检查**：确认新增代码未出现裸露 `console.*`，并维持数据库访问引用 `COLLECTIONS`。

## 五、推广节奏建议

1. **优先级排序**：按照《传统 Page 页面清单》从高到低依次处理。
2. **批次推进**：每批建议选取 1~2 个页面，完成后合并提交并记录要点。
3. **文档更新**：每轮迁移结束后在本指引中追加已完成页面与经验要点，持续完善。

## 六、Checklist（每页迁移需确认）

- [ ] 数据接口类型、事件参数类型补齐
- [ ] `Page` 配置封装 + 自定义方法类型声明
- [ ] 日志输出、降级流程与旧版一致
- [ ] UI / 动画 / 文案保持不变
- [ ] 手测关键路径并记录
- [ ] 更新完成列表与经验总结

---
如需新增示例代码或公共工具，请在提交前确认与项目规范一致，并保持对外 API 的兼容性。
