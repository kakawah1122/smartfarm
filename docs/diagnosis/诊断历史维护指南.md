# 诊断历史维护指南

> 适用于 `packageAI/diagnosis-history` 页面及相关云函数，概述数据结构、修正同步机制、迁移方案与排查步骤。

## 1. 功能概览

- **核心数据源**：
  - AI 诊断记录：`health_ai_diagnosis`
  - 异常记录/死亡记录：`health_records`（`status=abnormal` / `health_death_records`）
- **关联云函数**：
  - `ai-diagnosis.get_diagnosis_history`
  - `health-management.updateAbnormalRecord` / `updateDeathRecord`
  - （可选）`sync-correction-data` —— 历史修正迁移脚本
- **页面行为**：
  - 诊断历史列表展示近 7 天记录
  - 诊断详情弹窗支持图片预览、修正信息、治疗建议

## 2. 修正信息同步机制

### 2.1 问题回顾

- 旧逻辑仅在异常记录或死亡记录中保存修正信息
- `health_ai_diagnosis` 未同步，导致诊断历史无法呈现修正结果

### 2.2 现有方案

1. **修正时同步更新**（默认行为）
   - `health-management` 在修正完成后：
     - 更新异常/死亡记录
     - 若存在 `diagnosisId`/`aiDiagnosisId`，同步更新 `health_ai_diagnosis`
     - 写入字段：`isCorrected`、`correctedDiagnosis`、`veterinarianDiagnosis`、`aiAccuracyRating`、`correctedByName` 等
2. **历史数据迁移（可选）**
   - 云函数：`sync-correction-data`
   - 一次性扫描已修正记录 → 补写 AI 诊断集合

## 3. 运维操作流程

### 3.1 新修正流程

1. 部署/更新 `health-management` 与 `ai-diagnosis`
2. 在小程序中重新修正异常记录
3. 验证云函数日志：应出现 “✅ 已同步更新 AI 诊断记录”
4. 返回诊断历史页，确认绿色“诊断修正记录”卡片显示

### 3.2 历史数据同步（方案对比）

| 方案 | 操作 | 适用场景 |
|------|------|----------|
| 重新修正（方案 A） | 用户逐条重新提交修正 | 数据量少，操作简单 |
| 迁移脚本（方案 B） | 调用 `sync-correction-data` 云函数 | 数据量大，需要一次性同步 |
| 手动更新（方案 C） | 直接在云数据库中编辑 | 小规模验证或紧急补丁 |

#### 迁移脚本执行步骤

1. 部署 `cloudfunctions/sync-correction-data`
2. 云开发控制台 → 云函数 → `sync-correction-data` → 测试 → `{}`
3. 查看返回：`"success": true, "synced": X`
4. 随机抽样验证诊断记录是否已有修正字段

## 4. 验证与测试清单

| 步骤 | 检查点 |
|------|---------|
| 云函数 | `health-management`、`ai-diagnosis`、`sync-correction-data` 最后更新时间是否为最新 |
| 数据库 | `health_ai_diagnosis` 中是否存在 `isCorrected: true` 等字段 |
| 前端列表 | 诊断历史列表显示诊断名称、置信度、受影响数量、修正标签 |
| 诊断详情 | 弹窗展示修正卡片、图片列表（若有）、AI 建议及实际治疗信息 |
| 控制台日志 | 打开诊断详情时输出 `===== 查看诊断详情 =====`，`是否已修正: true` |

## 5. 常见问题排查

- **看不到修正卡片**：
  - 打开 `health_records` 检查目标异常记录是否包含 `diagnosisId`
  - 在 `health_ai_diagnosis` 中使用该 ID 查询修正字段（`isCorrected`、`correctedDiagnosis` 等）
  - 查看 `health-management` 云函数日志是否存在 “✅ 已同步更新 AI 诊断记录”
  - 若字段缺失，可参考上表重新修正或运行迁移脚本
- **迁移脚本报“记录不存在”**：
  - 可能早期数据已被清理或手动删除，脚本会自动跳过
- **图片无法预览**：
  - 诊断详情弹窗会将 `cloud://` 路径转换为临时 URL
  - 若 `wx.cloud.getTempFileURL` 抛错，前端会提示 “图片加载失败”，可重新上传或检查权限

## 6. 维护建议

1. **保持字段兼容性**：保留 `correctionReason` 与 `veterinarianDiagnosis`，兼容旧前端
2. **容错处理**：同步失败不应阻塞用户操作；检查日志后再重试
3. **日志监控**：部署后关注云函数调用日志，确认“已同步更新”/“更新失败”信息
4. **批量操作前备份**：执行迁移脚本或手动修改前建议导出相关集合

## 7. 参考资料

- `cloudfunctions/health-management/index.js`
- `cloudfunctions/ai-diagnosis/index.js`
- `cloudfunctions/sync-correction-data/`
- 微信云开发文档：[数据库 watch](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-client-api/database/collection.watch.html)

---

> 维护诊断历史时，务必确保 AI 诊断与异常记录的数据双向同步，并在发布前完成部署、迁移与回归测试，以保证修正信息的完整可见性。

