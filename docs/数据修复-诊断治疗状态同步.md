# 数据修复：AI诊断记录治疗状态同步

## 问题描述

当制定治疗方案后，治疗记录流转到"治疗中"状态，但健康管理中心的"待处理"卡片数量没有正确更新。

**根本原因：** AI诊断记录的 `hasTreatment` 字段没有同步更新为 `true`。

## 修复方案

### 方法1：使用开发者工具云函数测试（推荐）

1. **打开微信开发者工具**

2. **进入云开发控制台**
   - 点击工具栏的"云开发"按钮
   - 或者点击右上角的"云开发"图标

3. **选择云函数**
   - 在左侧菜单中点击"云函数"
   - 找到 `health-management` 云函数

4. **测试云函数**
   - 点击 `health-management` 右侧的"···"按钮
   - 选择"云端测试"
   - 在弹出的对话框中输入以下JSON：

   ```json
   {
     "action": "fix_diagnosis_treatment_status"
   }
   ```

5. **执行修复**
   - 点击"测试"按钮
   - 等待执行完成
   - 查看返回结果

### 方法2：在小程序中手动调用（开发模式）

在健康管理页面（或任意页面）的控制台中执行：

```javascript
wx.cloud.callFunction({
  name: 'health-management',
  data: {
    action: 'fix_diagnosis_treatment_status'
  },
  success: res => {
    console.log('修复结果:', res)
    if (res.result.success) {
      wx.showToast({
        title: `修复成功！已修复 ${res.result.data.fixedCount} 条记录`,
        icon: 'success',
        duration: 3000
      })
      // 刷新页面数据
      // 调用页面的 loadHealthData 方法
    }
  },
  fail: err => {
    console.error('修复失败:', err)
    wx.showToast({
      title: '修复失败，请查看控制台',
      icon: 'none'
    })
  }
})
```

## 返回结果说明

修复成功后会返回以下格式的数据：

```json
{
  "success": true,
  "message": "修复完成！已修复 1 条记录",
  "data": {
    "totalRecords": 1,      // 总共找到的治疗中记录
    "fixedCount": 1,         // 成功修复的记录数
    "skippedCount": 0,       // 跳过的记录数（已经正确或数据缺失）
    "errorCount": 0,         // 修复失败的记录数
    "errors": []             // 错误详情（最多5条）
  }
}
```

## 修复逻辑

脚本会执行以下操作：

1. ✅ 查询所有状态为 `'treating'`（治疗中）的异常记录
2. ✅ 获取每条异常记录关联的 AI 诊断记录 ID
3. ✅ 检查 AI 诊断记录的 `hasTreatment` 字段
4. ✅ 如果为 `false`，则更新为 `true`
5. ✅ 同时记录最新的治疗记录 ID

## 注意事项

- ⚠️ 此脚本只修复当前登录用户的数据
- ⚠️ 已经正确标记的记录会自动跳过
- ⚠️ 如果诊断记录不存在或缺少诊断ID，会跳过该记录
- ✅ 修复操作不影响主流程，即使部分失败也会继续执行
- ✅ 修复后需要刷新健康管理页面才能看到更新后的数量

## 后续测试

修复完成后，请按以下步骤测试新的流程：

1. **创建新的AI诊断**
   - 进入"AI智能诊断"
   - 输入症状并获取诊断结果

2. **查看待处理数量**
   - 返回健康管理中心
   - 确认待处理卡片数量增加了1

3. **制定治疗方案**
   - 点击待处理卡片
   - 进入诊断详情
   - 制定治疗方案并提交

4. **验证数量更新**
   - 返回健康管理中心
   - 确认待处理数量减少了1
   - 确认治疗中数量增加了1

## 问题排查

如果修复后仍然显示错误数量：

1. **检查云函数是否上传成功**
   - 确认 `health-management` 云函数已重新上传
   - 查看云函数版本是否为最新

2. **清除小程序缓存**
   - 在开发者工具中点击"清除缓存" → "清除数据缓存"
   - 重新编译小程序

3. **检查数据库权限**
   - 确认 `health_ai_diagnosis` 集合的权限设置正确
   - 确认云函数有权限更新该集合

4. **查看云函数日志**
   - 在云开发控制台查看云函数调用日志
   - 检查是否有错误信息

## 联系支持

如果问题仍然存在，请提供以下信息：

- 修复脚本的返回结果
- 云函数调用日志
- 待处理卡片截图
- 诊断记录列表截图
