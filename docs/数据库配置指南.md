# 数据库集合权限与索引配置指南

> 本文档提供所有数据库集合的权限设置和索引配置指南，按照项目规范格式编写。
> 
> **重要**：在云开发控制台操作时，请严格按照本文档的格式设置。

---

## 一、权限配置说明

### 权限选项说明

微信云数据库提供 5 个权限选项（**互斥单选**）：

| 选项 | 说明 |
|------|------|
| **所有用户可读，仅创建者可读写** | 用户可读所有数据，只能写自己的数据 |
| **仅创建者可读写** | 用户只能读写自己的数据 |
| **所有用户可读** | 所有用户可读，无人可写（需云函数写入） |
| **所有用户不可读写** | 完全禁止客户端访问（需云函数操作） |
| **自定义安全规则** | 使用 JSON 规则自定义权限 |

### JSON 规则格式要求

```json
{
  "read": true,           // 布尔值或表达式
  "write": false          // 布尔值或表达式
}
```

**注意事项**：
- ✅ 必须使用双引号 `"`
- ✅ 布尔值 `true`/`false` 小写，不加引号
- ✅ 表达式用双引号包裹，使用 `doc.fieldName`（不是 `resource.fieldName`）
- ✅ 确保 JSON 格式完整

---

## 二、集合权限配置

### 2.1 用户管理模块 (4 个集合)

#### `wx_users` - 用户信息表

**权限设置**：自定义安全规则
```json
{
  "read": "doc._openid == auth.openid",
  "write": false
}
```
> 用户只能读取自己的信息，写入必须通过云函数

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_` | _openid | 升序 | 否 | 默认索引，保留 |
| `_id_` | _id | - | 是 | 主键索引，保留 |
| `phone_1` | phone | 升序 | 否 | 手机号查询 |
| `role_1` | role | 升序 | 否 | 角色筛选 |
| `status_1` | status | 升序 | 否 | 状态筛选 |

---

#### `wx_user_invites` - 用户邀请表

**权限设置**：所有用户不可读写
> 邀请管理完全通过云函数操作

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `inviteCode_1` | inviteCode | 升序 | 是 | 邀请码唯一查询 |
| `status_1_createTime_-1` | status, createTime | 升序, 降序 | 否 | 状态+时间筛选 |
| `inviterOpenId_1` | inviterOpenId | 升序 | 否 | 邀请人查询 |

---

#### `user_notifications` - 用户通知表

**权限设置**：自定义安全规则
```json
{
  "read": "doc._openid == auth.openid",
  "write": false
}
```
> 用户只能读取自己的通知，写入通过云函数

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_1_isRead_1_createTime_-1` | _openid, isRead, createTime | 升序, 升序, 降序 | 否 | 用户通知列表 |

---

#### `user_notification_settings` - 用户通知设置表

**权限设置**：仅创建者可读写
> 用户只能管理自己的通知设置

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_` | _openid | 升序 | 否 | 默认索引，保留 |

---

### 2.2 生产管理模块 (6 个集合)

#### `prod_batch_entries` - 入栏记录表

**权限设置**：自定义安全规则
```json
{
  "read": "doc.userId == auth.openid",
  "write": "doc.userId == auth.openid"
}
```
> 使用 `userId` 字段（业务字段）

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `userId_1_isDeleted_1_createTime_-1` | userId, isDeleted, createTime | 升序, 升序, 降序 | 否 | 用户记录列表 |
| `batchId_1` | batchId | 升序 | 否 | 批次查询 |
| `entryDate_-1` | entryDate | 降序 | 否 | 按入栏日期排序 |

---

#### `prod_batch_exits` - 出栏记录表

**权限设置**：自定义安全规则
```json
{
  "read": "doc.userId == auth.openid",
  "write": "doc.userId == auth.openid"
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `userId_1_isDeleted_1_createTime_-1` | userId, isDeleted, createTime | 升序, 升序, 降序 | 否 | 用户记录列表 |
| `batchId_1` | batchId | 升序 | 否 | 批次查询 |
| `exitDate_-1` | exitDate | 降序 | 否 | 按出栏日期排序 |

---

#### `prod_materials` - 物料信息表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```
> 所有用户可读物料信息，写入通过云函数

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `materialCode_1` | materialCode | 升序 | 是 | 物料编码唯一 |
| `category_1_isDeleted_1` | category, isDeleted | 升序, 升序 | 否 | 分类筛选 |
| `name_1` | name | 升序 | 否 | 名称搜索 |

---

#### `prod_material_records` - 物料出入库记录表

**权限设置**：自定义安全规则
```json
{
  "read": "doc.userId == auth.openid",
  "write": "doc.userId == auth.openid"
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `materialId_1_recordDate_-1` | materialId, recordDate | 升序, 降序 | 否 | 物料记录查询 |
| `recordType_1_recordDate_-1` | recordType, recordDate | 升序, 降序 | 否 | 类型+日期筛选 |
| `userId_1_createTime_-1` | userId, createTime | 升序, 降序 | 否 | 用户记录查询 |

---

#### `prod_inventory_logs` - 库存变动日志表

**权限设置**：所有用户不可读写
> 库存日志为系统流水，通过云函数记录

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `materialId_1_createTime_-1` | materialId, createTime | 升序, 降序 | 否 | 物料变动历史 |
| `operationType_1_createTime_-1` | operationType, createTime | 升序, 降序 | 否 | 操作类型筛选 |

---

#### `feed_usage_records` - 饲料投喂记录表

**权限设置**：自定义安全规则
```json
{
  "read": "doc.userId == auth.openid",
  "write": "doc.userId == auth.openid"
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_recordDate_-1` | batchId, recordDate | 升序, 降序 | 否 | 批次投喂记录 |
| `userId_1_isDeleted_1_recordDate_-1` | userId, isDeleted, recordDate | 升序, 升序, 降序 | 否 | 用户记录列表 |
| `materialId_1_recordDate_-1` | materialId, recordDate | 升序, 降序 | 否 | 物料使用统计 |

---

### 2.3 健康管理模块 (5 个集合)

#### `health_records` - 健康检查记录表

**权限设置**：所有用户可读，仅创建者可读写
> 健康记录公开可读

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_recordDate_-1` | batchId, recordDate | 升序, 降序 | 否 | 批次健康记录 |
| `_openid_1_createTime_-1` | _openid, createTime | 升序, 降序 | 否 | 用户记录列表 |

---

#### `health_prevention_records` - 防疫记录表

**权限设置**：所有用户可读，仅创建者可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_preventionDate_-1` | batchId, preventionDate | 升序, 降序 | 否 | 批次防疫记录 |
| `vaccineType_1` | vaccineType | 升序 | 否 | 疫苗类型筛选 |
| `_openid_1_createTime_-1` | _openid, createTime | 升序, 降序 | 否 | 用户记录列表 |

---

#### `health_treatment_records` - 治疗记录表

**权限设置**：所有用户可读，仅创建者可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_treatmentDate_-1` | batchId, treatmentDate | 升序, 降序 | 否 | 批次治疗记录 |
| `diseaseType_1` | diseaseType | 升序 | 否 | 疾病类型筛选 |
| `status_1` | status | 升序 | 否 | 治疗状态筛选 |
| `_openid_1_createTime_-1` | _openid, createTime | 升序, 降序 | 否 | 用户记录列表 |

---

#### `health_ai_diagnosis` - AI诊断记录表

**权限设置**：所有用户可读，仅创建者可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_1_createTime_-1` | _openid, createTime | 升序, 降序 | 否 | 用户诊断历史 |
| `diagnosisResult_1` | diagnosisResult | 升序 | 否 | 诊断结果筛选 |
| `batchId_1_createTime_-1` | batchId, createTime | 升序, 降序 | 否 | 批次诊断记录 |

---

#### `health_death_records` - 死亡记录表

**权限设置**：所有用户可读，仅创建者可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_deathDate_-1` | batchId, deathDate | 升序, 降序 | 否 | 批次死亡记录 |
| `deathCause_1` | deathCause | 升序 | 否 | 死因分类统计 |
| `_openid_1_isDeleted_1_deathDate_-1` | _openid, isDeleted, deathDate | 升序, 升序, 降序 | 否 | 用户记录列表 |

---

### 2.4 财务管理模块 (5 个集合)

#### `finance_cost_records` - 成本记录表

**权限设置**：所有用户可读，仅创建者可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_recordDate_-1` | batchId, recordDate | 升序, 降序 | 否 | 批次成本记录 |
| `costType_1_recordDate_-1` | costType, recordDate | 升序, 降序 | 否 | 成本类型筛选 |
| `_openid_1_isDeleted_1_createTime_-1` | _openid, isDeleted, createTime | 升序, 升序, 降序 | 否 | 用户记录列表 |

---

#### `finance_revenue_records` - 收入记录表

**权限设置**：所有用户可读，仅创建者可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_recordDate_-1` | batchId, recordDate | 升序, 降序 | 否 | 批次收入记录 |
| `revenueType_1_recordDate_-1` | revenueType, recordDate | 升序, 降序 | 否 | 收入类型筛选 |

---

#### `finance_reports` - 财务报表表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```
> 报表由系统生成，所有用户可读

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `reportType_1_reportPeriod_-1` | reportType, reportPeriod | 升序, 降序 | 否 | 报表类型+周期 |
| `batchId_1_reportPeriod_-1` | batchId, reportPeriod | 升序, 降序 | 否 | 批次报表 |

---

#### `finance_summaries` - 财务汇总表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `summaryType_1_summaryDate_-1` | summaryType, summaryDate | 升序, 降序 | 否 | 汇总类型+日期 |

---

#### `finance_analysis_history` - 财务分析历史表

**权限设置**：自定义安全规则
```json
{
  "read": "doc._openid == auth.openid",
  "write": false
}
```
> 用户只能查看自己的分析历史

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_1_createTime_-1` | _openid, createTime | 升序, 降序 | 否 | 用户分析历史 |

---

### 2.5 任务管理模块 (4 个集合)

#### `task_batch_schedules` - 批次任务计划表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `batchId_1_scheduledDate_1` | batchId, scheduledDate | 升序, 升序 | 否 | 批次任务计划 |
| `status_1_scheduledDate_1` | status, scheduledDate | 升序, 升序 | 否 | 待执行任务 |

---

#### `task_completions` - 任务完成记录表

**权限设置**：所有用户可读，仅创建者可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `taskId_1` | taskId | 升序 | 否 | 关联任务查询 |
| `completedBy_1_completedAt_-1` | completedBy, completedAt | 升序, 降序 | 否 | 完成人记录 |

---

#### `task_records` - 任务记录表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `taskType_1_status_1_dueDate_1` | taskType, status, dueDate | 升序, 升序, 升序 | 否 | 任务列表筛选 |
| `assignedTo_1_status_1` | assignedTo, status | 升序, 升序 | 否 | 指派人任务 |

---

#### `task_templates` - 任务模板表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `templateType_1_isActive_1` | templateType, isActive | 升序, 升序 | 否 | 模板类型筛选 |

---

### 2.6 系统管理模块 (11 个集合)

#### `sys_audit_logs` - 审计日志表

**权限设置**：所有用户不可读写
> 审计日志仅通过云函数记录，管理员通过云函数查询

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_1_createTime_-1` | _openid, createTime | 升序, 降序 | 否 | 用户操作日志 |
| `action_1_createTime_-1` | action, createTime | 升序, 降序 | 否 | 操作类型筛选 |
| `targetType_1_targetId_1` | targetType, targetId | 升序, 升序 | 否 | 目标对象查询 |

---

#### `sys_ai_cache` - AI缓存表

**权限设置**：所有用户不可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `cacheKey_1` | cacheKey | 升序 | 是 | 缓存键唯一 |
| `expireTime_1` | expireTime | 升序 | 否 | 过期清理 |

---

#### `sys_ai_usage` - AI使用统计表

**权限设置**：所有用户不可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_1_usageDate_-1` | _openid, usageDate | 升序, 降序 | 否 | 用户使用统计 |
| `modelType_1_usageDate_-1` | modelType, usageDate | 升序, 降序 | 否 | 模型使用统计 |

---

#### `sys_approval_logs` - 审批日志表

**权限设置**：所有用户不可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `approvalType_1_status_1_createTime_-1` | approvalType, status, createTime | 升序, 升序, 降序 | 否 | 审批列表 |
| `applicantId_1_createTime_-1` | applicantId, createTime | 升序, 降序 | 否 | 申请人记录 |

---

#### `sys_cleanup_logs` - 清理日志表

**权限设置**：所有用户不可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `cleanupType_1_cleanupTime_-1` | cleanupType, cleanupTime | 升序, 降序 | 否 | 清理记录 |

---

#### `sys_configurations` - 系统配置表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `configKey_1` | configKey | 升序 | 是 | 配置键唯一 |
| `configType_1` | configType | 升序 | 否 | 配置类型筛选 |

---

#### `sys_overview_stats` - 系统概览统计表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `statsType_1_statsDate_-1` | statsType, statsDate | 升序, 降序 | 否 | 统计类型+日期 |

---

#### `sys_notifications` - 系统通知表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `notificationType_1_isActive_1_createTime_-1` | notificationType, isActive, createTime | 升序, 升序, 降序 | 否 | 通知列表 |

---

#### `sys_permissions` - 权限配置表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `permissionCode_1` | permissionCode | 升序 | 是 | 权限码唯一 |

---

#### `sys_roles` - 角色配置表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `roleCode_1` | roleCode | 升序 | 是 | 角色码唯一 |

---

#### `sys_storage_statistics` - 存储统计表

**权限设置**：所有用户不可读写

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `statsDate_-1` | statsDate | 降序 | 否 | 按日期排序 |

---

### 2.7 知识库模块 (1 个集合)

#### `knowledge_articles` - 知识文章表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `category_1_isPublished_1_createTime_-1` | category, isPublished, createTime | 升序, 升序, 降序 | 否 | 文章列表 |
| `tags_1` | tags | 升序 | 否 | 标签搜索 |

---

### 2.8 AI模块 (1 个集合)

#### `ai_learning_cases` - AI学习案例表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `caseType_1_isVerified_1_createTime_-1` | caseType, isVerified, createTime | 升序, 升序, 降序 | 否 | 案例列表 |
| `diseaseType_1` | diseaseType | 升序 | 否 | 疾病类型筛选 |

---

### 2.9 文件管理模块 (2 个集合)

#### `file_dynamic_records` - 动态文件记录表

**权限设置**：自定义安全规则
```json
{
  "read": "doc._openid == auth.openid",
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `_openid_1_fileType_1_createTime_-1` | _openid, fileType, createTime | 升序, 升序, 降序 | 否 | 用户文件列表 |
| `relatedType_1_relatedId_1` | relatedType, relatedId | 升序, 升序 | 否 | 关联对象查询 |

---

#### `file_static_records` - 静态文件记录表

**权限设置**：自定义安全规则
```json
{
  "read": true,
  "write": false
}
```

**索引配置**：
| 索引名称 | 字段 | 排序 | 唯一 | 说明 |
|----------|------|------|------|------|
| `fileType_1_category_1` | fileType, category | 升序, 升序 | 否 | 文件分类 |

---

## 三、配置操作步骤

### 3.1 权限配置步骤

1. 登录 **微信云开发控制台**
2. 选择对应环境 → **数据库**
3. 点击目标集合 → **权限设置**
4. 根据本文档选择权限选项：
   - 如果是预设选项，直接选择
   - 如果是自定义规则，选择"自定义安全规则"，点击"修改"，粘贴 JSON

### 3.2 索引配置步骤

1. 在集合页面，点击 **索引管理**
2. 点击 **添加索引**
3. 填写：
   - **索引名称**：按本文档格式（如 `batchId_1_createTime_-1`）
   - **索引属性**：唯一/非唯一
   - **索引字段**：逐个添加，选择排序方向
4. 点击 **确定** 创建

### 3.3 注意事项

- ⚠️ **保留默认索引**：`_id_` 和 `_openid_` 索引必须保留
- ⚠️ **字段名一致**：索引字段名必须与数据字段完全一致
- ⚠️ **顺序正确**：复合索引字段顺序必须正确（最左匹配）
- ⚠️ **备份数据**：修改权限前建议备份重要数据

---

## 四、集合命名问题说明

### 当前存在的命名不一致

| 常量名 | 实际集合名 | 问题 | 建议 |
|--------|------------|------|------|
| `FEED_USAGE_RECORDS` | `feed_usage_records` | 缺少 `prod_` 前缀 | 保持现状（已有数据） |

> **说明**：由于该集合已有生产数据，暂不建议重命名。如需重命名，需要执行数据迁移。

---

**文档版本**：v1.0  
**更新日期**：2025-11-28  
**维护者**：开发团队
