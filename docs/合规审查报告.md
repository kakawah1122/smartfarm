# 鹅数通小程序合规审查报告

**审查日期**: 2025年1月  
**审查范围**: 微信小程序云开发规范、TDesign组件规范、数据库集合规范、页面规范、云函数规范、主包和分包规范  
**审查状态**: 功能大部分已测试，距离上线还需完成以下工作

---

## 📋 审查概览

### ✅ 符合规范的部分

1. **TDesign组件使用** ✅
   - 所有页面均按需在 `*.json` 中声明组件
   - 未发现未注册组件直接使用的情况
   - 组件样式覆盖使用外部样式类（`t-class`）和CSS变量

2. **数据库集合设计** ✅
   - 集合命名统一规范，使用模块前缀（`prod_`, `health_`, `finance_`等）
   - 所有云函数引用统一的 `collections.js` 配置文件
   - 集合设计扁平化，层级不超过3层

3. **详情弹窗组件** ✅
   - 已实现4个详情弹窗组件，符合 `[module]-record-detail-popup` 命名规范
   - 使用 `bottom-popup` 作为基础组件
   - 实现延迟清空数据机制（300ms）
   - 样式使用统一规范（`!important`、虚线分隔符等）

4. **页面布局** ✅（大部分）
   - 大部分页面已使用Flex布局（`height: 100vh` + `flex: 1`）
   - 使用 `content-wrapper` 统一处理导航栏高度
   - 添加 `safe-area` 处理安全区域

5. **云函数设计** ✅
   - 使用 `switch-case` 模式，基本符合单一职责原则
   - 统一错误处理机制
   - 使用统一的集合配置

---

## ⚠️ 需要修复的问题

### 🔴 高优先级问题

#### 1. 生产环境日志控制缺失

**问题描述**:
- 发现 **97处** `console.log/error/warn` 使用
- 缺少生产环境控制机制
- 项目规范要求：生产环境禁止直接输出 `console.log`，需通过 `process.env.DEBUG_LOG === 'true'` 控制

**影响**:
- 生产环境可能输出敏感调试信息
- 影响性能（日志输出开销）
- 不符合项目规范

**修复建议**:
```typescript
// 创建统一的日志工具
// utils/logger.ts
const DEBUG_LOG = process.env.DEBUG_LOG === 'true'

export const logger = {
  log: (...args: any[]) => {
    if (DEBUG_LOG) console.log(...args)
  },
  error: (...args: any[]) => {
    // error 始终输出，但可以添加上报机制
    console.error(...args)
  },
  warn: (...args: any[]) => {
    if (DEBUG_LOG) console.warn(...args)
  }
}

// 替换所有 console.log 为 logger.log
// 替换所有 console.warn 为 logger.warn
// console.error 保留（用于错误追踪）
```

**涉及文件**: 所有包含 `console.log/warn` 的文件（97处）

---

#### 2. 页面布局不符合Flex规范

**问题描述**:
发现 **3个页面** 使用 `min-height: calc(100vh - xxx)`，不符合项目Flex布局规范

**不符合规范的页面**:
1. `miniprogram/packageHealth/treatment-records-list/treatment-records-list.scss` (2处)
2. `miniprogram/packageHealth/cured-records-list/cured-records-list.scss` (1处)

**修复建议**:
按照项目规范，改为Flex布局：

```scss
// ❌ 错误做法
.loading-container {
  min-height: calc(100vh - var(--navbar-height, 132rpx) - 100rpx);
}

// ✅ 正确做法
.page-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.content-wrapper {
  flex: 1;
  margin-top: calc(var(--status-bar-height, 44rpx) + var(--navbar-height, 88rpx) + 16rpx);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.list-container {
  flex: 1;
  padding: 16rpx 24rpx;
  box-sizing: border-box;
}
```

---

#### 3. 详情弹窗未完全组件化

**问题描述**:
`cured-records-list` 页面仍包含详情弹窗代码在页面中，未使用独立组件

**修复建议**:
1. 创建 `cured-record-detail-popup` 组件
2. 将页面中的弹窗代码迁移到组件
3. 删除页面中的弹窗样式代码

---

### 🟡 中优先级问题

#### 4. TODO标记未处理

**问题描述**:
- `miniprogram/app.ts:43` - 订阅消息模板ID未配置
- 其他TODO标记（117处，但大部分是代码注释，非阻塞）

**修复建议**:
```typescript
// app.ts
subscriptionTemplates: [
  { tmplId: 'REAL_TEMPLATE_ID_1', title: '系统交互消息', description: '系统审批、任务通知等提醒' },
  { tmplId: 'REAL_TEMPLATE_ID_2', title: '生产进度提醒', description: '生产计划、排行榜等动态提醒' }
]
```

---

#### 5. 调试代码残留

**问题描述**:
- `miniprogram/packageUser/invite-management/invite-management.ts` 包含 `debugInfo` 调试代码
- `miniprogram/packageUser/login/login.ts` 包含调试信息输出

**修复建议**:
- 移除或使用条件编译控制调试代码
- 使用统一的日志工具

---

### 🟢 低优先级问题

#### 6. 代码注释和文档

**问题描述**:
- 部分代码包含"从breeding-todo迁移"等注释，建议清理
- 部分函数缺少JSDoc注释

**修复建议**:
- 清理迁移注释
- 为关键函数添加JSDoc注释

---

## 📦 包大小检查

### 当前状态
- 源码大小: 约3.1MB（未压缩）
- 主包页面: 12个（符合tabBar页面必须在主包的要求）
- 分包数量: 5个（production, health, user, finance, ai）

### 建议
1. **编译后检查**: 需要在微信开发者工具中检查编译后的包大小
2. **主包限制**: 确保主包 ≤ 2MB
3. **总包限制**: 确保主包 + 分包 ≤ 20MB（服务商代开发）

---

## 🔍 云函数审查

### ✅ 符合规范
- 使用统一的集合配置
- 错误处理统一
- 基本符合单一职责原则

### ⚠️ 建议优化
1. **超时时间设置**: 检查云函数超时时间配置（建议3-60秒）
2. **并发控制**: 检查高并发场景的处理（如AI诊断）
3. **审计日志**: 确认敏感操作已添加审计日志

---

## 📊 数据库审查

### ✅ 符合规范
- 集合命名统一规范
- 使用模块前缀
- 设计扁平化

### ⚠️ 建议检查
1. **索引优化**: 确认高频查询字段已建立索引
2. **文档大小**: 确认单个文档不超过限制
3. **查询优化**: 确认使用 `select` 只查询必要字段

---

## 🎯 上线前必做清单

### 🔴 必须完成（阻塞上线）

- [ ] **修复生产环境日志控制**
  - [ ] 创建统一的日志工具
  - [ ] 替换所有 `console.log/warn`（97处）
  - [ ] 配置 `DEBUG_LOG` 环境变量

- [ ] **修复页面布局不符合规范**
  - [ ] `treatment-records-list` 页面改为Flex布局
  - [ ] `cured-records-list` 页面改为Flex布局

- [ ] **完成详情弹窗组件化**
  - [ ] 创建 `cured-record-detail-popup` 组件
  - [ ] 迁移页面代码到组件
  - [ ] 删除页面中的弹窗代码

### 🟡 建议完成（影响体验）

- [ ] **配置订阅消息模板ID**
  - [ ] 在微信公众平台获取真实模板ID
  - [ ] 更新 `app.ts` 中的配置

- [ ] **清理调试代码**
  - [ ] 移除或条件编译 `debugInfo` 相关代码
  - [ ] 清理迁移注释

### 🟢 可选优化（不影响上线）

- [ ] **代码文档完善**
  - [ ] 为关键函数添加JSDoc
  - [ ] 清理无用注释

- [ ] **包大小优化**
  - [ ] 检查编译后包大小
  - [ ] 优化图片资源
  - [ ] 检查是否有冗余代码

---

## 📝 合规性总结

| 规范项 | 状态 | 说明 |
|--------|------|------|
| TDesign组件规范 | ✅ 通过 | 按需引入，符合规范 |
| 数据库集合规范 | ✅ 通过 | 命名统一，设计扁平化 |
| 详情弹窗组件规范 | ⚠️ 部分 | 4个组件符合，1个页面未组件化 |
| 页面布局规范 | ⚠️ 部分 | 大部分符合，3个页面需修复 |
| 云函数规范 | ✅ 通过 | 基本符合单一职责 |
| 日志规范 | ❌ 不通过 | 缺少生产环境控制 |
| 主包分包规范 | ⚠️ 待检查 | 需检查编译后大小 |

---

## 🚀 上线时间预估

### 阻塞问题修复时间
- 日志控制修复: **2-3小时**
- 页面布局修复: **1-2小时**
- 详情弹窗组件化: **1-2小时**

**总计**: **4-7小时**（1个工作日）

### 建议完成时间
- 订阅消息配置: **0.5小时**
- 调试代码清理: **1小时**

**总计**: **1.5小时**

---

## 📞 后续建议

1. **建立CI/CD检查**: 在提交前自动检查规范符合性
2. **代码审查流程**: 确保新代码符合项目规范
3. **定期合规审查**: 每季度进行一次全面合规审查
4. **文档更新**: 及时更新项目规范文档

---

**报告生成时间**: 2025年1月  
**审查人员**: AI Assistant  
**下次审查建议**: 修复完成后进行复查

