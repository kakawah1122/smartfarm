# 微信小程序域名白名单配置指南

## 🚨 重要：403错误的主要原因

如果您遇到 `Request failed with status code 403` 错误，很可能是因为**域名未加入白名单**。

## 📋 配置步骤

### 第一步：登录微信公众平台

1. 访问：https://mp.weixin.qq.com/
2. 使用小程序管理员账号登录

### 第二步：进入开发设置

1. 在左侧菜单中点击 **"开发"**
2. 选择 **"开发管理"**
3. 点击 **"开发设置"**

### 第三步：配置服务器域名

在 **"服务器域名"** 部分：

#### request合法域名
添加以下域名到 **request合法域名** 中：

```
https://n96apwfjn2.re.qweatherapi.com
https://api.qweather.com
```

**重要**：您拥有专用的API Host `n96apwfjn2.re.qweatherapi.com`，这是更安全的选择。

#### 具体操作：
1. 点击 **"request合法域名"** 右侧的 **"修改"** 按钮
2. 在弹出的输入框中添加上述域名
3. 每个域名占一行
4. 点击 **"保存并提交"**

### 第四步：验证配置

配置完成后：
1. 等待 **5-10分钟** 让配置生效
2. 重新部署云函数
3. 测试天气功能

## 🔍 其他可能的403错误原因

### 1. API密钥问题
- 检查API密钥是否正确
- 确认API密钥状态是否正常
- 验证API密钥类型（免费版/商业版）

### 2. API端点问题
- 免费版用户使用：`https://devapi.qweather.com`
- 商业版用户使用：`https://api.qweather.com`

### 3. 请求频率限制
- 免费版：每天1000次，每分钟10次
- 检查是否超过调用限制

## 🧪 测试方法

### 方法1：使用云函数日志
1. 部署更新后的云函数
2. 测试天气功能
3. 查看云函数日志中的详细错误信息

### 方法2：使用本地测试脚本
1. 修改 `test-hefeng-direct.js` 中的API密钥
2. 运行：`node test-hefeng-direct.js`
3. 查看测试结果

## ⚠️ 常见错误信息

| 错误码 | 含义 | 解决方案 |
|--------|------|----------|
| 403 | 无访问权限 | 配置域名白名单 |
| 401 | 认证失败 | 检查API密钥 |
| 402 | 超过调用次数 | 升级账户或等待重置 |
| 404 | 位置不存在 | 检查经纬度格式 |

## 🎯 完成确认

配置成功后，您应该看到：
- ✅ 云函数日志显示API调用成功
- ✅ 天气数据来源为 `hefeng_api`
- ✅ 显示真实的天气信息
- ✅ 不再出现403错误

---

**如果按照此指南配置后仍有问题，请提供云函数的详细日志信息以便进一步诊断。**
