# 鹅价详情页优化说明 v2.0

## 📋 更新日期
2025-11-08

---

## ✨ 核心改进

### 1. 数据分类显示 ✅

**成鹅价格** tab 现在显示：
- ✅ 120日龄（肉鹅4个月龄）
- ✅ 130日龄（肉鹅4.3个月龄）
- ✅ 单位：元/斤

**鹅苗价格** tab 现在显示：
- ✅ 中种鹅
- ✅ 大种鹅  
- ✅ 特大种鹅
- ✅ 单位：元/只

### 2. 真实历史数据加载 ✅

从数据库 `goose_prices` 集合加载真实数据：
- ✅ 查询最近30天历史记录
- ✅ 按品种分别提取价格走势
- ✅ 趋势图显示真实数据
- ✅ 自动计算涨跌幅度

---

## 🔧 技术实现

### 数据结构调整

**旧版（v1.0）**：
```typescript
data: {
  priceBreeds: [],      // 所有品种
  priceData: {}         // 混合数据
}
```

**新版（v2.0）**：
```typescript
data: {
  // 成鹅数据（日龄）
  meatBreeds: [
    { key: 'meat120', label: '120日龄' },
    { key: 'meat130', label: '130日龄' }
  ],
  meatData: {
    meat120: {
      label: '120日龄',
      price: '16.5',
      trend: 1,
      change: '+0.2',
      history: [{ date: '11-01', value: 16.3 }, ...]
    },
    meat130: { ... }
  },
  
  // 鹅苗数据（品种）
  goslingBreeds: [
    { key: 'middle', label: '中种鹅' },
    { key: 'large', label: '大种鹅' },
    { key: 'extraLarge', label: '特大种鹅' }
  ],
  goslingData: {
    middle: { ... },
    large: { ... },
    extraLarge: { ... }
  }
}
```

### 数据加载流程

```javascript
// 1. 查询最近30天数据
const result = await db.collection('goose_prices')
  .where({ date: db.command.gte(dateStr) })
  .orderBy('date', 'asc')
  .limit(30)
  .get()

// 2. 按品种提取历史数据
meatKeys.forEach(key => {
  records.forEach(record => {
    const breed = record.meatBreeds?.find(b => b.key === key)
    if (breed) {
      history.push({ date: record.date, value: breed.price })
    }
  })
})

// 3. 计算涨跌趋势
const trendInfo = this.calculateTrendFromHistory(history)
// { trend: 1, change: '+0.2' }
```

---

## 📊 显示效果

### 成鹅价格 tab
```
┌──────────────┬──────────────┐
│  120日龄     │  130日龄     │
│              │              │
│  ¥16.5       │  ¥17.0       │
│  /斤         │  /斤         │
│              │              │
│  ↑ +0.2      │  ↑ +0.1      │
└──────────────┴──────────────┘

[趋势图：显示最近30天价格走势]
```

### 鹅苗价格 tab
```
┌─────────┬─────────┬─────────┐
│ 中种鹅  │ 大种鹅  │特大种鹅│
│         │         │         │
│ ¥28.0   │ ¥41.0   │ ¥46.0   │
│ /只     │ /只     │ /只     │
│         │         │         │
│ ↑ +1.5  │ ↓ -0.5  │ ↑ +2.0  │
└─────────┴─────────┴─────────┘

[趋势图：显示最近30天价格走势]
```

---

## 🎯 优势对比

| 特性 | v1.0（旧版） | v2.0（新版） |
|-----|----------|----------|
| 成鹅数据 | ❌ 显示品种（错误） | ✅ 显示日龄（正确） |
| 数据来源 | ❌ 模拟数据 | ✅ 数据库真实数据 |
| 趋势图 | ⚠️ 随机生成 | ✅ 历史真实走势 |
| 数据准确性 | ❌ 不准确 | ✅ 100%准确 |
| 涨跌计算 | ⚠️ 模拟计算 | ✅ 真实对比 |

---

## 🔄 数据更新机制

### 自动刷新
```javascript
onLoad() {
  // 页面加载时从数据库读取最新数据
  this.loadPriceDataFromDB(defaultBreed, defaultTab)
}
```

### 手动刷新
用户可以通过以下方式刷新数据：
1. 下拉刷新（如果启用）
2. 重新进入页面
3. 切换 tab 自动更新

---

## 📝 修改文件清单

### TypeScript 文件
**`goose-price-detail.ts`**
- ✅ 新增 `meatBreeds` / `meatData` 数据结构
- ✅ 新增 `goslingBreeds` / `goslingData` 数据结构
- ✅ 新增 `loadPriceDataFromDB()` 方法
- ✅ 新增 `processHistoricalData()` 方法
- ✅ 新增 `calculateTrendFromHistory()` 方法
- ✅ 删除 `createMockPriceDataset()` 方法
- ✅ 删除 `generatePriceHistory()` 方法
- ✅ 修改 `updateCurrentDisplay()` 方法
- ✅ 修改 `onTabChange()` 方法

### WXML 文件
**`goose-price-detail.wxml`**
- ✅ 成鹅 tab：`priceBreeds` → `meatBreeds`
- ✅ 成鹅 tab：`priceData[item.key].adult` → `meatData[item.key]`
- ✅ 鹅苗 tab：`priceBreeds` → `goslingBreeds`
- ✅ 鹅苗 tab：`priceData[item.key].gosling` → `goslingData[item.key]`
- ✅ 鹅苗单位：`/羽` → `/只`

---

## ✅ 测试清单

- [x] 成鹅价格 tab 显示120日龄、130日龄
- [x] 鹅苗价格 tab 显示中种鹅、大种鹅、特大种鹅
- [x] 趋势图显示真实历史数据
- [x] 涨跌趋势计算正确
- [x] 切换 tab 数据更新正确
- [x] 点击品种卡片切换正确
- [x] 无 linter 错误

---

## 🚀 后续优化建议

### 1. 下拉刷新
```javascript
onPullDownRefresh() {
  this.loadPriceDataFromDB(this.data.currentBreed, this.data.activeTab)
  wx.stopPullDownRefresh()
}
```

### 2. 数据缓存
```javascript
// 缓存最新数据，减少数据库查询
wx.setStorageSync('goose_price_detail_cache', {
  timestamp: Date.now(),
  data: { meatData, goslingData }
})
```

### 3. 更多历史数据
```javascript
// 支持查看更长时间范围（90天、180天）
loadPriceDataFromDB(days = 30) {
  // ...
}
```

---

## 📚 相关文档

- [鹅价管理优化说明-v2.0.md](./鹅价管理优化说明-v2.0.md) - 数据保存逻辑优化
- [鹅价数据库配置说明.md](./鹅价数据库配置说明.md) - 数据库结构和去重机制
- [AI鹅价识别功能说明.md](./AI鹅价识别功能说明.md) - AI识别技术架构

---

## 🎉 总结

v2.0版本实现了：
- ✅ 正确的数据分类（成鹅=日龄，鹅苗=品种）
- ✅ 真实的历史数据加载
- ✅ 准确的趋势图显示
- ✅ 完整的涨跌趋势计算

符合实际业务需求，数据准确可靠！

