# 数据库集合不存在 - 快速修复指南

## 问题描述
错误信息：`database collection not exists (-502005)`
这意味着 `users` 数据库集合还没有被创建。

## 快速修复方案

### 方案一：使用新创建的初始化云函数（推荐）

1. **部署新的云函数**
   ```bash
   # 在项目根目录执行
   cd cloudfunctions/database
   npm install
   cd ../..
   
   # 上传并部署云函数
   # 在微信开发者工具中右键 cloudfunctions/database 文件夹
   # 选择 "上传并部署：云端安装依赖"
   ```

2. **调用初始化函数**
   - 在微信开发者工具的"云开发"面板中
   - 选择"云函数" -> "manual-init"
   - 点击"测试"按钮
   - 输入测试参数：`{}` 
   - 点击"调用云函数"

3. **验证修复结果**
   - 重新尝试登录功能
   - 如果成功，问题已解决

### 方案二：手动在云开发控制台创建集合

1. **打开云开发控制台**
   - 在微信开发者工具中点击"云开发"
   - 选择"数据库"选项卡

2. **创建集合**
   - 点击"+"号创建新集合
   - 输入集合名称：`users`
   - 选择权限：仅创建者可读写
   - 点击"确定"

3. **验证**
   - 集合创建成功后，重新尝试登录

### 方案三：重新部署所有云函数

如果上述方案都不work，可以尝试重新部署：

1. **重新部署login云函数**
   ```bash
   cd cloudfunctions/login
   npm install
   ```
   - 右键login文件夹 -> "上传并部署：云端安装依赖"

2. **重新部署register云函数**  
   ```bash
   cd cloudfunctions/register
   npm install
   ```
   - 右键register文件夹 -> "上传并部署：云端安装依赖"

## 修复说明

我已经改进了您的云函数代码：

✅ **login云函数**：增强了对集合不存在错误的处理
✅ **register云函数**：添加了集合不存在的错误检查  
✅ **新增manual-init云函数**：专门用于初始化数据库集合

## 预防措施

为了避免类似问题，建议：

1. **在开发环境中先初始化数据库**
2. **部署前确保所有必要的数据库集合都已创建**
3. **在云函数中加入更完善的错误处理**

## 验证修复

修复后，您应该能看到：
- 登录功能正常工作
- 不再出现 `-502005` 错误
- 用户信息能正常保存到数据库

如果问题持续存在，请检查：
- 云开发环境ID是否正确
- 云函数是否正确部署
- 网络连接是否正常
