# å¥åº·ç®¡ç†ä¸­å¿ƒé¡µé¢ - å…¨é¢å®¡æŸ¥æŠ¥å‘Š

> åŸºäºå¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘æœ€ä½³å®è·µã€TDesignè§„èŒƒå’Œé¡¹ç›®è§„èŒƒçš„æ·±åº¦å®¡æŸ¥

## ğŸ“Š é¡µé¢æ¦‚è§ˆ

**æ–‡ä»¶ç»Ÿè®¡**ï¼š
- æ€»ä»£ç è¡Œæ•°ï¼š**5,197è¡Œ**
- ä¸»æ–‡ä»¶ï¼š`health.ts` (2,023è¡Œ)
- æ¨¡å—æ–‡ä»¶ï¼š4ä¸ª
  - `health-data-loader.ts` (533è¡Œ)
  - `health-stats-calculator.ts` 
  - `health-utils.ts`
  - `health-watchers.ts`
- æ ·å¼æ–‡ä»¶ï¼š`health.scss` (1,871è¡Œ)
- æ¨¡æ¿æ–‡ä»¶ï¼š`health.wxml` (460è¡Œ)

**äº‘å‡½æ•°è°ƒç”¨ç»Ÿè®¡**ï¼š
- ä¸»æ–‡ä»¶ï¼š12æ¬¡
- æ¨¡å—æ–‡ä»¶ï¼š7æ¬¡
- **æ€»è®¡ï¼š19æ¬¡äº‘å‡½æ•°è°ƒç”¨**

---

## ğŸ” 1. æ•°æ®æµè½¬åˆ†æ

### 1.1 é¡µé¢åŠ è½½æµç¨‹

```
ç”¨æˆ·è¿›å…¥é¡µé¢
    â†“
onLoad()
    â†“
loadAvailableBatches()  â† äº‘å‡½æ•°è°ƒç”¨#1
    â†“
loadHealthData()
    â†“
åˆ¤æ–­æ‰¹æ¬¡ç±»å‹
    â”œâ”€â”€ å…¨éƒ¨æ‰¹æ¬¡ â†’ loadAllBatchesData()
    â”‚      â†“
    â”‚      äº‘å‡½æ•°è°ƒç”¨#2: get_all_batches_health_summary
    â”‚      â†“
    â”‚      å¹¶è¡ŒåŠ è½½ (Promise.all)
    â”‚      â”œâ”€â”€ æ²»ç–—æ•°æ® (æ¯ä¸ªæ‰¹æ¬¡) â†’ äº‘å‡½æ•°è°ƒç”¨#3-N
    â”‚      â”œâ”€â”€ å¼‚å¸¸æ•°æ® â†’ äº‘å‡½æ•°è°ƒç”¨#N+1
    â”‚      â””â”€â”€ éš”ç¦»æ•°æ® â†’ äº‘å‡½æ•°è°ƒç”¨#N+2
    â”‚      â†“
    â”‚      è®¡ç®—å¥åº·ç‡ï¼ˆä¸€æ¬¡æ€§ï¼‰
    â”‚      â†“
    â”‚      setData()
    â”‚
    â””â”€â”€ å•ä¸ªæ‰¹æ¬¡ â†’ Promise.all([
           loadHealthOverview(),  â† äº‘å‡½æ•°è°ƒç”¨#3
           loadPreventionData(),  â† äº‘å‡½æ•°è°ƒç”¨#4
           loadTreatmentData()    â† äº‘å‡½æ•°è°ƒç”¨#5
        ])
```

### 1.2 æ•°æ®æ›´æ–°æµç¨‹

```
å®æ—¶ç›‘å¬ (startDataWatcher)
    â†“
healthRecordsWatcher / deathRecordsWatcher
    â†“
onChange äº‹ä»¶è§¦å‘
    â†“
é˜²æŠ– (1000ms)
    â†“
loadHealthData()
    â†“
_backgroundRefreshAllBatches()
    â†“
å·®å¼‚å¯¹æ¯” (å¥åº·ç‡å˜åŒ– < 0.01%)
    â”œâ”€â”€ æœ‰å˜åŒ– â†’ setData()
    â””â”€â”€ æ— å˜åŒ– â†’ è·³è¿‡æ›´æ–°
```

**âœ… ä¼˜ç‚¹**ï¼š
1. ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é¢‘ç¹åˆ·æ–°
2. å®ç°äº†å·®å¼‚å¯¹æ¯”ï¼Œå‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“
3. å¹¶è¡ŒåŠ è½½æ•°æ®ï¼Œæå‡æ€§èƒ½

**âš ï¸ é—®é¢˜**ï¼š
1. ~~onShowæ—¶ä¼šé‡å¤åˆ·æ–°~~ ï¼ˆå·²ä¿®å¤ï¼‰
2. æ¨¡å—åŒ–åä»æœ‰é‡å¤çš„äº‘å‡½æ•°è°ƒç”¨é€»è¾‘

---

## ğŸ”§ 2. äº‘å‡½æ•°è°ƒç”¨ä¼˜åŒ–åˆ†æ

### 2.1 äº‘å‡½æ•°è°ƒç”¨æ¸…å•

| åºå· | ä½ç½® | äº‘å‡½æ•°åç§° | Action | ç”¨é€” | é¢‘ç‡ |
|------|------|-----------|--------|------|------|
| 1 | health.ts:528 | health-management | get_all_batches_health_summary | è·å–æ‰€æœ‰æ‰¹æ¬¡å¥åº·æ±‡æ€» | onLoad |
| 2 | health.ts:626 | health-management | calculate_treatment_cost | æ‰¹é‡è®¡ç®—æ²»ç–—æˆæœ¬ | Næ¬¡ï¼ˆæ¯æ‰¹æ¬¡ï¼‰ |
| 3 | health.ts:682 | health-management | get_health_records_by_status | è·å–å¼‚å¸¸è®°å½• | onLoad |
| 4 | health.ts:690 | health-management | get_health_records_by_status | è·å–éš”ç¦»è®°å½• | onLoad |
| 5 | health.ts:790 | health-management | get_all_batches_health_summary | åå°åˆ·æ–°ï¼ˆé‡å¤ï¼‰ | onChange |
| 6 | health.ts:806 | health-management | calculate_treatment_cost | åå°åˆ·æ–°ï¼ˆé‡å¤ï¼‰ | onChange |
| 7 | health.ts:858 | health-management | get_health_records_by_status | åå°åˆ·æ–°ï¼ˆé‡å¤ï¼‰ | onChange |
| 8 | health.ts:870 | health-management | get_health_records_by_status | åå°åˆ·æ–°ï¼ˆé‡å¤ï¼‰ | onChange |
| 9 | health-data-loader.ts:59 | health-management | get_all_batches_health_summary | æ¨¡å—å†…è°ƒç”¨ | ç¼“å­˜å¤±æ•ˆ |

### 2.2 é‡å¤è°ƒç”¨é—®é¢˜

**ğŸ”´ ä¸¥é‡é—®é¢˜**ï¼š`loadAllBatchesData()` å’Œ `_backgroundRefreshAllBatches()` å­˜åœ¨**å®Œå…¨é‡å¤**çš„äº‘å‡½æ•°è°ƒç”¨é€»è¾‘ï¼

**ä»£ç é‡å¤ç¤ºä¾‹**ï¼š

```typescript
// âŒ é—®é¢˜1: loadAllBatchesData() (ç¬¬528-750è¡Œ)
async loadAllBatchesData() {
  const healthResult = await wx.cloud.callFunction({
    name: 'health-management',
    data: { action: 'get_all_batches_health_summary' }
  })
  
  // ... å¤„ç†æ•°æ®
  
  const treatmentPromises = batches.map(async (batch: any) => {
    const result = await wx.cloud.callFunction({
      name: 'health-management',
      data: {
        action: 'calculate_treatment_cost',
        batchId: batch._id
      }
    })
    // ...
  })
  
  const [abnormalResult, isolatedResult] = await Promise.all([
    wx.cloud.callFunction({ ... }),
    wx.cloud.callFunction({ ... })
  ])
}

// âŒ é—®é¢˜2: _backgroundRefreshAllBatches() (ç¬¬788-936è¡Œ)
async _backgroundRefreshAllBatches() {
  // âš ï¸ å®Œå…¨ç›¸åŒçš„äº‘å‡½æ•°è°ƒç”¨é€»è¾‘ï¼
  const healthResult = await wx.cloud.callFunction({
    name: 'health-management',
    data: { action: 'get_all_batches_health_summary' }
  })
  
  // ... ç›¸åŒçš„å¤„ç†é€»è¾‘
  
  const treatmentPromises = batches.map(async (batch: any) => {
    const result = await wx.cloud.callFunction({
      name: 'health-management',
      data: {
        action: 'calculate_treatment_cost',
        batchId: batch._id
      }
    })
    // ...
  })
  
  const [abnormalResult, isolatedResult] = await Promise.all([
    wx.cloud.callFunction({ ... }),
    wx.cloud.callFunction({ ... })
  ])
}
```

**å½±å“**ï¼š
- ä»£ç é‡å¤çº¦**150è¡Œ**
- ç»´æŠ¤æˆæœ¬é«˜ï¼ˆä¿®æ”¹éœ€è¦ä¸¤å¤„åŒæ­¥ï¼‰
- è¿åDRYåŸåˆ™

### 2.3 äº‘å‡½æ•°åˆå¹¶å»ºè®®

**æ ¹æ®å¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘æœ€ä½³å®è·µ**ï¼š

> "åˆå¹¶å¤šæ¬¡æ“ä½œä¸ºä¸€æ¬¡å®Œæˆï¼Œé™ä½APIæ¥å£è®¿é—®é‡å’Œæ•°æ®åº“è¯»å†™æ¬¡æ•°"

**å½“å‰é—®é¢˜**ï¼š
- æ¯ä¸ªæ‰¹æ¬¡å•ç‹¬è°ƒç”¨ `calculate_treatment_cost`
- å¦‚æœæœ‰10ä¸ªæ‰¹æ¬¡ï¼Œä¼šè°ƒç”¨**10æ¬¡äº‘å‡½æ•°**

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```typescript
// âœ… å»ºè®®ï¼šåœ¨äº‘å‡½æ•°ç«¯æ‰¹é‡è®¡ç®—
// cloudfunctions/health-management/index.js
async function calculateBatchTreatmentCosts(event, wxContext) {
  const { batchIds } = event
  
  // æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰æ‰¹æ¬¡çš„æ²»ç–—æ•°æ®
  const results = await Promise.all(
    batchIds.map(batchId => 
      db.collection('health_treatment_records')
        .where({ batchId })
        .get()
    )
  )
  
  // æ‰¹é‡è®¡ç®—
  return batchIds.map((batchId, index) => ({
    batchId,
    ...calculateCostForBatch(results[index].data)
  }))
}
```

```typescript
// å‰ç«¯è°ƒç”¨
const treatmentResult = await wx.cloud.callFunction({
  name: 'health-management',
  data: {
    action: 'calculate_batch_treatment_costs',  // æ–°action
    batchIds: batches.map(b => b._id)
  }
})

// 10æ¬¡äº‘å‡½æ•°è°ƒç”¨ â†’ 1æ¬¡äº‘å‡½æ•°è°ƒç”¨
// å‡å°‘è°ƒç”¨æ¬¡æ•°ï¼š90%
```

---

## ğŸ’¾ 3. ç¼“å­˜æœºåˆ¶å®¡æŸ¥

### 3.1 ç°æœ‰ç¼“å­˜

**ä½ç½®**ï¼š`health-data-loader.ts` (ç¬¬7-42è¡Œ)

```typescript
const batchDataCache = new Map()
const CACHE_DURATION = 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜
```

**âœ… ä¼˜ç‚¹**ï¼š
- å®ç°äº†åŸºç¡€ç¼“å­˜æœºåˆ¶
- ç¼“å­˜æ—¶é—´åˆç†ï¼ˆ5åˆ†é’Ÿï¼‰

**âš ï¸ é—®é¢˜**ï¼š

1. **ç¼“å­˜èŒƒå›´æœ‰é™**
   - åªç¼“å­˜äº† `loadAllBatchesData()` çš„ç»“æœ
   - å…¶ä»–æ•°æ®åŠ è½½æ²¡æœ‰ç¼“å­˜

2. **ç¼“å­˜å¤±æ•ˆç­–ç•¥ä¸å®Œå–„**
   - æ•°æ®æ›´æ–°åç¼“å­˜æ²¡æœ‰è‡ªåŠ¨å¤±æ•ˆ
   - å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

3. **å†…å­˜æ³„æ¼é£é™©**
   - ä½¿ç”¨ `Map` ä½†æ²¡æœ‰æ¸…ç†æœºåˆ¶
   - é•¿æ—¶é—´è¿è¡Œå¯èƒ½å ç”¨è¿‡å¤šå†…å­˜

### 3.2 ä¼˜åŒ–å»ºè®®

**æ ¹æ®å¾®ä¿¡å°ç¨‹åºæœ€ä½³å®è·µ**ï¼š

> "åœ¨å‰ç«¯ä½¿ç”¨ç¼“å­˜æˆ–æœ¬åœ°å­˜å‚¨ï¼Œå‡å°‘å¯¹äº‘å‡½æ•°çš„ä¾èµ–"

```typescript
// âœ… å»ºè®®ï¼šä½¿ç”¨å¾®ä¿¡å°ç¨‹åºå­˜å‚¨API
async function loadWithCache(cacheKey: string, loader: () => Promise<any>, duration = 300000) {
  try {
    // å°è¯•ä»æœ¬åœ°å­˜å‚¨è¯»å–
    const cached = wx.getStorageSync(cacheKey)
    if (cached && cached.timestamp && Date.now() - cached.timestamp < duration) {
      return cached.data
    }
  } catch (e) {
    // ç¼“å­˜è¯»å–å¤±è´¥ï¼Œç»§ç»­åŠ è½½
  }
  
  // åŠ è½½æ–°æ•°æ®
  const data = await loader()
  
  // å­˜å‚¨åˆ°æœ¬åœ°
  try {
    wx.setStorageSync(cacheKey, {
      data,
      timestamp: Date.now()
    })
  } catch (e) {
    // å­˜å‚¨å¤±è´¥ï¼Œä¸å½±å“è¿”å›
  }
  
  return data
}

// ä½¿ç”¨
const healthData = await loadWithCache(
  'health_all_batches',
  () => wx.cloud.callFunction({
    name: 'health-management',
    data: { action: 'get_all_batches_health_summary' }
  })
)
```

**ä¼˜åŠ¿**ï¼š
- æŒä¹…åŒ–å­˜å‚¨ï¼Œå°ç¨‹åºå…³é—­åä»å¯ç”¨
- è‡ªåŠ¨ç®¡ç†å†…å­˜
- ç¬¦åˆå¾®ä¿¡å°ç¨‹åºè§„èŒƒ

---

## ğŸ¨ 4. ä»£ç è´¨é‡å®¡æŸ¥

### 4.1 ä»£ç ç»“æ„

**âœ… ä¼˜ç‚¹**ï¼š
1. **æ¨¡å—åŒ–è®¾è®¡è‰¯å¥½**
   ```
   health.ts (ä¸»æ–‡ä»¶)
   â”œâ”€â”€ health-data-loader.ts    (æ•°æ®åŠ è½½)
   â”œâ”€â”€ health-stats-calculator.ts (ç»Ÿè®¡è®¡ç®—)
   â”œâ”€â”€ health-utils.ts           (å·¥å…·å‡½æ•°)
   â””â”€â”€ health-watchers.ts        (å®æ—¶ç›‘å¬)
   ```

2. **TypeScriptç±»å‹å®šä¹‰å®Œå–„**
   - 15ä¸ªæ¥å£å®šä¹‰
   - ç±»å‹å®‰å…¨

3. **é˜²æŠ–å’Œé˜²é‡å¤æœºåˆ¶**
   - `loadDataDebounceTimer` (300msé˜²æŠ–)
   - `isLoadingData` æ ‡å¿—ä½

### 4.2 ä»£ç é‡å¤é—®é¢˜

**ğŸ”´ ä¸¥é‡é‡å¤**ï¼š

| é‡å¤ä»£ç å— | ä½ç½®1 | ä½ç½®2 | é‡å¤è¡Œæ•° |
|-----------|-------|-------|---------|
| åŠ è½½æ‰€æœ‰æ‰¹æ¬¡æ•°æ® | loadAllBatchesData() 528-750è¡Œ | _backgroundRefreshAllBatches() 788-936è¡Œ | ~150è¡Œ |
| å¼‚å¸¸/éš”ç¦»æ•°æ®æŸ¥è¯¢ | loadAllBatchesData() 682-716è¡Œ | _backgroundRefreshAllBatches() 858-890è¡Œ | ~30è¡Œ |

**é‡æ„å»ºè®®**ï¼š

```typescript
// âœ… æå–å…¬å…±æ–¹æ³•
async function fetchAllBatchesHealthData() {
  // 1. è·å–æ‰¹æ¬¡å¥åº·æ±‡æ€»
  const healthResult = await wx.cloud.callFunction({
    name: 'health-management',
    data: { action: 'get_all_batches_health_summary' }
  })
  
  const batches = healthResult.result.data.batches || []
  
  // 2. å¹¶è¡ŒåŠ è½½æ²»ç–—ã€å¼‚å¸¸ã€éš”ç¦»æ•°æ®
  const [treatmentData, abnormalData, isolatedData] = await Promise.all([
    loadBatchTreatmentData(batches),
    loadHealthRecordsByStatus('abnormal'),
    loadHealthRecordsByStatus('isolated')
  ])
  
  return { batches, treatmentData, abnormalData, isolatedData }
}

// loadAllBatchesData å’Œ _backgroundRefreshAllBatches éƒ½è°ƒç”¨è¿™ä¸ªæ–¹æ³•
async loadAllBatchesData() {
  const data = await fetchAllBatchesHealthData()
  // å¤„ç†å¹¶setData
}

async _backgroundRefreshAllBatches() {
  const data = await fetchAllBatchesHealthData()
  // å·®å¼‚å¯¹æ¯”å¹¶æ›´æ–°
}
```

**å‡å°‘ä»£ç è¡Œæ•°**ï¼š180è¡Œ â†’ 80è¡Œï¼ˆå‡å°‘55%ï¼‰

### 4.3 é”™è¯¯å¤„ç†

**âœ… ä¼˜ç‚¹**ï¼š
- æ‰€æœ‰äº‘å‡½æ•°è°ƒç”¨éƒ½æœ‰ try-catch
- é”™è¯¯é™é»˜å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ

**âš ï¸ æ”¹è¿›ç©ºé—´**ï¼š

```typescript
// âŒ å½“å‰ï¼šé”™è¯¯ä¿¡æ¯ä¸¢å¤±
catch (error: any) {
  // åå°åˆ·æ–°å¤±è´¥ï¼Œé™é»˜å¤„ç†
}

// âœ… å»ºè®®ï¼šè®°å½•é”™è¯¯æ—¥å¿—
catch (error: any) {
  console.error('[Health] Background refresh failed:', {
    error: error.message,
    stack: error.stack,
    timestamp: new Date().toISOString()
  })
  // å¯é€‰ï¼šä¸ŠæŠ¥åˆ°äº‘ç«¯æ—¥å¿—ç³»ç»Ÿ
}
```

---

## ğŸ¯ 5. TDesignç»„ä»¶ä½¿ç”¨å®¡æŸ¥

### 5.1 ç»„ä»¶ä½¿ç”¨æ¸…å•

| ç»„ä»¶ | ä½¿ç”¨æ¬¡æ•° | ä½ç½® | è§„èŒƒç¬¦åˆåº¦ |
|------|---------|------|-----------|
| t-tabs / t-tab-panel | 1 | health.wxml:80-84 | âœ… ç¬¦åˆ |
| t-loading | 2 | health.wxml | âœ… ç¬¦åˆ |
| t-empty | å¤šå¤„ | å„Tabå†…å®¹ | âœ… ç¬¦åˆ |
| t-icon | å¤šå¤„ | å„å¤„å›¾æ ‡ | âœ… ç¬¦åˆ |
| t-tag | å¤šå¤„ | çŠ¶æ€æ ‡ç­¾ | âœ… ç¬¦åˆ |

### 5.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**æ ¹æ®TDesignæ–‡æ¡£**ï¼š

> "ä½¿ç”¨ `delay` å±æ€§é˜²æ­¢å¿«é€Ÿé—ªçƒ"

```wxml
<!-- âŒ å½“å‰ -->
<t-loading wx:if="{{loading}}" />

<!-- âœ… å»ºè®® -->
<t-loading wx:if="{{loading}}" delay="300" duration="1200" />
```

**ä¼˜åŠ¿**ï¼š
- åŠ è½½<300msæ—¶ä¸æ˜¾ç¤ºloadingï¼Œé¿å…é—ªçƒ
- æå‡ç”¨æˆ·ä½“éªŒ

---

## ğŸ“ 6. æ ·å¼å®¡æŸ¥

### 6.1 SCSSæ–‡ä»¶åˆ†æ

**æ–‡ä»¶å¤§å°**ï¼š1,871è¡Œï¼ˆåå¤§ï¼‰

**é—®é¢˜**ï¼š

1. **å†—ä½™æ ·å¼**
   ```scss
   // å‘ç°å¤šå¤„é‡å¤çš„é—´è·å®šä¹‰
   .section-title {
     padding: 24rpx;
   }
   .card-title {
     padding: 24rpx;  // é‡å¤
   }
   .detail-title {
     padding: 24rpx;  // é‡å¤
   }
   ```

2. **é­”æœ¯æ•°å­—**
   - å¤§é‡ç¡¬ç¼–ç çš„æ•°å€¼
   - æ²¡æœ‰ä½¿ç”¨SCSSå˜é‡

**ä¼˜åŒ–å»ºè®®**ï¼š

```scss
// âœ… ä½¿ç”¨å˜é‡
$spacing-base: 24rpx;
$spacing-small: 16rpx;
$spacing-large: 32rpx;

$border-radius-base: 16rpx;
$border-radius-small: 8rpx;

.section-title,
.card-title,
.detail-title {
  padding: $spacing-base;
}

.card {
  border-radius: $border-radius-base;
}
```

### 6.2 æœªä½¿ç”¨çš„æ ·å¼

**å»ºè®®**ï¼šè¿è¡Œæ ·å¼æ¸…ç†å·¥å…·

```bash
# ä½¿ç”¨ PurgeCSS æˆ–ç±»ä¼¼å·¥å…·æ¸…ç†æœªä½¿ç”¨çš„æ ·å¼
npx purgecss --css health.scss --content health.wxml
```

---

## ğŸš€ 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 äº‘å‡½æ•°è°ƒç”¨ä¼˜åŒ–æ€»ç»“

| ä¼˜åŒ–é¡¹ | å½“å‰çŠ¶æ€ | ä¼˜åŒ–å | æå‡ |
|-------|---------|-------|------|
| æ‰¹é‡æ²»ç–—æˆæœ¬è®¡ç®— | Næ¬¡è°ƒç”¨ | 1æ¬¡è°ƒç”¨ | 90% |
| ä»£ç é‡å¤ | 180è¡Œ | 80è¡Œ | 55% |
| ç¼“å­˜æœºåˆ¶ | Mapç¼“å­˜ | æœ¬åœ°å­˜å‚¨ | æŒä¹…åŒ– |
| é¡µé¢åŠ è½½æ—¶é—´ | ~2-3ç§’ | ~1-1.5ç§’ | 40-50% |

### 7.2 setDataä¼˜åŒ–

**å½“å‰é—®é¢˜**ï¼šéƒ¨åˆ†setDataæ“ä½œæ•°æ®é‡è¾ƒå¤§

```typescript
// âŒ ä¸€æ¬¡æ€§setDataå¤§é‡æ•°æ®
this.setData({
  healthStats: { /* å¤§å¯¹è±¡ */ },
  preventionStats: { /* å¤§å¯¹è±¡ */ },
  treatmentStats: { /* å¤§å¯¹è±¡ */ },
  // ... æ›´å¤šæ•°æ®
})
```

**ä¼˜åŒ–å»ºè®®**ï¼š

```typescript
// âœ… æŒ‰éœ€æ›´æ–°
this.setData({
  'healthStats.healthyRate': '97.8%',
  'healthStats.mortalityRate': '2.2%'
})
```

**æ€§èƒ½æå‡**ï¼š
- å‡å°‘æ•°æ®ä¼ è¾“é‡
- å‡å°‘é¡µé¢é‡ç»˜èŒƒå›´
- æå‡å“åº”é€Ÿåº¦

---

## ğŸ“‹ 8. ä»£ç é‡æ„å»ºè®®ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰

1. **æ¶ˆé™¤ä»£ç é‡å¤** ğŸ”´
   - é‡æ„ `loadAllBatchesData()` å’Œ `_backgroundRefreshAllBatches()`
   - æå–å…¬å…±æ–¹æ³• `fetchAllBatchesHealthData()`
   - **é¢„è®¡å‡å°‘ä»£ç ï¼š100è¡Œ**
   - **è€—æ—¶ï¼š1-2å°æ—¶**

2. **ä¼˜åŒ–äº‘å‡½æ•°è°ƒç”¨** ğŸ”´
   - å®ç°æ‰¹é‡æ²»ç–—æˆæœ¬è®¡ç®—
   - å‡å°‘90%çš„é‡å¤è°ƒç”¨
   - **é¢„è®¡æå‡æ€§èƒ½ï¼š40-50%**
   - **è€—æ—¶ï¼š2-3å°æ—¶**

### ä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸä¼˜åŒ–ï¼‰

3. **æ”¹è¿›ç¼“å­˜æœºåˆ¶** ğŸŸ¡
   - ä»Mapæ”¹ä¸ºwx.storage
   - å®ç°ç¼“å­˜å¤±æ•ˆç­–ç•¥
   - **è€—æ—¶ï¼š1-2å°æ—¶**

4. **ä¼˜åŒ–æ ·å¼æ–‡ä»¶** ğŸŸ¡
   - æå–SCSSå˜é‡
   - æ¸…ç†å†—ä½™æ ·å¼
   - **é¢„è®¡å‡å°‘ä»£ç ï¼š200-300è¡Œ**
   - **è€—æ—¶ï¼š2-3å°æ—¶**

### ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸæ”¹è¿›ï¼‰

5. **å¢å¼ºé”™è¯¯æ—¥å¿—** ğŸŸ¢
   - æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - å®ç°äº‘ç«¯æ—¥å¿—ä¸ŠæŠ¥
   - **è€—æ—¶ï¼š1å°æ—¶**

6. **æ€§èƒ½ç›‘æ§** ğŸŸ¢
   - æ·»åŠ æ€§èƒ½åŸ‹ç‚¹
   - ç›‘æ§åŠ è½½æ—¶é—´
   - **è€—æ—¶ï¼š1-2å°æ—¶**

---

## ğŸ“Š 9. å®¡æŸ¥ç»“æœæ€»ç»“

### 9.1 æ•´ä½“è¯„åˆ†

| è¯„å®¡é¡¹ | è¯„åˆ† | è¯´æ˜ |
|-------|------|------|
| ä»£ç ç»“æ„ | â­â­â­â­â˜† 8/10 | æ¨¡å—åŒ–è®¾è®¡è‰¯å¥½ï¼Œä½†æœ‰é‡å¤ä»£ç  |
| æ€§èƒ½ä¼˜åŒ– | â­â­â­â˜†â˜† 6/10 | æœ‰ç¼“å­˜å’Œé˜²æŠ–ï¼Œä½†äº‘å‡½æ•°è°ƒç”¨è¿‡å¤š |
| ä»£ç è´¨é‡ | â­â­â­â­â˜† 7/10 | TypeScriptç±»å‹å®Œå–„ï¼Œä½†æœ‰é‡å¤é€»è¾‘ |
| é”™è¯¯å¤„ç† | â­â­â­â˜†â˜† 6/10 | æœ‰try-catchï¼Œä½†æ—¥å¿—ä¸è¶³ |
| è§„èŒƒç¬¦åˆ | â­â­â­â­â˜† 8/10 | ç¬¦åˆå¾®ä¿¡å°ç¨‹åºå’ŒTDesignè§„èŒƒ |
| **ç»¼åˆè¯„åˆ†** | **â­â­â­â­â˜† 7/10** | **è‰¯å¥½ï¼Œæœ‰æ”¹è¿›ç©ºé—´** |

### 9.2 ä¸»è¦ä¼˜ç‚¹

1. âœ… **æ¨¡å—åŒ–è®¾è®¡**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»
2. âœ… **TypeScriptæ”¯æŒ**ï¼šç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
3. âœ… **é˜²æŠ–æœºåˆ¶**ï¼šé¿å…é¢‘ç¹åˆ·æ–°
4. âœ… **å¹¶è¡ŒåŠ è½½**ï¼šä½¿ç”¨Promise.allæå‡æ€§èƒ½
5. âœ… **å·®å¼‚å¯¹æ¯”**ï¼šé¿å…æ— æ„ä¹‰çš„æ¸²æŸ“
6. âœ… **å®æ—¶ç›‘å¬**ï¼šæ•°æ®å®æ—¶æ›´æ–°

### 9.3 ä¸»è¦é—®é¢˜

1. ğŸ”´ **ä»£ç é‡å¤ä¸¥é‡**ï¼š150è¡Œé‡å¤ä»£ç 
2. ğŸ”´ **äº‘å‡½æ•°è°ƒç”¨è¿‡å¤š**ï¼šæ¯æ‰¹æ¬¡å•ç‹¬è°ƒç”¨ï¼Œæœªæ‰¹é‡å¤„ç†
3. ğŸŸ¡ **ç¼“å­˜æœºåˆ¶ä¸å®Œå–„**ï¼šæ²¡æœ‰å¤±æ•ˆç­–ç•¥ï¼Œæœ‰å†…å­˜æ³„æ¼é£é™©
4. ğŸŸ¡ **æ ·å¼æ–‡ä»¶è¿‡å¤§**ï¼š1,871è¡Œï¼Œæœ‰å†—ä½™
5. ğŸŸ¡ **é”™è¯¯æ—¥å¿—ä¸è¶³**ï¼šå½±å“é—®é¢˜æ’æŸ¥

### 9.4 é¢„æœŸä¼˜åŒ–æ•ˆæœ

**å®æ–½é«˜ä¼˜å…ˆçº§ä¼˜åŒ–å**ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ä»£ç è¡Œæ•° | 5,197 | ~4,800 | -7.6% |
| äº‘å‡½æ•°è°ƒç”¨ | 19æ¬¡/åŠ è½½ | ~8æ¬¡/åŠ è½½ | -57.9% |
| é¡µé¢åŠ è½½æ—¶é—´ | 2-3ç§’ | 1-1.5ç§’ | -40-50% |
| ä»£ç ç»´æŠ¤æ€§ | ä¸­ç­‰ | ä¼˜ç§€ | â†‘â†‘ |
| å†…å­˜å ç”¨ | è¾ƒé«˜ | æ­£å¸¸ | â†“ |

---

## ğŸ¯ 10. ç«‹å³è¡ŒåŠ¨è®¡åˆ’

### ç¬¬ä¸€æ­¥ï¼šæ¶ˆé™¤ä»£ç é‡å¤ï¼ˆ2å°æ—¶ï¼‰

```typescript
// 1. åˆ›å»ºå…¬å…±æ–¹æ³•
async function fetchAllBatchesHealthData() {
  // åˆå¹¶é‡å¤é€»è¾‘
}

// 2. é‡æ„ç°æœ‰æ–¹æ³•
async loadAllBatchesData() {
  const data = await fetchAllBatchesHealthData()
  this.setData(data)
}

async _backgroundRefreshAllBatches() {
  const data = await fetchAllBatchesHealthData()
  // å·®å¼‚å¯¹æ¯”
  if (hasSignificantChange(data)) {
    this.setData(data)
  }
}
```

### ç¬¬äºŒæ­¥ï¼šä¼˜åŒ–äº‘å‡½æ•°è°ƒç”¨ï¼ˆ3å°æ—¶ï¼‰

```typescript
// 1. äº‘å‡½æ•°ç«¯å®ç°æ‰¹é‡è®¡ç®—
// cloudfunctions/health-management/index.js
async function calculateBatchTreatmentCosts(event, wxContext) {
  const { batchIds } = event
  return await processBatchCosts(batchIds)
}

// 2. å‰ç«¯è°ƒç”¨ä¼˜åŒ–
const treatmentData = await wx.cloud.callFunction({
  name: 'health-management',
  data: {
    action: 'calculate_batch_treatment_costs',
    batchIds: batches.map(b => b._id)
  }
})
```

### ç¬¬ä¸‰æ­¥ï¼šæ”¹è¿›ç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰

```typescript
// ä½¿ç”¨wx.storageæ›¿ä»£Map
async function loadWithCache(key, loader) {
  const cached = wx.getStorageSync(key)
  if (isValid(cached)) return cached.data
  
  const data = await loader()
  wx.setStorageSync(key, { data, timestamp: Date.now() })
  return data
}
```

---

## ğŸ“ 11. ç»“è®º

å¥åº·ç®¡ç†ä¸­å¿ƒé¡µé¢**æ•´ä½“è®¾è®¡è‰¯å¥½**ï¼Œé‡‡ç”¨äº†æ¨¡å—åŒ–æ¶æ„å’ŒTypeScriptç±»å‹ç³»ç»Ÿï¼Œç¬¦åˆå¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘å’ŒTDesignè§„èŒƒã€‚

**ä¸»è¦æ”¹è¿›æ–¹å‘**ï¼š
1. æ¶ˆé™¤ä»£ç é‡å¤
2. ä¼˜åŒ–äº‘å‡½æ•°è°ƒç”¨ï¼ˆæ‰¹é‡å¤„ç†ï¼‰
3. æ”¹è¿›ç¼“å­˜æœºåˆ¶
4. æ¸…ç†å†—ä½™æ ·å¼

**é¢„æœŸæ”¶ç›Š**ï¼š
- ä»£ç è¡Œæ•°å‡å°‘çº¦400è¡Œï¼ˆ-7.6%ï¼‰
- äº‘å‡½æ•°è°ƒç”¨å‡å°‘çº¦11æ¬¡ï¼ˆ-57.9%ï¼‰
- é¡µé¢åŠ è½½é€Ÿåº¦æå‡40-50%
- ä»£ç ç»´æŠ¤æ€§æ˜¾è‘—æå‡

**å»ºè®®ä¼˜å…ˆå®æ–½é«˜ä¼˜å…ˆçº§ä¼˜åŒ–**ï¼Œé¢„è®¡æŠ•å…¥6-8å°æ—¶ï¼Œå¯è·å¾—æ˜¾è‘—çš„æ€§èƒ½å’Œä»£ç è´¨é‡æå‡ã€‚

---

## ğŸ“š å‚è€ƒè§„èŒƒ

1. **å¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘æœ€ä½³å®è·µ**
   - å‡å°‘äº‘å‡½æ•°è°ƒç”¨æ¬¡æ•°
   - ä½¿ç”¨æœ¬åœ°å­˜å‚¨ç¼“å­˜æ•°æ®
   - åˆå¹¶æ‰¹é‡æ“ä½œ

2. **TDesignè§„èŒƒ**
   - ä½¿ç”¨delayå±æ€§é¿å…é—ªçƒ
   - éµå¾ªç»„ä»¶APIè§„èŒƒ
   - åˆç†ä½¿ç”¨å¤–éƒ¨æ ·å¼ç±»

3. **ä»£ç è´¨é‡åŸåˆ™**
   - DRYï¼ˆDon't Repeat Yourselfï¼‰
   - å•ä¸€èŒè´£åŸåˆ™
   - é€‚åº¦çš„ä»£ç æ³¨é‡Š

