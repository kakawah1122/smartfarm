# 📊 AI批量识别功能说明 v2.0

## 🎯 功能概述

**版本**：v2.0 (2025-11-08)

**核心升级**：从"单条识别"升级到"批量识别"

当用户上传包含多天价格数据的表格截图时，AI会**自动识别并提取所有日期的数据**，而不是只识别最新一天的数据。

---

## ✨ 主要特性

### 1. **批量数据提取**
- ✅ AI自动识别图片中的所有日期
- ✅ 提取每个日期对应的鹅苗价格（中种鹅、大种鹅、特大种鹅）
- ✅ 提取每个日期对应的肉鹅价格（120日龄、130日龄）
- ✅ 支持10天以上的历史数据批量识别

### 2. **智能预览**
- 📱 批量数据以卡片形式展示
- 📊 每条记录独立显示，包含日期、价格区间、平均价
- 🔢 显示识别到的总记录数

### 3. **批量保存**
- 💾 一次性保存所有识别到的数据
- 🔄 自动处理数据冲突（已存在则更新，不存在则新增）
- 📈 保存后自动刷新历史记录和趋势图

---

## 📝 使用场景

### 场景1：首次导入历史数据
**情况**：用户有10月30日到11月8日的完整价格表格截图

**操作流程**：
1. 进入：个人中心 → 鹅价管理 → AI识别
2. 上传表格截图
3. 点击"开始AI识别"
4. 等待AI分析（约10-30秒）
5. 查看预览：显示"共 10 条记录"
6. 点击"确认批量保存（10条）"
7. ✅ 完成！10天的数据全部保存到数据库

**预期结果**：
- 数据库中有10条记录（每天一条）
- 趋势图显示完整的10天价格走势
- 可以进行价格分析和预测

### 场景2：更新最近几天数据
**情况**：用户有最近3天的价格数据

**操作流程**：
1. 上传包含最近3天数据的截图
2. AI识别出3条记录
3. 批量保存
4. 如果这3天的数据已存在，则更新；否则新增

---

## 🔧 技术实现

### 前端 (price-management.ts)

#### 新增接口定义
```typescript
// 批量预览数据结构
interface BatchPreviewData {
  records: PreviewData[]  // 多条日期记录
  totalCount: number      // 识别到的总记录数
}

// 批量解析结果
interface ParsedBatchGoosePriceResult {
  records?: ParsedGoosePriceResult[]
  [key: string]: any
}
```

#### 核心函数

**1. parseGoosePriceContent()**
- 智能判断AI返回的是单条数据还是批量数据
- 兼容旧版本的单条数据格式
- 支持新版本的批量数据格式（`{ records: [...] }`）

**2. buildBatchPreviewData()**
- 将批量解析结果转换为预览数据
- 标准化价格区间格式
- 计算平均价格

**3. saveBatchData()**
- 循环保存每条记录
- 查询数据库判断记录是否已存在
- 已存在则更新，不存在则新增
- 显示保存进度（如"保存中...3/10"）

### AI Prompt 优化

**旧版本 Prompt**：
```
识别要求：
1. 找到表格中最新一行的日期（通常在最后几行）
2. 提取该日期的价格数据

注意事项：
- 只提取最新一行数据（日期最大的那一行）
```

**新版本 Prompt**：
```
识别要求：
1. 提取表格中的**所有日期**及对应的价格数据（不要遗漏任何一行）
2. 对于每个日期，提取鹅苗和肉鹅的价格信息
3. 按日期从早到晚排序

注意事项：
- 必须提取所有日期的数据，不要遗漏
- 日期格式：YYYY-MM-DD（如：2025-10-30）

输出格式：
{
  "records": [
    {
      "date": "2025-10-30",
      "goslingBreeds": [...],
      "meatBreeds": [...]
    },
    {
      "date": "2025-10-31",
      ...
    }
  ]
}
```

---

## 🎨 UI 设计

### 批量预览界面

**布局结构**：
```
┌────────────────────────────────────┐
│  批量数据预览   [ 共 10 条记录 ]     │
├────────────────────────────────────┤
│  ┌──────────────────────────────┐  │
│  │  2025-10-30      第 1 条     │  │
│  │  ─────────────────────────── │  │
│  │  鹅苗价格（元/只）            │  │
│  │  中种鹅   38-41   ¥39.5      │  │
│  │  大种鹅   52-54   ¥53.0      │  │
│  │  特大种鹅  56-60   ¥58.0     │  │
│  │  肉鹅价格（元/斤）            │  │
│  │  120日龄  18.5-18.5  ¥18.5   │  │
│  │  130日龄  19.0-19.0  ¥19.0   │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │  2025-10-31      第 2 条     │  │
│  │  ...                         │  │
│  └──────────────────────────────┘  │
│  ...                               │
├────────────────────────────────────┤
│  [ 取消 ]  [ 确认批量保存（10条）] │
└────────────────────────────────────┘
```

**设计特点**：
- 📋 每条记录独立卡片展示
- 📅 日期高亮显示，醒目易读
- 🔢 序号标识，方便核对
- 🎨 渐变配色，视觉层次分明
- 💫 淡入动画，流畅自然

---

## 📊 数据流程

```
用户上传截图
    ↓
wx.cloud.uploadFile (上传到云存储)
    ↓
wx.cloud.callFunction('ai-multi-model')
    ↓
Qwen-VL-Max AI 模型识别
    ↓
返回 JSON: { records: [...] }
    ↓
parseGoosePriceContent (解析)
    ↓
buildBatchPreviewData (构建预览)
    ↓
显示批量预览界面
    ↓
用户点击"确认批量保存"
    ↓
saveBatchData (逐条保存)
    ↓
  ┌─→ 查询该日期是否已存在
  │     ├─ 已存在 → update
  │     └─ 不存在 → add
  └─ 循环处理所有记录
    ↓
保存完成，刷新历史记录
    ↓
✅ 完成！
```

---

## ⚡ 性能优化

### 1. **分步保存**
- 不使用批量写入API，而是逐条保存
- 原因：需要先查询每条记录是否存在，再决定更新或新增
- 优点：数据冲突处理更精确

### 2. **进度提示**
```javascript
wx.showLoading({ 
  title: `保存中...${i + 1}/${totalCount}`, 
  mask: true 
})
```
- 实时显示保存进度（如"保存中...3/10"）
- 用户可以清楚知道当前进度

### 3. **错误处理**
```javascript
try {
  // 批量保存逻辑
} catch (error) {
  console.error('批量保存失败:', error)
  Message.error({
    content: '批量保存失败：' + error.message
  })
}
```
- 捕获并显示详细的错误信息
- 方便用户反馈问题

---

## 🔍 测试用例

### 用例1：批量识别10条记录
**输入**：包含10月30日到11月8日的价格表格截图

**预期输出**：
- AI返回10条记录的JSON数据
- 预览界面显示"共 10 条记录"
- 10个卡片，每个卡片显示一天的数据
- 保存后数据库中有10条记录

**验证**：
```javascript
// 查询数据库
db.collection('goose_prices')
  .where({
    date: db.command.gte('2025-10-30').and(db.command.lte('2025-11-08'))
  })
  .get()

// 应返回10条记录
```

### 用例2：更新已存在的数据
**输入**：包含11月6日到11月8日的价格数据（数据库已有11月8日数据）

**预期输出**：
- AI识别出3条记录
- 保存时：11月6日、7日新增，11月8日更新
- 提示："批量保存成功！新增 2 条，更新 1 条"

### 用例3：兼容单条数据
**输入**：AI返回单条数据格式（旧版本）

**预期输出**：
- 系统自动识别为单条数据
- 显示单条预览界面（而非批量预览）
- 保存正常工作

---

## 📌 注意事项

### 1. **日期格式**
- AI必须输出标准日期格式：`YYYY-MM-DD`
- 前端会自动补全缺失的日期（默认当天）

### 2. **数据去重**
- 同一日期只保留一条记录
- 新数据会覆盖旧数据（通过 `update` 操作）

### 3. **空数据处理**
- 如果某个品种没有数据，该品种会被省略
- 如果某条记录完全没有价格数据，该记录会被过滤掉

### 4. **AI识别时间**
- 批量识别比单条识别耗时更长
- 通常10条记录需要15-30秒
- 显示"AI正在分析图片内容..."提示用户等待

---

## 🚀 升级影响

### 对现有功能的影响
✅ **完全兼容**：旧版本的单条识别功能仍然可用

✅ **向后兼容**：如果AI返回的是旧格式，系统会自动识别并处理

✅ **数据库无需修改**：数据结构保持不变，只是保存的记录数量增多

---

## 📈 未来优化方向

### 1. **并发保存**
目前是串行保存（一条一条保存），未来可以考虑：
- 使用 `Promise.all` 并发保存
- 批量写入API（需要重新设计去重逻辑）

### 2. **增量识别**
- 用户可以选择只识别新日期的数据
- 跳过数据库中已存在的日期

### 3. **数据校验**
- AI识别后，前端进行数据合理性校验
- 例如：价格不能为负数，价格区间 min <= max

### 4. **历史数据导出**
- 支持导出批量识别的数据为Excel
- 方便用户备份和分析

---

## 🎉 总结

**v2.0 批量识别功能**让用户可以：
1. ⚡ **一次上传，批量识别**：不再需要手动逐天录入
2. 📊 **完整历史数据**：为趋势分析和AI预测提供数据基础
3. 🔄 **智能去重**：自动处理数据冲突，无需担心重复录入
4. 💯 **高准确率**：使用 Qwen-VL-Max 模型，识别准确率高

这次升级**大幅提升了用户体验**，让鹅价数据管理更加高效！🎊

