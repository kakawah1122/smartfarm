# 数据库检查与迁移操作指南

## 📋 **数据库状态说明**

您的数据库**可能需要迁移**，因为我们将系统从英文分类改为中文分类。需要检查现有数据格式。

---

## 🔍 **步骤1：检查现有数据**

### 方法一：上传检查云函数

1. **上传云函数**
   ```bash
   # 在微信开发者工具中
   # 右键 cloudfunctions/check-data -> 上传并部署
   ```

2. **在小程序中调用检查**
   ```javascript
   // 在任意页面的控制台或代码中执行
   wx.cloud.callFunction({
     name: 'check-data',
     success: (res) => {
       console.log('数据检查结果:', res.result)
       
       if (res.result.needMigration) {
         console.log('⚠️ 需要数据迁移!')
         console.log('当前分类:', res.result.categoryStats)
       } else {
         console.log('✅ 数据格式正确，无需迁移')
       }
     }
   })
   ```

### 方法二：直接在云开发控制台查看
1. 打开微信开发者工具
2. 点击 **云开发** -> **数据库** -> **materials**
3. 查看几条记录的 `category` 字段
4. 如果看到 `feed`、`medicine` 等英文值，需要迁移

---

## 🔄 **步骤2：数据迁移（如果需要）**

### 如果检查发现需要迁移：

1. **上传迁移云函数**
   ```bash
   # 在微信开发者工具中
   # 右键 cloudfunctions/migrate-data -> 上传并部署
   ```

2. **执行数据迁移**
   ```javascript
   // ⚠️ 注意：这会修改数据库数据，请先备份！
   wx.cloud.callFunction({
     name: 'migrate-data',
     success: (res) => {
       console.log('迁移结果:', res.result)
       
       if (res.result.success) {
         console.log(`✅ 迁移成功! 更新了 ${res.result.totalUpdated} 条记录`)
         console.log('最终分类:', res.result.finalCategories)
       } else {
         console.log('❌ 迁移失败:', res.result.error)
       }
     }
   })
   ```

---

## 📊 **预期的迁移映射**

| 英文分类 | 中文分类 | 说明 |
|---------|---------|------|
| feed | 饲料 | 普通饲料 |
| nutrition | 营养品 | 营养补充剂 |
| medicine | 药品 | 药物疫苗 |
| equipment | 设备 | 设备工具 |
| supplies | 耗材 | 日常耗材 |
| other | 其他 | 其他物料 |

---

## ⚠️ **重要注意事项**

### 1. **备份数据**
```javascript
// 建议先导出数据备份
// 在云开发控制台 -> 数据库 -> materials -> 导出
```

### 2. **测试环境先试**
- 如果有测试环境，建议先在测试环境执行
- 确认迁移效果后再在生产环境执行

### 3. **迁移后验证**
```javascript
// 迁移完成后验证
wx.cloud.callFunction({
  name: 'check-data',
  success: (res) => {
    console.log('迁移后检查:', res.result.categoryStats)
    // 应该只看到中文分类：饲料、营养品、药品、设备、耗材、其他
  }
})
```

---

## 🚀 **快速操作流程**

### 一键式检查和迁移：

```javascript
// 复制这段代码到小程序控制台执行
async function checkAndMigrate() {
  console.log('=== 开始数据库检查 ===')
  
  // 1. 检查数据
  const checkResult = await new Promise((resolve) => {
    wx.cloud.callFunction({
      name: 'check-data',
      success: (res) => resolve(res.result),
      fail: (err) => {
        console.error('检查失败:', err)
        resolve(null)
      }
    })
  })
  
  if (!checkResult) {
    console.log('❌ 数据检查失败，请确保已上传 check-data 云函数')
    return
  }
  
  console.log('📊 数据检查结果:', checkResult)
  
  if (!checkResult.needMigration) {
    console.log('✅ 数据格式正确，无需迁移！')
    return
  }
  
  console.log('⚠️ 需要数据迁移，开始迁移...')
  
  // 2. 执行迁移
  const migrateResult = await new Promise((resolve) => {
    wx.cloud.callFunction({
      name: 'migrate-data',
      success: (res) => resolve(res.result),
      fail: (err) => {
        console.error('迁移失败:', err)
        resolve(null)
      }
    })
  })
  
  if (migrateResult && migrateResult.success) {
    console.log(`✅ 迁移完成！更新了 ${migrateResult.totalUpdated} 条记录`)
    console.log('📋 最终分类:', migrateResult.finalCategories)
  } else {
    console.log('❌ 迁移失败:', migrateResult?.error)
  }
}

// 执行检查和迁移
checkAndMigrate()
```

---

## 🔧 **故障排除**

### 如果出现 "db is not defined" 错误：
- 不要在小程序前端直接使用 db 对象
- 必须通过云函数访问数据库

### 如果云函数调用失败：
1. 确认云函数已正确上传并部署
2. 检查云函数权限设置
3. 查看云函数日志排查问题

### 如果迁移后功能异常：
1. 检查所有代码是否使用中文分类
2. 清除小程序缓存重新测试
3. 检查云函数是否都已更新

---

**重要提醒**：执行迁移前请务必备份数据！
