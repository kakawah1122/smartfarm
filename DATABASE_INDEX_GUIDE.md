# 数据库索引配置指南

## 📊 集合：health_treatment_records

### 📝 添加索引

创建集合后，点击"索引"标签页，按以下配置添加索引：

#### 索引1：创建时间和删除状态索引
**用途：** 快速查询治疗记录，按创建时间倒序排列，同时过滤已删除记录

- **索引名称**：`createdAt_-1_isDeleted_1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`createdAt`，排序：**降序**
  - 字段：`isDeleted`，排序：**升序**

#### 索引2：批次和创建时间索引
**用途：** 查询特定批次的治疗记录

- **索引名称**：`batchId_1_createdAt_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`batchId`，排序：**升序**
  - 字段：`createdAt`，排序：**降序**

#### 索引3：治疗状态和创建时间索引
**用途：** 快速查询不同状态的治疗记录（进行中、已治愈、已完成）

- **索引名称**：`outcome.status_1_createdAt_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`outcome.status`，排序：**升序**
  - 字段：`createdAt`，排序：**降序**

---

## 🔧 创建方法

### 方法1：微信云开发控制台（推荐）

1. 登录 [微信云开发控制台](https://console.cloud.tencent.com/)
2. 选择对应的环境 → 进入"数据库"模块
3. 找到 `health_treatment_records` 集合 → 点击"索引"标签
4. 点击"添加索引"按钮
5. 按照上方配置依次添加3个索引：
   
**添加索引1示例：**
   - 索引名称：`createdAt_-1_isDeleted_1`
   - 勾选"非唯一"
   - 添加字段1：`createdAt`，选择"降序"
   - 添加字段2：`isDeleted`，选择"升序"
   - 点击"确定"

6. 重复步骤5，添加索引2和索引3

### 方法2：开发者工具

1. 打开微信开发者工具
2. 点击"云开发"按钮
3. 进入"数据库" → 选择 `health_treatment_records` 集合
4. 点击"索引管理"标签
5. 按照上方配置添加索引

---

## 📊 性能提升说明

| 项目 | 无索引 | 有索引 |
|------|--------|--------|
| 查询速度 | 慢（全表扫描） | 快（索引查询） |
| 适用数据量 | < 1000 | 无限制 ✅ |
| CPU 消耗 | 高 | 低 ✅ |
| 查询耗时 | 500-1000ms | 10-50ms ✅ |

---

## 📊 集合：health_death_records

### 📝 添加索引

#### 索引1：死亡日期和删除状态索引
**用途：** 快速查询死亡记录，按死亡日期倒序排列

- **索引名称**：`deathDate_-1_isDeleted_1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`deathDate`，排序：**降序**
  - 字段：`isDeleted`，排序：**升序**

#### 索引2：批次和死亡日期索引
**用途：** 查询特定批次的死亡记录

- **索引名称**：`batchId_1_deathDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`batchId`，排序：**升序**
  - 字段：`deathDate`，排序：**降序**

#### 索引3：来源和死亡日期索引
**用途：** 区分治疗来源和AI诊断来源的死亡记录

- **索引名称**：`source_1_deathDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`source`，排序：**升序**
  - 字段：`deathDate`，排序：**降序**

---

## 📊 集合：prod_batch_entries

### 📝 添加索引

#### 索引1：批次号和删除状态索引
**用途：** 通过批次号快速查询批次信息

- **索引名称**：`batchNumber_1_isDeleted_1`
- **索引属性**：非唯一（建议唯一，但考虑历史数据兼容性设为非唯一）
- **索引字段**：
  - 字段：`batchNumber`，排序：**升序**
  - 字段：`isDeleted`，排序：**升序**

#### 索引2：批次状态和入栏日期索引
**用途：** 查询在栏/已出栏批次，按入栏日期倒序排列

- **索引名称**：`status_1_entryDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`status`，排序：**升序**
  - 字段：`entryDate`，排序：**降序**

#### 索引3：养殖场和入栏日期索引
**用途：** 养殖场维度的批次查询和统计

- **索引名称**：`farmId_1_entryDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`farmId`，排序：**升序**
  - 字段：`entryDate`，排序：**降序**

---

## 📊 集合：health_records

> **📌 说明**：本集合用于存储各类健康记录，包括异常记录、日常检查、观察记录等。
> 通过 `recordType` 字段区分记录类型（如：abnormal、inspection、observation），
> 通过 `status` 字段区分处理状态（如：pending、processing、resolved）。

### 📝 添加索引

#### 索引1：创建时间和状态索引
**用途：** 查询待处理/已处理的健康异常记录

- **索引名称**：`createdAt_-1_status_1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`createdAt`，排序：**降序**
  - 字段：`status`，排序：**升序**

#### 索引2：批次和创建时间索引
**用途：** 查询特定批次的健康记录（包括异常记录）

- **索引名称**：`batchId_1_createdAt_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`batchId`，排序：**升序**
  - 字段：`createdAt`，排序：**降序**

#### 索引3：记录类型和创建时间索引
**用途：** 区分不同类型的健康记录（异常、检查、日常观察等）

- **索引名称**：`recordType_1_createdAt_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`recordType`，排序：**升序**
  - 字段：`createdAt`，排序：**降序**

---

## ⚠️ 注意事项

### 索引创建

1. **创建时间**: 
   - 数据量 < 1000 条：几秒内完成
   - 数据量 1000-10000 条：1-3 分钟
   - 数据量 > 10000 条：3-10 分钟

2. **存储占用**: 
   - 索引会占用额外存储空间（约数据的 10-20%）
   - 建议定期清理无用索引

3. **写入性能**: 
   - 索引会轻微影响写入速度（通常 < 5%）
   - 对于批量写入，影响可忽略

4. **索引数量**: 
   - 每个集合建议 3-5 个索引
   - 不建议超过 8 个索引
   - 按查询频率优先创建

### 索引命名规范

索引名称格式：`字段名_排序_字段名_排序`

- **升序**：用 `1` 表示（例如：`batchId_1`）
- **降序**：用 `-1` 表示（例如：`createdAt_-1`）
- **组合索引**：多个字段用下划线连接（例如：`batchId_1_createdAt_-1`）

---

## 🔍 验证索引效果

### 方法1：控制台查询

1. 打开微信云开发控制台
2. 进入"数据库" → 选择集合
3. 执行查询
4. 查看"查询耗时"（应从 500ms+ 降至 50ms 以下）

### 方法2：日志验证

在云函数中添加耗时日志：

```javascript
const startTime = Date.now()
const result = await db.collection('health_treatment_records')
  .orderBy('createdAt', 'desc')
  .limit(100)
  .get()
const endTime = Date.now()

console.log(`查询耗时: ${endTime - startTime}ms`)
```

**预期结果**：
- ❌ 无索引：300-1000ms
- ✅ 有索引：10-50ms

---

## 📈 推荐创建优先级

### 高优先级（必须创建）

| 集合 | 索引 | 原因 |
|------|------|------|
| `health_treatment_records` | `createdAt_-1_isDeleted_1` | 治愈记录列表高频查询 |
| `prod_batch_entries` | `batchNumber_1_isDeleted_1` | 批次号查询核心功能 |
| `health_death_records` | `deathDate_-1_isDeleted_1` | 死亡记录列表高频查询 |

### 中优先级（建议创建）

| 集合 | 索引 | 原因 |
|------|------|------|
| `health_treatment_records` | `batchId_1_createdAt_-1` | 批次维度治疗记录查询 |
| `prod_batch_entries` | `status_1_entryDate_-1` | 在栏批次查询 |
| `health_records` | `createdAt_-1_status_1` | 健康异常记录查询 |

### 低优先级（按需创建）

| 集合 | 索引 | 原因 |
|------|------|------|
| `health_treatment_records` | `outcome.status_1_createdAt_-1` | 状态筛选功能 |
| `health_death_records` | `source_1_deathDate_-1` | 来源区分查询 |
| `prod_batch_entries` | `farmId_1_entryDate_-1` | 多养殖场场景 |

---

## 📝 更新日志

### v1.1.1 (2025-10-29)
- ✅ 修正集合名称：`health_abnormal_records` → `health_records`
- ✅ 说明：异常记录存储在 `health_records` 集合中，通过 `status` 和 `recordType` 字段区分
- ✅ 新增 `recordType` 索引，支持记录类型筛选

### v1.1.0 (2025-10-29)
- ✅ 按照项目规则格式重构文档结构
- ✅ 添加索引命名规范说明
- ✅ 补充验证方法和优先级建议
- ✅ 增加 4 个核心集合的完整索引配置

### v1.0.0 (2025-10-29)
- ✅ 初始版本，添加治愈记录查询索引配置

