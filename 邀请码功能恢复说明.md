# 邀请码功能恢复说明

> 将邀请码管理功能重新集成到改版后的个人中心页面

---

## 📋 问题背景

在个人中心页面改版后，邀请码的生成和管理功能入口丢失了。虽然：
- ✅ 后端云函数完整保留
- ✅ 邀请管理页面完整保留
- ❌ 个人中心入口被移除

---

## ✅ 已完成的工作

### 1. 恢复邀请码管理入口

**修改文件：** `miniprogram/pages/profile/profile.ts`

**修改内容：**
```typescript
// 管理功能配置
const ADMIN_FUNCTIONS = [
  { id: 1, label: '人员管理', page: '/packageUser/user-management/user-management' },
  { id: 2, label: '邀请码管理', page: '/packageUser/invite-management/invite-management' }, // ✅ 新增
  { id: 3, label: '财务管理', page: '/packageFinance/finance/finance' },
  { id: 4, label: '数据分析', page: '/packageFinance/performance-analysis/performance-analysis' }
]
```

**效果：**
- 管理员在个人中心可以看到"邀请码管理"入口
- 点击后跳转到邀请管理页面

---

## 🔍 邀请码功能概览

### 后端云函数（已存在）

**文件位置：** `cloudfunctions/user-management/index.js`

**核心功能：**

1. **`createInvite()`** - 创建邀请码
   - 生成6位唯一邀请码（大写字母+数字）
   - 支持设置默认角色（员工、兽医、经理、超级管理员）
   - 支持设置有效期（3/7/15/30天）
   - 支持添加备注说明
   
2. **`validateInvite()`** - 验证邀请码
   - 检查邀请码是否存在
   - 检查是否已使用
   - 检查是否已过期
   - 检查是否已撤销

3. **`useInvite()`** - 使用邀请码
   - 注册时使用邀请码激活账户
   - 自动分配角色权限
   - 记录使用时间和使用者信息

4. **`getInviteStats()`** - 获取邀请统计
   - 总邀请数
   - 待使用数量
   - 已使用数量
   - 使用率统计

### 前端邀请管理页面（已存在）

**文件位置：** `miniprogram/packageUser/invite-management/`

**页面功能：**

1. **邀请统计卡片**
   - 显示总邀请数、待使用、已使用、使用率

2. **邀请列表**
   - 支持搜索（姓名、手机号、邀请码）
   - 支持筛选（全部、待使用、已使用、已过期）
   - 支持分页加载

3. **创建邀请码**
   - 选择默认角色（员工、兽医、经理、超级管理员）
   - 选择有效期（3/7/15/30天）
   - 添加备注说明
   - 生成后可复制邀请码

4. **邀请详情**
   - 查看邀请码详细信息
   - 撤销待使用的邀请
   - 重新发送邀请信息

---

## 🎯 使用流程

### 管理员创建邀请码

1. 进入"个人中心"
2. 点击"邀请码管理"（仅管理员可见）
3. 点击"创建邀请"按钮
4. 填写邀请信息：
   - 选择默认角色（注册时可调整）
   - 选择有效期
   - 填写备注（可选）
5. 点击"生成邀请码"
6. 复制邀请码并分享给被邀请人

### 用户使用邀请码注册

1. 打开小程序登录页面
2. 输入邀请码
3. 填写个人信息：
   - 姓名
   - 手机号
   - 部门
   - 职位
4. 确认角色（可以使用默认角色或调整）
5. 提交注册
6. 自动激活账户并分配权限

---

## 🔐 权限控制

### 邀请码管理权限

只有以下角色可以访问邀请码管理：
- ✅ 超级管理员（super_admin）
- ✅ 经理（manager）
- ❌ 员工（employee）
- ❌ 兽医（veterinarian）

**权限检查：**
- 个人中心：管理功能区域仅对管理员可见
- 邀请管理页面：进入时自动检查权限
- 云函数：创建邀请码时验证权限

---

## 📊 邀请码状态管理

### 邀请码状态

| 状态 | 说明 | 操作 |
|------|------|------|
| pending | 待使用 | 可撤销、可使用 |
| used | 已使用 | 只读 |
| expired | 已过期 | 只读 |
| revoked | 已撤销 | 只读 |

### 自动过期机制

- 创建时设置过期时间
- 验证时自动检查是否过期
- 过期的邀请码自动标记为 `expired` 状态

---

## 🎨 UI 设计

### 个人中心入口

```
个人中心
├── 个人信息卡片
├── 我的报销
└── 功能区域（管理员可见）
    ├── 管理功能
    │   ├── 人员管理
    │   ├── 邀请码管理  ← 新增入口
    │   ├── 财务管理
    │   └── 数据分析
    └── 系统设置
```

### 邀请管理页面布局

```
邀请管理页面
├── 统计卡片（4个指标）
├── 筛选选项卡（全部、待使用、已使用、已过期）
├── 搜索栏
├── 邀请列表
│   └── 每项显示：邀请码、状态、手机号、部门职位
└── 创建邀请按钮（固定底部）
```

---

## ✨ 功能亮点

### 1. 智能邀请码生成

- 自动生成6位唯一码
- 大写字母+数字组合
- 最多尝试10次避免重复
- 生成失败自动提示

### 2. 灵活的角色分配

- 创建时设置默认角色
- 注册时可以调整角色
- 支持4种角色体系
- 权限自动分配

### 3. 完善的状态管理

- 自动过期检查
- 支持撤销操作
- 状态变更记录
- 使用情况追踪

### 4. 友好的用户体验

- 一键复制邀请码
- 搜索和筛选功能
- 统计数据可视化
- TDesign 组件统一风格

---

## 🔧 技术实现

### 数据库表结构

**集合名称：** `wx_user_invites`

**字段说明：**
```typescript
{
  inviteCode: string          // 邀请码（6位大写字母+数字）
  inviterOpenId: string       // 邀请人 OpenID
  inviterName: string         // 邀请人姓名
  inviteeName: string | null  // 被邀请人姓名（使用后填写）
  inviteePhone: string | null // 被邀请人手机（使用后填写）
  department: string | null   // 部门（使用后填写）
  position: string | null     // 职位（使用后填写）
  defaultRole: string         // 预设的默认角色
  role: string | null         // 实际分配的角色（使用后填写）
  status: string              // 状态：pending/used/expired/revoked
  createTime: Date            // 创建时间
  expiryTime: Date            // 过期时间
  usedTime: Date | null       // 使用时间
  usedByOpenId: string | null // 使用者 OpenID
  remark: string              // 备注说明
}
```

### 云函数 Actions

```typescript
// 邀请码相关
- 'create_invite'      // 创建邀请码
- 'validate_invite'    // 验证邀请码
- 'use_invite'         // 使用邀请码
- 'get_invite_stats'   // 获取邀请统计
- 'get_invite_list'    // 获取邀请列表
- 'revoke_invite'      // 撤销邀请码
```

---

## 📱 页面路由配置

邀请管理页面已在 `app.json` 中正确配置：

```json
{
  "subpackages": [
    {
      "root": "packageUser",
      "name": "user",
      "pages": [
        "user-management/user-management",
        "invite-management/invite-management",  // ✅ 已配置
        "employee-permission/employee-permission",
        // ...
      ]
    }
  ]
}
```

**页面路径：** `/packageUser/invite-management/invite-management`

---

## ✅ 验证清单

在使用前，请确认以下功能正常：

### 基础功能
- [ ] 个人中心可以看到"邀请码管理"入口（仅管理员）
- [ ] 点击入口可以正常跳转到邀请管理页面
- [ ] 邀请管理页面正常加载
- [ ] 统计数据正确显示

### 创建邀请码
- [ ] 可以打开创建邀请弹窗
- [ ] 可以选择角色和有效期
- [ ] 可以填写备注
- [ ] 可以生成邀请码
- [ ] 可以复制邀请码

### 邀请码管理
- [ ] 可以查看邀请列表
- [ ] 可以搜索邀请记录
- [ ] 可以筛选不同状态
- [ ] 可以查看邀请详情
- [ ] 可以撤销待使用的邀请

### 注册流程
- [ ] 用户可以使用邀请码注册
- [ ] 邀请码验证正常
- [ ] 过期邀请码被拒绝
- [ ] 已使用邀请码被拒绝
- [ ] 注册后角色正确分配
- [ ] 邀请码状态自动更新

---

## 🚀 后续优化建议

### 1. 批量创建邀请码
- 支持一次生成多个邀请码
- 导出邀请码列表为 Excel
- 批量设置相同的角色和有效期

### 2. 邀请链接分享
- 生成带参数的小程序码
- 扫码自动填入邀请码
- 提升用户体验

### 3. 邀请统计增强
- 按时间统计邀请趋势
- 按角色统计邀请分布
- 按邀请人统计贡献度

### 4. 消息通知
- 邀请码被使用时通知邀请人
- 邀请码即将过期时提醒
- 邀请码被撤销时通知相关人

---

## 📝 注意事项

### 安全建议

1. **邀请码保密**
   - 提醒管理员妥善保管邀请码
   - 不要在公开场合分享
   - 及时撤销不再使用的邀请码

2. **权限控制**
   - 定期审查邀请记录
   - 检查异常注册账户
   - 及时处理权限异常

3. **有效期设置**
   - 建议使用较短的有效期（7-15天）
   - 特殊情况可延长至30天
   - 过期后及时清理记录

### 数据维护

1. **定期清理**
   - 清理过期的邀请记录（保留最近3个月）
   - 归档已使用的邀请记录
   - 删除撤销的邀请记录

2. **数据备份**
   - 定期备份邀请记录
   - 保留重要的使用记录
   - 统计数据定期导出

---

## 📞 技术支持

如遇到问题，请检查：

1. **入口不可见**
   - 确认当前用户是管理员角色
   - 检查 `isAdmin` 数据是否正确
   - 刷新页面重新加载数据

2. **创建失败**
   - 检查网络连接
   - 确认云函数已部署
   - 查看云函数日志

3. **使用失败**
   - 确认邀请码正确（大写）
   - 检查是否已过期
   - 确认是否已被使用

4. **权限错误**
   - 确认用户角色正确
   - 检查权限配置
   - 重新登录刷新权限

---

## 📊 总结

### 修改内容
- ✅ 1个文件修改：`profile.ts`
- ✅ 添加1个管理功能入口
- ✅ 无需修改后端代码
- ✅ 无需修改邀请管理页面

### 影响范围
- ✅ 仅影响个人中心管理功能列表
- ✅ 对现有功能无影响
- ✅ 向下兼容

### 测试建议
1. 使用管理员账号登录
2. 进入个人中心
3. 点击"邀请码管理"
4. 创建一个测试邀请码
5. 使用新账号测试邀请码注册
6. 验证权限分配是否正确

---

*文档生成时间：2025-11-06*  
*版本：v1.0*

