# ✅ 100%多模态方案 - 智谱GLM-4V

## 🎯 方案概述

**目标**: 100%使用多模态模型，不降级

**选择**: 智谱AI GLM-4V（免费，稳定）

**优势**:
- ✅ 一个API Key支持多个模型
- ✅ GLM-4V专门用于视觉理解
- ✅ 支持OpenAI标准格式
- ✅ 免费额度充足

---

## 📋 已完成的配置

### 1. 模型配置

```javascript
'glm-4v': {
  provider: '智谱AI',
  baseURL: 'https://open.bigmodel.cn/api/paas/v4/',
  model: 'glm-4v',  // ✅ 视觉模型
  apiKey: process.env.GLM4_API_KEY,
  maxTokens: 4096,
  costPerKToken: 0,
  maxRequestsPerDay: 500,
  supportVision: true,
  maxImages: 4
}
```

### 2. 任务映射

```javascript
'health_diagnosis_vision': {
  primary: 'glm-4v',  // ✅ 首选智谱GLM-4V
  fallback: ['qwen-vl'],
  timeout: 30000
}
```

### 3. 移除降级逻辑

- ❌ 不再自动降级到文本模型
- ✅ 图片处理失败时直接报错
- ✅ API调用失败时直接报错
- ✅ 便于调试和定位问题

---

## 🚀 部署步骤

### 第1步：确认API Key

在**微信云开发控制台** → **环境** → **环境变量**中：

确保已配置：
```
GLM4_API_KEY=你的智谱AI密钥
```

**获取方式**: https://open.bigmodel.cn/ → API管理 → API Keys

### 第2步：上传云函数

在**微信开发者工具**中:

**右键** `cloudfunctions/ai-multi-model/`  
→ **上传并部署: 云端安装依赖** ⚠️

### 第3步：编译前端

点击**编译**按钮

---

## 🧪 测试步骤

### 测试1: 纯文本（基准测试）

1. 打开AI诊断
2. 输入症状："1日龄雏鹅腹泻、白色粪便"
3. **不上传图片**
4. 点击诊断

**预期**:
- ✅ 使用文本模型（Qwen2.5-72B）
- ✅ 5-10秒完成
- ✅ 显示诊断结果

---

### 测试2: 多模态诊断（重点）

1. 打开AI诊断
2. 输入症状："雏鹅出现死亡，请分析死因"
3. **上传3张图片**
4. 点击诊断

**预期成功标志**:
- ✅ 显示"诊断处理中..."
- ✅ 10-30秒后完成
- ✅ 结果包含："**结合图片观察**..."
- ✅ 包含图片分析内容

**如果失败**:
- ❌ 会直接显示错误
- 📝 查看云函数日志定位问题

---

## 📊 查看详细日志

### 微信云开发控制台

**云函数** → **ai-multi-model** → **日志**

### 成功日志示例

```
选择模型: glm-4v, 任务类型: health_diagnosis_vision

开始处理3张图片...

====== 开始处理图片 ======
图片数量: 3
正在处理第1张图片...
正在下载图片: cloud://xxx/ai-diagnosis/xxx.jpg
图片转换成功 (方法1): { fileID: '...', base64长度: 123456 }

正在处理第2张图片...
图片转换成功 (方法1)

正在处理第3张图片...
图片转换成功 (方法1)

图片处理完成: 成功3/3
图片处理完成，已加入消息

====== 调用智谱AI ======
模型: glm-4v
API Key前6位: sk-xxx
包含图片: true

请求配置:
  model: glm-4v
  url: https://open.bigmodel.cn/api/paas/v4/chat/completions
  消息数量: 2
  消息结构: [
    { role: 'system', 内容类型: 'text' },
    { role: 'user', 内容类型: 'multipart', 内容项: ['text', 'image_url', 'image_url', 'image_url'] }
  ]

智谱AI调用成功!
返回内容长度: 1234
```

---

## 🔍 常见问题排查

### 问题1: "API Key无效"

**错误信息**: `401 Unauthorized` 或 `invalid API key`

**解决方案**:

1. 检查环境变量名称：`GLM4_API_KEY`
2. 检查API Key格式：应该以 `sk-` 开头
3. 重新生成API Key

### 问题2: "Request failed with status code 400"

**可能原因**:

#### A. 图片太大

**查看日志**:
```
图片统计: 3张, 总大小: 5000KB  ← 太大了！
```

**解决方案**: 前端压缩图片

```typescript
// miniprogram/pages/ai-diagnosis/ai-diagnosis.ts
// 在上传前添加压缩
wx.compressImage({
  src: file.tempFilePath,
  quality: 70,  // 压缩到70%
  success: (res) => {
    // 上传压缩后的图片
    wx.cloud.uploadFile({
      filePath: res.tempFilePath,
      ...
    })
  }
})
```

#### B. 图片格式问题

**查看日志**:
```
错误数据: { error: { message: "unsupported image format" } }
```

**解决方案**: 只支持jpg、jpeg、png

#### C. 图片数量超限

GLM-4V最多支持**4张图片**

**解决方案**: 限制前端上传数量或只传前4张

```typescript
// 只上传前4张
const imagesToSend = this.data.images.slice(0, 4)
```

---

### 问题3: "图片下载失败"

**错误信息**: `无法下载图片 cloud://xxx`

**可能原因**:
1. 云存储权限问题
2. fileID格式错误

**解决方案**:

#### 检查云存储权限

**微信云开发控制台** → **存储** → **权限设置**

确保:
```json
{
  "read": true,  // 或 "auth"
  "write": "auth"
}
```

#### 检查fileID格式

在数据库中查看失败任务的 `images` 字段：

```javascript
// 正确 ✅
images: [
  "cloud://cloud1-xxx.636c-cloud1-xxx/ai-diagnosis/1761136266335_6831.jpg"
]

// 错误 ❌
images: [
  "/var/tmp/xxx.jpg"  // 本地路径
]
```

---

### 问题4: 超时

**错误信息**: `timeout of 30000ms exceeded`

**原因**: 图片太大，处理时间过长

**解决方案**:

1. **压缩图片**（推荐）
2. **增加超时时间**

```javascript
// cloudfunctions/ai-multi-model/index.js
'health_diagnosis_vision': {
  primary: 'glm-4v',
  fallback: ['qwen-vl'],
  timeout: 60000  // 改为60秒
}
```

---

## 📈 性能优化建议

### 1. 前端图片压缩

```typescript
// miniprogram/pages/ai-diagnosis/ai-diagnosis.ts

async compressAndUpload(filePath) {
  // 压缩图片
  const compressed = await wx.compressImage({
    src: filePath,
    quality: 70,
    compressedWidth: 1200  // 限制宽度
  })
  
  // 上传压缩后的图片
  const result = await wx.cloud.uploadFile({
    cloudPath: `ai-diagnosis/${Date.now()}.jpg`,
    filePath: compressed.tempFilePath
  })
  
  return result.fileID
}
```

### 2. 限制图片数量

```typescript
// 最多上传4张（GLM-4V限制）
onChooseImage() {
  const remainingCount = Math.min(4 - this.data.images.length, 9)
  
  wx.chooseMedia({
    count: remainingCount,
    ...
  })
}
```

### 3. 图片质量提示

```xml
<!-- ai-diagnosis.wxml -->
<view class="upload-tips">
  <text>💡 提示：</text>
  <text>• 最多上传4张图片</text>
  <text>• 建议每张小于2MB</text>
  <text>• 清晰度越高，分析越准确</text>
</view>
```

---

## 🎯 成功标准

### 前端体验
✅ 上传图片成功  
✅ 显示"已上传X张图片"  
✅ 诊断中显示进度  
✅ 10-30秒完成诊断  
✅ 结果包含"结合图片观察..."  

### 云函数日志
✅ 选择模型: glm-4v  
✅ 图片处理完成: 成功3/3  
✅ 智谱AI调用成功!  
✅ 返回内容长度: >500  

### 诊断结果
✅ primaryDiagnosis 包含详细推理  
✅ reasoning 提到图片观察  
✅ 可能包含 imageAnalysis 字段:

```json
{
  "imageAnalysis": {
    "quality": "good",
    "observations": [
      "图片1显示雏鹅精神萎靡，羽毛松乱",
      "图片2可见粪便呈白色糊状",
      "图片3肛门周围羽毛污染严重"
    ]
  }
}
```

---

## 🔧 备选方案

### 如果GLM-4V仍然失败

可以尝试切换到其他免费多模态模型：

#### 方案1: Qwen-VL (阿里通义千问)

需要修改调用格式，Qwen-VL可能需要特殊的base64前缀。

#### 方案2: GPT-4o-mini (OpenAI)

需要付费API，但最稳定。

#### 方案3: Claude 3.5 Sonnet (Anthropic)

支持视觉，需要API Key。

---

## 📝 测试清单

- [ ] 部署 ai-multi-model 云函数
- [ ] 确认 GLM4_API_KEY 环境变量
- [ ] 纯文本诊断能成功
- [ ] 图片上传能成功
- [ ] 云存储中能看到图片
- [ ] 多模态诊断能成功
- [ ] 云函数日志显示"智谱AI调用成功!"
- [ ] 诊断结果包含图片观察内容

---

## 💡 关键改进总结

| 项目 | 之前 | 现在 |
|------|------|------|
| **首选模型** | Qwen-VL | GLM-4V |
| **降级策略** | 自动降级到文本 | 不降级，直接报错 |
| **调试能力** | 难以定位问题 | 详细日志 |
| **成功率** | 未知 | 目标100% |

---

**现在请按照步骤部署并测试！如有任何错误，请提供完整的云函数日志。** 🚀

