# âœ… 100%å¤šæ¨¡æ€æ–¹æ¡ˆ - æ™ºè°±GLM-4V

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡**: 100%ä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹ï¼Œä¸é™çº§

**é€‰æ‹©**: æ™ºè°±AI GLM-4Vï¼ˆå…è´¹ï¼Œç¨³å®šï¼‰

**ä¼˜åŠ¿**:
- âœ… ä¸€ä¸ªAPI Keyæ”¯æŒå¤šä¸ªæ¨¡å‹
- âœ… GLM-4Vä¸“é—¨ç”¨äºè§†è§‰ç†è§£
- âœ… æ”¯æŒOpenAIæ ‡å‡†æ ¼å¼
- âœ… å…è´¹é¢åº¦å……è¶³

---

## ğŸ“‹ å·²å®Œæˆçš„é…ç½®

### 1. æ¨¡å‹é…ç½®

```javascript
'glm-4v': {
  provider: 'æ™ºè°±AI',
  baseURL: 'https://open.bigmodel.cn/api/paas/v4/',
  model: 'glm-4v',  // âœ… è§†è§‰æ¨¡å‹
  apiKey: process.env.GLM4_API_KEY,
  maxTokens: 4096,
  costPerKToken: 0,
  maxRequestsPerDay: 500,
  supportVision: true,
  maxImages: 4
}
```

### 2. ä»»åŠ¡æ˜ å°„

```javascript
'health_diagnosis_vision': {
  primary: 'glm-4v',  // âœ… é¦–é€‰æ™ºè°±GLM-4V
  fallback: ['qwen-vl'],
  timeout: 30000
}
```

### 3. ç§»é™¤é™çº§é€»è¾‘

- âŒ ä¸å†è‡ªåŠ¨é™çº§åˆ°æ–‡æœ¬æ¨¡å‹
- âœ… å›¾ç‰‡å¤„ç†å¤±è´¥æ—¶ç›´æ¥æŠ¥é”™
- âœ… APIè°ƒç”¨å¤±è´¥æ—¶ç›´æ¥æŠ¥é”™
- âœ… ä¾¿äºè°ƒè¯•å’Œå®šä½é—®é¢˜

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬1æ­¥ï¼šç¡®è®¤API Key

åœ¨**å¾®ä¿¡äº‘å¼€å‘æ§åˆ¶å°** â†’ **ç¯å¢ƒ** â†’ **ç¯å¢ƒå˜é‡**ä¸­ï¼š

ç¡®ä¿å·²é…ç½®ï¼š
```
GLM4_API_KEY=ä½ çš„æ™ºè°±AIå¯†é’¥
```

**è·å–æ–¹å¼**: https://open.bigmodel.cn/ â†’ APIç®¡ç† â†’ API Keys

### ç¬¬2æ­¥ï¼šä¸Šä¼ äº‘å‡½æ•°

åœ¨**å¾®ä¿¡å¼€å‘è€…å·¥å…·**ä¸­:

**å³é”®** `cloudfunctions/ai-multi-model/`  
â†’ **ä¸Šä¼ å¹¶éƒ¨ç½²: äº‘ç«¯å®‰è£…ä¾èµ–** âš ï¸

### ç¬¬3æ­¥ï¼šç¼–è¯‘å‰ç«¯

ç‚¹å‡»**ç¼–è¯‘**æŒ‰é’®

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: çº¯æ–‡æœ¬ï¼ˆåŸºå‡†æµ‹è¯•ï¼‰

1. æ‰“å¼€AIè¯Šæ–­
2. è¾“å…¥ç—‡çŠ¶ï¼š"1æ—¥é¾„é›é¹…è…¹æ³»ã€ç™½è‰²ç²ªä¾¿"
3. **ä¸ä¸Šä¼ å›¾ç‰‡**
4. ç‚¹å‡»è¯Šæ–­

**é¢„æœŸ**:
- âœ… ä½¿ç”¨æ–‡æœ¬æ¨¡å‹ï¼ˆQwen2.5-72Bï¼‰
- âœ… 5-10ç§’å®Œæˆ
- âœ… æ˜¾ç¤ºè¯Šæ–­ç»“æœ

---

### æµ‹è¯•2: å¤šæ¨¡æ€è¯Šæ–­ï¼ˆé‡ç‚¹ï¼‰

1. æ‰“å¼€AIè¯Šæ–­
2. è¾“å…¥ç—‡çŠ¶ï¼š"é›é¹…å‡ºç°æ­»äº¡ï¼Œè¯·åˆ†ææ­»å› "
3. **ä¸Šä¼ 3å¼ å›¾ç‰‡**
4. ç‚¹å‡»è¯Šæ–­

**é¢„æœŸæˆåŠŸæ ‡å¿—**:
- âœ… æ˜¾ç¤º"è¯Šæ–­å¤„ç†ä¸­..."
- âœ… 10-30ç§’åå®Œæˆ
- âœ… ç»“æœåŒ…å«ï¼š"**ç»“åˆå›¾ç‰‡è§‚å¯Ÿ**..."
- âœ… åŒ…å«å›¾ç‰‡åˆ†æå†…å®¹

**å¦‚æœå¤±è´¥**:
- âŒ ä¼šç›´æ¥æ˜¾ç¤ºé”™è¯¯
- ğŸ“ æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—å®šä½é—®é¢˜

---

## ğŸ“Š æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### å¾®ä¿¡äº‘å¼€å‘æ§åˆ¶å°

**äº‘å‡½æ•°** â†’ **ai-multi-model** â†’ **æ—¥å¿—**

### æˆåŠŸæ—¥å¿—ç¤ºä¾‹

```
é€‰æ‹©æ¨¡å‹: glm-4v, ä»»åŠ¡ç±»å‹: health_diagnosis_vision

å¼€å§‹å¤„ç†3å¼ å›¾ç‰‡...

====== å¼€å§‹å¤„ç†å›¾ç‰‡ ======
å›¾ç‰‡æ•°é‡: 3
æ­£åœ¨å¤„ç†ç¬¬1å¼ å›¾ç‰‡...
æ­£åœ¨ä¸‹è½½å›¾ç‰‡: cloud://xxx/ai-diagnosis/xxx.jpg
å›¾ç‰‡è½¬æ¢æˆåŠŸ (æ–¹æ³•1): { fileID: '...', base64é•¿åº¦: 123456 }

æ­£åœ¨å¤„ç†ç¬¬2å¼ å›¾ç‰‡...
å›¾ç‰‡è½¬æ¢æˆåŠŸ (æ–¹æ³•1)

æ­£åœ¨å¤„ç†ç¬¬3å¼ å›¾ç‰‡...
å›¾ç‰‡è½¬æ¢æˆåŠŸ (æ–¹æ³•1)

å›¾ç‰‡å¤„ç†å®Œæˆ: æˆåŠŸ3/3
å›¾ç‰‡å¤„ç†å®Œæˆï¼Œå·²åŠ å…¥æ¶ˆæ¯

====== è°ƒç”¨æ™ºè°±AI ======
æ¨¡å‹: glm-4v
API Keyå‰6ä½: sk-xxx
åŒ…å«å›¾ç‰‡: true

è¯·æ±‚é…ç½®:
  model: glm-4v
  url: https://open.bigmodel.cn/api/paas/v4/chat/completions
  æ¶ˆæ¯æ•°é‡: 2
  æ¶ˆæ¯ç»“æ„: [
    { role: 'system', å†…å®¹ç±»å‹: 'text' },
    { role: 'user', å†…å®¹ç±»å‹: 'multipart', å†…å®¹é¡¹: ['text', 'image_url', 'image_url', 'image_url'] }
  ]

æ™ºè°±AIè°ƒç”¨æˆåŠŸ!
è¿”å›å†…å®¹é•¿åº¦: 1234
```

---

## ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: "API Keyæ— æ•ˆ"

**é”™è¯¯ä¿¡æ¯**: `401 Unauthorized` æˆ– `invalid API key`

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥ç¯å¢ƒå˜é‡åç§°ï¼š`GLM4_API_KEY`
2. æ£€æŸ¥API Keyæ ¼å¼ï¼šåº”è¯¥ä»¥ `sk-` å¼€å¤´
3. é‡æ–°ç”ŸæˆAPI Key

### é—®é¢˜2: "Request failed with status code 400"

**å¯èƒ½åŸå› **:

#### A. å›¾ç‰‡å¤ªå¤§

**æŸ¥çœ‹æ—¥å¿—**:
```
å›¾ç‰‡ç»Ÿè®¡: 3å¼ , æ€»å¤§å°: 5000KB  â† å¤ªå¤§äº†ï¼
```

**è§£å†³æ–¹æ¡ˆ**: å‰ç«¯å‹ç¼©å›¾ç‰‡

```typescript
// miniprogram/pages/ai-diagnosis/ai-diagnosis.ts
// åœ¨ä¸Šä¼ å‰æ·»åŠ å‹ç¼©
wx.compressImage({
  src: file.tempFilePath,
  quality: 70,  // å‹ç¼©åˆ°70%
  success: (res) => {
    // ä¸Šä¼ å‹ç¼©åçš„å›¾ç‰‡
    wx.cloud.uploadFile({
      filePath: res.tempFilePath,
      ...
    })
  }
})
```

#### B. å›¾ç‰‡æ ¼å¼é—®é¢˜

**æŸ¥çœ‹æ—¥å¿—**:
```
é”™è¯¯æ•°æ®: { error: { message: "unsupported image format" } }
```

**è§£å†³æ–¹æ¡ˆ**: åªæ”¯æŒjpgã€jpegã€png

#### C. å›¾ç‰‡æ•°é‡è¶…é™

GLM-4Væœ€å¤šæ”¯æŒ**4å¼ å›¾ç‰‡**

**è§£å†³æ–¹æ¡ˆ**: é™åˆ¶å‰ç«¯ä¸Šä¼ æ•°é‡æˆ–åªä¼ å‰4å¼ 

```typescript
// åªä¸Šä¼ å‰4å¼ 
const imagesToSend = this.data.images.slice(0, 4)
```

---

### é—®é¢˜3: "å›¾ç‰‡ä¸‹è½½å¤±è´¥"

**é”™è¯¯ä¿¡æ¯**: `æ— æ³•ä¸‹è½½å›¾ç‰‡ cloud://xxx`

**å¯èƒ½åŸå› **:
1. äº‘å­˜å‚¨æƒé™é—®é¢˜
2. fileIDæ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:

#### æ£€æŸ¥äº‘å­˜å‚¨æƒé™

**å¾®ä¿¡äº‘å¼€å‘æ§åˆ¶å°** â†’ **å­˜å‚¨** â†’ **æƒé™è®¾ç½®**

ç¡®ä¿:
```json
{
  "read": true,  // æˆ– "auth"
  "write": "auth"
}
```

#### æ£€æŸ¥fileIDæ ¼å¼

åœ¨æ•°æ®åº“ä¸­æŸ¥çœ‹å¤±è´¥ä»»åŠ¡çš„ `images` å­—æ®µï¼š

```javascript
// æ­£ç¡® âœ…
images: [
  "cloud://cloud1-xxx.636c-cloud1-xxx/ai-diagnosis/1761136266335_6831.jpg"
]

// é”™è¯¯ âŒ
images: [
  "/var/tmp/xxx.jpg"  // æœ¬åœ°è·¯å¾„
]
```

---

### é—®é¢˜4: è¶…æ—¶

**é”™è¯¯ä¿¡æ¯**: `timeout of 30000ms exceeded`

**åŸå› **: å›¾ç‰‡å¤ªå¤§ï¼Œå¤„ç†æ—¶é—´è¿‡é•¿

**è§£å†³æ–¹æ¡ˆ**:

1. **å‹ç¼©å›¾ç‰‡**ï¼ˆæ¨èï¼‰
2. **å¢åŠ è¶…æ—¶æ—¶é—´**

```javascript
// cloudfunctions/ai-multi-model/index.js
'health_diagnosis_vision': {
  primary: 'glm-4v',
  fallback: ['qwen-vl'],
  timeout: 60000  // æ”¹ä¸º60ç§’
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å‰ç«¯å›¾ç‰‡å‹ç¼©

```typescript
// miniprogram/pages/ai-diagnosis/ai-diagnosis.ts

async compressAndUpload(filePath) {
  // å‹ç¼©å›¾ç‰‡
  const compressed = await wx.compressImage({
    src: filePath,
    quality: 70,
    compressedWidth: 1200  // é™åˆ¶å®½åº¦
  })
  
  // ä¸Šä¼ å‹ç¼©åçš„å›¾ç‰‡
  const result = await wx.cloud.uploadFile({
    cloudPath: `ai-diagnosis/${Date.now()}.jpg`,
    filePath: compressed.tempFilePath
  })
  
  return result.fileID
}
```

### 2. é™åˆ¶å›¾ç‰‡æ•°é‡

```typescript
// æœ€å¤šä¸Šä¼ 4å¼ ï¼ˆGLM-4Vé™åˆ¶ï¼‰
onChooseImage() {
  const remainingCount = Math.min(4 - this.data.images.length, 9)
  
  wx.chooseMedia({
    count: remainingCount,
    ...
  })
}
```

### 3. å›¾ç‰‡è´¨é‡æç¤º

```xml
<!-- ai-diagnosis.wxml -->
<view class="upload-tips">
  <text>ğŸ’¡ æç¤ºï¼š</text>
  <text>â€¢ æœ€å¤šä¸Šä¼ 4å¼ å›¾ç‰‡</text>
  <text>â€¢ å»ºè®®æ¯å¼ å°äº2MB</text>
  <text>â€¢ æ¸…æ™°åº¦è¶Šé«˜ï¼Œåˆ†æè¶Šå‡†ç¡®</text>
</view>
```

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### å‰ç«¯ä½“éªŒ
âœ… ä¸Šä¼ å›¾ç‰‡æˆåŠŸ  
âœ… æ˜¾ç¤º"å·²ä¸Šä¼ Xå¼ å›¾ç‰‡"  
âœ… è¯Šæ–­ä¸­æ˜¾ç¤ºè¿›åº¦  
âœ… 10-30ç§’å®Œæˆè¯Šæ–­  
âœ… ç»“æœåŒ…å«"ç»“åˆå›¾ç‰‡è§‚å¯Ÿ..."  

### äº‘å‡½æ•°æ—¥å¿—
âœ… é€‰æ‹©æ¨¡å‹: glm-4v  
âœ… å›¾ç‰‡å¤„ç†å®Œæˆ: æˆåŠŸ3/3  
âœ… æ™ºè°±AIè°ƒç”¨æˆåŠŸ!  
âœ… è¿”å›å†…å®¹é•¿åº¦: >500  

### è¯Šæ–­ç»“æœ
âœ… primaryDiagnosis åŒ…å«è¯¦ç»†æ¨ç†  
âœ… reasoning æåˆ°å›¾ç‰‡è§‚å¯Ÿ  
âœ… å¯èƒ½åŒ…å« imageAnalysis å­—æ®µ:

```json
{
  "imageAnalysis": {
    "quality": "good",
    "observations": [
      "å›¾ç‰‡1æ˜¾ç¤ºé›é¹…ç²¾ç¥èé¡ï¼Œç¾½æ¯›æ¾ä¹±",
      "å›¾ç‰‡2å¯è§ç²ªä¾¿å‘ˆç™½è‰²ç³ŠçŠ¶",
      "å›¾ç‰‡3è‚›é—¨å‘¨å›´ç¾½æ¯›æ±¡æŸ“ä¸¥é‡"
    ]
  }
}
```

---

## ğŸ”§ å¤‡é€‰æ–¹æ¡ˆ

### å¦‚æœGLM-4Vä»ç„¶å¤±è´¥

å¯ä»¥å°è¯•åˆ‡æ¢åˆ°å…¶ä»–å…è´¹å¤šæ¨¡æ€æ¨¡å‹ï¼š

#### æ–¹æ¡ˆ1: Qwen-VL (é˜¿é‡Œé€šä¹‰åƒé—®)

éœ€è¦ä¿®æ”¹è°ƒç”¨æ ¼å¼ï¼ŒQwen-VLå¯èƒ½éœ€è¦ç‰¹æ®Šçš„base64å‰ç¼€ã€‚

#### æ–¹æ¡ˆ2: GPT-4o-mini (OpenAI)

éœ€è¦ä»˜è´¹APIï¼Œä½†æœ€ç¨³å®šã€‚

#### æ–¹æ¡ˆ3: Claude 3.5 Sonnet (Anthropic)

æ”¯æŒè§†è§‰ï¼Œéœ€è¦API Keyã€‚

---

## ğŸ“ æµ‹è¯•æ¸…å•

- [ ] éƒ¨ç½² ai-multi-model äº‘å‡½æ•°
- [ ] ç¡®è®¤ GLM4_API_KEY ç¯å¢ƒå˜é‡
- [ ] çº¯æ–‡æœ¬è¯Šæ–­èƒ½æˆåŠŸ
- [ ] å›¾ç‰‡ä¸Šä¼ èƒ½æˆåŠŸ
- [ ] äº‘å­˜å‚¨ä¸­èƒ½çœ‹åˆ°å›¾ç‰‡
- [ ] å¤šæ¨¡æ€è¯Šæ–­èƒ½æˆåŠŸ
- [ ] äº‘å‡½æ•°æ—¥å¿—æ˜¾ç¤º"æ™ºè°±AIè°ƒç”¨æˆåŠŸ!"
- [ ] è¯Šæ–­ç»“æœåŒ…å«å›¾ç‰‡è§‚å¯Ÿå†…å®¹

---

## ğŸ’¡ å…³é”®æ”¹è¿›æ€»ç»“

| é¡¹ç›® | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| **é¦–é€‰æ¨¡å‹** | Qwen-VL | GLM-4V |
| **é™çº§ç­–ç•¥** | è‡ªåŠ¨é™çº§åˆ°æ–‡æœ¬ | ä¸é™çº§ï¼Œç›´æ¥æŠ¥é”™ |
| **è°ƒè¯•èƒ½åŠ›** | éš¾ä»¥å®šä½é—®é¢˜ | è¯¦ç»†æ—¥å¿— |
| **æˆåŠŸç‡** | æœªçŸ¥ | ç›®æ ‡100% |

---

**ç°åœ¨è¯·æŒ‰ç…§æ­¥éª¤éƒ¨ç½²å¹¶æµ‹è¯•ï¼å¦‚æœ‰ä»»ä½•é”™è¯¯ï¼Œè¯·æä¾›å®Œæ•´çš„äº‘å‡½æ•°æ—¥å¿—ã€‚** ğŸš€

