# 🧪 物料管理系统完整测试脚本

## ✅ **修复完成的问题：**

### 🔧 **业务逻辑优化：**
1. **采购入库** - 现在使用 `create_record(purchase)` 而不是简单的 `create_material`
2. **领用出库** - 现在使用 `create_record(use)` 而不是直接修改库存
3. **完整流水** - 所有操作都有完整的记录和库存流水
4. **事务处理** - 确保数据一致性和库存准确性

---

## 🚀 **立即开始完整测试：**

### 第一步：清空现有数据（可选）
```javascript
// 在微信开发者工具控制台执行
// 1. 查看当前数据
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_materials' }
}).then(res => {
  console.log('当前物料:', res.result.data.materials)
})

// 2. 查看当前记录
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_records' }
}).then(res => {
  console.log('当前记录:', res.result.data.records)
})

// 3. 如需清空，先删除所有物料
/*
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_materials' }
}).then(res => {
  const materials = res.result.data.materials
  materials.forEach(material => {
    // 先清空库存再删除
    wx.cloud.callFunction({
      name: 'production-material',
      data: {
        action: 'update_material',
        materialId: material._id,
        updateData: { currentStock: 0 }
      }
    }).then(() => {
      wx.cloud.callFunction({
        name: 'production-material',
        data: {
          action: 'delete_material',
          materialId: material._id
        }
      })
    })
  })
})
*/
```

---

## 📋 **测试案例1：采购入库流程**

### 1.1 测试新物料采购
1. **进入采购表单**：
   - 导航：生产管理 → 物料管理 → 采购入库
   
2. **填写表单**：
   - 物料名称：`优质鹅用饲料`
   - 规格：`25kg/袋`
   - 单位：`袋`
   - 数量：`50`
   - 单价：`45.5`
   - 供应商：`正大饲料公司`
   - 类别：`饲料`
   - 操作人员：`采购部-张三`

3. **提交并验证**：
   - 提交成功提示
   - 控制台显示单据号：`P241205xxx`
   - 自动创建物料 + 采购记录

### 1.2 测试现有物料追加采购
1. **再次采购同种物料**：
   - 物料名称：`优质鹅用饲料`（相同）
   - 数量：`30`
   - 其他信息相同

2. **预期结果**：
   - 不创建新物料
   - 库存累加：50 + 30 = 80袋

---

## 📋 **测试案例2：第二种物料采购**

### 2.1 采购药品类物料
1. **填写表单**：
   - 物料名称：`禽用疫苗`
   - 规格：`10ml/支`
   - 单位：`支`
   - 数量：`100`
   - 单价：`15.0`
   - 供应商：`兽药公司`
   - 类别：`药品`

2. **验证结果**：
   - 成功创建药品类物料
   - 单据号：`P241205xxx`

---

## 📊 **测试案例3：概览统计验证**

### 3.1 检查主页面概览
1. **回到生产管理页面**
2. **切换到物料管理Tab**
3. **验证概览数据**：
   - 饲料库存：约2.0吨（80袋 × 25kg）
   - 药品库存：充足状态

### 3.2 控制台验证
```javascript
wx.cloud.callFunction({
  name: 'production-dashboard',
  data: { action: 'getOverviewStats' }
}).then(res => {
  console.log('概览统计:', res.result.data)
})
```

---

## 📋 **测试案例4：库存详情验证**

### 4.1 查看详情页面
1. **点击物料管理区域**
2. **进入物料库存详情页**
3. **验证显示内容**：
   - 优质鹅用饲料：80袋
   - 禽用疫苗：100支
   - 显示正确的供应商信息

---

## 📋 **测试案例5：物料领用流程**

### 5.1 测试饲料领用
1. **进入领用表单**：
   - 导航：生产管理 → 物料管理 → 物料领用

2. **填写表单**：
   - 选择物料：`优质鹅用饲料`
   - 领用数量：`15袋`
   - 用途：`1-2栏日常喂养`
   - 操作人员：`饲养员-李四`

3. **提交并验证**：
   - 单据号：`U241205xxx`
   - 库存自动减少：80 - 15 = 65袋

### 5.2 测试库存不足情况
1. **尝试超量领用**：
   - 选择物料：`禽用疫苗`
   - 领用数量：`150支`（超过100支库存）

2. **预期结果**：
   - 显示"库存不足"错误
   - 不允许提交

---

## 📋 **测试案例6：完整业务记录验证**

### 6.1 查看物料记录
```javascript
wx.cloud.callFunction({
  name: 'production-material',
  data: { 
    action: 'list_records',
    pageSize: 20
  }
}).then(res => {
  console.log('所有记录:', res.result.data.records)
  res.result.data.records.forEach(record => {
    console.log(`${record.type === 'purchase' ? '📦采购' : '📤领用'}: ${record.recordNumber} - ${record.quantity}`)
  })
})
```

### 6.2 查看库存流水
```javascript
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'inventory_logs' }
}).then(res => {
  console.log('库存流水:', res.result.data.logs)
})
```

---

## 📊 **测试案例7：高级功能验证**

### 7.1 库存统计
```javascript
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'inventory_stats' }
}).then(res => {
  console.log('库存统计:', res.result.data)
})
```

### 7.2 低库存预警
```javascript
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'low_stock_alert' }
}).then(res => {
  console.log('低库存预警:', res.result.data)
})
```

### 7.3 使用分析
```javascript
wx.cloud.callFunction({
  name: 'production-material',
  data: { 
    action: 'usage_analysis',
    dateRange: {
      start: '2024-12-01',
      end: '2024-12-31'
    }
  }
}).then(res => {
  console.log('使用分析:', res.result.data)
})
```

---

## ✅ **测试通过标准：**

### 📦 **采购功能：**
- ✅ 新物料自动创建基础信息
- ✅ 现有物料直接追加库存
- ✅ 生成规范的采购单据号
- ✅ 库存数量正确累加

### 📤 **领用功能：**
- ✅ 从现有库存中选择物料
- ✅ 自动检查库存充足性
- ✅ 生成规范的领用单据号
- ✅ 库存数量正确减少

### 📊 **统计功能：**
- ✅ 主页概览数据实时更新
- ✅ 详情页面显示准确信息
- ✅ 支持库存流水追溯
- ✅ 支持各种统计分析

### 🔄 **数据一致性：**
- ✅ 所有操作都有完整记录
- ✅ 库存变化可追溯
- ✅ 事务处理确保一致性
- ✅ 支持记录的修改和删除

---

## 🎯 **预期最终结果：**

经过完整测试后，系统应该具备：

1. **完整的物料台账**：每个物料都有详细的基础信息
2. **完整的操作记录**：每次入库/出库都有对应记录
3. **准确的库存数据**：实时库存与操作记录完全一致
4. **完善的流水账**：可以追溯每次库存变化
5. **实用的统计分析**：支持各种业务分析需求

**这是一个完全真实可用的物料管理系统！** 🎉

---

## 📞 **请测试并反馈：**

1. ✅ 采购入库是否生成正确的单据号？
2. ✅ 物料领用是否正确检查库存？
3. ✅ 概览统计是否实时更新？
4. ✅ 库存详情是否显示准确？
5. ✅ 库存流水是否完整记录？

**请按照测试脚本逐步验证，这将是一个完全专业的物料管理系统！** 🚀
