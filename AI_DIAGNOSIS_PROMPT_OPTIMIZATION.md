# AI 诊断 Prompt 优化方案

## 📊 当前问题分析

### 1. 疾病知识库不足
- ❌ 只有 5 种常见病
- ❌ 缺少狮头鹅特异性病种（球虫、里默氏杆菌、曲霉菌等）
- ❌ 日龄分段不够细致
- ❌ 缺少发病率/风险等级标注

### 2. 诊断流程不系统
- ❌ 缺少"思维链"(Chain-of-Thought)引导
- ❌ 没有明确的诊断步骤
- ❌ 鉴别诊断逻辑不清晰

### 3. 质量控制薄弱
- ❌ 缺少常见误诊陷阱提醒
- ❌ 没有诊断质量自检清单
- ❌ 置信度评估标准不明确

### 4. 格式不统一
- ❌ `getAutopsySystemPromptV2` 与新版本格式不一致
- ❌ 批次上下文格式可能淹没关键信息

---

## ✨ 改进方案

### 一、扩展疾病知识库（从 5 种 → 20+ 种）

#### 按日龄分 5 个阶段：

**第一阶段：0-7 日龄（雏鹅早期）**
1. 小鹅瘟 ★★★★★ 最高风险
2. 脐炎
3. 曲霉菌病

**第二阶段：8-21 日龄（雏鹅中后期）**
4. 小鹅瘟（延续）
5. 大肠杆菌病 ★★★★
6. 维生素/矿物质缺乏症
7. 沙门氏菌病

**第三阶段：22-45 日龄（中鹅期）**
8. 鹅副粘病毒病 ★★★★
9. 球虫病 ★★★
10. 鹅鸭疫里默氏杆菌病 ★★★★

**第四阶段：46-70 日龄（育成期）**
11. 鹅副粘病毒病（延续）
12. 禽霍乱 ★★★
13. 绦虫/吸虫病

**第五阶段：71 日龄以上（成鹅期）**
14. 鸭瘟/鹅瘟 ★★★★
15. 产蛋下降综合征
16. 痛风

**全日龄常发病**
17. 曲霉菌病（慢性）
18. 组织滴虫病
19. 应激综合征
20. 中毒

#### 每种病标注：
- 易感日龄范围
- 风险等级（★数量）
- 典型症状（详细）
- 剖检特征（带⚠️标注关键诊断标志）
- 鉴别要点
- 狮头鹅特异性

---

### 二、建立系统化诊断流程（Chain-of-Thought）

```
第一步：日龄定位
→ 根据批次日龄，锁定对应阶段高危病种

第二步：主症分析
→ 神经症状：副粘病毒、里默氏杆菌、VE 缺乏
→ 消化道症状：小鹅瘟、大肠杆菌、球虫、鸭瘟
→ 呼吸道症状：曲霉菌、大肠杆菌气囊炎
→ 运动障碍：维生素/矿物质缺乏、关节炎

第三步：剖检对照
→ 纤维素假膜位置：肠粘膜=小鹅瘟、浆膜=大肠杆菌
→ 出血部位：消化道=副粘/鸭瘟、心脏=副粘/禽霍乱
→ 坏死灶颜色/位置

第四步：历史关联
→ 批次异常记录、治疗效果、修正反馈

第五步：鉴别诊断
→ 至少列出 2 个相似疾病 + 排除理由

第六步：置信度评估
→ 高(>80)：症状+剖检+日龄完全吻合
→ 中(60-80)：部分吻合，需实验室确认
→ 低(<60)：信息不足，需补充检查
```

---

### 三、增加常见误诊陷阱提醒

**⚠️ 陷阱 1：仅凭单一症状诊断**
- 错误：看到拉稀就诊断肠炎
- 正确：结合日龄、剖检、病程综合判断

**⚠️ 陷阱 2：忽略日龄因素**
- 错误：3 日龄诊断副粘病毒（实际高发 30 天以上）
- 正确：先看日龄阶段，排除不符合的病种

**⚠️ 陷阱 3：混淆相似病变**
- 纤维素假膜：小鹅瘟在肠粘膜、大肠杆菌在浆膜
- 神经症状：副粘病毒有消化道症状、VE 缺乏无

**⚠️ 陷阱 4：忽视继发感染**
- 病毒性疾病后常继发细菌感染

**⚠️ 陷阱 5：忽略品种特异性**
- 狮头鹅体型大、生长快、对营养和环境要求高

---

### 四、诊断质量自检清单

```
✓ 日龄匹配度：诊断病种是否在该日龄高发？
✓ 症状完整性：主症、伴随症状、病程是否都考虑？
✓ 剖检关键点：有无特征性病变？是否与诊断吻合？
✓ 鉴别诊断：是否排除了相似疾病？
✓ 历史一致性：与批次历史病例是否一致或有关联？
✓ 置信度合理：是否高估或低估？
✓ 信息完整度：缺失哪些关键信息？是否影响诊断？
✓ 狮头鹅适用性：治疗方案是否考虑了体重和生理特点？
```

---

### 五、统一提示词格式

#### 病鹅诊断提示词结构：
1. 角色定位（只针对狮头鹅）
2. 诊断原则（7 条）
3. 输出 JSON 结构（带 followUp 字段）

#### 死因剖析提示词结构：
1. 角色定位（狮头鹅病理专家）
2. 分析要求（8 条）
3. 输出 JSON 结构（带 feedbackForAI 字段）

#### 统一 `getAutopsySystemPromptV2`：
- 整合到新版格式
- 保留历史案例学习功能
- 删除旧版简化格式

---

### 六、优化批次上下文格式

#### 改进建议：
1. **分层呈现**：用分隔符区分不同数据类型
2. **突出关键信息**：用标记（如 ⚠️、★）突出高风险数据
3. **简化描述**：避免冗长的流水账
4. **关联分析**：明确指出当前案例与历史的相似度

#### 示例格式：
```
【批次基线】第 35 天 | 存栏 980 只 | 异常 3 只 ⚠️ | 死亡累计 15 只

【高风险提示】
- 近 7 天内 2 例神经症状 → 疑似副粘病毒
- 上次 AI 修正：从"大肠杆菌"改为"副粘病毒"（评分 4★）

【治疗中方案】
- 恩诺沙星饮水（第 3 天），疗效：中等

【关键修正反馈】
- 案例 1：日龄 32 天，AI 判"大肠杆菌"→兽医改"副粘病毒"
  理由：有神经症状+腺胃出血，应优先考虑副粘
```

---

## 🎯 预期效果

### 诊断精度提升
- 日龄匹配准确率：从 60% → 90%+
- 鉴别诊断完整性：从 40% → 80%+
- 置信度评估合理性：从 50% → 85%+

### 诊断效率提升
- 减少人工审核时间：30%+
- 减少信息补充往返：40%+
- 提高首次诊断准确率：25%+

### 持续改进能力
- 自动学习历史修正案例
- 识别批次特异性疾病模式
- 动态调整诊断策略

---

## 📝 实施建议

### 阶段一：知识库扩展（高优先级）
1. ✅ 立即更新 `getDiseaseKnowledgePrompt()` 函数
2. 增加 20+ 种狮头鹅常见病
3. 按日龄分 5 个阶段
4. 标注风险等级和特异性

### 阶段二：流程优化（中优先级）
1. 在系统提示词中嵌入 6 步诊断流程
2. 增加误诊陷阱提醒
3. 增加质量自检清单

### 阶段三：格式统一（中优先级）
1. 统一病鹅诊断和死因剖析的 JSON 输出
2. 删除旧版 `getAutopsySystemPromptV2` 简化部分
3. 优化批次上下文格式

### 阶段四：反馈闭环（低优先级，长期）
1. 收集诊断准确率数据
2. 分析高频误诊模式
3. 定期更新知识库和提示词

---

## 🔗 相关文件

- `cloudfunctions/ai-diagnosis/index.js` - 主要提示词文件
- `cloudfunctions/health-management/index.js` - 批次数据汇总
- `miniprogram/packageAI/ai-diagnosis/ai-diagnosis.ts` - 前端诊断页面

---

**文档创建时间**：2025-10-26  
**最后更新**：2025-10-26  
**版本**：v2.0

