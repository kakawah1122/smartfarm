# 鹅价数据库集合配置说明

## 📋 集合信息

### goose_prices
**用途**：存储每日鹅价数据（鹅苗价格和肉鹅价格）

**版本**：v2.0（智能去重版）

**核心特性**：
- ✅ 按日期去重：同一天只保留一条记录
- ✅ 自动更新：新数据自动覆盖当天旧数据
- ✅ 历史完整：完整保存90天内所有日期的价格数据
- ✅ 趋势分析：支持AI预测和数据可视化

---

## 📝 创建集合

### 步骤1：创建集合
1. 登录[微信云开发控制台](https://console.cloud.tencent.com/)
2. 选择对应的环境 → 进入"数据库"模块
3. 点击"新建集合"
4. **集合名称**：`goose_prices`
5. **权限类型**：选择"自定义安全规则"

### 步骤2：配置权限（重要⚠️）

#### 选项A：简化权限（推荐，适合开发/测试）
```json
{
  "read": true,
  "write": "auth.openid != null"
}
```
**权限说明**：
- ✅ **read**: 所有用户可读
- ✅ **write**: 所有已登录用户可写

---

#### 选项B：严格权限（生产环境）
```json
{
  "read": true,
  "write": "get('database.wx_users.${auth.openid}').role in ['super_admin', 'manager']"
}
```
**权限说明**：
- ✅ **read**: 所有用户可读
- ✅ **write**: 仅超级管理员和管理员可写

**⚠️ 前置条件**：
1. 必须先有 `wx_users` 集合
2. 用户记录必须包含 `role` 字段
3. 使用 `scripts/fix-user-permission.js` 初始化用户角色

---

## 📊 添加索引

### 必需索引（立即创建）⭐

#### 索引1：日期升序索引（核心查询）
- **索引名称**：`date_1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`date`，排序：**升序(1)**

**用途**：
- ✅ 鹅价详情页加载历史数据（查询最近30天）
- ✅ 趋势图数据加载（按日期升序排序）
- ✅ 批量数据保存后刷新

**查询示例**：
```javascript
db.collection('goose_prices')
  .where({ date: db.command.gte('2025-10-09') })
  .orderBy('date', 'asc')  // 升序查询
  .limit(30)
  .get()
```

**性能影响**：
- 🚀 查询速度提升 10倍以上（从 50-100ms 降到 5-10ms）
- 📊 支持高效范围查询和排序
- ⚡ 为AI预测和数据分析提供性能保障

**创建方法**：见 [快速创建数据库索引.md](./快速创建数据库索引.md)

---

### 可选索引（按需创建）

#### 索引2：更新时间索引（管理查询）
- **索引名称**：`updateTime_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`updateTime`，排序：降序(-1)

**用途**：查询最近更新的记录（按更新时间倒序）

**查询示例**：
```javascript
db.collection('goose_prices')
  .orderBy('updateTime', 'desc')
  .limit(30)
  .get()
```

#### 索引3：来源统计索引
- **索引名称**：`source_1_date_1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`source`，排序：升序(1)
  - 字段：`date`，排序：升序(1)

**用途**：按来源筛选并按日期排序

**查询示例**：
```javascript
db.collection('goose_prices')
  .where({ source: 'ai_recognition' })
  .orderBy('source', 'asc')
  .orderBy('date', 'asc')
  .get()
```

---

### 索引配置文件

**位置**：`database-indexes/goose_prices.indexes.json`

**内容**：
```json
{
  "indexes": [
    {
      "name": "date_1",
      "keys": {
        "date": 1
      },
      "options": {
        "background": true
      }
    }
  ]
}
```

---

## 🔑 完整数据结构

### 字段清单

```javascript
{
  _id: String,              // 记录ID（自动生成）
  date: String,             // 日期（YYYY-MM-DD格式）
  
  // 鹅苗价格数组
  goslingBreeds: Array<{
    key: String,            // 品种代码：middle/large/extraLarge
    label: String,          // 品种名称：中种鹅/大种鹅/特大种鹅
    range: String,          // 价格区间：如 "26-29"
    price: Number           // 平均价格（元/只）
  }>,
  
  // 肉鹅价格数组
  meatBreeds: Array<{
    key: String,            // 日龄代码：meat120/meat130
    label: String,          // 日龄名称：肉鹅120日龄/肉鹅130日龄
    range: String,          // 价格区间：如 "16.5-17"
    price: Number           // 平均价格（元/斤）
  }>,
  
  // 原始数据备份
  rawData: Object<{
    goslingBreeds: Array,   // 鹅苗原始数据
    meatBreeds: Array       // 肉鹅原始数据
  }>,
  
  // 元数据
  source: String,           // 来源：manual/ai_recognition/wechat_article
  articleUrl: String,       // 文章链接（可选，已废弃）
  operator: String,         // 操作员名称
  createTime: Date,         // 创建时间（服务器时间，首次创建）
  updateTime: Date          // 更新时间（服务器时间，每次更新）
}
```

---

## 📝 标准数据示例

### 示例1：完整数据（包含所有品种）

```json
{
  "_id": "goose_price_20251108_001",
  "date": "2025-11-08",
  "goslingBreeds": [
    {
      "key": "middle",
      "label": "中种鹅",
      "range": "26-29",
      "price": 27.5
    },
    {
      "key": "large",
      "label": "大种鹅",
      "range": "40-42",
      "price": 41.0
    },
    {
      "key": "extraLarge",
      "label": "特大种鹅",
      "range": "44-48",
      "price": 46.0
    }
  ],
  "meatBreeds": [
    {
      "key": "meat120",
      "label": "肉鹅120日龄",
      "range": "16.5-16.5",
      "price": 16.5
    },
    {
      "key": "meat130",
      "label": "肉鹅130日龄",
      "range": "17-17",
      "price": 17.0
    }
  ],
  "rawData": {
    "goslingBreeds": [...],
    "meatBreeds": [...]
  },
  "source": "manual",
  "operator": "张三",
  "createTime": "2025-11-08T10:00:00.000Z",
  "updateTime": "2025-11-08T10:00:00.000Z"
}
```

### 示例2：最小数据（仅包含必要字段）

```json
{
  "date": "2025-11-08",
  "goslingBreeds": [
    {
      "key": "extraLarge",
      "label": "特大种鹅",
      "range": "44-48",
      "price": 46.0
    }
  ],
  "meatBreeds": [
    {
      "key": "meat130",
      "label": "肉鹅130日龄",
      "range": "17-17",
      "price": 17.0
    }
  ],
  "rawData": {
    "goslingBreeds": [...],
    "meatBreeds": [...]
  },
  "source": "manual",
  "operator": "管理员",
  "createTime": "2025-11-08T10:00:00.000Z",
  "updateTime": "2025-11-08T10:00:00.000Z"
}
```

---

## 🔄 数据去重机制（v2.0）

### 核心逻辑
**每个日期只保留一条记录**，新数据自动覆盖当天旧数据。

### 保存流程
```javascript
// 1. 查询该日期是否已存在记录
const existing = await db.collection('goose_prices')
  .where({ date: '2025-11-08' })
  .get()

if (existing.data.length > 0) {
  // 2. 已存在：更新记录
  await db.collection('goose_prices')
    .doc(existing.data[0]._id)
    .update({ data: newData })
} else {
  // 3. 不存在：新增记录
  await db.collection('goose_prices')
    .add({ data: newData })
}
```

### 优势
| 特性 | 说明 |
|-----|------|
| ✅ 数据整洁 | 每个日期一条记录，避免重复 |
| ✅ 自动更新 | 同日多次录入自动覆盖 |
| ✅ 历史完整 | 保留所有日期数据用于趋势分析 |
| ✅ 查询高效 | 按日期索引快速检索 |

### 来源标识
| source | 说明 |
|--------|------|
| `manual` | 手动录入 |
| `ai_recognition` | AI识别（Qwen-VL-Max） |
| `wechat_article` | 微信文章解析（已废弃） |

---

## 🎯 品种代码映射表

### 鹅苗品种（goslingBreeds）

| 品种代码 | 品种名称 | 价格单位 | 备注 |
|---------|---------|---------|------|
| `middle` | 中种鹅 | 元/只 | 狮头鹅中种 |
| `large` | 大种鹅 | 元/只 | 狮头鹅大种 |
| `extraLarge` | 特大种鹅 | 元/只 | 狮头鹅特大种 |

### 肉鹅日龄（meatBreeds）

| 日龄代码 | 日龄名称 | 价格单位 | 备注 |
|---------|---------|---------|------|
| `meat120` | 肉鹅120日龄 | 元/斤 | 4个月龄 |
| `meat130` | 肉鹅130日龄 | 元/斤 | 4.3个月龄 |

---

## 💻 前端数据读取示例

### 查询最新价格（推荐方式 - 按日期排序）

```typescript
const db = wx.cloud.database()

// 获取最新的价格记录（限定90天内，按日期降序）
const ninetyDaysAgo = new Date()
ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90)
const dateStr = ninetyDaysAgo.toISOString().split('T')[0]

const result = await db.collection('goose_prices')
  .where({
    date: db.command.gte(dateStr)
  })
  .orderBy('date', 'desc')
  .limit(1)
  .get()

if (result.data && result.data.length > 0) {
  const latestPrice = result.data[0]
  
  // 鹅苗价格
  console.log('鹅苗价格:', latestPrice.goslingBreeds)
  // 输出: [{ key: 'middle', label: '中种鹅', range: '26-29', price: 27.5 }, ...]
  
  // 肉鹅价格
  console.log('肉鹅价格:', latestPrice.meatBreeds)
  // 输出: [{ key: 'meat120', label: '肉鹅120日龄', range: '16.5-16.5', price: 16.5 }, ...]
}
```

**优化说明**：
- ✅ 使用 `updateTime >= 30天前` 条件，避免全表扫描
- ✅ 正常情况下鹅价每天更新，30天范围足够
- ✅ 配合 `updateTime_-1` 索引，查询性能最优

### 查询历史价格

```typescript
// 查询最近7天的价格
const sevenDaysAgo = new Date()
sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)

const result = await db.collection('goose_prices')
  .where({
    updateTime: db.command.gte(sevenDaysAgo)
  })
  .orderBy('updateTime', 'desc')
  .get()
```

---

## 📥 管理后台录入示例

### 手动录入代码

```typescript
const db = wx.cloud.database()

// 构建价格数据
const priceData = {
  date: '2025-11-08',
  goslingBreeds: [
    {
      key: 'middle',
      label: '中种鹅',
      range: '26-29',
      price: parseFloat(((26 + 29) / 2).toFixed(1)) // 27.5
    },
    {
      key: 'large',
      label: '大种鹅',
      range: '40-42',
      price: parseFloat(((40 + 42) / 2).toFixed(1)) // 41.0
    },
    {
      key: 'extraLarge',
      label: '特大种鹅',
      range: '44-48',
      price: parseFloat(((44 + 48) / 2).toFixed(1)) // 46.0
    }
  ],
  meatBreeds: [
    {
      key: 'meat120',
      label: '肉鹅120日龄',
      range: '16.5-16.5',
      price: 16.5
    },
    {
      key: 'meat130',
      label: '肉鹅130日龄',
      range: '17-17',
      price: 17.0
    }
  ],
  rawData: {
    goslingBreeds: [...],
    meatBreeds: [...]
  },
  source: 'manual',
  operator: wx.getStorageSync('userInfo')?.nickName || '管理员',
  createTime: db.serverDate(),
  updateTime: db.serverDate()
}

// 保存到数据库
await db.collection('goose_prices').add({
  data: priceData
})
```

---

## 🔄 数据验证规则

### 必填字段验证

```typescript
// 验证函数
function validatePriceData(data: any): boolean {
  // 1. 日期必填
  if (!data.date) return false
  
  // 2. 至少有一组价格数据
  if ((!data.goslingBreeds || data.goslingBreeds.length === 0) &&
      (!data.meatBreeds || data.meatBreeds.length === 0)) {
    return false
  }
  
  // 3. 品种数据格式验证
  const validateBreed = (breed: any) => {
    return breed.key && breed.label && breed.range && 
           typeof breed.price === 'number' && breed.price > 0
  }
  
  if (data.goslingBreeds) {
    for (const breed of data.goslingBreeds) {
      if (!validateBreed(breed)) return false
    }
  }
  
  if (data.meatBreeds) {
    for (const breed of data.meatBreeds) {
      if (!validateBreed(breed)) return false
    }
  }
  
  return true
}
```

---

## 📊 前端显示逻辑

### 首页显示策略

```typescript
// 首页默认显示特大种鹅的价格
const latestPrice = result.data[0]

// 显示鹅苗价格（优先特大种）
const displayGosling = latestPrice.goslingBreeds.find(b => b.key === 'extraLarge') ||
                       latestPrice.goslingBreeds[0]

// 显示肉鹅价格（优先130日龄）
const displayMeat = latestPrice.meatBreeds.find(b => b.key === 'meat130') ||
                    latestPrice.meatBreeds[0]

// 更新首页显示
this.setData({
  goosePrice: {
    gosling: displayGosling.price.toFixed(1),    // 鹅苗价格（元/只）
    adult: displayMeat.price.toFixed(1),         // 肉鹅价格（元/斤）
    goslingRange: displayGosling.range,
    adultRange: displayMeat.range
  }
})
```

### 详情页显示策略

```typescript
// 详情页显示所有品种
const latestPrice = result.data[0]

// 鹅苗标签页：显示所有鹅苗品种
const goslingTab = latestPrice.goslingBreeds.map(breed => ({
  key: breed.key,
  label: breed.label,
  price: breed.price,
  range: breed.range,
  unit: '元/只'
}))

// 成鹅标签页：显示所有肉鹅日龄
const adultTab = latestPrice.meatBreeds.map(breed => ({
  key: breed.key,
  label: breed.label,
  price: breed.price,
  range: breed.range,
  unit: '元/斤'
}))
```

---

## 🚀 性能优化建议

### 1. 查询优化
- ✅ **避免空 where 条件**：始终添加时间范围条件（如30天内）
- ✅ **使用索引字段**：查询条件使用已建立索引的字段（updateTime、date）
- ✅ **限制返回数量**：使用 `limit(n)` 限制返回记录数

### 2. 索引使用
```typescript
// ✅ 好的查询（使用索引）
db.collection('goose_prices')
  .where({ updateTime: db.command.gte(thirtyDaysAgo) })
  .orderBy('updateTime', 'desc')
  .limit(1)

// ❌ 不好的查询（全表扫描）
db.collection('goose_prices')
  .orderBy('updateTime', 'desc')
  .limit(1)
```

### 3. 缓存策略
- 首页价格数据可缓存5-10分钟，减少数据库查询
- 使用 `wx.setStorageSync` 缓存最新价格
- 详情页可从缓存读取，无需重复查询

---

## ⚠️ 注意事项

### 1. 数据一致性
- 所有价格保留1位小数
- 价格区间格式统一：`最低价-最高价`
- 日期格式统一：`YYYY-MM-DD`

### 2. 品种代码规范
- **严格使用**预定义的品种代码（middle/large/extraLarge/meat120/meat130）
- **不要**自定义新的品种代码
- 品种代码作为前端数据匹配的唯一标识

### 3. 单位说明
- 鹅苗价格：**元/只**
- 肉鹅价格：**元/斤**
- 前端显示时注意单位区分

### 4. 权限控制
- 只有管理员可以录入/修改价格
- 所有用户可以查看价格
- 云函数可以自动更新价格

---

## 📋 配置检查清单

### 数据库配置
- [ ] 创建 `goose_prices` 集合
- [ ] 配置权限规则（读：所有用户，写：管理员）
- [ ] 添加 `updateTime_-1` 索引
- [ ] 添加 `date_-1` 索引
- [ ] 添加 `source_1_updateTime_-1` 索引

### 前端适配
- [ ] 首页读取最新价格（特大种鹅 + 130日龄肉鹅）
- [ ] 详情页显示所有品种
- [ ] 管理后台录入功能
- [ ] 数据验证逻辑

### 测试验证
- [ ] 手动录入一条测试数据
- [ ] 首页是否正确显示
- [ ] 详情页是否显示所有品种
- [ ] 非管理员用户无法写入

---

## 📞 相关文档

- [鹅价管理功能说明.md](./鹅价管理功能说明.md) - 功能详细说明
- [鹅价管理功能完成总结.md](./鹅价管理功能完成总结.md) - 开发完成总结
- [DATABASE_CONFIG_GUIDE.md](./DATABASE_CONFIG_GUIDE.md) - 数据库配置总指南

---

**文档版本**：v1.0  
**创建时间**：2025-11-08  
**适用项目**：鹅数通智慧养鹅小程序  
**集合数量**：1个（goose_prices）

---

🎉 **配置完成后，请在管理后台录入第一条测试数据验证！**

