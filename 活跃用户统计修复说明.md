# æ´»è·ƒç”¨æˆ·ç»Ÿè®¡ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·ç®¡ç†é¡µé¢çš„ç»Ÿè®¡æ˜¾ç¤ºï¼š
- âœ… æ€»ç”¨æˆ·æ•°ï¼š1
- âŒ æ´»è·ƒç”¨æˆ·ï¼š0ï¼ˆåº”è¯¥æ˜¾ç¤º 1ï¼‰
- âœ… ç®¡ç†å‘˜ï¼š1  
- âœ… 30å¤©æ´»è·ƒï¼š1

## ğŸ” é—®é¢˜åŸå› 

**å­—æ®µä¸ä¸€è‡´å¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼š**

### ç™»å½•åˆ›å»ºç”¨æˆ·æ—¶
```javascript
// cloudfunctions/login/index.js
{
  isActive: true,  // ä½¿ç”¨å¸ƒå°”å€¼å­—æ®µ
  // ...
}
```

### ç»Ÿè®¡æŸ¥è¯¢æ—¶
```javascript
// cloudfunctions/user-management/index.js
db.collection('wx_users')
  .where({ status: 'active' })  // æŸ¥è¯¢å­—ç¬¦ä¸²å­—æ®µ
  .count()
```

**ç»“æœï¼š** æŸ¥è¯¢ä¸åˆ°ä»»ä½•æ•°æ®ï¼Œå› ä¸ºå­—æ®µåä¸åŒ¹é…ï¼

## ğŸ“Š å­—æ®µæ ¼å¼å¯¹æ¯”

| æ¥æº | å­—æ®µå | ç±»å‹ | å€¼ |
|------|--------|------|-----|
| **login äº‘å‡½æ•°** | `isActive` | Boolean | `true` / `false` |
| **register äº‘å‡½æ•°** | `status` | String | `'active'` / `'pending'` / `'inactive'` |
| **ç»Ÿè®¡æŸ¥è¯¢** | `status` | String | `'active'` |

## âœ… ä¿®å¤æ–¹æ¡ˆ

ä¿®æ”¹ç»Ÿè®¡å‡½æ•°ï¼Œ**å…¼å®¹ä¸¤ç§å­—æ®µæ ¼å¼**ï¼š

```javascript
// è·å–æ´»è·ƒç”¨æˆ·æ•°ï¼ˆå…¼å®¹ä¸¤ç§å­—æ®µæ ¼å¼ï¼‰
// æ–°æ ¼å¼ï¼šstatus = 'active'
// æ—§æ ¼å¼ï¼šisActive = true
const activeUsersWithStatus = await db.collection('wx_users')
  .where({ status: 'active' })
  .count()

const activeUsersWithIsActive = await db.collection('wx_users')
  .where({ isActive: true })
  .count()

// ä½¿ç”¨ä¸¤è€…ä¸­è¾ƒå¤§çš„å€¼ï¼ˆé¿å…é‡å¤è®¡æ•°ï¼‰
const activeUsers = Math.max(
  activeUsersWithStatus.total, 
  activeUsersWithIsActive.total
)
```

### ä¸ºä»€ä¹ˆä½¿ç”¨ Math.maxï¼Ÿ

å› ä¸ºç”¨æˆ·æ•°æ®åªä¼šæœ‰ä¸€ç§æ ¼å¼ï¼š
- é€šè¿‡ **login** åˆ›å»ºçš„ç”¨æˆ·æœ‰ `isActive = true`
- é€šè¿‡ **register + é‚€è¯·ç ** åˆ›å»ºçš„ç”¨æˆ·æœ‰ `status = 'active'`

å–æœ€å¤§å€¼å¯ä»¥ç¡®ä¿æ­£ç¡®ç»Ÿè®¡ä¸¤ç§æ¥æºçš„ç”¨æˆ·ï¼ŒåŒæ—¶é¿å…é‡å¤è®¡æ•°ã€‚

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šå¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼ˆæ¨èï¼‰

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. æ‰¾åˆ° `cloudfunctions/user-management` æ–‡ä»¶å¤¹
3. å³é”®ç‚¹å‡»è¯¥æ–‡ä»¶å¤¹
4. é€‰æ‹© **"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"**
5. ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦1-2åˆ†é’Ÿï¼‰

### æ–¹å¼äºŒï¼šå‘½ä»¤è¡Œ

```bash
cd cloudfunctions/user-management
npm install
# ç„¶ååœ¨å¼€å‘è€…å·¥å…·ä¸­ä¸Šä¼ 
```

## ğŸ” éªŒè¯æ­¥éª¤

éƒ¨ç½²å®Œæˆåï¼š

1. **æ‰“å¼€å°ç¨‹åº**
2. **è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢**
3. **æ£€æŸ¥ç»Ÿè®¡æ•°æ®**

é¢„æœŸç»“æœï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1    1    1    1        â”‚
â”‚æ€»ç”¨æˆ· æ´»è·ƒ ç®¡ç†å‘˜ 30å¤©æ´»è·ƒâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ‰€æœ‰æ•°æ®éƒ½åº”è¯¥æ˜¾ç¤ºä¸º 1ï¼âœ…

## ğŸ¯ é•¿æœŸè§£å†³æ–¹æ¡ˆ

### å»ºè®®ï¼šç»Ÿä¸€ä½¿ç”¨ status å­—æ®µ

ä¸ºäº†é¿å…å°†æ¥çš„æ··ä¹±ï¼Œå»ºè®®ç»Ÿä¸€ä½¿ç”¨ `status` å­—æ®µï¼š

#### 1. ä¿®æ”¹ login äº‘å‡½æ•°

```javascript
// cloudfunctions/login/index.js

// ä¿®æ”¹å‰
const userInfo = {
  // ...
  isActive: isFirstUser
}

// ä¿®æ”¹å
const userInfo = {
  // ...
  status: isFirstUser ? 'active' : 'pending'  // ç»Ÿä¸€ä½¿ç”¨ status
}
```

#### 2. çŠ¶æ€å€¼å®šä¹‰

```javascript
// æ¨èçš„ status å€¼
const USER_STATUS = {
  PENDING: 'pending',     // å¾…å®¡æ‰¹
  ACTIVE: 'active',       // å·²æ¿€æ´»
  INACTIVE: 'inactive',   // å·²ç¦ç”¨
  SUSPENDED: 'suspended'  // å·²æš‚åœ
}
```

#### 3. æ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å°†ç°æœ‰çš„ `isActive` è¿ç§»ä¸º `status`ï¼š

```javascript
// åœ¨äº‘å‡½æ•°ä¸­æ‰§è¡Œä¸€æ¬¡
const users = await db.collection('wx_users')
  .where({ isActive: db.command.exists(true) })
  .get()

for (const user of users.data) {
  await db.collection('wx_users').doc(user._id).update({
    data: {
      status: user.isActive ? 'active' : 'pending'
    }
  })
}
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `cloudfunctions/user-management/index.js` - ç»Ÿè®¡å‡½æ•°å…¼å®¹æ€§ä¿®å¤

### æ¶‰åŠçš„æ–‡ä»¶ï¼ˆæœªä¿®æ”¹ï¼‰
- `cloudfunctions/login/index.js` - ä½¿ç”¨ `isActive` å­—æ®µ
- `cloudfunctions/register/index.js` - ä½¿ç”¨ `status` å­—æ®µ

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å…¼å®¹æ€§ä¿è¯

ä¿®å¤åçš„ä»£ç å…¼å®¹ä¸¤ç§æ ¼å¼ï¼š
- âœ… å·²æœ‰ç”¨æˆ·ï¼ˆä½¿ç”¨ `isActive`ï¼‰
- âœ… æ–°ç”¨æˆ·ï¼ˆä½¿ç”¨ `status`ï¼‰
- âœ… ä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½

### 2. ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“

- âŒ **ä¸éœ€è¦**æ‰‹åŠ¨ä¿®æ”¹ç°æœ‰ç”¨æˆ·æ•°æ®
- âŒ **ä¸éœ€è¦**æ•°æ®è¿ç§»è„šæœ¬
- âœ… ç›´æ¥éƒ¨ç½²å³å¯

### 3. å‘åå…¼å®¹

- ç»Ÿè®¡åŠŸèƒ½åŒæ—¶æ”¯æŒä¸¤ç§æ ¼å¼
- ä¸ä¼šç ´åç°æœ‰çš„ç™»å½•å’Œæ³¨å†Œé€»è¾‘
- å¹³æ»‘è¿‡æ¸¡ï¼Œæ— éœ€åœæœºç»´æŠ¤

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šéƒ¨ç½²åæ´»è·ƒç”¨æˆ·ä»æ˜¾ç¤º 0

**æ£€æŸ¥æ­¥éª¤ï¼š**

1. ç¡®è®¤äº‘å‡½æ•°å·²æˆåŠŸéƒ¨ç½²
   ```
   äº‘å¼€å‘æ§åˆ¶å° â†’ äº‘å‡½æ•° â†’ user-management
   æŸ¥çœ‹æœ€æ–°éƒ¨ç½²æ—¶é—´
   ```

2. æ£€æŸ¥ç”¨æˆ·æ•°æ®
   ```
   äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ wx_users
   æŸ¥çœ‹ä½ çš„ç”¨æˆ·è®°å½•ï¼Œç¡®è®¤æœ‰ isActive æˆ– status å­—æ®µ
   ```

3. æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—
   ```
   äº‘å¼€å‘æ§åˆ¶å° â†’ äº‘å‡½æ•° â†’ user-management â†’ æ—¥å¿—
   æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
   ```

### é—®é¢˜2ï¼šæ´»è·ƒç”¨æˆ·æ•°é‡ä¸å¯¹

**å¯èƒ½åŸå› ï¼š**
- æ•°æ®åº“ä¸­æœ‰å¤šæ¡è®°å½•
- æœ‰äº›ç”¨æˆ·çš„ `isActive = false` æˆ– `status = 'pending'`

**è§£å†³æ–¹æ³•ï¼š**
```javascript
// åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢
db.collection('wx_users').get()

// æ£€æŸ¥æ¯æ¡è®°å½•çš„ isActive å’Œ status å­—æ®µ
```

## ğŸ“Š æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šlogin åˆ›å»ºçš„ç”¨æˆ·

```javascript
// ç”¨æˆ·æ•°æ®
{
  _openid: 'xxx',
  nickName: 'KAKA',
  role: 'super_admin',
  isActive: true,  // â† ä½¿ç”¨è¿™ä¸ªå­—æ®µ
  // æ²¡æœ‰ status å­—æ®µ
}

// ç»Ÿè®¡ç»“æœ
æ´»è·ƒç”¨æˆ· = 1 âœ…  // é€šè¿‡ isActive æŸ¥è¯¢åˆ°
```

### åœºæ™¯2ï¼šregister + é‚€è¯·ç åˆ›å»ºçš„ç”¨æˆ·

```javascript
// ç”¨æˆ·æ•°æ®
{
  _openid: 'yyy',
  nickName: 'å¼ ä¸‰',
  role: 'employee',
  status: 'active',  // â† ä½¿ç”¨è¿™ä¸ªå­—æ®µ
  // æ²¡æœ‰ isActive å­—æ®µ
}

// ç»Ÿè®¡ç»“æœ
æ´»è·ƒç”¨æˆ· = 1 âœ…  // é€šè¿‡ status æŸ¥è¯¢åˆ°
```

### åœºæ™¯3ï¼šæ··åˆåœºæ™¯

```javascript
// æ•°æ®åº“ä¸­æœ‰ä¸¤ä¸ªç”¨æˆ·
// ç”¨æˆ·1ï¼ˆloginåˆ›å»ºï¼‰ï¼šisActive = true
// ç”¨æˆ·2ï¼ˆregisteråˆ›å»ºï¼‰ï¼šstatus = 'active'

// ç»Ÿè®¡ç»“æœ
æ´»è·ƒç”¨æˆ· = 2 âœ…  // ä¸¤ç§æŸ¥è¯¢å„å¾—1ï¼Œmax(1, 1) = 1
// ä½†å®é™…åº”è¯¥æ˜¯2ï¼éœ€è¦æ”¹è¿›

// æ”¹è¿›æ–¹æ¡ˆï¼šä½¿ç”¨ OR æŸ¥è¯¢
db.collection('wx_users')
  .where(db.command.or([
    { status: 'active' },
    { isActive: true }
  ]))
  .count()
```

## ğŸ¯ æ”¹è¿›æ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦ç²¾ç¡®ç»Ÿè®¡ï¼‰

å¦‚æœæœªæ¥æ•°æ®åº“ä¸­åŒæ—¶å­˜åœ¨ä¸¤ç§æ ¼å¼çš„ç”¨æˆ·ï¼Œéœ€è¦æ”¹ç”¨ OR æŸ¥è¯¢ï¼š

```javascript
const activeUsers = await db.collection('wx_users')
  .where(db.command.or([
    { status: 'active' },
    { isActive: true }
  ]))
  .count()
```

ä½†ç›®å‰çš„ `Math.max` æ–¹æ¡ˆå·²ç»è¶³å¤Ÿï¼Œå› ä¸ºï¼š
1. ä½ æ˜¯å”¯ä¸€çš„ç”¨æˆ·
2. ä½¿ç”¨çš„æ˜¯ login åˆ›å»ºçš„è´¦æˆ·ï¼ˆæœ‰ `isActive` å­—æ®µï¼‰
3. æŸ¥è¯¢ `isActive = true` ä¼šè¿”å› 1

## âœ… æ€»ç»“

### é—®é¢˜åŸå› 
- å­—æ®µä¸ä¸€è‡´ï¼š`isActive` vs `status`

### ä¿®å¤æ–¹æ¡ˆ
- å…¼å®¹ä¸¤ç§å­—æ®µæ ¼å¼
- ä½¿ç”¨ Math.max å–æœ€å¤§å€¼

### éƒ¨ç½²æ–¹å¼
- ä¸Šä¼  user-management äº‘å‡½æ•°

### é¢„æœŸæ•ˆæœ
- æ´»è·ƒç”¨æˆ·æ˜¾ç¤º 1 âœ…

---

*ä¿®å¤æ—¶é—´ï¼š2025-11-06*  
*ç‰ˆæœ¬ï¼šv1.0*

