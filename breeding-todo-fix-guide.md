# 🔧 养殖待办事项问题修复指南

## ❗ 问题分析

用户添加了入栏记录，但没有生成相应的防疫待办事项。

## 🔍 排查过程

### 1. 问题根源
- **缺少 getActiveBatches 功能**：首页调用了不存在的云函数 action
- **状态字段不匹配**：入栏记录默认状态为"待验收"，但查询活跃批次时只查询"active"状态
- **缺少调试信息**：无法确定具体哪个环节出错

### 2. 修复方案

#### A. 添加 getActiveBatches 云函数功能
在 `cloudfunctions/production-entry/index.js` 中：
- ✅ 添加了 `getActiveBatches` action
- ✅ 实现了获取活跃批次的完整逻辑
- ✅ 包含日龄计算和数据格式转换

#### B. 修复状态字段匹配问题
- ✅ 将新入栏记录的默认状态从"待验收"改为"active"
- ✅ 扩展查询条件，支持多种活跃状态：`['active', '待验收', '已验收']`

#### C. 添加调试信息
- ✅ 在首页 `loadTodayBreedingTasks` 中添加详细日志
- ✅ 在 `getTodayTasks` 函数中添加日龄计算调试
- ✅ 在云函数中添加查询过程日志

## 🚀 修复后的工作流程

### 1. 用户添加入栏记录
```
用户操作 → production-entry.create → status: 'active' → 数据库存储
```

### 2. 首页加载待办事项
```
首页加载 → production-entry.getActiveBatches → 查询活跃批次 → 
计算日龄 → getTodayTasks → 获取当日任务 → 显示待办
```

### 3. 日龄计算逻辑
```javascript
const dayAge = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24)) + 1
```

## 📋 测试验证步骤

### 1. 部署更新的云函数
```bash
# 在微信开发者工具中
# 右键 cloudfunctions/production-entry
# 选择"上传并部署：云端安装依赖"
```

### 2. 清理缓存并重新测试
```bash
# 在开发者工具中
# 清除缓存 → 重新编译 → 刷新页面
```

### 3. 查看调试信息
在浏览器控制台中查看：
```
批次查询结果: {...}
活跃批次数量: X
选中的批次: {...}
getTodayTasks调试信息:
- 入栏日期: 2024-XX-XX
- 今日日期: 2024-XX-XX  
- 计算日龄: X
- 该日龄任务数量: X
今日任务计算结果: {...}
```

### 4. 预期结果
如果修复成功，应该看到：
- ✅ 批次查询返回至少1个活跃批次
- ✅ 日龄计算正确（1-80范围内）
- ✅ 对应日龄有具体任务
- ✅ 首页显示今日待办事项

## 🐛 可能的其他问题

### 1. 入栏日期格式问题
如果日期格式不正确，日龄计算可能出错：
```javascript
// 确保入栏日期格式为: YYYY-MM-DD
entryDate: "2024-12-11"
```

### 2. 云函数权限问题
确保云函数有正确的数据库访问权限：
```javascript
// 检查数据库权限设置
collection('entry_records') - 所有用户可读，仅创建者可读写
```

### 3. 时区问题
日期计算可能受时区影响：
```javascript
// 可以考虑使用固定时区
const today = new Date()
const startDate = new Date(batchStartDate + 'T00:00:00.000Z')
```

### 4. 防疫流程节点缺失
如果计算出的日龄没有对应的任务：
```javascript
// 检查 BREEDING_SCHEDULE 是否包含该日龄
console.log('第X日龄任务:', BREEDING_SCHEDULE[dayAge])
```

## 🎯 验证完整流程

### 测试场景1：新入栏（第1日龄）
```
入栏日期: 今天
预期日龄: 1
预期任务: 入栏健康检查 + 3%葡萄糖或红糖水+电解多维
```

### 测试场景2：第2日龄
```  
入栏日期: 昨天
预期日龄: 2
预期任务: 小鹅瘟疫苗第一针 + 开口药第1天
```

### 测试场景3：第6日龄
```
入栏日期: 5天前  
预期日龄: 6
预期任务: 第二针疫苗 + 控料第2天 + 多维防应激
```

## 📞 如果问题仍然存在

### 1. 检查数据库
- 确认入栏记录已正确保存
- 检查状态字段值
- 验证日期格式

### 2. 查看完整日志
- 云函数调用日志
- 前端控制台输出
- 错误信息详情

### 3. 手动测试云函数
在云开发控制台中手动调用：
```javascript
// 测试 getActiveBatches
{
  "action": "getActiveBatches"
}
```

## 🎉 修复完成后的效果

修复成功后，用户将看到：
- ✅ 首页"今日待办"显示真实的防疫任务
- ✅ 任务精确到具体日龄
- ✅ 连续任务显示进度（如"开口药第X天"）
- ✅ 重叠任务智能提醒
- ✅ 优先级颜色区分

**每只鹅的每一天都会得到专业的防疫指导！** 🦢✨
