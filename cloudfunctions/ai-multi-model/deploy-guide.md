# AI智能盘点云函数部署指南

## 🚀 快速部署

### 第一步：获取API密钥

#### 百度AI（必需 - 图像识别主服务）
1. 访问 [百度智能云控制台](https://console.bce.baidu.com/ai/#/ai/)
2. 创建应用，获取 `API Key` 和 `Secret Key`
3. 开通"图像识别"服务

#### 其他AI服务（可选）
根据需要获取以下服务的API密钥：
- [智谱AI](https://open.bigmodel.cn/) - 免费额度
- [DeepSeek](https://platform.deepseek.com/) - 高性价比
- [Moonshot](https://platform.moonshot.cn/) - 长文本
- [Groq](https://console.groq.com/) - 高速推理

### 第二步：配置环境变量

在微信开发者工具中：

1. **右键点击** `ai-multi-model` 云函数文件夹
2. **选择** "云函数设置"
3. **切换到** "环境变量" 选项卡
4. **添加变量**：

```
变量名: BAIDU_API_KEY
变量值: 你的百度API密钥

变量名: BAIDU_SECRET_KEY  
变量值: 你的百度Secret密钥
```

5. **可选添加**其他AI服务密钥

### 第三步：部署云函数

1. **右键点击** `ai-multi-model` 云函数文件夹
2. **选择** "上传并部署：云端安装依赖"
3. **等待** 部署完成

### 第四步：测试功能

在微信开发者工具控制台中测试：

```javascript
// 测试AI盘点功能
wx.cloud.callFunction({
  name: 'ai-multi-model',
  data: {
    action: 'image_recognition',
    imageData: 'data:image/jpeg;base64,/9j/4AAQ...', // 实际的base64图像
    location: '测试区域',
    expectedRange: { min: 10, max: 100 }
  },
  success: res => {
    console.log('AI盘点结果:', res.result)
  }
})
```

## ⚠️ 重要注意事项

### 安全配置
- ✅ **环境变量配置**：API密钥必须在云函数环境变量中配置
- ❌ **代码中硬编码**：绝不在代码中直接写入API密钥
- 🔒 **权限控制**：确保云函数权限设置正确

### 成本控制
- 📊 **监控用量**：定期检查API调用次数和费用
- 💰 **设置限额**：在API提供商控制台设置消费限额
- 🎯 **优化调用**：合理使用缓存机制

### 测试建议
- 🧪 **小规模测试**：先用少量图片测试功能
- 📱 **真机测试**：在真实设备上测试完整流程
- 🔍 **结果验证**：对比AI识别结果与人工计数

## 🛠️ 故障排除

### 常见问题

#### 1. "handler not found" 错误
**原因**：云函数未正确部署或代码有语法错误
**解决**：
- 检查代码语法
- 重新部署云函数
- 查看云函数日志

#### 2. API调用失败
**原因**：API密钥未配置或无效
**解决**：
- 检查环境变量配置
- 验证API密钥有效性
- 确认API服务已开通

#### 3. 识别结果不准确
**原因**：图像质量或AI模型限制
**解决**：
- 提高图像质量
- 调整拍摄角度和光线
- 使用智能估算降级方案

### 调试技巧

#### 查看云函数日志
1. 在微信开发者工具中打开"云开发"控制台
2. 点击"云函数"选项卡
3. 找到`ai-multi-model`函数
4. 查看"调用日志"

#### 本地测试
```javascript
// 在微信开发者工具控制台中运行
wx.cloud.callFunction({
  name: 'ai-multi-model',
  data: {
    action: 'health_check'
  }
}).then(res => {
  console.log('健康检查结果:', res.result)
})
```

## 📈 优化建议

### 性能优化
- 压缩图像大小（建议1MB以内）
- 使用缓存减少重复调用
- 合理设置超时时间

### 准确性提升
- 确保拍摄环境光线充足
- 避免过度拥挤的场景
- 多角度拍摄进行对比

### 用户体验
- 添加加载提示
- 提供操作指引
- 显示置信度信息

## 🔄 更新维护

### 定期检查
- 监控API调用量和费用
- 检查错误日志
- 更新API密钥（如过期）

### 功能升级
- 根据使用反馈优化算法
- 增加新的AI服务提供商
- 改进异常检测逻辑

## 📞 技术支持

如遇到问题，可以：
1. 查看详细的README.md文档
2. 检查微信开发者工具控制台日志
3. 参考环境变量配置示例(env.example)

---

**部署完成后，AI智能盘点功能就可以在您的小程序中正常使用了！** 🎉
