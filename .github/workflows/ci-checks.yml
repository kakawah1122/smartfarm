name: CI Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run TypeScript check
      id: typescript
      run: |
        echo "### TypeScriptæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        npm run check:ts 2>&1 | tee typescript.log | tail -10 >> $GITHUB_STEP_SUMMARY || true
        if grep -q "anyç±»åž‹ä½¿ç”¨" typescript.log; then
          echo "âš ï¸ å­˜åœ¨anyç±»åž‹ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… TypeScriptæ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
    
    - name: Run code standards check
      id: code-standards
      run: |
        echo "### ä»£ç è§„èŒƒæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        npm run check:code 2>&1 | tee code.log | tail -10 >> $GITHUB_STEP_SUMMARY || true
        if grep -q "é”™è¯¯æ€»æ•°: 0" code.log; then
          echo "âœ… ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ å­˜åœ¨ä»£ç è§„èŒƒé—®é¢˜" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
    
    - name: Run style check
      id: style
      run: |
        echo "### æ ·å¼è§„èŒƒæ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        npm run check:style 2>&1 | tee style.log | tail -10 >> $GITHUB_STEP_SUMMARY || true
        ERROR_COUNT=$(grep "é”™è¯¯æ€»æ•°:" style.log | awk '{print $2}')
        if [ "$ERROR_COUNT" -lt "100" ]; then
          echo "âœ… æ ·å¼æ£€æŸ¥åŸºæœ¬é€šè¿‡ï¼ˆé”™è¯¯æ•°ï¼š$ERROR_COUNTï¼‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æ ·å¼é—®é¢˜è¾ƒå¤šï¼ˆé”™è¯¯æ•°ï¼š$ERROR_COUNTï¼‰" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
    
    - name: Generate final summary
      if: always()
      run: |
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š æ•´ä½“è¯„ä¼°" >> $GITHUB_STEP_SUMMARY
        echo "æ‰€æœ‰æ£€æŸ¥å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ æç¤ºï¼š" >> $GITHUB_STEP_SUMMARY
        echo "- é»„è‰²è­¦å‘Šä¸ä¼šé˜»æ­¢åˆå¹¶ï¼Œä½†å»ºè®®ä¿®å¤" >> $GITHUB_STEP_SUMMARY
        echo "- å®šæœŸè¿è¡Œ \`npm run fix:all\` è‡ªåŠ¨ä¿®å¤é—®é¢˜" >> $GITHUB_STEP_SUMMARY
    
    - name: Use Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: 18
    - name: Install deps
      run: npm install
      working-directory: miniprogram
    - name: Check package size
      run: node scripts/check-package-size.js
    - name: Verify finance cost schema sample
      run: node scripts/verify-schema-fields.js finance-cost data/samples/finance-cost.json
    - name: Verify production batch entry schema sample
      run: node scripts/verify-schema-fields.js production-batch-entry data/samples/production-batch-entry.json
    - name: Verify user profile schema sample
      run: node scripts/verify-schema-fields.js user-profile data/samples/user-profile.json
    - name: Verify task todo schema sample
      run: node scripts/verify-schema-fields.js task-todo data/samples/task-todo.json
    - name: Verify ai diagnosis schema sample
      run: node scripts/verify-schema-fields.js ai-diagnosis data/samples/ai-diagnosis.json
