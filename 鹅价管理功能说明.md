# 鹅价管理功能说明文档

## 📋 功能概述

鹅价管理功能允许管理员手动录入或通过链接解析的方式更新每日鹅价数据，并在小程序首页展示给用户。

## 🎯 功能特性

### 1. 手动录入价格
- ✅ 支持录入鹅苗价格（中种鹅、大种鹅、特大种鹅）
- ✅ 支持录入肉鹅价格（120日龄、130日龄）
- ✅ 价格区间录入，自动计算平均值
- ✅ 日期选择，支持历史数据录入
- ✅ 实时预览和确认机制

### 2. 链接解析（开发中）
- ⏳ 微信公众号文章链接解析
- ⏳ 自动提取价格数据
- ⏳ 支持OCR识别图片价格

### 3. 历史记录
- ✅ 查看最近10条更新记录
- ✅ 显示更新日期和来源
- ✅ 支持查看历史详情

## 📁 文件结构

```
miniprogram/packageUser/price-management/
├── price-management.json    # 页面配置
├── price-management.wxml    # 页面结构
├── price-management.ts      # 页面逻辑
└── price-management.scss    # 页面样式

cloudfunctions/parse-wechat-article/
├── index.js                 # 云函数主文件
└── package.json             # 依赖配置
```

## 💾 数据库设计

### 数据集合：`goose_prices`

```javascript
{
  _id: String,                    // 记录ID
  date: String,                   // 日期 (YYYY-MM-DD)
  goslingBreeds: Array,           // 鹅苗价格数据
  meatBreeds: Array,              // 肉鹅价格数据
  rawData: Object,                // 原始数据
  source: String,                 // 来源 (manual/wechat_article)
  articleUrl: String,             // 文章链接（如有）
  operator: String,               // 操作员
  createTime: Date,               // 创建时间
  updateTime: Date                // 更新时间
}
```

### 鹅苗价格数据结构 (`goslingBreeds`)

```javascript
[
  {
    key: 'middle',              // 品种代码
    label: '中种鹅',            // 品种名称
    range: '38-41',             // 价格区间
    price: 39.5                 // 平均价格（元/只）
  },
  {
    key: 'large',
    label: '大种鹅',
    range: '52-54',
    price: 53.0
  },
  {
    key: 'extraLarge',
    label: '特大种鹅',
    range: '56-60',
    price: 58.0
  }
]
```

### 肉鹅价格数据结构 (`meatBreeds`)

```javascript
[
  {
    key: 'meat120',             // 品种代码
    label: '肉鹅120日龄',       // 品种名称
    range: '18-18.5',           // 价格区间
    price: 18.25                // 平均价格（元/斤）
  },
  {
    key: 'meat130',
    label: '肉鹅130日龄',
    range: '18.5-19',
    price: 18.75
  }
]
```

## 🚀 使用流程

### 管理员操作流程

1. **进入鹅价管理**
   - 打开小程序
   - 进入"个人中心"
   - 点击"管理功能" > "鹅价管理"

2. **手动录入价格**
   - 选择"手动录入"标签页
   - 选择日期
   - 输入各品种价格区间
   - 点击"保存价格数据"

3. **查看历史记录**
   - 页面下方显示最近更新记录
   - 点击记录可查看详情

### 数据展示流程

1. **首页展示**
   - 首页鹅价卡片自动读取最新数据
   - 显示特大种鹅苗和肉鹅价格
   - 支持点击查看详情

2. **详情页展示**
   - 显示所有品种价格
   - 展示价格走势图
   - 支持品种切换

## 🔧 配置说明

### 数据库权限配置

需要在云开发控制台配置 `goose_prices` 集合的权限：

```json
{
  "read": true,
  "write": "doc._openid == auth.openid && auth.role == 'admin'"
}
```

### 云函数部署

```bash
# 进入云函数目录
cd cloudfunctions/parse-wechat-article

# 安装依赖
npm install

# 上传并部署
# 在微信开发者工具中右键云函数目录 > 上传并部署
```

## 📊 数据格式示例

### 公众号文章格式

```
2025/11/8狮头鹅鹅苗价格

┌────────┬─────────┬─────────┬──────────┐
│  日期  │  中种鹅 │  大种鹅 │ 特大种鹅 │
│        │ (元/只) │ (元/只) │  (元/只) │
├────────┼─────────┼─────────┼──────────┤
│11月8日 │  26-29  │  40-42  │   44-48  │
└────────┴─────────┴─────────┴──────────┘

2025/11/8狮头鹅肉鹅价格

┌────────┬──────────┬──────────┐
│  日期  │肉鹅120日龄│肉鹅130日龄│
│        │  (元/斤) │  (元/斤)  │
├────────┼──────────┼──────────┤
│11月8日 │   16.5   │    17    │
└────────┴──────────┴──────────┘
```

### 录入示例

**日期**: 2025-11-08

**鹅苗价格**:
- 中种鹅: 26-29 元/只 → 平均 27.5
- 大种鹅: 40-42 元/只 → 平均 41.0
- 特大种鹅: 44-48 元/只 → 平均 46.0

**肉鹅价格**:
- 120日龄: 16.5-16.5 元/斤 → 平均 16.5
- 130日龄: 17-17 元/斤 → 平均 17.0

## 🔐 权限控制

- **查看权限**: 所有用户
- **录入权限**: 仅管理员
- **编辑权限**: 仅管理员
- **删除权限**: 仅管理员

权限判断在 `pages/profile/profile.ts` 中的 `isAdmin` 字段。

## 📝 开发注意事项

### 1. 数据验证
- 价格必须为数字
- 最高价必须大于或等于最低价
- 日期不能为空
- 至少录入一组价格数据

### 2. 错误处理
- 使用 `try-catch` 捕获异常
- 显示友好的错误提示
- 记录错误日志

### 3. 性能优化
- 历史记录限制10条
- 使用索引优化查询
- 缓存最新价格数据

## 🔄 后续优化计划

### 短期计划
- [ ] 完善链接解析功能
- [ ] 添加批量导入功能
- [ ] 支持Excel导入
- [ ] 添加数据导出功能

### 长期计划
- [ ] 接入微信公众平台API
- [ ] 实现自动采集定时任务
- [ ] 添加价格预测分析
- [ ] 支持多地区价格对比

## 🐛 问题排查

### 常见问题

1. **无法保存数据**
   - 检查云数据库权限配置
   - 确认用户是否为管理员
   - 查看控制台错误信息

2. **历史记录不显示**
   - 检查数据库连接
   - 确认集合名称正确
   - 检查查询条件

3. **价格计算错误**
   - 验证输入格式
   - 检查parseFloat转换
   - 确认保留小数位数

## 📞 技术支持

如有问题，请联系项目负责人或查看项目文档。

---

**最后更新**: 2025-11-08  
**版本**: v1.0.0

