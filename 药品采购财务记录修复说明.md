# 药品采购财务记录修复说明

## 问题描述

1. **药品采购未正确分类**：药品采购记录被归类为"其他费用"，而不是"药品采购"
2. **金额显示为0**：部分药品采购记录的金额显示为0
3. **治疗用药记录缺失**：治疗时使用的药品没有在财务记录中显示
4. **业务逻辑问题**：采购药品和使用药品的费用记录关系不明确

## 修复内容

### 1. 药品采购分类修复

**位置**：`cloudfunctions/finance-management/index.js` - `getAllFinanceRecords` 函数

**修改内容**：
- 添加了对药品类别的识别逻辑
- 当物料 `category` 为 `'药品'`、`'medicine'` 或 `'营养品'` 时，将 `costType` 设置为 `'health'`
- 药品采购记录的描述改为 `药品采购 - ${materialName} - ${supplier} - ${quantity}${unit}`

**代码变更**：
```javascript
// 判断类别：饲料归入饲料成本，药品归入医疗费用，其他归入其他费用
const category = material.data.category || material.data.type || ''
if (category === '饲料') {
  costType = 'feed'
} else if (category === '药品' || category === 'medicine' || category === '营养品') {
  costType = 'health'
}
```

### 2. 金额计算修复

**位置**：`cloudfunctions/finance-management/index.js` - `getAllFinanceRecords` 函数

**修改内容**：
- 增强了金额计算逻辑，按以下优先级计算：
  1. 优先使用 `record.totalAmount`
  2. 如果为0，使用 `record.quantity * record.unitPrice`
  3. 如果还是0，从物料信息中获取 `unitPrice` 并计算

**代码变更**：
```javascript
// 计算总金额：优先使用 totalAmount，如果没有则用 quantity * unitPrice
let amount = record.totalAmount || 0
if (amount === 0 && record.quantity && record.unitPrice) {
  amount = Number(record.quantity) * Number(record.unitPrice)
}
// 如果还是0，尝试从物料信息获取单价
if (amount === 0 && record.quantity && record.materialId) {
  try {
    const material = await db.collection(COLLECTIONS.PROD_MATERIALS).doc(record.materialId).get()
    if (material.data && material.data.unitPrice) {
      amount = Number(record.quantity) * Number(material.data.unitPrice)
    }
  } catch (e) {
    // 查询失败，保持为0
  }
}
```

### 3. 治疗用药记录添加

**位置**：`cloudfunctions/finance-management/index.js` - `getAllFinanceRecords` 函数

**修改内容**：
- 新增查询 `PROD_MATERIAL_RECORDS` 中 `type='use'` 且 `relatedModule='health_treatment'` 的记录
- 这些记录代表治疗时使用的药品，作为"治疗用药"成本显示在财务记录中
- 记录描述格式：`治疗用药 - ${materialName} - ${diagnosis} - ${quantity}${unit}`

**代码变更**：
```javascript
// 7. 获取治疗领用记录（治疗用药成本）
let treatmentUseQuery = db.collection(COLLECTIONS.PROD_MATERIAL_RECORDS).where({
  isDeleted: false,
  type: 'use',
  relatedModule: 'health_treatment'
})
// ... 日期和批次过滤逻辑 ...
```

### 4. 成本分解统计更新

**位置**：`cloudfunctions/finance-management/reimbursement-handler.js` - `getCostBreakdownByDateRange` 函数

**修改内容**：
- 更新了采购记录的分类逻辑，药品采购归入 `medicalCost`
- 添加了治疗领用记录的统计，归入 `medicalCost`
- 增强了金额计算逻辑，与财务记录查询保持一致

## 业务逻辑说明

### 采购和使用的关系

**正确的费用记录方式**：

1. **采购时**：
   - 记录为"药品采购"成本（`costType: 'health'`）
   - 金额 = 采购数量 × 采购单价
   - 这是**库存成本**，无论是否立即使用，都应该全额记录
   - **在财务记录中显示**，用于追踪资金支出

2. **使用时**：
   - 记录为"治疗用药"成本（`costType: 'health'`，`source: 'treatment'`）
   - 金额 = 使用数量 × 物料单价（从库存中扣减）
   - 这是**实际使用成本**，从库存中扣减
   - **在财务记录中显示**，并在**成本分解统计中计入**

**示例**：
- 采购100件药品，单价10元，总金额1000元
  - 财务记录：`药品采购 - 浆膜清 - 供应商 - 100件`，金额：-¥1000
  - 库存增加：100件
  - **成本分解统计**：不计入（避免重复计算）

- 治疗时使用20件药品，单价10元，总金额200元
  - 财务记录：`治疗用药 - 浆膜清 - 治疗 - 20件`，金额：-¥200
  - 库存减少：20件（剩余80件）
  - **成本分解统计**：计入医疗费用 ¥200

**为什么这样设计**：
- **财务记录层面**：
  - 采购时全额记录：反映实际的资金支出（现金流）
  - 使用时记录：反映实际的治疗成本（成本核算）
  - 两者都显示在财务记录中，便于全面了解资金流向

- **成本核算层面**：
  - **只统计治疗用药成本**：避免重复计算
  - 采购时不计入成本分解统计：因为药品是库存资产，只有在使用时才转为成本
  - 这样符合会计原则：采购是资产增加，使用是成本发生

### 避免重复计算的机制

**问题**：如果采购时计入成本，使用时又计入成本，会导致重复计算。

**解决方案**：
- 在 `getCostBreakdownByDateRange` 函数中：
  - **药品采购**：不计入成本分解统计（已注释相关代码）
  - **治疗用药**：计入医疗费用
  - **饲料采购**：计入饲料成本（因为饲料通常是直接使用，没有库存概念）

**注意**：
- `getCostSumByDateRange` 函数（总成本统计）仍然包含采购记录，因为它是用于现金流统计，需要反映所有资金支出
- `getCostBreakdownByDateRange` 函数（成本分解统计）排除药品采购，只统计实际使用的成本

### 财务记录类型

财务记录现在包含以下类型：

1. **药品采购**（`source: 'purchase'`, `costType: 'health'`）
   - 从 `PROD_MATERIAL_RECORDS` 中 `type='purchase'` 的记录生成
   - 物料类别为"药品"、"medicine"或"营养品"

2. **治疗用药**（`source: 'treatment'`, `costType: 'health'`）
   - 从 `PROD_MATERIAL_RECORDS` 中 `type='use'` 且 `relatedModule='health_treatment'` 的记录生成
   - 关联到具体的治疗记录

3. **其他费用**（`source: 'purchase'`, `costType: 'other'`）
   - 非饲料、非药品的物料采购

## 数据库字段要求

### PROD_MATERIAL_RECORDS 集合

采购记录应包含以下字段：
- `type`: `'purchase'`（采购）或 `'use'`（领用）
- `materialId`: 物料ID（必需）
- `quantity`: 数量（必需）
- `unitPrice`: 单价（建议包含）
- `totalAmount`: 总金额（建议包含，如果没有会自动计算）
- `category`: 物料类别（可选，会从物料信息中获取）
- `supplier`: 供应商
- `relatedBatch`: 关联批次
- `relatedModule`: 关联模块（领用时为 `'health_treatment'`）
- `relatedId`: 关联记录ID（领用时为治疗记录ID）

### PROD_MATERIALS 集合

物料信息应包含以下字段：
- `category`: 物料类别（`'饲料'`、`'药品'`、`'营养品'` 等）
- `name`: 物料名称
- `unitPrice`: 单价（用于计算金额）

## 测试建议

1. **测试药品采购记录**：
   - 创建一条药品采购记录（category='药品'）
   - 检查财务记录中是否正确显示为"药品采购"
   - 检查金额是否正确计算

2. **测试治疗用药记录**：
   - 创建治疗记录并使用药品
   - 检查财务记录中是否正确显示"治疗用药"
   - 检查金额是否正确计算

3. **测试金额为0的情况**：
   - 创建一条没有 `totalAmount` 的采购记录
   - 检查是否能从 `quantity * unitPrice` 计算金额
   - 检查是否能从物料信息中获取单价并计算

4. **测试成本分解统计**：
   - 查看成本分解统计
   - 检查药品采购是否归入医疗费用
   - 检查治疗用药是否归入医疗费用

## 注意事项

1. **历史数据**：如果历史数据中药品采购记录的金额为0，可能需要手动修复或重新计算
2. **物料类别**：确保物料信息中的 `category` 字段正确设置
3. **单价更新**：采购时建议更新物料的 `unitPrice`，以便后续使用时正确计算金额
4. **批次关联**：治疗记录需要正确关联到批次，才能正确过滤财务记录

## 相关文件

- `cloudfunctions/finance-management/index.js` - 财务记录查询主函数
- `cloudfunctions/finance-management/reimbursement-handler.js` - 成本分解统计函数
- `cloudfunctions/production-material/index.js` - 物料采购记录创建
- `cloudfunctions/health-management/index.js` - 治疗记录和药品领用

