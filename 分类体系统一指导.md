# 物料分类体系统一完整指导

## 📋 **修改总结**

我们已经将系统统一为**中文分类体系**，确保前端、后端、数据库的一致性。

### ✅ **已完成的修改**

#### 1. **前端页面修改**
- **采购表单** (`purchase-form.ts`)
  - ✅ 智能推断返回中文分类
  - ✅ 分类选择器存储中文值
  - ✅ 添加"营养品"分类选项

- **健康记录表单** (`health-record-form.ts`)
  - ✅ 物料筛选使用中文分类
  - ✅ 药品治疗筛选"药品"分类
  - ✅ 营养支持筛选"营养品"分类

- **库存详情页** (`inventory-detail.ts`)
  - ✅ 页面标题映射中文分类
  - ✅ 筛选参数使用中文值

- **生产管理页** (`production.ts`)
  - ✅ 导航链接传递中文分类参数

#### 2. **云函数修改**
- **物料管理云函数** (`production-material/index.js`)
  - ✅ 编码生成器支持中文分类映射
  - ✅ 数据库操作使用中文分类

- **仪表板云函数** (`production-dashboard/index.js`)
  - ✅ 统计分析使用中文分类
  - ✅ 分类详情映射英文key

---

## 🗂️ **新的分类体系**

| 中文分类 | 编码前缀 | 用途说明 |
|---------|----------|----------|
| 饲料 | F | 普通鹅料、玉米、豆粕等 |
| 营养品 | N | 维生素、营养补充剂、钙片等 |
| 药品 | M | 疫苗、抗生素、治疗药物等 |
| 设备 | E | 设备工具、机械等 |
| 耗材 | S | 日常耗材、包装材料等 |
| 其他 | O | 其他未分类物料 |

---

## 🔄 **数据库检查与迁移指导**

### 步骤1：检查现有数据
```javascript
// 在微信开发者工具 -> 云开发 -> 数据库 -> materials 中执行
db.collection('materials').get().then(res => {
  console.log('现有分类数据:', res.data.map(item => ({
    name: item.name,
    category: item.category
  })))
})
```

### 步骤2：数据迁移（如果需要）

#### 如果发现英文分类数据，执行迁移：
```javascript
// 在云开发控制台执行数据迁移
const categoryMapping = {
  'feed': '饲料',
  'nutrition': '营养品', 
  'medicine': '药品',
  'equipment': '设备',
  'supplies': '耗材',
  'other': '其他'
}

// 批量更新分类字段
for (let [oldCategory, newCategory] of Object.entries(categoryMapping)) {
  await db.collection('materials')
    .where({ category: oldCategory })
    .update({
      data: { category: newCategory }
    })
}
```

### 步骤3：验证数据一致性
```javascript
// 检查所有记录的分类
db.collection('materials').get().then(res => {
  const categories = [...new Set(res.data.map(item => item.category))]
  console.log('当前分类列表:', categories)
  
  // 应该只包含：['饲料', '营养品', '药品', '设备', '耗材', '其他']
})
```

---

## 🧪 **测试验证步骤**

### 1. **采购入库测试**
- [ ] 创建不同分类的物料
- [ ] 验证编码生成正确（F、N、M、E、S、O开头）
- [ ] 确认数据库存储中文分类

### 2. **健康记录测试**  
- [ ] 选择"药品治疗"，验证只显示"药品"分类物料
- [ ] 选择"营养支持"，验证只显示"营养品"分类物料
- [ ] 确认不会显示普通饲料

### 3. **库存管理测试**
- [ ] 从生产页面点击各分类库存链接
- [ ] 验证页面标题正确
- [ ] 确认筛选结果准确

---

## ⚠️ **注意事项**

### 1. **数据一致性**
- 确保所有模块都使用相同的中文分类值
- 定期检查数据库中是否有异常分类数据

### 2. **URL编码问题**
- 中文URL参数可能需要编码处理
- 如遇问题，考虑使用数字ID映射

### 3. **向后兼容**
- 如果有老数据使用英文分类，需要数据迁移
- 建议先备份数据库

---

## 🚀 **部署顺序**

1. **先部署云函数**
   ```bash
   # 上传云函数
   production-material
   production-dashboard
   ```

2. **再部署小程序**
   ```bash
   # 上传小程序代码
   # 确保前端和云函数版本一致
   ```

3. **执行数据迁移**（如需要）
   ```bash
   # 在云开发控制台执行迁移脚本
   ```

4. **验证功能**
   - 测试采购流程
   - 测试健康记录
   - 测试库存查看

---

## 📞 **问题排查**

### 如果健康记录显示"暂无药品库存"：
1. 检查数据库中是否有category为"药品"的物料
2. 确认物料的currentStock > 0
3. 检查云函数是否正确筛选

### 如果编码生成异常：
1. 确认云函数中的分类映射表正确
2. 检查传入的category参数格式

### 如果页面显示异常：
1. 检查URL参数是否正确传递
2. 确认前端分类判断逻辑一致

---

**总结**：系统现在完全使用中文分类体系，确保了数据的一致性和用户体验的统一性。
