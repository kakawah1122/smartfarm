# 🔥 终极解决方案 - 定时触发器（60秒限制）

## 🎯 问题确认

**微信云函数限制**：
- ❌ 超时时间最高只能：**60秒**
- ⚠️ GEMINI需要：**34秒**
- ⚠️ 加上处理时间：**40-50秒**
- ❌ 云函数调用链超时

**根本问题**：
```
ai-diagnosis → 触发 process-ai-diagnosis
                      ↓ (超时!)
                调用 ai-multi-model (需要40-50秒)
```

---

## ✅ 解决方案：定时触发器

**原理**：
- 不再由 `ai-diagnosis` 触发 `process-ai-diagnosis`
- 让 `process-ai-diagnosis` **每分钟自动运行**
- 自动扫描数据库中的待处理任务
- 完全避免云函数调用链超时

**工作流程**：
```
前端提交
  ↓
ai-diagnosis: 创建任务（2秒返回）✅
  ↓
数据库: 任务状态=processing
  ↓
定时触发器: 每分钟运行 process-ai-diagnosis
  ↓
自动扫描: 找到待处理任务
  ↓
调用 ai-multi-model → GEMINI (40秒)
  ↓
更新任务状态=completed ✅
  ↓
前端轮询: 获取结果 🎉
```

---

## 📋 操作步骤（3步完成）

### 第1步：上传修改后的云函数 ⭐

**在微信开发者工具中**：

```
1. 右键 cloudfunctions/process-ai-diagnosis
2. 选择 "上传并部署：云端安装依赖"
3. 等待完成（约30秒）
```

**修改内容**：
- ✅ 支持定时触发器模式
- ✅ 自动扫描数据库待处理任务
- ✅ 一次处理最多5个任务

---

### 第2步：配置定时触发器 ⏰

**打开云开发控制台**：
```
微信开发者工具 → 顶部菜单"云开发" → "云开发控制台"
或浏览器打开：https://console.cloud.tencent.com/tcb
```

**配置步骤**：

```
1. 左侧菜单：云函数
2. 点击：process-ai-diagnosis
3. 点击标签：触发器
4. 点击按钮：创建触发器
5. 填写配置：
   - 触发器名称: auto-process-diagnosis
   - 触发周期: 自定义触发周期
   - Cron表达式: 0 * * * * * *
     (表示每分钟第0秒触发)
   - 启用: 是
6. 点击：提交 ✅
```

**Cron表达式说明**：
```
0 * * * * * *
│ │ │ │ │ │ │
│ │ │ │ │ │ └─ 年（可选）
│ │ │ │ │ └─── 星期
│ │ │ │ └───── 月
│ │ │ └─────── 日
│ │ └───────── 时
│ └─────────── 分
└───────────── 秒

0 * * * * * * = 每分钟第0秒触发 = 每分钟一次
```

---

### 第3步：移除 ai-diagnosis 的触发逻辑 ✂️

**上传修改后的 ai-diagnosis**：

```
1. 右键 cloudfunctions/ai-diagnosis
2. 选择 "上传并部署：云端安装依赖"
3. 等待完成
```

**已移除内容**：
- ❌ 不再主动触发 process-ai-diagnosis
- ✅ 只创建任务到数据库
- ✅ 立即返回给前端

---

## 🎯 验证配置成功

### 1. 查看触发器配置

```
云开发控制台
→ 云函数
→ process-ai-diagnosis
→ 触发器标签
→ 看到：auto-process-diagnosis（已启用）✅
```

### 2. 测试诊断

```
1. 打开 AI诊断页面
2. 上传1张图片
3. 提交诊断
4. 等待 60-90秒（最多到下一个触发周期）
5. 看到诊断结果 ✅
```

### 3. 查看云函数日志

**process-ai-diagnosis 日志**（每分钟都会有）：
```
====== 模式2: 自动扫描待处理任务 ======
找到 1 个待处理任务
----- 处理任务: xxx -----
任务状态: processing
调用 ai-multi-model
诊断任务处理成功: xxx
处理完成: 成功 1/1
```

**如果没有待处理任务**：
```
====== 模式2: 自动扫描待处理任务 ======
找到 0 个待处理任务
没有待处理任务
```

---

## 📊 方案对比

### 旧方案（超时）

```
前端 → ai-diagnosis → 触发 process-ai-diagnosis
                              ↓ (60秒超时❌)
                        调用 ai-multi-model
```

**问题**：
- ❌ 触发超时（16秒）
- ❌ 任务被标记失败
- ❌ 用户看到错误

### 新方案（定时触发）

```
前端 → ai-diagnosis → 创建任务（2秒返回✅）
           ↓
       数据库: status=processing
           ↓
   (等待最多60秒)
           ↓
定时触发: 每分钟自动运行
           ↓
扫描并处理任务 (40秒完成✅)
           ↓
更新状态: status=completed
           ↓
前端轮询: 获取结果 🎉
```

**优势**：
- ✅ 无云函数调用链
- ✅ 无超时问题
- ✅ 自动批量处理
- ✅ 高可靠性

---

## ⏰ 时间线分析

### 最快情况（刚好赶上触发）

```
00秒: 提交诊断
02秒: 创建任务，前端开始轮询
05秒: 定时触发器执行（每分钟第5秒）
10秒: 开始调用 GEMINI
44秒: GEMINI返回
45秒: 更新任务状态为completed
46秒: 前端轮询到结果 ✅

总耗时: 46秒
```

### 最慢情况（刚错过触发）

```
00秒: 提交诊断
02秒: 创建任务
05秒: 错过触发器（刚执行完）
65秒: 下一次触发器执行
70秒: 开始调用 GEMINI
104秒: GEMINI返回
105秒: 更新任务状态
106秒: 前端轮询到结果 ✅

总耗时: 106秒（约2分钟）
```

### 平均情况

```
平均等待触发: 30秒
处理时间: 40秒
总耗时: 约70秒
```

---

## 🔧 高级配置

### 如果想要更快响应

**改为每30秒触发一次**：
```
Cron表达式: 0,30 * * * * * *
            ↑
            在第0秒和第30秒触发
```

**平均等待时间**：
- 每分钟触发：平均等待30秒
- 每30秒触发：平均等待15秒

---

## ⚠️ 注意事项

### 1. 触发器费用

定时触发器会持续运行：
- 每分钟触发1次
- 即使没有任务也会运行
- 每次运行约0.5秒（无任务时）
- 每月约 43200 次调用（30天）

**费用估算**：
- 无任务时：0.5秒 × 43200次 = 6小时
- 有任务时：40秒 × 每天10次 = 约400秒/天
- **总计**：每月约10小时云函数时长

**建议**：
- 使用量不大，费用很低
- 免费额度应该足够

### 2. 任务时效性

只处理10分钟内创建的任务：
```javascript
createdAt: db.command.gte(new Date(Date.now() - 10 * 60 * 1000))
```

超过10分钟的任务会被忽略（需要手动重试）。

### 3. 并发处理

一次最多处理5个任务：
```javascript
.limit(5)
```

如果有大量任务，会分批处理。

---

## 🆘 常见问题

### Q1: 找不到"触发器"标签？

**解决**：
```
1. 确保在云函数详情页（不是列表页）
2. 看顶部标签页：函数代码、函数配置、触发器、日志
3. 点击"触发器"
```

### Q2: Cron表达式怎么填？

**常用表达式**：
```
每分钟:  0 * * * * * *
每30秒:  0,30 * * * * *
每2分钟: 0 */2 * * * * *
每5分钟: 0 */5 * * * * *
```

### Q3: 触发器创建失败？

**可能原因**：
1. 云函数未上传成功
2. 权限不足
3. Cron表达式格式错误

**解决**：
1. 重新上传云函数
2. 检查表达式格式
3. 使用预设的 "每分钟"

### Q4: 任务还是失败？

**排查步骤**：
1. 查看 process-ai-diagnosis 日志
   - 是否每分钟都有日志？
   - 是否找到了待处理任务？
   - 调用 ai-multi-model 是否成功？
   
2. 查看 ai-multi-model 日志
   - 是否成功调用 GEMINI？
   - 执行时间是多少？

3. 查看数据库
   - 任务状态是什么？
   - 是否有错误信息？

---

## ✨ 预期效果

**配置完成后**：

```
✅ 提交诊断 → 立即返回（2秒）
✅ 等待60-90秒（平均70秒）
✅ 自动处理完成
✅ 前端显示结果
✅ 成功率 95%+
```

**日志确认**：
```
每分钟都能看到 process-ai-diagnosis 日志
有任务时自动处理
无任务时记录"没有待处理任务"
```

---

## 🎊 完成清单

- [ ] 上传 process-ai-diagnosis 云函数
- [ ] 上传 ai-diagnosis 云函数
- [ ] 配置定时触发器（每分钟）
- [ ] 测试提交诊断
- [ ] 等待60-90秒
- [ ] 查看结果 ✅

---

**现在就开始配置定时触发器！** 🚀

这是在60秒限制下的最佳方案，稳定可靠！

