# AI诊断修复 - 部署清单

## 🎯 问题总结
1. ❌ 批次提示词数据获取失败（使用了错误的数据库集合名）
2. ❌ AI诊断返回400错误（没有传递图片参数）
3. ✅ 症状标签交互优化（前端已完成）

---

## 📦 部署清单

### ✅ 步骤 1: 部署 health-management 云函数

**修复内容：** 修复批次数据查询的集合名称错误

**操作步骤：**
1. 打开微信开发者工具
2. 找到左侧文件树中的 `cloudfunctions/health-management`
3. 右键点击 `health-management` 文件夹
4. 选择 **"上传并部署：云端安装依赖"**
5. 等待上传完成（约1-2分钟）
6. 看到"上传成功"提示

**验证：**
```javascript
// 控制台不应再出现此错误：
// "获取批次提示词数据失败: document.get:fail document with _id xxx does not exist"
```

---

### ✅ 步骤 2: 部署 ai-diagnosis 云函数

**修复内容：** 添加图片参数传递

**操作步骤：**
1. 找到 `cloudfunctions/ai-diagnosis`
2. 右键点击 `ai-diagnosis` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待上传完成（约1-2分钟）
5. 看到"上传成功"提示

**验证：**
```javascript
// AI诊断应该能正常完成，不再返回 400 错误
```

---

### ✅ 步骤 3: 重新编译小程序

**修复内容：** 症状标签交互优化

**操作步骤：**
1. 在微信开发者工具顶部工具栏
2. 点击 **"编译"** 按钮（或按 Ctrl+B / Cmd+B）
3. 等待编译完成

**验证：**
```javascript
// 症状标签点击后应该能正常填充和取消
```

---

## 🧪 测试流程

### 测试 1: 无图片诊断（基础功能）

1. 进入"AI智能诊断"页面
2. 选择批次（如：QY-20251022）
3. 输入受影响数量：2
4. 点击症状标签：发热、咳嗽、腹泻
5. 查看文本框是否自动填充："发热、咳嗽、腹泻"
6. 再次点击"发热"标签，文本框应变为："咳嗽、腹泻"
7. 点击"开始AI智能诊断"
8. 等待20-30秒
9. ✅ 应该显示诊断结果

**期望结果：**
- ✅ 无 "获取批次提示词数据失败" 错误
- ✅ 诊断成功完成
- ✅ 显示主要诊断、鉴别诊断、治疗建议等

---

### 测试 2: 带图片诊断（完整功能）

1. 进入"AI智能诊断"页面
2. 选择批次
3. 输入症状（使用标签或手动输入）
4. 点击"拍摄症状照片"上传1-2张图片
5. 点击"开始AI智能诊断"
6. 等待20-30秒
7. ✅ 应该显示诊断结果（基于症状+图片）

**期望结果：**
- ✅ 图片上传成功
- ✅ 诊断成功完成
- ✅ AI分析了图片内容（在诊断推理中可能提到图片特征）

---

### 测试 3: 死因剖析（带图片）

1. 切换诊断类型为"死因剖析"
2. 选择批次
3. 输入死亡数量：1
4. 点击异常标签：肝脏颜色发黑、肠道发红
5. 上传剖检照片（2-4张）
6. 点击"开始AI死因分析"
7. 等待20-30秒
8. ✅ 应该显示死因分析结果

**期望结果：**
- ✅ 无错误
- ✅ 显示主要死因、病理发现、预防建议等

---

## 🐛 故障排查

### 问题 1: 仍然提示"获取批次提示词数据失败"

**可能原因：**
- health-management 云函数没有部署成功
- 缓存未清除

**解决方案：**
1. 重新部署 health-management 云函数
2. 在云开发控制台查看云函数日志
3. 清除小程序缓存后重试

---

### 问题 2: 仍然返回 400 错误

**可能原因：**
- ai-diagnosis 云函数没有部署成功
- 通义千问 API Key 未配置
- 图片太大（超过5MB）

**解决方案：**
1. 检查 ai-multi-model 云函数的环境变量：
   - `QWEN_API_KEY` 是否配置
2. 检查图片大小（小程序会自动压缩到1024x1024）
3. 查看云函数日志，确认具体错误

---

### 问题 3: 症状标签点击无反应

**可能原因：**
- 小程序没有重新编译
- 浏览器缓存

**解决方案：**
1. 点击微信开发者工具的"清除缓存" → "清除数据缓存"
2. 重新编译小程序
3. 刷新模拟器

---

## 📊 云函数日志查看

### 在微信开发者工具中查看

1. 点击左侧"云开发"按钮
2. 选择"云函数"
3. 点击对应云函数（如 health-management）
4. 选择"日志"标签
5. 查看最近的调用日志

### 关键日志标识

**成功标识：**
```
✅ 通义千问调用成功
✅ 诊断任务已创建
✅ 图片处理完成
```

**错误标识：**
```
❌ 批次不存在或已删除
❌ 通义千问调用失败
❌ 图片处理失败
Request failed with status code 400
```

---

## ✨ 预期效果

修复后，AI诊断功能应该：
- ✅ 能正确获取批次历史数据，提供更准确的诊断上下文
- ✅ 支持图片诊断（通义千问视觉模型）
- ✅ 症状标签支持点击选中/取消
- ✅ 无 400 错误
- ✅ 诊断速度：20-30秒

---

## 🎉 部署完成后

1. 通知用户可以测试AI诊断功能
2. 收集用户反馈
3. 持续监控云函数日志
4. 如有新问题，记录并修复

---

**部署负责人：** _________  
**部署时间：** 2025-10-26  
**预计耗时：** 5-10分钟  
**风险等级：** 🟢 低（仅修复bug，不影响其他功能）

