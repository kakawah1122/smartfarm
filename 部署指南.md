# 鹅数通项目部署指南

**更新时间**: 2025年10月21日  
**版本**: v1.0

---

## 一、部署前准备

### 1.1 Git 提交

#### 已修改但未提交的文件
```bash
# 查看修改状态
git status

# 应该看到以下文件：
# modified:   cloudfunctions/health-management/index.js
# modified:   cloudfunctions/production-entry/index.js
# modified:   cloudfunctions/breeding-todo/index.js
# modified:   cloudfunctions/user-management/index.js
# modified:   cloudfunctions/ai-diagnosis/index.js
# modified:   miniprogram/pages/weather-detail/weather-detail.ts
# modified:   miniprogram/pages/profile/profile.ts
# modified:   miniprogram/pages/invite-management/invite-management.ts
```

#### 新增的文档文件
```bash
# 未跟踪的文档
# HEALTH_EXIT_FILTER_FIX.md
# HEALTH_PAGE_OPTIMIZATION.md
# IMPLEMENTATION_SUMMARY.md
# URGENT_FIX_INSTRUCTIONS.md
# 项目审查报告.md
# 部署指南.md
# cloudfunctions/debug-health-batches/
```

#### 提交步骤

**1. 添加所有改动**
```bash
# 添加已修改的文件
git add cloudfunctions/health-management/index.js
git add cloudfunctions/production-entry/index.js
git add cloudfunctions/breeding-todo/index.js
git add cloudfunctions/user-management/index.js
git add cloudfunctions/ai-diagnosis/index.js
git add miniprogram/pages/weather-detail/weather-detail.ts
git add miniprogram/pages/profile/profile.ts
git add miniprogram/pages/invite-management/invite-management.ts

# 添加文档文件
git add HEALTH_EXIT_FILTER_FIX.md
git add HEALTH_PAGE_OPTIMIZATION.md
git add IMPLEMENTATION_SUMMARY.md
git add URGENT_FIX_INSTRUCTIONS.md
git add 项目审查报告.md
git add 部署指南.md
git add 测试清单.md

# 添加调试云函数（可选）
git add cloudfunctions/debug-health-batches/
```

**2. 提交改动**
```bash
git commit -m "代码清理和优化

- 清理所有 console.log 调试日志（前端11处，云函数10处）
- 删除临时备份文件（4个）
- 修复 currentBatchId undefined 错误
- 优化出栏批次过滤逻辑
- 完善健康管理流转逻辑
- 添加项目审查报告和部署文档"
```

**3. 推送到远程仓库（如果需要）**
```bash
git push origin main
```

---

## 二、云函数部署

### 2.1 必须部署的云函数（按优先级）

#### 🔴 高优先级

**1. production-entry**
- **修复内容**: currentBatchId undefined 错误
- **修改说明**: 
  - 字段名从 `id` 改为 `_id`
  - 添加 `quantity` 字段
  - 清理调试日志
- **影响**: 修复健康页面批次加载失败问题

**部署步骤**:
```
1. 打开微信开发者工具
2. 右键点击 cloudfunctions/production-entry 文件夹
3. 选择 "上传并部署：云端安装依赖"
4. 等待部署完成（约 30 秒）
5. 查看云开发控制台确认部署成功
```

---

**2. health-management**
- **修复内容**: 出栏批次过滤逻辑优化
- **修改说明**:
  - 跨集合查询出栏记录
  - 计算累计出栏数量
  - 过滤完全出栏的批次
  - 清理调试日志
- **影响**: 修复已出栏批次仍显示在健康页的问题

**部署步骤**:
```
1. 右键点击 cloudfunctions/health-management 文件夹
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成
4. 验证出栏过滤功能
```

---

**3. breeding-todo**
- **新增功能**: 任务完成自动创建健康记录
- **修改说明**:
  - 疫苗任务完成时自动创建健康记录
  - 记录关联任务ID
  - 设置7天后跟进提醒
  - 清理调试日志
- **影响**: 完善数据流转闭环

**部署步骤**:
```
1. 右键点击 cloudfunctions/breeding-todo 文件夹
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成
4. 测试疫苗任务完成流程
```

---

#### 🟡 中优先级

**4. user-management**
- **修改内容**: 清理调试日志
- **影响**: 无功能变化，代码清理

**5. ai-diagnosis**
- **修改内容**: 清理调试日志
- **影响**: 无功能变化，代码清理

**部署步骤**（可选）:
```
1. 右键点击对应云函数文件夹
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成
```

---

### 2.2 云函数部署验证

#### 方法一：云开发控制台验证
```
1. 打开云开发控制台
   https://console.cloud.tencent.com/tcb
   
2. 进入 "云函数" 管理页面

3. 检查以下云函数的 "最近部署时间"：
   - production-entry
   - health-management
   - breeding-todo
   
4. 如果时间是最新的（刚才部署的），说明部署成功
```

#### 方法二：云函数测试验证
```
1. 在云开发控制台，点击云函数名称

2. 点击 "测试" 标签

3. 输入测试数据并执行测试
   
   例如测试 production-entry:
   {
     "action": "getActiveBatches"
   }
   
4. 查看返回结果：
   - 应该返回 success: true
   - 批次数据字段应该是 _id（不是 id）
   - 应该包含 quantity 字段
```

#### 方法三：小程序端验证
```
1. 清除小程序缓存
   工具 → 清除缓存 → 清除全部缓存
   
2. 重新编译运行小程序

3. 打开健康管理页面
   - 应该能正常加载批次列表
   - 不应该出现 "currentBatchId undefined" 错误
   
4. 检查出栏批次过滤
   - 已完全出栏的批次不应该显示
   
5. 测试疫苗任务完成
   - 完成疫苗任务后应该自动创建健康记录
```

---

### 2.3 部署注意事项

⚠️ **重要提示**:

1. **部署顺序**: 建议按优先级顺序部署
   - 先部署 production-entry（修复关键bug）
   - 再部署 health-management（修复过滤问题）
   - 最后部署 breeding-todo（新增功能）

2. **清除缓存**: 部署后必须清除小程序缓存
   ```
   工具 → 清除缓存 → 清除全部缓存
   关闭并重新打开微信开发者工具
   ```

3. **等待部署完成**: 不要在部署过程中测试
   - 云函数部署需要 30-60 秒
   - 等待控制台显示 "部署成功"

4. **网络环境**: 确保网络稳定
   - 云函数部署需要上传文件
   - 不稳定的网络可能导致部署失败

5. **依赖安装**: 使用 "云端安装依赖"
   - 确保云端环境与本地一致
   - 避免依赖版本不匹配问题

---

### 2.4 部署失败排查

#### 问题1：部署超时
**现象**: 部署过程超过5分钟未完成

**解决方案**:
```
1. 检查网络连接
2. 重新上传部署
3. 如果多次失败，使用 "不重新安装依赖" 选项
```

#### 问题2：云函数运行错误
**现象**: 部署成功但调用失败

**解决方案**:
```
1. 查看云函数日志
   云开发控制台 → 云函数 → 日志
   
2. 检查错误信息
   - 如果是依赖问题，重新部署并安装依赖
   - 如果是代码错误，检查代码并修复
   
3. 使用云函数测试功能验证
```

#### 问题3：权限问题
**现象**: 提示无权限上传云函数

**解决方案**:
```
1. 检查云开发环境配置
   project.config.json 中的 cloudfunctionRoot
   
2. 检查微信开发者账号权限
   确保有开发者权限
   
3. 重新登录微信开发者工具
```

---

## 三、小程序代码上传

### 3.1 上传前检查

✅ **检查清单**:
- [ ] 所有云函数已部署
- [ ] 本地代码已编译无错误
- [ ] 已清除缓存
- [ ] 已完成基本功能测试
- [ ] 版本号已更新（project.config.json）

### 3.2 上传步骤

**1. 更新版本号**
```json
// project.config.json
{
  "version": "1.0.1",  // 更新版本号
  "description": "修复批次加载和出栏过滤问题，优化代码质量"
}
```

**2. 上传代码**
```
1. 点击微信开发者工具右上角 "上传"
2. 填写版本号：1.0.1
3. 填写项目备注：
   "修复 currentBatchId undefined 错误
    优化出栏批次过滤逻辑
    清理调试代码，提升代码质量"
4. 点击 "上传"
5. 等待上传完成
```

**3. 提交审核（可选）**
```
1. 登录微信公众平台
   https://mp.weixin.qq.com/
   
2. 进入 "版本管理"
   
3. 选择刚上传的版本
   
4. 点击 "提交审核"
   
5. 填写审核信息
   - 测试账号
   - 功能说明
   - 隐私政策链接
   
6. 提交审核
```

---

## 四、部署后验证

### 4.1 基础功能验证

**1. 批次加载**
```
测试步骤：
1. 打开健康管理页面
2. 检查批次列表是否正常加载
3. 点击批次筛选按钮
4. 验证批次列表显示正确

预期结果：
✅ 批次列表正常显示
✅ 不出现 "currentBatchId undefined" 错误
✅ 批次筛选功能正常
```

**2. 出栏过滤**
```
测试步骤：
1. 创建一个测试批次（入栏1000只）
2. 完全出栏该批次（出栏1000只）
3. 刷新健康管理页面
4. 检查该批次是否仍显示

预期结果：
✅ 完全出栏的批次不显示
✅ 部分出栏的批次仍显示
✅ 未出栏的批次正常显示
```

**3. 任务健康记录联动**
```
测试步骤：
1. 打开养殖任务页面
2. 完成一个疫苗任务
3. 打开健康管理页面
4. 查看是否自动创建了健康记录

预期结果：
✅ 自动创建疫苗接种健康记录
✅ 记录包含疫苗信息
✅ 记录关联了任务ID
✅ 设置了7天后跟进提醒
```

### 4.2 完整流程验证

**入栏 → 任务 → 健康 → 出栏 流程**
```
1. 创建入栏记录
   ✅ 批次创建成功
   ✅ 自动生成待办任务
   ✅ 自动创建初始健康检查记录

2. 完成疫苗任务
   ✅ 任务标记为完成
   ✅ 自动创建疫苗健康记录

3. 查看健康数据
   ✅ 健康记录显示正确
   ✅ 批次健康状态更新

4. 创建出栏记录
   ✅ 出栏数量扣减
   ✅ 存栏数量更新
   ✅ 完全出栏后批次不再显示
```

### 4.3 性能验证

**页面加载性能**
```
测试指标：
- 首页加载时间 < 2秒 ✅
- 健康页面加载 < 2秒 ✅
- 任务页面加载 < 2秒 ✅
- 云函数响应 < 1秒 ✅
```

### 4.4 兼容性验证

**设备兼容性**
```
测试设备：
- iOS 微信客户端 ✅
- Android 微信客户端 ✅
- 不同屏幕尺寸（iPhone、iPad、Android）✅
```

---

## 五、回滚方案

### 5.1 云函数回滚

**如果部署后出现问题，可以回滚到上一个版本**

#### 方法一：云开发控制台回滚
```
1. 打开云开发控制台
2. 进入 "云函数" 管理页面
3. 点击问题云函数名称
4. 点击 "版本管理"
5. 选择上一个稳定版本
6. 点击 "回滚"
```

#### 方法二：重新部署旧版本
```
1. 使用 Git 回退代码
   git log --oneline  # 查看提交历史
   git checkout <commit-hash>  # 切换到旧版本
   
2. 重新部署云函数
   右键云函数 → 上传并部署
   
3. 验证功能正常

4. 切回主分支
   git checkout main
```

### 5.2 小程序代码回滚

**如果上传的代码有问题**

```
1. 登录微信公众平台
2. 进入 "版本管理"
3. 选择上一个稳定版本
4. 点击 "设为体验版" 或 "提交审核"
```

---

## 六、部署检查清单

### 6.1 部署前
- [x] 代码已清理（无 console.log）
- [x] 临时文件已删除
- [ ] Git 已提交
- [ ] 版本号已更新
- [ ] 本地测试通过

### 6.2 部署中
- [ ] production-entry 已部署
- [ ] health-management 已部署
- [ ] breeding-todo 已部署
- [ ] 云函数测试通过
- [ ] 缓存已清除

### 6.3 部署后
- [ ] 批次加载测试通过
- [ ] 出栏过滤测试通过
- [ ] 任务联动测试通过
- [ ] 完整流程测试通过
- [ ] 性能测试通过
- [ ] 兼容性测试通过

---

## 七、常见问题 FAQ

### Q1: 部署后小程序仍然报错 "currentBatchId undefined"
**A**: 
1. 确认云函数已成功部署（检查部署时间）
2. 清除小程序缓存（工具 → 清除缓存）
3. 关闭并重新打开微信开发者工具
4. 重新编译运行

### Q2: 出栏批次仍然显示在健康页面
**A**:
1. 确认 health-management 云函数已部署
2. 检查出栏记录的数量是否正确
3. 刷新健康页面（下拉刷新）
4. 查看云函数日志排查问题

### Q3: 疫苗任务完成后没有创建健康记录
**A**:
1. 确认 breeding-todo 云函数已部署
2. 检查云函数日志是否有错误
3. 验证 health_records 集合权限设置
4. 重新完成一次疫苗任务测试

### Q4: 云函数部署失败
**A**:
1. 检查网络连接
2. 检查云开发环境配置
3. 尝试 "不重新安装依赖" 选项
4. 查看开发者工具控制台错误信息

### Q5: 小程序审核不通过
**A**:
1. 仔细阅读审核反馈
2. 根据反馈修改问题
3. 完善隐私政策和用户协议
4. 提供完整的测试账号和说明

---

## 八、联系支持

### 技术支持
- **微信云开发文档**: https://developers.weixin.qq.com/miniprogram/dev/wxcloud/
- **TDesign 文档**: https://tdesign.tencent.com/miniprogram/
- **项目仓库**: (填写您的 Git 仓库地址)

### 部署记录
- **首次部署**: 2025年10月21日
- **当前版本**: v1.0.1
- **部署人员**: (填写部署人员)

---

**最后更新**: 2025年10月21日  
**文档版本**: v1.0

