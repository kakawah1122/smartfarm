# 需求文档

## 简介

本项目旨在对鹅数通微信小程序进行全面的合规审查和性能优化。主要目标包括：解决开发者工具卡死问题、优化健康页面加载性能、清理冗余代码和样式、确保符合微信小程序规范、TDesign组件规范、云开发最佳实践以及项目开发规范。

**核心原则**：
- **非破坏性优化**：所有优化必须保持现有功能完整性
- **UI一致性**：不改变前端UI界面的视觉效果和交互逻辑
- **功能优先**：在保证功能完整实现的前提下进行优化
- **最优路径**：在不破坏功能的前提下，寻找性能和代码质量的最优解决方案

## 术语表

- **优化系统**：执行代码审查、性能分析和优化建议的整体系统
- **开发者工具**：微信小程序开发者工具
- **健康页面**：小程序中的健康管理相关页面（health.ts/wxml/scss）
- **主包**：微信小程序的主包，大小限制为2MB
- **分包**：微信小程序的分包，主包+分包总大小限制为20-30MB
- **TDesign组件**：腾讯开源的小程序UI组件库
- **云函数**：微信云开发的服务端函数
- **数据库集合**：微信云开发的数据库表
- **项目规范**：项目开发规范.md中定义的开发标准
- **非破坏性优化**：在不改变现有功能和UI的前提下进行的代码优化
- **功能完整性**：确保所有用户可见的功能和交互保持原有行为

## 需求

### 需求 1：代码规范合规审查

**用户故事：** 作为开发者，我想要确保代码符合项目开发规范，以便提高代码质量和可维护性

#### 验收标准

1. 当优化系统扫描代码文件时，优化系统应检查所有文件命名是否使用kebab-case格式
2. 当优化系统检查组件时，优化系统应验证详情弹窗组件是否遵循`[module]-record-detail-popup`命名规范
3. 当优化系统分析样式文件时，优化系统应识别所有内联样式（style属性）并标记为违规
4. 当优化系统检查样式文件时，优化系统应识别不合理的!important使用（非详情弹窗组件或非覆盖TDesign组件的场景）
5. 当优化系统完成代码规范审查后，优化系统应生成包含所有违规项和修复建议的报告

### 需求 2：微信小程序规范合规审查

**用户故事：** 作为开发者，我想要确保小程序符合微信官方规范，以便顺利通过审核和上线

#### 验收标准

1. 当优化系统检查主包大小时，优化系统应计算主包实际大小并与2MB限制进行对比
2. 当优化系统检查分包配置时，优化系统应验证app.json中的subPackages配置是否正确
3. 当优化系统检查tabBar页面时，优化系统应确认所有tabBar页面都位于主包中
4. 当优化系统检查分包引用时，优化系统应识别分包之间的直接互相引用并标记为违规
5. 当主包大小超过2MB时，优化系统应提供分包拆分建议

### 需求 3：TDesign组件规范审查

**用户故事：** 作为开发者，我想要确保TDesign组件使用符合规范，以便保持UI一致性和组件升级兼容性

#### 验收标准

1. 当优化系统检查组件配置时，优化系统应验证所有TDesign组件都在usingComponents中正确声明
2. 当优化系统检查WXML文件时，优化系统应识别未在json中注册但在wxml中使用的TDesign组件
3. 当优化系统检查样式覆盖时，优化系统应验证是否优先使用t-class等外部样式类
4. 当优化系统发现直接修改TDesign组件内部结构时，优化系统应标记为违规并建议使用插槽或受控属性
5. 当优化系统完成TDesign审查后，优化系统应生成组件使用规范性报告

### 需求 4：云开发最佳实践审查

**用户故事：** 作为开发者，我想要确保云函数和数据库使用符合最佳实践，以便提高性能和安全性

#### 验收标准

1. 当优化系统检查云函数时，优化系统应验证每个云函数是否遵循单一职责原则
2. 当优化系统检查数据库查询时，优化系统应识别缺少索引的频繁查询字段
3. 当优化系统检查权限校验时，优化系统应确认所有云函数调用都包含权限验证逻辑
4. 当优化系统检查前端调用时，优化系统应验证是否统一使用CloudApi.callFunction封装
5. 当优化系统发现数据库文档过大时，优化系统应建议字段扁平化或拆分集合

### 需求 5：冗余代码和样式清理

**用户故事：** 作为开发者，我想要清理项目中的冗余代码和样式，以便减小包体积和提高可维护性

#### 验收标准

1. 当优化系统扫描样式文件时，优化系统应识别所有未被引用的CSS类
2. 当优化系统检查组件时，优化系统应识别重复的UI代码（在2个或以上位置出现）
3. 当优化系统检查文件系统时，优化系统应识别所有"冲突副本"文件并标记为待删除
4. 当优化系统检查导入语句时，优化系统应识别未使用的import和require
5. 当优化系统完成清理分析后，优化系统应生成可安全删除的文件和代码列表

### 需求 6：健康页面性能优化

**用户故事：** 作为开发者，我想要优化健康页面的加载性能，以便提升用户体验

#### 验收标准

1. 当优化系统分析健康页面时，优化系统应识别所有阻塞渲染的同步操作
2. 当优化系统检查数据加载时，优化系统应识别可以延迟加载或按需加载的数据
3. 当优化系统检查setData调用时，优化系统应识别频繁的setData调用并建议合并
4. 当优化系统检查列表渲染时，优化系统应验证是否使用了虚拟列表或分页加载
5. 当优化系统完成性能分析后，优化系统应提供具体的优化建议和预期性能提升

### 需求 7：开发者工具卡死问题诊断

**用户故事：** 作为开发者，我想要找出导致开发者工具卡死的原因，以便解决这个问题

#### 验收标准

1. 当优化系统检查页面复杂度时，优化系统应计算WXML节点数量并与推荐值（<1000）对比
2. 当优化系统检查数据绑定时，优化系统应识别过深的数据嵌套（>5层）
3. 当优化系统检查事件监听时，优化系统应识别过多的事件监听器（>100个）
4. 当优化系统检查图片资源时，优化系统应识别未压缩的大图片（>500KB）
5. 当优化系统完成诊断后，优化系统应提供导致卡死的可能原因和解决方案

### 需求 8：数据流转和页面跳转审查

**用户故事：** 作为开发者，我想要确保数据流转和页面跳转逻辑清晰合理，以便避免数据不一致和跳转错误

#### 验收标准

1. 当优化系统检查页面跳转时，优化系统应验证所有navigateTo的目标页面是否存在于app.json中
2. 当优化系统检查数据传递时，优化系统应识别跨页面传递的未验证数据
3. 当优化系统检查返回逻辑时，优化系统应验证是否正确同步globalData.needSyncHomepage
4. 当优化系统检查分包跳转时，优化系统应验证tabBar页面是否使用switchTab而非navigateTo
5. 当优化系统发现无效的页面跳转时，优化系统应标记为待清理代码

### 需求 9：生成优化计划

**用户故事：** 作为开发者，我想要获得一个全面的优化计划，以便按优先级逐步实施优化

#### 验收标准

1. 当优化系统完成所有审查后，优化系统应生成按优先级排序的优化任务列表
2. 优化系统应为每个优化任务提供详细的问题描述、影响范围和修复建议
3. 优化系统应将优化任务分类为：紧急（影响功能）、重要（影响性能）、一般（代码质量）
4. 优化系统应为每个优化任务估算工作量（小时）和预期收益
5. 当生成优化计划后，优化系统应输出为Markdown格式的文档

### 需求 10：功能完整性保护

**用户故事：** 作为开发者，我想要确保所有优化不会破坏现有功能，以便保持用户体验的连续性

#### 验收标准

1. 当优化系统提出代码修改建议时，优化系统应分析该修改对现有功能的影响范围
2. 当优化系统识别可删除的代码时，优化系统应验证该代码是否被其他模块引用
3. 当优化系统建议重构UI组件时，优化系统应确认重构后的视觉效果和交互逻辑与原有完全一致
4. 如果优化可能影响功能，则优化系统应标记为"需人工确认"并提供详细的影响分析
5. 当优化系统生成优化计划时，优化系统应将所有修改分类为"安全修改"和"需确认修改"

### 需求 11：优化效果验证

**用户故事：** 作为开发者，我想要验证优化效果，以便确认优化是否达到预期目标且未破坏功能

#### 验收标准

1. 当优化系统执行性能测试时，优化系统应记录优化前的关键性能指标（页面加载时间、首屏渲染时间）
2. 当优化完成后，优化系统应重新测量相同的性能指标
3. 优化系统应计算性能提升百分比并与预期目标对比
4. 当优化系统检查包体积时，优化系统应对比优化前后的主包和分包大小
5. 当所有验证完成后，优化系统应生成包含功能完整性检查和性能提升的综合报告
