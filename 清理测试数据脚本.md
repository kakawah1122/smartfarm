# 🧹 清理测试数据脚本

## 🚨 **发现的问题：**
- 残留测试数据：`物料名称`、异常日期等
- 库存为0的无效物料
- 未来日期：`2025-09-04`

---

## 🛠️ **立即执行清理：**

### 第一步：查看当前所有数据
```javascript
// 在微信开发者工具控制台执行
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_materials' }
}).then(res => {
  console.log('当前物料数据:', res.result.data.materials)
  res.result.data.materials.forEach((material, index) => {
    console.log(`${index + 1}. ${material.name} - ${material.currentStock}${material.unit} - ${material.createTime}`)
  })
})
```

### 第二步：删除异常物料
```javascript
// 删除名为"物料名称"的测试物料
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_materials' }
}).then(res => {
  const materials = res.result.data.materials
  
  // 找到需要删除的物料
  const toDelete = materials.filter(material => 
    material.name === '物料名称' || 
    material.name.includes('测试') ||
    material.currentStock === 0 ||
    !material.supplier ||
    material.supplier === '未知供应商'
  )
  
  console.log('需要删除的物料:', toDelete)
  
  // 逐个删除
  toDelete.forEach(material => {
    wx.cloud.callFunction({
      name: 'production-material',
      data: {
        action: 'delete_material',
        materialId: material._id
      }
    }).then(result => {
      if (result.result.success) {
        console.log('✅ 删除成功:', material.name)
      } else {
        console.log('❌ 删除失败:', material.name, result.result.error)
      }
    })
  })
})
```

### 第三步：清理所有记录
```javascript
// 清理物料记录
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_records' }
}).then(res => {
  console.log('当前记录数量:', res.result.data.records.length)
  
  // 如果要清理所有记录，可以逐个删除
  res.result.data.records.forEach(record => {
    wx.cloud.callFunction({
      name: 'production-material',
      data: {
        action: 'delete_record',
        recordId: record._id
      }
    }).then(() => {
      console.log('记录删除完成:', record.recordNumber)
    })
  })
})
```

### 第四步：验证清理结果
```javascript
// 检查清理后的数据
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_materials' }
}).then(res => {
  console.log('清理后的物料数量:', res.result.data.materials.length)
  console.log('清理后的物料:', res.result.data.materials)
})

wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_records' }
}).then(res => {
  console.log('清理后的记录数量:', res.result.data.records.length)
})
```

---

## 🎯 **一键完全清理脚本：**

```javascript
// ⚠️ 警告：这会删除所有物料和记录数据！
async function cleanAllData() {
  console.log('🧹 开始清理所有数据...')
  
  try {
    // 1. 获取所有物料
    const materialsResult = await wx.cloud.callFunction({
      name: 'production-material',
      data: { action: 'list_materials' }
    })
    
    const materials = materialsResult.result.data.materials
    console.log(`📦 找到 ${materials.length} 个物料`)
    
    // 2. 获取所有记录
    const recordsResult = await wx.cloud.callFunction({
      name: 'production-material',
      data: { action: 'list_records' }
    })
    
    const records = recordsResult.result.data.records
    console.log(`📝 找到 ${records.length} 条记录`)
    
    // 3. 删除所有记录
    for (const record of records) {
      try {
        await wx.cloud.callFunction({
          name: 'production-material',
          data: {
            action: 'delete_record',
            recordId: record._id
          }
        })
        console.log(`✅ 删除记录: ${record.recordNumber}`)
      } catch (error) {
        console.log(`❌ 删除记录失败: ${record.recordNumber}`, error)
      }
    }
    
    // 4. 删除所有物料（先清空库存再删除）
    for (const material of materials) {
      try {
        // 先清空库存
        await wx.cloud.callFunction({
          name: 'production-material',
          data: {
            action: 'update_material',
            materialId: material._id,
            updateData: { currentStock: 0 }
          }
        })
        
        // 再删除物料
        await wx.cloud.callFunction({
          name: 'production-material',
          data: {
            action: 'delete_material',
            materialId: material._id
          }
        })
        console.log(`✅ 删除物料: ${material.name}`)
      } catch (error) {
        console.log(`❌ 删除物料失败: ${material.name}`, error)
      }
    }
    
    console.log('🎉 数据清理完成！')
    
    // 5. 验证清理结果
    const finalCheck = await wx.cloud.callFunction({
      name: 'production-material',
      data: { action: 'list_materials' }
    })
    
    console.log(`📊 清理后剩余物料: ${finalCheck.result.data.materials.length} 个`)
    
  } catch (error) {
    console.error('❌ 清理过程出错:', error)
  }
}

// 执行清理（请确认后再运行）
// cleanAllData()
```

---

## ⚡ **快速清理（推荐）：**

```javascript
// 只删除明显的测试数据，保留可能有用的数据
wx.cloud.callFunction({
  name: 'production-material',
  data: { action: 'list_materials' }
}).then(res => {
  const materials = res.result.data.materials
  
  // 只删除明显的测试数据
  const testMaterials = materials.filter(material => 
    material.name === '物料名称' || 
    material.name.includes('测试') ||
    material.supplier === '未知供应商' ||
    material.createTime.includes('2025-09-04')
  )
  
  console.log('发现测试数据:', testMaterials)
  
  testMaterials.forEach(material => {
    // 先清空库存
    wx.cloud.callFunction({
      name: 'production-material',
      data: {
        action: 'update_material',
        materialId: material._id,
        updateData: { currentStock: 0 }
      }
    }).then(() => {
      // 再删除
      wx.cloud.callFunction({
        name: 'production-material',
        data: {
          action: 'delete_material',
          materialId: material._id
        }
      }).then(() => {
        console.log('✅ 清理完成:', material.name)
      })
    })
  })
})
```

---

## 📝 **执行步骤：**

1. **打开微信开发者工具**
2. **进入控制台**（Console标签）
3. **复制上面的脚本执行**
4. **等待清理完成**
5. **刷新小程序验证结果**

清理完成后，数据库将是完全干净的状态，可以重新开始测试！ 🎉
