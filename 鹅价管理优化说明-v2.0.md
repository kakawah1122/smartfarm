# 鹅价管理功能优化说明 v2.0

## 📋 更新日期
2025-11-08

---

## ✨ 核心优化

### 1. 智能去重机制 ✅
**每个日期只保留一条记录**

#### 实现逻辑
```javascript
// 保存前先查询
const existing = await db.collection('goose_prices')
  .where({ date: '2025-11-08' })
  .get()

if (existing.data.length > 0) {
  // 已存在：更新
  await db.collection('goose_prices').doc(existing.data[0]._id).update({ data })
} else {
  // 不存在：新增
  await db.collection('goose_prices').add({ data })
}
```

#### 优势对比
| 特性 | v1.0（旧版） | v2.0（新版） |
|-----|----------|----------|
| 同日多次录入 | ❌ 生成多条记录 | ✅ 自动覆盖更新 |
| 数据重复 | ❌ 存在大量重复 | ✅ 每日一条，无重复 |
| 查询效率 | ⚠️ 需要筛选 | ✅ 直接按日期查 |
| 趋势分析 | ❌ 数据混乱 | ✅ 完整清晰 |

---

## 🔧 功能改进

### 手动录入
- ✅ 保存前自动查重
- ✅ 新增/更新智能判断
- ✅ 提示信息明确（"已保存" vs "已更新"）

### AI识别
- ✅ 同样支持智能去重
- ✅ Qwen-VL-Max 识别能力
- ✅ 上传后自动保存到云存储

### 历史记录
- ✅ 按日期降序排序（不再按updateTime）
- ✅ 查询最近90天数据（扩展from 30天）
- ✅ 显示数据来源标识

---

## 📊 数据库优化

### 字段更新
| 字段 | 说明 | 变化 |
|-----|------|------|
| `source` | 数据来源 | 新增 `ai_recognition` |
| `createTime` | 创建时间 | 仅首次创建时设置 |
| `updateTime` | 更新时间 | 每次保存都更新 |

### 来源标识
| source | 说明 | 使用场景 |
|--------|------|---------|
| `manual` | 手动录入 | 用户手动填写表单 |
| `ai_recognition` | AI识别 | Qwen-VL-Max识别截图 |
| `wechat_article` | 文章解析 | 已废弃 |

### 索引优化
**主要索引**: `date_-1`（日期降序）

```javascript
// 高效查询最新价格
db.collection('goose_prices')
  .where({ date: db.command.gte('2025-08-10') })
  .orderBy('date', 'desc')
  .limit(1)
```

---

## 💡 使用场景

### 场景1：每日更新价格
```
用户：每天早上10点录入最新鹅价
系统：自动覆盖当天旧数据，保持数据最新
结果：每个日期只有一条最新记录
```

### 场景2：AI识别后再手动修正
```
用户：先AI识别上传截图 → 发现有误 → 手动修正
系统：同一天的数据自动更新，不会产生两条记录
结果：保留最终修正的正确数据
```

### 场景3：历史数据分析
```
系统：完整保存90天内每天的价格数据
AI：基于历史数据预测未来趋势
结果：数据完整、无重复、可分析
```

---

## 🎯 后续计划

### 待开发功能
1. **价格趋势图** 📈
   - 展示最近30天鹅价走势
   - 支持按品种筛选
   - 显示涨跌幅度

2. **高级查询** 🔍
   - 按日期范围查询
   - 按品种过滤
   - 导出历史数据

3. **AI预测** 🤖
   - 基于历史数据预测未来价格
   - 季节性趋势分析
   - 异常价格预警

---

## 📝 迁移指南

### 清理旧数据（可选）
如果数据库中存在大量重复记录，可以执行清理：

```javascript
// 云函数中执行
const db = cloud.database()
const _ = db.command

// 查询所有记录，按日期分组
const allRecords = await db.collection('goose_prices')
  .orderBy('date', 'desc')
  .get()

// 按日期去重，只保留最新的一条
const dateMap = new Map()
allRecords.data.forEach(record => {
  const date = record.date
  if (!dateMap.has(date)) {
    dateMap.set(date, record)
  } else {
    // 如果updateTime更新，则替换
    if (record.updateTime > dateMap.get(date).updateTime) {
      // 删除旧记录
      db.collection('goose_prices').doc(dateMap.get(date)._id).remove()
      dateMap.set(date, record)
    } else {
      // 删除当前记录
      db.collection('goose_prices').doc(record._id).remove()
    }
  }
})
```

⚠️ **注意**：执行前请先备份数据库！

---

## ✅ 测试清单

- [x] 手动录入 - 新日期添加成功
- [x] 手动录入 - 同日期自动更新
- [x] AI识别 - 新日期添加成功
- [x] AI识别 - 同日期自动更新
- [x] 历史记录 - 按日期降序显示
- [x] 历史记录 - 来源标识正确
- [x] 数据库 - 每个日期只有一条记录

---

## 📚 相关文档

- [鹅价数据库配置说明.md](./鹅价数据库配置说明.md) - 数据库结构和去重机制
- [AI鹅价识别功能说明.md](./AI鹅价识别功能说明.md) - AI识别技术架构
- [鹅价管理功能说明.md](./鹅价管理功能说明.md) - 完整功能介绍

---

## 🎉 总结

v2.0版本通过**智能去重机制**，实现了：
- ✅ 数据整洁（每日一条）
- ✅ 自动更新（覆盖旧数据）
- ✅ 历史完整（便于分析）
- ✅ 查询高效（按日期索引）

为后续的**趋势分析**和**AI预测**奠定了坚实基础！

