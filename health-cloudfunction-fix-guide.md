# 🚨 健康管理云函数修复指南

## 问题诊断
错误信息：`errCode: -504002 functions execute fail | errMsg: handler not found`

**根本原因：** 健康管理相关的云函数没有部署到云端，导致前端调用时找不到对应的处理函数。

## ✅ 解决方案

### 步骤 1: 云函数依赖准备（已完成）
我们已经运行了部署准备脚本，所有依赖都已安装：
- ✅ health-management - 核心健康管理云函数
- ✅ ai-diagnosis - AI智能诊断云函数  
- ✅ setup-health-permissions - 数据库权限配置云函数

### 步骤 2: 在微信开发者工具中部署云函数（需要您操作）

1. **打开微信开发者工具**
   - 确保项目已经打开

2. **部署 health-management 云函数**
   - 找到 `cloudfunctions/health-management` 文件夹
   - 右键点击该文件夹
   - 选择 "**上传并部署：云端安装依赖**"
   - 等待部署完成（显示绿色对勾）

3. **部署 ai-diagnosis 云函数**  
   - 找到 `cloudfunctions/ai-diagnosis` 文件夹
   - 右键点击该文件夹
   - 选择 "**上传并部署：云端安装依赖**"
   - 等待部署完成

4. **部署 setup-health-permissions 云函数**
   - 找到 `cloudfunctions/setup-health-permissions` 文件夹
   - 右键点击该文件夹
   - 选择 "**上传并部署：云端安装依赖**"
   - 等待部署完成

### 步骤 3: 验证部署结果

1. **检查云函数状态**
   - 在微信开发者工具中，点击 "云开发" 按钮
   - 进入 "云函数" 页面
   - 确认以下函数显示为 "部署成功"：
     - `health-management`
     - `ai-diagnosis` 
     - `setup-health-permissions`

2. **测试健康页面**
   - 重新编译小程序
   - 打开健康管理页面
   - 检查是否还有 `handler not found` 错误

## 🔧 故障排除

### 如果部署过程中遇到错误：

**错误 1: "上传失败"**
- 检查网络连接
- 确认云开发环境是否正常
- 重试部署操作

**错误 2: "依赖安装失败"**  
- 检查云函数的 package.json 文件
- 重新运行本地依赖准备：`./deploy_health_functions.sh`

**错误 3: "函数运行异常"**
- 在云开发控制台查看云函数日志
- 检查函数代码是否有语法错误

### 如果问题仍然存在：

1. **清除缓存并重新部署**
   - 删除云函数的 node_modules 文件夹
   - 重新运行 `./deploy_health_functions.sh`
   - 重新在开发者工具中部署

2. **检查云函数调用**
   - 在前端代码中添加调试日志
   - 确认调用的 action 名称正确
   - 检查传入的参数是否符合预期

## 📝 预期结果

部署成功后，健康管理页面应该能够：
- ✅ 正常加载健康概览数据
- ✅ 显示预防管理统计
- ✅ 展示活跃预警信息
- ✅ 所有 Tab 功能正常工作
- ✅ AI 诊断功能可以使用

## 🎯 下一步

部署完成后，建议：
1. 测试所有健康管理功能
2. 检查数据库权限配置
3. 验证 AI 诊断功能
4. 确认预警系统工作正常

---

**💡 提示：** 如果您需要重新部署，可以随时运行 `./deploy_health_functions.sh` 脚本来准备云函数依赖。
