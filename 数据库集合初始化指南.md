# 数据库集合初始化指南

## 问题描述
用药管理功能遇到 "database collection not exists" 错误，这是因为物料管理相关的数据库集合尚未创建。

## 解决方案

### 方案1：使用微信云开发控制台手动创建集合（推荐）

1. **登录微信云开发控制台**
   - 前往 https://console.cloud.tencent.com/tcb
   - 选择对应的环境

2. **创建数据库集合**
   - 点击 "云数据库" -> "集合"
   - 创建以下两个集合：

   **集合1：prod_materials（物料基础信息）**
   ```
   集合名称：prod_materials
   描述：存储物料基础信息（药品、饲料等）
   ```

   **集合2：prod_material_records（物料记录）**
   ```
   集合名称：prod_material_records
   描述：存储物料使用和采购记录
   ```

3. **设置权限规则**
   - 将两个集合的权限设置为 "仅创建者及管理员可读写"

### 方案2：使用初始化云函数自动创建

1. **上传初始化云函数**
   - 在微信开发者工具中，右键 `cloudfunctions/init-database` 文件夹
   - 选择 "上传并部署：云端安装依赖"

2. **执行初始化**
   - 在云开发控制台的 "云函数" 中找到 `init-database`
   - 点击 "测试" 按钮执行
   - 查看返回结果确认集合创建成功

3. **删除初始化云函数**
   - 初始化完成后，可以删除这个临时云函数

### 方案3：临时解决方案（已实现）

如果暂时无法创建集合，系统会提供临时方案：
- 点击 "仅完成任务" 可以标记任务完成
- 但不会创建物料记录和扣减库存
- 等数据库集合创建后，功能将恢复正常

## 数据库结构说明

### prod_materials 集合字段
```javascript
{
  _id: "物料ID",
  name: "物料名称",
  category: "物料类别（药品/饲料/营养品等）",
  unit: "单位",
  currentStock: 0, // 当前库存
  unitPrice: 0,    // 单价
  supplier: "供应商",
  description: "描述",
  isActive: true,  // 是否启用
  createTime: Date,
  updateTime: Date
}
```

### prod_material_records 集合字段
```javascript
{
  _id: "记录ID",
  materialId: "物料ID",
  type: "记录类型（purchase/use）",
  quantity: 0,     // 数量
  recordNumber: "单据号",
  operator: "操作员",
  targetLocation: "目标位置/用途",
  status: "状态",
  notes: "备注",
  recordDate: "记录日期",
  createTime: Date,
  updateTime: Date
}
```

## 验证方法

1. 创建集合后，重新测试用药管理功能
2. 应该能够正常选择药品、提交表单
3. 在 "物料管理" 页面应该能看到使用记录
4. 药品库存应该正确扣减

## 注意事项

- 确保云函数 `production-material` 已经重新上传
- 如果问题持续存在，请检查云开发环境配置
- 建议备份重要数据后再进行操作
