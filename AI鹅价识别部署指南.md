# 🤖 AI鹅价识别部署指南

## 📋 功能说明

使用**阿里通义千问 qwen-vl-ocr** 模型实现公众号鹅价截图的智能识别，自动提取表格中的价格数据。

### ✨ 核心优势

- ✅ **免费额度充足**：180天内100万Token免费
- ✅ **专业OCR**：qwen-vl-ocr专为表格识别优化
- ✅ **高准确率**：通义千问多模态模型，识别精度高
- ✅ **成本极低**：约0.5分/次（使用完免费额度后）

---

## 🚀 部署步骤

### 1. 配置通义千问API Key（已完成）

由于你项目中已经配置了 `QWEN_API_KEY`，这一步已经完成。

**验证方法：**
1. 进入 **云开发控制台**
2. 点击 **云函数** → **ai-multi-model**
3. 点击 **配置** 标签
4. 检查环境变量中是否有 `QWEN_API_KEY`

### 2. 部署 ai-multi-model 云函数（更新）

由于我添加了 `qwen-vl-ocr` 模型配置，需要重新部署：

1. 打开**微信开发者工具**
2. 右键 `cloudfunctions/ai-multi-model` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待部署完成（约2-3分钟）

### 3. 部署 recognizeGoosePrice 云函数（新增）

这是专门用于鹅价识别的云函数：

1. 右键 `cloudfunctions/recognizeGoosePrice` 文件夹
2. 选择 **"上传并部署：云端安装依赖"**
3. 等待部署完成（约1-2分钟）

---

## 🧪 测试验证

### 1. 前端测试

1. 打开小程序**真机调试**
2. 进入 **个人中心** → **鹅价管理**
3. 切换到 **AI识别** 标签页
4. 上传一张鹅价表格截图
5. 点击 **"开始AI识别"**
6. 查看识别结果

### 2. 云函数日志查看

**操作步骤：**
1. 进入 **云开发控制台**
2. 点击 **云函数** → **recognizeGoosePrice**
3. 点击 **日志** 标签
4. 查看最近的调用记录

**✅ 正常日志：**
```
====== 开始AI识别鹅价 ======
图片路径: wxfile://tmp_xxxxx.jpg
✅ 图片已上传到云存储: cloud://xxx
🔗 获取图片临时URL...
✅ 临时URL获取成功
🤖 调用AI模型识别...
AI调用结果: {"success":true,...}
✅ AI识别成功
识别日期: 2025-11-08
鹅苗品种数: 3
肉鹅日龄数: 2
```

**❌ 常见错误及解决：**

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `Bearer undefined` | API Key未配置 | 检查 ai-multi-model 的环境变量 |
| `Invalid API key` | API Key无效 | 重新获取并配置正确的API Key |
| `Model not found: qwen-vl-ocr` | 模型不存在 | 确认 ai-multi-model 已更新部署 |
| `AI识别失败: timeout` | 超时 | 检查网络或图片大小 |

---

## 💰 成本估算

### 免费额度
- **额度**: 100万Token
- **有效期**: 180天
- **预估次数**: 约10,000-20,000次识别

### 付费价格（用完免费额度后）
- **单价**: 0.005元/千Token
- **单次识别**: 约0.005元（0.5分）
- **每天100次**: 约0.5元
- **每月3000次**: 约15元

---

## 📊 模型配置详情

### qwen-vl-ocr 模型特点

```javascript
{
  model: 'qwen-vl-ocr',
  provider: '阿里通义',
  costPerKToken: 0.005,  // 0.5分/千Token
  freeQuotaTokens: 1000000,  // 100万免费额度
  freeQuotaDays: 180,  // 180天有效期
  maxImages: 1,  // 单次1张图片
  maxImageSize: 10 * 1024 * 1024,  // 最大10MB
  features: {
    ocr: 'excellent',  // 专业OCR
    tableRecognition: 'excellent',  // 表格识别
    chinese: 'excellent'  // 中文优化
  }
}
```

### 任务路由策略

```javascript
'goose_price_ocr': {
  primary: 'qwen-vl-ocr',  // 主力：OCR专用模型
  fallback: ['qwen-vl-plus', 'qwen-vl-max'],  // 备选
  timeout: 30000,  // 30秒超时
  priority: 'free_first'  // 优先使用免费额度
}
```

---

## 🎯 Prompt设计

AI识别使用的提示词：

```
你是一个专业的价格表格识别助手。请识别图片中的鹅价表格，精确提取以下信息：

**识别要求：**
1. 找到表格中最新一行的日期（通常在最后几行）
2. 提取鹅苗价格（单位：元/只）：
   - 中种鹅：价格区间（如：30-33）
   - 大种鹅：价格区间（如：44-46）
   - 特大种鹅：价格区间（如：48-52）
3. 提取肉鹅价格（单位：元/斤）：
   - 120日龄：价格区间
   - 130日龄：价格区间

**输出格式（严格JSON）：**
{
  "date": "2025-11-08",
  "goslingBreeds": [
    {"key": "middle", "label": "中种鹅", "min": 30, "max": 33},
    {"key": "large", "label": "大种鹅", "min": 44, "max": 46},
    {"key": "extraLarge", "label": "特大种鹅", "min": 48, "max": 52}
  ],
  "meatBreeds": [
    {"key": "meat120", "label": "肉鹅120日龄", "min": 16.5, "max": 16.5},
    {"key": "meat130", "label": "肉鹅130日龄", "min": 17.0, "max": 17.0}
  ]
}
```

---

## 🔧 故障排查

### 1. 识别失败：图片上传问题

**症状**: 提示"获取图片临时链接失败"

**解决**:
- 检查图片大小（建议<5MB）
- 确保云存储权限正常
- 查看云函数日志中的详细错误

### 2. 识别结果不准确

**可能原因**:
- 截图不清晰
- 表格格式特殊
- 关键字识别错误

**优化方案**:
- 使用高清截图
- 确保表格完整
- 调整 Prompt 提示词（见上文）

### 3. 识别速度慢

**原因**: 图片过大或网络延迟

**优化**:
- 压缩图片（前端已实现）
- 使用 WiFi 网络
- 增加超时时间（当前30秒）

---

## 📈 性能优化建议

### 1. 图片预处理
```javascript
// 在 chooseImage 时压缩图片
wx.compressImage({
  src: tempFilePath,
  quality: 80,  // 压缩质量
  compressedWidth: 1500,  // 最大宽度
  success: (res) => {
    // 使用压缩后的图片
  }
})
```

### 2. 识别结果缓存
- 相同图片避免重复识别
- 使用本地存储缓存结果

### 3. 批量识别（未来扩展）
- 支持一次上传多张图片
- 后台批量处理，提高效率

---

## 📝 数据流程图

```
用户上传截图
    ↓
前端 (price-management.ts)
    ↓ wx.cloud.callFunction
recognizeGoosePrice 云函数
    ↓ 上传到云存储
    ↓ 获取临时URL
    ↓ 调用 ai-multi-model
ai-multi-model 云函数
    ↓ 选择 qwen-vl-ocr 模型
    ↓ 调用通义千问 API
通义千问 API
    ↓ OCR识别 + JSON解析
    ↓ 返回结构化数据
recognizeGoosePrice
    ↓ 格式化 + 验证
    ↓ 返回前端
前端展示预览
    ↓ 用户确认
保存到 goose_prices 数据库
```

---

## ✅ 部署检查清单

- [ ] `QWEN_API_KEY` 环境变量已配置
- [ ] `ai-multi-model` 云函数已更新部署
- [ ] `recognizeGoosePrice` 云函数已部署
- [ ] 云函数日志显示正常
- [ ] 前端 AI识别 功能可用
- [ ] 测试识别准确率 > 90%
- [ ] 识别速度 < 10秒

---

## 🎉 完成

恭喜！AI鹅价识别功能已成功部署。现在可以：

1. ✅ 自动识别公众号鹅价截图
2. ✅ 提取表格中的价格数据
3. ✅ 保存到数据库并更新前端显示
4. ✅ 享受180天100万Token免费额度

如有问题，请查看云函数日志或参考上述故障排查部分。







