# 饲养成本计算逻辑说明

## 📊 成本分类

### 1️⃣ **单位成本**（unitCost / entryUnitCost）
**定义**：入栏单价，即购买幼苗时的单价

**来源**：批次入栏记录中的 `unitCost` 字段

**示例**：30元/只

---

### 2️⃣ **单只饲养成本**（avgBreedingCost）
**定义**：单只动物在饲养过程中消耗的物料成本（**不包含入栏价**）

**计算公式**：
```
单只饲养成本 = 物料成本 / 当前存栏数

其中：
- 物料成本 = Σ 所有物料使用记录的总成本（饲料、垫料等）
- 当前存栏数 = 初始数量 - 死亡数 - 出栏数
```

**包含项目**：
- ✅ 饲料成本
- ✅ 垫料成本
- ✅ 其他物料成本

**不包含项目**：
- ❌ 入栏成本（单独记录在 unitCost）
- ❌ 预防成本（疫苗、消毒等）
- ❌ 治疗成本（药品、诊疗等）

### 3️⃣ **单只综合成本**（avgTotalCost）
**定义**：包含所有成本的综合平均成本

**计算公式**：
```
单只综合成本 = (入栏成本 + 物料成本 + 预防成本 + 治疗成本) / 当前存栏数
```

**包含项目**：
- ✅ 入栏成本
- ✅ 物料成本
- ✅ 预防成本
- ✅ 治疗成本

---

## 💰 死亡记录的财务损失计算

### 计算逻辑

```javascript
入栏成本损失 = 入栏单价 × 死亡数量
物料成本损失 = 单只物料成本 × 死亡数量
治疗成本损失 = (治疗总成本 / 治疗动物数) × 死亡数量

财务损失 = 入栏成本损失 + 物料成本损失 + 治疗成本损失
```

### 详细字段说明

| 字段 | 说明 | 计算方式 |
|------|------|----------|
| `unitCost` | 入栏单价 | 批次入栏时的单价 |
| `breedingCost` | 物料成本损失 | avgBreedingCost × 死亡数量 |
| `treatmentCost` | 治疗成本损失 | (治疗总成本 / 治疗动物数) × 死亡数量 |
| `financeLoss` | 总财务损失 | (unitCost + avgBreedingCost) × 死亡数量 + treatmentCost |

### 示例

**批次信息**：
- 批次号：QY-20251022
- 入栏单价：30元/只
- 入栏数量：100只
- 物料总成本：2000元
- 当前存栏：99只（死亡1只）

**成本计算**：
```
入栏单价 = 30元/只
单只物料成本 = 2000 / 99 = 20.20元/只
```

**死亡记录**：
- 死亡数量：1只
- 治疗总成本：100元（治疗了5只动物）
- 治疗成本分摊：100 / 5 = 20元/只

**财务损失明细**：
```
入栏成本损失 = 30 × 1 = 30元
物料成本损失 = 20.20 × 1 = 20.20元
治疗成本损失 = 20 × 1 = 20元
财务损失合计 = 30 + 20.20 + 20 = 70.20元
```

**页面显示**：
- 单位成本：¥30/只（入栏单价）
- 饲养成本：¥20.20（物料成本）
- 治疗成本：¥20.00
- 财务损失：¥70.20（总计）

---

## 🚨 数据验证

### 必需数据
为确保成本计算准确，系统要求以下数据：

1. **入栏单价**（必填）
   - 位置：入栏记录 → `unitCost` 字段
   - 如果缺失：系统会提示"批次 XXX 缺少入栏单价，请先在入栏记录中补充单价"
   - **重要**：这是计算财务损失的基础，必须填写

2. **物料使用记录**（可选，但建议填写）
   - 位置：物料管理 → 物料使用记录
   - 类型：饲料、垫料等
   - 如果缺失：饲养成本为0，财务损失只包含入栏成本和治疗成本

### 错误提示

如果批次缺少入栏单价，系统会显示错误：

```
批次 QY-20251022 缺少入栏单价，请先在入栏记录中补充单价
```

**解决方法**：
1. 打开"生产管理" → "入栏记录"
2. 找到对应批次，编辑并补充入栏单价
3. （可选）添加该批次的物料使用记录，以获得更准确的成本数据

---

## 📝 数据源说明

### 数据库集合

| 集合名 | 用途 | 关键字段 |
|--------|------|----------|
| `prod_batch_entries` | 批次入栏信息 | `unitCost`, `quantity`, `currentCount` |
| `prod_material_records` | 物料使用记录 | `batchId`, `totalCost`, `type='use'` |
| `health_prevention_records` | 预防记录 | `batchId`, `costInfo.totalCost` |
| `health_treatment_records` | 治疗记录 | `batchId`, `costInfo.totalCost` |
| `health_death_records` | 死亡记录 | `financeLoss`, `unitCost`, `breedingCost`, `treatmentCost` |

### 云函数

**函数名**：`health-management`

**Action**：`calculateBatchCost`

**返回数据**：
```javascript
{
  success: true,
  data: {
    avgCost: "20.20",              // 单只物料成本（向后兼容）
    avgBreedingCost: "20.20",      // 单只物料成本
    avgTotalCost: "65.32",         // 单只综合成本
    entryUnitCost: "30.00",        // 入栏单价（新增）
    breakdown: {
      entryCost: "3000.00",        // 总入栏成本
      materialCost: "2000.00",     // 总物料成本
      preventionCost: "500.00",    // 总预防成本
      treatmentCost: "965.00",     // 总治疗成本
      totalCost: "6465.00"         // 总综合成本
    },
    batchInfo: {
      initialQuantity: 100,        // 入栏数量
      currentCount: 99,            // 当前存栏
      entryUnitCost: 30            // 入栏单价
    }
  }
}
```

---

## ✅ 修改总结

### 改进点

1. ✅ **成本概念更清晰**
   - `unitCost`：入栏单价（不变）
   - `breedingCost`：物料成本（不含入栏价）
   - `financeLoss`：入栏 + 物料 + 治疗的总损失

2. ✅ **移除重复计算**
   - 饲养成本不再包含入栏价
   - 避免入栏价和单位成本的重复

3. ✅ **移除硬编码兜底值**
   - 不再使用50元作为默认值
   - 缺少入栏单价时明确提示用户补充

4. ✅ **清晰的成本构成**
   - 入栏成本：基于入栏单价
   - 物料成本（饲养成本）：饲料、垫料等
   - 治疗成本：药品、诊疗费用
   - 财务损失 = 三者之和

5. ✅ **详细的成本分解**
   - 提供入栏、物料、预防、治疗各项明细
   - 支持成本追溯和分析

### 兼容性

- ✅ 保持 `avgCost` 字段向后兼容（现在返回物料成本）
- ✅ 新增 `entryUnitCost` 字段返回入栏单价
- ✅ `breedingCost` 字段现在只记录物料成本损失

---

## 🔄 部署说明

### 需要上传的云函数

**函数名**：`health-management`

**上传步骤**：
1. 打开微信开发者工具
2. 点击"云开发"控制台
3. 进入"云函数"页面
4. 右键点击 `health-management` → 选择"上传并部署：云端安装依赖"

### 影响的功能

- ✅ 死亡记录创建
- ✅ 治疗死亡记录创建
- ✅ 死亡记录详情显示
- ✅ 财务损失统计

### 测试建议

1. **创建测试批次**
   - 入栏单价：30元
   - 入栏数量：10只
   - 添加物料使用记录

2. **记录死亡**
   - 死亡数量：1只
   - 查看成本构成是否正确

3. **验证数据缺失提示**
   - 创建无单价的批次
   - 尝试记录死亡，确认提示正确

