<!--è§’è‰²è¿ç§»ç®¡ç†é¡µé¢-->
<view class="container">
  <!-- å¯¼èˆªæ  -->
  <view class="navbar">
    <view class="navbar-content">
      <t-icon name="arrow-left" bind:tap="goBack" />
      <view class="navbar-title">è§’è‰²è¿ç§»ç®¡ç†</view>
      <view></view>
    </view>
  </view>

  <view wx:if="{{canMigrate}}" class="content">
    <!-- æ“ä½œè¯´æ˜ -->
    <view class="info-card">
      <view class="info-title">ğŸ“‹ è§’è‰²è¿ç§»è¯´æ˜</view>
      <view class="info-content">
        <text>æœ¬å·¥å…·ç”¨äºå°†æ—§çš„è§’è‰²ä½“ç³»è¿ç§»åˆ°æ–°çš„4è§’è‰²ä½“ç³»ï¼š</text>
        <view class="migration-mapping">
          <view class="mapping-item">
            <text class="old-role">ç®¡ç†å‘˜(admin)</text>
            <t-icon name="arrow-right" />
            <text class="new-role">è¶…çº§ç®¡ç†å‘˜</text>
          </view>
          <view class="mapping-item">
            <text class="old-role">æ™®é€šç”¨æˆ·(user)/æ“ä½œå‘˜(operator)</text>
            <t-icon name="arrow-right" />
            <text class="new-role">å‘˜å·¥</text>
          </view>
          <view class="mapping-item">
            <text class="old-role">æŠ€æœ¯å‘˜(technician)</text>
            <t-icon name="arrow-right" />
            <text class="new-role">å…½åŒ»</text>
          </view>
          <view class="mapping-item">
            <text class="old-role">è´¢åŠ¡(finance)</text>
            <t-icon name="arrow-right" />
            <text class="new-role">ç»ç†</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <t-button theme="outline" bind:tap="analyzeRoles">
        <t-icon name="analytics" />
        åˆ†æè§’è‰²åˆ†å¸ƒ
      </t-button>
      <t-button theme="outline" bind:tap="previewMigration">
        <t-icon name="preview-open" />
        é¢„è§ˆè¿ç§»
      </t-button>
      <t-button theme="primary" bind:tap="executeMigration">
        <t-icon name="play-circle" />
        æ‰§è¡Œè¿ç§»
      </t-button>
      <t-button theme="outline" bind:tap="verifyMigration">
        <t-icon name="check-circle" />
        éªŒè¯ç»“æœ
      </t-button>
    </view>

    <!-- åˆ†æç»“æœ -->
    <view wx:if="{{analysisResult}}" class="result-card">
      <view class="result-title">ğŸ“Š è§’è‰²åˆ†æç»“æœ</view>
      <view class="stats-grid">
        <view class="stat-item">
          <view class="stat-value">{{analysisResult.totalUsers}}</view>
          <view class="stat-label">æ€»ç”¨æˆ·æ•°</view>
        </view>
        <view class="stat-item">
          <view class="stat-value">{{analysisResult.migrationPlan.length}}</view>
          <view class="stat-label">éœ€è¿ç§»è§’è‰²</view>
        </view>
        <view class="stat-item">
          <view class="stat-value">{{analysisResult.problemUsers.length}}</view>
          <view class="stat-label">é—®é¢˜ç”¨æˆ·</view>
        </view>
      </view>

      <!-- å½“å‰è§’è‰²åˆ†å¸ƒ -->
      <view class="role-distribution">
        <view class="section-title">å½“å‰è§’è‰²åˆ†å¸ƒ</view>
        <view wx:for="{{analysisResult.roleStats}}" wx:for-item="count" wx:for-index="role" wx:key="role" class="role-stat">
          <view class="role-badge" style="background-color: {{getRoleColor(role)}}20; color: {{getRoleColor(role)}};">
            {{getRoleDisplayName(role)}}
          </view>
          <view class="role-count">{{count}} äºº</view>
        </view>
      </view>

      <!-- è¿ç§»è®¡åˆ’ -->
      <view wx:if="{{analysisResult.migrationPlan.length > 0}}" class="migration-plan">
        <view class="section-title">è¿ç§»è®¡åˆ’</view>
        <view wx:for="{{analysisResult.migrationPlan}}" wx:key="oldRole" class="plan-item">
          <view class="plan-mapping">
            <view class="old-role-tag" style="background-color: {{getRoleColor(item.oldRole)}}20; color: {{getRoleColor(item.oldRole)}};">
              {{getRoleDisplayName(item.oldRole)}}
            </view>
            <t-icon name="arrow-right" />
            <view class="new-role-tag" style="background-color: {{getRoleColor(item.newRole)}}20; color: {{getRoleColor(item.newRole)}};">
              {{getRoleDisplayName(item.newRole)}}
            </view>
            <view class="plan-count">({{item.count}}äºº)</view>
          </view>
        </view>
      </view>

      <!-- é—®é¢˜ç”¨æˆ· -->
      <view wx:if="{{analysisResult.problemUsers.length > 0}}" class="problem-users">
        <view class="section-title">âš ï¸ é—®é¢˜ç”¨æˆ·ï¼ˆéœ€æ‰‹åŠ¨å¤„ç†ï¼‰</view>
        <view wx:for="{{analysisResult.problemUsers}}" wx:key="_id" class="problem-user">
          <view class="user-info">
            <view class="user-name">{{item.nickname}}</view>
            <view class="user-role error-role">{{item.role}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¿ç§»ç»“æœ -->
    <view wx:if="{{migrationResult}}" class="result-card">
      <view class="result-title">
        {{migrationResult.dryRun ? 'ğŸ” è¿ç§»é¢„è§ˆ' : 'âœ… è¿ç§»ç»“æœ'}}
      </view>
      
      <view class="stats-grid">
        <view class="stat-item">
          <view class="stat-value">{{migrationResult.totalUsers}}</view>
          <view class="stat-label">æ€»ç”¨æˆ·</view>
        </view>
        <view class="stat-item success">
          <view class="stat-value">{{migrationResult.successCount}}</view>
          <view class="stat-label">æˆåŠŸ</view>
        </view>
        <view class="stat-item error" wx:if="{{migrationResult.errorCount > 0}}">
          <view class="stat-value">{{migrationResult.errorCount}}</view>
          <view class="stat-label">å¤±è´¥</view>
        </view>
      </view>

      <!-- è¿ç§»è¯¦æƒ… -->
      <view class="migration-details">
        <view wx:for="{{migrationResult.results}}" wx:key="userId" class="migration-item {{item.status}}">
          <view class="user-info">
            <view class="user-name">{{item.nickname}}</view>
            <view class="role-change">
              {{getRoleDisplayName(item.oldRole)}} â†’ {{getRoleDisplayName(item.newRole)}}
            </view>
          </view>
          <view class="status-badge {{item.status}}">
            <text wx:if="{{item.status === 'success'}}">âœ…</text>
            <text wx:elif="{{item.status === 'error'}}">âŒ</text>
            <text wx:else>âš ï¸</text>
          </view>
        </view>
      </view>
    </view>

    <!-- éªŒè¯ç»“æœ -->
    <view wx:if="{{verificationResult}}" class="result-card">
      <view class="result-title">âœ… éªŒè¯ç»“æœ</view>
      
      <view class="verification-summary">
        <view class="summary-item {{verificationResult.isValid ? 'success' : 'error'}}">
          <t-icon name="{{verificationResult.isValid ? 'check-circle-filled' : 'close-circle-filled'}}" />
          <text>{{verificationResult.isValid ? 'è§’è‰²è¿ç§»å®Œå…¨æˆåŠŸ' : 'å­˜åœ¨æ— æ•ˆè§’è‰²'}}</text>
        </view>
      </view>

      <view class="stats-grid">
        <view class="stat-item">
          <view class="stat-value">{{verificationResult.totalUsers}}</view>
          <view class="stat-label">æ€»ç”¨æˆ·</view>
        </view>
        <view class="stat-item success">
          <view class="stat-value">{{verificationResult.validRoleCount}}</view>
          <view class="stat-label">æœ‰æ•ˆè§’è‰²</view>
        </view>
        <view class="stat-item error" wx:if="{{verificationResult.invalidRoles.length > 0}}">
          <view class="stat-value">{{verificationResult.invalidRoles.length}}</view>
          <view class="stat-label">æ— æ•ˆè§’è‰²</view>
        </view>
      </view>

      <!-- æ–°è§’è‰²åˆ†å¸ƒ -->
      <view class="role-distribution">
        <view class="section-title">æ–°è§’è‰²åˆ†å¸ƒ</view>
        <view wx:for="{{verificationResult.newRoleStats}}" wx:for-item="count" wx:for-index="role" wx:key="role" class="role-stat">
          <view class="role-badge" style="background-color: {{getRoleColor(role)}}20; color: {{getRoleColor(role)}};">
            {{getRoleDisplayName(role)}}
          </view>
          <view class="role-count">{{count}} äºº</view>
        </view>
      </view>

      <!-- æ— æ•ˆè§’è‰² -->
      <view wx:if="{{verificationResult.invalidRoles.length > 0}}" class="problem-users">
        <view class="section-title">âš ï¸ æ— æ•ˆè§’è‰²</view>
        <view wx:for="{{verificationResult.invalidRoles}}" wx:key="_id" class="problem-user">
          <view class="user-info">
            <view class="user-name">{{item.nickname}}</view>
            <view class="user-role error-role">{{item.role}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æƒé™ä¸è¶³æç¤º -->
  <view wx:else class="no-permission">
    <t-icon name="lock-on" size="64" color="#ccc" />
    <text>æƒé™ä¸è¶³</text>
    <text>åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œè§’è‰²è¿ç§»</text>
  </view>

  <!-- ç¡®è®¤å¯¹è¯æ¡† -->
  <t-dialog
    visible="{{showConfirmDialog}}"
    title="{{confirmTitle}}"
    content="{{confirmContent}}"
    confirm-btn="ç¡®è®¤æ‰§è¡Œ"
    cancel-btn="å–æ¶ˆ"
    bind:confirm="onConfirm"
    bind:cancel="onCancel"
  />
</view>
