<!-- é‚€è¯·ç®¡ç†é¡µé¢ -->
<view class="page-container">
  <navigation-bar
    title="å‘˜å·¥é‚€è¯·ç®¡ç†"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.total}}</text>
        <text class="stat-label">æ€»é‚€è¯·æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.pending}}</text>
        <text class="stat-label">å¾…ä½¿ç”¨</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.used}}</text>
        <text class="stat-label">å·²ä½¿ç”¨</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.usageRate}}%</text>
        <text class="stat-label">ä½¿ç”¨ç‡</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰é€‰é¡¹å¡ -->
  <view class="filter-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="å…¨éƒ¨é‚€è¯·" value="all" />
      <t-tab-panel label="å¾…ä½¿ç”¨" value="pending" />
      <t-tab-panel label="å·²ä½¿ç”¨" value="used" />
      <t-tab-panel label="å·²è¿‡æœŸ" value="expired" />
    </t-tabs>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="spinner" size="40rpx" text="åŠ è½½ä¸­..." />
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{inviteList.length === 0}}" class="empty-container">
    <t-empty icon="user-add" description="æš‚æ— é‚€è¯·è®°å½•" />
  </view>

  <!-- é‚€è¯·åˆ—è¡¨ -->
  <view wx:else class="content-container">
    <t-cell-group class="invite-list" border="{{true}}">
      <t-cell
        wx:for="{{inviteList}}"
        wx:key="_id"
        title="{{item.inviteCode || ''}}"
        note="{{item.inviteePhone || ''}}"
        description="{{item.department || ''}} {{item.position || ''}}"
      >
        <view slot="right-icon" class="invite-actions">
          <t-tag
            theme="{{getStatusTheme(item.status) || 'default'}}"
            size="small"
            class="status-tag"
          >
            {{item.statusText || 'æœªçŸ¥çŠ¶æ€'}}
          </t-tag>
        </view>
      </t-cell>
    </t-cell-group>

    <!-- åˆ†é¡µåŠ è½½ -->
    <view wx:if="{{hasMore}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
      </t-button>
    </view>
  </view>

  <!-- åˆ›å»ºé‚€è¯·æŒ‰é’® -->
  <view class="create-button-container">
    <t-button
      theme="primary"
      size="large"
      bind:tap="showCreateDialog"
      class="create-invite-btn"
    >
      åˆ›å»ºé‚€è¯·
    </t-button>
    
    <!-- ä¸´æ—¶çš„è¶…çº§ç®¡ç†å‘˜è®¾ç½®æŒ‰é’®ï¼ˆè°ƒè¯•ç”¨ï¼‰ -->
    <t-button
      wx:if="{{!userInfo.isSuper && userInfo.role === 'admin'}}"
      theme="warning"
      size="medium"
      bind:tap="manualSetSuperAdmin"
      class="temp-super-admin-btn btn-spacing"
    >
      è®¾ç½®è¶…çº§ç®¡ç†å‘˜
    </t-button>
  </view>
</view>

<!-- é‚€è¯·è¯¦æƒ…å¼¹çª— -->
<t-dialog
  visible="{{showInviteDetail}}"
  title="é‚€è¯·è¯¦æƒ…"
  confirm-btn="ç¡®å®š"
  bind:confirm="closeInviteDetail"
  bind:cancel="closeInviteDetail"
>
  <view wx:if="{{selectedInvite}}" class="invite-detail">
    <view class="detail-section">
      <view class="detail-item">
        <text class="detail-label">é‚€è¯·ç ï¼š</text>
        <text class="detail-value">{{selectedInvite.inviteCode}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">è¢«é‚€è¯·äººï¼š</text>
        <text class="detail-value">{{selectedInvite.inviteeName}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">æ‰‹æœºå·ï¼š</text>
        <text class="detail-value">{{selectedInvite.inviteePhone}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">éƒ¨é—¨ï¼š</text>
        <text class="detail-value">{{selectedInvite.department || 'æœªè®¾ç½®'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">èŒä½ï¼š</text>
        <text class="detail-value">{{selectedInvite.position || 'æœªè®¾ç½®'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">è§’è‰²ï¼š</text>
        <text class="detail-value">{{getRoleText(selectedInvite.role)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">çŠ¶æ€ï¼š</text>
        <text class="detail-value">{{selectedInvite.statusText}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</text>
        <text class="detail-value">{{formatTime(selectedInvite.createTime)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">è¿‡æœŸæ—¶é—´ï¼š</text>
        <text class="detail-value">{{formatTime(selectedInvite.expiryTime)}}</text>
      </view>
      <view wx:if="{{selectedInvite.remark}}" class="detail-item">
        <text class="detail-label">å¤‡æ³¨ï¼š</text>
        <text class="detail-value">{{selectedInvite.remark}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="invite-actions-section">
      <t-button
        wx:if="{{selectedInvite.status === 'pending'}}"
        theme="warning"
        size="medium"
        bind:tap="revokeInvite"
        class="action-btn"
      >
        æ’¤é”€é‚€è¯·
      </t-button>
      <t-button
        wx:if="{{selectedInvite.status === 'pending'}}"
        theme="primary"
        size="medium"
        bind:tap="resendInvite"
        class="action-btn"
      >
        é‡æ–°å‘é€
      </t-button>
    </view>
  </view>
</t-dialog>

<!-- åˆ›å»ºé‚€è¯·ç å¼¹çª— -->
<view wx:if="{{showCreateDialog}}" class="create-dialog-overlay">
  <view class="create-dialog-mask" bind:tap="closeCreateDialog"></view>
  <view class="create-dialog-content">
    <view class="create-dialog-header">
      <text class="create-dialog-title">åˆ›å»ºé‚€è¯·ç </text>
      <text class="create-dialog-close" bind:tap="closeCreateDialog">âœ•</text>
    </view>
    
    <view class="create-dialog-body">
      <!-- è¡¨å•éƒ¨åˆ†ï¼ˆæœªç”Ÿæˆé‚€è¯·ç æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{!isInviteGenerated}}">
        <view class="form-tip">
          <text class="tip-icon">ğŸ’¡</text>
          <text class="tip-text">ç”Ÿæˆé‚€è¯·ç åï¼Œè¢«é‚€è¯·äººå¯ä½¿ç”¨é‚€è¯·ç è‡ªè¡Œæ³¨å†Œå¹¶å¡«å†™ä¸ªäººä¿¡æ¯</text>
        </view>
        
        <view class="form-group">
          <text class="form-label">é»˜è®¤è§’è‰²</text>
          <picker 
            range="{{roleOptions}}" 
            range-key="label" 
            value="{{selectedRoleIndex[0]}}" 
            bind:change="onRoleChange"
          >
            <view class="picker-container">
              <text class="picker-text">{{roleOptions[selectedRoleIndex[0]].label}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <view class="form-group">
          <text class="form-label">æœ‰æ•ˆæœŸ</text>
          <picker 
            range="{{expiryOptions}}" 
            range-key="label" 
            value="{{selectedExpiryIndex[0]}}" 
            bind:change="onExpiryDaysChange"
          >
            <view class="picker-container">
              <text class="picker-text">{{expiryOptions[selectedExpiryIndex[0]].label}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <view class="form-group">
          <text class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</text>
          <textarea 
            class="form-textarea" 
            placeholder="å¯å¡«å†™æ­¤é‚€è¯·ç çš„ç”¨é€”è¯´æ˜" 
            value="{{newInvite.remark}}" 
            bind:input="onRemarkInput"
            maxlength="100"
          />
        </view>
      </view>

      <!-- é‚€è¯·ç ç”ŸæˆæˆåŠŸæ˜¾ç¤ºéƒ¨åˆ† -->
      <view wx:if="{{isInviteGenerated}}" class="invite-success-content">
        <view class="success-tip">
          <text class="success-icon">ğŸ‰</text>
          <text class="success-text">é‚€è¯·ç ç”ŸæˆæˆåŠŸï¼</text>
        </view>
        
        <view class="invite-code-section">
          <text class="invite-code-label">é‚€è¯·ç </text>
          <view class="invite-code-box" bind:tap="copyInviteCode">
            <text class="invite-code-value">{{generatedInviteCode}}</text>
            <text class="copy-hint">ç‚¹å‡»å¤åˆ¶</text>
          </view>
        </view>
        
        <view class="usage-instructions">
          <text class="instructions-title">ä½¿ç”¨è¯´æ˜</text>
          <text class="instruction-item">â€¢ ç”¨æˆ·ä½¿ç”¨æ­¤é‚€è¯·ç å¯è‡ªè¡Œæ³¨å†Œ</text>
          <text class="instruction-item">â€¢ æ³¨å†Œæ—¶å¯å¡«å†™ä¸ªäººä¿¡æ¯</text>
          <text class="instruction-item">â€¢ é‚€è¯·ç ä½¿ç”¨åå°†è‡ªåŠ¨å¤±æ•ˆ</text>
          <text class="instruction-item">â€¢ è¯·å¦¥å–„ä¿ç®¡é‚€è¯·ç ä¿¡æ¯</text>
        </view>
      </view>
    </view>
    
    <view class="create-dialog-footer">
      <button class="create-btn-cancel" bind:tap="closeCreateDialog">
        {{isInviteGenerated ? 'å…³é—­' : 'å–æ¶ˆ'}}
      </button>
      <button 
        wx:if="{{!isInviteGenerated}}" 
        class="create-btn-confirm" 
        bind:tap="createInvite"
      >
        ç”Ÿæˆé‚€è¯·ç 
      </button>
      <button 
        wx:if="{{isInviteGenerated}}" 
        class="create-btn-copy" 
        bind:tap="copyInviteCode"
      >
        ğŸ“‹ å¤åˆ¶é‚€è¯·ç 
      </button>
    </view>
  </view>
</view>


<!-- æ’¤é”€ç¡®è®¤å¼¹çª— -->
<t-dialog
  visible="{{showRevokeDialog}}"
  title="æ’¤é”€é‚€è¯·"
  confirm-btn="ç¡®è®¤æ’¤é”€"
  cancel-btn="å–æ¶ˆ"
  bind:confirm="confirmRevoke"
  bind:cancel="closeRevokeDialog"
>
  <view class="revoke-form">
    <view class="revoke-warning">
      <text class="revoke-text">ç¡®å®šè¦æ’¤é”€å¯¹"{{selectedInvite.inviteeName}}"çš„é‚€è¯·å—ï¼Ÿ</text>
    </view>
    <view class="form-item">
      <text class="form-label">æ’¤é”€åŸå› </text>
      <t-textarea
        value="{{revokeReason}}"
        placeholder="è¯·è¾“å…¥æ’¤é”€åŸå› "
        maxlength="200"
        bind:change="onRevokeReasonChange"
      />
    </view>
  </view>
</t-dialog>
