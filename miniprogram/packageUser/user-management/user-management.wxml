<!-- 用户管理页面 -->
<wxs module="roleHelper">
  var getRoleText = function(role) {
    if (!role) return '员工';
    var roleMap = {
      'super_admin': '超级管理员',
      'manager': '经理',
      'employee': '员工',
      'veterinarian': '兽医',
      'admin': '管理员',
      'user': '普通用户',
      'operator': '操作员'
    };
    return roleMap[role] || '员工';
  };
  
  module.exports = {
    getRoleText: getRoleText
  };
</wxs>

<view class="page-container">
  <navigation-bar
    title="用户管理"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- 统计卡片 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.totalUsers}}</text>
        <text class="stat-label">总用户数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.activeUsers}}</text>
        <text class="stat-label">活跃用户</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.adminUsers}}</text>
        <text class="stat-label">管理员</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.recentActiveUsers}}</text>
        <text class="stat-label">30天活跃</text>
      </view>
    </view>
  </view>

  <!-- 筛选选项卡 -->
  <view class="filter-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="全部用户" value="all" />
      <t-tab-panel label="管理员" value="admin" />
      <t-tab-panel label="普通用户" value="user" />
      <t-tab-panel label="已禁用" value="disabled" />
    </t-tabs>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="spinner" size="40rpx" text="加载中..." />
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{userList.length === 0}}" class="empty-container">
    <t-empty icon="user" description="暂无用户数据" />
  </view>

  <!-- 用户列表 -->
  <view wx:else class="content-container">
    <view class="user-list">
      <view 
        wx:for="{{userList}}"
        wx:key="_id"
        class="user-card"
        hover-class="user-card-hover"
        bind:tap="onUserClick"
        data-user="{{item}}"
      >
        <view class="user-card-content">
          <!-- 左侧：用户信息 -->
          <view class="user-info">
            <text class="user-nickname">{{item.nickName || item.nickname || '未设置昵称'}}</text>
            <text class="user-role-badge">{{roleHelper.getRoleText(item.role)}}</text>
          </view>
          
          <!-- 右侧：牧场名 -->
          <text class="user-farm">{{item.farmName || item.department || '千羽牧业'}}</text>
        </view>
      </view>
    </view>

    <!-- 分页加载 -->
    <view wx:if="{{hasMore}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? '加载中...' : '加载更多'}}
      </t-button>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-section">
    <t-button
      theme="primary"
      size="large"
      block
      bind:tap="exportUsers"
      class="export-btn"
    >
      导出用户数据
    </t-button>
  </view>
</view>

<!-- 用户详情底部弹窗 -->
<view wx:if="{{showUserDetail}}" class="popup-mask" bind:tap="closeUserDetail">
  <view class="popup-container" catchtap="stopPropagation">
    <view wx:if="{{selectedUser}}" class="user-detail-popup">
    <!-- 弹窗头部 -->
    <view class="popup-header">
      <view class="header-title">用户详情</view>
      <view class="header-close" bind:tap="closeUserDetail">
        <t-icon name="close" size="48rpx" />
      </view>
    </view>

    <!-- 用户基本信息 -->
    <view class="detail-basic">
      <view class="basic-name">{{selectedUser.nickName || selectedUser.nickname || '未设置昵称'}}</view>
      <view class="basic-meta">
        <text class="meta-item">{{selectedUser.phone || '未绑定手机'}}</text>
        <text class="meta-divider">|</text>
        <text class="meta-item">{{selectedUser.farmName || selectedUser.department || '千羽牧业'}}</text>
      </view>
    </view>

    <!-- 角色与权限管理 -->
    <view class="detail-section">
      <view class="section-header">
        <text class="section-title">角色与权限</text>
      </view>
      
      <!-- 当前角色 -->
      <view class="current-role">
        <view class="role-label">当前角色</view>
        <view class="role-value">
          <text class="role-badge {{getRoleClass(selectedUser.role)}}">
            {{roleHelper.getRoleText(selectedUser.role)}}
          </text>
        </view>
      </view>

      <!-- 角色选择 -->
      <view class="role-selector">
        <view class="selector-label">修改角色</view>
        <picker 
          range="{{roleOptions}}" 
          range-key="label" 
          value="{{selectedRoleIndex[0]}}" 
          bind:change="onRoleChange"
        >
          <view class="selector-box">
            <text class="selector-text">{{roleOptions[selectedRoleIndex[0]].label}}</text>
            <t-icon name="chevron-down" size="32rpx" />
          </view>
        </picker>
      </view>

      <!-- 权限列表 -->
      <view wx:if="{{selectedUser.permissions && selectedUser.permissions.length > 0}}" class="permissions-list">
        <view class="permissions-label">当前权限</view>
        <view class="permissions-tags">
          <view 
            wx:for="{{getDisplayPermissions(selectedUser.permissions)}}" 
            wx:key="*this"
            class="permission-tag"
          >
            {{item}}
          </view>
        </view>
      </view>
    </view>

    <!-- 账户信息 -->
    <view class="detail-section">
      <view class="section-header">
        <text class="section-title">账户信息</text>
      </view>
      
      <view class="info-grid">
        <view class="info-item">
          <text class="info-label">账户状态</text>
          <text class="info-value {{selectedUser.isActive ? 'status-active' : 'status-inactive'}}">
            {{selectedUser.isActive ? '正常' : '已禁用'}}
          </text>
        </view>
        <view class="info-item">
          <text class="info-label">登录次数</text>
          <text class="info-value">{{selectedUser.loginCount || 0}}次</text>
        </view>
        <view class="info-item">
          <text class="info-label">注册时间</text>
          <text class="info-value">{{formatTime(selectedUser.createTime)}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">最后登录</text>
          <text class="info-value">{{formatTime(selectedUser.lastLoginTime)}}</text>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="detail-actions">
      <t-button
        theme="primary"
        size="large"
        block
        bind:tap="confirmRoleUpdate"
        disabled="{{!roleChanged}}"
      >
        保存角色修改
      </t-button>
      <t-button
        theme="{{selectedUser.isActive ? 'danger' : 'success'}}"
        size="large"
        block
        variant="outline"
        bind:tap="toggleUserStatus"
      >
        {{selectedUser.isActive ? '禁用账户' : '启用账户'}}
      </t-button>
    </view>
    </view>
  </view>
</view>
