<!-- 用户管理页面 -->
<view class="page-container">
  <navigation-bar
    title="用户管理"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- 统计卡片 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.totalUsers}}</text>
        <text class="stat-label">总用户数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.activeUsers}}</text>
        <text class="stat-label">活跃用户</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.adminUsers}}</text>
        <text class="stat-label">管理员</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.recentActiveUsers}}</text>
        <text class="stat-label">30天活跃</text>
      </view>
    </view>
  </view>

  <!-- 筛选选项卡 -->
  <view class="filter-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="全部用户" value="all" />
      <t-tab-panel label="管理员" value="admin" />
      <t-tab-panel label="普通用户" value="user" />
      <t-tab-panel label="已禁用" value="disabled" />
    </t-tabs>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="spinner" size="40rpx" text="加载中..." />
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{!loading && loadError}}" class="empty-container">
    <t-empty description="加载失败，请重试">
      <t-button theme="primary" size="medium" bind:tap="loadUserList">重新加载</t-button>
    </t-empty>
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{!loading && userList.length === 0}}" class="empty-container">
    <t-empty description="暂无用户数据" />
  </view>

  <!-- 用户列表 -->
  <view wx:elif="{{!loading && userList.length > 0}}" class="content-container">
    <view class="user-list">
      <view
        wx:for="{{userList}}"
        wx:key="_id"
        class="user-card"
        bind:tap="onUserClick"
        data-user="{{item}}"
      >
        <!-- 左侧：头像 -->
        <view class="user-avatar-container">
          <image
            wx:if="{{item.avatarUrl}}"
            class="user-avatar"
            src="{{item.avatarUrl}}"
            mode="aspectFill"
          />
          <view wx:else class="user-avatar user-avatar-placeholder">
            <text class="avatar-text">{{item.nickname && item.nickname.length > 0 ? item.nickname[0] : '用'}}</text>
          </view>
        </view>

        <!-- 中间：用户信息 -->
        <view class="user-info">
          <view class="user-name">{{item.nickname}}</view>
          <view class="user-details">
            <text class="user-phone">{{item.phone}}</text>
            <text wx:if="{{item.farmName}}" class="user-farm">{{item.farmName}}</text>
          </view>
        </view>

        <!-- 右侧：角色标签 -->
        <view class="user-role-tag">
          <t-tag
            theme="{{item.roleTheme}}"
            size="small"
            class="role-tag"
          >
            {{item.roleText}}
          </t-tag>
        </view>
      </view>
    </view>

    <!-- 分页加载 -->
    <view wx:if="{{hasMore}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? '加载中...' : '加载更多'}}
      </t-button>
    </view>
  </view>
</view>

<!-- 用户详情底部弹窗 -->
<bottom-popup
  visible="{{showUserDetail}}"
  title="用户详情"
  show-close="{{true}}"
  show-actions="{{true}}"
  confirm-text="保存"
  cancel-text="取消"
  bind:close="closeUserDetail"
  bind:confirm="confirmRoleUpdate"
  bind:visiblechange="onUserDetailPopupChange"
>
  <view wx:if="{{selectedUser}}" class="user-detail-content">
    <view class="info-card">
      <view class="card-content">
        <!-- 用户头像和基本信息 -->
        <view class="user-header">
          <view class="user-avatar-large">
            <image
              wx:if="{{selectedUser.avatarUrl}}"
              class="avatar-image"
              src="{{selectedUser.avatarUrl}}"
              mode="aspectFill"
            />
            <view wx:else class="avatar-placeholder">
              <text class="avatar-text">{{selectedUser.nickname && selectedUser.nickname.length > 0 ? selectedUser.nickname[0] : '用'}}</text>
            </view>
          </view>
          <view class="user-basic-info">
            <text class="user-name-large">{{selectedUser.nickname || '未设置昵称'}}</text>
            <text class="user-phone-large">{{selectedUser.phone || '未绑定手机'}}</text>
          </view>
        </view>
        <view class="divider-line"></view>

        <!-- 基本信息 -->
        <view class="info-row">
          <text class="info-label">农场：</text>
          <text class="info-value">{{selectedUser.farmName || '未设置'}}</text>
        </view>
        <view class="divider-line"></view>

        <!-- 身份管理 -->
        <view class="identity-section">
          <view class="section-title">身份管理</view>
          
          <view class="info-row">
            <text class="info-label">角色：</text>
            <picker 
              range="{{roleOptions}}" 
              range-key="label" 
              value="{{selectedRoleIndex}}" 
              bind:change="onRoleChange"
            >
              <view class="picker-value">
                <text class="info-value picker-text">{{roleOptions[selectedRoleIndex[0] || 0].label}}</text>
                <t-icon name="chevron-down" size="16" color="#c8c9cc" />
              </view>
            </picker>
          </view>
          <view class="divider-line"></view>

          <!-- 权限信息 -->
          <view class="info-row permissions-row">
            <text class="info-label">权限：</text>
            <view class="permissions-list">
              <text 
                wx:for="{{displayPermissions}}" 
                wx:key="*this"
                class="permission-item"
              >{{item}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 操作按钮区域 -->
    <view class="action-buttons-section">
      <t-button
        theme="{{selectedUser.status === 'active' ? 'danger' : 'success'}}"
        size="large"
        bind:tap="toggleUserStatus"
        class="action-button"
      >
        {{selectedUser.status === 'active' ? '禁用用户' : '启用用户'}}
      </t-button>
    </view>
  </view>
</bottom-popup>
