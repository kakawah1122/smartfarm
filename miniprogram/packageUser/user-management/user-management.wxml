<!-- 用户管理页面 -->
<wxs module="roleHelper">
  var getRoleText = function(role) {
    if (!role) return '员工';
    var roleMap = {
      'super_admin': '超级管理员',
      'manager': '经理',
      'employee': '员工',
      'veterinarian': '兽医',
      'admin': '管理员',
      'user': '普通用户',
      'operator': '操作员'
    };
    return roleMap[role] || '员工';
  };
  
  module.exports = {
    getRoleText: getRoleText
  };
</wxs>

<view class="page-container">
  <navigation-bar
    title="用户管理"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- 统计卡片 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.totalUsers}}</text>
        <text class="stat-label">总用户数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.activeUsers}}</text>
        <text class="stat-label">活跃用户</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.adminUsers}}</text>
        <text class="stat-label">管理员</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.recentActiveUsers}}</text>
        <text class="stat-label">30天活跃</text>
      </view>
    </view>
  </view>

  <!-- 筛选选项卡 -->
  <view class="filter-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="全部用户" value="all" />
      <t-tab-panel label="管理员" value="admin" />
      <t-tab-panel label="普通用户" value="user" />
      <t-tab-panel label="已禁用" value="disabled" />
    </t-tabs>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="spinner" size="40rpx" text="加载中..." />
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{userList.length === 0}}" class="empty-container">
    <t-empty 
      icon="user" 
      description="暂无用户数据"
      size="large"
    />
  </view>

  <!-- 用户列表 -->
  <view wx:else class="content-container">
    <view class="user-list">
      <view 
        wx:for="{{userList}}"
        wx:key="_id"
        class="user-card"
        hover-class="user-card-hover"
        bind:tap="onUserClick"
        data-user="{{item}}"
      >
        <view class="user-card-content">
          <!-- 左侧：用户信息 -->
          <view class="user-info">
            <text class="user-nickname">{{item.nickName || item.nickname || '未设置昵称'}}</text>
            <text class="user-role-badge">{{roleHelper.getRoleText(item.role)}}</text>
          </view>
          
          <!-- 右侧：牧场名 -->
          <text class="user-farm">{{item.farmName || item.department || '千羽牧业'}}</text>
        </view>
      </view>
    </view>

    <!-- 分页加载 -->
    <view wx:if="{{hasMore}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? '加载中...' : '加载更多'}}
      </t-button>
    </view>
  </view>
</view>

<!-- 用户详情底部弹窗 -->
<t-popup
  visible="{{showUserDetail}}"
  placement="bottom"
  bind:visible-change="onPopupVisibleChange"
  custom-style="border-radius: 32rpx 32rpx 0 0;"
>
    <view wx:if="{{selectedUser}}" class="user-detail-popup">
    <!-- 弹窗头部 -->
    <view class="popup-header">
      <view class="header-title">用户详情</view>
      <view class="header-close" bind:tap="closeUserDetail">
        <text class="close-icon">✕</text>
      </view>
    </view>

    <!-- 滚动内容区 -->
    <scroll-view scroll-y class="popup-content">
    <!-- 用户基本信息 -->
    <view class="detail-basic">
      <view class="basic-name">{{selectedUser.nickName || selectedUser.nickname || '未设置昵称'}}</view>
      <view class="basic-meta">
        <text class="meta-item">{{selectedUser.phone || '未绑定手机'}}</text>
        <text class="meta-divider">|</text>
        <text class="meta-item">{{selectedUser.farmName || selectedUser.department || '千羽牧业'}}</text>
      </view>
    </view>

    <!-- 角色与权限管理 -->
    <view class="detail-section">
      <view class="section-header">
          <text class="section-title">角色与权限管理</text>
          <text class="section-subtitle">修改角色后权限将自动更新</text>
        </view>

        <!-- 角色与权限卡片 -->
        <view class="role-permission-card">
          <!-- 角色选择器 -->
          <view class="role-selector-section">
            <view class="selector-header">
              <text class="selector-title">当前角色</text>
              <text wx:if="{{roleChanged}}" class="change-indicator">已修改</text>
            </view>
            <picker 
              range="{{roleOptions}}" 
              range-key="label" 
              value="{{selectedRoleIndex[0]}}" 
              bind:change="onRoleChange"
            >
              <view class="selector-box">
                <text class="selector-text">{{roleOptions[selectedRoleIndex[0]].label}}</text>
                <t-icon name="chevron-down" size="32rpx" color="#0052d9" />
              </view>
            </picker>
          </view>

          <!-- 分隔线 -->
          <view class="card-divider"></view>

          <!-- 权限预览 -->
          <view class="permissions-section">
            <view class="permissions-header">
              <text class="permissions-title">该角色包含以下权限</text>
            </view>
            <view wx:if="{{displayPermissions && displayPermissions.length > 0}}" class="permissions-tags">
              <view 
                wx:for="{{displayPermissions}}" 
                wx:key="*this"
                class="permission-tag"
              >
                {{item}}
              </view>
            </view>
            <view wx:else class="no-permissions">
              <text>暂无特殊权限</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 账户状态 -->
      <view class="detail-section">
        <view class="section-header">
          <text class="section-title">账户状态</text>
        </view>
        
        <view class="account-status-card">
          <view class="status-details">
            <view class="detail-row">
              <text class="detail-label">当前状态</text>
              <text class="detail-value {{selectedUser.isActive !== false ? 'status-active' : 'status-inactive'}}">{{selectedUser.isActive !== false ? '正常使用中' : '已禁用'}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">登录次数</text>
              <text class="detail-value">{{selectedUser.loginCount || 0}} 次</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">最后登录</text>
              <text class="detail-value">{{selectedUser.formattedLastLoginTime}}</text>
            </view>
            <view class="detail-row">
              <text class="detail-label">注册时间</text>
              <text class="detail-value">{{selectedUser.formattedCreateTime}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 底部安全间距 -->
      <view style="height: 40rpx;"></view>
    </scroll-view>

    <!-- 固定底部操作按钮 -->
    <view class="detail-actions-fixed">
      <view class="actions-container">
      <t-button
        theme="primary"
        size="large"
        block
        bind:tap="confirmRoleUpdate"
        disabled="{{!roleChanged}}"
          class="action-btn-save"
      >
          <t-icon name="check" size="32rpx" slot="icon" />
          {{roleChanged ? '保存角色修改' : '角色未修改'}}
      </t-button>
      <t-button
          theme="{{selectedUser.isActive ? 'default' : 'success'}}"
        size="large"
        block
        variant="outline"
        bind:tap="toggleUserStatus"
          class="action-btn-toggle"
      >
          <t-icon name="{{selectedUser.isActive ? 'poweroff' : 'refresh'}}" size="32rpx" slot="icon" />
          {{selectedUser.isActive ? '禁用此账户' : '启用此账户'}}
      </t-button>
    </view>
    </view>
  </view>
</t-popup>
