<!--health-record-form.wxml - å¥åº·è®°å½•è¡¨å•é¡µé¢-->
<view class="page page-container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navigation-bar 
    title="æ–°å¢å¥åº·è®°å½•"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- è¡¨å•å†…å®¹åŒºåŸŸ -->
  <view class="form-content">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <t-loading theme="spinner" size="40rpx" text="åŠ è½½ä¸­..." />
    </view>

    <!-- è¡¨å•ä¸»ä½“ -->
    <view wx:else class="health-record-form">
      <!-- ç—‡çŠ¶ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">ç—‡çŠ¶ä¿¡æ¯</text>
        </view>
        
        <view class="form-card">
          <!-- æ‰¹æ¬¡é€‰æ‹© -->
          <view class="form-item">
            <view class="form-label required">é€‰æ‹©æ‰¹æ¬¡</view>
            <view class="form-content">
              <picker 
                wx:if="{{activeBatches.length > 0}}"
                bindchange="onBatchChange" 
                range="{{activeBatches}}" 
                range-key="displayName"
                value="{{batchIndex >= 0 ? batchIndex : 0}}"
              >
                <view class="picker-display" bind:tap="onBatchCellClick">
                  {{batchIndex >= 0 && activeBatches[batchIndex] ? activeBatches[batchIndex].displayName : 'è¯·é€‰æ‹©å­˜æ æ‰¹æ¬¡'}}
                </view>
              </picker>
              <view wx:else class="picker-display disabled">
                æš‚æ— å­˜æ æ‰¹æ¬¡
              </view>
            </view>
          </view>

          <!-- å¸¸è§ç—‡çŠ¶é€‰æ‹© -->
          <view class="form-item">
            <view class="form-label">å¸¸è§ç—‡çŠ¶</view>
            <view class="form-content">
              <picker 
                wx:if="{{commonSymptoms.length > 0}}"
                bindchange="onSymptomChange" 
                range="{{commonSymptoms}}" 
                range-key="name"
                value="{{symptomIndex >= 0 ? symptomIndex : 0}}"
              >
                <view class="picker-display">
                  {{symptomIndex >= 0 && commonSymptoms[symptomIndex] ? commonSymptoms[symptomIndex].name : 'è¯·é€‰æ‹©ç—‡çŠ¶ç±»å‹'}}
                </view>
              </picker>
              <view wx:else class="picker-display disabled">
                ç—‡çŠ¶é€‰é¡¹åŠ è½½ä¸­...
              </view>
            </view>
          </view>

          <!-- ç—‡çŠ¶æè¿° -->
          <view class="form-item form-item-vertical">
            <view class="form-label required">ç—‡çŠ¶æè¿°</view>
            <view class="form-content">
              <t-textarea
                placeholder="è¯·è¯¦ç»†æè¿°ç—‡çŠ¶ï¼Œå¦‚ï¼šé¹…ç¾¤å‡ºç°ç²¾ç¥èé¡ã€é£Ÿæ¬²ä¸æŒ¯ç­‰ç—‡çŠ¶..."
                value="{{formData.symptoms}}"
                bind:change="onFieldChange"
                data-field="symptoms"
                maxlength="500"
                indicator
                autosize
                class="form-textarea"
              />
            </view>
          </view>

          <!-- è¯Šæ–­ç—…ç§ -->
          <view class="form-item">
            <view class="form-label">è¯Šæ–­ç—…ç§</view>
            <view class="form-content">
              <picker 
                wx:if="{{commonDiseases.length > 0}}"
                bindchange="onDiseaseChange" 
                range="{{commonDiseases}}" 
                range-key="name"
                value="{{diseaseIndex >= 0 ? diseaseIndex : 0}}"
              >
                <view class="picker-display">
                  {{diseaseIndex >= 0 && commonDiseases[diseaseIndex] ? commonDiseases[diseaseIndex].name : 'è¯·é€‰æ‹©è¯Šæ–­ç—…ç§'}}
                </view>
              </picker>
              <view wx:else class="picker-display disabled">
                ç—…ç§é€‰é¡¹åŠ è½½ä¸­...
              </view>
            </view>
          </view>

          <!-- å¼‚å¸¸æ•°é‡ -->
          <view class="form-item">
            <view class="form-label required">å¼‚å¸¸æ•°é‡</view>
            <view class="form-content">
              <t-input
                placeholder="è¯·è¾“å…¥å¼‚å¸¸æ•°é‡"
                value="{{formData.abnormalCount}}"
                type="number"
                bind:change="onFieldChange"
                data-field="abnormalCount"
                suffix="ç¾½"
                align="right"
                class="form-input"
              />
            </view>
          </view>

          <!-- è®°å½•æ—¥æœŸ -->
          <view class="form-item">
            <view class="form-label required">è®°å½•æ—¥æœŸ</view>
            <view class="form-content">
              <view class="picker-content" bind:tap="showDatePicker" data-type="record">
                <text class="picker-text">{{formData.recordDate || 'è¯·é€‰æ‹©è®°å½•æ—¥æœŸ'}}</text>
                <t-icon name="calendar" size="24rpx" color="#bbb" />
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ²»ç–—ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">æ²»ç–—ä¿¡æ¯</text>
        </view>
        
        <view class="form-card">
          <!-- æ²»ç–—æ–¹æ¡ˆ -->
          <view class="form-item">
            <view class="form-label">æ²»ç–—æ–¹æ¡ˆ</view>
            <view class="form-content">
              <picker 
                wx:if="{{treatmentOptions.length > 0}}"
                bindchange="onTreatmentChange" 
                range="{{treatmentOptions}}" 
                range-key="label"
                value="{{treatmentIndex >= 0 ? treatmentIndex : 0}}"
              >
                <view class="picker-display">
                  {{treatmentIndex >= 0 && treatmentOptions[treatmentIndex] ? treatmentOptions[treatmentIndex].label : 'è¯·é€‰æ‹©æ²»ç–—æ–¹æ¡ˆ'}}
                </view>
              </picker>
              <view wx:else class="picker-display disabled">
                æ²»ç–—æ–¹æ¡ˆåŠ è½½ä¸­...
              </view>
            </view>
          </view>

          <!-- æ²»ç–—æ—¥æœŸ -->
          <view class="form-item">
            <view class="form-label required">æ²»ç–—æ—¥æœŸ</view>
            <view class="form-content">
              <view class="picker-content" bind:tap="showDatePicker" data-type="treatment">
                <text class="picker-text">{{formData.treatmentDate || 'è¯·é€‰æ‹©æ²»ç–—æ—¥æœŸ'}}</text>
                <t-icon name="calendar" size="24rpx" color="#bbb" />
              </view>
            </view>
          </view>

          <!-- ç”¨è¯è®°å½•ï¼ˆä»…åœ¨é€‰æ‹©è¯å“æ²»ç–—æˆ–è¥å…»æ”¯æŒæ—¶æ˜¾ç¤ºï¼‰ -->
          <view wx:if="{{showMedicineSelector}}">
            <!-- è¯å“/è¥å…»å“é€‰æ‹© -->
            <view class="form-item">
              <view class="form-label">{{selectedTreatmentType === 'nutrition' ? 'è¥å…»å“é€‰æ‹©' : 'è¯å“é€‰æ‹©'}}</view>
              <view class="form-content">
                <picker 
                  wx:if="{{medicineRecords.length > 0}}"
                  bindchange="onMedicineRecordChange" 
                  range="{{medicineRecords}}" 
                  range-key="displayName"
                  value="{{medicineRecordIndex >= 0 ? medicineRecordIndex : 0}}"
                >
                  <view class="picker-display">
                    {{medicineRecordIndex >= 0 && medicineRecords[medicineRecordIndex] ? medicineRecords[medicineRecordIndex].displayName : (selectedTreatmentType === 'nutrition' ? 'è¯·é€‰æ‹©è¥å…»å“' : 'è¯·é€‰æ‹©è¯å“')}}
                  </view>
                </picker>
                <view wx:else class="picker-display disabled">
                  {{selectedTreatmentType === 'nutrition' ? 'æš‚æ— è¥å…»å“åº“å­˜' : 'æš‚æ— è¯å“åº“å­˜'}}
                </view>
              </view>
            </view>

            <!-- ç”¨é‡è¾“å…¥ï¼ˆé€‰æ‹©è¯å“åæ˜¾ç¤ºï¼‰ -->
            <view wx:if="{{selectedMedicine}}" class="form-item">
              <view class="form-label required">ä½¿ç”¨æ•°é‡</view>
              <view class="form-content">
                <t-input
                  placeholder="è¯·è¾“å…¥ä½¿ç”¨æ•°é‡"
                  value="{{formData.medicineQuantity}}"
                  type="digit"
                  bind:change="onFieldChange"
                  data-field="medicineQuantity"
                  suffix="{{selectedMedicine.unit || 'å•ä½'}}"
                  align="right"
                  class="form-input"
                />
              </view>
            </view>

            <!-- åº“å­˜æç¤ºï¼ˆé€‰æ‹©è¯å“åæ˜¾ç¤ºï¼‰ -->
            <view wx:if="{{selectedMedicine}}" class="form-item stock-info">
              <view class="stock-info-content">
                <text class="stock-label">å½“å‰åº“å­˜ï¼š</text>
                <text class="stock-value">{{selectedMedicine.currentStock}}{{selectedMedicine.unit}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-header">
          <text class="section-title">å¤‡æ³¨ä¿¡æ¯</text>
        </view>
        
        <view class="form-card notes-card">
          <t-textarea
            placeholder="è¯·è¾“å…¥å…¶ä»–å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
            value="{{formData.notes}}"
            bind:change="onFieldChange"
            data-field="notes"
            maxlength="200"
            indicator
            autosize
            class="fullwidth-notes-textarea"
          />
        </view>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="form-actions">
        <t-button 
          theme="primary" 
          size="large" 
          block 
          bind:tap="onSubmit"
          loading="{{submitting}}"
          disabled="{{submitting}}"
        >
          {{submitting ? 'æäº¤ä¸­...' : 'æäº¤å¥åº·è®°å½•'}}
        </t-button>
        <t-button 
          theme="default" 
          size="large" 
          block 
          bind:tap="onReset"
          disabled="{{submitting}}"
        >
          é‡ç½®è¡¨å•
        </t-button>
      </view>

      <!-- æ¸©é¦¨æç¤º -->
      <view class="form-tips">
        <t-notice-bar theme="info" content="ğŸ’¡ æç¤ºï¼šå¥åº·è®°å½•æäº¤åï¼Œå¯é€šè¿‡å¥åº·ç®¡ç†é¡µé¢è¿›è¡Œæ²»ç–—è·Ÿè¿›å’Œç»“æœè®°å½•ã€‚" />
      </view>
    </view>
  </view>

  <!-- æ—¥æœŸé€‰æ‹©å™¨ - è®°å½•æ—¥æœŸ -->
  <t-date-time-picker 
    visible="{{showRecordDate}}"
    mode="date"
    value="{{recordDateValue}}"
    format="YYYY-MM-DD"
    bind:cancel="hideDatePicker"
    bind:confirm="onDateConfirm"
    data-type="record"
  />

  <!-- æ—¥æœŸé€‰æ‹©å™¨ - æ²»ç–—æ—¥æœŸ -->
  <t-date-time-picker 
    visible="{{showTreatmentDate}}"
    mode="date"
    value="{{treatmentDateValue}}"
    format="YYYY-MM-DD"
    bind:cancel="hideDatePicker"
    bind:confirm="onDateConfirm"
    data-type="treatment"
  />
</view>
