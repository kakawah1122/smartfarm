<!--abnormal-detail.wxml-->
<view class="page page-container">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar 
    title="å½“å‰å¼‚å¸¸ç®¡ç†"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- åŠ è½½çŠ¶æ€ -->
  <t-loading wx:if="{{loading}}" theme="circular" size="40rpx" text="åŠ è½½ä¸­..." class="loading-container" />

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="content-container">
    <!-- å¼‚å¸¸æ¦‚è§ˆå¡ç‰‡ -->
    <view class="current-status-overview">
      <view class="status-header">
        <t-icon name="error-circle" size="32rpx" color="#ff4d4f" />
        <text class="status-title">å½“å‰å¼‚å¸¸çŠ¶æ€</text>
        <text class="status-time">{{updateTime}}</text>
      </view>
      
      <t-row gutter="12" class="status-stats">
        <t-col span="6">
          <view class="status-card urgent">
            <view class="status-value">{{currentStats.urgent}}</view>
            <view class="status-label">ç´§æ€¥</view>
          </view>
        </t-col>
        <t-col span="6">
          <view class="status-card moderate">
            <view class="status-value">{{currentStats.moderate}}</view>
            <view class="status-label">ä¸­ç­‰</view>
          </view>
        </t-col>
        <t-col span="6">
          <view class="status-card mild">
            <view class="status-value">{{currentStats.mild}}</view>
            <view class="status-label">è½»å¾®</view>
          </view>
        </t-col>
        <t-col span="6">
          <view class="status-card treating">
            <view class="status-value">{{currentStats.treating}}</view>
            <view class="status-label">æ²»ç–—ä¸­</view>
          </view>
        </t-col>
      </t-row>
    </view>

    <!-- Tab åˆ‡æ¢ -->
    <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" class="detail-tabs">
      <t-tab-panel value="distribution" label="å½“å‰åˆ†å¸ƒ"></t-tab-panel>
      <t-tab-panel value="priority" label="ç´§æ€¥æ’åº"></t-tab-panel>
      <t-tab-panel value="treatment" label="æ²»ç–—è·Ÿè¸ª"></t-tab-panel>
      <t-tab-panel value="ai_advice" label="AIå»ºè®®"></t-tab-panel>
    </t-tabs>

    <view class="scroll-container">
      <!-- å½“å‰åˆ†å¸ƒ Tab -->
      <view wx:if="{{activeTab === 'distribution'}}" class="tab-content">
        <!-- ç—…ç§åˆ†å¸ƒå›¾è¡¨ -->
        <view class="current-distribution-section">
          <view class="card">
            <view class="card-header">
              <text class="card-title">å½“å‰å¼‚å¸¸ç—…ç§åˆ†å¸ƒ</text>
              <text class="data-note">ä»…ç»Ÿè®¡å½“å‰å¼‚å¸¸ä¸ªä½“</text>
            </view>
            
            <!-- ç—…ç§é¥¼å›¾ -->
            <view class="disease-pie-chart">
              <view class="css-pie-chart" wx:if="{{currentDiseases.length > 0}}">
                <view wx:for="{{currentDiseases}}" wx:key="name" 
                      class="pie-slice-container" 
                      style="transform: rotate({{item.startAngle}}deg)">
                  <view class="pie-slice" 
                        style="--slice-color: {{item.color}}; --slice-angle: {{item.angle}}deg"></view>
                </view>
                <view class="pie-center">
                  <text class="center-value">{{currentStats.total}}</text>
                  <text class="center-label">å¼‚å¸¸ä¸ªä½“</text>
                </view>
              </view>
              
              <!-- å›¾ä¾‹ -->
              <view class="chart-legend">
                <view wx:for="{{currentDiseases}}" wx:key="name" class="legend-item">
                  <view class="legend-color" style="background-color: {{item.color}}"></view>
                  <text class="legend-name">{{item.name}}</text>
                  <text class="legend-count">{{item.count}}åª</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- ä½ç½®åˆ†å¸ƒ -->
        <view class="location-distribution-section">
          <view class="card">
            <view class="card-header">
              <text class="card-title">å„é¹…èˆåˆ†å¸ƒæƒ…å†µ</text>
            </view>
            <view class="location-list">
              <view wx:for="{{locationDistribution}}" wx:key="location" class="location-item">
                <view class="location-header">
                  <view class="location-name">{{item.location}}</view>
                  <view class="location-total">{{item.abnormalCount}}/{{item.totalCount}}åªå¼‚å¸¸</view>
                </view>
                <view class="location-diseases">
                  <view wx:for="{{item.diseases}}" wx:for-item="disease" wx:key="name" class="disease-tag">
                    <view class="disease-dot" style="background-color: {{disease.color}}"></view>
                    <text class="disease-text">{{disease.name}} {{disease.count}}åª</text>
                  </view>
                </view>
                <view class="location-rate">
                  <text class="rate-label">å¼‚å¸¸ç‡:</text>
                  <text class="rate-value {{item.rate >= 20 ? 'high' : item.rate >= 10 ? 'medium' : 'low'}}">{{item.rate}}%</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç´§æ€¥æ’åº Tab -->
      <view wx:if="{{activeTab === 'priority'}}" class="tab-content">
        <!-- ç´§æ€¥ç¨‹åº¦ç­›é€‰ -->
        <view class="priority-filter">
          <view class="filter-buttons">
            <t-button wx:for="{{priorityLevels}}" wx:key="level" 
                      theme="{{activePriority === item.level ? 'primary' : 'light'}}"
                      variant="{{activePriority === item.level ? 'base' : 'outline'}}"
                      size="small"
                      bind:tap="onPriorityFilter"
                      data-level="{{item.level}}"
                      class="priority-btn">
              {{item.label}} ({{item.count}})
            </t-button>
          </view>
        </view>
        
        <!-- å¼‚å¸¸ä¸ªä½“åˆ—è¡¨ -->
        <view class="abnormal-animals-list">
          <view wx:for="{{filteredAbnormalAnimals}}" wx:key="id" class="animal-card">
            <view class="animal-header">
              <view class="animal-info">
                <view class="animal-id">ç¼–å·: {{item.animalId}}</view>
                <view class="priority-badge {{item.priority}}">
                  {{item.priority === 'urgent' ? 'ğŸ”´ ç´§æ€¥' : item.priority === 'moderate' ? 'ğŸŸ¡ ä¸­ç­‰' : 'ğŸŸ¢ è½»å¾®'}}
                </view>
              </view>
              <view class="animal-status">
                <t-tag theme="{{item.treatmentStatus === 'treating' ? 'primary' : 'default'}}" size="small">
                  {{item.treatmentStatus === 'treating' ? 'æ²»ç–—ä¸­' : 'å¾…å¤„ç†'}}
                </t-tag>
              </view>
            </view>
            
            <view class="animal-details">
              <view class="detail-row">
                <text class="detail-label">ç–¾ç—…:</text>
                <text class="detail-value">{{item.disease}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">ä½ç½®:</text>
                <text class="detail-value">{{item.location}}</text>
              </view>
              <view class="detail-row">
                <text class="detail-label">å‘ç°æ—¶é—´:</text>
                <text class="detail-value">{{item.discoveredTime}}</text>
              </view>
              <view wx:if="{{item.symptoms}}" class="detail-row">
                <text class="detail-label">ä¸»è¦ç—‡çŠ¶:</text>
                <text class="detail-value">{{item.symptoms}}</text>
              </view>
            </view>
            
            <view class="animal-actions">
              <t-button size="small" theme="primary" bind:tap="startTreatment" data-animal="{{item}}">
                å¼€å§‹æ²»ç–—
              </t-button>
              <t-button size="small" theme="light" bind:tap="viewAnimalDetail" data-animal="{{item}}">
                æŸ¥çœ‹è¯¦æƒ…
              </t-button>
            </view>
          </view>
        </view>
      </view>

      <!-- æ²»ç–—è·Ÿè¸ª Tab -->
      <view wx:if="{{activeTab === 'treatment'}}" class="tab-content">
        <!-- æ²»ç–—çŠ¶æ€æ¦‚è§ˆ -->
        <view class="treatment-overview">
          <t-row gutter="12" class="treatment-stats">
            <t-col span="8">
              <view class="treatment-stat-card treating">
                <view class="stat-value">{{treatmentStats.treating}}</view>
                <view class="stat-label">æ²»ç–—ä¸­</view>
              </view>
            </t-col>
            <t-col span="8">
              <view class="treatment-stat-card recovering">
                <view class="stat-value">{{treatmentStats.recovering}}</view>
                <view class="stat-label">æ¢å¤ä¸­</view>
              </view>
            </t-col>
            <t-col span="8">
              <view class="treatment-stat-card completed">
                <view class="stat-value">{{treatmentStats.completed}}</view>
                <view class="stat-label">æœ¬å‘¨æ²»æ„ˆ</view>
              </view>
            </t-col>
          </t-row>
        </view>
        
        <!-- æ²»ç–—è¿›åº¦åˆ—è¡¨ -->
        <view class="treatment-progress-list">
          <view wx:for="{{treatmentRecords}}" wx:key="id" class="treatment-card">
            <view class="treatment-header">
              <view class="animal-info">
                <text class="animal-id">{{item.animalId}}</text>
                <text class="disease-name">{{item.disease}}</text>
              </view>
              <view class="treatment-status {{item.status}}">
                {{item.statusText}}
              </view>
            </view>
            
            <view class="treatment-progress">
              <view class="progress-info">
                <text class="progress-label">æ²»ç–—è¿›åº¦</text>
                <text class="progress-text">ç¬¬{{item.currentDay}}å¤© / å…±{{item.totalDays}}å¤©</text>
              </view>
              <t-progress 
                percentage="{{item.progressPercentage}}"
                theme="{{item.status === 'treating' ? 'primary' : item.status === 'recovering' ? 'success' : 'warning'}}"
                size="medium"
                class="progress-bar"
              />
            </view>
            
            <view class="treatment-details">
              <view class="detail-item">
                <text class="detail-label">ç”¨è¯:</text>
                <text class="detail-value">{{item.medication}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">å‰‚é‡:</text>
                <text class="detail-value">{{item.dosage}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">è´Ÿè´£äºº:</text>
                <text class="detail-value">{{item.operator}}</text>
              </view>
            </view>
            
            <view class="treatment-actions">
              <t-button size="small" theme="primary" bind:tap="updateTreatment" data-record="{{item}}">
                æ›´æ–°è®°å½•
              </t-button>
              <t-button wx:if="{{item.status === 'treating'}}" size="small" theme="success" bind:tap="markRecovered" data-record="{{item}}">
                æ ‡è®°æ²»æ„ˆ
              </t-button>
            </view>
          </view>
        </view>
      </view>

      <!-- AIå»ºè®® Tab -->
      <view wx:if="{{activeTab === 'ai_advice'}}" class="tab-content">
        <!-- AIåˆ†æè§¦å‘å™¨ -->
        <view class="ai-analysis-trigger">
          <view class="card">
            <view class="card-header">
              <t-icon name="robot" size="32rpx" color="#0052D9" />
              <text class="card-title">AIæ™ºèƒ½åˆ†æ</text>
              <t-button wx:if="{{!aiAdvice.loading}}" size="small" theme="primary" bind:tap="generateAIAdvice">
                {{aiAdvice.result ? 'é‡æ–°åˆ†æ' : 'å¼€å§‹åˆ†æ'}}
              </t-button>
            </view>
            
            <!-- AIåˆ†æè¿›è¡Œä¸­ -->
            <view wx:if="{{aiAdvice.loading}}" class="ai-loading">
              <t-loading theme="spinner" size="40rpx" />
              <text class="loading-text">AIæ­£åœ¨åˆ†æå½“å‰å¼‚å¸¸æƒ…å†µ...</text>
            </view>
            
            <!-- AIåˆ†æç»“æœ -->
            <view wx:elif="{{aiAdvice.result}}" class="ai-results">
              <!-- é£é™©è¯„ä¼° -->
              <view class="risk-assessment">
                <view class="assessment-title">ğŸ¯ é£é™©è¯„ä¼°</view>
                <view class="risk-level {{aiAdvice.result.riskLevel}}">
                  æ•´ä½“é£é™©ç­‰çº§: {{aiAdvice.result.riskLevelText}}
                </view>
                <view class="risk-factors">
                  <text wx:for="{{aiAdvice.result.riskFactors}}" wx:key="index" class="risk-factor">
                    â€¢ {{item}}
                  </text>
                </view>
              </view>
              
              <!-- ç´§æ€¥å¤„ç†å»ºè®® -->
              <view class="urgent-recommendations">
                <view class="recommendation-title">âš¡ ç´§æ€¥å¤„ç†å»ºè®®</view>
                <view class="urgent-actions">
                  <view wx:for="{{aiAdvice.result.urgentActions}}" wx:key="index" class="urgent-action">
                    <view class="action-priority">{{item.priority}}</view>
                    <view class="action-content">
                      <view class="action-title">{{item.title}}</view>
                      <view class="action-description">{{item.description}}</view>
                    </view>
                  </view>
                </view>
              </view>
              
              <!-- æ²»ç–—æ–¹æ¡ˆå»ºè®® -->
              <view class="treatment-recommendations">
                <view class="recommendation-title">ğŸ’Š æ²»ç–—æ–¹æ¡ˆå»ºè®®</view>
                <view wx:for="{{aiAdvice.result.treatmentPlan}}" wx:key="disease" class="treatment-plan">
                  <view class="plan-header">
                    <text class="disease-name">{{item.disease}}</text>
                    <text class="affected-count">å½±å“ {{item.affectedCount}} åª</text>
                  </view>
                  <view class="plan-medications">
                    <view wx:for="{{item.medications}}" wx:for-item="med" wx:key="name" class="medication-item">
                      <view class="med-name">{{med.name}}</view>
                      <view class="med-dosage">{{med.dosage}}</view>
                      <view class="med-priority {{med.priority}}">{{med.priorityText}}</view>
                    </view>
                  </view>
                  <view class="plan-notes">
                    <text wx:for="{{item.notes}}" wx:key="index" class="plan-note">
                      â€¢ {{item}}
                    </text>
                  </view>
                </view>
              </view>
              
              <!-- é¢„é˜²æªæ–½ -->
              <view class="prevention-measures">
                <view class="recommendation-title">ğŸ›¡ï¸ é¢„é˜²æªæ–½</view>
                <view class="prevention-categories">
                  <view wx:for="{{aiAdvice.result.preventionMeasures}}" wx:key="category" class="prevention-category">
                    <view class="category-title">{{item.category}}</view>
                    <view class="category-measures">
                      <text wx:for="{{item.measures}}" wx:for-item="measure" wx:key="index" class="prevention-measure">
                        â€¢ {{measure}}
                      </text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
            
            <!-- æ— åˆ†æç»“æœæ—¶çš„æç¤º -->
            <view wx:else class="ai-empty">
              <view class="empty-icon">ğŸ¤–</view>
              <view class="empty-text">ç‚¹å‡»"å¼€å§‹åˆ†æ"è·å–AIæ™ºèƒ½å»ºè®®</view>
              <view class="empty-desc">åŸºäºå½“å‰å¼‚å¸¸æƒ…å†µè¿›è¡Œæ™ºèƒ½åˆ†æå’Œå¤„ç†å»ºè®®</view>
            </view>
          </view>
        </view>
        
        <!-- å†å²AIå»ºè®® -->
        <view wx:if="{{aiAdviceHistory.length > 0}}" class="ai-history-section">
          <view class="card">
            <view class="card-header">
              <text class="card-title">å†å²AIå»ºè®®</text>
            </view>
            <view class="history-list">
              <view wx:for="{{aiAdviceHistory}}" wx:key="id" class="history-item">
                <view class="history-header">
                  <text class="history-time">{{item.createTime}}</text>
                  <t-tag theme="{{item.adopted ? 'success' : 'default'}}" size="small">
                    {{item.adopted ? 'å·²é‡‡ç”¨' : 'æœªé‡‡ç”¨'}}
                  </t-tag>
                </view>
                <view class="history-content">
                  <text class="history-summary">{{item.summary}}</text>
                </view>
                <view class="history-actions">
                  <t-button size="small" theme="light" bind:tap="viewHistoryDetail" data-item="{{item}}">
                    æŸ¥çœ‹è¯¦æƒ…
                  </t-button>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
      <view style="height: 120rpx;"></view>
    </view>
  </view>
</view>
