<!--pages/employee/employee.wxml-->
<navigation-bar title="员工管理" show-back="{{true}}" bind:back="goBack"></navigation-bar>

<view class="container">
  <!-- 权限检查 -->
  <view wx:if="{{!hasManagePermission && !hasInvitePermission}}" class="no-permission">
    <view class="no-permission-icon">🔒</view>
    <view class="no-permission-text">您没有员工管理权限</view>
    <view class="no-permission-desc">请联系管理员分配相应权限</view>
    <button class="join-btn" bindtap="showJoinOrganization">加入组织</button>
  </view>

  <!-- 主要内容 -->
  <view wx:else class="main-content">
    <!-- 页面标题 -->
    <view class="page-header">
      <text class="page-title">员工列表 ({{totalEmployees}})</text>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <button wx:if="{{hasInvitePermission}}" class="invite-btn" bindtap="goToInviteManagement">
        <text class="icon">➕</text>
        邀请管理
      </button>
      <button class="join-btn" bindtap="showJoinOrganization">
        <text class="icon">🔗</text>
        加入组织
      </button>
    </view>

    <!-- 员工列表 -->
    <view class="employees-section">
      <view wx:if="{{loading}}" class="loading">
        <text>加载中...</text>
      </view>
      
      <view wx:elif="{{employees.length === 0}}" class="empty-state">
        <view class="empty-icon">👥</view>
        <view class="empty-text">暂无员工</view>
        <view class="empty-desc">点击邀请管理创建邀请码</view>
      </view>
      
      <view wx:else class="employee-list">
        <view class="employee-item" wx:for="{{employees}}" wx:key="_id">
          <view class="employee-avatar">
            <image src="{{item.avatarUrl || '/assets/icons/profile.png'}}" mode="aspectFill"></image>
            <view class="status-badge {{item.isActive ? 'active' : 'inactive'}}"></view>
          </view>
          
          <view class="employee-info">
            <view class="employee-name">{{item.nickname || '未设置'}}</view>
            <view class="employee-role">{{item.position || '未设置职位'}} · {{item.department || '未设置部门'}}</view>
            <view class="employee-meta">
              <text class="role-tag {{item.role}}">{{item.role === 'admin' ? '管理员' : item.role === 'employee' ? '员工' : '用户'}}</text>
              <text class="join-time">{{item.createTime}}</text>
            </view>
          </view>
          
          <view wx:if="{{hasManagePermission}}" class="employee-actions">
            <button class="action-btn edit" data-employee="{{item}}" bindtap="editEmployee">编辑</button>
            <button class="action-btn remove" data-employee="{{item}}" bindtap="removeEmployee">移除</button>
          </view>
        </view>
      </view>
    </view>

  </view>
</view>


<!-- 编辑员工对话框 -->
<view wx:if="{{showEditDialog}}" class="dialog-overlay" bindtap="closeDialog">
  <view class="dialog-content" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">编辑员工</text>
      <text class="dialog-close" bindtap="closeDialog">✕</text>
    </view>
    
    <view class="dialog-body">
      <view class="form-group">
        <text class="form-label">部门</text>
        <input class="form-input" placeholder="请输入部门名称" value="{{editForm.department}}" bindinput="onEditDepartmentInput" />
      </view>
      
      <view class="form-group">
        <text class="form-label">职位</text>
        <input class="form-input" placeholder="请输入职位名称" value="{{editForm.position}}" bindinput="onEditPositionInput" />
      </view>
      
      <view class="form-group">
        <text class="form-label">权限设置</text>
        <checkbox-group data-type="edit" bindchange="onPermissionChange">
          <view class="permission-list">
            <label class="permission-item" wx:for="{{permissions}}" wx:key="*this" wx:for-index="permKey" wx:for-item="permName">
              <checkbox value="{{permKey}}" checked="{{editForm.permissions.includes(permKey)}}" />
              <text class="permission-name">{{permName}}</text>
            </label>
          </view>
        </checkbox-group>
      </view>
      
      <view class="form-group">
        <text class="form-label">状态</text>
        <switch checked="{{editForm.isActive}}" bindchange="onEditActiveChange" />
        <text class="switch-label">{{editForm.isActive ? '激活' : '停用'}}</text>
      </view>
    </view>
    
    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeDialog">取消</button>
      <button class="btn-confirm" bindtap="saveEmployeeEdit">保存</button>
    </view>
  </view>
</view>

<!-- 加入组织对话框 -->
<view wx:if="{{showJoinDialog}}" class="dialog-overlay" bindtap="closeDialog">
  <view class="dialog-content" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">加入组织</text>
      <text class="dialog-close" bindtap="closeDialog">✕</text>
    </view>
    
    <view class="dialog-body">
      <view class="form-group">
        <text class="form-label">邀请码</text>
        <input class="form-input" placeholder="请输入8位邀请码" value="{{joinForm.inviteCode}}" bindinput="onJoinCodeInput" maxlength="8" />
      </view>
      
      <view class="join-tip">
        <text class="tip-icon">💡</text>
        <text class="tip-text">请向您的管理员获取邀请码</text>
      </view>
    </view>
    
    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeDialog">取消</button>
      <button class="btn-confirm" bindtap="joinOrganization">加入</button>
    </view>
  </view>
</view>
