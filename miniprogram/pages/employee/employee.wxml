<!--pages/employee/employee.wxml-->
<navigation-bar title="å‘˜å·¥ç®¡ç†" bind:back="goBack"></navigation-bar>

<view class="container">
  <!-- æƒé™æ£€æŸ¥ -->
  <view wx:if="{{!hasManagePermission && !hasInvitePermission}}" class="no-permission">
    <view class="no-permission-icon">ğŸ”’</view>
    <view class="no-permission-text">æ‚¨æ²¡æœ‰å‘˜å·¥ç®¡ç†æƒé™</view>
    <view class="no-permission-desc">è¯·è”ç³»ç®¡ç†å‘˜åˆ†é…ç›¸åº”æƒé™</view>
    <button class="join-btn" bindtap="showJoinOrganization">åŠ å…¥ç»„ç»‡</button>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else class="main-content">
    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <view class="tab-nav">
      <view class="tab-item {{activeTab === 'employees' ? 'active' : ''}}" data-tab="employees" bindtap="switchTab">
        å‘˜å·¥åˆ—è¡¨ ({{totalEmployees}})
      </view>
      <view wx:if="{{hasInvitePermission}}" class="tab-item {{activeTab === 'invites' ? 'active' : ''}}" data-tab="invites" bindtap="switchTab">
        é‚€è¯·è®°å½•
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button wx:if="{{hasInvitePermission}}" class="invite-btn" bindtap="showInviteEmployee">
        <text class="icon">â•</text>
        é‚€è¯·å‘˜å·¥
      </button>
      <button class="join-btn" bindtap="showJoinOrganization">
        <text class="icon">ğŸ”—</text>
        åŠ å…¥ç»„ç»‡
      </button>
    </view>

    <!-- å‘˜å·¥åˆ—è¡¨ -->
    <view wx:if="{{activeTab === 'employees'}}" class="employees-tab">
      <view wx:if="{{loading}}" class="loading">
        <text>åŠ è½½ä¸­...</text>
      </view>
      
      <view wx:elif="{{employees.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ‘¥</view>
        <view class="empty-text">æš‚æ— å‘˜å·¥</view>
        <view class="empty-desc">é‚€è¯·å‘˜å·¥åŠ å…¥æ‚¨çš„ç»„ç»‡</view>
      </view>
      
      <view wx:else class="employee-list">
        <view class="employee-item" wx:for="{{employees}}" wx:key="_id">
          <view class="employee-avatar">
            <image src="{{item.avatarUrl || '/assets/icons/profile.png'}}" mode="aspectFill"></image>
            <view class="status-badge {{item.isActive ? 'active' : 'inactive'}}"></view>
          </view>
          
          <view class="employee-info">
            <view class="employee-name">{{item.nickname || 'æœªè®¾ç½®'}}</view>
            <view class="employee-role">{{item.position || 'æœªè®¾ç½®èŒä½'}} Â· {{item.department || 'æœªè®¾ç½®éƒ¨é—¨'}}</view>
            <view class="employee-meta">
              <text class="role-tag {{item.role}}">{{item.role === 'admin' ? 'ç®¡ç†å‘˜' : item.role === 'employee' ? 'å‘˜å·¥' : 'ç”¨æˆ·'}}</text>
              <text class="join-time">{{item.createTime}}</text>
            </view>
          </view>
          
          <view wx:if="{{hasManagePermission}}" class="employee-actions">
            <button class="action-btn edit" data-employee="{{item}}" bindtap="editEmployee">ç¼–è¾‘</button>
            <button class="action-btn remove" data-employee="{{item}}" bindtap="removeEmployee">ç§»é™¤</button>
          </view>
        </view>
      </view>
    </view>

    <!-- é‚€è¯·è®°å½• -->
    <view wx:if="{{activeTab === 'invites' && hasInvitePermission}}" class="invites-tab">
      <view wx:if="{{loading}}" class="loading">
        <text>åŠ è½½ä¸­...</text>
      </view>
      
      <view wx:elif="{{invites.length === 0}}" class="empty-state">
        <view class="empty-icon">ğŸ“¨</view>
        <view class="empty-text">æš‚æ— é‚€è¯·è®°å½•</view>
        <view class="empty-desc">ç‚¹å‡»é‚€è¯·å‘˜å·¥åˆ›å»ºé‚€è¯·ç </view>
      </view>
      
      <view wx:else class="invite-list">
        <view class="invite-item" wx:for="{{invites}}" wx:key="_id">
          <view class="invite-header">
            <view class="invite-code" data-code="{{item.inviteCode}}" bindtap="copyInviteCode">
              {{item.inviteCode}}
              <text class="copy-hint">ç‚¹å‡»å¤åˆ¶</text>
            </view>
            <view class="invite-status {{item.isUsed ? 'used' : 'pending'}}">
              {{item.isUsed ? 'å·²ä½¿ç”¨' : 'å¾…ä½¿ç”¨'}}
            </view>
          </view>
          
          <view class="invite-info">
            <view class="invite-detail">
              <text class="label">éƒ¨é—¨ï¼š</text>{{item.department || 'æœªè®¾ç½®'}}
            </view>
            <view class="invite-detail">
              <text class="label">èŒä½ï¼š</text>{{item.position || 'æœªè®¾ç½®'}}
            </view>
            <view class="invite-detail">
              <text class="label">åˆ›å»ºæ—¶é—´ï¼š</text>{{item.createTime}}
            </view>
            <view class="invite-detail">
              <text class="label">è¿‡æœŸæ—¶é—´ï¼š</text>{{item.expireTime}}
            </view>
          </view>
          
          <view wx:if="{{item.isUsed}}" class="invite-usage">
            <text class="label">ä½¿ç”¨è€…ï¼š</text>{{item.usedBy}}
            <text class="label">ä½¿ç”¨æ—¶é—´ï¼š</text>{{item.usedTime}}
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- é‚€è¯·å‘˜å·¥å¯¹è¯æ¡† -->
<view wx:if="{{showInviteDialog}}" class="dialog-overlay" bindtap="closeDialog">
  <view class="dialog-content" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">é‚€è¯·å‘˜å·¥</text>
      <text class="dialog-close" bindtap="closeDialog">âœ•</text>
    </view>
    
    <view class="dialog-body">
      <view class="form-group">
        <text class="form-label">éƒ¨é—¨</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥éƒ¨é—¨åç§°" value="{{inviteForm.department}}" bindinput="onInviteDepartmentInput" />
      </view>
      
      <view class="form-group">
        <text class="form-label">èŒä½</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥èŒä½åç§°" value="{{inviteForm.position}}" bindinput="onInvitePositionInput" />
      </view>
      
      <view class="form-group">
        <text class="form-label">æƒé™è®¾ç½®</text>
        <checkbox-group data-type="invite" bindchange="onPermissionChange">
          <view class="permission-list">
            <label class="permission-item" wx:for="{{permissions}}" wx:key="*this" wx:for-index="permKey" wx:for-item="permName">
              <checkbox value="{{permKey}}" checked="{{inviteForm.permissions.includes(permKey)}}" />
              <text class="permission-name">{{permName}}</text>
            </label>
          </view>
        </checkbox-group>
      </view>
      
      <view class="form-group">
        <text class="form-label">æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</text>
        <input class="form-input" type="number" value="{{inviteForm.validDays}}" bindinput="onInviteValidDaysInput" />
      </view>
    </view>
    
    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeDialog">å–æ¶ˆ</button>
      <button class="btn-confirm" bindtap="inviteEmployee">ç”Ÿæˆé‚€è¯·ç </button>
    </view>
  </view>
</view>

<!-- ç¼–è¾‘å‘˜å·¥å¯¹è¯æ¡† -->
<view wx:if="{{showEditDialog}}" class="dialog-overlay" bindtap="closeDialog">
  <view class="dialog-content" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">ç¼–è¾‘å‘˜å·¥</text>
      <text class="dialog-close" bindtap="closeDialog">âœ•</text>
    </view>
    
    <view class="dialog-body">
      <view class="form-group">
        <text class="form-label">éƒ¨é—¨</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥éƒ¨é—¨åç§°" value="{{editForm.department}}" bindinput="onEditDepartmentInput" />
      </view>
      
      <view class="form-group">
        <text class="form-label">èŒä½</text>
        <input class="form-input" placeholder="è¯·è¾“å…¥èŒä½åç§°" value="{{editForm.position}}" bindinput="onEditPositionInput" />
      </view>
      
      <view class="form-group">
        <text class="form-label">æƒé™è®¾ç½®</text>
        <checkbox-group data-type="edit" bindchange="onPermissionChange">
          <view class="permission-list">
            <label class="permission-item" wx:for="{{permissions}}" wx:key="*this" wx:for-index="permKey" wx:for-item="permName">
              <checkbox value="{{permKey}}" checked="{{editForm.permissions.includes(permKey)}}" />
              <text class="permission-name">{{permName}}</text>
            </label>
          </view>
        </checkbox-group>
      </view>
      
      <view class="form-group">
        <text class="form-label">çŠ¶æ€</text>
        <switch checked="{{editForm.isActive}}" bindchange="onEditActiveChange" />
        <text class="switch-label">{{editForm.isActive ? 'æ¿€æ´»' : 'åœç”¨'}}</text>
      </view>
    </view>
    
    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeDialog">å–æ¶ˆ</button>
      <button class="btn-confirm" bindtap="saveEmployeeEdit">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- åŠ å…¥ç»„ç»‡å¯¹è¯æ¡† -->
<view wx:if="{{showJoinDialog}}" class="dialog-overlay" bindtap="closeDialog">
  <view class="dialog-content" catchtap="">
    <view class="dialog-header">
      <text class="dialog-title">åŠ å…¥ç»„ç»‡</text>
      <text class="dialog-close" bindtap="closeDialog">âœ•</text>
    </view>
    
    <view class="dialog-body">
      <view class="form-group">
        <text class="form-label">é‚€è¯·ç </text>
        <input class="form-input" placeholder="è¯·è¾“å…¥8ä½é‚€è¯·ç " value="{{joinForm.inviteCode}}" bindinput="onJoinCodeInput" maxlength="8" />
      </view>
      
      <view class="join-tip">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">è¯·å‘æ‚¨çš„ç®¡ç†å‘˜è·å–é‚€è¯·ç </text>
      </view>
    </view>
    
    <view class="dialog-footer">
      <button class="btn-cancel" bindtap="closeDialog">å–æ¶ˆ</button>
      <button class="btn-confirm" bindtap="joinOrganization">åŠ å…¥</button>
    </view>
  </view>
</view>
