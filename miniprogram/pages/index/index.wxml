<view class="page page-container mobile-container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navigation-bar 
    title="æ™ºæ…§å…»é¹…"
    show-back="{{false}}"
  />

  <scroll-view class="scroll-container" scroll-y>
    <!-- å¤©æ°”æ¨¡å— -->
    <view class="card weather-card {{weather.loading ? 'loading' : ''}}" bindtap="navigateToWeatherDetail">
      <view class="card-content">
        <view class="weather-header">
          <view class="weather-left">
            <view class="weather-icon-wrapper {{weather.loading ? 'loading-animation' : ''}}">
              <text class="weather-emoji">{{weather.emoji || 'ğŸŒ¤ï¸'}}</text>
            </view>
            <view class="weather-info">
              <text class="weather-title">{{weather.loading ? 'è·å–å¤©æ°”ä¸­...' : 'ä»Šæ—¥å¤©æ°”'}}</text>
              <text class="weather-location">{{location.city}}{{location.district}}</text>
              <text wx:if="{{weather.hasError}}" class="weather-error-hint" bindtap="onWeatherRefresh">ç‚¹å‡»é‡è¯•</text>
            </view>
          </view>
          <view class="weather-right">
            <view class="temperature-and-condition">
              <text class="weather-condition {{weather.hasError ? 'error-text' : ''}}">{{weather.condition || 'æ™´'}}</text>
              <text class="temperature {{weather.hasError ? 'error-text' : ''}}">{{weather.temperature}}Â°C</text>
            </view>
          </view>
        </view>
        
        <!-- å¤©æ°”è¯¦ç»†ä¿¡æ¯ -->
        <view class="weather-details">
          <view class="weather-detail-item">
            <text class="detail-label">é£å‘</text>
            <text class="detail-value">{{weather.windDirection}}</text>
          </view>
          <view class="weather-detail-item">
            <text class="detail-label">é£åŠ›</text>
            <text class="detail-value">{{weather.windScale}}</text>
          </view>
          <view class="weather-detail-item">
            <text class="detail-label">ä½“æ„Ÿæ¸©åº¦</text>
            <text class="detail-value">{{weather.feelsLike}}Â°C</text>
          </view>
          <view class="weather-detail-item">
            <text class="detail-label">æ¹¿åº¦</text>
            <text class="detail-value">{{weather.humidity}}%</text>
          </view>
          <view class="weather-detail-item weather-update-item" catchtap="onWeatherRefresh">
            <text class="detail-label">æ›´æ–°æ—¶é—´</text>
            <text class="detail-value">{{weather.updateTime}}</text>
          </view>
        </view>
        
      </view>
    </view>

    <!-- ä»Šæ—¥é¹…ä»· -->
    <view class="card price-card">
      <view class="card-header">
        <text class="card-title">ä»Šæ—¥é¹…ä»·</text>
        <text class="update-time">æ›´æ–°äº {{priceUpdateTime}}</text>
      </view>
      <view class="price-combined-card">
        <view class="price-item success-bg" bindtap="navigateToPriceDetail" data-tab="adult" hover-class="price-item-hover">
          <view class="price-label">æˆé¹…ä»·æ ¼</view>
          <view class="price-value">
            <text class="price-number success-text">Â¥{{goosePrice.adult}}</text>
            <text class="price-unit">/æ–¤</text>
          </view>
          <view class="price-trend {{goosePrice.adultTrend > 0 ? 'trend-down' : 'trend-up'}}">
            <text class="trend-icon">{{goosePrice.adultTrend > 0 ? 'â†‘' : 'â†“'}}</text>
            <text class="trend-value">{{goosePrice.adultChange}}</text>
          </view>
        </view>
        <view class="price-divider"></view>
        <view class="price-item primary-bg" bindtap="navigateToPriceDetail" data-tab="gosling" hover-class="price-item-hover">
          <view class="price-label">é¹…è‹—ä»·æ ¼</view>
          <view class="price-value">
            <text class="price-number primary-text">Â¥{{goosePrice.gosling}}</text>
            <text class="price-unit">/ç¾½</text>
          </view>
          <view class="price-trend {{goosePrice.goslingTrend > 0 ? 'trend-down' : 'trend-up'}}">
            <text class="trend-icon">{{goosePrice.goslingTrend > 0 ? 'â†‘' : 'â†“'}}</text>
            <text class="trend-value">{{goosePrice.goslingChange}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å…»æ®–çŸ¥è¯†å¡ç‰‡ -->
    <view class="card knowledge-card" bind:tap="navigateToKnowledge">
      <view class="card-header">
        <text class="card-title">ğŸ“š å…»æ®–çŸ¥è¯†</text>
        <text class="view-all-link">æŸ¥çœ‹æ›´å¤š â€º</text>
      </view>
      <view wx:if="{{knowledgeList.length > 0}}" class="knowledge-preview">
        <view wx:for="{{knowledgeList}}" wx:key="id" class="knowledge-item">
          <view class="knowledge-dot"></view>
          <text class="knowledge-title">{{item.title}}</text>
        </view>
      </view>
      <view wx:else class="knowledge-empty">
        <text class="empty-hint">ç‚¹å‡»æŸ¥çœ‹å…»æ®–çŸ¥è¯†åº“</text>
      </view>
    </view>

  </scroll-view>

  <!-- ä»»åŠ¡è¯¦æƒ…å¼¹çª— -->
  <bottom-popup
    visible="{{showTaskDetailPopup}}"
    title="ä»»åŠ¡è¯¦æƒ…"
    show-close="{{true}}"
    show-actions="{{selectedTask && !selectedTask.completed}}"
    confirm-text="{{selectedTask && selectedTask.isVaccineTask ? 'å¡«å†™æ¥ç§ä¿¡æ¯' : (selectedTask && selectedTask.isMedicationTask ? 'é¢†å–è¯å“' : (selectedTask && selectedTask.isNutritionTask ? 'é¢†å–è¥å…»å“' : 'å®Œæˆä»»åŠ¡'))}}"
    cancel-text="å…³é—­"
    bind:close="closeTaskDetailPopup"
    bind:confirm="onTaskConfirm"
    bind:cancel="closeTaskDetailPopup"
    bind:visiblechange="onTaskDetailPopupChange"
  >
    <view wx:if="{{selectedTask}}" class="record-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">ä»»åŠ¡åç§°ï¼š</text>
            <text class="info-value">{{selectedTask.title || 'æœªå‘½åä»»åŠ¡'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ä»»åŠ¡ç±»å‹ï¼š</text>
            <text class="info-value">{{selectedTask.typeName || 'æœªåˆ†ç±»'}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.estimatedTime}}">
            <text class="info-label">é¢„è®¡ç”¨æ—¶ï¼š</text>
            <text class="info-value">{{selectedTask.estimatedTime}}åˆ†é’Ÿ</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.duration && selectedTask.dayInSeries}}">
            <text class="info-label">è¿ç»­ä»»åŠ¡ï¼š</text>
            <text class="info-value">ç¬¬{{selectedTask.dayInSeries}}/{{selectedTask.duration}}å¤©</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dosage}}">
            <text class="info-label">ç”¨é‡ï¼š</text>
            <text class="info-value">{{selectedTask.dosage}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.materials && selectedTask.materials.length > 0}}">
            <text class="info-label">æ‰€éœ€ç‰©æ–™ï¼š</text>
            <text class="info-value materials-text">
              <block wx:for="{{selectedTask.materials}}" wx:key="index">
                {{item}}{{index < selectedTask.materials.length - 1 ? 'ã€' : ''}}
              </block>
            </text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.batchNumber}}">
            <text class="info-label">æ‰¹æ¬¡ç¼–å·ï¼š</text>
            <text class="info-value">{{selectedTask.batchNumber}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dayAge}}">
            <text class="info-label">æ—¥é¾„ï¼š</text>
            <text class="info-value">ç¬¬{{selectedTask.dayAge}}æ—¥é¾„</text>
          </view>
          <view class="info-row">
            <text class="info-label">å®ŒæˆçŠ¶æ€ï¼š</text>
            <view class="status-value">
              <t-tag theme="{{selectedTask.completed ? 'success' : 'primary'}}" size="small">
                {{selectedTask.statusText || 'å¾…å®Œæˆ'}}
              </t-tag>
            </view>
          </view>
          <view class="info-row info-row-description" wx:if="{{selectedTask.description}}">
            <text class="info-label">ä»»åŠ¡æè¿°ï¼š</text>
            <text class="info-value note-text">{{selectedTask.description}}</text>
          </view>
          <view class="info-row info-row-notes" wx:if="{{selectedTask.notes}}">
            <text class="info-label">æ³¨æ„äº‹é¡¹ï¼š</text>
            <text class="info-value note-text important-text">{{selectedTask.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- ç–«è‹—æ¥ç§è¡¨å•å¼¹çª— -->
  <bottom-popup
    visible="{{showVaccineFormPopup}}"
    title="ç–«è‹—æ¥ç§ä¿¡æ¯"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="å®Œæˆæ¥ç§"
    cancel-text="å–æ¶ˆ"
    bind:close="closeVaccineFormPopup"
    bind:confirm="submitVaccineForm"
    bind:cancel="closeVaccineFormPopup"
  >
    <view class="vaccine-form-content">
      <!-- å…½åŒ»ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å…½åŒ»ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">æ‰§è¡Œå…½åŒ»</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥å…½åŒ»å§“å"
                 value="{{vaccineFormData.veterinarianName}}"
                 data-field="veterinarianName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">è”ç³»ç”µè¯</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
                 value="{{vaccineFormData.veterinarianContact}}"
                 data-field="veterinarianContact"
                 bindinput="onVaccineFormInput" />
        </view>
      </view>

      <!-- ç–«è‹—ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">ç–«è‹—ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ç–«è‹—åç§°</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç–«è‹—åç§°"
                 value="{{vaccineFormData.vaccineName}}"
                 data-field="vaccineName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">ç”Ÿäº§å‚å®¶</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç”Ÿäº§å‚å®¶"
                 value="{{vaccineFormData.manufacturer}}"
                 data-field="manufacturer"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ‰¹æ¬¡å·</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç–«è‹—æ‰¹æ¬¡å·"
                 value="{{vaccineFormData.batchNumber}}"
                 data-field="batchNumber"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">æ¥ç§å‰‚é‡</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥æ¥ç§å‰‚é‡"
                 value="{{vaccineFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">æ¥ç§æ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="è¯·è¾“å…¥æ¥ç§æ•°é‡"
                 value="{{vaccineFormData.vaccinationCount}}"
                 data-field="vaccinationCount"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ¥ç§æ–¹å¼</text>
          <picker mode="selector" 
                  range="{{vaccineRouteOptions}}"
                  range-key="label"
                  value="{{vaccineFormData.routeIndex}}"
                  bindchange="onVaccineRouteChange">
            <view class="form-input picker-input">
              {{vaccineRouteOptions[vaccineFormData.routeIndex].label}}
            </view>
          </picker>
        </view>
      </view>

      <!-- è´¹ç”¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">è´¹ç”¨ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ç–«è‹—è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥ç–«è‹—è´¹ç”¨"
                 value="{{vaccineFormData.vaccineCost}}"
                 data-field="vaccineCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">å…½åŒ»è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥å…½åŒ»è´¹ç”¨"
                 value="{{vaccineFormData.veterinaryCost}}"
                 data-field="veterinaryCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">å…¶ä»–è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥å…¶ä»–è´¹ç”¨"
                 value="{{vaccineFormData.otherCost}}"
                 data-field="otherCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row total-cost">
          <text class="form-label">æ€»è´¹ç”¨</text>
          <text class="form-value cost-value">{{vaccineFormData.totalCostFormatted}}</text>
        </view>
      </view>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="form-row">
          <textarea class="form-textarea"
                    placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
                    value="{{vaccineFormData.notes}}"
                    data-field="notes"
                    bindinput="onVaccineFormInput"
                    maxlength="500"
                    auto-height />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- ç”¨è¯ç®¡ç†è¡¨å•å¼¹çª— -->
  <bottom-popup
    visible="{{showMedicationFormPopup}}"
    title="ç”¨è¯ç®¡ç†"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="ç¡®è®¤é¢†ç”¨"
    cancel-text="å–æ¶ˆ"
    bind:close="closeMedicationFormPopup"
    bind:confirm="submitMedicationForm"
    bind:cancel="closeMedicationFormPopup"
  >
    <view class="medication-form-content">
      <!-- è¯å“é€‰æ‹© -->
      <view class="form-section">
        <view class="section-title">è¯å“é€‰æ‹©</view>
        <view class="form-row">
          <text class="form-label required">é€‰æ‹©è¯å“</text>
          <picker mode="selector" 
                  range="{{availableMedicines}}"
                  range-key="name"
                  bindchange="onMedicineSelect">
            <view class="form-input picker-input">
              {{selectedMedicine ? selectedMedicine.name : 'è¯·é€‰æ‹©è¯å“'}}
            </view>
          </picker>
          <text wx:if="{{medicationFormErrors.medicineId}}" class="error-text">{{medicationFormErrors.medicineId}}</text>
        </view>
        
        <view wx:if="{{selectedMedicine}}" class="medicine-info">
          <view class="info-item">
            <text class="info-label">å½“å‰åº“å­˜ï¼š</text>
            <text class="info-value">{{selectedMedicine.stock}}{{selectedMedicine.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedMedicine.description}}">
            <text class="info-label">è¯å“è¯´æ˜ï¼š</text>
            <text class="info-value">{{selectedMedicine.description}}</text>
          </view>
        </view>
      </view>

      <!-- ç”¨è¯ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">ç”¨è¯ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ç”¨è¯æ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="è¯·è¾“å…¥ç”¨è¯æ•°é‡"
                 value="{{medicationFormData.quantity > 0 ? medicationFormData.quantity : ''}}"
                 bindinput="onMedicationQuantityInput" />
          <text wx:if="{{medicationFormErrors.quantity}}" class="error-text">{{medicationFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">ç”¨è¯å‰‚é‡</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç”¨è¯å‰‚é‡"
                 value="{{medicationFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onMedicationFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ“ä½œå‘˜</text>
          <view class="form-input readonly-input">{{medicationFormData.operator}}</view>
        </view>
      </view>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥ç”¨è¯å¤‡æ³¨ä¿¡æ¯"
                    value="{{medicationFormData.notes}}"
                    data-field="notes"
                    bindinput="onMedicationFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- è¡¨å•éªŒè¯é”™è¯¯æç¤º -->
      <view wx:if="{{medicationFormErrorList && medicationFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{medicationFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- è¥å…»ç®¡ç†è¡¨å•å¼¹çª— -->
  <bottom-popup
    visible="{{showNutritionFormPopup}}"
    title="è¥å…»ç®¡ç†"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="ç¡®è®¤é¢†ç”¨"
    cancel-text="å–æ¶ˆ"
    bind:close="closeNutritionFormPopup"
    bind:confirm="submitNutritionForm"
    bind:cancel="closeNutritionFormPopup"
  >
    <view class="nutrition-form-content">
      <!-- è¥å…»å“é€‰æ‹© -->
      <view class="form-section">
        <view class="section-title">è¥å…»å“é€‰æ‹©</view>
        <view class="form-row">
          <text class="form-label required">é€‰æ‹©è¥å…»å“</text>
          <picker mode="selector" 
                  range="{{availableNutrition}}"
                  range-key="name"
                  bindchange="onNutritionSelect">
            <view class="form-input picker-input">
              {{selectedNutrition ? selectedNutrition.name : 'è¯·é€‰æ‹©è¥å…»å“'}}
            </view>
          </picker>
          <text wx:if="{{nutritionFormErrors.nutritionId}}" class="error-text">{{nutritionFormErrors.nutritionId}}</text>
        </view>
        
        <view wx:if="{{selectedNutrition}}" class="nutrition-info">
          <view class="info-item">
            <text class="info-label">å½“å‰åº“å­˜ï¼š</text>
            <text class="info-value">{{selectedNutrition.stock}}{{selectedNutrition.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedNutrition.description}}">
            <text class="info-label">è¥å…»å“è¯´æ˜ï¼š</text>
            <text class="info-value">{{selectedNutrition.description}}</text>
          </view>
        </view>
      </view>

      <!-- ä½¿ç”¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">ä½¿ç”¨ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ä½¿ç”¨æ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="è¯·è¾“å…¥ä½¿ç”¨æ•°é‡"
                 value="{{nutritionFormData.quantity > 0 ? nutritionFormData.quantity : ''}}"
                 bindinput="onNutritionQuantityInput" />
          <text wx:if="{{nutritionFormErrors.quantity}}" class="error-text">{{nutritionFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">ä½¿ç”¨å‰‚é‡</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ä½¿ç”¨å‰‚é‡"
                 value="{{nutritionFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onNutritionFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ“ä½œå‘˜</text>
          <view class="form-input readonly-input">{{nutritionFormData.operator}}</view>
        </view>
      </view>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥è¥å…»å“ä½¿ç”¨å¤‡æ³¨ä¿¡æ¯"
                    value="{{nutritionFormData.notes}}"
                    data-field="notes"
                    bindinput="onNutritionFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- è¡¨å•éªŒè¯é”™è¯¯æç¤º -->
      <view wx:if="{{nutritionFormErrorList && nutritionFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{nutritionFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>
</view>