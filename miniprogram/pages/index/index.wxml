<view class="page page-container mobile-container">
  <!-- 新式导航栏 -->
  <navigation-bar 
    title="智慧养鹅"
    show-back="{{false}}"
  />



  <scroll-view class="scroll-container" scroll-y>
    <!-- 天气模块 -->
    <view class="card weather-card {{weather.loading ? 'loading' : ''}}" bindtap="navigateToWeatherDetail">
      <view class="card-content">
        <view class="weather-header">
          <view class="weather-left">
            <view class="weather-icon-wrapper {{weather.loading ? 'loading-animation' : ''}}">
              <text class="weather-emoji">{{weather.emoji || '🌤️'}}</text>
            </view>
            <view class="weather-info">
              <text class="weather-title">{{weather.loading ? '获取天气中...' : '今日天气'}}</text>
              <text class="weather-location">{{location.city}}{{location.district}}</text>
              <view class="weather-condition-wrapper">
                <text class="weather-condition {{weather.hasError ? 'error-text' : ''}}">{{weather.condition || '晴'}}</text>
                <text wx:if="{{weather.hasError}}" class="weather-error-hint" bindtap="onWeatherRefresh">点击重试</text>
              </view>
            </view>
          </view>
          <view class="weather-right">
            <text class="temperature {{weather.hasError ? 'error-text' : ''}}">{{weather.temperature}}°C</text>
            <text class="feels-like">体感 {{weather.feelsLike}}°C</text>
            <text class="humidity">湿度 {{weather.humidity}}%</text>
          </view>
        </view>
        
        <!-- 天气详细信息 -->
        <view class="weather-details">
          <view class="weather-detail-item">
            <text class="detail-label">风向</text>
            <text class="detail-value">{{weather.windDirection}}</text>
          </view>
          <view class="weather-detail-item">
            <text class="detail-label">风力</text>
            <text class="detail-value">{{weather.windScale}}</text>
          </view>
          <view class="weather-detail-item weather-update-item" bindtap="onWeatherRefresh" catchtap="onWeatherRefresh">
            <text class="detail-label">更新时间</text>
            <text class="detail-value">{{weather.updateTime}}</text>
          </view>
        </view>
        
      </view>
    </view>

    <!-- 今日鹅价 -->
    <view class="card price-card">
      <view class="card-header">
        <text class="card-title">📈 今日鹅价</text>
        <text class="update-time">更新于 {{priceUpdateTime}}</text>
      </view>
      <view class="price-grid">
        <view class="price-item success-bg">
          <text class="price-label">成鹅价格</text>
          <text class="price-value success-text">¥{{goosePrice.adult}}<text class="price-unit">/斤</text></text>
          <text class="price-trend {{goosePrice.adultTrend > 0 ? 'trend-up' : 'trend-down'}}">
            {{goosePrice.adultTrend > 0 ? '↑' : '↓'}} {{goosePrice.adultChange}}
          </text>
        </view>
        <view class="price-item primary-bg">
          <text class="price-label">鹅苗价格</text>
          <text class="price-value primary-text">¥{{goosePrice.gosling}}<text class="price-unit">/羽</text></text>
          <text class="price-trend {{goosePrice.goslingTrend > 0 ? 'trend-up' : 'trend-down'}}">
            {{goosePrice.goslingTrend > 0 ? '↑' : '↓'}} {{goosePrice.goslingChange}}
          </text>
        </view>
      </view>
    </view>

    <!-- AI智能建议 -->
    <view class="card ai-advice-card">
      <view class="card-header">
        <text class="card-title">🤖 AI智能建议</text>
        <t-button wx:if="{{!aiAdvice.loading}}" size="small" theme="primary" bind:tap="generateFarmingAdvice" class="refresh-btn">
          {{aiAdvice.result ? '刷新建议' : '生成建议'}}
        </t-button>
      </view>
      
      <!-- AI分析进行中 -->
      <view wx:if="{{aiAdvice.loading}}" class="ai-loading">
        <t-loading theme="spinner" size="40rpx" />
        <text class="loading-text">AI正在分析环境和生产数据...</text>
      </view>
      
      <!-- AI建议结果 -->
      <view wx:elif="{{aiAdvice.result}}" class="ai-advice-content">
        <!-- 综合评级 -->
        <view class="advice-rating">
          <view class="rating-icon {{aiAdvice.result.overallRating.level}}">
            {{aiAdvice.result.overallRating.emoji}}
          </view>
          <view class="rating-content">
            <text class="rating-title">{{aiAdvice.result.overallRating.title}}</text>
            <text class="rating-desc">{{aiAdvice.result.overallRating.description}}</text>
          </view>
          <view class="rating-score {{aiAdvice.result.overallRating.level}}">
            {{aiAdvice.result.overallRating.score}}分
          </view>
        </view>
        
        <!-- 关键建议 -->
        <view class="key-advice">
          <view class="advice-section">
            <text class="section-title">🎯 今日关键建议</text>
            <view class="advice-list">
              <view wx:for="{{aiAdvice.result.keyAdvice}}" wx:key="index" class="advice-item {{item.priority}}">
                <view class="advice-icon">{{item.icon}}</view>
                <view class="advice-content">
                  <text class="advice-title">{{item.title}}</text>
                  <text class="advice-desc">{{item.description}}</text>
                </view>
                <view class="advice-priority">{{item.priorityText}}</view>
              </view>
            </view>
          </view>
          
          <!-- 环境建议 -->
          <view class="advice-section">
            <text class="section-title">🌤️ 环境管理</text>
            <view class="env-advice">
              <view wx:for="{{aiAdvice.result.environmentAdvice}}" wx:key="category" class="env-category">
                <view class="env-header">
                  <text class="env-category-name">{{item.category}}</text>
                  <view class="env-status {{item.status}}">{{item.statusText}}</view>
                </view>
                <text class="env-recommendation">{{item.recommendation}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 快速操作 -->
        <view class="quick-actions">
          <t-button size="small" theme="light" variant="outline" bind:tap="viewDetailedAdvice">
            查看详细建议
          </t-button>
          <t-button size="small" theme="success" variant="outline" bind:tap="addAdviceToTodo">
            添加到待办
          </t-button>
        </view>
      </view>
      
      <!-- 无建议时的提示 -->
      <view wx:else class="ai-advice-empty">
        <view class="empty-icon">🤖</view>
        <text class="empty-text">点击"生成建议"获取AI智能建议</text>
        <text class="empty-desc">基于天气、生产、健康等数据提供个性化建议</text>
      </view>
    </view>

    <!-- 待办事项 -->
    <view class="card todo-card">
      <view class="card-header">
        <text class="card-title">✅ 今日待办</text>
      </view>
      <view class="todo-list">
        <view class="todo-item" wx:for="{{todoList}}" wx:key="id">
          <view class="todo-left">
            <view class="todo-dot {{item.priority}}"></view>
            <text class="todo-text">{{item.content}}</text>
          </view>
          <t-tag theme="{{item.tagTheme || 'default'}}" size="small" class="todo-tag">{{item.priorityText || '普通'}}</t-tag>
        </view>
      </view>
      <t-button theme="light" size="medium" block bind:tap="viewAllTodos" class="view-all-btn">
        查看全部
      </t-button>
    </view>




  </scroll-view>
</view>