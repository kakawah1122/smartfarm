<view class="page page-container mobile-container">
  <!-- æ–°å¼å¯¼èˆªæ  -->
  <navigation-bar 
    title="æ™ºæ…§å…»é¹…"
    show-back="{{false}}"
  />



  <scroll-view class="scroll-container" scroll-y>
    <!-- å¤©æ°”æ¨¡å— -->
    <view class="card weather-card {{weather.loading ? 'loading' : ''}}" bindtap="navigateToWeatherDetail">
      <view class="card-content">
        <view class="weather-header">
          <view class="weather-left">
            <view class="weather-icon-wrapper {{weather.loading ? 'loading-animation' : ''}}">
              <text class="weather-emoji">{{weather.emoji || 'ğŸŒ¤ï¸'}}</text>
            </view>
            <view class="weather-info">
              <text class="weather-title">{{weather.loading ? 'è·å–å¤©æ°”ä¸­...' : 'ä»Šæ—¥å¤©æ°”'}}</text>
              <text class="weather-location">{{location.city}}{{location.district}}</text>
              <text wx:if="{{weather.hasError}}" class="weather-error-hint" bindtap="onWeatherRefresh">ç‚¹å‡»é‡è¯•</text>
            </view>
          </view>
          <view class="weather-right">
            <view class="temperature-and-condition">
              <text class="weather-condition {{weather.hasError ? 'error-text' : ''}}">{{weather.condition || 'æ™´'}}</text>
              <text class="temperature {{weather.hasError ? 'error-text' : ''}}">{{weather.temperature}}Â°C</text>
            </view>
          </view>
        </view>
        
        <!-- å¤©æ°”è¯¦ç»†ä¿¡æ¯ -->
        <view class="weather-details">
          <view class="weather-detail-item">
            <text class="detail-label">é£å‘</text>
            <text class="detail-value">{{weather.windDirection}}</text>
          </view>
          <view class="weather-detail-item">
            <text class="detail-label">é£åŠ›</text>
            <text class="detail-value">{{weather.windScale}}</text>
          </view>
          <view class="weather-detail-item">
            <text class="detail-label">ä½“æ„Ÿæ¸©åº¦</text>
            <text class="detail-value">{{weather.feelsLike}}Â°C</text>
          </view>
          <view class="weather-detail-item">
            <text class="detail-label">æ¹¿åº¦</text>
            <text class="detail-value">{{weather.humidity}}%</text>
          </view>
          <view class="weather-detail-item weather-update-item" catchtap="onWeatherRefresh">
            <text class="detail-label">æ›´æ–°æ—¶é—´</text>
            <text class="detail-value">{{weather.updateTime}}</text>
          </view>
        </view>
        
      </view>
    </view>

    <!-- ä»Šæ—¥é¹…ä»· -->
    <view class="card price-card">
      <view class="card-header">
        <text class="card-title">ğŸ“ˆ ä»Šæ—¥é¹…ä»·</text>
        <text class="update-time">æ›´æ–°äº {{priceUpdateTime}}</text>
      </view>
      <view class="price-grid">
        <view class="price-item success-bg">
          <text class="price-label">æˆé¹…ä»·æ ¼</text>
          <text class="price-value success-text">Â¥{{goosePrice.adult}}<text class="price-unit">/æ–¤</text></text>
          <text class="price-trend {{goosePrice.adultTrend > 0 ? 'trend-up' : 'trend-down'}}">
            {{goosePrice.adultTrend > 0 ? 'â†‘' : 'â†“'}} {{goosePrice.adultChange}}
          </text>
        </view>
        <view class="price-item primary-bg">
          <text class="price-label">é¹…è‹—ä»·æ ¼</text>
          <text class="price-value primary-text">Â¥{{goosePrice.gosling}}<text class="price-unit">/ç¾½</text></text>
          <text class="price-trend {{goosePrice.goslingTrend > 0 ? 'trend-up' : 'trend-down'}}">
            {{goosePrice.goslingTrend > 0 ? 'â†‘' : 'â†“'}} {{goosePrice.goslingChange}}
          </text>
        </view>
      </view>
    </view>

    <!-- AIæ™ºèƒ½å»ºè®® -->
    <view class="card ai-advice-card">
      <view class="card-header">
        <text class="card-title">ğŸ¤– AIæ™ºèƒ½å»ºè®®</text>
        <t-button wx:if="{{!aiAdvice.loading}}" size="small" theme="primary" bind:tap="generateFarmingAdvice" class="refresh-btn ai-button primary-button">
          {{aiAdvice.result ? 'åˆ·æ–°å»ºè®®' : 'ç”Ÿæˆå»ºè®®'}}
        </t-button>
      </view>
      
      <!-- AIåˆ†æè¿›è¡Œä¸­ -->
      <view wx:if="{{aiAdvice.loading}}" class="ai-loading">
        <t-loading theme="spinner" size="40rpx" />
        <text class="loading-text">AIæ­£åœ¨åˆ†æç¯å¢ƒå’Œç”Ÿäº§æ•°æ®...</text>
      </view>
      
      <!-- AIå»ºè®®ç»“æœ -->
      <view wx:elif="{{aiAdvice.result}}" class="ai-advice-content">
        <!-- ç»¼åˆè¯„çº§ -->
        <view class="advice-rating">
          <view class="rating-icon {{aiAdvice.result.overallRating.level}}">
            {{aiAdvice.result.overallRating.emoji}}
          </view>
          <view class="rating-content">
            <text class="rating-title">{{aiAdvice.result.overallRating.title}}</text>
            <text class="rating-desc">{{aiAdvice.result.overallRating.description}}</text>
          </view>
          <view class="rating-score {{aiAdvice.result.overallRating.level}}">
            {{aiAdvice.result.overallRating.score}}åˆ†
          </view>
        </view>
        
        <!-- å…³é”®å»ºè®® -->
        <view class="key-advice">
          <view class="advice-section">
            <text class="section-title">ğŸ¯ ä»Šæ—¥å…³é”®å»ºè®®</text>
            <view class="advice-list">
              <view wx:for="{{aiAdvice.result && aiAdvice.result.keyAdvice ? aiAdvice.result.keyAdvice : []}}" wx:key="index" class="advice-item {{item.priority}}">
                <view class="advice-icon">{{item.icon}}</view>
                <view class="advice-content">
                  <text class="advice-title">{{item.title}}</text>
                  <text class="advice-desc">{{item.description}}</text>
                </view>
                <view class="advice-priority">{{item.priorityText}}</view>
              </view>
            </view>
          </view>
          
          <!-- ç¯å¢ƒå»ºè®® -->
          <view class="advice-section">
            <text class="section-title">ğŸŒ¤ï¸ ç¯å¢ƒç®¡ç†</text>
            <view class="env-advice">
              <view wx:for="{{aiAdvice.result && aiAdvice.result.environmentAdvice ? aiAdvice.result.environmentAdvice : []}}" wx:key="category" class="env-category">
                <view class="env-header">
                  <text class="env-category-name">{{item.category}}</text>
                  <view class="env-status {{item.status}}">{{item.statusText}}</view>
                </view>
                <text class="env-recommendation">{{item.recommendation}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- å¿«é€Ÿæ“ä½œ -->
        <view class="quick-actions">
          <t-button size="small" theme="light" variant="outline" bind:tap="viewDetailedAdvice" class="light-button">
            æŸ¥çœ‹è¯¦ç»†å»ºè®®
          </t-button>
          <t-button size="small" theme="success" variant="outline" bind:tap="addAdviceToTodo" class="success-button">
            æ·»åŠ åˆ°å¾…åŠ
          </t-button>
        </view>
      </view>
      
      <!-- æ— å»ºè®®æ—¶çš„æç¤º -->
      <view wx:else class="ai-advice-empty">
        <view class="empty-icon">ğŸ¤–</view>
        <text class="empty-text">ç‚¹å‡»"ç”Ÿæˆå»ºè®®"è·å–AIæ™ºèƒ½å»ºè®®</text>
        <text class="empty-desc">åŸºäºå¤©æ°”ã€ç”Ÿäº§ã€å¥åº·ç­‰æ•°æ®æä¾›ä¸ªæ€§åŒ–å»ºè®®</text>
      </view>
    </view>

    <!-- å¾…åŠäº‹é¡¹ -->
    <view class="card todo-card">
      <view class="card-header">
        <text class="card-title">âœ… ä»Šæ—¥å¾…åŠ</text>
        <t-button theme="light" size="small" bind:tap="viewAllTodos" class="view-all-btn light-button">
          æŸ¥çœ‹å…¨éƒ¨
        </t-button>
      </view>
      <view class="todo-list">
        <view class="todo-item {{item.completed ? 'completed' : ''}}" wx:for="{{todoList}}" wx:key="id" bind:tap="viewTaskDetail" data-task="{{item}}">
          <view class="todo-left">
            <view class="todo-dot {{item.priority}}"></view>
            <text class="todo-text">{{item.content}}</text>
          </view>
          <t-tag theme="{{item.completed ? 'success' : (item.tagTheme || 'default')}}" size="small" class="todo-tag">{{item.completed ? 'å·²å®Œæˆ' : (item.priorityText || 'æ™®é€š')}}</t-tag>
        </view>
      </view>
    </view>




  </scroll-view>

  <!-- ä»»åŠ¡è¯¦æƒ…å¼¹çª— -->
  <bottom-popup
    visible="{{showTaskDetailPopup}}"
    title="ä»»åŠ¡è¯¦æƒ…"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="{{selectedTask && selectedTask.completed ? 'ç¡®å®š' : 'å®Œæˆä»»åŠ¡'}}"
    cancel-text="{{selectedTask && selectedTask.completed ? '' : 'å…³é—­'}}"
    bind:close="closeTaskDetailPopup"
    bind:confirm="{{selectedTask && selectedTask.completed ? 'closeTaskDetailPopup' : 'completeTaskFromPopup'}}"
    bind:cancel="closeTaskDetailPopup"
    bind:visiblechange="onTaskDetailPopupChange"
  >
    <view wx:if="{{selectedTask}}" class="record-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">ä»»åŠ¡åç§°ï¼š</text>
            <text class="info-value">{{selectedTask.title || 'æœªå‘½åä»»åŠ¡'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ä»»åŠ¡ç±»å‹ï¼š</text>
            <text class="info-value">{{selectedTask.typeName || 'æœªåˆ†ç±»'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ä¼˜å…ˆçº§ï¼š</text>
            <view class="status-value">
              <t-tag 
                theme="{{selectedTask.priorityTheme || 'primary'}}" 
                size="small"
              >
                {{selectedTask.priorityName || 'æ™®é€š'}}
              </t-tag>
            </view>
          </view>
          <view class="info-row" wx:if="{{selectedTask.estimatedTime}}">
            <text class="info-label">é¢„è®¡ç”¨æ—¶ï¼š</text>
            <text class="info-value">{{selectedTask.estimatedTime}}åˆ†é’Ÿ</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.duration && selectedTask.dayInSeries}}">
            <text class="info-label">è¿ç»­ä»»åŠ¡ï¼š</text>
            <text class="info-value">ç¬¬{{selectedTask.dayInSeries}}/{{selectedTask.duration}}å¤©</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dosage}}">
            <text class="info-label">ç”¨é‡ï¼š</text>
            <text class="info-value">{{selectedTask.dosage}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.materials && selectedTask.materials.length > 0}}">
            <text class="info-label">æ‰€éœ€ç‰©æ–™ï¼š</text>
            <text class="info-value materials-text">{{selectedTask.materials.join('ã€')}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.batchNumber}}">
            <text class="info-label">æ‰¹æ¬¡ç¼–å·ï¼š</text>
            <text class="info-value">{{selectedTask.batchNumber}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dayAge}}">
            <text class="info-label">æ—¥é¾„ï¼š</text>
            <text class="info-value">ç¬¬{{selectedTask.dayAge}}æ—¥é¾„</text>
          </view>
          <view class="info-row">
            <text class="info-label">å®ŒæˆçŠ¶æ€ï¼š</text>
            <view class="status-value">
              <t-tag theme="{{selectedTask.completed ? 'success' : 'primary'}}" size="small">
                {{selectedTask.statusText || 'å¾…å®Œæˆ'}}
              </t-tag>
            </view>
          </view>
          <view class="info-row info-row-description" wx:if="{{selectedTask.description}}">
            <text class="info-label">ä»»åŠ¡æè¿°ï¼š</text>
            <text class="info-value note-text">{{selectedTask.description}}</text>
          </view>
          <view class="info-row info-row-notes" wx:if="{{selectedTask.notes}}">
            <text class="info-label">æ³¨æ„äº‹é¡¹ï¼š</text>
            <text class="info-value note-text important-text">{{selectedTask.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  </bottom-popup>
</view>