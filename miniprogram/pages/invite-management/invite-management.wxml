<!-- 邀请管理页面 -->
<view class="page-container">
  <navigation-bar
    title="员工邀请管理"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- 搜索栏 -->
  <view class="search-section">
    <t-search
      value="{{searchKeyword}}"
      placeholder="搜索姓名、手机号或邀请码"
      bind:change="onSearchChange"
      bind:submit="onSearch"
      bind:clear="onSearchClear"
    />
  </view>

  <!-- 统计卡片 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.total}}</text>
        <text class="stat-label">总邀请数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.pending}}</text>
        <text class="stat-label">待使用</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.used}}</text>
        <text class="stat-label">已使用</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.usageRate}}%</text>
        <text class="stat-label">使用率</text>
      </view>
    </view>
  </view>

  <!-- 筛选选项卡 -->
  <view class="filter-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="全部邀请" value="all" />
      <t-tab-panel label="待使用" value="pending" />
      <t-tab-panel label="已使用" value="used" />
      <t-tab-panel label="已过期" value="expired" />
    </t-tabs>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="spinner" size="40rpx" text="加载中..." />
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{inviteList.length === 0}}" class="empty-container">
    <t-empty icon="user-add" description="暂无邀请记录" />
  </view>

  <!-- 邀请列表 -->
  <view wx:else class="content-container">
    <t-cell-group class="invite-list" border="{{true}}">
      <t-cell
        wx:for="{{inviteList}}"
        wx:key="_id"
        title="{{item.inviteCode || ''}}"
        note="{{item.inviteePhone || ''}}"
        description="{{item.department || ''}} {{item.position || ''}}"
      >
        <view slot="right-icon" class="invite-actions">
          <t-tag
            theme="{{getStatusTheme(item.status) || 'default'}}"
            size="small"
            class="status-tag"
          >
            {{item.statusText || '未知状态'}}
          </t-tag>
        </view>
      </t-cell>
    </t-cell-group>

    <!-- 分页加载 -->
    <view wx:if="{{hasMore}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? '加载中...' : '加载更多'}}
      </t-button>
    </view>
  </view>

  <!-- 创建邀请按钮 -->
  <view class="create-button-container">
    <t-button
      theme="primary"
      size="large"
      icon="add"
      bind:tap="showCreateDialog"
      class="create-invite-btn"
    >
      创建邀请
    </t-button>
    
    <!-- 临时的超级管理员设置按钮（调试用） -->
    <t-button
      wx:if="{{!userInfo.isSuper && userInfo.role === 'admin'}}"
      theme="warning"
      size="medium"
      bind:tap="manualSetSuperAdmin"
      class="temp-super-admin-btn"
      style="margin-top: 16rpx;"
    >
      设置超级管理员
    </t-button>
  </view>
</view>

<!-- 邀请详情弹窗 -->
<t-dialog
  visible="{{showInviteDetail}}"
  title="邀请详情"
  confirm-btn="确定"
  bind:confirm="closeInviteDetail"
  bind:cancel="closeInviteDetail"
>
  <view wx:if="{{selectedInvite}}" class="invite-detail">
    <view class="detail-section">
      <view class="detail-item">
        <text class="detail-label">邀请码：</text>
        <text class="detail-value">{{selectedInvite.inviteCode}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">被邀请人：</text>
        <text class="detail-value">{{selectedInvite.inviteeName}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">手机号：</text>
        <text class="detail-value">{{selectedInvite.inviteePhone}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">部门：</text>
        <text class="detail-value">{{selectedInvite.department || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">职位：</text>
        <text class="detail-value">{{selectedInvite.position || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">角色：</text>
        <text class="detail-value">{{getRoleText(selectedInvite.role)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">状态：</text>
        <text class="detail-value">{{selectedInvite.statusText}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">创建时间：</text>
        <text class="detail-value">{{formatTime(selectedInvite.createTime)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">过期时间：</text>
        <text class="detail-value">{{formatTime(selectedInvite.expiryTime)}}</text>
      </view>
      <view wx:if="{{selectedInvite.remark}}" class="detail-item">
        <text class="detail-label">备注：</text>
        <text class="detail-value">{{selectedInvite.remark}}</text>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="invite-actions-section">
      <t-button
        wx:if="{{selectedInvite.status === 'pending'}}"
        theme="warning"
        size="medium"
        bind:tap="revokeInvite"
        class="action-btn"
      >
        撤销邀请
      </t-button>
      <t-button
        wx:if="{{selectedInvite.status === 'pending'}}"
        theme="primary"
        size="medium"
        bind:tap="resendInvite"
        class="action-btn"
      >
        重新发送
      </t-button>
    </view>
  </view>
</t-dialog>

<!-- 创建邀请码弹窗 -->
<view wx:if="{{showCreateDialog}}" class="create-dialog-overlay">
  <view class="create-dialog-mask" bind:tap="closeCreateDialog"></view>
  <view class="create-dialog-content">
    <view class="create-dialog-header">
      <text class="create-dialog-title">创建邀请码</text>
      <text class="create-dialog-close" bind:tap="closeCreateDialog">✕</text>
    </view>
    
    <view class="create-dialog-body">
      <!-- 表单部分（未生成邀请码时显示） -->
      <view wx:if="{{!isInviteGenerated}}">
        <view class="form-tip">
          <text class="tip-icon">💡</text>
          <text class="tip-text">生成邀请码后，被邀请人可使用邀请码自行注册并填写个人信息</text>
        </view>
        
        <view class="form-group">
          <text class="form-label">默认角色</text>
          <picker 
            range="{{roleOptions}}" 
            range-key="label" 
            value="{{selectedRoleIndex[0]}}" 
            bind:change="onRoleChange"
          >
            <view class="picker-container">
              <text class="picker-text">{{roleOptions[selectedRoleIndex[0]].label}}</text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>
        
        <view class="form-group">
          <text class="form-label">有效期</text>
          <picker 
            range="{{expiryOptions}}" 
            range-key="label" 
            value="{{selectedExpiryIndex[0]}}" 
            bind:change="onExpiryDaysChange"
          >
            <view class="picker-container">
              <text class="picker-text">{{expiryOptions[selectedExpiryIndex[0]].label}}</text>
              <text class="picker-arrow">▼</text>
            </view>
          </picker>
        </view>
        
        <view class="form-group">
          <text class="form-label">备注（可选）</text>
          <textarea 
            class="form-textarea" 
            placeholder="可填写此邀请码的用途说明" 
            value="{{newInvite.remark}}" 
            bind:input="onRemarkInput"
            maxlength="100"
          />
        </view>
      </view>

      <!-- 邀请码生成成功显示部分 -->
      <view wx:if="{{isInviteGenerated}}" class="invite-success-content">
        <view class="success-tip">
          <text class="success-icon">🎉</text>
          <text class="success-text">邀请码生成成功！</text>
        </view>
        
        <view class="invite-code-section">
          <text class="invite-code-label">邀请码</text>
          <view class="invite-code-box" bind:tap="copyInviteCode">
            <text class="invite-code-value">{{generatedInviteCode}}</text>
            <text class="copy-hint">点击复制</text>
          </view>
        </view>
        
        <view class="usage-instructions">
          <text class="instructions-title">使用说明</text>
          <text class="instruction-item">• 用户使用此邀请码可自行注册</text>
          <text class="instruction-item">• 注册时可填写个人信息</text>
          <text class="instruction-item">• 邀请码使用后将自动失效</text>
          <text class="instruction-item">• 请妥善保管邀请码信息</text>
        </view>
      </view>
    </view>
    
    <view class="create-dialog-footer">
      <button class="create-btn-cancel" bind:tap="closeCreateDialog">
        {{isInviteGenerated ? '关闭' : '取消'}}
      </button>
      <button 
        wx:if="{{!isInviteGenerated}}" 
        class="create-btn-confirm" 
        bind:tap="createInvite"
      >
        生成邀请码
      </button>
      <button 
        wx:if="{{isInviteGenerated}}" 
        class="create-btn-copy" 
        bind:tap="copyInviteCode"
      >
        📋 复制邀请码
      </button>
    </view>
  </view>
</view>


<!-- 撤销确认弹窗 -->
<t-dialog
  visible="{{showRevokeDialog}}"
  title="撤销邀请"
  confirm-btn="确认撤销"
  cancel-btn="取消"
  bind:confirm="confirmRevoke"
  bind:cancel="closeRevokeDialog"
>
  <view class="revoke-form">
    <view class="revoke-warning">
      <text class="revoke-text">确定要撤销对"{{selectedInvite.inviteeName}}"的邀请吗？</text>
    </view>
    <view class="form-item">
      <text class="form-label">撤销原因</text>
      <t-textarea
        value="{{revokeReason}}"
        placeholder="请输入撤销原因"
        maxlength="200"
        bind:change="onRevokeReasonChange"
      />
    </view>
  </view>
</t-dialog>
