<!--death-record.wxml - 死亡记录页面-->
<view class="page death-record-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="死亡记录"
    show-back="true"
    bind:back="goBack"
  />

  <view class="page-content">
    <!-- 来源提示 -->
    <view class="source-tip" wx:if="{{sourceType !== 'manual'}}">
      <text class="tip-icon">ℹ️</text>
      <text class="tip-text">
        {{sourceType === 'diagnosis' ? '来自AI诊断' : '来自治疗记录'}}
      </text>
    </view>

    <!-- 表单区域 -->
    <view class="form-section">
      <!-- 批次信息 -->
      <view class="form-item">
        <view class="label required">批次编号</view>
        <view class="value">{{formData.batchNumber || '未选择'}}</view>
      </view>

      <!-- 死亡日期 -->
      <view class="form-item {{formErrors.deathDate ? 'error' : ''}}">
        <view class="label required">死亡日期</view>
        <picker 
          mode="date" 
          value="{{formData.deathDate}}" 
          bindchange="onDeathDateChange"
        >
          <view class="picker-value">
            {{formData.deathDate || '请选择日期'}}
          </view>
        </picker>
        <text class="error-text" wx:if="{{formErrors.deathDate}}">{{formErrors.deathDate}}</text>
      </view>

      <!-- 死亡数量 -->
      <view class="form-item {{formErrors.deathCount ? 'error' : ''}}">
        <view class="label required">死亡数量</view>
        <input 
          type="number" 
          placeholder="请输入死亡数量"
          value="{{formData.deathCount}}"
          bindinput="onDeathCountInput"
        />
        <text class="error-text" wx:if="{{formErrors.deathCount}}">{{formErrors.deathCount}}</text>
      </view>

      <!-- 死亡原因 -->
      <view class="form-item {{formErrors.deathCause ? 'error' : ''}}">
        <view class="label required">死亡原因</view>
        <input 
          type="text" 
          placeholder="请输入死亡原因"
          value="{{formData.deathCause}}"
          bindinput="onDeathCauseInput"
        />
        <text class="error-text" wx:if="{{formErrors.deathCause}}">{{formErrors.deathCause}}</text>
      </view>

      <!-- 常见原因快捷选择 -->
      <view class="cause-tags">
        <view 
          class="cause-tag {{formData.deathCause === item ? 'active' : ''}}"
          wx:for="{{deathCauseOptions}}"
          wx:key="*this"
          bindtap="selectDeathCause"
          data-cause="{{item}}"
        >
          {{item}}
        </view>
      </view>

      <!-- 死亡分类 -->
      <view class="form-item">
        <view class="label">死亡分类</view>
        <picker 
          range="{{deathCategoryOptions}}" 
          range-key="label"
          value="{{currentDeathCategoryIndex}}"
          bindchange="onDeathCategoryChange"
        >
          <view class="picker-value">
            {{currentDeathCategoryLabel}}
          </view>
        </picker>
      </view>

      <!-- 处理方式 -->
      <view class="form-item">
        <view class="label">处理方式</view>
        <picker 
          range="{{disposalMethodOptions}}" 
          range-key="label"
          value="{{currentDisposalMethodIndex}}"
          bindchange="onDisposalMethodChange"
        >
          <view class="picker-value">
            {{currentDisposalMethodLabel}}
          </view>
        </picker>
      </view>

      <!-- 描述 -->
      <view class="form-item">
        <view class="label">详细描述</view>
        <textarea 
          placeholder="请输入详细描述（选填）"
          value="{{formData.description}}"
          bindinput="onDescriptionInput"
          maxlength="500"
        />
      </view>
    </view>

    <!-- 解剖分析区域 -->
    <view class="autopsy-section">
      <view class="section-header">
        <text class="section-title">AI解剖分析</text>
        <text class="section-subtitle">上传解剖照片，AI帮您分析死因</text>
      </view>

      <!-- 解剖照片上传 -->
      <view class="autopsy-images">
        <!-- 已上传的图片 -->
        <view 
          class="image-item"
          wx:for="{{autopsyImages}}" 
          wx:key="index"
        >
          <image 
            src="{{item}}"
            mode="aspectFill"
            class="autopsy-image"
            bindtap="onPreviewAutopsyImage"
            data-src="{{item}}"
          />
          <view 
            class="image-delete"
            bindtap="onDeleteAutopsyImage"
            data-index="{{index}}"
          >
            ×
          </view>
        </view>

        <!-- 上传按钮 -->
        <view 
          class="upload-btn"
          wx:if="{{autopsyImages.length < 9}}"
          bindtap="onChooseAutopsyImage"
        >
          <text class="upload-icon">+</text>
          <text class="upload-text">添加照片</text>
          <text class="upload-hint">最多9张</text>
        </view>
      </view>

      <!-- AI分析按钮 -->
      <view class="analyze-section">
        <button 
          class="analyze-btn"
          bindtap="analyzeDeathCause"
          disabled="{{autopsyImages.length === 0 || analyzing}}"
          loading="{{analyzing}}"
        >
          {{analyzing ? 'AI分析中...' : 'AI分析死因'}}
        </button>
      </view>

      <!-- AI分析结果 -->
      <view class="analysis-result" wx:if="{{showAnalysisResult && aiAnalysisResult}}">
        <view class="result-header">
          <text class="result-title">分析结果</text>
          <text class="result-link" bindtap="viewAnalysisDetail">查看详情 ></text>
        </view>
        <view class="result-content">
          <view class="result-item">
            <text class="result-label">疑似死因</text>
            <text class="result-value">{{aiAnalysisResult.primaryDiagnosis.disease}}</text>
          </view>
          <view class="result-item">
            <text class="result-label">置信度</text>
            <text class="result-value confidence">{{aiConfidencePercent}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 财务损失信息 -->
    <view class="financial-section" wx:if="{{financialLoss.totalLoss > 0}}">
      <view class="section-title">财务损失估算</view>
      <view class="loss-grid">
        <view class="loss-item">
          <text class="loss-label">单只成本</text>
          <text class="loss-value">¥{{financialLoss.costPerAnimal.toFixed(2)}}</text>
        </view>
        <view class="loss-item" wx:if="{{financialLoss.treatmentCost > 0}}">
          <text class="loss-label">治疗成本</text>
          <text class="loss-value">¥{{financialLoss.treatmentCost.toFixed(2)}}</text>
        </view>
        <view class="loss-item total">
          <text class="loss-label">总损失</text>
          <text class="loss-value">¥{{financialLoss.totalLoss.toFixed(2)}}</text>
        </view>
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="submit-section">
      <button 
        class="submit-btn" 
        type="primary"
        bindtap="submitDeathRecord"
        disabled="{{!formValid || submitting}}"
        loading="{{submitting}}"
      >
        {{submitting ? '提交中...' : '提交记录'}}
      </button>
    </view>
  </view>
</view>

