<!--profile.wxml - 个人中心页面-->
<view class="page-container">
  <!-- 导航栏 -->
  <navigation-bar 
    title="个人中心"
    show-back="{{false}}"
  />
  
  <!-- 内容区域 -->
  <view class="content-wrapper">
    <scroll-view class="list-container" scroll-y enhanced>
    <!-- 个人信息卡片 -->
    <view class="profile-card">
      <view class="profile-header">
        <!-- 头像 -->
        <view class="avatar-container">
          <button 
            class="avatar-button" 
            open-type="chooseAvatar" 
            bind:chooseavatar="onChooseAvatar"
          >
            <image 
              wx:if="{{userInfo.avatarUrl}}"
              class="avatar-image" 
              src="{{userInfo.avatarUrl}}"
              mode="aspectFill"
            />
            <view wx:else class="avatar-placeholder"></view>
          </button>
        </view>
        
        <!-- 用户信息 -->
        <view class="profile-info">
          <view class="profile-name-row">
            <text class="profile-name" bind:tap="editUserInfo">{{userInfo.name}}</text>
            <text class="role-badge">{{userInfo.role}}</text>
          </view>
          <text class="profile-farm">{{userInfo.farm}}</text>
          <text class="profile-contact">{{userInfo.phone}}</text>
        </view>
      </view>
    </view>
    
    <!-- 我的报销 - 所有用户可见 -->
    <view class="card">
      <view class="card-title-row">
        <text class="card-title">我的报销</text>
        <text class="view-all-btn" bind:tap="viewAllReimbursements">查看全部</text>
      </view>
      
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">¥{{reimbursementStats.monthlyAmount}}</text>
          <text class="stat-label">本月报销</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">¥{{reimbursementStats.totalAmount}}</text>
          <text class="stat-label">累计报销</text>
        </view>
      </view>
      
      <button class="btn-primary" bind:tap="createReimbursement">
        新建报销申请
      </button>
    </view>
    
    <!-- 功能区域整合卡片 -->
    <view class="card function-group-card">
      <!-- 管理功能 - 仅管理员可见 -->
      <view wx:if="{{isAdmin}}" class="function-section">
        <view class="section-title">
          <text>管理功能</text>
        </view>
        
        <view class="function-list">
          <view 
            wx:for="{{adminFunctions}}" 
            wx:key="id"
            class="function-list-item"
            bind:tap="navigateToFunction"
            data-page="{{item.page}}"
          >
            <text class="function-list-label">{{item.label}}</text>
            <text class="function-list-arrow">›</text>
          </view>
        </view>
      </view>
      
      <view wx:if="{{isAdmin}}" class="section-divider"></view>
      
      <!-- 系统设置 -->
      <view class="function-section">
        <view class="section-title">
          <text>系统设置</text>
        </view>
        
        <view class="function-list">
          <view 
            wx:for="{{systemSettings}}" 
            wx:key="id"
            class="function-list-item"
            bind:tap="handleSystemSetting"
            data-action="{{item.action}}"
          >
            <text class="function-list-label">{{item.label}}</text>
            <text class="function-list-arrow">›</text>
          </view>
        </view>
      </view>
      
      <view class="section-divider"></view>
      
      <!-- 退出登录按钮 -->
      <button class="btn-logout" bind:tap="logout">
        退出登录
      </button>
    </view>
    
      <!-- 底部安全区域占位 -->
      <view class="safe-area"></view>
  </scroll-view>
      </view>
      
  <!-- 报销申请弹窗 - 使用 bottom-popup 组件 -->
  <bottom-popup
    visible="{{showReimbursementDialog}}"
    title="新建报销申请"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="提交申请"
    cancel-text="取消"
    bind:close="closeReimbursementDialog"
    bind:confirm="submitReimbursement"
    bind:cancel="closeReimbursementDialog"
  >
        <view class="reimbursement-form">
          <!-- 基础信息 -->
          <view class="form-section">
            <view class="section-header">
              <text class="section-title">基础信息</text>
            </view>
            <view class="form-card">
              <!-- 报销类型 -->
        <picker 
          mode="selector" 
          range="{{reimbursementTypes}}" 
          range-key="name"
          value="{{reimbursementForm.typeIndex}}"
          bind:change="onReimbursementTypeChange"
                class="picker-wrapper"
        >
                <view class="form-item">
                  <text class="form-label required">报销类型</text>
          <view class="picker-value">
            {{reimbursementTypes[reimbursementForm.typeIndex].name}}
                  </view>
          </view>
        </picker>
      
              <!-- 报销金额 -->
      <view class="form-item">
                <text class="form-label required">报销金额</text>
        <input 
          class="form-input" 
          type="digit"
          placeholder="请输入金额" 
          value="{{reimbursementForm.amount}}" 
          bind:input="onAmountInput"
        />
      </view>
      
              <!-- 报销日期 -->
        <picker 
          mode="date" 
          value="{{reimbursementForm.date}}"
          bind:change="onDateChange"
                class="picker-wrapper"
        >
                <view class="form-item">
                  <text class="form-label required">报销日期</text>
          <view class="picker-value">{{reimbursementForm.date}}</view>
                </view>
        </picker>
            </view>
      </view>
      
          <!-- 报销说明 -->
          <view class="form-section">
            <view class="section-title">报销说明</view>
            <view class="form-card">
              <view class="form-item-textarea">
        <textarea 
          class="form-textarea" 
          placeholder="请填写报销说明" 
          value="{{reimbursementForm.description}}" 
          bind:input="onDescriptionInput"
          maxlength="200"
          auto-height
          show-confirm-bar="{{false}}"
        />
      </view>
            </view>
      </view>
      
          <!-- 上传凭证 -->
          <view class="form-section">
            <view class="section-title">上传凭证（最多5张）</view>
            <view class="form-card">
              <view class="form-item-textarea">
        <view class="voucher-upload">
          <view 
            wx:for="{{reimbursementForm.vouchers}}" 
            wx:key="index"
            class="voucher-item"
          >
            <image class="voucher-image" src="{{item.tempPath}}" mode="aspectFill" />
            <view class="voucher-remove" bind:tap="removeVoucher" data-index="{{index}}">×</view>
          </view>
          <view 
            wx:if="{{reimbursementForm.vouchers.length < 5}}"
            class="voucher-add"
            bind:tap="chooseVoucher"
          >
            <text class="add-icon">+</text>
            <text class="add-text">添加凭证</text>
                  </view>
                </view>
          </view>
        </view>
      </view>
        </view>
  </bottom-popup>
      
  <!-- 编辑用户信息弹窗 - 使用 bottom-popup 组件 -->
  <bottom-popup
    visible="{{showEditUserDialog}}"
    title="编辑个人信息"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="保存"
    cancel-text="取消"
    bind:close="closeEditUserDialog"
    bind:confirm="submitEditUserInfo"
    bind:cancel="closeEditUserDialog"
  >
        <view class="edit-user-form">
          <!-- 基础信息 -->
          <view class="form-section">
            <view class="section-header">
              <text class="section-title">基础信息</text>
            </view>
            <view class="form-card">
              <!-- 昵称 -->
              <view class="form-item">
                <text class="form-label required">昵称</text>
                <input 
                  class="form-input" 
                  type="nickname"
                  placeholder="请输入昵称" 
                  value="{{editUserForm.nickName}}" 
                  bind:input="onNickNameInput"
                  maxlength="20"
                />
              </view>
              
              <!-- 手机号 -->
              <view class="form-item">
                <text class="form-label required">手机号</text>
                <input 
                  class="form-input" 
                  type="number"
                  placeholder="请输入手机号" 
                  value="{{editUserForm.phone}}" 
                  bind:input="onPhoneInput"
                  maxlength="11"
                />
              </view>
              
              <!-- 养殖场名称 -->
              <view class="form-item">
                <text class="form-label required">养殖场名称</text>
                <input 
                  class="form-input" 
                  type="text"
                  placeholder="请输入养殖场名称" 
                  value="{{editUserForm.farmName}}" 
                  bind:input="onFarmNameInput"
                  maxlength="30"
                />
              </view>
            </view>
          </view>
        </view>
  </bottom-popup>
  
</view>


