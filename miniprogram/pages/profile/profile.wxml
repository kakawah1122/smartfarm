<!--profile.wxml - 重新设计的个人中心页面-->
<view class="page profile-page">
  <!-- 新式导航栏 -->
  <navigation-bar 
    title="个人中心"
    show-back="true"
    show-menu="true"
    show-record="false"
    bind:back="goBack"
    bind:menu="onSettingsTap"
  />
  
  <scroll-view class="profile-content" scroll-y>
    <!-- 完善信息提示条 -->
    <view wx:if="{{showProfileSetupTip}}" class="profile-setup-tip">
      <view class="tip-content">
        <view class="tip-icon">⚠️</view>
        <view class="tip-text">
          <view class="tip-title">请完善个人信息</view>
          <view class="tip-subtitle">完善后可享受更好的服务体验</view>
        </view>
        <view class="tip-action" bind:tap="editProfile">
          <text class="action-text">立即完善</text>
          <text class="action-arrow">›</text>
        </view>
      </view>
      <view class="tip-close" bind:tap="closeProfileSetupTip">✕</view>
    </view>
    
    <!-- 用户信息卡片 - 保留原设计 -->
    <view class="user-info-section">
      <view class="user-card">
        <view class="user-info">
          <view class="user-avatar">
            <!-- 直接使用微信头像获取按钮，覆盖整个头像区域 -->
            <button 
              class="avatar-button-invisible" 
              open-type="chooseAvatar" 
              bind:chooseavatar="onChooseAvatar"
            >
              <image 
                wx:if="{{userInfo.avatarUrl}}"
                class="avatar-image" 
                src="{{userInfo.avatarUrl}}"
                mode="aspectFill"
              />
              <text wx:else class="default-avatar">👤</text>
            </button>
            
            <!-- 头像编辑提示 -->
            <view class="avatar-edit-tip">点击更换头像</view>
            <!-- 开发环境提示 -->
            <view class="dev-tip" wx:if="{{!userInfo.avatarUrl || userInfo.avatarUrl.includes('assets')}}">
              <text class="dev-tip-text">💡 开发环境请在真机上测试头像功能</text>
            </view>
          </view>
          <view class="user-details">
            <view class="user-name-row">
              <text class="user-name" bind:tap="editProfile" bind:longpress="onLongPressUserName">{{userInfo.name}}</text>
              <text class="user-role-badge">{{userInfo.role}}</text>
            </view>
            <text class="user-farm">{{userInfo.farm}}</text>
          </view>
          <view wx:if="{{notificationStats.unreadCount > 0}}" class="notification-area" bind:tap="showNotifications">
            <view class="notification-badge">{{notificationStats.unreadCount}}</view>
            <view class="notification-icon">🔔</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 功能菜单 -->
    <view class="menu-section">
      <view class="section-title">功能菜单</view>
      <view class="tdesign-card-grid">
        <t-card 
          wx:for="{{menuItems}}" 
          wx:key="id"
          class="tdesign-menu-card"
          bind:tap="navigateToMenu"
          data-item="{{item}}">
          <view class="tdesign-card-content">
            <view class="tdesign-card-info">
              <view class="tdesign-card-title-wrapper">
                <view class="tdesign-card-title">{{item.title}}</view>
                <view wx:if="{{item.badge}}" class="tdesign-card-badge-inline">{{item.badge}}</view>
              </view>
              <view class="tdesign-card-description">{{item.description}}</view>
            </view>
            <view class="tdesign-card-arrow">›</view>
          </view>
        </t-card>
      </view>
    </view>



    <!-- 登录/退出登录 -->
    <view class="auth-section">
      <t-button 
        wx:if="{{!isLoggedIn}}"
        theme="primary" 
        size="large" 
        block 
        bind:tap="goToLogin"
        class="login-btn"
      >
        登录
      </t-button>
      
      <t-button 
        wx:else
        theme="danger" 
        size="large" 
        block 
        bind:tap="logout"
        class="logout-btn"
      >
        退出登录
      </t-button>
    </view>

    <!-- 底部安全区域 -->
    <view class="safe-area-bottom"></view>
  </scroll-view>

  <!-- 编辑个人信息弹窗 -->
  <view wx:if="{{showEditDialog}}" class="edit-dialog-overlay">
    <view class="edit-dialog-mask" bind:tap="closeEditDialog"></view>
    <view class="edit-dialog-content">
      <view class="edit-dialog-header">
        <text class="edit-dialog-title">编辑个人信息</text>
        <text class="edit-dialog-close" bind:tap="closeEditDialog">✕</text>
      </view>
      
      <view class="edit-dialog-body">
        <!-- 快捷操作提示 -->
        <view class="quick-tips">
          <view class="tip-item">
            <text class="tip-icon">💡</text>
            <text class="tip-text">请填写完整信息，昵称框支持微信昵称获取</text>
          </view>
        </view>
        
        <view class="form-group">
          <text class="form-label">昵称 *</text>
          <view class="input-with-button">
            <input 
              class="form-input nickname-input" 
              type="nickname"
              placeholder="请输入您的昵称" 
              value="{{editNickname}}" 
              bind:input="onEditNicknameInput"
              maxlength="20"
            />
          </view>
        </view>
        
        <view class="form-group">
          <text class="form-label">手机号 *</text>
          <input 
            class="form-input" 
            type="number"
            placeholder="请输入手机号" 
            value="{{editPhone}}" 
            bind:input="onEditPhoneInput"
            maxlength="11"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">养殖场名称 *</text>
          <input 
            class="form-input" 
            placeholder="请输入养殖场名称" 
            value="{{editFarmName}}" 
            bind:input="onEditFarmNameInput"
            maxlength="30"
          />
        </view>
      </view>
      
      <view class="edit-dialog-footer">
        <button class="edit-btn-cancel" bind:tap="closeEditDialog">取消</button>
        <button class="edit-btn-confirm" bind:tap="onSaveEditProfile">保存</button>
      </view>
    </view>
  </view>
</view>