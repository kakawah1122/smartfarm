<!--profile.wxml - é‡æ–°è®¾è®¡çš„ä¸ªäººä¸­å¿ƒé¡µé¢-->
<view class="page profile-page">
  <!-- æ–°å¼å¯¼èˆªæ  -->
  <navigation-bar 
    title="ä¸ªäººä¸­å¿ƒ"
    show-back="true"
    show-menu="true"
    show-record="false"
    bind:back="goBack"
    bind:menu="onSettingsTap"
  />
  
  <scroll-view class="profile-content" scroll-y>
    <!-- å®Œå–„ä¿¡æ¯æç¤ºæ¡ -->
    <view wx:if="{{showProfileSetupTip}}" class="profile-setup-tip">
      <view class="tip-content">
        <view class="tip-icon">âš ï¸</view>
        <view class="tip-text">
          <view class="tip-title">è¯·å®Œå–„ä¸ªäººä¿¡æ¯</view>
          <view class="tip-subtitle">å®Œå–„åå¯äº«å—æ›´å¥½çš„æœåŠ¡ä½“éªŒ</view>
        </view>
        <view class="tip-action" bind:tap="editProfile">
          <text class="action-text">ç«‹å³å®Œå–„</text>
          <text class="action-arrow">â€º</text>
        </view>
      </view>
      <view class="tip-close" bind:tap="closeProfileSetupTip">âœ•</view>
    </view>
    
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ - ä¿ç•™åŸè®¾è®¡ -->
    <view class="user-info-section">
      <view class="user-card">
        <view class="user-info">
          <view class="user-avatar">
            <!-- ç›´æ¥ä½¿ç”¨å¾®ä¿¡å¤´åƒè·å–æŒ‰é’®ï¼Œè¦†ç›–æ•´ä¸ªå¤´åƒåŒºåŸŸ -->
            <button 
              class="avatar-button-invisible" 
              open-type="chooseAvatar" 
              bind:chooseavatar="onChooseAvatar"
            >
              <image 
                wx:if="{{userInfo.avatarUrl}}"
                class="avatar-image" 
                src="{{userInfo.avatarUrl}}"
                mode="aspectFill"
              />
              <text wx:else class="default-avatar">ğŸ‘¤</text>
            </button>
            
            <!-- å¤´åƒç¼–è¾‘æç¤º -->
            <view class="avatar-edit-tip">ç‚¹å‡»æ›´æ¢å¤´åƒ</view>
            <!-- å¼€å‘ç¯å¢ƒæç¤º -->
            <view class="dev-tip" wx:if="{{!userInfo.avatarUrl || userInfo.avatarUrl.includes('assets')}}">
              <text class="dev-tip-text">ğŸ’¡ å¼€å‘ç¯å¢ƒè¯·åœ¨çœŸæœºä¸Šæµ‹è¯•å¤´åƒåŠŸèƒ½</text>
            </view>
          </view>
          <view class="user-details">
            <view class="user-name-row">
              <text class="user-name" bind:tap="editProfile" bind:longpress="onLongPressUserName">{{userInfo.name}}</text>
              <text class="user-role-badge">{{userInfo.role}}</text>
            </view>
            <text class="user-farm">{{userInfo.farm}}</text>
          </view>
          <view wx:if="{{notificationStats.unreadCount > 0}}" class="notification-area" bind:tap="showNotifications">
            <view class="notification-badge">{{notificationStats.unreadCount}}</view>
            <view class="notification-icon">ğŸ””</view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½èœå• -->
    <view class="menu-section">
      <view class="section-title">åŠŸèƒ½èœå•</view>
      <view class="tdesign-card-grid">
        <t-card 
          wx:for="{{menuItems || []}}" 
          wx:key="id"
          class="tdesign-menu-card"
          bind:tap="navigateToMenu"
          data-item="{{item}}">
          <view class="tdesign-card-content">
            <view class="tdesign-card-info">
              <view class="tdesign-card-title-wrapper">
                <view class="tdesign-card-title">{{item.title}}</view>
                <view wx:if="{{item.badge}}" class="tdesign-card-badge-inline">{{item.badge}}</view>
              </view>
              <view class="tdesign-card-description">{{item.description}}</view>
            </view>
            <view class="tdesign-card-arrow">â€º</view>
          </view>
        </t-card>
      </view>
    </view>



    <!-- ç™»å½•/é€€å‡ºç™»å½• -->
    <view class="auth-section">
      <t-button 
        wx:if="{{!isLoggedIn}}"
        theme="primary" 
        size="large" 
        block 
        bind:tap="goToLogin"
        class="login-btn"
      >
        ç™»å½•
      </t-button>
      
      <t-button 
        wx:else
        theme="danger" 
        size="large" 
        block 
        bind:tap="logout"
        class="logout-btn"
      >
        é€€å‡ºç™»å½•
      </t-button>
    </view>

    <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
    <view class="safe-area-bottom"></view>
  </scroll-view>

  <!-- ç¼–è¾‘ä¸ªäººä¿¡æ¯å¼¹çª— -->
  <bottom-popup
    visible="{{showEditProfilePopup}}"
    title="ç¼–è¾‘ä¸ªäººä¿¡æ¯"
    show-close="{{true}}"
    show-actions="{{true}}"
    cancel-text="å–æ¶ˆ"
    confirm-text="ä¿å­˜"
    bind:close="closeEditProfilePopup"
    bind:cancel="closeEditProfilePopup"
    bind:confirm="confirmEditProfile"
    bind:visiblechange="onEditProfilePopupChange"
  >
    <view class="edit-profile-content">
      <view class="form-group">
        <text class="form-label">æ˜µç§° *</text>
        <view class="input-container">
          <input 
            class="form-input" 
            type="nickname"
            placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" 
            value="{{editNickname}}" 
            bind:input="onEditNicknameInput"
            maxlength="20"
          />
        </view>
      </view>
      
      <view class="form-group">
        <text class="form-label">æ‰‹æœºå· *</text>
        <view class="input-container">
          <input 
            class="form-input" 
            type="number"
            placeholder="è¯·è¾“å…¥æ‰‹æœºå·" 
            value="{{editPhone}}" 
            bind:input="onEditPhoneInput"
            maxlength="11"
          />
        </view>
      </view>
      
      <view class="form-group">
        <text class="form-label">å…»æ®–åœºåç§° *</text>
        <view class="input-container">
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥å…»æ®–åœºåç§°" 
            value="{{editFarmName}}" 
            bind:input="onEditFarmNameInput"
            maxlength="30"
          />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- ç¼–è¾‘æ˜µç§°å¼¹çª— -->
  <bottom-popup
    visible="{{showEditNicknamePopup}}"
    title="{{popupData.title}}"
    show-close="{{true}}"
    show-actions="{{true}}"
    cancel-text="å–æ¶ˆ"
    confirm-text="ä¿å­˜"
    bind:close="closeEditNicknamePopup"
    bind:cancel="closeEditNicknamePopup"
    bind:confirm="confirmEditNickname"
  >
    <view class="edit-content">
      <view class="content-section">
        <view class="info-text">{{popupData.content}}</view>
        <view class="input-group">
          <text class="input-label">æ–°æ˜µç§°</text>
          <input 
            class="input-field" 
            type="nickname"
            placeholder="è¯·è¾“å…¥æ–°çš„æ˜µç§°" 
            value="{{popupData.inputValue}}" 
            bind:input="onNicknameInput"
            maxlength="20"
          />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- ç¼–è¾‘å…»æ®–åœºåç§°å¼¹çª— -->
  <bottom-popup
    visible="{{showEditFarmPopup}}"
    title="{{popupData.title}}"
    show-close="{{true}}"
    show-actions="{{true}}"
    cancel-text="å–æ¶ˆ"
    confirm-text="ä¿å­˜"
    bind:close="closeEditFarmPopup"
    bind:cancel="closeEditFarmPopup"
    bind:confirm="confirmEditFarm"
  >
    <view class="edit-content">
      <view class="content-section">
        <view class="info-text">{{popupData.content}}</view>
        <view class="input-group">
          <text class="input-label">æ–°åç§°</text>
          <input 
            class="input-field" 
            placeholder="è¯·è¾“å…¥æ–°çš„å…»æ®–åœºåç§°" 
            value="{{popupData.inputValue}}" 
            bind:input="onFarmNameInput"
            maxlength="30"
          />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- é€€å‡ºç™»å½•ç¡®è®¤å¼¹çª— -->
  <bottom-popup
    visible="{{showLogoutConfirmPopup}}"
    title="{{popupData.title}}"
    show-close="{{true}}"
    show-actions="{{true}}"
    cancel-text="å–æ¶ˆ"
    confirm-text="ç¡®è®¤é€€å‡º"
    bind:close="closeLogoutPopup"
    bind:cancel="closeLogoutPopup"
    bind:confirm="confirmLogout"
  >
    <view class="confirm-content">
      <view class="content-section">
        <view class="warning-icon">âš ï¸</view>
        <view class="warning-text">{{popupData.content}}</view>
      </view>
    </view>
  </bottom-popup>

</view>