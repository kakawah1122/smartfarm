<!--profile.wxml - ä¸ªäººä¸­å¿ƒé¡µé¢-->
<view class="page profile-page">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar 
    title="ä¸ªäººä¸­å¿ƒ"
    show-back="{{false}}"
  />
  
  <scroll-view class="scroll-container" scroll-y>
    <!-- å¼€å‘è°ƒè¯•ï¼šè§’è‰²åˆ‡æ¢æŒ‰é’® -->
    <view class="role-switch-container">
      <button class="role-switch-btn" bind:tap="toggleAdminRole">
        <text class="role-switch-icon">{{isAdmin ? 'ğŸ‘¨â€ğŸ’¼' : 'ğŸ‘¤'}}</text>
        <text class="role-switch-text">{{isAdmin ? 'ç®¡ç†å‘˜æ¨¡å¼' : 'æ™®é€šç”¨æˆ·æ¨¡å¼'}}</text>
      </button>
    </view>
    
    <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
    <view class="profile-card">
      <view class="profile-header">
        <!-- å¤´åƒ -->
        <view class="avatar-container">
          <button 
            class="avatar-button" 
            open-type="chooseAvatar" 
            bind:chooseavatar="onChooseAvatar"
          >
            <image 
              wx:if="{{userInfo.avatarUrl}}"
              class="avatar-image" 
              src="{{userInfo.avatarUrl}}"
              mode="aspectFill"
            />
            <view wx:else class="avatar-placeholder"></view>
          </button>
        </view>
        
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="profile-info">
          <view class="profile-name-row">
            <text class="profile-name">{{userInfo.name}}</text>
            <text class="role-badge">{{userInfo.role}}</text>
          </view>
          <text class="profile-farm">{{userInfo.farm}}</text>
          <text class="profile-contact">{{userInfo.phone}}</text>
        </view>
      </view>
    </view>
    
    <!-- æˆ‘çš„æŠ¥é”€ - æ‰€æœ‰ç”¨æˆ·å¯è§ -->
    <view class="card">
      <view class="card-title-row">
        <text class="card-title">æˆ‘çš„æŠ¥é”€</text>
        <text class="view-all-btn" bind:tap="viewAllReimbursements">æŸ¥çœ‹å…¨éƒ¨</text>
      </view>
      
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">Â¥{{reimbursementStats.monthlyAmount}}</text>
          <text class="stat-label">æœ¬æœˆæŠ¥é”€</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">Â¥{{reimbursementStats.totalAmount}}</text>
          <text class="stat-label">ç´¯è®¡æŠ¥é”€</text>
        </view>
      </view>
      
      <button class="btn-primary" bind:tap="createReimbursement">
        æ–°å»ºæŠ¥é”€ç”³è¯·
      </button>
    </view>
    
    <!-- åŠŸèƒ½åŒºåŸŸæ•´åˆå¡ç‰‡ -->
    <view class="card function-group-card">
      <!-- ç®¡ç†åŠŸèƒ½ - ä»…ç®¡ç†å‘˜å¯è§ -->
      <view wx:if="{{isAdmin}}" class="function-section">
        <view class="section-title">
          <text>ç®¡ç†åŠŸèƒ½</text>
        </view>
        
        <view class="function-list">
          <view 
            wx:for="{{adminFunctions}}" 
            wx:key="id"
            class="function-list-item"
            bind:tap="navigateToFunction"
            data-page="{{item.page}}"
          >
            <text class="function-list-label">{{item.label}}</text>
            <text class="function-list-arrow">â€º</text>
          </view>
        </view>
      </view>
      
      <view wx:if="{{isAdmin}}" class="section-divider"></view>
      
      <!-- ç³»ç»Ÿè®¾ç½® -->
      <view class="function-section">
        <view class="section-title">
          <text>ç³»ç»Ÿè®¾ç½®</text>
        </view>
        
        <view class="function-list">
          <view 
            wx:for="{{systemSettings}}" 
            wx:key="id"
            class="function-list-item"
            bind:tap="handleSystemSetting"
            data-action="{{item.action}}"
          >
            <text class="function-list-label">{{item.label}}</text>
            <text class="function-list-arrow">â€º</text>
          </view>
        </view>
      </view>
      
      <view class="section-divider"></view>
      
      <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
      <button class="btn-logout" bind:tap="logout">
        é€€å‡ºç™»å½•
      </button>
    </view>
    
    <!-- å®‰å…¨åŒºåŸŸ -->
    <view class="safe-area-bottom"></view>
  </scroll-view>
  
  <!-- æŠ¥é”€ç”³è¯·å¼¹çª— - ä½¿ç”¨åŸç”Ÿå®ç° -->
  <view wx:if="{{showReimbursementDialog}}" class="popup-mask" catchtap="closeReimbursementDialog">
    <view class="popup-container reimbursement-popup" catchtap="stopPropagation">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="popup-header">
        <text class="header-title">æ–°å»ºæŠ¥é”€ç”³è¯·</text>
        <text class="header-close" catchtap="closeReimbursementDialog">âœ•</text>
      </view>
      
      <!-- å¼¹çª—å†…å®¹ -->
      <scroll-view class="popup-content" scroll-y>
        <view class="reimbursement-form">
      <view class="form-item">
        <text class="form-label">æŠ¥é”€ç±»å‹ *</text>
        <picker 
          mode="selector" 
          range="{{reimbursementTypes}}" 
          range-key="name"
          value="{{reimbursementForm.typeIndex}}"
          bind:change="onReimbursementTypeChange"
        >
          <view class="picker-value">
            {{reimbursementTypes[reimbursementForm.typeIndex].name}}
          </view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">æŠ¥é”€é‡‘é¢ *</text>
        <input 
          class="form-input" 
          type="digit"
          placeholder="è¯·è¾“å…¥é‡‘é¢" 
          value="{{reimbursementForm.amount}}" 
          bind:input="onAmountInput"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">æŠ¥é”€æ—¥æœŸ *</text>
        <picker 
          mode="date" 
          value="{{reimbursementForm.date}}"
          bind:change="onDateChange"
        >
          <view class="picker-value">{{reimbursementForm.date}}</view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">æŠ¥é”€è¯´æ˜ *</text>
        <textarea 
          class="form-textarea" 
          placeholder="è¯·å¡«å†™æŠ¥é”€è¯´æ˜" 
          value="{{reimbursementForm.description}}" 
          bind:input="onDescriptionInput"
          maxlength="200"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">è¯¦ç»†è¯´æ˜</text>
        <textarea 
          class="form-textarea" 
          placeholder="é€‰å¡«" 
          value="{{reimbursementForm.detail}}" 
          bind:input="onDetailInput"
          maxlength="500"
        />
      </view>
      
      <view class="form-item">
        <text class="form-label">ä¸Šä¼ å‡­è¯ï¼ˆæœ€å¤š5å¼ ï¼‰</text>
        <view class="voucher-upload">
          <view 
            wx:for="{{reimbursementForm.vouchers}}" 
            wx:key="index"
            class="voucher-item"
          >
            <image class="voucher-image" src="{{item.tempPath}}" mode="aspectFill" />
            <view class="voucher-remove" bind:tap="removeVoucher" data-index="{{index}}">Ã—</view>
          </view>
          <view 
            wx:if="{{reimbursementForm.vouchers.length < 5}}"
            class="voucher-add"
            bind:tap="chooseVoucher"
          >
            <text class="add-icon">+</text>
            <text class="add-text">æ·»åŠ å‡­è¯</text>
          </view>
        </view>
      </view>
        </view>
      </scroll-view>
      
      <!-- å¼¹çª—åº•éƒ¨æ“ä½œæŒ‰é’® -->
      <view class="popup-footer">
        <button class="btn-cancel" catchtap="closeReimbursementDialog">å–æ¶ˆ</button>
        <button class="btn-confirm" catchtap="submitReimbursement">æäº¤ç”³è¯·</button>
      </view>
    </view>
  </view>
  
</view>


