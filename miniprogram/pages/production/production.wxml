<!--production.wxml - é‡æ–°è®¾è®¡çš„ç”Ÿäº§ç®¡ç†é¡µé¢-->
<view class="page page-container">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navigation-bar 
    title="ç”Ÿäº§ç®¡ç†"
    show-back="true"
    show-menu="true"
    show-record="false"
    bind:back="goBack"
    bind:menu="onMenuTap"
  />

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    <!-- Tab å¯¼èˆª -->
    <t-tabs 
      value="{{activeTab}}" 
      bind:change="onTabChange" 
      theme="line" 
      class="main-tabs"
      sticky
      sticky-offset="{{navBarHeight}}"
    >
      <t-tab-panel label="å…¥æ ç®¡ç†" value="entry" />
      <t-tab-panel label="å‡ºæ ç®¡ç†" value="exit" />
      <t-tab-panel label="ç‰©æ–™ç®¡ç†" value="material" />
    </t-tabs>

    <!-- Tab å†…å®¹åŒºåŸŸ -->
    <view class="tab-container">
      <!-- å…¥æ ç®¡ç† -->
      <view wx:if="{{activeTab === 'entry'}}" class="tab-content">
        <!-- æ•°æ®æ¦‚è§ˆ -->
        <view class="stats-section">
          <t-row gutter="16" class="overview-stats">
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-primary">
                  <view class="stat-value">{{entryStats.total}}</view>
                  <view class="stat-label">å…¥æ æ€»æ•°(ç¾½)</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-success">
                  <view class="stat-value">{{entryStats.stockQuantity}}</view>
                  <view class="stat-label">å­˜æ æ•°é‡</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-warning">
                  <view class="stat-value">{{entryStats.batches}}</view>
                  <view class="stat-label">å…¥æ æ‰¹æ¬¡</view>
                </view>
              </t-card>
            </t-col>
          </t-row>
        </view>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <view class="quick-action">
          <t-row gutter="16">
            <t-col span="12">
              <t-button theme="primary" block icon="add" bind:tap="addEntry">
                æ–°å¢å…¥æ è®°å½•
              </t-button>
            </t-col>
            <t-col span="12">
              <t-button theme="light" variant="outline" block icon="camera" bind:tap="startAICount">
                ğŸ¤– AIæ™ºèƒ½ç›˜ç‚¹
              </t-button>
            </t-col>
          </t-row>
        </view>

        <!-- AIç›˜ç‚¹åŠŸèƒ½åŒºåŸŸ -->
        <view wx:if="{{aiCount.active}}" class="ai-count-section">
          <view class="card ai-count-card">
            <view class="card-header">
              <t-icon name="robot" size="32rpx" color="#0052D9" />
              <text class="card-title">AIæ™ºèƒ½ç›˜ç‚¹</text>
              <t-icon wx:if="{{!aiCount.loading && !aiCount.result}}" name="close" size="28rpx" color="#999" bind:tap="closeAICount" class="close-btn" />
            </view>
            
            <!-- ç›˜ç‚¹æ“ä½œåŒºåŸŸ -->
            <view wx:if="{{!aiCount.result}}" class="count-operation">
              <!-- æ‹ç…§åŒºåŸŸ -->
              <view class="camera-section">
                <view wx:if="{{!aiCount.imageUrl}}" class="camera-placeholder" bind:tap="takePhoto">
                  <t-icon name="camera" size="80rpx" color="#0052D9" />
                  <text class="placeholder-text">ç‚¹å‡»æ‹ç…§</text>
                  <text class="placeholder-desc">è¯·å¯¹å‡†é¹…ç¾¤æ‹æ‘„æ¸…æ™°ç…§ç‰‡</text>
                </view>
                
                <view wx:else class="photo-preview">
                  <image src="{{aiCount.imageUrl}}" mode="aspectFit" class="preview-image" />
                  <view class="photo-actions">
                    <t-button size="small" theme="light" bind:tap="retakePhoto">é‡æ–°æ‹ç…§</t-button>
                    <t-button size="small" theme="primary" bind:tap="analyzeImage" loading="{{aiCount.loading}}" disabled="{{aiCount.loading}}">
                      {{aiCount.loading ? 'AIåˆ†æä¸­...' : 'å¼€å§‹è¯†åˆ«'}}
                    </t-button>
                  </view>
                </view>
              </view>
              
              <!-- æ‹æ‘„å»ºè®® -->
              <view class="shooting-tips">
                <text class="tips-title">ğŸ“¸ æ‹æ‘„å»ºè®®</text>
                <view class="tips-list">
                  <text class="tip-item">â€¢ é€‰æ‹©å…‰çº¿å……è¶³çš„ç¯å¢ƒ</text>
                  <text class="tip-item">â€¢ å°½é‡åŒ…å«å®Œæ•´çš„é¹…ç¾¤</text>
                  <text class="tip-item">â€¢ é¿å…è¿‡åº¦æ‹¥æŒ¤æˆ–é®æŒ¡</text>
                  <text class="tip-item">â€¢ ä¿æŒç›¸æœºç¨³å®šæ¸…æ™°</text>
                </view>
              </view>
            </view>
            
            <!-- è¯†åˆ«ç»“æœ -->
            <view wx:if="{{aiCount.result}}" class="count-result">
              <view class="result-header">
                <t-icon name="check-circle" size="32rpx" color="#52c41a" />
                <text class="result-title">è¯†åˆ«å®Œæˆ</text>
                <text class="confidence-badge">ç½®ä¿¡åº¦ {{aiCount.result.confidence}}%</text>
              </view>
              
              <view class="result-content">
                <!-- ä¸»è¦ç»“æœ -->
                <view class="main-result">
                  <view class="count-display">
                    <text class="count-number">{{aiCount.result.totalCount}}</text>
                    <text class="count-unit">åª</text>
                  </view>
                  <text class="count-label">è¯†åˆ«åˆ°çš„é¹…ç¾¤æ•°é‡</text>
                </view>
                
                <!-- è¯¦ç»†ä¿¡æ¯ -->
                <view wx:if="{{aiCount.result.regions && aiCount.result.regions.length > 0}}" class="result-details">
                  <view class="detail-item">
                    <text class="detail-label">æ£€æµ‹åŒºåŸŸï¼š</text>
                    <text class="detail-value">{{aiCount.result.regions.length}} ä¸ª</text>
                  </view>
                </view>
                
                <!-- å¼‚å¸¸æé†’ -->
                <view wx:if="{{aiCount.result.abnormalDetection && aiCount.result.abnormalDetection.suspiciousAnimals > 0}}" class="abnormal-alert">
                  <view class="alert-content">
                    <t-icon name="error-circle" size="24rpx" color="#ff4d4f" />
                    <text class="alert-text">å‘ç° {{aiCount.result.abnormalDetection.suspiciousAnimals}} åªç–‘ä¼¼å¼‚å¸¸ä¸ªä½“</text>
                  </view>
                  <view wx:if="{{aiCount.result.abnormalDetection.healthConcerns.length > 0}}" class="health-concerns">
                    <text wx:for="{{aiCount.result.abnormalDetection.healthConcerns}}" wx:key="index" class="concern-item">
                      â€¢ {{item}}
                    </text>
                  </view>
                </view>
                
                <!-- è¡¥å……å»ºè®® -->
                <view wx:if="{{aiCount.result.suggestions && aiCount.result.suggestions.length > 0}}" class="suggestions">
                  <text class="suggestions-title">ğŸ’¡ å»ºè®®</text>
                  <view wx:for="{{aiCount.result.suggestions}}" wx:key="index" class="suggestion-item">
                    â€¢ {{item}}
                  </view>
                </view>
              </view>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <view class="result-actions">
                <t-button theme="primary" size="medium" bind:tap="saveCountRecord">
                  ä¿å­˜ç›˜ç‚¹è®°å½•
                </t-button>
                <t-button theme="light" variant="outline" size="medium" bind:tap="restartCount">
                  é‡æ–°ç›˜ç‚¹
                </t-button>
              </view>
            </view>
          </view>
        </view>

        <!-- è®°å½•åˆ—è¡¨ -->
        <view class="list-section">
          <view class="card list-card">
            <view class="card-header">
              <text class="card-title">æœ€è¿‘å…¥æ è®°å½•</text>
            </view>
            <view class="records-container">
              <!-- ç©ºçŠ¶æ€æ˜¾ç¤º -->
              <view wx:if="{{entryRecords.length === 0 && !loading}}" class="empty-state">
                <t-empty icon="file" description="æš‚æ— å…¥æ è®°å½•">
                  <t-button theme="primary" size="small" bind:tap="addEntry">
                    ç«‹å³æ·»åŠ 
                  </t-button>
                </t-empty>
              </view>
              
              <!-- è®°å½•åˆ—è¡¨ -->
              <view wx:for="{{entryRecords}}" wx:key="id" 
                    class="record-item">
                <view class="record-main">
                  <view class="record-header">
                    <text class="record-location">{{item.displayTitle}}</text>
                    <t-tag theme="{{item.status === 'å·²å®Œæˆ' ? 'success' : 'warning'}}" size="small" class="record-status-tag">{{item.status}}</t-tag>
                  </view>
                  <view class="record-content">
                    <text class="record-symptoms">{{item.supplier}} â€¢ {{item.quantity}}ç¾½</text>
                    <view class="record-date-tag">{{item.entryDate || item.date}}</view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- å‡ºæ ç®¡ç† -->
      <view wx:if="{{activeTab === 'exit'}}" class="tab-content">
        <!-- æ•°æ®æ¦‚è§ˆ -->
        <view class="stats-section">
          <t-row gutter="16" class="overview-stats">
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-success">
                  <view class="stat-value">{{exitStats.total}}</view>
                  <view class="stat-label">å‡ºæ æ€»æ•°(ç¾½)</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-primary">
                  <view class="stat-value">{{exitStats.avgWeight}}æ–¤</view>
                  <view class="stat-label">å¹³å‡é‡é‡</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-success">
                  <view class="stat-value">{{exitStats.batches}}</view>
                  <view class="stat-label">å‡ºæ æ‰¹æ¬¡</view>
                </view>
              </t-card>
            </t-col>
          </t-row>
        </view>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <view class="quick-action">
          <t-button theme="primary" block icon="add" bind:tap="addExit">
            æ–°å¢å‡ºæ è®°å½•
          </t-button>
        </view>

        <!-- è®°å½•åˆ—è¡¨ -->
        <view class="list-section">
          <view class="card list-card">
            <view class="card-header">
              <text class="card-title">æœ€è¿‘å‡ºæ è®°å½•</text>
            </view>
            <view class="records-container">
              <!-- ç©ºçŠ¶æ€æ˜¾ç¤º -->
              <view wx:if="{{exitRecords.length === 0 && !loading}}" class="empty-state">
                <t-empty icon="file" description="æš‚æ— å‡ºæ è®°å½•">
                  <t-button theme="primary" size="small" bind:tap="addExit">
                    ç«‹å³æ·»åŠ 
                  </t-button>
                </t-empty>
              </view>
              
              <!-- è®°å½•åˆ—è¡¨ -->
              <view wx:for="{{exitRecords}}" wx:key="id" 
                    class="record-item">
                <view class="record-main">
                  <view class="record-header">
                    <text class="record-location">{{item.displayTitle}}</text>
                    <t-tag theme="{{item.status === 'å·²äº¤ä»˜' ? 'success' : 'primary'}}" size="small" class="record-status-tag">{{item.status}}</t-tag>
                  </view>
                  <view class="record-content">
                    <text class="record-symptoms">{{item.customer}} â€¢ {{item.quantity}}ç¾½ â€¢ å¹³å‡{{item.avgWeight}}æ–¤</text>
                    <view class="record-date-tag">{{item.exitDate || item.date}}</view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç‰©æ–™ç®¡ç† -->
      <view wx:if="{{activeTab === 'material'}}" class="tab-content">
        <!-- åº“å­˜çŠ¶æ€ - å››å®«æ ¼å¸ƒå±€ -->
        <view class="stats-section">
          <t-grid column="2" class="material-grid">
            <!-- é¥²æ–™åº“å­˜ -->
            <t-grid-item text="é¥²æ–™åº“å­˜" bind:click="viewFeedInventory" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.feedDetails.totalCount}}ç§ç‰©æ–™</view>
                <view class="grid-status {{materialStats.feedDetails.status}}">
                  {{materialStats.feedDetails.statusText}}
                </view>
                <view class="grid-desc">{{materialStats.feedDetails.description}}</view>
              </view>
            </t-grid-item>
            
            <!-- è¯å“åº“å­˜ -->
            <t-grid-item text="è¯å“åº“å­˜" bind:click="viewMedicineInventory" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.medicineDetails.totalCount}}ç§ç‰©æ–™</view>
                <view class="grid-status {{materialStats.medicineDetails.status}}">
                  {{materialStats.medicineDetails.statusText}}
                </view>
                <view class="grid-desc">{{materialStats.medicineDetails.description}}</view>
              </view>
            </t-grid-item>

            <!-- è®¾å¤‡ç‰©æ–™ -->
            <t-grid-item text="è®¾å¤‡ç‰©æ–™" bind:click="viewEquipmentInventory" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.equipmentDetails.totalCount}}ç§ç‰©æ–™</view>
                <view class="grid-status {{materialStats.equipmentDetails.status}}">
                  {{materialStats.equipmentDetails.statusText}}
                </view>
                <view class="grid-desc">{{materialStats.equipmentDetails.description}}</view>
              </view>
            </t-grid-item>

            <!-- æ€»è§ˆç»Ÿè®¡ -->
            <t-grid-item text="åº“å­˜æ€»è§ˆ" bind:click="viewInventoryDetail" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.feedDetails.totalCount + materialStats.medicineDetails.totalCount + materialStats.equipmentDetails.totalCount}}ç§ç‰©æ–™</view>
                <view class="grid-status {{(materialStats.feedDetails.status === 'critical' || materialStats.medicineDetails.status === 'critical' || materialStats.equipmentDetails.status === 'critical') ? 'critical' : (materialStats.feedDetails.status === 'warning' || materialStats.medicineDetails.status === 'warning' || materialStats.equipmentDetails.status === 'warning') ? 'warning' : 'normal'}}">
                  {{(materialStats.feedDetails.status === 'critical' || materialStats.medicineDetails.status === 'critical' || materialStats.equipmentDetails.status === 'critical') ? 'éœ€è¦å…³æ³¨' : (materialStats.feedDetails.status === 'warning' || materialStats.medicineDetails.status === 'warning' || materialStats.equipmentDetails.status === 'warning') ? 'éƒ¨åˆ†åä½' : 'çŠ¶æ€è‰¯å¥½'}}
                </view>
                <view class="grid-desc">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</view>
              </view>
            </t-grid-item>
          </t-grid>
        </view>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <view class="quick-action">
          <t-row gutter="16">
            <t-col span="12">
              <t-button theme="primary" block icon="add" bind:tap="purchaseMaterial">
                é‡‡è´­å…¥åº“
              </t-button>
            </t-col>
            <t-col span="12">
              <t-button theme="warning" block icon="remove" bind:tap="useMaterial">
                ç‰©æ–™é¢†ç”¨
              </t-button>
            </t-col>
          </t-row>
        </view>

        <!-- è®°å½•åˆ—è¡¨ -->
        <view class="list-section">
          <view class="card list-card">
            <view class="card-header">
              <text class="card-title">æœ€è¿‘ç‰©æ–™è®°å½•</text>
            </view>
            <view class="records-container">
              <!-- åŠ è½½çŠ¶æ€ -->
              <view wx:if="{{loading}}" class="loading-state">
                <t-loading theme="spinner" size="40rpx" text="åŠ è½½ä¸­..." />
              </view>
              
              <!-- è®°å½•åˆ—è¡¨ - ç›´æ¥æ˜¾ç¤ºï¼Œä¸ç”¨å¤æ‚æ¡ä»¶ -->
              <view wx:if="{{!loading && materialRecords && materialRecords.length > 0}}">
                <view wx:for="{{materialRecords}}" wx:key="id" 
                      class="record-item">
                  <view class="record-main">
                    <view class="record-header">
                      <text class="record-location">{{item.name}}</text>
                      <t-tag theme="{{item.type === 'é‡‡è´­' ? 'success' : 'warning'}}" size="small" class="record-status-tag">{{item.type}}</t-tag>
                    </view>
                    <view class="record-content">
                      <text class="record-symptoms">{{item.description}} â€¢ {{item.quantity}}</text>
                      <view class="record-date-tag">{{item.date}}</view>
                    </view>
                  </view>
                </view>
              </view>
              
              <!-- ç©ºçŠ¶æ€æ˜¾ç¤º -->
              <view wx:if="{{!loading && (!materialRecords || materialRecords.length === 0)}}" class="empty-state">
                <t-empty icon="file" description="æš‚æ— ç‰©æ–™è®°å½•">
                  <t-button theme="primary" size="small" bind:tap="purchaseMaterial">
                    é‡‡è´­ç‰©æ–™
                  </t-button>
                </t-empty>
              </view>
              
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>