<!--production.wxml - 重新设计的生产管理页面-->
<view class="page page-container">
  <!-- 自定义导航栏 -->
  <navigation-bar 
    title="生产管理"
    show-back="true"
    show-menu="true"
    show-record="false"
    bind:back="goBack"
    bind:menu="onMenuTap"
  />

  <!-- 主内容区域 -->
  <view class="main-content">
    <!-- Tab 导航 -->
    <t-tabs 
      value="{{activeTab}}" 
      bind:change="onTabChange" 
      theme="line" 
      class="main-tabs"
      sticky
      sticky-offset="{{navBarHeight}}"
    >
      <t-tab-panel label="入栏管理" value="entry" />
      <t-tab-panel label="出栏管理" value="exit" />
      <t-tab-panel label="物料管理" value="material" />
    </t-tabs>

    <!-- Tab 内容区域 -->
    <view class="tab-container">
      <!-- 入栏管理 -->
      <view wx:if="{{activeTab === 'entry'}}" class="tab-content">
        <!-- 数据概览 -->
        <view class="stats-section">
          <t-row gutter="16" class="overview-stats">
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-primary">
                  <view class="stat-value">{{entryStats.total}}</view>
                  <view class="stat-label">入栏总数(羽)</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-success">
                  <view class="stat-value">{{entryStats.stockQuantity}}</view>
                  <view class="stat-label">存栏数量</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-warning">
                  <view class="stat-value">{{entryStats.batches}}</view>
                  <view class="stat-label">入栏批次</view>
                </view>
              </t-card>
            </t-col>
          </t-row>
        </view>

        <!-- 快速操作 -->
        <view class="quick-action">
          <t-row gutter="16">
            <t-col span="12">
              <t-button theme="primary" block icon="add" bind:tap="addEntry">
                新增入栏记录
              </t-button>
            </t-col>
            <t-col span="12">
              <t-button theme="light" variant="outline" block icon="camera" bind:tap="startAICount">
                🤖 AI智能盘点
              </t-button>
            </t-col>
          </t-row>
        </view>

        <!-- AI盘点功能区域 -->
        <view wx:if="{{aiCount.active}}" class="ai-count-section">
          <view class="card ai-count-card">
            <view class="card-header">
              <t-icon name="robot" size="32rpx" color="#0052D9" />
              <text class="card-title">AI智能盘点</text>
              <t-icon wx:if="{{!aiCount.loading && !aiCount.result}}" name="close" size="28rpx" color="#999" bind:tap="closeAICount" class="close-btn" />
            </view>
            
            <!-- 盘点操作区域 -->
            <view wx:if="{{!aiCount.result}}" class="count-operation">
              <!-- 拍照区域 -->
              <view class="camera-section">
                <view wx:if="{{!aiCount.imageUrl}}" class="camera-placeholder" bind:tap="takePhoto">
                  <t-icon name="camera" size="80rpx" color="#0052D9" />
                  <text class="placeholder-text">点击拍照</text>
                  <text class="placeholder-desc">请对准鹅群拍摄清晰照片</text>
                </view>
                
                <view wx:else class="photo-preview">
                  <image src="{{aiCount.imageUrl}}" mode="aspectFit" class="preview-image" />
                  <view class="photo-actions">
                    <t-button size="small" theme="light" bind:tap="retakePhoto">重新拍照</t-button>
                    <t-button size="small" theme="primary" bind:tap="analyzeImage" loading="{{aiCount.loading}}" disabled="{{aiCount.loading}}">
                      {{aiCount.loading ? 'AI分析中...' : '开始识别'}}
                    </t-button>
                  </view>
                </view>
              </view>
              
              <!-- 拍摄建议 -->
              <view class="shooting-tips">
                <text class="tips-title">📸 拍摄建议</text>
                <view class="tips-list">
                  <text class="tip-item">• 选择光线充足的环境</text>
                  <text class="tip-item">• 尽量包含完整的鹅群</text>
                  <text class="tip-item">• 避免过度拥挤或遮挡</text>
                  <text class="tip-item">• 保持相机稳定清晰</text>
                </view>
              </view>
            </view>
            
            <!-- 识别结果 -->
            <view wx:if="{{aiCount.result}}" class="count-result">
              <view class="result-header">
                <t-icon name="check-circle" size="32rpx" color="#52c41a" />
                <text class="result-title">识别完成</text>
                <text class="confidence-badge">置信度 {{aiCount.result.confidence}}%</text>
              </view>
              
              <view class="result-content">
                <!-- 主要结果 -->
                <view class="main-result">
                  <view class="count-display">
                    <text class="count-number">{{aiCount.result.totalCount}}</text>
                    <text class="count-unit">只</text>
                  </view>
                  <text class="count-label">识别到的鹅群数量</text>
                </view>
                
                <!-- 详细信息 -->
                <view wx:if="{{aiCount.result.regions && aiCount.result.regions.length > 0}}" class="result-details">
                  <view class="detail-item">
                    <text class="detail-label">检测区域：</text>
                    <text class="detail-value">{{aiCount.result.regions.length}} 个</text>
                  </view>
                </view>
                
                <!-- 异常提醒 -->
                <view wx:if="{{aiCount.result.abnormalDetection && aiCount.result.abnormalDetection.suspiciousAnimals > 0}}" class="abnormal-alert">
                  <view class="alert-content">
                    <t-icon name="error-circle" size="24rpx" color="#ff4d4f" />
                    <text class="alert-text">发现 {{aiCount.result.abnormalDetection.suspiciousAnimals}} 只疑似异常个体</text>
                  </view>
                  <view wx:if="{{aiCount.result.abnormalDetection.healthConcerns.length > 0}}" class="health-concerns">
                    <text wx:for="{{aiCount.result.abnormalDetection.healthConcerns}}" wx:key="index" class="concern-item">
                      • {{item}}
                    </text>
                  </view>
                </view>
                
                <!-- 补充建议 -->
                <view wx:if="{{aiCount.result.suggestions && aiCount.result.suggestions.length > 0}}" class="suggestions">
                  <text class="suggestions-title">💡 建议</text>
                  <view wx:for="{{aiCount.result.suggestions}}" wx:key="index" class="suggestion-item">
                    • {{item}}
                  </view>
                </view>
              </view>
              
              <!-- 操作按钮 -->
              <view class="result-actions">
                <t-button theme="primary" size="medium" bind:tap="saveCountRecord">
                  保存盘点记录
                </t-button>
                <t-button theme="light" variant="outline" size="medium" bind:tap="restartCount">
                  重新盘点
                </t-button>
              </view>
            </view>
          </view>
        </view>

        <!-- 记录列表 -->
        <view class="list-section">
          <view class="card list-card">
            <view class="card-header">
              <text class="card-title">最近入栏记录</text>
            </view>
            <view class="records-container">
              <!-- 空状态显示 -->
              <view wx:if="{{entryRecords.length === 0 && !loading}}" class="empty-state">
                <t-empty icon="file" description="暂无入栏记录">
                  <t-button theme="primary" size="small" bind:tap="addEntry">
                    立即添加
                  </t-button>
                </t-empty>
              </view>
              
              <!-- 记录列表 -->
              <view wx:for="{{entryRecords}}" wx:key="id" 
                    class="record-item">
                <view class="record-main">
                  <view class="record-header">
                    <text class="record-location">{{item.displayTitle}}</text>
                    <t-tag theme="{{item.status === '已完成' ? 'success' : 'warning'}}" size="small" class="record-status-tag">{{item.status}}</t-tag>
                  </view>
                  <view class="record-content">
                    <text class="record-symptoms">{{item.supplier}} • {{item.quantity}}羽</text>
                    <view class="record-date-tag">{{item.entryDate || item.date}}</view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 出栏管理 -->
      <view wx:if="{{activeTab === 'exit'}}" class="tab-content">
        <!-- 数据概览 -->
        <view class="stats-section">
          <t-row gutter="16" class="overview-stats">
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-success">
                  <view class="stat-value">{{exitStats.total}}</view>
                  <view class="stat-label">出栏总数(羽)</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-primary">
                  <view class="stat-value">{{exitStats.avgWeight}}斤</view>
                  <view class="stat-label">平均重量</view>
                </view>
              </t-card>
            </t-col>
            <t-col span="8">
              <t-card>
                <view class="stat-content stat-success">
                  <view class="stat-value">{{exitStats.batches}}</view>
                  <view class="stat-label">出栏批次</view>
                </view>
              </t-card>
            </t-col>
          </t-row>
        </view>

        <!-- 快速操作 -->
        <view class="quick-action">
          <t-button theme="primary" block icon="add" bind:tap="addExit">
            新增出栏记录
          </t-button>
        </view>

        <!-- 记录列表 -->
        <view class="list-section">
          <view class="card list-card">
            <view class="card-header">
              <text class="card-title">最近出栏记录</text>
            </view>
            <view class="records-container">
              <!-- 空状态显示 -->
              <view wx:if="{{exitRecords.length === 0 && !loading}}" class="empty-state">
                <t-empty icon="file" description="暂无出栏记录">
                  <t-button theme="primary" size="small" bind:tap="addExit">
                    立即添加
                  </t-button>
                </t-empty>
              </view>
              
              <!-- 记录列表 -->
              <view wx:for="{{exitRecords}}" wx:key="id" 
                    class="record-item">
                <view class="record-main">
                  <view class="record-header">
                    <text class="record-location">{{item.displayTitle}}</text>
                    <t-tag theme="{{item.status === '已交付' ? 'success' : 'primary'}}" size="small" class="record-status-tag">{{item.status}}</t-tag>
                  </view>
                  <view class="record-content">
                    <text class="record-symptoms">{{item.customer}} • {{item.quantity}}羽 • 平均{{item.avgWeight}}斤</text>
                    <view class="record-date-tag">{{item.exitDate || item.date}}</view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 物料管理 -->
      <view wx:if="{{activeTab === 'material'}}" class="tab-content">
        <!-- 库存状态 - 四宫格布局 -->
        <view class="stats-section">
          <t-grid column="2" class="material-grid">
            <!-- 饲料库存 -->
            <t-grid-item text="饲料库存" bind:click="viewFeedInventory" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.feedDetails.totalCount}}种物料</view>
                <view class="grid-status {{materialStats.feedDetails.status}}">
                  {{materialStats.feedDetails.statusText}}
                </view>
                <view class="grid-desc">{{materialStats.feedDetails.description}}</view>
              </view>
            </t-grid-item>
            
            <!-- 药品库存 -->
            <t-grid-item text="药品库存" bind:click="viewMedicineInventory" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.medicineDetails.totalCount}}种物料</view>
                <view class="grid-status {{materialStats.medicineDetails.status}}">
                  {{materialStats.medicineDetails.statusText}}
                </view>
                <view class="grid-desc">{{materialStats.medicineDetails.description}}</view>
              </view>
            </t-grid-item>

            <!-- 设备物料 -->
            <t-grid-item text="设备物料" bind:click="viewEquipmentInventory" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.equipmentDetails.totalCount}}种物料</view>
                <view class="grid-status {{materialStats.equipmentDetails.status}}">
                  {{materialStats.equipmentDetails.statusText}}
                </view>
                <view class="grid-desc">{{materialStats.equipmentDetails.description}}</view>
              </view>
            </t-grid-item>

            <!-- 总览统计 -->
            <t-grid-item text="库存总览" bind:click="viewInventoryDetail" class="grid-item">
              <view class="grid-content">
                <view class="grid-count">{{materialStats.feedDetails.totalCount + materialStats.medicineDetails.totalCount + materialStats.equipmentDetails.totalCount}}种物料</view>
                <view class="grid-status {{(materialStats.feedDetails.status === 'critical' || materialStats.medicineDetails.status === 'critical' || materialStats.equipmentDetails.status === 'critical') ? 'critical' : (materialStats.feedDetails.status === 'warning' || materialStats.medicineDetails.status === 'warning' || materialStats.equipmentDetails.status === 'warning') ? 'warning' : 'normal'}}">
                  {{(materialStats.feedDetails.status === 'critical' || materialStats.medicineDetails.status === 'critical' || materialStats.equipmentDetails.status === 'critical') ? '需要关注' : (materialStats.feedDetails.status === 'warning' || materialStats.medicineDetails.status === 'warning' || materialStats.equipmentDetails.status === 'warning') ? '部分偏低' : '状态良好'}}
                </view>
                <view class="grid-desc">点击查看详情</view>
              </view>
            </t-grid-item>
          </t-grid>
        </view>

        <!-- 快速操作 -->
        <view class="quick-action">
          <t-row gutter="16">
            <t-col span="12">
              <t-button theme="primary" block icon="add" bind:tap="purchaseMaterial">
                采购入库
              </t-button>
            </t-col>
            <t-col span="12">
              <t-button theme="warning" block icon="remove" bind:tap="useMaterial">
                物料领用
              </t-button>
            </t-col>
          </t-row>
        </view>

        <!-- 记录列表 -->
        <view class="list-section">
          <view class="card list-card">
            <view class="card-header">
              <text class="card-title">最近物料记录</text>
            </view>
            <view class="records-container">
              <!-- 加载状态 -->
              <view wx:if="{{loading}}" class="loading-state">
                <t-loading theme="spinner" size="40rpx" text="加载中..." />
              </view>
              
              <!-- 记录列表 - 直接显示，不用复杂条件 -->
              <view wx:if="{{!loading && materialRecords && materialRecords.length > 0}}">
                <view wx:for="{{materialRecords}}" wx:key="id" 
                      class="record-item">
                  <view class="record-main">
                    <view class="record-header">
                      <text class="record-location">{{item.name}}</text>
                      <t-tag theme="{{item.type === '采购' ? 'success' : 'warning'}}" size="small" class="record-status-tag">{{item.type}}</t-tag>
                    </view>
                    <view class="record-content">
                      <text class="record-symptoms">{{item.description}} • {{item.quantity}}</text>
                      <view class="record-date-tag">{{item.date}}</view>
                    </view>
                  </view>
                </view>
              </view>
              
              <!-- 空状态显示 -->
              <view wx:if="{{!loading && (!materialRecords || materialRecords.length === 0)}}" class="empty-state">
                <t-empty icon="file" description="暂无物料记录">
                  <t-button theme="primary" size="small" bind:tap="purchaseMaterial">
                    采购物料
                  </t-button>
                </t-empty>
              </view>
              
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>