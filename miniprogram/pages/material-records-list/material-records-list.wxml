<!--pages/material-records-list/material-records-list.wxml-->
<view class="page page-container">
  <!-- 自定义导航栏 -->
  <navigation-bar 
    title="物料记录"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- 主内容区域 -->
  <view class="main-content">
    
    <!-- 搜索栏 -->
    <view class="search-section">
      <t-search 
        placeholder="搜索物料名称或单据号"
        bind:change="onSearch"
        bind:submit="onSearch"
        class="search-bar"
      />
    </view>

    <!-- 筛选标签 -->
    <view class="filter-section">
      <t-tabs 
        value="{{activeFilter}}" 
        bind:change="onFilterChange" 
        theme="line"
        class="filter-tabs"
      >
        <t-tab-panel label="全部" value="all" />
        <t-tab-panel label="采购入库" value="purchase" />
        <t-tab-panel label="物料领用" value="use" />
      </t-tabs>
    </view>

    <!-- 统计信息 -->
    <view class="stats-section">
      <text class="stats-text">共{{totalRecords}}条记录</text>
      <text wx:if="{{activeFilter !== 'all'}}" class="filter-text">
        ({{activeFilter === 'purchase' ? '采购入库' : '物料领用'}})
      </text>
    </view>

    <!-- 记录列表 -->
    <view class="records-section">
      
      <!-- 加载状态 -->
      <view wx:if="{{loading}}" class="loading-state">
        <t-loading theme="spinner" size="40rpx" text="加载中..." />
      </view>

      <!-- 记录列表 -->
      <view wx:if="{{!loading && records.length > 0}}" class="records-list">
        <view 
          wx:for="{{records}}" 
          wx:key="id" 
          class="record-item"
          bind:tap="viewRecordDetail"
          data-record="{{item}}"
        >
          <!-- 记录头部 -->
          <view class="record-header">
            <view class="record-title-row">
              <text class="record-name">{{item.name}}</text>
            </view>
          </view>

          <!-- 记录内容 -->
          <view class="record-content">
            <!-- 第一行：单据号 + 分类 -->
            <view class="info-row">
              <view class="info-group">
                <text class="info-label">单据：</text>
                <text class="info-value">{{item.recordNumber}}</text>
              </view>
              <view class="info-group">
                <text class="info-label">分类：</text>
                <text class="info-value">{{item.category}}</text>
              </view>
            </view>

            <!-- 第二行：类型 + 数量 -->
            <view class="info-row">
              <view class="info-group">
                <text class="info-label">类型：</text>
                <text class="info-value">{{item.type}}</text>
              </view>
              <view class="info-group">
                <text class="info-label">数量：</text>
                <text class="info-value">{{item.displayQuantity}}</text>
              </view>
            </view>

            <!-- 第三行：供应商/用途 -->
            <view class="info-row" wx:if="{{item.supplier || item.targetLocation}}">
              <view class="info-group" wx:if="{{item.supplier}}">
                <text class="info-label">供应商：</text>
                <text class="info-value">{{item.supplier}}</text>
              </view>
              <view class="info-group" wx:if="{{item.targetLocation}}">
                <text class="info-label">用途：</text>
                <text class="info-value">{{item.targetLocation}}</text>
              </view>
            </view>

            <!-- 第四行：操作员 + 日期 + 状态 -->
            <view class="record-footer">
              <view class="footer-left">
                <text class="operator-text">{{item.operator}}</text>
                <text class="date-text">{{item.date}}</text>
              </view>
              <t-tag 
                theme="{{item.status === '已完成' ? 'success' : 'primary'}}" 
                size="small"
                variant="light"
                class="status-tag"
              >
                {{item.status}}
              </t-tag>
            </view>
          </view>


        </view>
      </view>

      <!-- 加载更多状态 -->
      <view wx:if="{{loadingMore}}" class="loading-more">
        <t-loading theme="spinner" size="32rpx" text="加载更多..." />
      </view>

      <!-- 无更多数据提示 -->
      <view wx:if="{{!loading && !loadingMore && records.length > 0 && !hasMore}}" class="no-more">
        <text class="no-more-text">已显示全部记录</text>
      </view>

      <!-- 空状态 -->
      <view wx:if="{{!loading && isEmpty}}" class="empty-state">
        <t-empty 
          icon="file" 
          description="{{activeFilter === 'all' ? '暂无物料记录' : (activeFilter === 'purchase' ? '暂无采购记录' : '暂无领用记录')}}"
        >
          <t-button theme="primary" size="small" bind:tap="goBack" class="primary-button">
            返回生产管理
          </t-button>
        </t-empty>
      </view>

    </view>
  </view>

  <!-- 物料记录详情弹窗 -->
  <bottom-popup
    visible="{{showDetailPopup}}"
    title="{{selectedRecord.type}}记录详情"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="确定"
    bind:close="closeDetailPopup"
    bind:confirm="closeDetailPopup"
    bind:visiblechange="onDetailPopupChange"
  >
    <view wx:if="{{selectedRecord}}" class="record-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">物料：</text>
            <text class="info-value">{{selectedRecord.name}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">分类：</text>
            <text class="info-value">{{selectedRecord.category}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">数量：</text>
            <text class="info-value">{{selectedRecord.displayQuantity}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedRecord.supplier}}">
            <text class="info-label">供应商：</text>
            <text class="info-value">{{selectedRecord.supplier}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedRecord.targetLocation}}">
            <text class="info-label">用途：</text>
            <text class="info-value">{{selectedRecord.targetLocation}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">操作员：</text>
            <text class="info-value">{{selectedRecord.operator}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">时间：</text>
            <text class="info-value">{{selectedRecord.date}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">状态：</text>
            <view class="status-value">
              <t-tag theme="{{selectedRecord.status === '已完成' ? 'success' : 'primary'}}" size="small">
                {{selectedRecord.status}}
              </t-tag>
            </view>
          </view>
          <view class="info-row" wx:if="{{selectedRecord.notes}}">
            <text class="info-label">备注：</text>
            <text class="info-value note-text">{{selectedRecord.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  </bottom-popup>

</view>
