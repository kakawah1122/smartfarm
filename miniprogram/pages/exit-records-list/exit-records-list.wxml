<!--pages/exit-records-list/exit-records-list.wxml-->
<view class="page page-container">
  <!-- 自定义导航栏 -->
  <navigation-bar 
    title="出栏记录"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- 主内容区域 -->
  <view class="main-content">
    
    <!-- 搜索栏 -->
    <view class="search-section">
      <t-search 
        placeholder="搜索客户或出栏号"
        bind:change="onSearch"
        bind:submit="onSearch"
        class="search-bar"
      />
    </view>

    <!-- 统计信息 -->
    <view class="stats-section">
      <text class="stats-text">共{{totalRecords}}条记录</text>
    </view>

    <!-- 记录列表 -->
    <view class="records-section">
      
      <!-- 加载状态 -->
      <view wx:if="{{loading}}" class="loading-state">
        <t-loading theme="spinner" size="40rpx" text="加载中..." />
      </view>

      <!-- 记录列表 -->
      <view wx:if="{{!loading && records.length > 0}}" class="records-list">
        <view 
          wx:for="{{records}}" 
          wx:key="id" 
          class="record-item"
          bind:tap="viewRecordDetail"
          data-record="{{item}}"
        >
          <!-- 记录头部 -->
          <view class="record-header">
            <view class="record-title-row">
              <text class="record-name">{{item.displayTitle}}</text>
            </view>
          </view>

          <!-- 记录内容 -->
          <view class="record-content">
            <!-- 第一行：出栏号 + 数量 -->
            <view class="info-row">
              <view class="info-group">
                <text class="info-label">出栏号：</text>
                <text class="info-value">{{item.exitNumber}}</text>
              </view>
              <view class="info-group">
                <text class="info-label">数量：</text>
                <text class="info-value">{{item.displayQuantity}}</text>
              </view>
            </view>

            <!-- 第二行：客户 + 品种 -->
            <view class="info-row">
              <view class="info-group" wx:if="{{item.customer}}">
                <text class="info-label">客户：</text>
                <text class="info-value">{{item.customer}}</text>
              </view>
              <view class="info-group" wx:if="{{item.breed}}">
                <text class="info-label">品种：</text>
                <text class="info-value">{{item.breed}}</text>
              </view>
            </view>

            <!-- 第三行：批次号 -->
            <view class="info-row" wx:if="{{item.batchNumber}}">
              <view class="info-group">
                <text class="info-label">批次：</text>
                <text class="info-value">{{item.batchNumber}}</text>
              </view>
            </view>

            <!-- 第四行：平均重量 + 总重量 -->
            <view class="info-row" wx:if="{{item.avgWeight > 0 || item.totalWeight > 0}}">
              <view class="info-group" wx:if="{{item.avgWeight > 0}}">
                <text class="info-label">平均重量：</text>
                <text class="info-value">{{item.avgWeight}}斤</text>
              </view>
              <view class="info-group" wx:if="{{item.totalWeight > 0}}">
                <text class="info-label">总重量：</text>
                <text class="info-value">{{item.totalWeight}}斤</text>
              </view>
            </view>

            <!-- 第五行：操作员 + 日期 + 状态 -->
            <view class="record-footer">
              <view class="footer-left">
                <text class="operator-text">{{item.operator}}</text>
                <text class="date-text">{{item.date}}</text>
              </view>
              <t-tag theme="{{item.status === '已交付' ? 'success' : 'primary'}}" size="small" class="status-tag">
                {{item.status}}
              </t-tag>
            </view>
          </view>

        </view>
      </view>

      <!-- 加载更多状态 -->
      <view wx:if="{{loadingMore}}" class="loading-more">
        <t-loading theme="spinner" size="32rpx" text="加载更多..." />
      </view>

      <!-- 无更多数据提示 -->
      <view wx:if="{{!loading && !loadingMore && records.length > 0 && !hasMore}}" class="no-more">
        <text class="no-more-text">已显示全部记录</text>
      </view>

      <!-- 空状态 -->
      <view wx:if="{{!loading && isEmpty}}" class="empty-state">
        <t-empty 
          icon="file" 
          description="暂无出栏记录"
        >
          <t-button theme="primary" size="small" bind:tap="addExit" class="primary-button">
            新增出栏记录
          </t-button>
        </t-empty>
      </view>

    </view>
  </view>
</view>

<!-- 出栏记录详情弹窗 -->
<bottom-popup
  visible="{{showDetailPopup}}"
  title="出栏记录详情"
  show-close="{{true}}"
  show-actions="{{true}}"
  confirm-text="确定"
  bind:close="closeDetailPopup"
  bind:confirm="closeDetailPopup"
  bind:visiblechange="onDetailPopupChange"
>
  <view wx:if="{{selectedRecord}}" class="record-detail-content">
    <view class="info-card">
      <view class="card-content">
        <view class="info-row">
          <text class="info-label">客户：</text>
          <text class="info-value">{{selectedRecord.customer}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">出栏号：</text>
          <text class="info-value">{{selectedRecord.exitNumber}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">数量：</text>
          <text class="info-value">{{selectedRecord.displayQuantity}}</text>
        </view>
        <view class="info-row" wx:if="{{selectedRecord.batchNumber}}">
          <text class="info-label">批次号：</text>
          <text class="info-value">{{selectedRecord.batchNumber}}</text>
        </view>
        <view class="info-row" wx:if="{{selectedRecord.breed}}">
          <text class="info-label">品种：</text>
          <text class="info-value">{{selectedRecord.breed}}</text>
        </view>
        <view class="info-row" wx:if="{{selectedRecord.avgWeight > 0}}">
          <text class="info-label">平均重量：</text>
          <text class="info-value">{{selectedRecord.avgWeight}}斤</text>
        </view>
        <view class="info-row" wx:if="{{selectedRecord.totalWeight > 0}}">
          <text class="info-label">总重量：</text>
          <text class="info-value">{{selectedRecord.totalWeight}}斤</text>
        </view>
        <view class="info-row">
          <text class="info-label">操作员：</text>
          <text class="info-value">{{selectedRecord.operator}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">时间：</text>
          <text class="info-value">{{selectedRecord.date}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">状态：</text>
          <view class="status-value">
            <t-tag theme="{{selectedRecord.status === '已交付' ? 'success' : 'primary'}}" size="small">
              {{selectedRecord.status}}
            </t-tag>
          </view>
        </view>
        <view class="info-row" wx:if="{{selectedRecord.notes}}">
          <text class="info-label">备注：</text>
          <text class="info-value note-text">{{selectedRecord.notes}}</text>
        </view>
      </view>
    </view>
  </view>
</bottom-popup>
