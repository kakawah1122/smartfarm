<!--health.wxml-->
<view class="page-container">
  <!-- 新式导航栏 -->
  <navigation-bar 
    title="健康管理"
    show-back="true"
    show-menu="true"
    show-record="false"
    bind:back="goBack"
    bind:menu="onMenuTap"
  />

  <!-- Tab 切换 -->
  <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" class="health-tabs">
    <t-tab-panel value="record" label="健康记录"></t-tab-panel>
    <t-tab-panel value="vaccine" label="疫苗管理"></t-tab-panel>
    <t-tab-panel value="ai" label="AI诊疗"></t-tab-panel>
  </t-tabs>

  <view class="scroll-container">
    <!-- 健康记录 -->
    <view wx:if="{{activeTab === 'record'}}" class="tab-content">
      <!-- 健康概览 -->
      <view class="stats-section">
        <t-row gutter="16" class="health-stats">
          <t-col span="8">
            <t-card>
              <view class="stat-content stat-success">
                <view class="stat-value">{{healthStats.survivalRate}}%</view>
                <view class="stat-label">存活率</view>
              </view>
            </t-card>
          </t-col>
          <t-col span="8">
            <t-card>
              <view class="stat-content stat-warning">
                <view class="stat-value">{{healthStats.abnormal}}</view>
                <view class="stat-label">异常个体</view>
              </view>
            </t-card>
          </t-col>
          <t-col span="8">
            <t-card>
              <view class="stat-content stat-primary">
                <view class="stat-value">{{healthStats.records}}</view>
                <view class="stat-label">本月记录</view>
              </view>
            </t-card>
          </t-col>
        </t-row>
      </view>

      <!-- 添加按钮 -->
      <view class="action-section">
        <t-button theme="primary" size="large" block icon="add" bind:tap="addHealthRecord">
          新增健康记录
        </t-button>
      </view>

      <!-- 健康记录列表 -->
      <view class="list-section">
        <view class="card list-card">
          <view class="card-header">
            <text class="card-title">最近健康记录</text>
          </view>
          <view class="records-container">
            <view wx:for="{{healthRecords}}" wx:key="id" 
                  class="record-item" 
                  bind:tap="viewHealthRecord" 
                  data-item="{{item}}">
              <view class="record-main">
                <view class="record-header">
                  <text class="record-location">{{item.location}}</text>
                  <t-tag theme="{{item.severity || 'default'}}" size="small">{{item.priorityText || '未知'}}</t-tag>
                </view>
                <view class="record-content">
                  <text class="record-symptoms">{{item.symptoms}}</text>
                </view>
                <view class="record-footer">
                  <text class="record-operator">{{item.operator}}</text>
                  <text class="record-date">{{item.date}} {{item.time}}</text>
                </view>
              </view>
              <view class="record-arrow">
                <t-icon name="chevron-right" size="16" color="#c8c9cc" />
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 疫苗管理 -->
    <view wx:if="{{activeTab === 'vaccine'}}" class="tab-content">
      <!-- 疫苗提醒 -->
      <view class="reminder-section">
        <view class="card">
          <view class="card-header">
            <text class="card-title">疫苗接种提醒</text>
          </view>
          <t-notice-bar theme="warning" content="有{{vaccineReminders.length}}项疫苗计划即将到期" />
          <view class="records-container" style="margin-top: 24rpx;">
            <view wx:for="{{vaccineReminders}}" wx:key="id" 
                  class="record-item" 
                  bind:tap="viewVaccineReminder" 
                  data-item="{{item}}">
              <view class="record-main">
                <view class="record-header">
                  <text class="record-location">{{item.name}} - {{item.location}}</text>
                  <t-tag theme="warning" size="small">待接种</t-tag>
                </view>
                <view class="record-content">
                  <text class="record-symptoms">预计接种时间：{{item.scheduledDate}}</text>
                </view>
              </view>
              <view class="record-arrow">
                <t-icon name="chevron-right" size="16" color="#c8c9cc" />
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="action-section">
        <view class="vaccine-actions">
          <t-button theme="primary" size="large" icon="add" bind:tap="addVaccinePlan" class="vaccine-action-btn">
            添加疫苗计划
          </t-button>
          <t-button theme="success" size="large" icon="check" bind:tap="recordVaccination" class="vaccine-action-btn">
            记录接种
          </t-button>
        </view>
      </view>

      <!-- 疫苗记录 -->
      <view class="list-section">
        <view class="card list-card">
          <view class="card-header">
            <text class="card-title">疫苗接种记录</text>
          </view>
          <view class="records-container">
            <view wx:for="{{vaccineRecords}}" wx:key="id" 
                  class="record-item" 
                  bind:tap="viewVaccineRecord" 
                  data-item="{{item}}">
              <view class="record-main">
                <view class="record-header">
                  <text class="record-location">{{item.name}}</text>
                  <t-tag theme="{{item.status === '已完成' ? 'success' : 'primary'}}" size="small">{{item.status}}</t-tag>
                </view>
                <view class="record-content">
                  <text class="record-symptoms">{{item.location}} • {{item.quantity}}只鹅 • {{item.nextDate ? '下次：' + item.nextDate : '计划：' + item.plannedDate}}</text>
                </view>
                <view class="record-footer">
                  <text class="record-operator">{{item.operator}}</text>
                  <text class="record-date">{{item.date}}</text>
                </view>
              </view>
              <view class="record-arrow">
                <t-icon name="chevron-right" size="16" color="#c8c9cc" />
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- AI诊疗 -->
    <view wx:if="{{activeTab === 'ai'}}" class="tab-content">
      <!-- 症状输入 -->
      <view class="input-section">
        <t-card class="ai-diagnosis-card">
          <view slot="header" class="ai-card-header">
            <text class="card-title">AI智能诊断</text>
          </view>
          
          <!-- 图片上传区域 -->
          <view class="image-upload-section">
            <text class="upload-label">上传鹅群图片（可选）</text>
            <view class="image-upload-container">
              <view wx:if="{{uploadedImages.length === 0}}" class="upload-placeholder" bind:tap="chooseImage" hover-class="upload-hover">
                <t-icon name="camera" size="48" color="#c8c9cc" />
                <text class="upload-text">点击上传图片</text>
                <text class="upload-hint">支持JPG、PNG格式，最多3张</text>
              </view>
              <view wx:else class="uploaded-images">
                <view wx:for="{{uploadedImages}}" wx:key="index" class="image-item">
                  <image src="{{item}}" class="uploaded-image" mode="aspectFill" />
                  <view class="image-delete" bind:tap="deleteImage" data-index="{{index}}" hover-class="delete-hover">
                    <t-icon name="close" size="16" color="#fff" />
                  </view>
                </view>
                <view wx:if="{{uploadedImages.length < 3}}" class="upload-more" bind:tap="chooseImage" hover-class="upload-hover">
                  <t-icon name="add" size="24" color="#c8c9cc" />
                </view>
              </view>
            </view>
          </view>

          <!-- 文字描述 -->
          <view class="text-input-section">
            <text class="input-label">症状描述</text>
            <t-textarea placeholder="请详细描述鹅群症状，如：精神状态、食欲情况、排便状况、体温变化等..." 
                        value="{{symptomInput}}" 
                        bind:change="onSymptomInput"
                        maxlength="500"
                        autosize 
                        class="symptom-textarea" />
          </view>

          <!-- 常见症状标签 -->
          <view class="symptom-tags-section">
            <text class="tags-label">常见症状（可多选）</text>
            <view class="symptom-tags">
              <t-tag wx:for="{{commonSymptoms}}" wx:key="id" 
                     theme="{{item.selected ? 'primary' : 'light'}}" 
                     size="small" 
                     bind:tap="toggleSymptom" 
                     data-id="{{item.id}}">
                {{item.name}}
              </t-tag>
            </view>
          </view>

          <!-- 提交按钮 -->
          <view class="submit-section">
            <t-notice-bar theme="warning" content="⚠️ AI建议仅供参考，请结合专业兽医诊断进行治疗决策" />
            <t-button theme="primary" size="large" block bind:tap="getAIAdvice" 
                      disabled="{{!symptomInput && uploadedImages.length === 0}}" 
                      class="ai-submit-btn">
              获取AI精准诊断
            </t-button>
          </view>
        </t-card>
      </view>

      <!-- AI建议结果 -->
      <view wx:if="{{aiAdvice}}" class="advice-section">
        <view class="card">
          <view class="card-header">
            <text class="card-title">AI诊疗建议</text>
          </view>
          <view class="ai-advice-content">
            <view class="advice-item">
              <text class="advice-label">初步诊断</text>
              <text class="advice-text">{{aiAdvice.diagnosis}}</text>
            </view>
            <view class="advice-item">
              <text class="advice-label">建议措施</text>
              <view class="treatment-list">
                <text wx:for="{{aiAdvice.treatments}}" wx:key="index" class="treatment-item">
                  {{index + 1}}. {{item}}
                </text>
              </view>
            </view>
          </view>
          <view class="advice-actions">
            <t-button theme="success" size="small" bind:tap="adoptAdvice">采纳建议</t-button>
            <t-button theme="light" size="small" bind:tap="saveAdvice">保存记录</t-button>
          </view>
        </view>
      </view>

      <!-- 历史咨询记录 -->
      <view class="history-section">
        <view class="card list-card">
          <view class="card-header">
            <text class="card-title">历史咨询记录</text>
          </view>
          <view class="records-container">
            <view wx:for="{{consultationHistory}}" wx:key="id" 
                  class="record-item" 
                  bind:tap="viewConsultation" 
                  data-item="{{item}}">
              <view class="record-main">
                <view class="record-header">
                  <text class="record-location">症状咨询</text>
                  <t-tag theme="{{item.adopted ? 'success' : 'primary'}}" size="small">
                    {{item.adopted ? '已采纳' : '处理中'}}
                  </t-tag>
                </view>
                <view class="record-content">
                  <text class="record-symptoms">{{item.symptoms}}</text>
                </view>
                <view class="ai-consultation-detail">
                  <view class="ai-diagnosis">
                    <text class="diagnosis-label">诊断：</text>
                    <text class="diagnosis-text">{{item.diagnosis}}</text>
                  </view>
                  <view class="ai-treatment">
                    <text class="treatment-label">建议：</text>
                    <text class="treatment-text">{{item.mainTreatment}}</text>
                  </view>
                </view>
                <view class="record-footer">
                  <text class="record-date">{{item.date}}</text>
                </view>
              </view>
              <view class="record-arrow">
                <t-icon name="chevron-right" size="16" color="#c8c9cc" />
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 底部安全区域 -->
    <view style="height: 120rpx;"></view>
  </view>
</view>