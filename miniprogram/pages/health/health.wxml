<!--health.wxml - å¥åº·ç®¡ç†ä¸­å¿ƒå®Œæ•´é‡æ„ç‰ˆæœ¬-->
<wxs module="healthUtils" src="./health-utils.wxs"></wxs>

<view class="page health-center-page">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar 
    title="å¥åº·ç®¡ç†ä¸­å¿ƒ"
    show-back="{{false}}"
  />

  <!-- è¯¦æƒ…è§†å›¾ -->
  <view class="detail-view">

    <!-- å¥åº·æ•°æ®æ¦‚è§ˆ -->
    <view class="health-stats-section">
      <view class="stats-grid stats-grid-two">
        <view class="stat-card stat-primary">
          <text class="stat-value">{{healthStats.healthyRate}}</text>
          <text class="stat-label">å¥åº·ç‡</text>
        </view>
        <view class="stat-card stat-mortality">
          <text class="stat-value">{{healthStats.mortalityRate}}</text>
          <text class="stat-label">æ­»äº¡ç‡</text>
        </view>
      </view>
    </view>

    <!-- æ‰¹æ¬¡ç­›é€‰å’ŒTabå¯¼èˆªå¡ç‰‡ç»„ -->
    <view class="filter-tabs-card">
      <!-- æ‰¹æ¬¡ç­›é€‰æ  -->
      <view class="batch-filter-section">
        <view class="filter-header">
          <view class="current-batch">
            <text class="label">å½“å‰æ‰¹æ¬¡</text>
            <text class="value">{{currentBatchNumber || 'è¯·é€‰æ‹©æ‰¹æ¬¡'}}</text>
          </view>
          <view class="filter-action" bind:tap="toggleBatchDropdown">
            <text class="action-text">ç­›é€‰</text>
            <text class="action-icon {{showBatchDropdown ? 'rotate' : ''}}">â–¾</text>
          </view>
        </view>
      </view>
      
      <!-- ä¸»è¦Tabåˆ‡æ¢ -->
      <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" class="health-main-tabs">
        <t-tab-panel value="prevention" label="é¢„é˜²ç®¡ç†"></t-tab-panel>
        <t-tab-panel value="treatment" label="è¯Šç–—ç®¡ç†"></t-tab-panel>
        <t-tab-panel value="analysis" label="æ•ˆæœåˆ†æ"></t-tab-panel>
      </t-tabs>
      
      <!-- é¢„é˜²ç®¡ç†å­æ ‡ç­¾é¡µï¼ˆæ•´åˆåˆ°å¡ç‰‡å†…ï¼Œä¸breeding-todoä¿æŒä¸€è‡´ï¼‰ -->
      <view class="prevention-sub-tabs" wx:if="{{activeTab === 'prevention'}}">
        <t-tabs value="{{preventionSubTab}}" bind:change="onPreventionSubTabChange" theme="line">
          <t-tab-panel label="è¿›è¡Œä¸­" value="today"></t-tab-panel>
          <t-tab-panel label="å³å°†åˆ°æ¥" value="upcoming"></t-tab-panel>
          <t-tab-panel label="å·²å®Œæˆ" value="history"></t-tab-panel>
        </t-tabs>
      </view>
    </view>

    <!-- æ´»è·ƒé¢„è­¦ -->
  <view class="active-alerts" wx:if="{{activeAlerts.length > 0}}">
    <view class="alert-header">
      <text class="alert-title">æ´»è·ƒé¢„è­¦</text>
      <text class="alert-count">{{activeAlerts.length}}æ¡</text>
    </view>
    <view class="alert-list">
      <view 
        class="alert-item alert-{{item.severity}}"
        wx:for="{{activeAlerts}}"
        wx:key="_id"
        bind:tap="onAlertAction"
        data-alert-id="{{item._id}}"
        data-action="acknowledge"
      >
        <view class="alert-content">
          <text class="alert-message">{{item.message}}</text>
          <text class="alert-time">{{item.createTime}}</text>
        </view>
        <view class="alert-action">
          <t-icon name="chevron-right" size="16" color="#c8c9cc" />
        </view>
      </view>
    </view>
  </view>

  <!-- Tabå†…å®¹åŒºåŸŸ -->
  <view class="tab-content-container">
    
    <!-- é¢„é˜²ç®¡ç† Tab (æ•´åˆå¾…åŠ+è®¡åˆ’+ç»Ÿè®¡+è®°å½•) -->
    <view class="tab-content prevention-content" wx:if="{{activeTab === 'prevention'}}">
      
      <!-- è¿›è¡Œä¸­å­æ ‡ç­¾ï¼ˆä»Šæ—¥å¾…åŠ - ä» breeding-todo å®Œæ•´è¿ç§»ï¼‰ -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'today'}}">
        <!-- æŒ‰æ‰¹æ¬¡åˆ†ç»„çš„ä»»åŠ¡åˆ—è¡¨ -->
        <view wx:if="{{todayTasksByBatch.length > 0}}" class="batch-task-groups">
          <view wx:for="{{todayTasksByBatch}}" wx:key="id" class="batch-group">
            <!-- æ‰¹æ¬¡ç»„å¤´éƒ¨ -->
            <view class="batch-group-header">
              <view class="batch-group-info">
                <text class="batch-group-title">{{item.batchNumber}}</text>
                <text class="batch-group-separator">Â·</text>
                <text class="batch-group-age">ç¬¬{{item.dayAge}}æ—¥é¾„</text>
              </view>
              <view class="batch-task-count">{{item.tasks.length}}ä¸ªä»»åŠ¡</view>
            </view>
            
            <!-- è¯¥æ‰¹æ¬¡çš„ä»»åŠ¡åˆ—è¡¨ -->
            <view class="batch-task-list">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card {{task.completed ? 'completed' : ''}}">
                <!-- ä»»åŠ¡ä¸»ä½“ -->
                <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <!-- å³ä¸Šè§’æ ‡ç­¾ -->
                  <view class="task-badges-top">
                        <view class="type-badge type-{{task.type}}">
                          <text class="type-text">{{healthUtils.getTypeName(task.type)}}</text>
                        </view>
                      </view>
                  
                  <view class="task-content">
                    <view class="task-header-info">
                      <text class="task-title {{task.completed ? 'completed' : ''}}" data-completed="{{task.completed}}" data-task-id="{{task._id}}">{{task.title}}</text>
                    </view>
                    
                    <view class="task-description">{{task.description}}</view>
                    
                    <view class="task-meta-info">
                      <view wx:if="{{task.estimatedTime}}" class="meta-item">
                        <text class="meta-text">é¢„è®¡ç”¨æ—¶ï¼š{{task.estimatedTime}}åˆ†é’Ÿ</text>
                      </view>
                      <view wx:if="{{task.dosage}}" class="meta-item meta-item-full">
                        <text class="meta-text">ç”¨é‡ï¼š{{task.dosage}}</text>
                      </view>
                      <view wx:if="{{task.duration}}" class="meta-item meta-item-full">
                        <text class="meta-text">è¿ç»­ç¬¬{{task.dayInSeries}}/{{task.duration}}å¤©</text>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- æ— ä»»åŠ¡çŠ¶æ€ -->
        <view wx:else class="modern-empty-state">
          <view class="empty-content">
            <text class="empty-title">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡</text>
            <text class="empty-description">æ‰€æœ‰è®¡åˆ’ä»»åŠ¡å‡å·²å®Œæˆ</text>
          </view>
        </view>
      </view>

      <!-- å³å°†åˆ°æ¥å­æ ‡ç­¾ -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'upcoming'}}">
        <!-- æŒ‰æ‰¹æ¬¡åˆ†ç»„çš„å³å°†åˆ°æ¥ä»»åŠ¡åˆ—è¡¨ -->
        <view wx:if="{{upcomingTasksByBatch.length > 0}}" class="batch-task-groups">
          <view wx:for="{{upcomingTasksByBatch}}" wx:key="id" class="batch-group">
            <!-- æ‰¹æ¬¡ç»„å¤´éƒ¨ -->
            <view class="batch-group-header">
              <view class="batch-group-info">
                <text class="batch-group-title">{{item.batchNumber}}</text>
                <text class="batch-group-separator">Â·</text>
                <text class="batch-group-age">ç¬¬{{item.dayAge}}æ—¥é¾„</text>
              </view>
              <view class="batch-task-count">{{item.tasks.length}}ä¸ªä»»åŠ¡</view>
            </view>
            
            <!-- è¯¥æ‰¹æ¬¡çš„å³å°†åˆ°æ¥ä»»åŠ¡åˆ—è¡¨ -->
            <view class="batch-task-list">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card upcoming">
                <!-- ä»»åŠ¡ä¸»ä½“ -->
                <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <!-- å³ä¸Šè§’æ ‡ç­¾ -->
                  <view class="task-badges-top">
                    <view class="type-badge type-{{task.type}}">
                      <text class="type-text">{{healthUtils.getTypeName(task.type)}}</text>
              </view>
            </view>

                  <view class="task-content">
                    <view class="task-header-info">
                    <text class="task-title">{{task.title}}</text>
                      </view>
                    
                    <view class="task-description">{{task.description}}</view>
                    
                    <view class="task-meta-info">
                      <view wx:if="{{task.dayAge}}" class="meta-item">
                        <text class="meta-text">ç¬¬{{task.dayAge}}æ—¥é¾„</text>
                    </view>
                      <view wx:if="{{task.estimatedTime}}" class="meta-item">
                        <text class="meta-text">é¢„è®¡ç”¨æ—¶ï¼š{{task.estimatedTime}}åˆ†é’Ÿ</text>
                  </view>
                      <view wx:if="{{task.dosage}}" class="meta-item meta-item-full">
                        <text class="meta-text">ç”¨é‡ï¼š{{task.dosage}}</text>
                </view>
                      <view wx:if="{{task.duration}}" class="meta-item meta-item-full">
                        <text class="meta-text">è¿ç»­ç¬¬{{task.dayInSeries}}/{{task.duration}}å¤©</text>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- æ— å³å°†åˆ°æ¥çš„ä»»åŠ¡ -->
        <view wx:else class="modern-empty-state">
          <view class="empty-content">
            <text class="empty-title">æš‚æ— å³å°†åˆ°æ¥çš„ä»»åŠ¡</text>
            <text class="empty-description">å½“å‰æ²¡æœ‰å³å°†åˆ°æ¥çš„è®¡åˆ’ä»»åŠ¡</text>
          </view>
        </view>
      </view>

      <!-- å·²å®Œæˆå­æ ‡ç­¾ -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'history'}}">
        <!-- æŒ‰æ‰¹æ¬¡åˆ†ç»„çš„å·²å®Œæˆä»»åŠ¡åˆ—è¡¨ -->
        <view wx:if="{{historyTasksByBatch.length > 0}}" class="batch-task-groups">
          <view wx:for="{{historyTasksByBatch}}" wx:key="id" class="batch-group">
            <!-- æ‰¹æ¬¡ç»„å¤´éƒ¨ -->
            <view class="batch-group-header">
              <view class="batch-group-info">
                <text class="batch-group-title">{{item.batchNumber}}</text>
                <text class="batch-group-separator">Â·</text>
                <text class="batch-group-age">ç¬¬{{item.dayAge}}æ—¥é¾„</text>
                </view>
              <view class="batch-task-count">{{item.tasks.length}}ä¸ªä»»åŠ¡</view>
                  </view>
            
            <!-- è¯¥æ‰¹æ¬¡çš„å·²å®Œæˆä»»åŠ¡åˆ—è¡¨ -->
            <view class="batch-task-list">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card completed">
                <!-- ä»»åŠ¡ä¸»ä½“ -->
                <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <!-- å³ä¸Šè§’æ ‡ç­¾ -->
                  <view class="task-badges-top">
                    <view class="type-badge type-{{task.type}}">
                      <text class="type-text">{{healthUtils.getTypeName(task.type)}}</text>
                </view>
              </view>
                  
                  <view class="task-content">
                    <view class="task-header-info">
                      <text class="task-title completed">{{task.title}}</text>
              </view>
                    
                    <view class="task-description">{{task.description}}</view>
                    
                    <view class="task-meta-info">
                      <view wx:if="{{task.completedDate}}" class="meta-item">
                        <text class="meta-text">å®Œæˆæ—¶é—´ï¼š{{task.completedDate}}</text>
            </view>
                      <view wx:if="{{task.dosage}}" class="meta-item meta-item-full">
                        <text class="meta-text">ç”¨é‡ï¼š{{task.dosage}}</text>
                      </view>
                      <view wx:if="{{task.duration}}" class="meta-item meta-item-full">
                        <text class="meta-text">è¿ç»­ç¬¬{{task.dayInSeries}}/{{task.duration}}å¤©</text>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <view wx:else class="modern-empty-state">
          <view class="empty-content">
            <text class="empty-title">æš‚æ— å·²å®Œæˆçš„ä»»åŠ¡</text>
            <text class="empty-description">å½“å‰æ²¡æœ‰å·²å®Œæˆçš„ä»»åŠ¡è®°å½•</text>
          </view>
        </view>
      </view>

    </view>


    <!-- è¯Šç–—ç®¡ç† Tab -->
    <view class="tab-content treatment-content" wx:if="{{activeTab === 'treatment'}}">
      <!-- è¯Šç–—ç»Ÿè®¡ -->
      <view class="treatment-stats">
        <!-- AIè¯Šæ–­å¡ç‰‡ï¼ˆå•ç‹¬ä¸€è¡Œï¼‰ -->
        <view class="stat-card stat-card-ai-diagnosis stat-card-full-width" bind:tap="onTreatmentAction" data-action="start_diagnosis">
          <view class="stat-icon stat-icon-ai">
            <view class="css-icon-ai">âš¡</view>
          </view>
          <view class="stat-content">
            <text class="stat-value">AIæ™ºèƒ½è¯Šæ–­</text>
            <text class="stat-label">å¿«é€Ÿè¯†åˆ«ç–¾ç—…ï¼Œæ™ºèƒ½æ¨èæ²»ç–—æ–¹æ¡ˆ</text>
          </view>
        </view>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆå››åˆ—ï¼‰ -->
        <view class="stats-grid stats-grid-four-treatment">
          <!-- å¼‚å¸¸ -->
          <view class="stat-card stat-card-abnormal" bind:tap="onAbnormalCountTap">
            <view class="stat-icon stat-icon-abnormal">
              <view class="css-icon-alert"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{monitoringData.realTimeStatus.abnormalCount || healthStats.abnormalCount || 0}}</text>
              <text class="stat-label">å¾…å¤„ç†</text>
            </view>
          </view>

          <!-- æ²»ç–—ä¸­ -->
          <view class="stat-card stat-card-treating" bindtap="onOngoingTreatmentClick">
            <view class="stat-icon stat-icon-treating">
              <view class="css-icon-medicine"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentData.stats.ongoingTreatment}}</text>
              <text class="stat-label">æ²»ç–—ä¸­</text>
            </view>
          </view>
          
          <!-- æ²»æ„ˆæ•° -->
          <view class="stat-card stat-card-cured clickable" bindtap="navigateToCuredRecords">
            <view class="stat-icon stat-icon-cured">
              <view class="css-icon-heart"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentStats.recoveredCount || 0}}</text>
              <text class="stat-label">æ²»æ„ˆæ•°</text>
            </view>
          </view>

          <!-- æ­»äº¡æ•° -->
          <view class="stat-card stat-card-death" bind:tap="onDeathCountTap">
            <view class="stat-icon stat-icon-death">
              <view class="css-icon-cross"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{healthStats.deadCount}}</text>
              <text class="stat-label">æ­»äº¡æ•°</text>
            </view>
          </view>
        </view>
      </view>

      <!-- è¯Šæ–­è®°å½• -->
      <view class="diagnosis-history">
        <view class="section-header">
          <text class="section-title">è¯Šæ–­è®°å½•</text>
          <text class="sub-title">ï¼ˆè¿‘7å¤©ï¼‰</text>
          <text class="more-link" bind:tap="onViewAllDiagnosis">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
        <view class="diagnosis-records-list" wx:if="{{treatmentData.diagnosisHistory.length > 0}}">
          <view 
            class="diagnosis-record-item"
            wx:for="{{treatmentData.diagnosisHistory}}"
            wx:key="_id"
            bind:tap="onDiagnosisRecordTap"
            data-record="{{item}}"
          >
            <view class="record-main">
              <!-- ç–¾ç—…åç§° + ç½®ä¿¡åº¦æ ‡ç­¾ -->
              <view class="record-header">
                <text class="record-name">{{item.diagnosis}}</text>
                <view class="confidence-badge">
                  <text class="confidence-text">ç½®ä¿¡åº¦ {{item.confidence}}%</text>
                </view>
              </view>

              <!-- è®°å½•å†…å®¹ -->
              <view class="record-content">
                <!-- ç¬¬ä¸€è¡Œï¼šå—å½±å“æ•° + æ—¥é¾„ -->
                <view class="info-row">
                  <view class="info-group">
                    <text class="info-label">å—å½±å“ï¼š</text>
                    <text class="info-value">{{item.affectedCount || 0}}åª</text>
                  </view>
                  <view class="info-group">
                    <text class="info-label">æ—¥é¾„ï¼š</text>
                    <text class="info-value">{{item.dayAge || 0}}å¤©</text>
                  </view>
                </view>

                <!-- ç¬¬äºŒè¡Œï¼šç—‡çŠ¶ï¼ˆå¦‚æœæœ‰ï¼‰ -->
                <view class="info-row" wx:if="{{item.symptoms}}">
                  <view class="info-group full-width">
                    <text class="info-label">ç—‡çŠ¶ï¼š</text>
                    <text class="info-value symptoms-value">{{item.symptoms}}</text>
                  </view>
                </view>

                <!-- ç¬¬ä¸‰è¡Œï¼šAIè¯Šæ–­ + æ—¥æœŸ + å‘¨æœŸ -->
                <view class="record-footer">
                  <view class="footer-left">
                    <text class="operator-text">AIè¯Šæ–­</text>
                    <text class="date-text">{{item.diagnosisDate}}</text>
                  </view>
                  <text class="duration-text" wx:if="{{item.treatmentDuration}}">å‘¨æœŸï¼š{{item.treatmentDuration}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <t-empty 
            description="è¿‘7å¤©æš‚æ— è¯Šæ–­è®°å½•"
          />
        </view>
      </view>
    </view>

    <!-- æ•ˆæœåˆ†æ Tab -->
    <view class="tab-content analysis-content" wx:if="{{activeTab === 'analysis'}}">
      <!-- å­˜æ´»ç‡åˆ†æ -->
      <view class="survival-analysis">
        <view class="survival-cards-grid">
          <!-- å­˜æ´»ç‡å¡ç‰‡ -->
          <view class="stat-card stat-card-survival-rate">
            <view class="stat-icon stat-icon-survival-rate">
              <view class="css-icon-heart-pulse"></view>
          </view>
            <view class="stat-content">
              <text class="stat-label">å­˜æ´»ç‡</text>
            </view>
            <view class="stat-value-wrapper">
              <text class="stat-value">{{analysisData.survivalAnalysis.rate === '-' ? '-' : analysisData.survivalAnalysis.rate + '%'}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- é¢„é˜²ç»Ÿè®¡ -->
      <view class="prevention-stats-analysis">
        <view class="section-header">
          <text class="section-title">é¢„é˜²ç»Ÿè®¡</text>
        </view>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆä¸¤åˆ—ï¼‰ -->
        <view class="stats-grid stats-grid-two-analysis">
          <!-- é˜²ç–«ç”¨è¯ -->
          <view class="stat-card stat-card-vaccination clickable" bind:tap="onMedicationCountTap">
            <view class="stat-icon stat-icon-vaccination">
              <view class="css-icon-check-list"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{preventionData.stats.medicationCount || 0}}</text>
              <text class="stat-label">é˜²ç–«ç”¨è¯</text>
            </view>
          </view>

          <!-- ç–«è‹—è¿½è¸ª -->
          <view class="stat-card stat-card-vaccine-count clickable" bind:tap="onVaccineCountTap">
            <view class="stat-icon stat-icon-vaccine-count">
              <view class="css-icon-check-list"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{preventionData.stats.vaccineCount || 0}}</text>
              <text class="stat-label">ç–«è‹—è¿½è¸ª</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æˆæœ¬åˆ†æ -->
      <view class="cost-analysis">
        <view class="section-header">
          <text class="section-title">æˆæœ¬åˆ†æ</text>
        </view>
        <view class="stats-grid stats-grid-four-cost">
          <!-- é¢„é˜²æˆæœ¬ -->
          <view class="stat-card stat-card-prevention-cost-analysis">
            <view class="stat-icon stat-icon-prevention-cost-analysis">
              <view class="css-icon-shield"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">Â¥{{analysisData.costAnalysis.preventionCost || 0}}</text>
              <text class="stat-label">é¢„é˜²æˆæœ¬</text>
            </view>
          </view>

          <!-- æ²»ç–—æˆæœ¬ -->
          <view class="stat-card stat-card-treatment-cost-analysis">
            <view class="stat-icon stat-icon-treatment-cost-analysis">
              <view class="css-icon-medicine-cost"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">Â¥{{analysisData.costAnalysis.treatmentCost || 0}}</text>
              <text class="stat-label">æ²»ç–—æˆæœ¬</text>
            </view>
          </view>
          
          <!-- æ€»æˆæœ¬ -->
          <view class="stat-card stat-card-total-cost">
            <view class="stat-icon stat-icon-total-cost">
              <view class="css-icon-total"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">Â¥{{analysisData.costAnalysis.totalCost || 0}}</text>
              <text class="stat-label">æ€»æˆæœ¬</text>
            </view>
          </view>

          <!-- æŠ•å…¥å›æŠ¥ç‡ -->
          <view class="stat-card stat-card-roi">
            <view class="stat-icon stat-icon-roi">
              <view class="css-icon-growth"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{analysisData.costAnalysis.roi === '-' ? '-' : (analysisData.costAnalysis.roi || 0) + ':1'}}</text>
              <text class="stat-label">æŠ•å…¥å›æŠ¥ç‡</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
    <view style="height: 120rpx;"></view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <bottom-popup
    visible="{{showDetailPopup}}"
    title="è¯¦æƒ…ä¿¡æ¯"
    show-close="{{true}}"
    bind:close="onCloseDetail"
    bind:visiblechange="onHealthDetailPopupChange"
  >
    <view wx:if="{{selectedRecord}}" class="detail-content">
      <view class="detail-card">
        <text class="detail-info">{{selectedRecord.title || selectedRecord.name || selectedRecord.symptoms}}</text>
        <text class="detail-desc">{{selectedRecord.description || selectedRecord.content}}</text>
        <text class="detail-time">{{selectedRecord.createTime || selectedRecord.date}}</text>
      </view>
    </view>
  </bottom-popup>

  <!-- âœ… è¯Šæ–­è®°å½•è¯¦æƒ…å¼¹çª—ï¼ˆå¤ç”¨ diagnosis-history çš„å¼¹çª—ç»“æ„ï¼‰ -->
  <bottom-popup
    visible="{{showDiagnosisDetailPopup}}"
    title="è¯Šæ–­è¯¦æƒ…"
    show-close="{{true}}"
    bind:close="onCloseDiagnosisDetail"
  >
    <view wx:if="{{selectedDiagnosisRecord}}" class="diagnosis-detail-content">
      <!-- AIè¯Šæ–­ç»“æœ -->
      <view class="detail-section">
        <view class="detail-section-title">
          <text>AIè¯Šæ–­ç»“æœ</text>
          <t-tag wx:if="{{!selectedDiagnosisRecord.isCorrected}}" theme="primary" size="small">AIåˆ†æ</t-tag>
        </view>
        <view class="detail-item">
          <text class="detail-label">ç–¾ç—…åç§°</text>
          <text class="detail-value primary">{{selectedDiagnosisRecord.diagnosisResult || selectedDiagnosisRecord.diagnosis}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">ç½®ä¿¡åº¦</text>
          <text class="detail-value confidence">{{selectedDiagnosisRecord.confidence}}%</text>
        </view>
      </view>

      <!-- è¯Šæ–­ä¿®æ­£è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
      <view class="detail-section correction-section" wx:if="{{selectedDiagnosisRecord.isCorrected}}">
        <view class="detail-section-title">
          <text>è¯Šæ–­ä¿®æ­£è®°å½•</text>
          <t-tag theme="success" size="small">å·²ç¡®è®¤</t-tag>
        </view>
        <view class="detail-item">
          <text class="detail-label">ä¿®æ­£åè¯Šæ–­</text>
          <text class="detail-value primary corrected">{{selectedDiagnosisRecord.correctedDiagnosis}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.aiAccuracyRating > 0}}">
          <text class="detail-label">AIå‡†ç¡®æ€§è¯„åˆ†</text>
          <view class="rating-display">
              <text 
              wx:for="{{[1,2,3,4,5]}}" 
              wx:key="*this"
                class="star-display {{selectedDiagnosisRecord.aiAccuracyRating >= item ? 'active' : ''}}"
              >{{selectedDiagnosisRecord.aiAccuracyRating >= item ? 'â˜…' : 'â˜†'}}</text>
          </view>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.veterinarianDiagnosis}}">
          <text class="detail-label">å…½åŒ»è¯Šæ–­</text>
          <text class="detail-value text-content">{{selectedDiagnosisRecord.veterinarianDiagnosis}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.correctionReason}}">
          <text class="detail-label">ä¿®æ­£åŸå› </text>
          <text class="detail-value text-content">{{selectedDiagnosisRecord.correctionReason}}</text>
        </view>
      </view>

      <!-- ç—‡çŠ¶æè¿° -->
      <view class="detail-section" wx:if="{{selectedDiagnosisRecord.symptoms}}">
        <view class="detail-section-title">ç—‡çŠ¶æè¿°</view>
        <view class="detail-text-content">
          <text class="detail-text">{{selectedDiagnosisRecord.symptoms}}</text>
        </view>
      </view>

      <!-- è¯Šæ–­å›¾ç‰‡ -->
      <view class="detail-section" wx:if="{{selectedDiagnosisRecord.images && selectedDiagnosisRecord.images.length > 0}}">
        <view class="detail-section-title">
          {{selectedDiagnosisRecord.diagnosisType === 'autopsy_analysis' ? 'å‰–æ£€å›¾ç‰‡' : 'ç—‡çŠ¶å›¾ç‰‡'}}
          <text class="image-count">({{selectedDiagnosisRecord.images.length}}å¼ )</text>
        </view>
        <view class="diagnosis-images">
          <view 
            class="image-item"
            wx:for="{{selectedDiagnosisRecord.images}}"
            wx:key="index"
            bind:tap="onPreviewDiagnosisImage"
            data-url="{{item}}"
          >
            <t-image 
              src="{{item}}"
              mode="aspectFill"
              width="200rpx"
              height="200rpx"
              shape="round"
              error="åŠ è½½å¤±è´¥"
              lazy-load="{{false}}"
            />
          </view>
        </view>
      </view>

      <!-- å»ºè®®ç”¨è¯ -->
      <view class="detail-section" wx:if="{{selectedDiagnosisRecord.recommendedMedications && selectedDiagnosisRecord.recommendedMedications.length > 0}}">
        <view class="detail-section-title">å»ºè®®ç”¨è¯</view>
        <view class="medications-list">
          <view class="medication-item" wx:for="{{selectedDiagnosisRecord.recommendedMedications}}" wx:key="index">
            <text class="medication-icon">ğŸ’Š</text>
            <text class="medication-name">{{item}}</text>
          </view>
        </view>
      </view>

      <!-- å®é™…æ²»ç–—è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
      <view class="detail-section treatment-section" wx:if="{{selectedDiagnosisRecord.actualTreatment}}">
        <view class="detail-section-title">
          <text>å®é™…æ²»ç–—è®°å½•</text>
          <t-tag theme="primary" size="small">å·²æ‰§è¡Œ</t-tag>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.actualTreatment.treatmentPlan}}">
          <text class="detail-label">æ²»ç–—æ–¹æ¡ˆ</text>
          <text class="detail-value text-content">{{selectedDiagnosisRecord.actualTreatment.treatmentPlan}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.actualTreatment.medications && selectedDiagnosisRecord.actualTreatment.medications.length > 0}}">
          <text class="detail-label">ç”¨è¯è®°å½•</text>
          <view class="medications-list-actual">
            <view class="medication-item-actual" wx:for="{{selectedDiagnosisRecord.actualTreatment.medications}}" wx:key="index">
              <text class="medication-icon">ğŸ’Š</text>
              <view class="medication-info">
                <text class="medication-name">{{item.name || item}}</text>
                <text class="medication-detail" wx:if="{{item.dosage}}">{{item.dosage}}</text>
              </view>
            </view>
          </view>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.actualTreatment.outcome}}">
          <text class="detail-label">æ²»ç–—ç»“æœ</text>
          <text class="detail-value">{{selectedDiagnosisRecord.actualTreatment.outcome}}</text>
        </view>
      </view>

      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="detail-section-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="detail-item">
          <text class="detail-label">å—å½±å“æ•°é‡</text>
          <text class="detail-value">{{selectedDiagnosisRecord.affectedCount || 0}}åª</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">é¹…åªæ—¥é¾„</text>
          <text class="detail-value">{{selectedDiagnosisRecord.dayAge || 0}}å¤©</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">è¯Šæ–­æ—¶é—´</text>
          <text class="detail-value">{{selectedDiagnosisRecord.diagnosisDate || selectedDiagnosisRecord.createTime}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.treatmentDuration}}">
          <text class="detail-label">æ²»ç–—å‘¨æœŸ</text>
          <text class="detail-value">{{selectedDiagnosisRecord.treatmentDuration}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- æ‰¹æ¬¡ç­›é€‰ä¸‹æ‹‰èœå•ï¼ˆæ”¾åœ¨æœ€åï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ï¼‰ -->
  <view class="batch-dropdown {{showBatchDropdown ? 'show' : ''}}" style="top: {{dropdownTop}}px;" wx:if="{{showBatchDropdown}}">
    <!-- å…¨éƒ¨æ‰¹æ¬¡é€‰é¡¹ -->
    <view 
      class="dropdown-item {{'all' === currentBatchId ? 'active' : ''}}"
      bind:tap="selectAllBatches"
    >
      <view class="item-content">
        <text class="item-title">å…¨éƒ¨æ‰¹æ¬¡</text>
        <text class="item-subtitle">æŸ¥çœ‹æ‰€æœ‰æ‰¹æ¬¡çš„å¥åº·æ•°æ®æ±‡æ€»</text>
      </view>
      <text class="check-mark" wx:if="{{'all' === currentBatchId}}">âœ“</text>
    </view>
    
    <!-- åˆ†éš”çº¿ -->
    <view class="dropdown-divider" wx:if="{{availableBatches.length > 0}}"></view>
    
    <!-- å…·ä½“æ‰¹æ¬¡åˆ—è¡¨ -->
    <view 
      class="dropdown-item {{item._id === currentBatchId ? 'active' : ''}}"
      wx:for="{{availableBatches}}"
      wx:key="_id"
      bind:tap="selectBatchFromDropdown"
      data-index="{{index}}"
    >
      <view class="item-content">
        <text class="item-title">{{item.batchNumber}}</text>
        <text class="item-subtitle">{{item.breed}} Â· {{item.dayAge}}æ—¥é¾„ Â· {{item.quantity}}åª</text>
      </view>
      <text class="check-mark" wx:if="{{item._id === currentBatchId}}">âœ“</text>
    </view>
    
    <view class="dropdown-empty" wx:if="{{availableBatches.length === 0}}">
      <text>æš‚æ— å­˜æ æ‰¹æ¬¡</text>
    </view>
  </view>

  <!-- é®ç½©å±‚ï¼ˆæ”¾åœ¨æœ€åï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ï¼‰ -->
  <view 
    class="dropdown-mask {{showBatchDropdown ? 'show' : ''}}" 
    wx:if="{{showBatchDropdown}}"
    bind:tap="closeBatchDropdown"
    catchtouchmove="preventTouchMove"
  ></view>

  <!-- ========== ä» breeding-todo å®Œæ•´å¤åˆ¶çš„è¡¨å•å¼¹çª— ========== -->
  
  <!-- ä»»åŠ¡è¯¦æƒ…å¼¹çª— -->
  <bottom-popup
    visible="{{showTaskDetailPopup}}"
    title="ä»»åŠ¡è¯¦æƒ…"
    show-close="{{true}}"
    bind:close="closeTaskDetailPopup"
    bind:visiblechange="onTaskDetailPopupChange"
  >
    <view wx:if="{{selectedTask}}" class="record-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">ä»»åŠ¡åç§°ï¼š</text>
            <text class="info-value auto-align {{taskFieldMultiline.title ? 'multiline' : ''}}" id="info-value-title">{{selectedTask.title || 'æœªå‘½åä»»åŠ¡'}}</text>
          </view>
          <view class="divider-line"></view>

          <view class="info-row">
            <text class="info-label">ä»»åŠ¡ç±»å‹ï¼š</text>
            <text class="info-value auto-align {{taskFieldMultiline.type ? 'multiline' : ''}}" id="info-value-type">{{selectedTask.typeName || 'æœªåˆ†ç±»'}}</text>
          </view>
          <view class="divider-line"></view>

          <block wx:if="{{selectedTask.estimatedTime}}">
            <view class="info-row">
              <text class="info-label">é¢„è®¡ç”¨æ—¶ï¼š</text>
              <text class="info-value auto-align {{taskFieldMultiline.time ? 'multiline' : ''}}" id="info-value-time">{{selectedTask.estimatedTime}}åˆ†é’Ÿ</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.duration && selectedTask.dayInSeries}}">
            <view class="info-row">
              <text class="info-label">è¿ç»­ä»»åŠ¡ï¼š</text>
              <text class="info-value auto-align {{taskFieldMultiline.duration ? 'multiline' : ''}}" id="info-value-duration">ç¬¬{{selectedTask.dayInSeries}}/{{selectedTask.duration}}å¤©</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.materials && selectedTask.materials.length > 0}}">
            <view class="info-row">
              <text class="info-label">æ‰€éœ€ç‰©æ–™ï¼š</text>
              <text class="info-value materials-text auto-align {{taskFieldMultiline.materials ? 'multiline' : ''}}" id="info-value-materials">
                <text wx:for="{{selectedTask.materials}}" wx:key="index">{{item}}<text wx:if="{{index < selectedTask.materials.length - 1}}">ã€</text></text>
              </text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.batchNumber}}">
            <view class="info-row">
              <text class="info-label">æ‰¹æ¬¡ç¼–å·ï¼š</text>
              <text class="info-value auto-align {{taskFieldMultiline.batch ? 'multiline' : ''}}" id="info-value-batch">{{selectedTask.batchNumber}}</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.dayAge}}">
            <view class="info-row">
              <text class="info-label">æ—¥é¾„ï¼š</text>
              <text class="info-value auto-align {{taskFieldMultiline.age ? 'multiline' : ''}}" id="info-value-age">ç¬¬{{selectedTask.dayAge}}æ—¥é¾„</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.description}}">
            <view class="info-row info-row-description">
              <text class="info-label">ä»»åŠ¡æè¿°ï¼š</text>
              <text class="info-value note-text auto-align {{taskFieldMultiline.description ? 'multiline' : ''}}" id="info-value-description">{{selectedTask.description}}</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.dosage}}">
            <view class="info-row info-row-dosage">
              <text class="info-label">ç”¨é‡ï¼š</text>
              <text class="info-value dosage-text auto-align {{taskFieldMultiline.dosage ? 'multiline' : ''}}" id="info-value-dosage">{{selectedTask.dosage}}</text>
            </view>
            <view class="divider-line"></view>
          </block>
          
          <!-- å·²å®Œæˆä»»åŠ¡çš„é¢å¤–ä¿¡æ¯ -->
          <view wx:if="{{selectedTask.completed}}">
            <view class="info-row" wx:if="{{selectedTask.completedDate}}">
              <text class="info-label">å®Œæˆæ—¶é—´ï¼š</text>
              <text class="info-value">{{selectedTask.completedDate}}</text>
            </view>
            <view class="divider-line" wx:if="{{selectedTask.completedDate && selectedTask.completedBy}}"></view>
            <view class="info-row" wx:if="{{selectedTask.completedBy}}">
              <text class="info-label">å®Œæˆäººå‘˜ï¼š</text>
              <text class="info-value">{{selectedTask.completedBy}}</text>
            </view>
            
            <!-- ç”¨è¯ç®¡ç†ç±»å‹çš„ç‰¹æ®Šä¿¡æ¯ -->
            <view wx:if="{{selectedTask.isMedicationTask && selectedTask.medicationDetails}}" class="medication-info-card">
              <view class="card-title">ç”¨è¯ä¿¡æ¯</view>
              <view class="info-row">
                <text class="info-label">è¯å“åç§°ï¼š</text>
                <text class="info-value">{{selectedTask.medicationDetails.name || 'æœªè®°å½•'}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.medicationDetails.actualDosage}}">
                <text class="info-label">å®é™…ç”¨é‡ï¼š</text>
                <text class="info-value">{{selectedTask.medicationDetails.actualDosage}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.medicationDetails.method}}">
                <text class="info-label">ç”¨è¯æ–¹å¼ï¼š</text>
                <text class="info-value">{{selectedTask.medicationDetails.method}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.medicationDetails.batchNumber}}">
                <text class="info-label">è¯å“æ‰¹å·ï¼š</text>
                <text class="info-value">{{selectedTask.medicationDetails.batchNumber}}</text>
              </view>
            </view>
            
            <!-- ç–«è‹—æ¥ç§ç±»å‹çš„ç‰¹æ®Šä¿¡æ¯ -->
            <view wx:if="{{selectedTask.isVaccineTask && selectedTask.vaccineDetails}}" class="vaccine-info-card">
              <view class="card-title">æ¥ç§ä¿¡æ¯</view>
              <view class="info-row">
                <text class="info-label">ç–«è‹—åç§°ï¼š</text>
                <text class="info-value">{{selectedTask.vaccineDetails.name || 'æœªè®°å½•'}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.vaccineDetails.batchNumber}}">
                <text class="info-label">ç–«è‹—æ‰¹å·ï¼š</text>
                <text class="info-value">{{selectedTask.vaccineDetails.batchNumber}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.vaccineDetails.dosage}}">
                <text class="info-label">æ¥ç§å‰‚é‡ï¼š</text>
                <text class="info-value">{{selectedTask.vaccineDetails.dosage}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.vaccineDetails.count}}">
                <text class="info-label">æ¥ç§æ•°é‡ï¼š</text>
                <text class="info-value">{{selectedTask.vaccineDetails.count}}åª</text>
            </view>
            </view>
          </view>
          
          <view class="info-row info-row-notes" wx:if="{{selectedTask.notes}}">
            <text class="info-label">æ³¨æ„äº‹é¡¹ï¼š</text>
            <text class="info-value note-text important-text auto-align {{taskFieldMultiline.notes ? 'multiline' : ''}}" id="info-value-notes">{{selectedTask.notes}}</text>
          </view>

          <!-- å®ŒæˆçŠ¶æ€æ”¾åœ¨æœ€ä¸‹æ–¹ -->
          <view class="divider-line"></view>
          <view class="info-row">
            <text class="info-label">å®ŒæˆçŠ¶æ€ï¼š</text>
            <view class="status-value">
              <t-tag theme="{{selectedTask.completed ? 'success' : 'primary'}}" size="small">
                {{selectedTask.statusText || 'å¾…å®Œæˆ'}}
              </t-tag>
            </view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æ“ä½œæŒ‰é’® - ä»…å¾…å®Œæˆä»»åŠ¡æ˜¾ç¤º -->
      <view class="task-detail-actions" wx:if="{{selectedTask && !selectedTask.completed && !selectedTask.isUpcoming}}">
        <t-button 
          theme="primary" 
          size="large" 
          block
          bind:tap="onTaskConfirm"
        >
          {{selectedTask.isVaccineTask ? 'å¡«å†™æ¥ç§ä¿¡æ¯' : (selectedTask.isMedicationTask ? 'é¢†å–è¯å“' : (selectedTask.isNutritionTask ? 'é¢†å–è¥å…»å“' : 'å®Œæˆä»»åŠ¡'))}}
        </t-button>
      </view>
    </view>
  </bottom-popup>

  <!-- ç–«è‹—æ¥ç§è¡¨å•å¼¹çª— -->
  <bottom-popup
    visible="{{showVaccineFormPopup}}"
    title="ç–«è‹—æ¥ç§ä¿¡æ¯"
    show-close="{{true}}"
    bind:close="closeVaccineFormPopup"
  >
    <view class="vaccine-form-content">
      <!-- å…½åŒ»ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å…½åŒ»ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">æ‰§è¡Œå…½åŒ»</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥å…½åŒ»å§“å"
                 value=""
                 data-field="veterinarianName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">è”ç³»ç”µè¯</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
                 value=""
                 data-field="veterinarianPhone"
                 bindinput="onVaccineFormInput" />
        </view>
      </view>

      <!-- ç–«è‹—ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">ç–«è‹—ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ç–«è‹—åç§°</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç–«è‹—åç§°"
                 value=""
                 data-field="vaccineName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">ç”Ÿäº§å‚å®¶</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç”Ÿäº§å‚å®¶"
                 value=""
                 data-field="manufacturer"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ‰¹æ¬¡å·</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç–«è‹—æ‰¹æ¬¡å·"
                 value=""
                 data-field="batchNumber"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">æ¥ç§å‰‚é‡</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥æ¥ç§å‰‚é‡"
                 value=""
                 data-field="dosage"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">æ¥ç§æ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="{{currentBatchStockQuantity > 0 ? 'è¯·è¾“å…¥æ¥ç§æ•°é‡ï¼ˆå­˜æ ' + currentBatchStockQuantity + 'åªï¼‰' : 'è¯·è¾“å…¥æ¥ç§æ•°é‡'}}"
                 value=""
                 data-field="vaccinationCount"
                 bindinput="onVaccineNumberInput" />
          <text wx:if="{{vaccineFormErrors.vaccinationCount}}" class="error-text">{{vaccineFormErrors.vaccinationCount}}</text>
        </view>
      </view>

      <!-- è´¹ç”¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">è´¹ç”¨ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ç–«è‹—è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥ç–«è‹—è´¹ç”¨"
                 value=""
                 data-field="vaccineCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">å…½åŒ»è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥å…½åŒ»è´¹ç”¨"
                 value=""
                 data-field="veterinaryCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">å…¶ä»–è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥å…¶ä»–è´¹ç”¨"
                 value=""
                 data-field="otherCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ€»è´¹ç”¨</text>
          <view class="form-input readonly-input">{{vaccineFormData.totalCostFormatted}}</view>
        </view>
      </view>

      <!-- å¤‡æ³¨å’Œå¼‚å¸¸è®°å½• -->
      <view class="form-section">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥æ¥ç§å¤‡æ³¨ä¿¡æ¯"
                    value=""
                    data-field="notes"
                    bindinput="onVaccineFormInput"
                    maxlength="200"
                    auto-height />
        </view>
      </view>

      <!-- è¡¨å•éªŒè¯é”™è¯¯æç¤º -->
      <view wx:if="{{vaccineFormErrorList && vaccineFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{vaccineFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="form-bottom-buttons">
        <button class="form-button form-button-cancel" bindtap="closeVaccineFormPopup">å–æ¶ˆ</button>
        <button class="form-button form-button-primary" bindtap="submitVaccineForm">å®Œæˆæ¥ç§</button>
      </view>
    </view>
  </bottom-popup>

  <!-- å¼‚å¸¸ååº”å¤„ç†å¼¹çª— -->
  <bottom-popup
    visible="{{showAdverseReactionPopup}}"
    title="å¼‚å¸¸ååº”å¤„ç†"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="è®°å½•å¼‚å¸¸"
    cancel-text="å–æ¶ˆ"
    bind:close="closeAdverseReactionPopup"
    bind:confirm="submitAdverseReactionRecord"
    bind:cancel="closeAdverseReactionPopup"
  >
    <view class="adverse-reaction-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">å¼‚å¸¸æ•°é‡ï¼š</text>
            <text class="info-value">{{adverseReactionData.count}}åª</text>
          </view>
          <view class="info-row">
            <text class="info-label">å¼‚å¸¸ç—‡çŠ¶ï¼š</text>
            <text class="info-value">{{adverseReactionData.symptoms}}</text>
          </view>
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">è¡¥å……ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label">ç—‡çŠ¶ç­‰çº§</text>
          <picker mode="selector" 
                  range="{{severityOptions}}"
                  range-key="label"
                  value="{{adverseReactionData.severityIndex}}"
                  bindchange="onSeverityChange">
            <view class="form-input picker-input">
              {{severityOptions[adverseReactionData.severityIndex].label}}
            </view>
          </picker>
        </view>
        <view class="form-row">
          <text class="form-label">å¤„ç†æªæ–½</text>
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥å·²é‡‡å–çš„å¤„ç†æªæ–½"
                    value="{{adverseReactionData.treatment}}"
                    data-field="treatment"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
        <view class="form-row">
          <text class="form-label">åç»­è§‚å¯Ÿ</text>
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥åç»­è§‚å¯Ÿè¦ç‚¹"
                    value="{{adverseReactionData.followUp}}"
                    data-field="followUp"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- ç”¨è¯ç®¡ç†è¡¨å•å¼¹çª— -->
  <bottom-popup
    visible="{{showMedicationFormPopup}}"
    title="ç”¨è¯ç®¡ç†"
    show-close="{{true}}"
    bind:close="closeMedicationFormPopup"
  >
    <view class="medication-form-content">
      <!-- ç”¨è¯ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">ç”¨è¯ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">é€‰æ‹©è¯å“</text>
          <picker mode="selector" 
                  range="{{availableMedicines}}"
                  range-key="name"
                  bindchange="onMedicineSelect">
            <view class="form-input picker-input">
              {{selectedMedicine ? selectedMedicine.name : 'è¯·é€‰æ‹©è¯å“'}}
            </view>
          </picker>
          <text wx:if="{{medicationFormErrors.medicineId}}" class="error-text">{{medicationFormErrors.medicineId}}</text>
        </view>
        
        <view wx:if="{{selectedMedicine}}" class="medicine-info">
          <view class="info-item">
            <text class="info-label">å½“å‰åº“å­˜ï¼š</text>
            <text class="info-value">{{selectedMedicine.stock}}{{selectedMedicine.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedMedicine.description}}">
            <text class="info-label">è¯å“è¯´æ˜ï¼š</text>
            <text class="info-value">{{selectedMedicine.description}}</text>
          </view>
        </view>

        <view class="form-row">
          <text class="form-label required">ç”¨è¯æ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="è¯·è¾“å…¥ç”¨è¯æ•°é‡"
                 value="{{medicationFormData.quantity > 0 ? medicationFormData.quantity : ''}}"
                 bindinput="onMedicationQuantityInput" />
          <text wx:if="{{medicationFormErrors.quantity}}" class="error-text">{{medicationFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">ç”¨è¯å‰‚é‡</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç”¨è¯å‰‚é‡"
                 value="{{medicationFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onMedicationFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">é¹…åªæ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="{{currentBatchStockQuantity > 0 ? 'è¯·è¾“å…¥é¹…åªæ•°é‡ï¼ˆå­˜æ ' + currentBatchStockQuantity + 'åªï¼‰' : 'è¯·è¾“å…¥é¹…åªæ•°é‡'}}"
                 value="{{medicationFormData.animalCount > 0 ? medicationFormData.animalCount : ''}}"
                 bindinput="onMedicationAnimalCountInput" />
          <text wx:if="{{medicationFormErrors.animalCount}}" class="error-text">{{medicationFormErrors.animalCount}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">æ“ä½œå‘˜</text>
          <view class="form-input readonly-input">{{medicationFormData.operator}}</view>
        </view>
      </view>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥ç”¨è¯å¤‡æ³¨ä¿¡æ¯"
                    value="{{medicationFormData.notes}}"
                    data-field="notes"
                    bindinput="onMedicationFormInput"
                    maxlength="200"
                    auto-height="{{true}}"
                    show-confirm-bar="{{false}}" />
        </view>
      </view>

      <!-- è¡¨å•éªŒè¯é”™è¯¯æç¤º -->
      <view wx:if="{{medicationFormErrorList && medicationFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{medicationFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>

      <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
      <view class="form-actions">
        <t-button 
          theme="light" 
          size="large" 
          block
          bind:tap="closeMedicationFormPopup"
        >
          å–æ¶ˆ
        </t-button>
        <t-button 
          theme="primary" 
          size="large" 
          block
          bind:tap="submitMedicationForm"
        >
          ç¡®è®¤é¢†ç”¨
        </t-button>
      </view>
    </view>
  </bottom-popup>

  <!-- è¥å…»ç®¡ç†è¡¨å•å¼¹çª— -->
  <bottom-popup
    visible="{{showNutritionFormPopup}}"
    title="è¥å…»ç®¡ç†"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="ç¡®è®¤é¢†å–"
    cancel-text="å–æ¶ˆ"
    bind:close="closeNutritionFormPopup"
    bind:confirm="submitNutritionForm"
    bind:cancel="closeNutritionFormPopup"
  >
    <view class="nutrition-form-content">
      <!-- è¥å…»å“é€‰æ‹© -->
      <view class="form-section">
        <view class="section-title">è¥å…»å“é€‰æ‹©</view>
        <view class="form-row">
          <text class="form-label required">é€‰æ‹©è¥å…»å“</text>
          <picker mode="selector" 
                  range="{{availableNutrition}}"
                  range-key="name"
                  bindchange="onNutritionSelect">
            <view class="form-input picker-input">
              {{selectedNutrition ? selectedNutrition.name : 'è¯·é€‰æ‹©è¥å…»å“'}}
            </view>
          </picker>
          <text wx:if="{{nutritionFormErrors.nutritionId}}" class="error-text">{{nutritionFormErrors.nutritionId}}</text>
        </view>
        
        <view wx:if="{{selectedNutrition}}" class="nutrition-info">
          <view class="info-item">
            <text class="info-label">å½“å‰åº“å­˜ï¼š</text>
            <text class="info-value">{{selectedNutrition.stock}}{{selectedNutrition.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedNutrition.description}}">
            <text class="info-label">è¥å…»å“è¯´æ˜ï¼š</text>
            <text class="info-value">{{selectedNutrition.description}}</text>
          </view>
        </view>
      </view>

      <!-- ä½¿ç”¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">ä½¿ç”¨ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ä½¿ç”¨æ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="è¯·è¾“å…¥ä½¿ç”¨æ•°é‡"
                 value="{{nutritionFormData.quantity > 0 ? nutritionFormData.quantity : ''}}"
                 bindinput="onNutritionQuantityInput" />
          <text wx:if="{{nutritionFormErrors.quantity}}" class="error-text">{{nutritionFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">ä½¿ç”¨å‰‚é‡</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ä½¿ç”¨å‰‚é‡"
                 value="{{nutritionFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onNutritionFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ“ä½œå‘˜</text>
          <view class="form-input readonly-input">{{nutritionFormData.operator}}</view>
        </view>
      </view>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥è¥å…»å“ä½¿ç”¨å¤‡æ³¨ä¿¡æ¯"
                    value="{{nutritionFormData.notes}}"
                    data-field="notes"
                    bindinput="onNutritionFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- è¡¨å•éªŒè¯é”™è¯¯æç¤º -->
      <view wx:if="{{nutritionFormErrorList && nutritionFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{nutritionFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  </view>
  <!-- detail-view ç»“æŸ -->

</view>