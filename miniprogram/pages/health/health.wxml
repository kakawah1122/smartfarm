<!--health.wxml - å¥åº·ç®¡ç†ä¸­å¿ƒå®Œæ•´é‡æ„ç‰ˆæœ¬-->
<view class="page health-center-page">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar 
    title="å¥åº·ç®¡ç†ä¸­å¿ƒ"
    show-back="{{false}}"
  />

  <!-- è¯¦æƒ…è§†å›¾ -->
  <view class="detail-view">

    <!-- å¥åº·æ•°æ®æ¦‚è§ˆ -->
    <view class="health-stats-section">
      <view class="stats-grid stats-grid-two">
        <view class="stat-card stat-primary">
          <text class="stat-value">{{healthStats.healthyRate}}</text>
          <text class="stat-label">å¥åº·ç‡</text>
        </view>
        <view class="stat-card stat-mortality clickable" bind:tap="navigateToDeathRecords">
          <text class="stat-value">{{healthStats.mortalityRate}}</text>
          <text class="stat-label">æ­»äº¡ç‡ â€º</text>
        </view>
      </view>
    </view>

    <!-- æ‰¹æ¬¡ç­›é€‰å’ŒTabå¯¼èˆªå¡ç‰‡ç»„ -->
    <view class="filter-tabs-card">
      <!-- æ‰¹æ¬¡ç­›é€‰æ  -->
      <view class="batch-filter-section">
        <view class="filter-header">
          <view class="current-batch">
            <text class="label">å½“å‰æ‰¹æ¬¡</text>
            <text class="value">{{currentBatchNumber || 'è¯·é€‰æ‹©æ‰¹æ¬¡'}}</text>
          </view>
          <view class="filter-action" bind:tap="toggleBatchDropdown">
            <text class="action-text">ç­›é€‰</text>
            <text class="action-icon {{showBatchDropdown ? 'rotate' : ''}}">â–¾</text>
          </view>
        </view>
      </view>
      
      <!-- ä¸»è¦Tabåˆ‡æ¢ -->
      <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" class="health-main-tabs">
        <t-tab-panel value="prevention" label="é¢„é˜²ç®¡ç†"></t-tab-panel>
        <t-tab-panel value="treatment" label="è¯Šç–—ç®¡ç†"></t-tab-panel>
        <t-tab-panel value="analysis" label="æ•ˆæœåˆ†æ"></t-tab-panel>
      </t-tabs>
      
      <!-- é¢„é˜²ç®¡ç†å­æ ‡ç­¾é¡µï¼ˆæ•´åˆåˆ°å¡ç‰‡å†…ï¼‰ -->
      <view class="prevention-sub-tabs" wx:if="{{activeTab === 'prevention'}}">
        <t-tabs value="{{preventionSubTab}}" bind:change="onPreventionSubTabChange" theme="line">
          <t-tab-panel label="ä»Šæ—¥å¾…åŠ" value="today"></t-tab-panel>
          <t-tab-panel label="å…¨å‘¨æœŸ" value="timeline"></t-tab-panel>
          <t-tab-panel label="ç»Ÿè®¡" value="stats"></t-tab-panel>
          <t-tab-panel label="è®°å½•" value="records"></t-tab-panel>
        </t-tabs>
      </view>
    </view>

    <!-- æ´»è·ƒé¢„è­¦ -->
  <view class="active-alerts" wx:if="{{activeAlerts.length > 0}}">
    <view class="alert-header">
      <text class="alert-title">æ´»è·ƒé¢„è­¦</text>
      <text class="alert-count">{{activeAlerts.length}}æ¡</text>
    </view>
    <view class="alert-list">
      <view 
        class="alert-item alert-{{item.severity}}"
        wx:for="{{activeAlerts}}"
        wx:key="_id"
        bind:tap="onAlertAction"
        data-alert-id="{{item._id}}"
        data-action="acknowledge"
      >
        <view class="alert-content">
          <text class="alert-message">{{item.message}}</text>
          <text class="alert-time">{{item.createTime}}</text>
        </view>
        <view class="alert-action">
          <t-icon name="chevron-right" size="16" color="#c8c9cc" />
        </view>
      </view>
    </view>
  </view>

  <!-- Tabå†…å®¹åŒºåŸŸ -->
  <view class="tab-content-container">
    
    <!-- é¢„é˜²ç®¡ç† Tab (æ•´åˆå¾…åŠ+è®¡åˆ’+ç»Ÿè®¡+è®°å½•) -->
    <view class="tab-content prevention-content" wx:if="{{activeTab === 'prevention'}}">
      
      <!-- ä»Šæ—¥å¾…åŠå­æ ‡ç­¾ -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'today'}}">
        <!-- ä»Šæ—¥å¾…åŠ -->
        <view class="today-tasks-section" wx:if="{{preventionData.todayTasks && preventionData.todayTasks.length > 0}}">
          <view class="section-header">
            <text class="section-title">ğŸ“‹ ä»Šæ—¥å¾…åŠ ({{preventionData.todayTasks.length}}é¡¹)</text>
          </view>
          <view class="today-tasks-list">
            <view 
              class="task-card task-card-{{item.isOverdue ? 'overdue' : 'normal'}}"
              wx:for="{{preventionData.todayTasks}}"
              wx:key="taskId"
              bind:tap="onCompleteTask"
              data-task="{{item}}"
            >
              <view class="task-icon">
                <text class="task-emoji">{{item.taskType === 'vaccine' ? 'ğŸ’‰' : item.taskType === 'medication' ? 'ğŸ’Š' : 'ğŸ§¼'}}</text>
              </view>
              <view class="task-content">
                <view class="task-header">
                  <text class="task-name">{{item.taskName}}</text>
                  <t-tag wx:if="{{item.isOverdue}}" variant="light" theme="danger" size="small">é€¾æœŸ{{item.overdueDays}}å¤©</t-tag>
                </view>
                <text class="task-info">ğŸ“¦ æ‰¹æ¬¡ï¼š{{item.batchNumber}} (ç¬¬{{item.dayAge}}å¤©)</text>
                <text class="task-desc" wx:if="{{item.description}}">{{item.description}}</text>
              </view>
              <view class="task-action">
                <t-button size="small" theme="primary" variant="outline">å»å®Œæˆ</t-button>
              </view>
            </view>
          </view>
        </view>

        <!-- æ— å¾…åŠæç¤º -->
        <view class="empty-tasks" wx:else>
          <text class="empty-icon">ğŸ‰</text>
          <text class="empty-text">ä»Šæ—¥æ— é¢„é˜²ä»»åŠ¡</text>
          <text class="empty-hint">æ‰€æœ‰è®¡åˆ’ä»»åŠ¡å‡å·²å®Œæˆ</text>
        </view>

        <!-- è¿‘æœŸè®¡åˆ’æ—¶é—´çº¿ -->
        <view class="upcoming-tasks-section" wx:if="{{preventionData.upcomingTasks && preventionData.upcomingTasks.length > 0}}">
          <view class="section-header">
            <text class="section-title">ğŸ“… è¿‘æœŸè®¡åˆ’ (7å¤©)</text>
          </view>
          <view class="timeline">
            <view 
              class="timeline-item"
              wx:for="{{preventionData.upcomingTasks}}"
              wx:key="date"
            >
              <view class="timeline-date">
                <text class="date-text">ç¬¬{{item.dayAge}}å¤©</text>
                <text class="date-value">{{item.date}}</text>
              </view>
              <view class="timeline-tasks">
                <view 
                  class="timeline-task"
                  wx:for="{{item.tasks}}"
                  wx:key="taskId"
                  wx:for-item="task"
                >
                  <text class="timeline-task-icon">{{task.taskType === 'vaccine' ? 'ğŸ’‰' : task.taskType === 'medication' ? 'ğŸ’Š' : 'ğŸ§¼'}}</text>
                  <text class="timeline-task-name">{{task.taskName}}</text>
                  <t-tag variant="light" theme="default" size="small">è®¡åˆ’ä¸­</t-tag>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- å…¨å‘¨æœŸå­æ ‡ç­¾ -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'timeline'}}">
        <!-- æ‰¹æ¬¡ä¿¡æ¯ -->
        <view class="batch-info-card" wx:if="{{timelineData.batch}}">
          <view class="batch-info-header">
            <text class="batch-title">ğŸ“¦ {{timelineData.batch.batchNumber}}</text>
            <t-tag variant="light" theme="success" size="small">{{timelineData.batch.status === 'active' ? 'æ´»è·ƒ' : 'å·²å®Œæˆ'}}</t-tag>
          </view>
          <view class="batch-info-content">
            <text class="batch-detail">ğŸ“… å…¥æ æ—¥æœŸï¼š{{timelineData.batch.entryDate}}</text>
            <text class="batch-detail">ğŸ“ æ•°é‡ï¼š{{timelineData.batch.quantity}} åª</text>
          </view>
        </view>

        <!-- è¿›åº¦ç»Ÿè®¡ -->
        <view class="timeline-progress" wx:if="{{timelineData.progress}}">
          <view class="progress-bar-container">
            <view class="progress-bar-bg">
              <view class="progress-bar-fill" style="width: {{timelineData.progress.percentage}}%"></view>
            </view>
            <text class="progress-text">{{timelineData.progress.percentage}}%</text>
          </view>
          <view class="progress-stats">
            <view class="progress-stat">
              <text class="stat-label">æ€»è®¡</text>
              <text class="stat-value">{{timelineData.progress.total}}</text>
            </view>
            <view class="progress-stat">
              <text class="stat-label">å·²å®Œæˆ</text>
              <text class="stat-value stat-value-success">{{timelineData.progress.completed}}</text>
            </view>
            <view class="progress-stat">
              <text class="stat-label">å¾…å¤„ç†</text>
              <text class="stat-value stat-value-warning">{{timelineData.progress.pending}}</text>
            </view>
            <view class="progress-stat">
              <text class="stat-label">é€¾æœŸ</text>
              <text class="stat-value stat-value-danger">{{timelineData.progress.overdue}}</text>
            </view>
          </view>
        </view>

        <!-- å…¨å‘¨æœŸæ—¶é—´çº¿ -->
        <view class="full-timeline" wx:if="{{timelineData.timeline && timelineData.timeline.length > 0}}">
          <view class="section-header">
            <text class="section-title">ğŸ—“ é¢„é˜²è®¡åˆ’æ—¶é—´çº¿</text>
          </view>
          <view class="timeline-full-list">
            <view 
              class="timeline-full-item"
              wx:for="{{timelineData.timeline}}"
              wx:key="dayAge"
            >
              <!-- æ—¥æœŸæ ‡è®° -->
              <view class="timeline-marker">
                <view class="marker-line"></view>
                <view class="marker-dot"></view>
              </view>
              
              <!-- æ—¥æœŸä¿¡æ¯ -->
              <view class="timeline-date-info">
                <text class="day-age">ç¬¬{{item.dayAge}}å¤©</text>
                <text class="target-date">{{item.date}}</text>
              </view>
              
              <!-- ä»»åŠ¡åˆ—è¡¨ -->
              <view class="timeline-task-list">
                <view 
                  class="timeline-full-task task-status-{{task.status}}"
                  wx:for="{{item.tasks}}"
                  wx:key="taskId"
                  wx:for-item="task"
                  bind:tap="onCompleteTask"
                  data-task="{{task}}"
                >
                  <view class="task-header-row">
                    <view class="task-left">
                      <text class="task-icon-emoji">{{task.taskType === 'vaccine' ? 'ğŸ’‰' : task.taskType === 'medication' ? 'ğŸ’Š' : 'ğŸ§¼'}}</text>
                      <text class="task-name-text">{{task.taskName}}</text>
                    </view>
                    <t-tag 
                      variant="light" 
                      theme="{{task.status === 'completed' ? 'success' : task.status === 'overdue' ? 'danger' : 'default'}}" 
                      size="small"
                    >
                      {{task.status === 'completed' ? 'å·²å®Œæˆ' : task.status === 'overdue' ? 'é€¾æœŸ' : 'å¾…å¤„ç†'}}
                    </t-tag>
                  </view>
                  <text class="task-description" wx:if="{{task.description}}">{{task.description}}</text>
                  <view class="task-cost-info">
                    <text class="cost-item">ğŸ’° é¢„ç®—æˆæœ¬ï¼šÂ¥{{task.estimatedCost || 0}}</text>
                    <text class="cost-item" wx:if="{{task.actualCost}}">ğŸ’¸ å®é™…æˆæœ¬ï¼šÂ¥{{task.actualCost}}</text>
                  </view>
                  <text class="completed-time" wx:if="{{task.completedAt}}">âœ… å®Œæˆæ—¶é—´ï¼š{{task.completedAt}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-timeline" wx:else>
          <text class="empty-icon">ğŸ“‹</text>
          <text class="empty-text">æš‚æ— æ—¶é—´çº¿æ•°æ®</text>
          <text class="empty-hint">è¯·é€‰æ‹©å…·ä½“æ‰¹æ¬¡æŸ¥çœ‹é¢„é˜²è®¡åˆ’æ—¶é—´çº¿</text>
        </view>
      </view>

      <!-- ç»Ÿè®¡å­æ ‡ç­¾ -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'stats'}}">
        <!-- é¢„é˜²ç»Ÿè®¡ -->
        <view class="prevention-stats">
          <view class="section-header">
            <text class="section-title">ğŸ“Š é¢„é˜²ç»Ÿè®¡</text>
          </view>
          
          <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆå››å®«æ ¼ï¼‰ -->
          <view class="stats-grid stats-grid-four-prevention">
            <!-- æ¥ç§ç‡ -->
            <view class="stat-card stat-card-vaccination">
              <view class="stat-icon stat-icon-vaccination">
                <view class="css-icon-percent"></view>
              </view>
              <view class="stat-content">
                <text class="stat-value">{{preventionData.stats.vaccinationRate}}%</text>
                <text class="stat-label">æ¥ç§ç‡</text>
              </view>
            </view>

            <!-- ç–«è‹—æ¬¡æ•° -->
            <view class="stat-card stat-card-vaccine-count">
              <view class="stat-icon stat-icon-vaccine-count">
                <view class="css-icon-check-list"></view>
              </view>
              <view class="stat-content">
                <text class="stat-value">{{preventionData.stats.vaccineCount || 0}}</text>
                <text class="stat-label">ç–«è‹—æ¬¡æ•°</text>
              </view>
            </view>
            
            <!-- é¢„é˜²æˆæœ¬ -->
            <view class="stat-card stat-card-prevention-cost">
              <view class="stat-icon stat-icon-prevention-cost">
                <view class="css-icon-coin"></view>
              </view>
              <view class="stat-content">
                <text class="stat-value">Â¥{{preventionData.stats.preventionCost || 0}}</text>
                <text class="stat-label">é¢„é˜²æˆæœ¬</text>
              </view>
            </view>

            <!-- è¦†ç›–æ•° -->
            <view class="stat-card stat-card-coverage">
              <view class="stat-icon stat-icon-coverage">
                <view class="css-icon-animals"></view>
              </view>
              <view class="stat-content">
                <text class="stat-value">{{preventionData.stats.vaccineCoverage || 0}}</text>
                <text class="stat-label">è¦†ç›–æ•°</text>
              </view>
            </view>
          </view>
        </view>

        <!-- æ‰¹æ¬¡å¯¹æ¯” -->
        <view class="batch-comparison" wx:if="{{comparisonData.comparison && comparisonData.comparison.length > 0}}">
          <view class="section-header">
            <text class="section-title">ğŸ“ˆ æ‰¹æ¬¡å¯¹æ¯”</text>
            <t-button size="small" variant="outline" bind:tap="loadBatchComparison">åˆ·æ–°</t-button>
          </view>
          <view class="comparison-table">
            <view class="comparison-header">
              <text class="col-batch">æ‰¹æ¬¡</text>
              <text class="col-vaccination">æ¥ç§ç‡</text>
              <text class="col-completion">å®Œæˆåº¦</text>
              <text class="col-cost">æˆæœ¬</text>
            </view>
            <view 
              class="comparison-row"
              wx:for="{{comparisonData.comparison}}"
              wx:key="batchId"
            >
              <view class="col-batch">
                <text class="batch-number">{{item.batchNumber}}</text>
                <text class="batch-date">{{item.entryDate}}</text>
              </view>
              <view class="col-vaccination">
                <view class="rate-bar">
                  <view class="rate-fill" style="width: {{item.vaccinationRate}}%"></view>
                </view>
                <text class="rate-value">{{item.vaccinationRate}}%</text>
              </view>
              <view class="col-completion">
                <view class="rate-bar">
                  <view class="rate-fill rate-fill-success" style="width: {{item.completionRate}}%"></view>
                </view>
                <text class="rate-value">{{item.completedTasks}}/{{item.totalTasks}}</text>
              </view>
              <view class="col-cost">
                <text class="cost-value">Â¥{{item.totalCost}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- è®°å½•å­æ ‡ç­¾ -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'records'}}">
        <!-- æ‰§è¡Œè®°å½• -->
        <view class="prevention-records">
          <view class="section-header">
            <text class="section-title">ğŸ“ æ‰§è¡Œè®°å½•</text>
          </view>
          <view class="record-list" wx:if="{{preventionData.recentRecords && preventionData.recentRecords.length > 0}}">
            <view 
              class="record-item"
              wx:for="{{preventionData.recentRecords}}"
              wx:key="recordId"
              bind:tap="onViewRecord"
              data-record="{{item}}"
            >
              <view class="record-info">
                <view class="record-title-row">
                  <text class="record-title">{{item.preventionType === 'vaccine' ? 'ç–«è‹—æ¥ç§' : item.preventionType === 'disinfection' ? 'æ¶ˆæ¯’' : 'ç”¨è¯'}}</text>
                  <t-tag wx:if="{{item.taskId}}" variant="light" theme="primary" size="small">æ¥è‡ªå¾…åŠ</t-tag>
                </view>
                <text class="record-desc">ğŸ“… {{item.preventionDate}} Â· ğŸ“¦ {{item.batchNumber}}</text>
                <text class="record-cost">ğŸ’° æˆæœ¬ï¼šÂ¥{{item.cost}} Â· ğŸ‘¤ {{item.operator}}</text>
              </view>
              <view class="record-action">
                <t-icon name="chevron-right" size="16" color="#c8c9cc" />
              </view>
            </view>
          </view>
          <view wx:else class="record-empty">
            <text class="empty-icon">ğŸ“‹</text>
            <text class="empty-text">æš‚æ— é¢„é˜²è®°å½•</text>
            <text class="empty-hint">å®Œæˆå¾…åŠä»»åŠ¡åï¼Œè®°å½•ä¼šè‡ªåŠ¨ç”Ÿæˆ</text>
          </view>
        </view>
      </view>

    </view>


    <!-- è¯Šç–—ç®¡ç† Tab -->
    <view class="tab-content treatment-content" wx:if="{{activeTab === 'treatment'}}">
      <!-- è¯Šç–—ç»Ÿè®¡ -->
      <view class="treatment-stats">
        <!-- AIè¯Šæ–­å¡ç‰‡ï¼ˆå•ç‹¬ä¸€è¡Œï¼‰ -->
        <view class="stat-card stat-card-ai-diagnosis stat-card-full-width" bind:tap="onTreatmentAction" data-action="start_diagnosis">
          <view class="stat-icon stat-icon-ai">
            <view class="css-icon-ai">âš¡</view>
          </view>
          <view class="stat-content">
            <text class="stat-value">AIæ™ºèƒ½è¯Šæ–­</text>
            <text class="stat-label">å¿«é€Ÿè¯†åˆ«ç–¾ç—…ï¼Œæ™ºèƒ½æ¨èæ²»ç–—æ–¹æ¡ˆ</text>
          </view>
          <view class="stat-arrow">
            <t-icon name="chevron-right" size="20" color="#7C3AED" />
          </view>
        </view>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆå››åˆ—ï¼‰ -->
        <view class="stats-grid stats-grid-four-treatment">
          <!-- å¼‚å¸¸ -->
          <view class="stat-card stat-card-abnormal" bind:tap="onAbnormalCountTap">
            <view class="stat-icon stat-icon-abnormal">
              <view class="css-icon-alert"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{monitoringData.realTimeStatus.abnormalCount || healthStats.abnormalCount || 0}}</text>
              <text class="stat-label">å¾…å¤„ç†</text>
            </view>
          </view>

          <!-- æ²»ç–—ä¸­ -->
          <view class="stat-card stat-card-treating" bindtap="onOngoingTreatmentClick">
            <view class="stat-icon stat-icon-treating">
              <view class="css-icon-medicine"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentData.stats.ongoingTreatment}}</text>
              <text class="stat-label">æ²»ç–—ä¸­</text>
            </view>
          </view>
          
          <!-- æ²»æ„ˆæ•° -->
          <view class="stat-card stat-card-cured clickable" bindtap="navigateToCuredRecords">
            <view class="stat-icon stat-icon-cured">
              <view class="css-icon-heart"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentStats.recoveredCount || 0}}</text>
              <text class="stat-label">æ²»æ„ˆæ•°</text>
            </view>
          </view>

          <!-- æ­»äº¡æ•° -->
          <view class="stat-card stat-card-death" bind:tap="onDeathCountTap">
            <view class="stat-icon stat-icon-death">
              <view class="css-icon-cross"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{healthStats.deadCount}}</text>
              <text class="stat-label">æ­»äº¡æ•°</text>
            </view>
          </view>
        </view>
      </view>

      <!-- è¯Šæ–­è®°å½• -->
      <view class="diagnosis-history">
        <view class="section-header">
          <text class="section-title">è¯Šæ–­è®°å½•</text>
          <text class="sub-title">ï¼ˆè¿‘7å¤©ï¼‰</text>
          <text class="more-link" bind:tap="onViewAllDiagnosis">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
        <view class="diagnosis-records-list" wx:if="{{treatmentData.diagnosisHistory.length > 0}}">
          <view 
            class="diagnosis-record-item"
            wx:for="{{treatmentData.diagnosisHistory}}"
            wx:key="_id"
            bind:tap="onDiagnosisRecordTap"
            data-record="{{item}}"
          >
            <view class="record-main">
              <!-- ç–¾ç—…åç§° + ç½®ä¿¡åº¦æ ‡ç­¾ -->
              <view class="record-header">
                <text class="record-name">{{item.diagnosis}}</text>
                <view class="confidence-badge">
                  <text class="confidence-text">ç½®ä¿¡åº¦ {{item.confidence}}%</text>
                </view>
              </view>

              <!-- è®°å½•å†…å®¹ -->
              <view class="record-content">
                <!-- ç¬¬ä¸€è¡Œï¼šå—å½±å“æ•° + æ—¥é¾„ -->
                <view class="info-row">
                  <view class="info-group">
                    <text class="info-label">å—å½±å“ï¼š</text>
                    <text class="info-value">{{item.affectedCount || 0}}åª</text>
                  </view>
                  <view class="info-group">
                    <text class="info-label">æ—¥é¾„ï¼š</text>
                    <text class="info-value">{{item.dayAge || 0}}å¤©</text>
                  </view>
                </view>

                <!-- ç¬¬äºŒè¡Œï¼šç—‡çŠ¶ï¼ˆå¦‚æœæœ‰ï¼‰ -->
                <view class="info-row" wx:if="{{item.symptoms}}">
                  <view class="info-group full-width">
                    <text class="info-label">ç—‡çŠ¶ï¼š</text>
                    <text class="info-value symptoms-value">{{item.symptoms}}</text>
                  </view>
                </view>

                <!-- ç¬¬ä¸‰è¡Œï¼šAIè¯Šæ–­ + æ—¥æœŸ + å‘¨æœŸ -->
                <view class="record-footer">
                  <view class="footer-left">
                    <text class="operator-text">AIè¯Šæ–­</text>
                    <text class="date-text">{{item.diagnosisDate}}</text>
                  </view>
                  <text class="duration-text" wx:if="{{item.treatmentDuration}}">å‘¨æœŸï¼š{{item.treatmentDuration}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <t-empty 
            icon="chart-bubble" 
            description="è¿‘7å¤©æš‚æ— è¯Šæ–­è®°å½•"
          />
        </view>
      </view>
    </view>

    <!-- æ•ˆæœåˆ†æ Tab -->
    <view class="tab-content analysis-content" wx:if="{{activeTab === 'analysis'}}">
      <!-- å­˜æ´»ç‡åˆ†æ -->
      <view class="survival-analysis">
        <text class="section-title">å­˜æ´»ç‡åˆ†æ</text>
        <view class="analysis-card">
          <view class="analysis-header">
            <text class="analysis-value">{{analysisData.survivalAnalysis.rate}}%</text>
            <text class="analysis-trend trend-{{analysisData.survivalAnalysis.trend}}">
              {{analysisData.survivalAnalysis.trend === 'improving' ? 'â†— æ”¹å–„ä¸­' : 'â†’ ç¨³å®š'}}
            </text>
          </view>
          <view class="stage-breakdown">
            <view 
              class="stage-item"
              wx:for="{{analysisData.survivalAnalysis.byStage}}"
              wx:key="stage"
            >
              <text class="stage-name">{{item.stage}}</text>
              <text class="stage-rate">{{item.rate}}%</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æˆæœ¬åˆ†æ -->
      <view class="cost-analysis">
        <view class="section-header">
          <text class="section-title">æˆæœ¬åˆ†æ</text>
        </view>
        <view class="stats-grid stats-grid-four-cost">
          <!-- é¢„é˜²æˆæœ¬ -->
          <view class="stat-card stat-card-prevention-cost-analysis">
            <view class="stat-icon stat-icon-prevention-cost-analysis">
              <view class="css-icon-shield"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">Â¥{{analysisData.costAnalysis.preventionCost || 0}}</text>
              <text class="stat-label">é¢„é˜²æˆæœ¬</text>
            </view>
          </view>

          <!-- æ²»ç–—æˆæœ¬ -->
          <view class="stat-card stat-card-treatment-cost-analysis">
            <view class="stat-icon stat-icon-treatment-cost-analysis">
              <view class="css-icon-medicine-cost"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">Â¥{{analysisData.costAnalysis.treatmentCost || 0}}</text>
              <text class="stat-label">æ²»ç–—æˆæœ¬</text>
            </view>
          </view>
          
          <!-- æ€»æˆæœ¬ -->
          <view class="stat-card stat-card-total-cost">
            <view class="stat-icon stat-icon-total-cost">
              <view class="css-icon-total"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">Â¥{{analysisData.costAnalysis.totalCost || 0}}</text>
              <text class="stat-label">æ€»æˆæœ¬</text>
            </view>
          </view>

          <!-- æŠ•å…¥å›æŠ¥ç‡ -->
          <view class="stat-card stat-card-roi">
            <view class="stat-icon stat-icon-roi">
              <view class="css-icon-growth"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{analysisData.costAnalysis.roi || 0}}:1</text>
              <text class="stat-label">æŠ•å…¥å›æŠ¥ç‡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ€§èƒ½æŒ‡æ ‡ -->
      <view class="performance-metrics">
        <text class="section-title">æ€§èƒ½æŒ‡æ ‡</text>
        <view class="metrics-list">
          <view 
            class="metric-item"
            wx:for="{{analysisData.performanceMetrics}}"
            wx:key="name"
          >
            <view class="metric-info">
              <text class="metric-name">{{item.name}}</text>
              <text class="metric-progress">{{item.value}}% / ç›®æ ‡{{item.target}}%</text>
            </view>
            <view class="metric-indicator">
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{item.value / item.target * 100}}%"></view>
              </view>
              <text class="metric-trend trend-{{item.trend}}">
                {{item.trend === 'up' ? 'â†—' : item.trend === 'down' ? 'â†˜' : 'â†’'}}
              </text>
            </view>
          </view>
        </view>
      </view>

      <!-- åˆ†ææ“ä½œ -->
      <view class="analysis-actions">
        <t-button 
          theme="primary" 
          size="large" 
          block
          bind:tap="onAnalysisAction"
          data-action="export_report"
        >å¯¼å‡ºå¥åº·æŠ¥å‘Š</t-button>
      </view>
    </view>

    <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
    <view style="height: 120rpx;"></view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <bottom-popup
    visible="{{showDetailPopup}}"
    title="è¯¦æƒ…ä¿¡æ¯"
    show-close="{{true}}"
    bind:close="onCloseDetail"
    bind:visiblechange="onHealthDetailPopupChange"
  >
    <view wx:if="{{selectedRecord}}" class="detail-content">
      <view class="detail-card">
        <text class="detail-info">{{selectedRecord.title || selectedRecord.name || selectedRecord.symptoms}}</text>
        <text class="detail-desc">{{selectedRecord.description || selectedRecord.content}}</text>
        <text class="detail-time">{{selectedRecord.createTime || selectedRecord.date}}</text>
      </view>
    </view>
  </bottom-popup>

  <!-- âœ… è¯Šæ–­è®°å½•è¯¦æƒ…å¼¹çª—ï¼ˆå¤ç”¨ diagnosis-history çš„å¼¹çª—ç»“æ„ï¼‰ -->
  <bottom-popup
    visible="{{showDiagnosisDetailPopup}}"
    title="è¯Šæ–­è¯¦æƒ…"
    show-close="{{true}}"
    bind:close="onCloseDiagnosisDetail"
  >
    <view wx:if="{{selectedDiagnosisRecord}}" class="diagnosis-detail-content">
      <!-- AIè¯Šæ–­ç»“æœ -->
      <view class="detail-section">
        <view class="detail-section-title">
          <text>AIè¯Šæ–­ç»“æœ</text>
          <t-tag wx:if="{{!selectedDiagnosisRecord.isCorrected}}" theme="primary" size="small">AIåˆ†æ</t-tag>
        </view>
        <view class="detail-item">
          <text class="detail-label">ç–¾ç—…åç§°</text>
          <text class="detail-value primary">{{selectedDiagnosisRecord.diagnosisResult || selectedDiagnosisRecord.diagnosis}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">ç½®ä¿¡åº¦</text>
          <text class="detail-value confidence">{{selectedDiagnosisRecord.confidence}}%</text>
        </view>
      </view>

      <!-- è¯Šæ–­ä¿®æ­£è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
      <view class="detail-section correction-section" wx:if="{{selectedDiagnosisRecord.isCorrected}}">
        <view class="detail-section-title">
          <text>è¯Šæ–­ä¿®æ­£è®°å½•</text>
          <t-tag theme="success" size="small">å·²ç¡®è®¤</t-tag>
        </view>
        <view class="detail-item">
          <text class="detail-label">ä¿®æ­£åè¯Šæ–­</text>
          <text class="detail-value primary corrected">{{selectedDiagnosisRecord.correctedDiagnosis}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.aiAccuracyRating > 0}}">
          <text class="detail-label">AIå‡†ç¡®æ€§è¯„åˆ†</text>
          <view class="rating-display">
            <text 
              class="star-display {{selectedDiagnosisRecord.aiAccuracyRating >= item ? 'active' : ''}}"
              wx:for="{{[1,2,3,4,5]}}" 
              wx:key="index"
            >{{selectedDiagnosisRecord.aiAccuracyRating >= item ? 'â˜…' : 'â˜†'}}</text>
          </view>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.veterinarianDiagnosis}}">
          <text class="detail-label">å…½åŒ»è¯Šæ–­</text>
          <text class="detail-value text-content">{{selectedDiagnosisRecord.veterinarianDiagnosis}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.correctionReason}}">
          <text class="detail-label">ä¿®æ­£åŸå› </text>
          <text class="detail-value text-content">{{selectedDiagnosisRecord.correctionReason}}</text>
        </view>
      </view>

      <!-- ç—‡çŠ¶æè¿° -->
      <view class="detail-section" wx:if="{{selectedDiagnosisRecord.symptoms}}">
        <view class="detail-section-title">ç—‡çŠ¶æè¿°</view>
        <view class="detail-text-content">
          <text class="detail-text">{{selectedDiagnosisRecord.symptoms}}</text>
        </view>
      </view>

      <!-- è¯Šæ–­å›¾ç‰‡ -->
      <view class="detail-section" wx:if="{{selectedDiagnosisRecord.images && selectedDiagnosisRecord.images.length > 0}}">
        <view class="detail-section-title">
          {{selectedDiagnosisRecord.diagnosisType === 'autopsy_analysis' ? 'å‰–æ£€å›¾ç‰‡' : 'ç—‡çŠ¶å›¾ç‰‡'}}
          <text class="image-count">({{selectedDiagnosisRecord.images.length}}å¼ )</text>
        </view>
        <view class="diagnosis-images">
          <view 
            class="image-item"
            wx:for="{{selectedDiagnosisRecord.images}}"
            wx:key="index"
            bind:tap="onPreviewDiagnosisImage"
            data-url="{{item}}"
          >
            <t-image 
              src="{{item}}"
              mode="aspectFill"
              width="200rpx"
              height="200rpx"
              shape="round"
              error="åŠ è½½å¤±è´¥"
              lazy-load="{{false}}"
            />
          </view>
        </view>
      </view>

      <!-- å»ºè®®ç”¨è¯ -->
      <view class="detail-section" wx:if="{{selectedDiagnosisRecord.recommendedMedications && selectedDiagnosisRecord.recommendedMedications.length > 0}}">
        <view class="detail-section-title">å»ºè®®ç”¨è¯</view>
        <view class="medications-list">
          <view class="medication-item" wx:for="{{selectedDiagnosisRecord.recommendedMedications}}" wx:key="index">
            <text class="medication-icon">ğŸ’Š</text>
            <text class="medication-name">{{item}}</text>
          </view>
        </view>
      </view>

      <!-- å®é™…æ²»ç–—è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
      <view class="detail-section treatment-section" wx:if="{{selectedDiagnosisRecord.actualTreatment}}">
        <view class="detail-section-title">
          <text>å®é™…æ²»ç–—è®°å½•</text>
          <t-tag theme="primary" size="small">å·²æ‰§è¡Œ</t-tag>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.actualTreatment.treatmentPlan}}">
          <text class="detail-label">æ²»ç–—æ–¹æ¡ˆ</text>
          <text class="detail-value text-content">{{selectedDiagnosisRecord.actualTreatment.treatmentPlan}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.actualTreatment.medications && selectedDiagnosisRecord.actualTreatment.medications.length > 0}}">
          <text class="detail-label">ç”¨è¯è®°å½•</text>
          <view class="medications-list-actual">
            <view class="medication-item-actual" wx:for="{{selectedDiagnosisRecord.actualTreatment.medications}}" wx:key="index">
              <text class="medication-icon">ğŸ’Š</text>
              <view class="medication-info">
                <text class="medication-name">{{item.name || item}}</text>
                <text class="medication-detail" wx:if="{{item.dosage}}">{{item.dosage}}</text>
              </view>
            </view>
          </view>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.actualTreatment.outcome}}">
          <text class="detail-label">æ²»ç–—ç»“æœ</text>
          <text class="detail-value">{{selectedDiagnosisRecord.actualTreatment.outcome}}</text>
        </view>
      </view>

      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="detail-section-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="detail-item">
          <text class="detail-label">å—å½±å“æ•°é‡</text>
          <text class="detail-value">{{selectedDiagnosisRecord.affectedCount || 0}}åª</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">é¹…åªæ—¥é¾„</text>
          <text class="detail-value">{{selectedDiagnosisRecord.dayAge || 0}}å¤©</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">è¯Šæ–­æ—¶é—´</text>
          <text class="detail-value">{{selectedDiagnosisRecord.diagnosisDate || selectedDiagnosisRecord.createTime}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedDiagnosisRecord.treatmentDuration}}">
          <text class="detail-label">æ²»ç–—å‘¨æœŸ</text>
          <text class="detail-value">{{selectedDiagnosisRecord.treatmentDuration}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- æ‰¹æ¬¡ç­›é€‰ä¸‹æ‹‰èœå•ï¼ˆæ”¾åœ¨æœ€åï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ï¼‰ -->
  <view class="batch-dropdown {{showBatchDropdown ? 'show' : ''}}" style="top: {{dropdownTop}}px;" wx:if="{{showBatchDropdown}}">
    <!-- å…¨éƒ¨æ‰¹æ¬¡é€‰é¡¹ -->
    <view 
      class="dropdown-item {{'all' === currentBatchId ? 'active' : ''}}"
      bind:tap="selectAllBatches"
    >
      <view class="item-content">
        <text class="item-title">å…¨éƒ¨æ‰¹æ¬¡</text>
        <text class="item-subtitle">æŸ¥çœ‹æ‰€æœ‰æ‰¹æ¬¡çš„å¥åº·æ•°æ®æ±‡æ€»</text>
      </view>
      <text class="check-mark" wx:if="{{'all' === currentBatchId}}">âœ“</text>
    </view>
    
    <!-- åˆ†éš”çº¿ -->
    <view class="dropdown-divider" wx:if="{{availableBatches.length > 0}}"></view>
    
    <!-- å…·ä½“æ‰¹æ¬¡åˆ—è¡¨ -->
    <view 
      class="dropdown-item {{item._id === currentBatchId ? 'active' : ''}}"
      wx:for="{{availableBatches}}"
      wx:key="_id"
      bind:tap="selectBatchFromDropdown"
      data-index="{{index}}"
    >
      <view class="item-content">
        <text class="item-title">{{item.batchNumber}}</text>
        <text class="item-subtitle">{{item.breed}} Â· {{item.dayAge}}æ—¥é¾„ Â· {{item.quantity}}åª</text>
      </view>
      <text class="check-mark" wx:if="{{item._id === currentBatchId}}">âœ“</text>
    </view>
    
    <view class="dropdown-empty" wx:if="{{availableBatches.length === 0}}">
      <text>æš‚æ— å­˜æ æ‰¹æ¬¡</text>
    </view>
  </view>

  <!-- é®ç½©å±‚ï¼ˆæ”¾åœ¨æœ€åï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ï¼‰ -->
  <view 
    class="dropdown-mask {{showBatchDropdown ? 'show' : ''}}" 
    wx:if="{{showBatchDropdown}}"
    bind:tap="closeBatchDropdown"
    catchtouchmove="preventTouchMove"
  ></view>

  </view>
  <!-- detail-view ç»“æŸ -->

</view>