<!--health.wxml - 健康管理中心完整重构版本-->
<view class="page health-center-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="健康管理中心"
    show-back="{{true}}"
    bind:back="goBack"
  />

  <!-- 详情视图 -->
  <view class="detail-view">

    <!-- 健康数据概览（整合实时状态） -->
    <view class="health-stats-section">
      <view class="stats-grid stats-grid-four">
        <view class="stat-card stat-primary">
          <text class="stat-value">{{healthStats.healthyRate}}</text>
          <text class="stat-label">健康率</text>
        </view>
        <view class="stat-card stat-warning" bind:tap="onAbnormalCountTap">
          <text class="stat-value">{{monitoringData.realTimeStatus.abnormalCount || healthStats.sickCount}}</text>
          <text class="stat-label">异常</text>
        </view>
        <view class="stat-card stat-info">
          <text class="stat-value">{{monitoringData.realTimeStatus.isolatedCount || 0}}</text>
          <text class="stat-label">隔离</text>
        </view>
        <view class="stat-card stat-danger" bind:tap="onDeathCountTap">
          <text class="stat-value">{{healthStats.deadCount}}</text>
          <text class="stat-label">死亡数</text>
        </view>
      </view>
    </view>

    <!-- 批次筛选栏 -->
    <view class="batch-filter-section">
      <view class="filter-header">
        <view class="current-batch">
          <text class="label">当前批次</text>
          <text class="value">{{currentBatchNumber || '请选择批次'}}</text>
        </view>
        <view class="filter-action" bind:tap="toggleBatchDropdown">
          <text class="action-text">筛选</text>
          <text class="action-icon {{showBatchDropdown ? 'rotate' : ''}}">▾</text>
        </view>
      </view>
      
      <!-- 下拉菜单 -->
      <view class="batch-dropdown {{showBatchDropdown ? 'show' : ''}}" wx:if="{{showBatchDropdown}}">
        <!-- 全部批次选项 -->
        <view 
          class="dropdown-item {{'all' === currentBatchId ? 'active' : ''}}"
          bind:tap="selectAllBatches"
        >
          <view class="item-content">
            <text class="item-title">全部批次</text>
            <text class="item-subtitle">查看所有批次的健康数据汇总</text>
          </view>
          <text class="check-mark" wx:if="{{'all' === currentBatchId}}">✓</text>
        </view>
        
        <!-- 分隔线 -->
        <view class="dropdown-divider" wx:if="{{availableBatches.length > 0}}"></view>
        
        <!-- 具体批次列表 -->
        <view 
          class="dropdown-item {{item._id === currentBatchId ? 'active' : ''}}"
          wx:for="{{availableBatches}}"
          wx:key="_id"
          bind:tap="selectBatchFromDropdown"
          data-index="{{index}}"
        >
          <view class="item-content">
            <text class="item-title">{{item.batchNumber}}</text>
            <text class="item-subtitle">{{item.breed}} · {{item.dayAge}}日龄 · {{item.quantity}}只</text>
          </view>
          <text class="check-mark" wx:if="{{item._id === currentBatchId}}">✓</text>
        </view>
        
        <view class="dropdown-empty" wx:if="{{availableBatches.length === 0}}">
          <text>暂无存栏批次</text>
        </view>
      </view>
    </view>
  
    <!-- 遮罩层 -->
    <view 
      class="dropdown-mask {{showBatchDropdown ? 'show' : ''}}" 
      wx:if="{{showBatchDropdown}}"
      bind:tap="closeBatchDropdown"
      catchtouchmove="preventTouchMove"
    ></view>

    <!-- 活跃预警 -->
  <view class="active-alerts" wx:if="{{activeAlerts.length > 0}}">
    <view class="alert-header">
      <text class="alert-title">活跃预警</text>
      <text class="alert-count">{{activeAlerts.length}}条</text>
    </view>
    <view class="alert-list">
      <view 
        class="alert-item alert-{{item.severity}}"
        wx:for="{{activeAlerts}}"
        wx:key="_id"
        bind:tap="onAlertAction"
        data-alert-id="{{item._id}}"
        data-action="acknowledge"
      >
        <view class="alert-content">
          <text class="alert-message">{{item.message}}</text>
          <text class="alert-time">{{item.createTime}}</text>
        </view>
        <view class="alert-action">
          <t-icon name="chevron-right" size="16" color="#c8c9cc" />
        </view>
      </view>
    </view>
  </view>

  <!-- 主要Tab切换 -->
  <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" class="health-main-tabs">
    <t-tab-panel value="prevention" label="预防管理"></t-tab-panel>
    <t-tab-panel value="treatment" label="诊疗管理"></t-tab-panel>
    <t-tab-panel value="analysis" label="效果分析"></t-tab-panel>
  </t-tabs>

  <!-- Tab内容区域 -->
  <view class="tab-content-container">
    
    <!-- 预防管理 Tab (合并了健康监控) -->
    <view class="tab-content prevention-content" wx:if="{{activeTab === 'prevention'}}">
      <!-- 预防统计 -->
      <view class="prevention-stats">
        <view class="stats-header">
          <text class="stats-title">预防统计</text>
          <text class="stats-period">本月数据</text>
        </view>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value">{{preventionData.stats.vaccinationRate}}%</text>
            <text class="stat-label">疫苗接种率</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">¥{{preventionData.stats.preventionCost}}</text>
            <text class="stat-label">预防成本</text>
          </view>
        </view>
      </view>

      <!-- 近期预防记录 -->
      <view class="prevention-records">
        <view class="section-header">
          <text class="section-title">近期预防记录</text>
          <text class="more-link">查看更多 ></text>
        </view>
        <view class="record-list" wx:if="{{preventionData.recentRecords && preventionData.recentRecords.length > 0}}">
          <view 
            class="record-item"
            wx:for="{{preventionData.recentRecords}}"
            wx:key="_id"
          >
            <view class="record-info">
              <view class="record-title-row">
                <text class="record-title">{{item.preventionType}}</text>
                <t-tag wx:if="{{item.isFromTask}}" variant="light" theme="primary" size="small">来自待办</t-tag>
              </view>
              <text class="record-desc">{{item.location}} · {{item.targetAnimals}}只</text>
            </view>
            <view class="record-meta">
              <text class="record-date">{{item.createTime}}</text>
              <t-tag variant="light" theme="success" size="small">已完成</t-tag>
            </view>
          </view>
        </view>
        <view wx:else class="record-empty">
          <text class="empty-text">暂无预防记录</text>
          <text class="empty-hint">完成待办中的疫苗接种任务后，记录会自动关联到这里</text>
        </view>
      </view>


      <!-- 异常个体列表 -->
      <view class="abnormal-list" wx:if="{{monitoringData.abnormalList.length > 0}}">
        <text class="section-title">异常个体 ({{monitoringData.abnormalList.length}})</text>
        <view class="abnormal-items">
          <view 
            class="abnormal-item"
            wx:for="{{monitoringData.abnormalList}}"
            wx:key="_id"
            bind:tap="onMonitoringAction"
            data-action="view_abnormal"
            data-data="{{item}}"
          >
            <view class="abnormal-info">
              <text class="animal-id">{{item.animalId}}</text>
              <text class="symptoms">{{item.symptoms}}</text>
              <text class="location">{{item.location}}</text>
            </view>
            <view class="severity-indicator severity-{{item.severity}}">
              {{item.severity === 'high' ? '严重' : item.severity === 'medium' ? '中等' : '轻微'}}
            </view>
          </view>
        </view>
      </view>

      <!-- 疾病分布统计 -->
      <view class="disease-distribution" wx:if="{{monitoringData.diseaseDistribution.length > 0}}">
        <text class="section-title">疾病分布</text>
        <view class="distribution-chart">
          <view 
            class="disease-item"
            wx:for="{{monitoringData.diseaseDistribution}}"
            wx:key="disease"
          >
            <view class="disease-info">
              <text class="disease-name">{{item.disease}}</text>
              <text class="case-count">{{item.count}}例</text>
            </view>
            <view class="disease-bar">
              <view class="bar-fill" style="width: {{item.percentage}}%"></view>
            </view>
          </view>
        </view>
      </view>

    </view>


    <!-- 诊疗管理 Tab -->
    <view class="tab-content treatment-content" wx:if="{{activeTab === 'treatment'}}">
      <!-- 诊疗统计 -->
      <view class="treatment-stats">
        <!-- AI诊断卡片（单独一行） -->
        <view class="ai-diagnosis-card" bind:tap="onTreatmentAction" data-action="start_diagnosis">
          <view class="ai-card-icon">⚡</view>
          <view class="ai-card-content">
            <text class="ai-card-title">AI智能诊断</text>
            <text class="ai-card-desc">快速识别疾病，智能推荐治疗方案</text>
          </view>
          <view class="ai-card-arrow">
            <t-icon name="chevron-right" size="24" color="#7C3AED" />
          </view>
        </view>
        
        <!-- 统计卡片（两列） -->
        <view class="stats-grid stats-grid-two">
          <!-- 治疗中 -->
          <view class="stat-card stat-card-treating" bindtap="onOngoingTreatmentClick">
            <view class="stat-icon stat-icon-treating">
              <view class="css-icon-medicine"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentData.stats.ongoingTreatment}}</text>
              <text class="stat-label">治疗中</text>
            </view>
          </view>
          
          <!-- 治愈率 -->
          <view class="stat-card stat-card-cured" bindtap="onCureRateClick">
            <view class="stat-icon stat-icon-cured">
              <view class="css-icon-shield"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentData.stats.cureRate}}%</text>
              <text class="stat-label">治愈率</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 当前治疗记录 -->
      <view class="current-treatments">
        <view class="section-header">
          <text class="section-title">当前治疗</text>
          <text class="more-link">查看全部 ></text>
        </view>
        <view class="treatment-list">
          <view 
            class="treatment-item"
            wx:for="{{treatmentData.currentTreatments}}"
            wx:key="_id"
            bind:tap="onTreatmentAction"
            data-action="view_treatment"
            data-data="{{item}}"
          >
            <view class="treatment-info">
              <text class="treatment-title">{{item.diagnosisDisease}}</text>
              <text class="treatment-desc">{{item.location}} · 第{{item.treatmentDay}}天</text>
            </view>
            <view class="treatment-meta">
              <text class="treatment-date">{{item.nextTreatmentDate}}</text>
              <t-tag variant="light" theme="warning" size="small">进行中</t-tag>
            </view>
          </view>
        </view>
      </view>

      <!-- AI诊断历史 -->
      <view class="ai-diagnosis-history">
        <text class="section-title">AI诊断历史</text>
        <view class="diagnosis-list">
          <view 
            class="diagnosis-item"
            wx:for="{{treatmentData.aiDiagnosisHistory}}"
            wx:key="_id"
          >
            <view class="diagnosis-info">
              <text class="diagnosis-title">{{item.diagnosisResult}}</text>
              <text class="diagnosis-desc">置信度：{{item.confidence}}%</text>
            </view>
            <view class="diagnosis-meta">
              <text class="diagnosis-date">{{item.createTime}}</text>
              <t-tag 
                variant="light" 
                theme="{{item.status === 'confirmed' ? 'success' : 'primary'}}" 
                size="small"
              >
                {{item.status === 'confirmed' ? '已确认' : '待确认'}}
              </t-tag>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 效果分析 Tab -->
    <view class="tab-content analysis-content" wx:if="{{activeTab === 'analysis'}}">
      <!-- 存活率分析 -->
      <view class="survival-analysis">
        <text class="section-title">存活率分析</text>
        <view class="analysis-card">
          <view class="analysis-header">
            <text class="analysis-value">{{analysisData.survivalAnalysis.rate}}%</text>
            <text class="analysis-trend trend-{{analysisData.survivalAnalysis.trend}}">
              {{analysisData.survivalAnalysis.trend === 'improving' ? '↗ 改善中' : '→ 稳定'}}
            </text>
          </view>
          <view class="stage-breakdown">
            <view 
              class="stage-item"
              wx:for="{{analysisData.survivalAnalysis.byStage}}"
              wx:key="stage"
            >
              <text class="stage-name">{{item.stage}}</text>
              <text class="stage-rate">{{item.rate}}%</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 成本分析 -->
      <view class="cost-analysis">
        <text class="section-title">成本分析</text>
        <view class="cost-overview">
          <view class="cost-item">
            <text class="cost-label">预防成本</text>
            <text class="cost-value">¥{{analysisData.costAnalysis.preventionCost}}</text>
          </view>
          <view class="cost-item">
            <text class="cost-label">治疗成本</text>
            <text class="cost-value">¥{{analysisData.costAnalysis.treatmentCost}}</text>
          </view>
          <view class="cost-item">
            <text class="cost-label">总成本</text>
            <text class="cost-value total">¥{{analysisData.costAnalysis.totalCost}}</text>
          </view>
          <view class="cost-item">
            <text class="cost-label">投入回报率</text>
            <text class="cost-value">{{analysisData.costAnalysis.roi}}:1</text>
          </view>
        </view>
      </view>

      <!-- 性能指标 -->
      <view class="performance-metrics">
        <text class="section-title">性能指标</text>
        <view class="metrics-list">
          <view 
            class="metric-item"
            wx:for="{{analysisData.performanceMetrics}}"
            wx:key="name"
          >
            <view class="metric-info">
              <text class="metric-name">{{item.name}}</text>
              <text class="metric-progress">{{item.value}}% / 目标{{item.target}}%</text>
            </view>
            <view class="metric-indicator">
              <view class="progress-bar">
                <view class="progress-fill" style="width: {{item.value / item.target * 100}}%"></view>
              </view>
              <text class="metric-trend trend-{{item.trend}}">
                {{item.trend === 'up' ? '↗' : item.trend === 'down' ? '↘' : '→'}}
              </text>
            </view>
          </view>
        </view>
      </view>

      <!-- 分析操作 -->
      <view class="analysis-actions">
        <t-button 
          theme="primary" 
          size="large" 
          block
          bind:tap="onAnalysisAction"
          data-action="export_report"
        >导出健康报告</t-button>
      </view>
    </view>

    <!-- 底部安全区域 -->
    <view style="height: 120rpx;"></view>
  </view>

  <!-- 详情弹窗 -->
  <bottom-popup
    visible="{{showDetailPopup}}"
    title="详情信息"
    show-close="{{true}}"
    bind:close="onCloseDetail"
    bind:visiblechange="onHealthDetailPopupChange"
  >
    <view wx:if="{{selectedRecord}}" class="detail-content">
      <view class="detail-card">
        <text class="detail-info">{{selectedRecord.title || selectedRecord.name || selectedRecord.symptoms}}</text>
        <text class="detail-desc">{{selectedRecord.description || selectedRecord.content}}</text>
        <text class="detail-time">{{selectedRecord.createTime || selectedRecord.date}}</text>
      </view>
    </view>
  </bottom-popup>

  </view>
  <!-- detail-view 结束 -->

</view>