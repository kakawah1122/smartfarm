<!--health.wxml - 健康管理中心完整重构版本-->
<wxs module="healthUtils" src="./health-utils.wxs"></wxs>

<view class="page health-center-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="健康管理中心"
    show-back="{{false}}"
  />

  <!-- 详情视图 -->
  <view class="detail-view">

    <!-- 健康数据概览 -->
    <view class="health-stats-section">
      <view class="stats-grid stats-grid-two">
        <view class="stat-card stat-primary">
          <text class="stat-value">{{healthStats.healthyRate}}</text>
          <text class="stat-label">健康率</text>
        </view>
        <view class="stat-card stat-mortality">
          <text class="stat-value">{{healthStats.mortalityRate}}</text>
          <text class="stat-label">死亡率</text>
        </view>
      </view>
    </view>

    <!-- 批次筛选和Tab导航卡片组 -->
    <view class="filter-tabs-card">
      <!-- 批次筛选栏 -->
      <view class="batch-filter-section">
        <view class="filter-header">
          <view class="current-batch">
            <text class="label">当前批次</text>
            <text class="value">{{currentBatchNumber || '请选择批次'}}</text>
          </view>
          <view class="filter-action" bind:tap="toggleBatchDropdown">
            <text class="action-text">筛选</text>
            <text class="action-icon {{showBatchDropdown ? 'rotate' : ''}}">▾</text>
          </view>
        </view>
      </view>
      
      <!-- 主要Tab切换 -->
      <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" class="health-main-tabs">
        <t-tab-panel value="prevention" label="预防管理"></t-tab-panel>
        <t-tab-panel value="treatment" label="诊疗管理"></t-tab-panel>
        <t-tab-panel value="analysis" label="效果分析"></t-tab-panel>
      </t-tabs>
      
      <!-- 预防管理子标签页（整合到卡片内，与breeding-todo保持一致） -->
      <view class="prevention-sub-tabs" wx:if="{{activeTab === 'prevention'}}">
        <t-tabs value="{{preventionSubTab}}" bind:change="onPreventionSubTabChange" theme="line">
          <t-tab-panel label="进行中" value="today"></t-tab-panel>
          <t-tab-panel label="即将到来" value="upcoming"></t-tab-panel>
          <t-tab-panel label="已完成" value="history"></t-tab-panel>
        </t-tabs>
      </view>
    </view>

    <!-- 活跃预警 -->
  <view class="active-alerts" wx:if="{{activeAlerts.length > 0}}">
    <view class="alert-header">
      <text class="alert-title">活跃预警</text>
      <text class="alert-count">{{activeAlerts.length}}条</text>
    </view>
    <view class="alert-list">
      <view 
        class="alert-item alert-{{item.severity}}"
        wx:for="{{activeAlerts}}"
        wx:key="_id"
        bind:tap="onAlertAction"
        data-alert-id="{{item._id}}"
        data-action="acknowledge"
      >
        <view class="alert-content">
          <text class="alert-message">{{item.message}}</text>
          <text class="alert-time">{{item.createTime}}</text>
        </view>
        <view class="alert-action">
          <t-icon name="chevron-right" size="16" color="#c8c9cc" />
        </view>
      </view>
    </view>
  </view>

  <!-- Tab内容区域 -->
  <view class="tab-content-container">
    
    <!-- 预防管理 Tab (整合待办+计划+统计+记录) -->
    <view class="tab-content prevention-content" wx:if="{{activeTab === 'prevention'}}">
      
      <!-- 进行中子标签（今日待办 - 从 breeding-todo 完整迁移） -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'today'}}">
        <!-- 按批次分组的任务列表 -->
        <view wx:if="{{todayTasksByBatch.length > 0}}" class="batch-task-groups">
          <view wx:for="{{todayTasksByBatch}}" wx:key="id" class="batch-group">
            <!-- 批次组头部 -->
            <view class="batch-group-header">
              <view class="batch-group-info">
                <text class="batch-group-title">{{item.batchNumber}}</text>
                <text class="batch-group-separator">·</text>
                <text class="batch-group-age">第{{item.dayAge}}日龄</text>
              </view>
              <view class="batch-task-count">{{item.tasks.length}}个任务</view>
            </view>
            
            <!-- 该批次的任务列表 -->
            <view class="batch-task-list">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card {{task.completed ? 'completed' : ''}}">
                <!-- 任务主体 -->
                <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <!-- 右上角标签 -->
                  <view class="task-badges-top">
                        <view class="type-badge type-{{task.type}}">
                          <text class="type-text">{{healthUtils.getTypeName(task.type)}}</text>
                        </view>
                      </view>
                  
                  <view class="task-content">
                    <view class="task-header-info">
                      <text class="task-title {{task.completed ? 'completed' : ''}}" data-completed="{{task.completed}}" data-task-id="{{task._id}}">{{task.title}}</text>
                    </view>
                    
                    <view class="task-description">{{task.description}}</view>
                    
                    <view class="task-meta-info">
                      <view wx:if="{{task.estimatedTime}}" class="meta-item">
                        <text class="meta-text">预计用时：{{task.estimatedTime}}分钟</text>
                      </view>
                      <view wx:if="{{task.dosage}}" class="meta-item meta-item-full">
                        <text class="meta-text">用量：{{task.dosage}}</text>
                      </view>
                      <view wx:if="{{task.duration}}" class="meta-item meta-item-full">
                        <text class="meta-text">连续第{{task.dayInSeries}}/{{task.duration}}天</text>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 无任务状态 -->
        <view wx:else class="modern-empty-state">
          <view class="empty-content">
            <text class="empty-title">暂无进行中的任务</text>
            <text class="empty-description">所有计划任务均已完成</text>
          </view>
        </view>
      </view>

      <!-- 即将到来子标签 -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'upcoming'}}">
        <!-- 按批次分组的即将到来任务列表 -->
        <view wx:if="{{upcomingTasksByBatch.length > 0}}" class="batch-task-groups">
          <view wx:for="{{upcomingTasksByBatch}}" wx:key="id" class="batch-group">
            <!-- 批次组头部 -->
            <view class="batch-group-header">
              <view class="batch-group-info">
                <text class="batch-group-title">{{item.batchNumber}}</text>
                <text class="batch-group-separator">·</text>
                <text class="batch-group-age">第{{item.dayAge}}日龄</text>
              </view>
              <view class="batch-task-count">{{item.tasks.length}}个任务</view>
            </view>
            
            <!-- 该批次的即将到来任务列表 -->
            <view class="batch-task-list">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card upcoming">
                <!-- 任务主体 -->
                <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <!-- 右上角标签 -->
                  <view class="task-badges-top">
                    <view class="type-badge type-{{task.type}}">
                      <text class="type-text">{{healthUtils.getTypeName(task.type)}}</text>
              </view>
            </view>

                  <view class="task-content">
                    <view class="task-header-info">
                    <text class="task-title">{{task.title}}</text>
                      </view>
                    
                    <view class="task-description">{{task.description}}</view>
                    
                    <view class="task-meta-info">
                      <view wx:if="{{task.dayAge}}" class="meta-item">
                        <text class="meta-text">第{{task.dayAge}}日龄</text>
                    </view>
                      <view wx:if="{{task.estimatedTime}}" class="meta-item">
                        <text class="meta-text">预计用时：{{task.estimatedTime}}分钟</text>
                  </view>
                      <view wx:if="{{task.dosage}}" class="meta-item meta-item-full">
                        <text class="meta-text">用量：{{task.dosage}}</text>
                </view>
                      <view wx:if="{{task.duration}}" class="meta-item meta-item-full">
                        <text class="meta-text">连续第{{task.dayInSeries}}/{{task.duration}}天</text>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 无即将到来的任务 -->
        <view wx:else class="modern-empty-state">
          <view class="empty-content">
            <text class="empty-title">暂无即将到来的任务</text>
            <text class="empty-description">当前没有即将到来的计划任务</text>
          </view>
        </view>
      </view>

      <!-- 已完成子标签 -->
      <view class="prevention-subtab-content" wx:if="{{preventionSubTab === 'history'}}">
        <!-- 按批次分组的已完成任务列表 -->
        <view wx:if="{{historyTasksByBatch.length > 0}}" class="batch-task-groups">
          <view wx:for="{{historyTasksByBatch}}" wx:key="id" class="batch-group">
            <!-- 批次组头部 -->
            <view class="batch-group-header">
              <view class="batch-group-info">
                <text class="batch-group-title">{{item.batchNumber}}</text>
                <text class="batch-group-separator">·</text>
                <text class="batch-group-age">第{{item.dayAge}}日龄</text>
                </view>
              <view class="batch-task-count">{{item.tasks.length}}个任务</view>
                  </view>
            
            <!-- 该批次的已完成任务列表 -->
            <view class="batch-task-list">
              <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card completed">
                <!-- 任务主体 -->
                <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <!-- 右上角标签 -->
                  <view class="task-badges-top">
                    <view class="type-badge type-{{task.type}}">
                      <text class="type-text">{{healthUtils.getTypeName(task.type)}}</text>
                </view>
              </view>
                  
                  <view class="task-content">
                    <view class="task-header-info">
                      <text class="task-title completed">{{task.title}}</text>
              </view>
                    
                    <view class="task-description">{{task.description}}</view>
                    
                    <view class="task-meta-info">
                      <view wx:if="{{task.completedDate}}" class="meta-item">
                        <text class="meta-text">完成时间：{{task.completedDate}}</text>
            </view>
                      <view wx:if="{{task.dosage}}" class="meta-item meta-item-full">
                        <text class="meta-text">用量：{{task.dosage}}</text>
                      </view>
                      <view wx:if="{{task.duration}}" class="meta-item meta-item-full">
                        <text class="meta-text">连续第{{task.dayInSeries}}/{{task.duration}}天</text>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>

        <view wx:else class="modern-empty-state">
          <view class="empty-content">
            <text class="empty-title">暂无已完成的任务</text>
            <text class="empty-description">当前没有已完成的任务记录</text>
          </view>
        </view>
      </view>

    </view>


    <!-- 诊疗管理 Tab -->
    <view class="tab-content treatment-content" wx:if="{{activeTab === 'treatment'}}">
      <!-- 诊疗统计 -->
      <view class="treatment-stats">
        <!-- AI诊断卡片（单独一行） -->
        <view class="stat-card stat-card-ai-diagnosis stat-card-full-width" bind:tap="onTreatmentAction" data-action="start_diagnosis">
          <view class="stat-icon stat-icon-ai">
            <view class="css-icon-ai">⚡</view>
          </view>
          <view class="stat-content">
            <text class="stat-value">AI智能诊断</text>
            <text class="stat-label">快速识别疾病，智能推荐治疗方案</text>
          </view>
        </view>
        
        <!-- 统计卡片（四列） -->
        <view class="stats-grid stats-grid-four-treatment">
          <!-- 异常 -->
          <view class="stat-card stat-card-abnormal" bind:tap="onAbnormalCountTap">
            <view class="stat-icon stat-icon-abnormal">
              <view class="css-icon-alert"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{monitoringData.realTimeStatus.abnormalCount || healthStats.abnormalCount || 0}}</text>
              <text class="stat-label">待处理</text>
            </view>
          </view>

          <!-- 治疗中 -->
          <view class="stat-card stat-card-treating" bindtap="onOngoingTreatmentClick">
            <view class="stat-icon stat-icon-treating">
              <view class="css-icon-medicine"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentData.stats.ongoingTreatment}}</text>
              <text class="stat-label">治疗中</text>
            </view>
          </view>
          
          <!-- 治愈数 -->
          <view class="stat-card stat-card-cured clickable" bindtap="navigateToCuredRecords">
            <view class="stat-icon stat-icon-cured">
              <view class="css-icon-heart"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{treatmentStats.recoveredCount || 0}}</text>
              <text class="stat-label">治愈数</text>
            </view>
          </view>

          <!-- 死亡数 -->
          <view class="stat-card stat-card-death" bind:tap="onDeathCountTap">
            <view class="stat-icon stat-icon-death">
              <view class="css-icon-cross"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{healthStats.deadCount}}</text>
              <text class="stat-label">死亡数</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 诊断记录 -->
      <view class="diagnosis-history">
        <view class="section-header">
          <text class="section-title">诊断记录</text>
          <text class="sub-title">（近7天）</text>
          <text class="more-link" bind:tap="onViewAllDiagnosis">查看全部 ></text>
        </view>
        <view class="diagnosis-records-list" wx:if="{{treatmentData.diagnosisHistory.length > 0}}">
          <view 
            class="diagnosis-record-item"
            wx:for="{{treatmentData.diagnosisHistory}}"
            wx:key="_id"
            bind:tap="onDiagnosisRecordTap"
            data-record="{{item}}"
          >
            <view class="record-main">
              <!-- 疾病名称 + 置信度标签 -->
              <view class="record-header">
                <text class="record-name">{{item.diagnosis}}</text>
                <view class="confidence-badge">
                  <text class="confidence-text">置信度 {{item.confidence}}%</text>
                </view>
              </view>

              <!-- 记录内容 -->
              <view class="record-content">
                <!-- 第一行：受影响数 + 日龄 -->
                <view class="info-row">
                  <view class="info-group">
                    <text class="info-label">受影响：</text>
                    <text class="info-value">{{item.affectedCount || 0}}只</text>
                  </view>
                  <view class="info-group">
                    <text class="info-label">日龄：</text>
                    <text class="info-value">{{item.dayAge || 0}}天</text>
                  </view>
                </view>

                <!-- 第二行：症状（如果有） -->
                <view class="info-row" wx:if="{{item.symptoms}}">
                  <view class="info-group full-width">
                    <text class="info-label">症状：</text>
                    <text class="info-value symptoms-value">{{item.symptoms}}</text>
                  </view>
                </view>

                <!-- 第三行：AI诊断 + 日期 + 周期 -->
                <view class="record-footer">
                  <view class="footer-left">
                    <text class="operator-text">AI诊断</text>
                    <text class="date-text">{{item.diagnosisDate}}</text>
                  </view>
                  <text class="duration-text" wx:if="{{item.treatmentDuration}}">周期：{{item.treatmentDuration}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        <view class="empty-placeholder" wx:else>
          <t-empty 
            description="近7天暂无诊断记录"
          />
        </view>
      </view>
    </view>

    <!-- 效果分析 Tab -->
    <view class="tab-content analysis-content" wx:if="{{activeTab === 'analysis'}}">
      <!-- 存活率分析 -->
      <view class="survival-analysis">
        <view class="survival-cards-grid">
          <!-- 存活率卡片 -->
          <view class="stat-card stat-card-survival-rate">
            <view class="stat-icon stat-icon-survival-rate">
              <view class="css-icon-heart-pulse"></view>
          </view>
            <view class="stat-content">
              <text class="stat-label">存活率</text>
            </view>
            <view class="stat-value-wrapper">
              <text class="stat-value">{{analysisData.survivalAnalysis.rate === '-' ? '-' : analysisData.survivalAnalysis.rate + '%'}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 预防统计 -->
      <view class="prevention-stats-analysis">
        <view class="section-header">
          <text class="section-title">预防统计</text>
        </view>
        
        <!-- 统计卡片（两列） -->
        <view class="stats-grid stats-grid-two-analysis">
          <!-- 防疫用药 -->
          <view class="stat-card stat-card-vaccination clickable" bind:tap="onMedicationCountTap">
            <view class="stat-icon stat-icon-vaccination">
              <view class="css-icon-check-list"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{preventionData.stats.medicationCount || 0}}</text>
              <text class="stat-label">防疫用药</text>
            </view>
          </view>

          <!-- 疫苗追踪 -->
          <view class="stat-card stat-card-vaccine-count clickable" bind:tap="onVaccineCountTap">
            <view class="stat-icon stat-icon-vaccine-count">
              <view class="css-icon-check-list"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{preventionData.stats.vaccineCount || 0}}</text>
              <text class="stat-label">疫苗追踪</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 成本分析 -->
      <view class="cost-analysis">
        <view class="section-header">
          <text class="section-title">成本分析</text>
        </view>
        <view class="stats-grid stats-grid-four-cost">
          <!-- 预防成本 -->
          <view class="stat-card stat-card-prevention-cost-analysis">
            <view class="stat-icon stat-icon-prevention-cost-analysis">
              <view class="css-icon-shield"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">¥{{analysisData.costAnalysis.preventionCost || 0}}</text>
              <text class="stat-label">预防成本</text>
            </view>
          </view>

          <!-- 治疗成本 -->
          <view class="stat-card stat-card-treatment-cost-analysis">
            <view class="stat-icon stat-icon-treatment-cost-analysis">
              <view class="css-icon-medicine-cost"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">¥{{analysisData.costAnalysis.treatmentCost || 0}}</text>
              <text class="stat-label">治疗成本</text>
            </view>
          </view>
          
          <!-- 总成本 -->
          <view class="stat-card stat-card-total-cost">
            <view class="stat-icon stat-icon-total-cost">
              <view class="css-icon-total"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">¥{{analysisData.costAnalysis.totalCost || 0}}</text>
              <text class="stat-label">总成本</text>
            </view>
          </view>

          <!-- 投入回报率 -->
          <view class="stat-card stat-card-roi">
            <view class="stat-icon stat-icon-roi">
              <view class="css-icon-growth"></view>
            </view>
            <view class="stat-content">
              <text class="stat-value">{{analysisData.costAnalysis.roi === '-' ? '-' : (analysisData.costAnalysis.roi || 0) + ':1'}}</text>
              <text class="stat-label">投入回报率</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 底部安全区域 -->
    <view class="safe-area"></view>
  </view>

  <!-- 详情弹窗 -->
  <bottom-popup
    visible="{{showDetailPopup}}"
    title="详情信息"
    show-close="{{true}}"
    bind:close="onCloseDetail"
    bind:visiblechange="onHealthDetailPopupChange"
  >
    <view wx:if="{{selectedRecord}}" class="detail-content">
      <view class="detail-card">
        <text class="detail-info">{{selectedRecord.title || selectedRecord.name || selectedRecord.symptoms}}</text>
        <text class="detail-desc">{{selectedRecord.description || selectedRecord.content}}</text>
        <text class="detail-time">{{selectedRecord.createTime || selectedRecord.date}}</text>
      </view>
    </view>
  </bottom-popup>

  <!-- ✅ 诊断记录详情弹窗（使用共用组件） -->
  <diagnosis-detail-popup
    visible="{{showDiagnosisDetailPopup}}"
    record="{{selectedDiagnosisRecord}}"
    bind:close="onCloseDiagnosisDetail"
  />

  <!-- 批次筛选下拉菜单（放在最后，确保显示在最上层） -->
  <view class="batch-dropdown {{showBatchDropdown ? 'show' : ''}}" style="top: {{dropdownTop}}px;" wx:if="{{showBatchDropdown}}">
    <!-- 全部批次选项 -->
    <view 
      class="dropdown-item {{'all' === currentBatchId ? 'active' : ''}}"
      bind:tap="selectAllBatches"
    >
      <view class="item-content">
        <text class="item-title">全部批次</text>
        <text class="item-subtitle">查看所有批次的健康数据汇总</text>
      </view>
      <text class="check-mark" wx:if="{{'all' === currentBatchId}}">✓</text>
    </view>
    
    <!-- 分隔线 -->
    <view class="dropdown-divider" wx:if="{{availableBatches.length > 0}}"></view>
    
    <!-- 具体批次列表 -->
    <view 
      class="dropdown-item {{item._id === currentBatchId ? 'active' : ''}}"
      wx:for="{{availableBatches}}"
      wx:key="_id"
      bind:tap="selectBatchFromDropdown"
      data-index="{{index}}"
    >
      <view class="item-content">
        <text class="item-title">{{item.batchNumber}}</text>
        <text class="item-subtitle">{{item.breed}} · {{item.dayAge}}日龄 · {{item.quantity}}只</text>
      </view>
      <text class="check-mark" wx:if="{{item._id === currentBatchId}}">✓</text>
    </view>
    
    <view class="dropdown-empty" wx:if="{{availableBatches.length === 0}}">
      <text>暂无存栏批次</text>
    </view>
  </view>

  <!-- 遮罩层（放在最后，确保显示在最上层） -->
  <view 
    class="dropdown-mask {{showBatchDropdown ? 'show' : ''}}" 
    wx:if="{{showBatchDropdown}}"
    bind:tap="closeBatchDropdown"
    catchtouchmove="preventTouchMove"
  ></view>

  <!-- ========== 从 breeding-todo 完整复制的表单弹窗 ========== -->
  
  <!-- 任务详情弹窗 -->
  <bottom-popup
    visible="{{showTaskDetailPopup}}"
    title="任务详情"
    show-close="{{true}}"
    show-actions="{{selectedTask && !selectedTask.completed && !selectedTask.isUpcoming}}"
    confirm-text="{{selectedTask && selectedTask.isVaccineTask ? '填写接种信息' : (selectedTask && selectedTask.isMedicationTask ? '领取药品' : (selectedTask && selectedTask.isNutritionTask ? '领取营养品' : '完成任务'))}}"
    cancel-text="关闭"
    bind:close="closeTaskDetailPopup"
    bind:confirm="onTaskConfirm"
    bind:cancel="closeTaskDetailPopup"
    bind:visiblechange="onTaskDetailPopupChange"
  >
    <view wx:if="{{selectedTask}}" class="record-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">任务名称：</text>
            <text class="info-value auto-align {{taskFieldMultiline.title ? 'multiline' : ''}}" id="info-value-title">{{selectedTask.title || '未命名任务'}}</text>
          </view>
          <view class="divider-line"></view>

          <view class="info-row">
            <text class="info-label">任务类型：</text>
            <text class="info-value auto-align {{taskFieldMultiline.type ? 'multiline' : ''}}" id="info-value-type">{{selectedTask.typeName || '未分类'}}</text>
          </view>
          <view class="divider-line"></view>

          <block wx:if="{{selectedTask.estimatedTime}}">
            <view class="info-row">
              <text class="info-label">预计用时：</text>
              <text class="info-value auto-align {{taskFieldMultiline.time ? 'multiline' : ''}}" id="info-value-time">{{selectedTask.estimatedTime}}分钟</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.duration && selectedTask.dayInSeries}}">
            <view class="info-row">
              <text class="info-label">连续任务：</text>
              <text class="info-value auto-align {{taskFieldMultiline.duration ? 'multiline' : ''}}" id="info-value-duration">第{{selectedTask.dayInSeries}}/{{selectedTask.duration}}天</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.materials && selectedTask.materials.length > 0}}">
            <view class="info-row">
              <text class="info-label">所需物料：</text>
              <text class="info-value materials-text auto-align {{taskFieldMultiline.materials ? 'multiline' : ''}}" id="info-value-materials">
                <text wx:for="{{selectedTask.materials}}" wx:key="index">{{item}}<text wx:if="{{index < selectedTask.materials.length - 1}}">、</text></text>
              </text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.batchNumber}}">
            <view class="info-row">
              <text class="info-label">批次编号：</text>
              <text class="info-value auto-align {{taskFieldMultiline.batch ? 'multiline' : ''}}" id="info-value-batch">{{selectedTask.batchNumber}}</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.dayAge}}">
            <view class="info-row">
              <text class="info-label">日龄：</text>
              <text class="info-value auto-align {{taskFieldMultiline.age ? 'multiline' : ''}}" id="info-value-age">第{{selectedTask.dayAge}}日龄</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.description}}">
            <view class="info-row info-row-description">
              <text class="info-label">任务描述：</text>
              <text class="info-value note-text auto-align {{taskFieldMultiline.description ? 'multiline' : ''}}" id="info-value-description">{{selectedTask.description}}</text>
            </view>
            <view class="divider-line"></view>
          </block>

          <block wx:if="{{selectedTask.dosage}}">
            <view class="info-row info-row-dosage">
              <text class="info-label">用量：</text>
              <text class="info-value dosage-text auto-align {{taskFieldMultiline.dosage ? 'multiline' : ''}}" id="info-value-dosage">{{selectedTask.dosage}}</text>
            </view>
            <view class="divider-line"></view>
          </block>
          
          <!-- 已完成任务的额外信息 -->
          <view wx:if="{{selectedTask.completed}}">
            <view class="info-row" wx:if="{{selectedTask.completedDate}}">
              <text class="info-label">完成时间：</text>
              <text class="info-value">{{selectedTask.completedDate}}</text>
            </view>
            <view class="divider-line" wx:if="{{selectedTask.completedDate && selectedTask.completedBy}}"></view>
            <view class="info-row" wx:if="{{selectedTask.completedBy}}">
              <text class="info-label">完成人员：</text>
              <text class="info-value">{{selectedTask.completedBy}}</text>
            </view>
            
            <!-- 用药管理类型的特殊信息 -->
            <view wx:if="{{selectedTask.isMedicationTask && selectedTask.medicationDetails}}" class="medication-info-card">
              <view class="card-title">用药信息</view>
              <view class="info-row">
                <text class="info-label">药品名称：</text>
                <text class="info-value">{{selectedTask.medicationDetails.name || '未记录'}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.medicationDetails.actualDosage}}">
                <text class="info-label">实际用量：</text>
                <text class="info-value">{{selectedTask.medicationDetails.actualDosage}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.medicationDetails.method}}">
                <text class="info-label">用药方式：</text>
                <text class="info-value">{{selectedTask.medicationDetails.method}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.medicationDetails.batchNumber}}">
                <text class="info-label">药品批号：</text>
                <text class="info-value">{{selectedTask.medicationDetails.batchNumber}}</text>
              </view>
            </view>
            
            <!-- 疫苗接种类型的特殊信息 -->
            <view wx:if="{{selectedTask.isVaccineTask && selectedTask.vaccineDetails}}" class="vaccine-info-card">
              <view class="card-title">接种信息</view>
              <view class="info-row">
                <text class="info-label">疫苗名称：</text>
                <text class="info-value">{{selectedTask.vaccineDetails.name || '未记录'}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.vaccineDetails.batchNumber}}">
                <text class="info-label">疫苗批号：</text>
                <text class="info-value">{{selectedTask.vaccineDetails.batchNumber}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.vaccineDetails.dosage}}">
                <text class="info-label">接种剂量：</text>
                <text class="info-value">{{selectedTask.vaccineDetails.dosage}}</text>
              </view>
              <view class="info-row" wx:if="{{selectedTask.vaccineDetails.count}}">
                <text class="info-label">接种数量：</text>
                <text class="info-value">{{selectedTask.vaccineDetails.count}}只</text>
            </view>
            </view>
          </view>
          
          <view class="info-row info-row-notes" wx:if="{{selectedTask.notes}}">
            <text class="info-label">注意事项：</text>
            <text class="info-value note-text important-text auto-align {{taskFieldMultiline.notes ? 'multiline' : ''}}" id="info-value-notes">{{selectedTask.notes}}</text>
          </view>

          <!-- 完成状态放在最下方 -->
          <view class="divider-line"></view>
          <view class="info-row">
            <text class="info-label">完成状态：</text>
            <view class="status-value">
              <t-tag theme="{{selectedTask.completed ? 'success' : 'primary'}}" size="small">
                {{selectedTask.statusText || '待完成'}}
              </t-tag>
            </view>
          </view>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- 疫苗接种表单弹窗 -->
  <bottom-popup
    visible="{{showVaccineFormPopup}}"
    title="疫苗接种信息"
    show-close="{{true}}"
    bind:close="closeVaccineFormPopup"
  >
    <view class="vaccine-form-content">
      <!-- 兽医信息 -->
      <view class="form-section">
        <view class="section-title">兽医信息</view>
        <view class="form-item">
          <view class="item-label required">执行兽医</view>
          <view class="item-input">
            <input
              placeholder="请输入兽医姓名"
              value="{{vaccineFormData.veterinarianName}}"
              data-field="veterinarianName"
              bindinput="onVaccineFormInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label">联系电话</view>
          <view class="item-input">
            <input
              placeholder="请输入联系电话"
              value="{{vaccineFormData.veterinarianContact}}"
              data-field="veterinarianContact"
              bindinput="onVaccineFormInput"
            />
          </view>
        </view>
      </view>

      <!-- 疫苗信息 -->
      <view class="form-section">
        <view class="section-title">疫苗信息</view>
        <view class="form-item">
          <view class="item-label required">疫苗名称</view>
          <view class="item-input">
            <input
              placeholder="请输入疫苗名称"
              value="{{vaccineFormData.vaccineName}}"
              data-field="vaccineName"
              bindinput="onVaccineFormInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label">生产厂家</view>
          <view class="item-input">
            <input
              placeholder="请输入生产厂家"
              value="{{vaccineFormData.manufacturer}}"
              data-field="manufacturer"
              bindinput="onVaccineFormInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label">批次号</view>
          <view class="item-input">
            <input
              placeholder="请输入疫苗批次号"
              value="{{vaccineFormData.batchNumber}}"
              data-field="batchNumber"
              bindinput="onVaccineFormInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label required">接种剂量</view>
          <view class="item-input">
            <input
              placeholder="请输入接种剂量"
              value="{{vaccineFormData.dosage}}"
              data-field="dosage"
              bindinput="onVaccineFormInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label required">接种数量</view>
          <view class="item-input">
            <input
              type="number"
              placeholder="{{currentBatchStockQuantity > 0 ? '请输入接种数量（存栏' + currentBatchStockQuantity + '只）' : '请输入接种数量'}}"
              value="{{vaccineFormData.vaccinationCount}}"
              data-field="vaccinationCount"
              bindinput="onVaccineNumberInput"
            />
          </view>
        </view>
        <view wx:if="{{vaccineFormErrors.vaccinationCount}}" class="form-item error-item">
          <view class="error-text">{{vaccineFormErrors.vaccinationCount}}</view>
        </view>
      </view>

      <!-- 费用信息 -->
      <view class="form-section">
        <view class="section-title">费用信息</view>
        <view class="form-item">
          <view class="item-label required">疫苗费用</view>
          <view class="item-input">
            <input
              type="digit"
              placeholder="请输入疫苗费用"
              value="{{vaccineFormData.vaccineCost}}"
              data-field="vaccineCost"
              bindinput="onVaccineNumberInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label">兽医费用</view>
          <view class="item-input">
            <input
              type="digit"
              placeholder="请输入兽医费用"
              value="{{vaccineFormData.veterinaryCost}}"
              data-field="veterinaryCost"
              bindinput="onVaccineNumberInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label">其他费用</view>
          <view class="item-input">
            <input
              type="digit"
              placeholder="请输入其他费用"
              value="{{vaccineFormData.otherCost}}"
              data-field="otherCost"
              bindinput="onVaccineNumberInput"
            />
          </view>
        </view>
        <view class="form-item">
          <view class="item-label">总费用</view>
          <view class="item-value">
            <view class="value-text">{{vaccineFormData.totalCostFormatted || '¥0.00'}}</view>
          </view>
        </view>
      </view>

      <!-- 备注和异常记录 -->
      <view class="form-section">
        <view class="section-title">备注信息</view>
        <view class="form-item textarea-item">
          <textarea
            class="textarea-input"
            placeholder="请输入接种备注信息"
            value="{{vaccineFormData.notes}}"
            data-field="notes"
            bindinput="onVaccineFormInput"
            maxlength="200"
            auto-height
          />
        </view>
      </view>

      <!-- 表单验证错误提示 -->
      <view wx:if="{{vaccineFormErrorList && vaccineFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{vaccineFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>

      <!-- 底部按钮 -->
      <view class="form-bottom-buttons">
        <button class="form-button form-button-cancel" bindtap="closeVaccineFormPopup">取消</button>
        <button class="form-button form-button-primary" bindtap="submitVaccineForm">完成接种</button>
      </view>
    </view>
  </bottom-popup>

  <!-- 异常反应处理弹窗 -->
  <bottom-popup
    visible="{{showAdverseReactionPopup}}"
    title="异常反应处理"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="记录异常"
    cancel-text="取消"
    bind:close="closeAdverseReactionPopup"
    bind:confirm="submitAdverseReactionRecord"
    bind:cancel="closeAdverseReactionPopup"
  >
    <view class="adverse-reaction-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">异常数量：</text>
            <text class="info-value">{{adverseReactionData.count}}只</text>
          </view>
          <view class="info-row">
            <text class="info-label">异常症状：</text>
            <text class="info-value">{{adverseReactionData.symptoms}}</text>
          </view>
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">补充信息</view>
        <view class="form-row">
          <text class="form-label">症状等级</text>
          <picker mode="selector" 
                  range="{{severityOptions}}"
                  range-key="label"
                  value="{{adverseReactionData.severityIndex}}"
                  bindchange="onSeverityChange">
            <view class="form-input picker-input">
              {{severityOptions[adverseReactionData.severityIndex].label}}
            </view>
          </picker>
        </view>
        <view class="form-row">
          <text class="form-label">处理措施</text>
          <textarea class="form-textarea" 
                    placeholder="请输入已采取的处理措施"
                    value="{{adverseReactionData.treatment}}"
                    data-field="treatment"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
        <view class="form-row">
          <text class="form-label">后续观察</text>
          <textarea class="form-textarea" 
                    placeholder="请输入后续观察要点"
                    value="{{adverseReactionData.followUp}}"
                    data-field="followUp"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- 用药管理表单弹窗 -->
  <bottom-popup
    visible="{{showMedicationFormPopup}}"
    title="用药管理"
    show-close="{{true}}"
    bind:close="closeMedicationFormPopup"
  >
    <view class="medication-form-content">
      <!-- 用药信息 -->
      <view class="form-section">
        <view class="section-title">用药信息</view>
        <view class="form-row">
          <text class="form-label required">选择药品</text>
          <picker mode="selector" 
                  range="{{availableMedicines}}"
                  range-key="name"
                  bindchange="onMedicineSelect">
            <view class="form-input picker-input">
              {{selectedMedicine ? selectedMedicine.name : '请选择药品'}}
            </view>
          </picker>
          <text wx:if="{{medicationFormErrors.medicineId}}" class="error-text">{{medicationFormErrors.medicineId}}</text>
        </view>
        
        <view wx:if="{{selectedMedicine}}" class="medicine-info">
          <view class="info-item">
            <text class="info-label">当前库存：</text>
            <text class="info-value">{{selectedMedicine.stock}}{{selectedMedicine.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedMedicine.description}}">
            <text class="info-label">药品说明：</text>
            <text class="info-value">{{selectedMedicine.description}}</text>
          </view>
        </view>

        <view class="form-row">
          <text class="form-label required">用药数量</text>
          <input class="form-input" 
                 type="number"
                 placeholder="请输入用药数量"
                 value="{{medicationFormData.quantity > 0 ? medicationFormData.quantity : ''}}"
                 bindinput="onMedicationQuantityInput" />
          <text wx:if="{{medicationFormErrors.quantity}}" class="error-text">{{medicationFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">用药剂量</text>
          <input class="form-input" 
                 placeholder="请输入用药剂量"
                 value="{{medicationFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onMedicationFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">鹅只数量</text>
          <input class="form-input" 
                 type="number"
                 placeholder="{{currentBatchStockQuantity > 0 ? '请输入鹅只数量（存栏' + currentBatchStockQuantity + '只）' : '请输入鹅只数量'}}"
                 value="{{medicationFormData.animalCount > 0 ? medicationFormData.animalCount : ''}}"
                 bindinput="onMedicationAnimalCountInput" />
          <text wx:if="{{medicationFormErrors.animalCount}}" class="error-text">{{medicationFormErrors.animalCount}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">操作员</text>
          <view class="form-input readonly-input">{{medicationFormData.operator}}</view>
        </view>
      </view>

      <!-- 备注信息 -->
      <view class="form-section">
        <view class="section-title">备注信息</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="请输入用药备注信息"
                    value="{{medicationFormData.notes}}"
                    data-field="notes"
                    bindinput="onMedicationFormInput"
                    maxlength="200"
                    auto-height="{{true}}"
                    show-confirm-bar="{{false}}" />
        </view>
      </view>

      <!-- 表单验证错误提示 -->
      <view wx:if="{{medicationFormErrorList && medicationFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{medicationFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>

      <!-- 底部操作按钮 -->
      <view class="form-actions">
        <t-button 
          theme="light" 
          size="large" 
          block
          bind:tap="closeMedicationFormPopup"
        >
          取消
        </t-button>
        <t-button 
          theme="primary" 
          size="large" 
          block
          bind:tap="submitMedicationForm"
        >
          确认领用
        </t-button>
      </view>
    </view>
  </bottom-popup>

  <!-- 营养管理表单弹窗 -->
  <bottom-popup
    visible="{{showNutritionFormPopup}}"
    title="营养管理"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="确认领取"
    cancel-text="取消"
    bind:close="closeNutritionFormPopup"
    bind:confirm="submitNutritionForm"
    bind:cancel="closeNutritionFormPopup"
  >
    <view class="nutrition-form-content">
      <!-- 营养品选择 -->
      <view class="form-section">
        <view class="section-title">营养品选择</view>
        <view class="form-row">
          <text class="form-label required">选择营养品</text>
          <picker mode="selector" 
                  range="{{availableNutrition}}"
                  range-key="name"
                  bindchange="onNutritionSelect">
            <view class="form-input picker-input">
              {{selectedNutrition ? selectedNutrition.name : '请选择营养品'}}
            </view>
          </picker>
          <text wx:if="{{nutritionFormErrors.nutritionId}}" class="error-text">{{nutritionFormErrors.nutritionId}}</text>
        </view>
        
        <view wx:if="{{selectedNutrition}}" class="nutrition-info">
          <view class="info-item">
            <text class="info-label">当前库存：</text>
            <text class="info-value">{{selectedNutrition.stock}}{{selectedNutrition.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedNutrition.description}}">
            <text class="info-label">营养品说明：</text>
            <text class="info-value">{{selectedNutrition.description}}</text>
          </view>
        </view>
      </view>

      <!-- 使用信息 -->
      <view class="form-section">
        <view class="section-title">使用信息</view>
        <view class="form-row">
          <text class="form-label required">使用数量</text>
          <input class="form-input" 
                 type="number"
                 placeholder="请输入使用数量"
                 value="{{nutritionFormData.quantity > 0 ? nutritionFormData.quantity : ''}}"
                 bindinput="onNutritionQuantityInput" />
          <text wx:if="{{nutritionFormErrors.quantity}}" class="error-text">{{nutritionFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">使用剂量</text>
          <input class="form-input" 
                 placeholder="请输入使用剂量"
                 value="{{nutritionFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onNutritionFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">操作员</text>
          <view class="form-input readonly-input">{{nutritionFormData.operator}}</view>
        </view>
      </view>

      <!-- 备注信息 -->
      <view class="form-section">
        <view class="section-title">备注信息</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="请输入营养品使用备注信息"
                    value="{{nutritionFormData.notes}}"
                    data-field="notes"
                    bindinput="onNutritionFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- 表单验证错误提示 -->
      <view wx:if="{{nutritionFormErrorList && nutritionFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{nutritionFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  </view>
  <!-- detail-view 结束 -->

</view>