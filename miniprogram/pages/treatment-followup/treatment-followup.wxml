<!--treatment-followup.wxml - 治疗跟进页面-->
<view class="page-container">
  <!-- 自定义导航栏 -->
  <navigation-bar 
    title="治疗跟进"
    show-back="{{true}}"
    show-menu="{{false}}"
    show-record="{{false}}"
    bind:back="goBack"
  />

  <!-- 表单内容区域 -->
  <view class="form-content">
    <!-- 原始记录信息 -->
    <view class="original-record-section">
      <view class="section-header">
        <text class="section-title">原始记录</text>
      </view>
      
      <view class="form-card original-record">
        <view class="record-header">
          <view class="batch-info">
            <text class="record-batch">{{originalRecord.batchNumber}}</text>
            <text class="record-date">{{originalRecord.recordDate}}</text>
          </view>
          <view class="header-right">
            <view class="stat-badge">
              <text class="stat-number">{{originalRecord.affectedCount}}</text>
              <text class="stat-unit">羽</text>
            </view>
            <t-tag theme="{{originalRecord.severity}}" size="small">{{originalRecord.severityText}}</t-tag>
          </view>
        </view>
        
        <view class="record-summary">
          <view class="summary-item">
            <text class="summary-label">症状</text>
            <text class="summary-value">{{originalRecord.symptoms}}</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">治疗</text>
            <text class="summary-value">{{originalRecord.treatment}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 跟进表单 -->
    <view class="followup-form-section">
      <view class="section-header">
        <text class="section-title">治疗跟进</text>
      </view>
      
      <view class="form-card">
        <!-- 跟进日期 -->
        <view class="form-item">
          <view class="form-label required">跟进日期</view>
          <view class="form-field-content">
            <view class="picker-content" bind:tap="showDatePicker">
              <text class="picker-text">{{formData.followupDate || '请选择跟进日期'}}</text>
              <t-icon name="calendar" size="24rpx" color="#bbb" />
            </view>
          </view>
        </view>

        <!-- 治愈数量 -->
        <view class="quantity-section cured-section">
          <view class="quantity-header">
            <view class="quantity-title">
              <t-icon name="check-circle-filled" size="32rpx" color="#00a870" />
              <text class="title-text">治愈数量</text>
            </view>
            <view class="reference-info">
              <text class="reference-text">可处理：{{originalRecord.currentAffectedCount}} 羽</text>
              <text class="detail-text">（原始 {{originalRecord.affectedCount}} 羽，已治愈 {{originalRecord.curedCount}} 羽，已死亡 {{originalRecord.deathCount}} 羽）</text>
            </view>
          </view>
          <view class="quantity-input">
            <t-input
              placeholder="输入治愈数量"
              value="{{formData.curedCount}}"
              type="number"
              bind:change="onFieldChange"
              data-field="curedCount"
              suffix="羽"
              align="center"
              class="quantity-field cured-field"
            />
          </view>
        </view>

        <!-- 死亡数量 -->
        <view class="quantity-section death-section">
          <view class="quantity-header">
            <view class="quantity-title">
              <t-icon name="error-circle-filled" size="32rpx" color="#d54941" />
              <text class="title-text">死亡数量</text>
            </view>
            <view class="reference-info">
              <text class="reference-text">可处理：{{originalRecord.currentAffectedCount}} 羽</text>
              <text class="detail-text">（原始 {{originalRecord.affectedCount}} 羽，已治愈 {{originalRecord.curedCount}} 羽，已死亡 {{originalRecord.deathCount}} 羽）</text>
            </view>
          </view>
          <view class="quantity-input">
            <t-input
              placeholder="输入死亡数量"
              value="{{formData.deathCount}}"
              type="number"
              bind:change="onFieldChange"
              data-field="deathCount"
              suffix="羽"
              align="center"
              class="quantity-field death-field"
            />
          </view>
        </view>

        <!-- 跟进备注 -->
        <view class="form-item form-item-vertical">
          <view class="form-label">跟进备注</view>
          <view class="form-field-content">
            <t-textarea
              placeholder="请输入跟进情况，如：治疗效果、症状变化、后续计划等..."
              value="{{formData.notes}}"
              bind:change="onFieldChange"
              data-field="notes"
              maxlength="300"
              indicator
              autosize
              class="form-textarea"
            />
          </view>
        </view>
      </view>
    </view>

    <!-- 提交按钮 -->
    <view class="form-actions">
      <t-button 
        theme="primary" 
        size="large" 
        block 
        bind:tap="onSubmit"
        loading="{{submitting}}"
        disabled="{{submitting}}"
      >
        {{submitting ? '提交中...' : '提交跟进记录'}}
      </t-button>
      <t-button 
        theme="default" 
        size="large" 
        block 
        bind:tap="goBack"
        disabled="{{submitting}}"
      >
        取消
      </t-button>
    </view>

    <!-- 温馨提示 -->
    <view class="form-tips">
      <t-notice-bar theme="info" content="💡 提示：可同时填写治愈和死亡数量，总数不能超过剩余待处理数量。至少需要填写一项。" />
    </view>
  </view>

  <!-- 日期选择器 -->
  <t-date-time-picker 
    visible="{{showDate}}"
    mode="date"
    value="{{dateValue}}"
    format="YYYY-MM-DD"
    bind:cancel="hideDatePicker"
    bind:confirm="onDateConfirm"
  />
</view>
