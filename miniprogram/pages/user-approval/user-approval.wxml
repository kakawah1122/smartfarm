<!-- 用户审批页面 -->
<view class="page-container">
  <navigation-bar
    title="用户审批管理"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- 搜索栏 -->
  <view class="search-section">
    <t-search
      value="{{searchKeyword}}"
      placeholder="搜索用户昵称、手机号或农场名"
      bind:change="onSearchChange"
      bind:submit="onSearch"
      bind:clear="onSearchClear"
    />
  </view>

  <!-- 统计卡片 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.total}}</text>
        <text class="stat-label">总用户数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.pending}}</text>
        <text class="stat-label">待审批</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.approved}}</text>
        <text class="stat-label">已审批</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.approvalRate}}%</text>
        <text class="stat-label">通过率</text>
      </view>
    </view>
  </view>

  <!-- 筛选选项卡 -->
  <view class="filter-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="待审批" value="pending" />
      <t-tab-panel label="已审批" value="approved" />
      <t-tab-panel label="已拒绝" value="rejected" />
      <t-tab-panel label="全部用户" value="all" />
    </t-tabs>
  </view>

  <!-- 批量操作栏 -->
  <view wx:if="{{selectedUsers.length > 0}}" class="batch-action-bar">
    <view class="selected-info">
      <text>已选择 {{selectedUsers.length}} 个用户</text>
    </view>
    <view class="batch-actions">
      <t-button
        theme="primary"
        size="small"
        bind:tap="batchApprove"
      >
        批量批准
      </t-button>
      <t-button
        theme="danger"
        size="small"
        bind:tap="batchReject"
      >
        批量拒绝
      </t-button>
      <t-button
        theme="default"
        size="small"
        bind:tap="clearSelection"
      >
        取消选择
      </t-button>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="spinner" size="40rpx" text="加载中..." />
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{userList.length === 0}}" class="empty-container">
    <t-empty icon="user" description="暂无用户数据" />
  </view>

  <!-- 用户列表 -->
  <view wx:else class="content-container">
    <t-cell-group class="user-list">
      <t-cell
        wx:for="{{userList}}"
        wx:key="_id"
        title="{{item.nickname || '未设置昵称'}}"
        note="{{item.farmName || '未设置农场'}}"
        description="{{item.phone || '未绑定手机'}} | 等待{{item.waitingDays}}天"
        image="{{item.avatarUrl}}"
        hover
        bind:click="onUserClick"
        data-user="{{item}}"
      >
        <view slot="left-icon" wx:if="{{activeTab === 'pending'}}" class="checkbox-container">
          <checkbox
            value="{{item._id}}"
            checked="{{selectedUsers.indexOf(item._id) !== -1}}"
            bind:tap="onCheckboxChange"
            data-user-id="{{item._id}}"
          />
        </view>
        <view slot="right-icon" class="user-info">
          <t-tag
            theme="{{getStatusTheme(item.approvalStatus) || 'default'}}"
            size="small"
            class="status-tag"
          >
            {{item.statusText || '未知状态'}}
          </t-tag>
          <view wx:if="{{item.inviteInfo}}" class="invite-info">
            <text class="invite-text">{{item.inviteInfo.department}} - {{item.inviteInfo.position}}</text>
          </view>
        </view>
      </t-cell>
    </t-cell-group>

    <!-- 分页加载 -->
    <view wx:if="{{hasMore}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? '加载中...' : '加载更多'}}
      </t-button>
    </view>
  </view>
</view>

<!-- 用户详情弹窗 -->
<t-dialog
  visible="{{showUserDetail}}"
  title="用户审批详情"
  confirm-btn="确定"
  bind:confirm="closeUserDetail"
  bind:cancel="closeUserDetail"
>
  <view wx:if="{{selectedUser}}" class="user-detail">
    <!-- 基本信息 -->
    <view class="detail-section">
      <view class="section-title">基本信息</view>
      <view class="detail-item">
        <text class="detail-label">昵称：</text>
        <text class="detail-value">{{selectedUser.nickname || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">手机号：</text>
        <text class="detail-value">{{selectedUser.phone || '未绑定'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">农场名：</text>
        <text class="detail-value">{{selectedUser.farmName || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">当前状态：</text>
        <text class="detail-value">{{selectedUser.statusText}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">等待时间：</text>
        <text class="detail-value">{{selectedUser.waitingDays}}天</text>
      </view>
    </view>

    <!-- 邀请信息 -->
    <view wx:if="{{selectedUser.inviteInfo}}" class="detail-section">
      <view class="section-title">邀请信息</view>
      <view class="detail-item">
        <text class="detail-label">邀请人：</text>
        <text class="detail-value">{{selectedUser.inviteInfo.inviterName}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">部门：</text>
        <text class="detail-value">{{selectedUser.inviteInfo.department || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">职位：</text>
        <text class="detail-value">{{selectedUser.inviteInfo.position || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">邀请时间：</text>
        <text class="detail-value">{{formatTime(selectedUser.inviteInfo.createTime)}}</text>
      </view>
    </view>

    <!-- 业务统计 -->
    <view wx:if="{{selectedUser.businessStats}}" class="detail-section">
      <view class="section-title">业务统计</view>
      <view class="business-stats">
        <view class="stat-item">
          <text class="stat-number">{{selectedUser.businessStats.healthRecords}}</text>
          <text class="stat-label">健康记录</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{selectedUser.businessStats.entryRecords}}</text>
          <text class="stat-label">入栏记录</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{selectedUser.businessStats.exitRecords}}</text>
          <text class="stat-label">出栏记录</text>
        </view>
      </view>
    </view>

    <!-- 审批操作 -->
    <view wx:if="{{selectedUser.approvalStatus === 'pending'}}" class="approval-actions">
      <t-button
        theme="primary"
        size="medium"
        bind:tap="showApprovalDialog"
        class="action-btn"
      >
        批准用户
      </t-button>
      <t-button
        theme="danger"
        size="medium"
        bind:tap="showRejectDialog"
        class="action-btn"
      >
        拒绝用户
      </t-button>
    </view>
  </view>
</t-dialog>

<!-- 批准用户弹窗 -->
<t-dialog
  visible="{{showApprovalDialog}}"
  title="批准用户"
  confirm-btn="确认批准"
  cancel-btn="取消"
  bind:confirm="approveUser"
  bind:cancel="closeApprovalDialog"
>
  <view class="approval-form">
    <view class="form-item">
      <text class="form-label">分配角色</text>
      <t-picker
        value="{{selectedApprovalRoleIndex}}"
        options="{{roleOptions}}"
        bind:change="onAssignedRoleChange"
      />
    </view>
    <view class="form-item">
      <text class="form-label">审批备注</text>
      <t-textarea
        value="{{approvalData.approvalRemark}}"
        placeholder="请输入审批备注（可选）"
        maxlength="200"
        bind:change="onApprovalRemarkChange"
      />
    </view>
  </view>
</t-dialog>

<!-- 拒绝用户弹窗 -->
<t-dialog
  visible="{{showRejectDialog}}"
  title="拒绝用户"
  confirm-btn="确认拒绝"
  cancel-btn="取消"
  bind:confirm="rejectUser"
  bind:cancel="closeRejectDialog"
>
  <view class="reject-form">
    <view class="reject-warning">
      <text>确定要拒绝用户"{{selectedUser.nickname}}"的注册申请吗？</text>
    </view>
    <view class="form-item">
      <text class="form-label">拒绝原因 *</text>
      <t-textarea
        value="{{rejectedReason}}"
        placeholder="请输入拒绝原因"
        maxlength="200"
        bind:change="onRejectedReasonChange"
      />
    </view>
  </view>
</t-dialog>

<!-- 批量操作弹窗 -->
<t-dialog
  visible="{{showBatchDialog}}"
  title="{{batchAction === 'approve' ? '批量批准' : '批量拒绝'}}"
  confirm-btn="{{batchAction === 'approve' ? '确认批准' : '确认拒绝'}}"
  cancel-btn="取消"
  bind:confirm="confirmBatchAction"
  bind:cancel="closeBatchDialog"
>
  <view class="batch-form">
    <view class="batch-info">
      <text>您选择了 {{selectedUsers.length}} 个用户进行{{batchAction === 'approve' ? '批准' : '拒绝'}}操作</text>
    </view>
    
    <view wx:if="{{batchAction === 'approve'}}" class="form-item">
      <text class="form-label">统一分配角色</text>
      <t-picker
        value="{{selectedBatchRoleIndex}}"
        options="{{roleOptions}}"
        bind:change="onBatchRoleChange"
      />
    </view>
    
    <view class="form-item">
      <text class="form-label">{{batchAction === 'approve' ? '审批备注' : '拒绝原因'}} {{batchAction === 'reject' ? '*' : ''}}</text>
      <t-textarea
        value="{{batchData.remark}}"
        placeholder="{{batchAction === 'approve' ? '请输入审批备注（可选）' : '请输入拒绝原因'}}"
        maxlength="200"
        bind:change="onBatchRemarkChange"
      />
    </view>
  </view>
</t-dialog>
