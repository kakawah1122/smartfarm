<!--pages/test/test.wxml-->
<navigation-bar title="权限管理测试" bind:back="goBack"></navigation-bar>

<view class="container">
  <!-- 当前状态 -->
  <view class="status-card">
    <view class="status-header">
      <text class="status-title">当前状态</text>
      <text class="status-indicator {{isLoggedIn ? 'logged-in' : 'not-logged'}}">
        {{isLoggedIn ? '已登录' : '未登录'}}
      </text>
    </view>
    
    <view wx:if="{{isLoggedIn && currentUser}}" class="user-info">
      <view class="user-item">
        <text class="label">用户:</text>
        <text class="value">{{currentUser.nickname || '未设置'}}</text>
      </view>
      <view class="user-item">
        <text class="label">角色:</text>
        <text class="value role-{{currentUser.role}}">
          {{currentUser.role === 'admin' ? '管理员' : currentUser.role === 'employee' ? '员工' : '普通用户'}}
        </text>
      </view>
      <view class="user-item">
        <text class="label">权限:</text>
        <text class="value">{{currentUser.permissions ? currentUser.permissions.join(', ') : '无'}}</text>
      </view>
    </view>
    
    <view wx:else class="no-user">
      <text class="tip-text">请先登录以开始测试</text>
    </view>
  </view>

  <!-- 快速操作 -->
  <view class="quick-actions">
    <view class="section-title">快速操作</view>
    
    <view class="action-grid">
      <button class="action-btn primary" bindtap="quickLogin">
        <text class="btn-icon">🔑</text>
        <text class="btn-text">登录/注册</text>
      </button>
      
      <button class="action-btn secondary" bindtap="goToEmployee" disabled="{{!isLoggedIn}}">
        <text class="btn-icon">👥</text>
        <text class="btn-text">员工管理</text>
      </button>
      
      <button class="action-btn info" bindtap="viewTestData">
        <text class="btn-icon">📊</text>
        <text class="btn-text">查看数据</text>
      </button>
      
      <button class="action-btn danger" bindtap="manualClearData">
        <text class="btn-icon">🗑️</text>
        <text class="btn-text">清除数据</text>
      </button>
    </view>
    
    <!-- 快速操作第二行 -->
    <view class="action-grid" style="margin-top: 16rpx;">
      <button class="action-btn warning" bindtap="quickClearLocal">
        <text class="btn-icon">🔄</text>
        <text class="btn-text">重置登录</text>
      </button>
      
      <button class="action-btn success" bindtap="initDatabase" disabled="{{testing}}">
        <text class="btn-icon">🔧</text>
        <text class="btn-text">初始化DB</text>
      </button>
    </view>
  </view>

  <!-- 测试步骤 -->
  <view class="test-section">
    <view class="section-title">完整测试流程</view>
    
    <view class="test-steps">
      <view class="test-step" wx:for="{{testSteps}}" wx:key="id">
        <view class="step-number {{item.status}}">{{item.id}}</view>
        <view class="step-content">
          <view class="step-name">{{item.name}}</view>
          <view class="step-result {{item.status}}">{{item.result || '等待执行'}}</view>
        </view>
        <view class="step-status">
          <text wx:if="{{item.status === 'pending'}}" class="status-icon pending">⏳</text>
          <text wx:elif="{{item.status === 'running'}}" class="status-icon running">🔄</text>
          <text wx:elif="{{item.status === 'success'}}" class="status-icon success">✅</text>
          <text wx:else class="status-icon failed">❌</text>
        </view>
      </view>
    </view>
    
    <button class="full-test-btn" bindtap="startFullTest" disabled="{{testing}}">
      <text wx:if="{{testing}}">测试进行中...</text>
      <text wx:else>开始完整测试</text>
    </button>
  </view>

  <!-- 单项测试 -->
  <view class="individual-tests">
    <view class="section-title">单项功能测试</view>
    
    <view class="test-grid">
      <button class="test-item" bindtap="testCloudFunction" disabled="{{testing}}">
        <view class="test-icon">☁️</view>
        <view class="test-name">云函数测试</view>
        <view class="test-desc">测试employeeManage云函数</view>
      </button>
      
      <button class="test-item" bindtap="testAdminPermissions" disabled="{{!isLoggedIn || testing}}">
        <view class="test-icon">🔐</view>
        <view class="test-name">管理员权限</view>
        <view class="test-desc">测试管理员权限验证</view>
      </button>
      
      <button class="test-item" bindtap="testGenerateInvite" disabled="{{!isLoggedIn || testing}}">
        <view class="test-icon">📨</view>
        <view class="test-name">生成邀请码</view>
        <view class="test-desc">测试员工邀请功能（云函数）</view>
      </button>
      
      <button class="test-item" bindtap="generateSimpleInvite" disabled="{{!isLoggedIn || testing}}">
        <view class="test-icon">📧</view>
        <view class="test-name">简化邀请码</view>
        <view class="test-desc">生成本地邀请码（备用方案）</view>
      </button>
      
      <button class="test-item" bindtap="testEmployeeJoin" disabled="{{!testInviteCode}}">
        <view class="test-icon">🤝</view>
        <view class="test-name">员工加入</view>
        <view class="test-desc">测试通过邀请码加入</view>
      </button>
      
      <button class="test-item" bindtap="joinBySimpleInvite" disabled="{{testing}}">
        <view class="test-icon">🔗</view>
        <view class="test-name">快速加入</view>
        <view class="test-desc">使用邀请码加入组织</view>
      </button>
    </view>
  </view>

  <!-- 测试结果 -->
  <view wx:if="{{testInviteCode}}" class="test-result">
    <view class="section-title">测试邀请码</view>
    <view class="invite-code-display">
      <text class="invite-code">{{testInviteCode}}</text>
      <button class="copy-btn" data-code="{{testInviteCode}}" bindtap="copyInviteCode">复制</button>
    </view>
    <view class="result-tip">
      <text class="tip-icon">💡</text>
      <text class="tip-text">请使用另一个微信账号测试员工加入功能</text>
    </view>
  </view>

  <!-- 测试说明 -->
  <view class="test-guide">
    <view class="section-title">测试说明</view>
    
    <view class="guide-content">
      <view class="guide-item">
        <text class="guide-number">1</text>
        <text class="guide-text">点击"开始完整测试"清除现有数据</text>
      </view>
      <view class="guide-item">
        <text class="guide-number">2</text>
        <text class="guide-text">重新登录成为管理员（第一个用户）</text>
      </view>
      <view class="guide-item">
        <text class="guide-number">3</text>
        <text class="guide-text">测试生成邀请码功能</text>
      </view>
      <view class="guide-item">
        <text class="guide-number">4</text>
        <text class="guide-text">用另一个微信账号测试员工加入</text>
      </view>
      <view class="guide-item">
        <text class="guide-number">5</text>
        <text class="guide-text">验证权限分配和功能访问控制</text>
      </view>
    </view>
  </view>
</view>
