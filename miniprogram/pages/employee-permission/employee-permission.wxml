<!-- employee-permission.wxml - å‘˜å·¥æƒé™ä¸é‚€è¯·ç®¡ç†é¡µé¢ -->
<view class="page-container">
  <navigation-bar
    title="å‘˜å·¥ç®¡ç†ä¸­å¿ƒ"
    show-back="true"
    show-menu="false"
    show-record="false"
    bind:back="goBack"
  />

  <!-- ä¸»é€‰é¡¹å¡ -->
  <view class="main-tabs-section">
    <t-tabs value="{{activeMainTab}}" bind:change="onMainTabChange">
      <t-tab-panel label="æƒé™ç®¡ç†" value="permission" />
      <t-tab-panel label="é‚€è¯·ç®¡ç†" value="invite" />
    </t-tabs>
  </view>

  <!-- æƒé™ç®¡ç†å†…å®¹ -->
  <view wx:if="{{activeMainTab === 'permission'}}">
    <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-section">
    <t-search
      value="{{searchKeyword}}"
      placeholder="æœç´¢å‘˜å·¥å§“åæˆ–æ‰‹æœºå·"
      bind:change="onSearchChange"
      bind:submit="onSearch"
    />
    
    <t-tabs value="{{activeTab}}" bind:change="onTabChange" class="filter-tabs">
      <t-tab-panel label="å…¨éƒ¨" value="all" />
      <t-tab-panel label="ç®¡ç†å‘˜" value="admin" />
      <t-tab-panel label="ç»ç†" value="manager" />
      <t-tab-panel label="æ“ä½œå‘˜" value="operator" />
      <t-tab-panel label="ç”¨æˆ·" value="user" />
    </t-tabs>
  </view>

  <!-- å‘˜å·¥åˆ—è¡¨ -->
  <view class="content-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <t-loading theme="spinner" size="40rpx" text="åŠ è½½ä¸­..." />
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{employeeList.length === 0}}" class="empty-container">
      <t-empty icon="user" description="æš‚æ— å‘˜å·¥æ•°æ®" />
    </view>

    <!-- å‘˜å·¥å¡ç‰‡åˆ—è¡¨ -->
    <view wx:else class="employee-list">
      <view
        wx:for="{{employeeList}}"
        wx:key="_id"
        class="employee-card {{isEmployeeSelected(item._id) ? 'selected' : ''}}"
        bind:tap="onEmployeeClick"
        data-employee="{{item}}"
      >
        <view class="employee-header">
          <view class="employee-info">
            <view class="employee-basic">
              <text class="employee-name">{{item.nickname || 'æœªè®¾ç½®'}}</text>
              <text class="employee-details">{{item.farmName || 'æœªè®¾ç½®å†œåœº'}} Â· {{item.department || 'æœªè®¾ç½®éƒ¨é—¨'}}</text>
            </view>
            <view class="employee-role">
              <view class="role-tag" style="background-color: {{getRoleColor(item.role)}}15; border-color: {{getRoleColor(item.role)}}; color: {{getRoleColor(item.role)}}">
                {{item.roleDisplayName || 'æœªçŸ¥è§’è‰²'}}
              </view>
              <t-icon name="chevron-right" size="16" color="#c8c9cc" />
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{hasMore && employeeList.length > 0}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}
      </t-button>
    </view>
  </view>
  </view>

  <!-- é‚€è¯·ç®¡ç†å†…å®¹ -->
  <view wx:if="{{activeMainTab === 'invite'}}">
    <!-- æœç´¢æ  -->
    <view class="search-section">
      <t-search
        value="{{inviteSearchKeyword}}"
        placeholder="æœç´¢å§“åã€æ‰‹æœºå·æˆ–é‚€è¯·ç "
        bind:change="onInviteSearchChange"
        bind:submit="onInviteSearch"
        bind:clear="onInviteSearchClear"
      />
    </view>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-section">
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{inviteStats.total}}</text>
          <text class="stat-label">æ€»é‚€è¯·æ•°</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{inviteStats.pending}}</text>
          <text class="stat-label">å¾…ä½¿ç”¨</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{inviteStats.used}}</text>
          <text class="stat-label">å·²ä½¿ç”¨</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{inviteStats.usageRate}}%</text>
          <text class="stat-label">ä½¿ç”¨ç‡</text>
        </view>
      </view>
    </view>

    <!-- ç­›é€‰é€‰é¡¹å¡ -->
    <view class="filter-section">
      <view class="filter-tabs">
        <t-tabs value="{{inviteActiveTab}}" bind:change="onInviteTabChange">
          <t-tab-panel label="å…¨éƒ¨é‚€è¯·" value="all" />
          <t-tab-panel label="å¾…ä½¿ç”¨" value="pending" />
          <t-tab-panel label="å·²ä½¿ç”¨" value="used" />
          <t-tab-panel label="å·²è¿‡æœŸ" value="expired" />
        </t-tabs>
      </view>
    </view>

    <!-- é‚€è¯·åˆ—è¡¨å†…å®¹ -->
    <view class="content-container">
      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{inviteLoading}}" class="loading-container">
        <t-loading theme="spinner" size="40rpx" text="åŠ è½½ä¸­..." />
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{inviteList.length === 0}}" class="empty-container">
        <t-empty icon="user-add" description="æš‚æ— é‚€è¯·è®°å½•" />
      </view>

      <!-- é‚€è¯·åˆ—è¡¨ -->
      <view wx:else class="invite-list">
        <view
          wx:for="{{inviteList}}"
          wx:key="_id"
          class="invite-card"
          bind:tap="onInviteClick"
          data-invite="{{item}}"
        >
          <view class="invite-header">
            <view class="invite-info">
              <text class="invite-code">{{item.inviteCode || ''}}</text>
              <text class="invite-phone">{{item.inviteePhone || ''}}</text>
              <text class="invite-role">{{getInviteRoleText(item.role)}}</text>
            </view>
            <view class="invite-status">
              <view class="status-tag {{getInviteStatusTheme(item.status)}}-tag">
                {{item.statusText || 'æœªçŸ¥çŠ¶æ€'}}
              </view>
              <t-icon name="chevron-right" size="16" color="#c8c9cc" />
            </view>
          </view>
          <view wx:if="{{item.remark}}" class="invite-remark">
            <text class="remark-text">{{item.remark}}</text>
          </view>
        </view>
      </view>

      <!-- åˆ†é¡µåŠ è½½ -->
      <view wx:if="{{inviteHasMore}}" class="load-more">
        <view class="load-more-btn" bind:tap="loadMoreInvites">
          <t-loading wx:if="{{inviteLoadingMore}}" theme="spinner" size="32rpx" />
          <text class="load-more-text">{{inviteLoadingMore ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š'}}</text>
        </view>
      </view>
    </view>

    <!-- åˆ›å»ºé‚€è¯·æŒ‰é’® -->
    <view class="create-button-container">
      <view class="create-invite-btn" bind:tap="showCreateDialog">
        <text class="create-btn-icon">+</text>
        <text class="create-btn-text">åˆ›å»ºé‚€è¯·</text>
      </view>
    </view>
  </view>
</view>

<!-- æƒé™è¯¦æƒ…å¼¹çª— -->
<t-popup
  visible="{{showPermissionDetail}}"
  placement="bottom"
  close-on-overlay-click="{{true}}"
  show-overlay="{{true}}"
  z-index="{{12000}}"
  bind:visible-change="onPermissionDetailChange"
  t-class-content="permission-detail-popup"
>
  <view wx:if="{{selectedEmployee}}" class="permission-detail-container">
    <!-- å¼¹çª—å¤´éƒ¨ -->
    <view class="popup-header">
      <text class="popup-title">{{permissionDetailMode === 'edit' ? 'ä¿®æ”¹å‘˜å·¥è§’è‰²' : 'å‘˜å·¥æƒé™è¯¦æƒ…'}}</text>
      <view class="close-btn" bind:tap="closePermissionDetail">
        <text class="close-text">Ã—</text>
      </view>
    </view>

    <!-- å‘˜å·¥åŸºæœ¬ä¿¡æ¯ -->
    <view class="employee-profile-section">
      <view class="profile-info">
        <text class="profile-name">{{selectedEmployee.nickname || 'æœªè®¾ç½®'}}</text>
        <view class="profile-role-tag" style="background-color: {{getRoleColor(selectedEmployee.role)}}15; border-color: {{getRoleColor(selectedEmployee.role)}}; color: {{getRoleColor(selectedEmployee.role)}}">
          {{selectedEmployeeRoleDisplayName}}
        </view>
      </view>
    </view>

    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <view wx:if="{{permissionDetailMode === 'view'}}">
      <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
      <view class="info-card">
        <view class="card-header">
          <text class="card-title">åŸºæœ¬ä¿¡æ¯</text>
          <view class="edit-info-btn" bind:tap="toggleEditInfo">
            <text class="edit-info-text">{{editingInfo ? 'ä¿å­˜' : 'ç¼–è¾‘'}}</text>
          </view>
        </view>
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">å†œåœº</text>
            <input wx:if="{{editingInfo}}" 
              class="info-input" 
              value="{{tempEmployee.farmName}}"
              placeholder="è¯·è¾“å…¥å†œåœºåç§°"
              data-field="farmName"
              bind:input="onInfoInput"
            />
            <text wx:else class="info-value">{{selectedEmployee.farmName || 'æœªè®¾ç½®'}}</text>
          </view>
          <!-- éƒ¨é—¨å­—æ®µå·²ä¸å†œåœºåç§°å­—æ®µåˆå¹¶ï¼Œæ— éœ€å•ç‹¬æ˜¾ç¤º -->
          <view class="info-row">
            <text class="info-label">èŒä½</text>
            <input wx:if="{{editingInfo}}" 
              class="info-input" 
              value="{{tempEmployee.position}}"
              placeholder="è¯·è¾“å…¥èŒä½åç§°"
              data-field="position"
              bind:input="onInfoInput"
            />
            <text wx:else class="info-value">{{selectedEmployee.position || 'æœªè®¾ç½®'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ³¨å†Œæ—¶é—´</text>
            <text class="info-value">{{selectedEmployee.formattedRegisterTime || 'æœªçŸ¥'}}</text>
          </view>
        </view>
      </view>

      <!-- æƒé™è¯¦æƒ…å¡ç‰‡ -->
      <view class="info-card">
        <view class="card-header">
          <text class="card-title">æƒé™è¯¦æƒ…</text>
        </view>
        <view class="card-content">
          <view class="permission-role-info">
            <text class="role-label">å½“å‰è§’è‰²</text>
            <view class="role-badge" style="background-color: {{getRoleColor(selectedEmployee.role)}}; color: #ffffff;">
              {{selectedEmployeeRoleDisplayName}}
            </view>
          </view>
          <view class="permission-list">
            <text class="permission-list-title">æƒé™æ¸…å•</text>
            <view class="permission-items">
              <view 
                wx:for="{{selectedEmployeePermissions}}"
                wx:key="*this"
                class="permission-item"
              >
                <text class="permission-check">â€¢</text>
                <text class="permission-name">{{item}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æŸ¥çœ‹æ¨¡å¼æ“ä½œæŒ‰é’® -->
      <view class="popup-actions">
        <t-button theme="default" size="large" bind:tap="closePermissionDetail" class="secondary-button">
          å…³é—­
        </t-button>
        <t-button theme="primary" size="large" bind:tap="switchToEditMode" class="primary-button">
          ä¿®æ”¹æƒé™
        </t-button>
      </view>
    </view>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <view wx:if="{{permissionDetailMode === 'edit'}}">
      <!-- è§’è‰²é€‰æ‹©åŒºåŸŸ -->
      <view class="role-selection-section">
        <view class="section-header">
          <text class="section-title">é€‰æ‹©æ–°è§’è‰²</text>
        </view>
        
        <view class="role-options">
          <view 
            wx:for="{{roleOptions}}"
            wx:key="value"
            class="role-option {{selectedRoleIndex[0] === index ? 'selected' : ''}}"
            bind:tap="selectRole"
            data-index="{{index}}"
          >
            <view class="role-option-header">
              <view class="role-info">
                <text class="role-name">{{item.label}}</text>
                <text class="role-description">{{item.description}}</text>
              </view>
              <view class="role-check">
                <text wx:if="{{selectedRoleIndex[0] === index}}" class="check-mark">âœ“</text>
                <view wx:else class="unchecked-circle"></view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç¼–è¾‘æ¨¡å¼æ“ä½œæŒ‰é’® -->
      <view class="popup-actions">
        <t-button theme="default" size="large" bind:tap="switchToViewMode" class="secondary-button">
          å–æ¶ˆ
        </t-button>
        <t-button theme="primary" size="large" bind:tap="updateEmployeeRole" disabled="{{selectedRoleIndex[0] === getRoleIndex(selectedEmployee.role)}}" class="primary-button">
          ç¡®è®¤ä¿®æ”¹
        </t-button>
      </view>
    </view>
  </view>
</t-popup>

<!-- é‚€è¯·è¯¦æƒ…å¼¹çª— -->
<t-popup
  visible="{{showInviteDetail}}"
  placement="bottom"
  close-on-overlay-click="{{true}}"
  show-overlay="{{true}}"
  z-index="{{12000}}"
  bind:visible-change="onInviteDetailChange"
  t-class-content="invite-detail-popup"
>
  <view wx:if="{{selectedInvite}}" class="invite-detail-container">
    <!-- å¼¹çª—å¤´éƒ¨ -->
    <view class="popup-header">
      <text class="popup-title">é‚€è¯·è¯¦æƒ…</text>
      <view class="close-btn" bind:tap="closeInviteDetail">
        <text class="close-text">Ã—</text>
      </view>
    </view>

    <!-- é‚€è¯·è¯¦æƒ…å†…å®¹ -->
    <view class="invite-detail-content">
      <view class="detail-section">
        <view class="detail-item">
          <text class="detail-label">é‚€è¯·ç </text>
          <text class="detail-value">{{selectedInvite.inviteCode}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">è§’è‰²</text>
          <text class="detail-value">{{selectedInvite.roleDisplayName || getInviteRoleText(selectedInvite.role) || 'æœªçŸ¥è§’è‰²'}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">çŠ¶æ€</text>
          <view class="status-tag {{getInviteStatusTheme(selectedInvite.status)}}-tag">
            {{selectedInvite.statusText || 'æœªçŸ¥çŠ¶æ€'}}
          </view>
        </view>
        <view class="detail-item">
          <text class="detail-label">åˆ›å»ºæ—¶é—´</text>
          <text class="detail-value">{{selectedInvite.formattedCreateTime || formatInviteTime(selectedInvite.createTime) || 'æœªçŸ¥æ—¶é—´'}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">è¿‡æœŸæ—¶é—´</text>
          <text class="detail-value">{{selectedInvite.formattedExpiresAt || formatInviteTime(selectedInvite.expiresAt) || formatInviteTime(selectedInvite.expiryTime) || 'æœªçŸ¥æ—¶é—´'}}</text>
        </view>
        <view wx:if="{{selectedInvite.remark}}" class="detail-item">
          <text class="detail-label">å¤‡æ³¨</text>
          <text class="detail-value">{{selectedInvite.remark}}</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="popup-actions">
      <t-button
        wx:if="{{selectedInvite.status === 'pending'}}"
        theme="warning"
        size="large"
        bind:tap="revokeInvite"
        class="warning-button"
      >
        æ’¤é”€é‚€è¯·
      </t-button>
      <t-button
        wx:if="{{selectedInvite.status === 'pending'}}"
        theme="primary"
        size="large"
        bind:tap="resendInvite"
        class="primary-button"
      >
        é‡æ–°å‘é€
      </t-button>
      <t-button
        theme="default"
        size="large"
        bind:tap="copyInviteCodeFromDetail"
        class="secondary-button"
      >
        å¤åˆ¶é‚€è¯·ç 
      </t-button>
    </view>
  </view>
</t-popup>

<!-- åˆ›å»ºé‚€è¯·ç å¼¹çª— -->
<t-popup
  visible="{{showCreateDialog}}"
  placement="center"
  close-on-overlay-click="{{false}}"
  show-overlay="{{true}}"
  z-index="{{12200}}"
  bind:visible-change="onCreateDialogChange"
  t-class-content="create-dialog-popup"
>
  <view class="create-dialog-content">
    <view class="create-dialog-header">
      <text class="create-dialog-title">åˆ›å»ºé‚€è¯·ç </text>
      <text class="create-dialog-close" bind:tap="closeCreateDialog">Ã—</text>
    </view>
    
    <view class="create-dialog-body">
      <!-- è¡¨å•éƒ¨åˆ†ï¼ˆæœªç”Ÿæˆé‚€è¯·ç æ—¶æ˜¾ç¤ºï¼‰ -->
      <view wx:if="{{!isInviteGenerated}}">
        <view class="form-tip">
          <text class="tip-text">ğŸ’¡ ç”Ÿæˆé‚€è¯·ç åï¼Œè¢«é‚€è¯·äººå¯ä½¿ç”¨é‚€è¯·ç è‡ªè¡Œæ³¨å†Œå¹¶å¡«å†™ä¸ªäººä¿¡æ¯</text>
        </view>
        
        <view class="form-group">
          <text class="form-label">é»˜è®¤è§’è‰²</text>
          <picker 
            range="{{inviteRoleOptions}}" 
            range-key="label" 
            value="{{selectedInviteRoleIndex[0]}}" 
            bind:change="onInviteRoleChange"
          >
            <view class="picker-container">
              <text class="picker-text">{{inviteRoleOptions[selectedInviteRoleIndex[0]].label}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <view class="form-group">
          <text class="form-label">æœ‰æ•ˆæœŸ</text>
          <picker 
            range="{{inviteExpiryOptions}}" 
            range-key="label" 
            value="{{selectedInviteExpiryIndex[0]}}" 
            bind:change="onInviteExpiryDaysChange"
          >
            <view class="picker-container">
              <text class="picker-text">{{inviteExpiryOptions[selectedInviteExpiryIndex[0]].label}}</text>
              <text class="picker-arrow">â–¼</text>
            </view>
          </picker>
        </view>
        
        <view class="form-group">
          <text class="form-label">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</text>
          <textarea 
            class="form-textarea" 
            placeholder="å¯å¡«å†™æ­¤é‚€è¯·ç çš„ç”¨é€”è¯´æ˜" 
            value="{{newInvite.remark}}" 
            bind:input="onInviteRemarkInput"
            maxlength="100"
          />
        </view>
      </view>

      <!-- é‚€è¯·ç ç”ŸæˆæˆåŠŸæ˜¾ç¤ºéƒ¨åˆ† -->
      <view wx:if="{{isInviteGenerated}}" class="invite-success-content">
        <view class="success-tip">
          <text class="success-text">ğŸ‰ é‚€è¯·ç ç”ŸæˆæˆåŠŸï¼</text>
        </view>
        
        <view class="invite-code-section">
          <text class="invite-code-label">é‚€è¯·ç </text>
          <view class="invite-code-box" bind:tap="copyInviteCode">
            <text class="invite-code-value">{{generatedInviteCode}}</text>
            <text class="copy-hint">ç‚¹å‡»å¤åˆ¶</text>
          </view>
        </view>
        
        <view class="usage-instructions">
          <text class="instructions-title">ä½¿ç”¨è¯´æ˜</text>
          <text class="instruction-item">â€¢ ç”¨æˆ·ä½¿ç”¨æ­¤é‚€è¯·ç å¯è‡ªè¡Œæ³¨å†Œ</text>
          <text class="instruction-item">â€¢ æ³¨å†Œæ—¶å¯å¡«å†™ä¸ªäººä¿¡æ¯</text>
          <text class="instruction-item">â€¢ é‚€è¯·ç ä½¿ç”¨åå°†è‡ªåŠ¨å¤±æ•ˆ</text>
          <text class="instruction-item">â€¢ è¯·å¦¥å–„ä¿ç®¡é‚€è¯·ç ä¿¡æ¯</text>
        </view>
      </view>
    </view>
    
    <view class="create-dialog-footer">
      <view class="dialog-btn cancel-btn" bind:tap="closeCreateDialog">
        {{isInviteGenerated ? 'å…³é—­' : 'å–æ¶ˆ'}}
      </view>
      <view 
        wx:if="{{!isInviteGenerated}}" 
        class="dialog-btn confirm-btn" 
        bind:tap="createInvite"
      >
        ç”Ÿæˆé‚€è¯·ç 
      </view>
      <view 
        wx:if="{{isInviteGenerated}}" 
        class="dialog-btn copy-btn" 
        bind:tap="copyInviteCode"
      >
        ğŸ“‹ å¤åˆ¶é‚€è¯·ç 
      </view>
    </view>
  </view>
</t-popup>

<!-- æ’¤é”€ç¡®è®¤å¼¹çª—å·²ç§»é™¤ -->

