<!-- 用户管理页面 -->
<view class="page-container">
  <navigation-bar
    title="用户管理"
    show-back="{{true}}"
    show-menu="{{false}}"
    show-record="{{false}}"
    bind:back="goBack"
  />

  <!-- 搜索栏 -->
  <view class="search-section">
    <t-search
      value="{{searchKeyword}}"
      placeholder="搜索用户昵称或农场名"
      bind:change="onSearchChange"
      bind:submit="onSearch"
      bind:clear="onSearchClear"
    />
  </view>

  <!-- 统计卡片 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.totalUsers}}</text>
        <text class="stat-label">总用户数</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.activeUsers}}</text>
        <text class="stat-label">活跃用户</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.adminUsers}}</text>
        <text class="stat-label">管理员</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{stats.recentActiveUsers}}</text>
        <text class="stat-label">30天活跃</text>
      </view>
    </view>
  </view>

  <!-- 筛选选项卡 -->
  <view class="filter-section">
    <t-tabs value="{{activeTab}}" bind:change="onTabChange">
      <t-tab-panel label="全部用户" value="all" />
      <t-tab-panel label="管理员" value="admin" />
      <t-tab-panel label="普通用户" value="user" />
      <t-tab-panel label="已禁用" value="disabled" />
    </t-tabs>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <t-loading theme="spinner" size="40rpx" text="加载中..." />
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{userList.length === 0}}" class="empty-container">
    <t-empty icon="user" description="暂无用户数据" />
  </view>

  <!-- 用户列表 -->
  <view wx:else class="content-container">
    <t-cell-group class="user-list">
      <t-cell
        wx:for="{{userList}}"
        wx:key="_id"
        title="{{item.nickname || '未设置昵称'}}"
        note="{{item.farmName || '未设置农场'}}"
        description="{{item.phone || '未绑定手机'}}"
        image="{{item.avatarUrl}}"
        hover
        bind:click="onUserClick"
        data-user="{{item}}"
      >
        <view slot="right-icon" class="user-actions">
          <t-tag
            theme="{{getUserRoleTheme(item.role)}}"
            size="small"
            class="role-tag"
          >
            {{getUserRoleText(item.role)}}
          </t-tag>
          <t-tag
            theme="{{getUserStatusTheme(item.status)}}"
            size="small"
            class="status-tag"
          >
            {{getUserStatusText(item.status)}}
          </t-tag>
        </view>
      </t-cell>
    </t-cell-group>

    <!-- 分页加载 -->
    <view wx:if="{{hasMore}}" class="load-more">
      <t-button
        theme="default"
        size="large"
        block
        loading="{{loadingMore}}"
        bind:tap="loadMore"
      >
        {{loadingMore ? '加载中...' : '加载更多'}}
      </t-button>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-section">
    <t-button
      theme="primary"
      size="large"
      block
      bind:tap="exportUsers"
      class="export-btn"
    >
      导出用户数据
    </t-button>
  </view>
</view>

<!-- 用户详情弹窗 -->
<t-dialog
  visible="{{showUserDetail}}"
  title="用户详情"
  confirm-btn="确定"
  bind:confirm="closeUserDetail"
  bind:cancel="closeUserDetail"
>
  <view wx:if="{{selectedUser}}" class="user-detail">
    <view class="detail-section">
      <view class="detail-item">
        <text class="detail-label">昵称：</text>
        <text class="detail-value">{{selectedUser.nickname || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">农场：</text>
        <text class="detail-value">{{selectedUser.farmName || '未设置'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">手机：</text>
        <text class="detail-value">{{selectedUser.phone || '未绑定'}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">角色：</text>
        <text class="detail-value">{{getUserRoleText(selectedUser.role)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">状态：</text>
        <text class="detail-value">{{getUserStatusText(selectedUser.status)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">注册时间：</text>
        <text class="detail-value">{{formatTime(selectedUser.createTime)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">最后登录：</text>
        <text class="detail-value">{{formatTime(selectedUser.lastLoginTime)}}</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">登录次数：</text>
        <text class="detail-value">{{selectedUser.loginCount || 0}}次</text>
      </view>
    </view>

    <!-- 业务统计 -->
    <view wx:if="{{selectedUser.stats}}" class="stats-section">
      <view class="section-title">业务统计</view>
      <view class="business-stats">
        <view class="stat-item">
          <text class="stat-number">{{selectedUser.stats.healthRecords}}</text>
          <text class="stat-label">健康记录</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{selectedUser.stats.entryRecords}}</text>
          <text class="stat-label">入栏记录</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{selectedUser.stats.exitRecords}}</text>
          <text class="stat-label">出栏记录</text>
        </view>
      </view>
    </view>

    <!-- 管理操作 -->
    <view class="management-actions">
      <t-button
        theme="primary"
        size="medium"
        bind:tap="showRoleDialog"
        class="action-btn"
      >
        修改角色
      </t-button>
      <t-button
        theme="{{selectedUser.status === 'active' ? 'danger' : 'success'}}"
        size="medium"
        bind:tap="toggleUserStatus"
        class="action-btn"
      >
        {{selectedUser.status === 'active' ? '禁用用户' : '启用用户'}}
      </t-button>
    </view>
  </view>
</t-dialog>

<!-- 角色修改弹窗 -->
<t-dialog
  visible="{{showRoleDialog}}"
  title="修改用户角色"
  confirm-btn="确定"
  cancel-btn="取消"
  bind:confirm="updateUserRole"
  bind:cancel="closeRoleDialog"
>
  <view class="role-dialog">
    <view class="form-item">
      <text class="form-label">选择角色：</text>
      <t-picker
        value="{{newRole}}"
        options="{{roleOptions}}"
        bind:change="onRoleChange"
      />
    </view>
    <view class="form-item">
      <text class="form-label">修改原因：</text>
      <t-input
        value="{{roleChangeReason}}"
        placeholder="请输入修改原因"
        bind:change="onReasonChange"
      />
    </view>
  </view>
</t-dialog>
