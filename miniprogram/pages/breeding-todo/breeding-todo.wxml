<!-- breeding-todo.wxml - å…»æ®–å¾…åŠäº‹é¡¹é¡µé¢ -->
<view class="page page-container mobile-container">
  <!-- ç°ä»£åŒ–å¯¼èˆªæ  -->
  <navigation-bar 
    title="å…»æ®–å¾…åŠäº‹é¡¹"
    show-back="{{true}}"
    bind:go-back="onGoBack"
  />

  <scroll-view class="scroll-container" scroll-y>
    <!-- ä»»åŠ¡æ¦‚è§ˆå¡ç‰‡ -->
    <view class="card task-overview-card">
      <view class="card-content">
        <view class="card-header">
          <text class="card-title">å…¨åœºä»»åŠ¡æ¦‚è§ˆ</text>
          <view class="header-actions">
            <text class="batch-count-badge">{{activeBatchCount}}ä¸ªæ‰¹æ¬¡</text>
            <!-- ä¸´æ—¶æ•°æ®ä¿®å¤æŒ‰é’® -->
            <t-button theme="primary" variant="outline" size="extra-small" bind:tap="migrateTaskData" style="margin-left: 20rpx;">
              ğŸ”§ ä¿®å¤
            </t-button>
          </view>
        </view>
        
        <view class="overview-stats">
          <view class="stat-item primary-stat">
            <view class="stat-content">
              <text class="stat-number primary-text">{{allTasksCount}}</text>
              <text class="stat-label">æ€»ä»»åŠ¡</text>
            </view>
          </view>
          <view class="stat-item success-stat">
            <view class="stat-content">
              <text class="stat-number success-text">{{allCompletedCount}}</text>
              <text class="stat-label">å·²å®Œæˆ</text>
            </view>
          </view>
          <view class="stat-item progress-stat">
            <view class="stat-content">
              <text class="stat-number info-text">{{allCompletionPercentage}}%</text>
              <text class="stat-label">å®Œæˆç‡</text>
            </view>
          </view>
        </view>
        
        <view class="progress-bar">
          <view class="progress-track">
            <view class="progress-fill" style="width: {{allCompletionPercentage}}%"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- Tabåˆ‡æ¢å¡ç‰‡ -->
    <view class="card tabs-card">
      <t-tabs value="{{activeTab}}" bind:change="onTabChange" class="modern-tabs">
        <t-tab-panel label="è¿›è¡Œä¸­({{allTasksCount}})" value="today">
          <!-- ä»»åŠ¡é‡å æé†’ -->
          <view wx:if="{{taskOverlaps.length > 0}}" class="overlap-alerts">
            <view class="alert-header">
              <text class="alert-title">ä»»åŠ¡æé†’</text>
            </view>
            <view wx:for="{{taskOverlaps}}" wx:key="taskId" class="overlap-item">
              <text>{{item.message}}</text>
            </view>
          </view>

          <!-- æŒ‰æ‰¹æ¬¡åˆ†ç»„çš„ä»»åŠ¡åˆ—è¡¨ -->
          <view wx:if="{{todayTasksByBatch.length > 0}}" class="batch-task-groups">
            <view wx:for="{{todayTasksByBatch}}" wx:key="batchId" class="batch-group">
              <!-- æ‰¹æ¬¡ç»„å¤´éƒ¨ -->
              <view class="batch-group-header">
                <view class="batch-group-info">
                  <text class="batch-group-title">{{item.batchNumber}}</text>
                  <text class="batch-group-age">ç¬¬{{item.dayAge}}æ—¥é¾„</text>
                </view>
                <view class="batch-task-count">{{item.tasks.length}}ä¸ªä»»åŠ¡</view>
              </view>
              
              <!-- è¯¥æ‰¹æ¬¡çš„ä»»åŠ¡åˆ—è¡¨ -->
              <view class="batch-task-list">
                <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card priority-{{task.priority}} {{task.completed ? 'completed' : ''}}">
                  <!-- ä»»åŠ¡ä¸»ä½“ -->
                  <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                    <view class="task-content">
                      <view class="task-header-info">
                        <text class="task-title {{task.completed ? 'completed' : ''}}" data-completed="{{task.completed}}" data-task-id="{{task._id}}">{{task.title}}</text>
                        <view class="task-badges">
                          <view class="priority-badge priority-{{task.priority}}">
                            <text class="priority-text">{{getPriorityName(task.priority)}}</text>
                          </view>
                          <view class="type-badge type-{{task.type}}">
                            <text class="type-text">{{getTypeName(task.type)}}</text>
                          </view>
                        </view>
                      </view>
                      
                      <view class="task-description">{{task.description}}</view>
                      
                      <view class="task-meta-info">
                        <view wx:if="{{task.estimatedTime}}" class="meta-item">
                          <text class="meta-text">é¢„è®¡ç”¨æ—¶ï¼š{{task.estimatedTime}}åˆ†é’Ÿ</text>
                        </view>
                        <view wx:if="{{task.duration}}" class="meta-item">
                          <text class="meta-text">è¿ç»­ç¬¬{{task.dayInSeries}}/{{task.duration}}å¤©</text>
                        </view>
                        <view wx:if="{{task.dosage}}" class="meta-item">
                          <text class="meta-text">ç”¨é‡ï¼š{{task.dosage}}</text>
                        </view>
                      </view>
                    </view>
                  </view>

                </view>
              </view>
            </view>
          </view>

          <!-- æ— ä»»åŠ¡çŠ¶æ€ -->
          <view wx:else class="modern-empty-state">
            <view class="empty-content">
              <text class="empty-title">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡</text>
            </view>
          </view>
        </t-tab-panel>

        <t-tab-panel label="å³å°†åˆ°æ¥" value="upcoming">
          <!-- å³å°†åˆ°æ¥çš„ä»»åŠ¡ -->
          <view wx:if="{{upcomingTasks.length > 0}}" class="upcoming-tasks">
            <view wx:for="{{upcomingTasks}}" wx:key="dayAge" class="upcoming-day-group">
              <!-- æ—¥æœŸæ ‡é¢˜ -->
              <view class="upcoming-day-header">
                <view class="day-info">
                  <text class="day-title">ç¬¬{{item.dayAge}}æ—¥é¾„</text>
                  <text class="day-date">{{calculateDate(item.dayAge)}}</text>
                </view>
                <view class="task-count-badge">
                  <text class="count-number">{{item.tasks.length}}</text>
                  <text class="count-label">ä¸ªä»»åŠ¡</text>
                </view>
              </view>

              <!-- è¯¥æ—¥ä»»åŠ¡åˆ—è¡¨ -->
              <view class="upcoming-task-list">
                <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="id" class="upcoming-task-item priority-{{task.priority}}" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <view class="upcoming-task-left">
                    <view class="task-priority-dot priority-{{task.priority}}"></view>
                    <view class="task-info">
                      <text class="task-title">{{task.title}}</text>
                      <text class="task-batch-info">{{task.batchNumber}}</text>
                      <view class="task-badges">
                        <view class="type-badge type-{{task.type}}">
                          <text>{{getTypeName(task.type)}}</text>
                        </view>
                        <view class="priority-badge priority-{{task.priority}}">
                          <text>{{getPriorityName(task.priority)}}</text>
                        </view>
                      </view>
                    </view>
                  </view>
                  <view class="upcoming-task-right">
                    <t-icon name="time" size="28rpx" color="var(--color-text-tertiary)" />
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- æ— å³å°†åˆ°æ¥çš„ä»»åŠ¡ -->
          <view wx:else class="modern-empty-state">
            <view class="empty-content">
              <text class="empty-title">æš‚æ— å³å°†åˆ°æ¥çš„ä»»åŠ¡</text>
            </view>
          </view>
        </t-tab-panel>

        <t-tab-panel label="å·²å®Œæˆ" value="history">
          <!-- å†å²ä»»åŠ¡è®°å½• -->
          <view wx:if="{{historyTasks.length > 0}}" class="history-tasks">
            <view wx:for="{{historyTasks}}" wx:key="id" class="history-task-item" bind:tap="viewTaskDetail" data-task="{{item}}">
              <view class="history-task-main">
                <view class="history-task-left">
                  <view class="completion-icon">
                    <t-icon name="check-circle-filled" size="32rpx" color="var(--color-success)" />
                  </view>
                  <view class="history-task-info">
                    <text class="history-task-title">{{item.title}}</text>
                    <view class="history-task-meta">
                      <text class="completion-time">{{item.completedDate}}</text>
                      <text class="day-age-info">ç¬¬{{item.dayAge}}æ—¥é¾„</text>
                      <text class="batch-info">{{item.batchNumber}}</text>
                    </view>
                  </view>
                </view>
                <view class="completed-badge">
                  <text class="completed-text">å·²å®Œæˆ</text>
                </view>
              </view>
            </view>
          </view>

          <view wx:else class="modern-empty-state">
            <view class="empty-content">
              <text class="empty-title">æš‚æ— å·²å®Œæˆçš„ä»»åŠ¡</text>
            </view>
          </view>
        </t-tab-panel>
      </t-tabs>
    </view>


    <!-- æ‰¹æ¬¡é€‰æ‹©å¼¹çª— -->
    <t-overlay visible="{{showBatchDialog}}" bind:click="hideBatchPicker" class="modern-overlay">
      <view class="modern-batch-dialog" catchtap="">
        <view class="dialog-header">
          <text class="dialog-title">é€‰æ‹©æ‰¹æ¬¡</text>
          <view class="close-btn" bind:tap="hideBatchPicker">
            <t-icon name="close" size="32rpx" color="var(--color-text-secondary)" />
          </view>
        </view>
        
        <view class="batch-list">
          <view 
            wx:for="{{batchList}}" 
            wx:key="id" 
            class="modern-batch-item {{selectedBatch.id === item.id ? 'selected' : ''}}"
            bind:tap="selectBatch"
            data-batch="{{item}}"
          >
            <view class="batch-item-content">
              <view class="batch-main-info">
                <text class="batch-number">{{item.batchNumber}}</text>
                <text class="batch-entry-date">å…¥æ ï¼š{{item.entryDate}}</text>
              </view>
              <view class="batch-status-info">
                <view class="status-item">
                  <text class="status-value primary-text">{{calculateCurrentAge(item.entryDate)}}</text>
                  <text class="status-label">æ—¥é¾„</text>
                </view>
                <view class="status-item">
                  <text class="status-value">{{item.currentCount}}</text>
                  <text class="status-label">åª</text>
                </view>
              </view>
            </view>
            <view wx:if="{{selectedBatch.id === item.id}}" class="selected-indicator">
              <t-icon name="check" size="24rpx" color="var(--primary-blue)" />
            </view>
          </view>
        </view>
      </view>
    </t-overlay>


  <!-- ä»»åŠ¡è¯¦æƒ…å¼¹çª— -->
  <bottom-popup
    visible="{{showTaskDetailPopup}}"
    title="ä»»åŠ¡è¯¦æƒ…"
    show-close="{{true}}"
    show-actions="{{!selectedTask.completed && selectedTask.canComplete}}"
    confirm-text="{{selectedTask && selectedTask.isVaccineTask ? 'å¡«å†™æ¥ç§ä¿¡æ¯' : 'å®Œæˆä»»åŠ¡'}}"
    cancel-text="å…³é—­"
    bind:close="closeTaskDetailPopup"
    bind:confirm="{{selectedTask && selectedTask.isVaccineTask ? 'openVaccineForm' : 'completeTaskFromPopup'}}"
    bind:cancel="closeTaskDetailPopup"
    bind:visiblechange="onTaskDetailPopupChange"
  >
    <view wx:if="{{selectedTask}}" class="record-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">ä»»åŠ¡åç§°ï¼š</text>
            <text class="info-value">{{selectedTask.title || 'æœªå‘½åä»»åŠ¡'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ä»»åŠ¡ç±»å‹ï¼š</text>
            <text class="info-value">{{selectedTask.typeName || 'æœªåˆ†ç±»'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ä¼˜å…ˆçº§ï¼š</text>
            <view class="status-value">
              <t-tag 
                theme="{{selectedTask.priorityTheme || 'primary'}}" 
                size="small"
              >
                {{selectedTask.priorityName || 'æ™®é€š'}}
              </t-tag>
            </view>
          </view>
          <view class="info-row" wx:if="{{selectedTask.estimatedTime}}">
            <text class="info-label">é¢„è®¡ç”¨æ—¶ï¼š</text>
            <text class="info-value">{{selectedTask.estimatedTime}}åˆ†é’Ÿ</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.duration && selectedTask.dayInSeries}}">
            <text class="info-label">è¿ç»­ä»»åŠ¡ï¼š</text>
            <text class="info-value">ç¬¬{{selectedTask.dayInSeries}}/{{selectedTask.duration}}å¤©</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dosage}}">
            <text class="info-label">ç”¨é‡ï¼š</text>
            <text class="info-value">{{selectedTask.dosage}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.materials && selectedTask.materials.length > 0}}">
            <text class="info-label">æ‰€éœ€ç‰©æ–™ï¼š</text>
            <text class="info-value materials-text">{{selectedTask.materials.join('ã€')}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.batchNumber}}">
            <text class="info-label">æ‰¹æ¬¡ç¼–å·ï¼š</text>
            <text class="info-value">{{selectedTask.batchNumber}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dayAge}}">
            <text class="info-label">æ—¥é¾„ï¼š</text>
            <text class="info-value">ç¬¬{{selectedTask.dayAge}}æ—¥é¾„</text>
          </view>
          <view class="info-row">
            <text class="info-label">å®ŒæˆçŠ¶æ€ï¼š</text>
            <view class="status-value">
              <t-tag theme="{{selectedTask.completed ? 'success' : 'primary'}}" size="small">
                {{selectedTask.statusText || 'å¾…å®Œæˆ'}}
              </t-tag>
            </view>
          </view>
          <!-- ğŸ”¥ æ—¶é—´çŠ¶æ€æç¤º -->
          <view class="info-row" wx:if="{{selectedTask.dayAge && !selectedTask.canComplete}}">
            <text class="info-label">æ—¶é—´çŠ¶æ€ï¼š</text>
            <view class="status-value">
              <t-tag theme="warning" size="small">
                æ—¶é—´æœªåˆ°ï¼Œç¬¬{{selectedTask.dayAge}}æ—¥é¾„æ‰§è¡Œ
              </t-tag>
            </view>
          </view>
          <view class="info-row" wx:if="{{selectedTask.completedDate}}">
            <text class="info-label">å®Œæˆæ—¶é—´ï¼š</text>
            <text class="info-value">{{selectedTask.completedDate}}</text>
          </view>
          <view class="info-row info-row-description" wx:if="{{selectedTask.description}}">
            <text class="info-label">ä»»åŠ¡æè¿°ï¼š</text>
            <text class="info-value note-text">{{selectedTask.description}}</text>
          </view>
          <view class="info-row info-row-notes" wx:if="{{selectedTask.notes}}">
            <text class="info-label">æ³¨æ„äº‹é¡¹ï¼š</text>
            <text class="info-value note-text important-text">{{selectedTask.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- ç–«è‹—æ¥ç§è¡¨å•å¼¹çª— -->
  <bottom-popup
    visible="{{showVaccineFormPopup}}"
    title="ç–«è‹—æ¥ç§ä¿¡æ¯"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="å®Œæˆæ¥ç§"
    cancel-text="å–æ¶ˆ"
    bind:close="closeVaccineFormPopup"
    bind:confirm="submitVaccineForm"
    bind:cancel="closeVaccineFormPopup"
  >
    <view class="vaccine-form-content">
      <!-- å…½åŒ»ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">å…½åŒ»ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">æ‰§è¡Œå…½åŒ»</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥å…½åŒ»å§“å"
                 value=""
                 data-field="veterinarianName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">è”ç³»ç”µè¯</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
                 value=""
                 data-field="veterinarianPhone"
                 bindinput="onVaccineFormInput" />
        </view>
      </view>

      <!-- ç–«è‹—ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">ç–«è‹—ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ç–«è‹—åç§°</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç–«è‹—åç§°"
                 value=""
                 data-field="vaccineName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">ç”Ÿäº§å‚å®¶</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç”Ÿäº§å‚å®¶"
                 value=""
                 data-field="manufacturer"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ‰¹æ¬¡å·</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥ç–«è‹—æ‰¹æ¬¡å·"
                 value=""
                 data-field="batchNumber"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">æ¥ç§å‰‚é‡</text>
          <input class="form-input" 
                 placeholder="è¯·è¾“å…¥æ¥ç§å‰‚é‡"
                 value=""
                 data-field="dosage"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">æ¥ç§æ•°é‡</text>
          <input class="form-input" 
                 type="number"
                 placeholder="è¯·è¾“å…¥æ¥ç§æ•°é‡"
                 value=""
                 data-field="vaccineCount"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ¥ç§æ–¹å¼</text>
          <picker mode="selector" 
                  range="{{vaccineRouteOptions}}"
                  range-key="label"
                  value="0"
                  bindchange="onVaccineRouteChange">
            <view class="form-input picker-input">
              {{vaccineRouteOptions[vaccineFormData.routeIndex].label}}
            </view>
          </picker>
        </view>
      </view>

      <!-- è´¹ç”¨ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">è´¹ç”¨ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label required">ç–«è‹—è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥ç–«è‹—è´¹ç”¨"
                 value=""
                 data-field="vaccineCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">å…½åŒ»è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥å…½åŒ»è´¹ç”¨"
                 value=""
                 data-field="veterinaryCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">å…¶ä»–è´¹ç”¨</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="è¯·è¾“å…¥å…¶ä»–è´¹ç”¨"
                 value=""
                 data-field="otherCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">æ€»è´¹ç”¨</text>
          <view class="form-input readonly-input">{{vaccineFormData.totalCostFormatted}}</view>
        </view>
      </view>

      <!-- å¤‡æ³¨å’Œå¼‚å¸¸è®°å½• -->
      <view class="form-section">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥æ¥ç§å¤‡æ³¨ä¿¡æ¯"
                    value=""
                    data-field="notes"
                    bindinput="onVaccineFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- è¡¨å•éªŒè¯é”™è¯¯æç¤º -->
      <view wx:if="{{vaccineFormErrors && Object.keys(vaccineFormErrors).length > 0}}" class="form-errors">
        <view wx:for="{{Object.keys(vaccineFormErrors)}}" wx:key="*this" class="error-item">
          <text class="error-text">{{vaccineFormErrors[item]}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- å¼‚å¸¸ååº”å¤„ç†å¼¹çª— -->
  <bottom-popup
    visible="{{showAdverseReactionPopup}}"
    title="å¼‚å¸¸ååº”å¤„ç†"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="è®°å½•å¼‚å¸¸"
    cancel-text="å–æ¶ˆ"
    bind:close="closeAdverseReactionPopup"
    bind:confirm="submitAdverseReactionRecord"
    bind:cancel="closeAdverseReactionPopup"
  >
    <view class="adverse-reaction-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">å¼‚å¸¸æ•°é‡ï¼š</text>
            <text class="info-value">{{adverseReactionData.count}}åª</text>
          </view>
          <view class="info-row">
            <text class="info-label">å¼‚å¸¸ç—‡çŠ¶ï¼š</text>
            <text class="info-value">{{adverseReactionData.symptoms}}</text>
          </view>
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">è¡¥å……ä¿¡æ¯</view>
        <view class="form-row">
          <text class="form-label">ç—‡çŠ¶ç­‰çº§</text>
          <picker mode="selector" 
                  range="{{severityOptions}}"
                  range-key="label"
                  value="{{adverseReactionData.severityIndex}}"
                  bindchange="onSeverityChange">
            <view class="form-input picker-input">
              {{severityOptions[adverseReactionData.severityIndex].label}}
            </view>
          </picker>
        </view>
        <view class="form-row">
          <text class="form-label">å¤„ç†æªæ–½</text>
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥å·²é‡‡å–çš„å¤„ç†æªæ–½"
                    value="{{adverseReactionData.treatment}}"
                    data-field="treatment"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
        <view class="form-row">
          <text class="form-label">åç»­è§‚å¯Ÿ</text>
          <textarea class="form-textarea" 
                    placeholder="è¯·è¾“å…¥åç»­è§‚å¯Ÿè¦ç‚¹"
                    value="{{adverseReactionData.followUp}}"
                    data-field="followUp"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="modern-loading">
    <view class="loading-content">
      <t-loading theme="spinner" size="60rpx" />
      <text class="loading-text">æ­£åœ¨åŠ è½½...</text>
    </view>
  </view>
  </scroll-view>
</view>