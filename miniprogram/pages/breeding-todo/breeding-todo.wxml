<!-- breeding-todo.wxml - 养殖待办事项页面 -->
<view class="page page-container mobile-container">
  <!-- 现代化导航栏 -->
  <navigation-bar 
    title="养殖待办事项"
    show-back="{{true}}"
    bind:go-back="onGoBack"
  />

  <scroll-view class="scroll-container" scroll-y>
    <!-- 任务概览卡片 -->
    <view class="card task-overview-card">
      <view class="card-content">
        <view class="card-header">
          <text class="card-title">全场任务概览</text>
          <view class="header-actions">
            <text class="batch-count-badge">{{activeBatchCount}}个批次</text>
          </view>
        </view>
        
        <view class="overview-stats">
          <view class="stat-item primary-stat">
            <view class="stat-content">
              <text class="stat-number primary-text">{{allTasksCount}}</text>
              <text class="stat-label">总任务</text>
            </view>
          </view>
          <view class="stat-item success-stat">
            <view class="stat-content">
              <text class="stat-number success-text">{{allCompletedCount}}</text>
              <text class="stat-label">已完成</text>
            </view>
          </view>
          <view class="stat-item progress-stat">
            <view class="stat-content">
              <text class="stat-number info-text">{{allCompletionPercentage}}%</text>
              <text class="stat-label">完成率</text>
            </view>
          </view>
        </view>
        
        <view class="progress-bar">
          <view class="progress-track">
            <view class="progress-fill" style="width: {{allCompletionPercentage}}%"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- Tab切换卡片 -->
    <view class="card tabs-card">
      <t-tabs value="{{activeTab}}" bind:change="onTabChange" class="modern-tabs">
        <t-tab-panel label="进行中({{allTasksCount}})" value="today">
          <!-- 任务重叠提醒 -->
          <view wx:if="{{taskOverlaps.length > 0}}" class="overlap-alerts">
            <view class="alert-header">
              <text class="alert-title">任务提醒</text>
            </view>
            <view wx:for="{{taskOverlaps}}" wx:key="taskId" class="overlap-item">
              <text>{{item.message}}</text>
            </view>
          </view>

          <!-- 按批次分组的任务列表 -->
          <view wx:if="{{todayTasksByBatch.length > 0}}" class="batch-task-groups">
            <view wx:for="{{todayTasksByBatch}}" wx:key="batchId" class="batch-group">
              <!-- 批次组头部 -->
              <view class="batch-group-header">
                <view class="batch-group-info">
                  <text class="batch-group-title">{{item.batchNumber}}</text>
                  <text class="batch-group-age">第{{item.dayAge}}日龄</text>
                </view>
                <view class="batch-task-count">{{item.tasks.length}}个任务</view>
              </view>
              
              <!-- 该批次的任务列表 -->
              <view class="batch-task-list">
                <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="_id" class="modern-task-card {{task.completed ? 'completed' : ''}}">
                  <!-- 任务主体 -->
                  <view class="task-main" bind:tap="viewTaskDetail" data-task="{{task}}">
                    <view class="task-content">
                      <view class="task-header-info">
                        <text class="task-title {{task.completed ? 'completed' : ''}}" data-completed="{{task.completed}}" data-task-id="{{task._id}}">{{task.title}}</text>
                        <view class="task-badges">
                          <view class="type-badge type-{{task.type}}">
                            <text class="type-text">{{getTypeName(task.type)}}</text>
                          </view>
                        </view>
                      </view>
                      
                      <view class="task-description">{{task.description}}</view>
                      
                      <view class="task-meta-info">
                        <view wx:if="{{task.estimatedTime}}" class="meta-item">
                          <text class="meta-text">预计用时：{{task.estimatedTime}}分钟</text>
                        </view>
                        <view wx:if="{{task.duration}}" class="meta-item">
                          <text class="meta-text">连续第{{task.dayInSeries}}/{{task.duration}}天</text>
                        </view>
                        <view wx:if="{{task.dosage}}" class="meta-item">
                          <text class="meta-text">用量：{{task.dosage}}</text>
                        </view>
                      </view>
                    </view>
                  </view>

                </view>
              </view>
            </view>
          </view>

          <!-- 无任务状态 -->
          <view wx:else class="modern-empty-state">
            <view class="empty-content">
              <text class="empty-title">暂无进行中的任务</text>
            </view>
          </view>
        </t-tab-panel>

        <t-tab-panel label="即将到来" value="upcoming">
          <!-- 即将到来的任务 -->
          <view wx:if="{{upcomingTasks.length > 0}}" class="upcoming-tasks">
            <view wx:for="{{upcomingTasks}}" wx:key="dayAge" class="upcoming-day-group">
              <!-- 日期标题 -->
              <view class="upcoming-day-header">
                <view class="day-info">
                  <text class="day-title">第{{item.dayAge}}日龄</text>
                  <text class="day-date">{{calculateDate(item.dayAge)}}</text>
                </view>
                <view class="task-count-badge">
                  <text class="count-number">{{item.tasks.length}}</text>
                  <text class="count-label">个任务</text>
                </view>
              </view>

              <!-- 该日任务列表 -->
              <view class="upcoming-task-list">
                <view wx:for="{{item.tasks}}" wx:for-item="task" wx:key="id" class="upcoming-task-item" bind:tap="viewTaskDetail" data-task="{{task}}">
                  <view class="upcoming-task-left">
                    <view class="task-info">
                      <text class="task-title">{{task.title}}</text>
                      <text class="task-batch-info">{{task.batchNumber}}</text>
                      <view class="task-badges">
                        <view class="type-badge type-{{task.type}}">
                          <text>{{getTypeName(task.type)}}</text>
                        </view>
                      </view>
                    </view>
                  </view>
                  <view class="upcoming-task-right">
                    <t-icon name="time" size="28rpx" color="var(--color-text-tertiary)" />
                  </view>
                </view>
              </view>
            </view>
          </view>

          <!-- 无即将到来的任务 -->
          <view wx:else class="modern-empty-state">
            <view class="empty-content">
              <text class="empty-title">暂无即将到来的任务</text>
            </view>
          </view>
        </t-tab-panel>

        <t-tab-panel label="已完成" value="history">
          <!-- 历史任务记录 -->
          <view wx:if="{{historyTasks.length > 0}}" class="history-tasks">
            <view wx:for="{{historyTasks}}" wx:key="id" class="history-task-item" bind:tap="viewTaskDetail" data-task="{{item}}">
              <view class="history-task-main">
                <view class="history-task-left">
                  <view class="completion-icon">
                    <t-icon name="check-circle-filled" size="32rpx" color="var(--color-success)" />
                  </view>
                  <view class="history-task-info">
                    <text class="history-task-title">{{item.title}}</text>
                    <view class="history-task-meta">
                      <text class="completion-time">{{item.completedDate}}</text>
                      <text class="day-age-info">第{{item.dayAge}}日龄</text>
                      <text class="batch-info">{{item.batchNumber}}</text>
                    </view>
                  </view>
                </view>
                <view class="completed-badge">
                  <text class="completed-text">已完成</text>
                </view>
              </view>
            </view>
          </view>

          <view wx:else class="modern-empty-state">
            <view class="empty-content">
              <text class="empty-title">暂无已完成的任务</text>
            </view>
          </view>
        </t-tab-panel>
      </t-tabs>
    </view>


    <!-- 批次选择弹窗 -->
    <t-overlay visible="{{showBatchDialog}}" bind:click="hideBatchPicker" class="modern-overlay">
      <view class="modern-batch-dialog" catchtap="">
        <view class="dialog-header">
          <text class="dialog-title">选择批次</text>
          <view class="close-btn" bind:tap="hideBatchPicker">
            <t-icon name="close" size="32rpx" color="var(--color-text-secondary)" />
          </view>
        </view>
        
        <view class="batch-list">
          <view 
            wx:for="{{batchList}}" 
            wx:key="id" 
            class="modern-batch-item {{selectedBatch.id === item.id ? 'selected' : ''}}"
            bind:tap="selectBatch"
            data-batch="{{item}}"
          >
            <view class="batch-item-content">
              <view class="batch-main-info">
                <text class="batch-number">{{item.batchNumber}}</text>
                <text class="batch-entry-date">入栏：{{item.entryDate}}</text>
              </view>
              <view class="batch-status-info">
                <view class="status-item">
                  <text class="status-value primary-text">{{calculateCurrentAge(item.entryDate)}}</text>
                  <text class="status-label">日龄</text>
                </view>
                <view class="status-item">
                  <text class="status-value">{{item.currentCount}}</text>
                  <text class="status-label">只</text>
                </view>
              </view>
            </view>
            <view wx:if="{{selectedBatch.id === item.id}}" class="selected-indicator">
              <t-icon name="check" size="24rpx" color="var(--primary-blue)" />
            </view>
          </view>
        </view>
      </view>
    </t-overlay>


  <!-- 任务详情弹窗 -->
  <bottom-popup
    visible="{{showTaskDetailPopup}}"
    title="任务详情"
    show-close="{{true}}"
    show-actions="{{selectedTask && !selectedTask.completed && selectedTask.canComplete}}"
    confirm-text="{{selectedTask && selectedTask.isVaccineTask ? '填写接种信息' : (selectedTask && selectedTask.isMedicationTask ? '领取药品' : (selectedTask && selectedTask.isNutritionTask ? '领取营养品' : '完成任务'))}}"
    cancel-text="关闭"
    bind:close="closeTaskDetailPopup"
    bind:confirm="onTaskConfirm"
    bind:cancel="closeTaskDetailPopup"
    bind:visiblechange="onTaskDetailPopupChange"
  >
    <view wx:if="{{selectedTask}}" class="record-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">任务名称：</text>
            <text class="info-value">{{selectedTask.title || '未命名任务'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">任务类型：</text>
            <text class="info-value">{{selectedTask.typeName || '未分类'}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.estimatedTime}}">
            <text class="info-label">预计用时：</text>
            <text class="info-value">{{selectedTask.estimatedTime}}分钟</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.duration && selectedTask.dayInSeries}}">
            <text class="info-label">连续任务：</text>
            <text class="info-value">第{{selectedTask.dayInSeries}}/{{selectedTask.duration}}天</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dosage}}">
            <text class="info-label">用量：</text>
            <text class="info-value">{{selectedTask.dosage}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.materials && selectedTask.materials.length > 0}}">
            <text class="info-label">所需物料：</text>
            <text class="info-value materials-text">
              <block wx:for="{{selectedTask.materials}}" wx:key="index">
                {{item}}{{index < selectedTask.materials.length - 1 ? '、' : ''}}
              </block>
            </text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.batchNumber}}">
            <text class="info-label">批次编号：</text>
            <text class="info-value">{{selectedTask.batchNumber}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedTask.dayAge}}">
            <text class="info-label">日龄：</text>
            <text class="info-value">第{{selectedTask.dayAge}}日龄</text>
          </view>
          <view class="info-row">
            <text class="info-label">完成状态：</text>
            <view class="status-value">
              <t-tag theme="{{selectedTask.completed ? 'success' : 'primary'}}" size="small">
                {{selectedTask.statusText || '待完成'}}
              </t-tag>
            </view>
          </view>
          <view class="info-row info-row-description" wx:if="{{selectedTask.description}}">
            <text class="info-label">任务描述：</text>
            <text class="info-value note-text">{{selectedTask.description}}</text>
          </view>
          <view class="info-row info-row-notes" wx:if="{{selectedTask.notes}}">
            <text class="info-label">注意事项：</text>
            <text class="info-value note-text important-text">{{selectedTask.notes}}</text>
          </view>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- 疫苗接种表单弹窗 -->
  <bottom-popup
    visible="{{showVaccineFormPopup}}"
    title="疫苗接种信息"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="完成接种"
    cancel-text="取消"
    bind:close="closeVaccineFormPopup"
    bind:confirm="submitVaccineForm"
    bind:cancel="closeVaccineFormPopup"
  >
    <view class="vaccine-form-content">
      <!-- 兽医信息 -->
      <view class="form-section">
        <view class="section-title">兽医信息</view>
        <view class="form-row">
          <text class="form-label required">执行兽医</text>
          <input class="form-input" 
                 placeholder="请输入兽医姓名"
                 value=""
                 data-field="veterinarianName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">联系电话</text>
          <input class="form-input" 
                 placeholder="请输入联系电话"
                 value=""
                 data-field="veterinarianPhone"
                 bindinput="onVaccineFormInput" />
        </view>
      </view>

      <!-- 疫苗信息 -->
      <view class="form-section">
        <view class="section-title">疫苗信息</view>
        <view class="form-row">
          <text class="form-label required">疫苗名称</text>
          <input class="form-input" 
                 placeholder="请输入疫苗名称"
                 value=""
                 data-field="vaccineName"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">生产厂家</text>
          <input class="form-input" 
                 placeholder="请输入生产厂家"
                 value=""
                 data-field="manufacturer"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">批次号</text>
          <input class="form-input" 
                 placeholder="请输入疫苗批次号"
                 value=""
                 data-field="batchNumber"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">接种剂量</text>
          <input class="form-input" 
                 placeholder="请输入接种剂量"
                 value=""
                 data-field="dosage"
                 bindinput="onVaccineFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label required">接种数量</text>
          <input class="form-input" 
                 type="number"
                 placeholder="请输入接种数量"
                 value=""
                 data-field="vaccineCount"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">接种方式</text>
          <picker mode="selector" 
                  range="{{vaccineRouteOptions}}"
                  range-key="label"
                  value="0"
                  bindchange="onVaccineRouteChange">
            <view class="form-input picker-input">
              {{vaccineRouteOptions[vaccineFormData.routeIndex].label}}
            </view>
          </picker>
        </view>
      </view>

      <!-- 费用信息 -->
      <view class="form-section">
        <view class="section-title">费用信息</view>
        <view class="form-row">
          <text class="form-label required">疫苗费用</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="请输入疫苗费用"
                 value=""
                 data-field="vaccineCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">兽医费用</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="请输入兽医费用"
                 value=""
                 data-field="veterinaryCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">其他费用</text>
          <input class="form-input" 
                 type="digit"
                 placeholder="请输入其他费用"
                 value=""
                 data-field="otherCost"
                 bindinput="onVaccineNumberInput" />
        </view>
        <view class="form-row">
          <text class="form-label">总费用</text>
          <view class="form-input readonly-input">{{vaccineFormData.totalCostFormatted}}</view>
        </view>
      </view>

      <!-- 备注和异常记录 -->
      <view class="form-section">
        <view class="section-title">备注信息</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="请输入接种备注信息"
                    value=""
                    data-field="notes"
                    bindinput="onVaccineFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- 表单验证错误提示 -->
      <view wx:if="{{vaccineFormErrorList && vaccineFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{vaccineFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- 异常反应处理弹窗 -->
  <bottom-popup
    visible="{{showAdverseReactionPopup}}"
    title="异常反应处理"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="记录异常"
    cancel-text="取消"
    bind:close="closeAdverseReactionPopup"
    bind:confirm="submitAdverseReactionRecord"
    bind:cancel="closeAdverseReactionPopup"
  >
    <view class="adverse-reaction-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">异常数量：</text>
            <text class="info-value">{{adverseReactionData.count}}只</text>
          </view>
          <view class="info-row">
            <text class="info-label">异常症状：</text>
            <text class="info-value">{{adverseReactionData.symptoms}}</text>
          </view>
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">补充信息</view>
        <view class="form-row">
          <text class="form-label">症状等级</text>
          <picker mode="selector" 
                  range="{{severityOptions}}"
                  range-key="label"
                  value="{{adverseReactionData.severityIndex}}"
                  bindchange="onSeverityChange">
            <view class="form-input picker-input">
              {{severityOptions[adverseReactionData.severityIndex].label}}
            </view>
          </picker>
        </view>
        <view class="form-row">
          <text class="form-label">处理措施</text>
          <textarea class="form-textarea" 
                    placeholder="请输入已采取的处理措施"
                    value="{{adverseReactionData.treatment}}"
                    data-field="treatment"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
        <view class="form-row">
          <text class="form-label">后续观察</text>
          <textarea class="form-textarea" 
                    placeholder="请输入后续观察要点"
                    value="{{adverseReactionData.followUp}}"
                    data-field="followUp"
                    bindinput="onAdverseReactionInput"
                    maxlength="200" />
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- 用药管理表单弹窗 -->
  <bottom-popup
    visible="{{showMedicationFormPopup}}"
    title="用药管理"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="确认领用"
    cancel-text="取消"
    bind:close="closeMedicationFormPopup"
    bind:confirm="submitMedicationForm"
    bind:cancel="closeMedicationFormPopup"
  >
    <view class="medication-form-content">
      <!-- 药品选择 -->
      <view class="form-section">
        <view class="section-title">药品选择</view>
        <view class="form-row">
          <text class="form-label required">选择药品</text>
          <picker mode="selector" 
                  range="{{availableMedicines}}"
                  range-key="name"
                  bindchange="onMedicineSelect">
            <view class="form-input picker-input">
              {{selectedMedicine ? selectedMedicine.name : '请选择药品'}}
            </view>
          </picker>
          <text wx:if="{{medicationFormErrors.medicineId}}" class="error-text">{{medicationFormErrors.medicineId}}</text>
        </view>
        
        <view wx:if="{{selectedMedicine}}" class="medicine-info">
          <view class="info-item">
            <text class="info-label">当前库存：</text>
            <text class="info-value">{{selectedMedicine.stock}}{{selectedMedicine.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedMedicine.description}}">
            <text class="info-label">药品说明：</text>
            <text class="info-value">{{selectedMedicine.description}}</text>
          </view>
        </view>
      </view>

      <!-- 用药信息 -->
      <view class="form-section">
        <view class="section-title">用药信息</view>
        <view class="form-row">
          <text class="form-label required">用药数量</text>
          <input class="form-input" 
                 type="number"
                 placeholder="请输入用药数量"
                 value="{{medicationFormData.quantity > 0 ? medicationFormData.quantity : ''}}"
                 bindinput="onMedicationQuantityInput" />
          <text wx:if="{{medicationFormErrors.quantity}}" class="error-text">{{medicationFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label required">用药用途</text>
          <input class="form-input" 
                 placeholder="请输入用药用途"
                 value="{{medicationFormData.purpose}}"
                 data-field="purpose"
                 bindinput="onMedicationFormInput" />
          <text wx:if="{{medicationFormErrors.purpose}}" class="error-text">{{medicationFormErrors.purpose}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">用药剂量</text>
          <input class="form-input" 
                 placeholder="请输入用药剂量"
                 value="{{medicationFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onMedicationFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">操作员</text>
          <view class="form-input readonly-input">{{medicationFormData.operator}}</view>
        </view>
      </view>

      <!-- 备注信息 -->
      <view class="form-section">
        <view class="section-title">备注信息</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="请输入用药备注信息"
                    value="{{medicationFormData.notes}}"
                    data-field="notes"
                    bindinput="onMedicationFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- 表单验证错误提示 -->
      <view wx:if="{{medicationFormErrorList && medicationFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{medicationFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- 营养管理表单弹窗 -->
  <bottom-popup
    visible="{{showNutritionFormPopup}}"
    title="营养管理"
    show-close="{{true}}"
    show-actions="{{true}}"
    confirm-text="确认领取"
    cancel-text="取消"
    bind:close="closeNutritionFormPopup"
    bind:confirm="submitNutritionForm"
    bind:cancel="closeNutritionFormPopup"
  >
    <view class="nutrition-form-content">
      <!-- 营养品选择 -->
      <view class="form-section">
        <view class="section-title">营养品选择</view>
        <view class="form-row">
          <text class="form-label required">选择营养品</text>
          <picker mode="selector" 
                  range="{{availableNutrition}}"
                  range-key="name"
                  bindchange="onNutritionSelect">
            <view class="form-input picker-input">
              {{selectedNutrition ? selectedNutrition.name : '请选择营养品'}}
            </view>
          </picker>
          <text wx:if="{{nutritionFormErrors.nutritionId}}" class="error-text">{{nutritionFormErrors.nutritionId}}</text>
        </view>
        
        <view wx:if="{{selectedNutrition}}" class="nutrition-info">
          <view class="info-item">
            <text class="info-label">当前库存：</text>
            <text class="info-value">{{selectedNutrition.stock}}{{selectedNutrition.unit}}</text>
          </view>
          <view class="info-item" wx:if="{{selectedNutrition.description}}">
            <text class="info-label">营养品说明：</text>
            <text class="info-value">{{selectedNutrition.description}}</text>
          </view>
        </view>
      </view>

      <!-- 使用信息 -->
      <view class="form-section">
        <view class="section-title">使用信息</view>
        <view class="form-row">
          <text class="form-label required">使用数量</text>
          <input class="form-input" 
                 type="number"
                 placeholder="请输入使用数量"
                 value="{{nutritionFormData.quantity > 0 ? nutritionFormData.quantity : ''}}"
                 bindinput="onNutritionQuantityInput" />
          <text wx:if="{{nutritionFormErrors.quantity}}" class="error-text">{{nutritionFormErrors.quantity}}</text>
        </view>
        <view class="form-row">
          <text class="form-label required">使用用途</text>
          <input class="form-input" 
                 placeholder="请输入使用用途"
                 value="{{nutritionFormData.purpose}}"
                 data-field="purpose"
                 bindinput="onNutritionFormInput" />
          <text wx:if="{{nutritionFormErrors.purpose}}" class="error-text">{{nutritionFormErrors.purpose}}</text>
        </view>
        <view class="form-row">
          <text class="form-label">使用剂量</text>
          <input class="form-input" 
                 placeholder="请输入使用剂量"
                 value="{{nutritionFormData.dosage}}"
                 data-field="dosage"
                 bindinput="onNutritionFormInput" />
        </view>
        <view class="form-row">
          <text class="form-label">操作员</text>
          <view class="form-input readonly-input">{{nutritionFormData.operator}}</view>
        </view>
      </view>

      <!-- 备注信息 -->
      <view class="form-section">
        <view class="section-title">备注信息</view>
        <view class="form-row textarea-row">
          <textarea class="form-textarea" 
                    placeholder="请输入营养品使用备注信息"
                    value="{{nutritionFormData.notes}}"
                    data-field="notes"
                    bindinput="onNutritionFormInput"
                    maxlength="200" />
        </view>
      </view>

      <!-- 表单验证错误提示 -->
      <view wx:if="{{nutritionFormErrorList && nutritionFormErrorList.length > 0}}" class="form-errors">
        <view wx:for="{{nutritionFormErrorList}}" wx:key="index" class="error-item">
          <text class="error-text">{{item}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="modern-loading">
    <view class="loading-content">
      <t-loading theme="spinner" size="60rpx" />
      <text class="loading-text">正在加载...</text>
    </view>
  </view>
  </scroll-view>
</view>