<!--ai-diagnosis.wxml - AI智能诊断页面-->
<view class="page ai-diagnosis-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="AI智能诊断"
    show-back="{{true}}"
    bind:back="goBack"
  />

  <!-- 页面内容 -->
  <view class="page-content">
    
    <!-- 诊断结果展示 - 全新设计 -->
    <view class="diagnosis-result" wx:if="{{diagnosisResult && diagnosisStatus === 'completed'}}">
      
      <!-- 诊断头部 -->
      <view class="result-header-card">
        <view class="header-icon">
          <t-icon name="check-circle" size="48" color="#00a870" />
        </view>
        <view class="header-content">
          <view class="header-title">AI诊断完成</view>
          <view class="header-subtitle">基于症状分析的智能诊断结果</view>
        </view>
      </view>

      <!-- 主要诊断/死因卡片 -->
      <view class="diagnosis-card primary-card">
        <view class="card-header">
          <view class="card-title">{{diagnosisType === 'autopsy_analysis' ? '主要死因' : '主要诊断'}}</view>
          <view class="confidence-badge">
            <text class="confidence-number">{{diagnosisType === 'autopsy_analysis' ? (diagnosisResult.primaryCause.confidence || diagnosisResult.primaryDiagnosis.confidence) : diagnosisResult.primaryDiagnosis.confidence}}</text>
            <text class="confidence-unit">%</text>
          </view>
        </view>
        <view class="card-body">
          <view class="diagnosis-name">{{diagnosisType === 'autopsy_analysis' ? (diagnosisResult.primaryCause.disease || diagnosisResult.primaryDiagnosis.disease) : diagnosisResult.primaryDiagnosis.disease}}</view>
          <view class="diagnosis-reasoning">{{diagnosisType === 'autopsy_analysis' ? (diagnosisResult.primaryCause.reasoning || diagnosisResult.primaryDiagnosis.reasoning) : diagnosisResult.primaryDiagnosis.reasoning}}</view>
        </view>
        
        <!-- 病鹅诊断：严重程度和紧急程度 -->
        <view class="status-row" wx:if="{{diagnosisType === 'live_diagnosis'}}">
          <view class="status-item">
            <text class="status-label">严重程度</text>
            <t-tag 
              theme="{{diagnosisResult.severity === 'severe' ? 'danger' : diagnosisResult.severity === 'moderate' ? 'warning' : 'success'}}"
              size="medium"
            >
              {{diagnosisResult.severity === 'severe' ? '严重' : diagnosisResult.severity === 'moderate' ? '中度' : '轻度'}}
            </t-tag>
          </view>
          <view class="status-item">
            <text class="status-label">紧急程度</text>
            <t-tag 
              theme="{{diagnosisResult.urgency === 'critical' || diagnosisResult.urgency === 'high' ? 'danger' : diagnosisResult.urgency === 'medium' ? 'warning' : 'primary'}}"
              size="medium"
            >
              {{diagnosisResult.urgency === 'critical' ? '危急' : diagnosisResult.urgency === 'high' ? '高' : diagnosisResult.urgency === 'medium' ? '中' : '低'}}
            </t-tag>
          </view>
        </view>
        
        <!-- 死因剖析：流行病学风险 -->
        <view class="status-row" wx:if="{{diagnosisType === 'autopsy_analysis' && diagnosisResult.epidemiologyRisk}}">
          <view class="status-item">
            <text class="status-label">传播风险</text>
            <t-tag 
              theme="{{diagnosisResult.epidemiologyRisk === 'high' ? 'danger' : diagnosisResult.epidemiologyRisk === 'medium' ? 'warning' : 'success'}}"
              size="medium"
            >
              {{diagnosisResult.epidemiologyRisk === 'high' ? '高风险' : diagnosisResult.epidemiologyRisk === 'medium' ? '中等' : '低风险'}}
            </t-tag>
          </view>
        </view>
      </view>

      <!-- 鉴别诊断/可能死因卡片 -->
      <view class="diagnosis-card" wx:if="{{(diagnosisResult.differentialDiagnosis && diagnosisResult.differentialDiagnosis.length > 0) || (diagnosisResult.differentialCauses && diagnosisResult.differentialCauses.length > 0)}}">
        <view class="card-header">
          <view class="card-title">{{diagnosisType === 'autopsy_analysis' ? '可能死因' : '鉴别诊断'}}</view>
          <view class="card-subtitle">其他可能的{{diagnosisType === 'autopsy_analysis' ? '死因' : '疾病'}}</view>
        </view>
        <view class="card-body">
          <view class="differential-list">
            <view 
              class="differential-item"
              wx:for="{{diagnosisType === 'autopsy_analysis' ? (diagnosisResult.differentialCauses || diagnosisResult.differentialDiagnosis) : diagnosisResult.differentialDiagnosis}}" 
              wx:key="index"
            >
              <view class="diff-name">{{item.disease}}</view>
              <view class="diff-confidence">{{item.confidence}}%</view>
            </view>
          </view>
        </view>
      </view>

      <!-- 病鹅诊断：立即措施卡片 -->
      <view class="diagnosis-card action-card" wx:if="{{diagnosisType === 'live_diagnosis' && diagnosisResult.treatmentRecommendation && diagnosisResult.treatmentRecommendation.immediate}}">
        <view class="card-header">
          <t-icon name="notification" size="20" color="#e34d59" />
          <view class="card-title">立即措施</view>
        </view>
        <view class="card-body">
          <view class="action-list">
            <view 
              class="action-list-item"
              wx:for="{{diagnosisResult.treatmentRecommendation.immediate}}" 
              wx:key="index"
            >
              <view class="action-number">{{index + 1}}</view>
              <view class="action-content">{{item}}</view>
            </view>
          </view>
        </view>
      </view>

      <!-- 病鹅诊断：药物治疗卡片 -->
      <view class="diagnosis-card medication-card" wx:if="{{diagnosisType === 'live_diagnosis' && diagnosisResult.treatmentRecommendation && diagnosisResult.treatmentRecommendation.medication}}">
        <view class="card-header">
          <t-icon name="edit" size="20" color="#0052d9" />
          <view class="card-title">药物治疗方案</view>
        </view>
        <view class="card-body">
          <view 
            class="medication-box"
            wx:for="{{diagnosisResult.treatmentRecommendation.medication}}" 
            wx:key="index"
          >
            <view class="med-name-row">
              <t-icon name="check-circle" size="18" color="#0052d9" />
              <text class="med-name-text">{{item.name}}</text>
            </view>
            <view class="med-info-grid">
              <view class="med-info-item">
                <text class="med-info-label">用量</text>
                <text class="med-info-value">{{item.dosage}}</text>
              </view>
              <view class="med-info-item">
                <text class="med-info-label">途径</text>
                <text class="med-info-value">{{item.route}}</text>
              </view>
              <view class="med-info-item">
                <text class="med-info-label">频率</text>
                <text class="med-info-value">{{item.frequency}}</text>
              </view>
              <view class="med-info-item">
                <text class="med-info-label">疗程</text>
                <text class="med-info-value">{{item.duration}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 病鹅诊断：支持性治疗卡片 -->
      <view class="diagnosis-card" wx:if="{{diagnosisType === 'live_diagnosis' && diagnosisResult.treatmentRecommendation && diagnosisResult.treatmentRecommendation.supportive}}">
        <view class="card-header">
          <t-icon name="heart" size="20" color="#ed7b2f" />
          <view class="card-title">支持性治疗</view>
        </view>
        <view class="card-body">
          <view class="simple-list">
            <view 
              class="simple-list-item"
              wx:for="{{diagnosisResult.treatmentRecommendation.supportive}}" 
              wx:key="index"
            >
              <view class="list-dot"></view>
              <text class="list-text">{{item}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 预防建议卡片（两种类型都显示） -->
      <view class="diagnosis-card" wx:if="{{diagnosisResult.preventionAdvice || diagnosisResult.preventionMeasures}}">
        <view class="card-header">
          <t-icon name="secured" size="20" color="#00a870" />
          <view class="card-title">预防建议</view>
        </view>
        <view class="card-body">
          <view class="simple-list">
            <view 
              class="simple-list-item"
              wx:for="{{diagnosisResult.preventionAdvice || diagnosisResult.preventionMeasures}}" 
              wx:key="index"
            >
              <view class="list-dot prevention-dot"></view>
              <text class="list-text">{{item}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 死因剖析：生物安全建议 -->
      <view class="diagnosis-card" wx:if="{{diagnosisType === 'autopsy_analysis' && diagnosisResult.biosecurityAdvice}}">
        <view class="card-header">
          <t-icon name="error-circle" size="20" color="#e34d59" />
          <view class="card-title">生物安全建议</view>
        </view>
        <view class="card-body">
          <view class="simple-list">
            <view 
              class="simple-list-item"
              wx:for="{{diagnosisResult.biosecurityAdvice}}" 
              wx:key="index"
            >
              <view class="list-dot" style="background: #e34d59;"></view>
              <text class="list-text">{{item}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 操作按钮 -->
      <view class="result-actions">
        <t-button 
          theme="primary" 
          size="large" 
          block
          bind:tap="saveRecord"
          class="primary-action-btn"
        >
          {{diagnosisType === 'autopsy_analysis' ? '记录死亡报告' : '保存诊断记录'}}
        </t-button>
      </view>
    </view>

    <!-- 症状输入表单 -->
    <view class="diagnosis-form" wx:else>
      
      <!-- 重要提醒 -->
      <view class="notice-section">
        <t-notice-bar 
          theme="warning" 
          content="⚠️ AI诊断仅供参考，请结合专业兽医建议进行最终诊断和治疗"
        />
      </view>

      <!-- 基本信息 -->
      <view class="form-section">
        <text class="section-title">基本信息</text>
        
        <!-- 诊断类型选择 -->
        <view class="form-row">
          <text class="form-label">诊断类型</text>
          <picker 
            class="form-picker"
            mode="selector"
            range="{{diagnosisTypeOptions}}"
            range-key="label"
            value="{{diagnosisTypePickerIndex}}"
            bindchange="onDiagnosisTypeChange"
          >
            <view class="picker-value">
              {{diagnosisTypeOptions[diagnosisTypePickerIndex].label}}
            </view>
          </picker>
        </view>
        
        <!-- 批次选择 -->
        <view class="form-row">
          <text class="form-label">选择批次</text>
          <picker 
            class="form-picker"
            mode="selector"
            range="{{batchPickerRange}}"
            value="{{batchPickerIndex}}"
            bindchange="onBatchPickerChange"
          >
            <view class="picker-value {{selectedBatchNumber ? '' : 'placeholder'}}">
              {{selectedBatchNumber ? selectedBatchNumber : '请选择批次'}}
            </view>
          </picker>
        </view>

        <!-- 日龄（自动显示） -->
        <view class="form-row" wx:if="{{selectedBatchId}}">
          <text class="form-label">鹅只日龄</text>
          <view class="form-value">
            <text class="value-text">{{dayAge}}</text>
            <text class="form-unit">天</text>
          </view>
        </view>
        
        <!-- 病鹅诊断：受影响数量 -->
        <view class="form-row" wx:if="{{diagnosisType === 'live_diagnosis'}}">
          <text class="form-label">受影响数量<text class="required-mark">*</text></text>
          <input 
            class="form-input"
            type="number"
            placeholder="请输入数量"
            value="{{affectedCount}}"
            bindinput="onAffectedCountInput"
          />
          <text class="form-unit">只</text>
        </view>
        
        <!-- 死因剖析：死亡数量 -->
        <view class="form-row" wx:if="{{diagnosisType === 'autopsy_analysis'}}">
          <text class="form-label">死亡数量<text class="required-mark">*</text></text>
          <input 
            class="form-input"
            type="number"
            placeholder="请输入死亡数量"
            value="{{deathCount}}"
            bindinput="onDeathCountInput"
          />
          <text class="form-unit">只</text>
        </view>
      </view>

      <!-- 症状描述（仅病鹅诊断显示） -->
      <view class="form-section" wx:if="{{diagnosisType !== 'autopsy_analysis'}}">
        <text class="section-title">症状描述</text>
        
        <!-- 常见症状标签（点击填充） -->
        <view class="symptom-tags-inline">
          <view 
            wx:for="{{commonSymptoms}}" 
            wx:key="id"
            class="symptom-tag-inline {{item.checked ? 'tag-checked' : ''}}"
            bind:tap="onSymptomTagTap"
            data-index="{{index}}"
          >
            <text class="tag-icon">+</text>
            <text class="tag-name">{{item.name}}</text>
          </view>
        </view>
        
        <!-- 症状输入框 -->
        <textarea 
          placeholder="请详细描述鹅群症状，如：精神状态、食欲情况、排便状况、异常行为等..."
          value="{{symptoms}}"
          bindinput="onSymptomsInput"
          maxlength="500"
          auto-height="{{true}}"
          class="symptoms-textarea"
        />
        
        <view class="char-count">{{symptoms.length}}/500</view>
      </view>
      
      <!-- 死因剖析专用：剖检所见 -->
      <view class="form-section" wx:if="{{diagnosisType === 'autopsy_analysis'}}">
        <text class="section-title">看到的异常（可选）</text>
        
        <!-- 常见异常标签（点击选择） -->
        <view class="symptom-tags-inline">
          <view 
            wx:for="{{autopsyAbnormalities}}" 
            wx:key="id"
            class="symptom-tag-inline {{item.checked ? 'tag-checked' : ''}}"
            bind:tap="onAbnormalityChange"
            data-index="{{index}}"
          >
            <text class="tag-icon">+</text>
            <text class="tag-name">{{item.name}}</text>
          </view>
        </view>
        
        <!-- 详细描述输入框 -->
        <textarea 
          placeholder="请描述看到的情况，如：肠子里面全是血、肝脏有很多白点等..."
          value="{{autopsyDescription}}"
          bindinput="onAutopsyDescriptionInput"
          maxlength="300"
          auto-height="{{true}}"
          class="symptoms-textarea"
        />
        
        <view class="char-count">{{autopsyDescription.length}}/300</view>
      </view>

      <!-- 图片上传 - ✨ 增强版 -->
      <view class="form-section">
        <text class="section-title">{{diagnosisType === 'autopsy_analysis' ? '剖检照片（强烈建议）' : '上传症状图片（可选）'}}</text>
        
        <!-- ✨ 拍摄建议 -->
        <view class="photo-tips-card" wx:if="{{diagnosisType === 'live_diagnosis'}}">
          <view class="tips-title">
            <t-icon name="lightbulb" size="18" color="#ed7b2f" />
            <text class="tips-title-text">拍摄建议（可提高诊断准确性）</text>
          </view>
          <view class="tips-list">
            <view class="tip-item">
              <text class="tip-number">1</text>
              <text class="tip-text">粪便照片：拍摄清晰、光线充足，能看清颜色和性状</text>
            </view>
            <view class="tip-item">
              <text class="tip-number">2</text>
              <text class="tip-text">病鹅姿态：全身照，能看清精神状态和异常姿势</text>
            </view>
            <view class="tip-item">
              <text class="tip-number">3</text>
              <text class="tip-text">局部病变：肛门周围、眼部、肢体等异常部位特写</text>
            </view>
            <view class="tip-item">
              <text class="tip-number">4</text>
              <text class="tip-text">避免模糊：请勿抖动，确保对焦清晰</text>
            </view>
          </view>
        </view>
        
        <!-- 死因剖析拍摄建议 -->
        <view class="photo-tips-card autopsy-tips-card" wx:if="{{diagnosisType === 'autopsy_analysis'}}">
          <view class="tips-title">
            <t-icon name="lightbulb" size="18" color="#e34d59" />
            <text class="tips-title-text">剖检拍照要点（重要）</text>
          </view>
          <view class="tips-list">
            <view class="tip-item">
              <text class="tip-number">1</text>
              <text class="tip-text">打开腹腔后整体拍摄，能看到肝脏、肠道、心脏等主要器官</text>
            </view>
            <view class="tip-item">
              <text class="tip-number">2</text>
              <text class="tip-text">发现异常的器官单独特写（如肝脏有白点、肠道出血等）</text>
            </view>
            <view class="tip-item">
              <text class="tip-number">3</text>
              <text class="tip-text">光线充足、对焦清晰，能看清器官颜色和病变</text>
            </view>
            <view class="tip-item">
              <text class="tip-number">4</text>
              <text class="tip-text">建议拍摄2-4张不同角度的照片</text>
            </view>
          </view>
        </view>
        
        <view class="image-upload-container">
          <!-- 已上传的图片 -->
          <view 
            class="uploaded-image-item"
            wx:for="{{images}}" 
            wx:key="index"
          >
            <t-image 
              src="{{item}}"
              mode="aspectFill"
              width="200rpx"
              height="200rpx"
              bind:tap="onPreviewImage"
              data-src="{{item}}"
              class="uploaded-image"
            />
            <view 
              class="image-delete-btn"
              bind:tap="onDeleteImage"
              data-index="{{index}}"
            >
              <t-icon name="close" size="16" color="#fff" />
            </view>
          </view>

          <!-- 上传按钮 -->
          <view 
            class="upload-placeholder {{images.length === 0 ? 'first-upload' : ''}}"
            wx:if="{{images.length < (diagnosisType === 'autopsy_analysis' ? 4 : 2)}}"
            bind:tap="onChooseImage"
          >
            <text class="upload-text {{images.length === 0 ? 'upload-text-primary' : ''}}">
              {{images.length === 0 ? (diagnosisType === 'autopsy_analysis' ? '拍摄剖检照片' : '拍摄症状照片') : '继续添加'}}
            </text>
            <text class="upload-hint" wx:if="{{images.length === 0}}">{{diagnosisType === 'autopsy_analysis' ? '帮助AI准确分析死因' : '可提升诊断准确率'}}</text>
          </view>
        </view>
        
        <!-- 已上传提示 -->
        <view class="upload-status" wx:if="{{images.length > 0}}">
          <t-icon name="check-circle" size="16" color="#00a870" />
          <text class="status-text">已上传 {{images.length}} 张{{diagnosisType === 'autopsy_analysis' ? '剖检' : ''}}图片，AI将结合图片进行综合{{diagnosisType === 'autopsy_analysis' ? '分析' : '诊断'}}</text>
        </view>
      </view>

      <!-- 提交按钮 -->
      <view class="submit-section">
        <t-button 
          theme="primary" 
          size="large" 
          block
          disabled="{{!formValid || submitting}}"
          loading="{{submitting}}"
          bind:tap="startDiagnosis"
          class="submit-btn"
        >
          {{submitting ? (diagnosisType === 'autopsy_analysis' ? 'AI分析中...' : 'AI诊断中...') : (diagnosisType === 'autopsy_analysis' ? '开始AI死因分析' : '开始AI智能诊断')}}
        </t-button>
        
        <!-- 预计等待时间提示 -->
        <view class="submit-hint" wx:if="{{submitting}}">
          <text class="hint-text">⏱️ 预计需要 20-30 秒，AI正在深度分析中...</text>
        </view>
      </view>

      <!-- 底部链接 -->
      <view class="bottom-links">
        <text class="link-text" bind:tap="viewDiagnosisHistory">查看历史诊断</text>
        <text class="link-divider">|</text>
        <text class="link-text" bind:tap="contactVet">联系专业兽医</text>
      </view>

    </view>

    <!-- 底部安全区域 -->
    <view class="safe-area-bottom"></view>
  </view>
</view>
