<!--diagnosis-history.wxml - è¯Šæ–­å†å²é¡µé¢-->
<view class="page diagnosis-history-page">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar 
    title="è¯Šæ–­å†å²"
    show-back="{{true}}"
    bind:back="goBack"
  />

  <!-- è¯Šæ–­è®°å½•åˆ—è¡¨ -->
  <view class="records-container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading}}">
      <t-loading theme="circular" size="40rpx" text="åŠ è½½ä¸­..." />
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-container" wx:elif="{{records.length === 0}}">
      <t-empty 
        icon="medical-record" 
        description="æš‚æ— è¯Šæ–­è®°å½•"
      >
        <t-button 
          theme="primary" 
          size="medium"
          bind:tap="goBack"
        >å»è¯Šæ–­</t-button>
      </t-empty>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="records-list" wx:else>
      <view 
        class="record-item"
        wx:for="{{records}}"
        wx:key="_id"
        bind:tap="onViewRecord"
        data-record="{{item}}"
      >
        <view class="record-main">
          <!-- ç–¾ç—…åç§° + ç½®ä¿¡åº¦æ ‡ç­¾ -->
          <view class="record-header">
            <text class="record-name">{{item.diagnosisResult}}</text>
            <view class="confidence-badge">
              <text class="confidence-text">ç½®ä¿¡åº¦ {{item.confidence}}%</text>
            </view>
          </view>

          <!-- è®°å½•å†…å®¹ -->
          <view class="record-content">
            <!-- ç¬¬ä¸€è¡Œï¼šå—å½±å“æ•° + æ—¥é¾„ -->
            <view class="info-row">
              <view class="info-group">
                <text class="info-label">å—å½±å“ï¼š</text>
                <text class="info-value">{{item.affectedCount}}åª</text>
              </view>
              <view class="info-group">
                <text class="info-label">æ—¥é¾„ï¼š</text>
                <text class="info-value">{{item.dayAge}}å¤©</text>
              </view>
            </view>

            <!-- ç¬¬äºŒè¡Œï¼šç—‡çŠ¶ï¼ˆå¦‚æœæœ‰ï¼‰ -->
            <view class="info-row" wx:if="{{item.symptoms}}">
              <view class="info-group full-width">
                <text class="info-label">ç—‡çŠ¶ï¼š</text>
                <text class="info-value symptoms-value">{{item.symptoms}}</text>
              </view>
            </view>

            <!-- ç¬¬ä¸‰è¡Œï¼šAIè¯Šæ–­ + æ—¥æœŸ + å‘¨æœŸ -->
            <view class="record-footer">
              <view class="footer-left">
                <text class="operator-text">AIè¯Šæ–­</text>
                <text class="date-text">{{item.createTime}}</text>
              </view>
              <text class="duration-text">å‘¨æœŸï¼š{{item.treatmentDuration}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{pagination.hasMore && records.length > 0}}">
      <t-loading wx:if="{{loadingMore}}" theme="circular" size="32rpx" text="åŠ è½½æ›´å¤š..." />
      <text wx:else class="load-more-text">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view class="no-more" wx:if="{{!pagination.hasMore && records.length > 0}}">
      <t-divider content="æ²¡æœ‰æ›´å¤šæ•°æ®äº†" />
    </view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <bottom-popup
    visible="{{showDetailDialog}}"
    title="è¯Šæ–­è¯¦æƒ…"
    show-close="{{true}}"
    bind:close="onCloseDetail"
  >
    <view wx:if="{{selectedRecord}}" class="detail-content">
      <!-- AIè¯Šæ–­ç»“æœ -->
      <view class="detail-section">
        <view class="detail-section-title">
          <text>AIè¯Šæ–­ç»“æœ</text>
          <t-tag wx:if="{{!selectedRecord.isCorrected}}" theme="primary" size="small">AIåˆ†æ</t-tag>
        </view>
        <view class="detail-item">
          <text class="detail-label">ç–¾ç—…åç§°</text>
          <text class="detail-value primary">{{selectedRecord.diagnosisResult}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">ç½®ä¿¡åº¦</text>
          <text class="detail-value confidence">{{selectedRecord.confidence}}%</text>
        </view>
      </view>

      <!-- è¯Šæ–­ä¿®æ­£è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
      <view class="detail-section correction-section" wx:if="{{selectedRecord.isCorrected}}">
        <view class="detail-section-title">
          <text>è¯Šæ–­ä¿®æ­£è®°å½•</text>
          <t-tag theme="success" size="small">å·²ç¡®è®¤</t-tag>
        </view>
        <view class="detail-item">
          <text class="detail-label">ä¿®æ­£åè¯Šæ–­</text>
          <text class="detail-value primary corrected">{{selectedRecord.correctedDiagnosis}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.aiAccuracyRating > 0}}">
          <text class="detail-label">AIå‡†ç¡®æ€§è¯„åˆ†</text>
          <view class="rating-display">
            <text 
              class="star-display {{selectedRecord.aiAccuracyRating >= item ? 'active' : ''}}"
              wx:for="{{[1,2,3,4,5]}}" 
              wx:key="index"
            >{{selectedRecord.aiAccuracyRating >= item ? 'â˜…' : 'â˜†'}}</text>
            <text class="rating-text">{{ratingHints[selectedRecord.aiAccuracyRating - 1] || ''}}</text>
          </view>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.veterinarianDiagnosis}}">
          <text class="detail-label">å…½åŒ»è¯Šæ–­</text>
          <text class="detail-value text-content">{{selectedRecord.veterinarianDiagnosis}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.veterinarianTreatmentPlan}}">
          <text class="detail-label">å…½åŒ»æ²»ç–—æ–¹æ¡ˆ</text>
          <text class="detail-value text-content">{{selectedRecord.veterinarianTreatmentPlan}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.correctedByName}}">
          <text class="detail-label">ä¿®æ­£äºº</text>
          <text class="detail-value">{{selectedRecord.correctedByName}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.correctedAt}}">
          <text class="detail-label">ä¿®æ­£æ—¶é—´</text>
          <text class="detail-value">{{selectedRecord.correctedAt}}</text>
        </view>
      </view>

      <!-- ç—‡çŠ¶æè¿° -->
      <view class="detail-section" wx:if="{{selectedRecord.symptoms}}">
        <view class="detail-section-title">ç—‡çŠ¶æè¿°</view>
        <view class="detail-text-content">
          <text class="detail-text">{{selectedRecord.symptoms}}</text>
        </view>
      </view>

      <!-- è¯Šæ–­å›¾ç‰‡ -->
      <view class="detail-section" wx:if="{{selectedRecord.images && selectedRecord.images.length > 0}}">
        <view class="detail-section-title">
          {{selectedRecord.diagnosisType === 'autopsy_analysis' ? 'å‰–æ£€å›¾ç‰‡' : 'ç—‡çŠ¶å›¾ç‰‡'}}
          <text class="image-count">({{selectedRecord.images.length}}å¼ )</text>
        </view>
        <view class="diagnosis-images">
          <view 
            class="image-item"
            wx:for="{{selectedRecord.images}}"
            wx:key="index"
            bind:tap="onPreviewImage"
            data-url="{{item}}"
          >
            <t-image 
              src="{{item}}"
              mode="aspectFill"
              width="200rpx"
              height="200rpx"
              shape="round"
              loading="lazy"
              error="åŠ è½½å¤±è´¥"
            />
          </view>
        </view>
      </view>

      <!-- å»ºè®®ç”¨è¯ -->
      <view class="detail-section" wx:if="{{selectedRecord.recommendedMedications && selectedRecord.recommendedMedications.length > 0}}">
        <view class="detail-section-title">å»ºè®®ç”¨è¯</view>
        <view class="medications-list">
          <view class="medication-item" wx:for="{{selectedRecord.recommendedMedications}}" wx:key="index">
            <text class="medication-icon">ğŸ’Š</text>
            <text class="medication-name">{{item}}</text>
          </view>
        </view>
      </view>

      <!-- å®é™…æ²»ç–—è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ -->
      <view class="detail-section treatment-section" wx:if="{{selectedRecord.actualTreatment}}">
        <view class="detail-section-title">
          <text>å®é™…æ²»ç–—è®°å½•</text>
          <t-tag theme="primary" size="small">å·²æ‰§è¡Œ</t-tag>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.actualTreatment.treatmentPlan}}">
          <text class="detail-label">æ²»ç–—æ–¹æ¡ˆ</text>
          <text class="detail-value text-content">{{selectedRecord.actualTreatment.treatmentPlan}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.actualTreatment.medications && selectedRecord.actualTreatment.medications.length > 0}}">
          <text class="detail-label">ç”¨è¯è®°å½•</text>
          <view class="medications-list-actual">
            <view class="medication-item-actual" wx:for="{{selectedRecord.actualTreatment.medications}}" wx:key="index">
              <text class="medication-icon">ğŸ’Š</text>
              <view class="medication-info">
                <text class="medication-name">{{item.name || item}}</text>
                <text class="medication-detail" wx:if="{{item.dosage}}">{{item.dosage}}</text>
              </view>
            </view>
          </view>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.actualTreatment.treatmentDate}}">
          <text class="detail-label">æ²»ç–—æ—¶é—´</text>
          <text class="detail-value">{{selectedRecord.actualTreatment.treatmentDate}}</text>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.actualTreatment.outcome}}">
          <text class="detail-label">æ²»ç–—ç»“æœ</text>
          <text class="detail-value">{{selectedRecord.actualTreatment.outcome}}</text>
        </view>
      </view>

      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="detail-section-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="detail-item">
          <text class="detail-label">å—å½±å“æ•°é‡</text>
          <text class="detail-value">{{selectedRecord.affectedCount || 0}}åª</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">é¹…åªæ—¥é¾„</text>
          <text class="detail-value">{{selectedRecord.dayAge || 0}}å¤©</text>
        </view>
        <view class="detail-item" wx:if="{{selectedRecord.temperature > 0}}">
          <text class="detail-label">ç¯å¢ƒæ¸©åº¦</text>
          <text class="detail-value">{{selectedRecord.temperature}}Â°C</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">å»ºè®®æ²»ç–—å‘¨æœŸ</text>
          <text class="detail-value">{{selectedRecord.treatmentDuration}}</text>
        </view>
        <view class="detail-item">
          <text class="detail-label">è¯Šæ–­æ—¶é—´</text>
          <text class="detail-value">{{selectedRecord.createTime}}</text>
        </view>
      </view>
    </view>
  </bottom-popup>

</view>
