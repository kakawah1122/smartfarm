<!--diagnosis-history.wxml - 诊断历史页面-->
<view class="page diagnosis-history-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="诊断历史"
    show-back="{{true}}"
    bind:back="goBack"
  />

  <!-- 诊断记录列表 -->
  <view class="records-container">
    <!-- 加载状态 -->
    <view class="loading-container" wx:if="{{loading}}">
      <t-loading theme="circular" size="40rpx" text="加载中..." />
    </view>

    <!-- 空状态 -->
    <view class="empty-container" wx:elif="{{records.length === 0}}">
      <t-empty 
        description="暂无诊断记录"
      >
        <t-button 
          theme="primary" 
          size="medium" 
          bind:tap="goBack"
        >去诊断</t-button>
      </t-empty>
    </view>

    <!-- 记录列表 -->
    <view class="records-list" wx:else>
      <view 
        class="record-item"
        wx:for="{{records}}"
        wx:key="_id"
        bind:tap="onViewRecord"
        data-record="{{item}}"
      >
        <view class="record-main">
          <!-- 疾病名称 + 置信度标签 -->
          <view class="record-header">
            <text class="record-name">{{item.diagnosisResult}}</text>
            <view class="confidence-badge">
              <text class="confidence-text">置信度 {{item.confidence}}%</text>
            </view>
          </view>

          <!-- 记录内容 -->
          <view class="record-content">
            <!-- 第一行：受影响数 + 日龄 -->
            <view class="info-row">
              <view class="info-group">
                <text class="info-label">受影响：</text>
                <text class="info-value">{{item.affectedCount}}只</text>
              </view>
              <view class="info-group">
                <text class="info-label">日龄：</text>
                <text class="info-value">{{item.dayAge}}天</text>
              </view>
            </view>

            <!-- 第二行：症状（如果有） -->
            <view class="info-row" wx:if="{{item.symptoms}}">
              <view class="info-group full-width">
                <text class="info-label">症状：</text>
                <text class="info-value symptoms-value">{{item.symptoms}}</text>
              </view>
            </view>

            <!-- 第三行：AI诊断 + 日期 + 周期 -->
            <view class="record-footer">
              <view class="footer-left">
                <text class="operator-text">AI诊断</text>
                <text class="date-text">{{item.createTime}}</text>
              </view>
              <text class="duration-text">周期：{{item.treatmentDuration}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{pagination.hasMore && records.length > 0}}">
      <t-loading wx:if="{{loadingMore}}" theme="circular" size="32rpx" text="加载更多..." />
      <text wx:else class="load-more-text">上拉加载更多</text>
    </view>

    <!-- 没有更多数据 -->
    <view class="no-more" wx:if="{{!pagination.hasMore && records.length > 0}}">
      <t-divider content="没有更多数据了" />
    </view>
  </view>

  <!-- 详情弹窗（使用共用组件） -->
  <diagnosis-detail-popup
    visible="{{showDetailDialog}}"
    record="{{selectedRecord}}"
    bind:close="onCloseDetail"
  />

</view>
