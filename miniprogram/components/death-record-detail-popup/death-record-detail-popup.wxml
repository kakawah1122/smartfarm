<!-- 死亡记录详情弹窗组件 -->
<bottom-popup
  visible="{{visible}}"
  title="死亡详情"
  show-close="{{true}}"
  show-actions="{{true}}"
  confirm-text="确定"
  bind:close="onClose"
  bind:confirm="onClose"
  bind:visiblechange="onVisibleChange"
>
  <view wx:if="{{record}}" class="record-detail-content">
    <!-- 基本信息 -->
    <view class="detail-section">
      <view class="section-title">基本信息</view>
      <view class="info-card">
        <view class="info-row">
          <text class="info-label">死亡原因：</text>
          <text class="info-value">{{record.displayDeathCause || record.deathCause || '未知'}}</text>
        </view>
        <view class="divider-line"></view>
        <view class="info-row">
          <text class="info-label">死亡批次：</text>
          <text class="info-value">{{record.batchNumber || record.batchId}}</text>
        </view>
        <view class="divider-line"></view>
        <view class="info-row">
          <text class="info-label">死亡日期：</text>
          <text class="info-value">{{record.deathDate}}</text>
        </view>
        <view class="divider-line" wx:if="{{record.deathCategory}}"></view>
        <view class="info-row" wx:if="{{record.deathCategory}}">
          <text class="info-label">死亡类别：</text>
          <text class="info-value">{{record.deathCategory === 'disease' ? '疾病' : record.deathCategory === 'accident' ? '事故' : record.deathCategory === 'old_age' ? '衰老' : '其他'}}
          </text>
        </view>
        <!-- 症状/异常描述 -->
        <view class="divider-line" wx:if="{{record.displayFindings}}"></view>
        <view class="info-row" wx:if="{{record.displayFindings}}">
          <text class="info-label">症状/异常：</text>
          <text class="info-value symptoms-text">{{record.displayFindings}}</text>
        </view>
      </view>
    </view>

    <!-- 死亡统计 -->
    <view class="detail-section">
      <view class="section-title">死亡统计</view>
      <view class="death-summary">
        <view class="death-stat-item danger">
          <text class="stat-value">{{record.deathCount}} 只</text>
        </view>
      </view>
    </view>

    <!-- 成本分解 -->
    <view class="detail-section" wx:if="{{record.formattedTotalLoss}}">
      <view class="section-title">
        <text class="title-text">成本分解</text>
        <t-tag theme="primary" size="small" wx:if="{{record.costBreakdown}}">综合平均成本</t-tag>
      </view>
      
      <!-- 详细成本分解 -->
      <view class="cost-breakdown-container" wx:if="{{record.costBreakdown}}">
        <view class="breakdown-item" wx:if="{{record.costBreakdown.entryUnitCost}}">
          <view class="breakdown-label">
            <view class="label-dot" style="background: #0052d9;"></view>
            <text class="label-text">鹅苗成本</text>
          </view>
          <text class="breakdown-value">¥{{record.costBreakdown.entryUnitCost}}</text>
        </view>
        
        <view class="breakdown-item" wx:if="{{record.costBreakdown.breedingCost && record.costBreakdown.breedingCost !== '0.00'}}">
          <view class="breakdown-label">
            <view class="label-dot" style="background: #00a870;"></view>
            <text class="label-text">饲养成本</text>
          </view>
          <text class="breakdown-value">¥{{record.costBreakdown.breedingCost}}</text>
        </view>
        
        <view class="breakdown-item" wx:if="{{record.costBreakdown.preventionCost && record.costBreakdown.preventionCost !== '0.00'}}">
          <view class="breakdown-label">
            <view class="label-dot" style="background: #ed7b2f;"></view>
            <text class="label-text">预防成本</text>
          </view>
          <text class="breakdown-value">¥{{record.costBreakdown.preventionCost}}</text>
        </view>
        
        <view class="breakdown-item" wx:if="{{record.costBreakdown.treatmentCost && record.costBreakdown.treatmentCost !== '0.00'}}">
          <view class="breakdown-label">
            <view class="label-dot" style="background: #e34d59;"></view>
            <text class="label-text">治疗成本</text>
          </view>
          <text class="breakdown-value">¥{{record.costBreakdown.treatmentCost}}</text>
        </view>
        
        <view class="breakdown-divider"></view>
        
        <!-- 总计 -->
        <view class="breakdown-total">
          <text class="total-label">单只综合成本</text>
          <text class="total-value">¥{{record.formattedCostPerAnimal}}</text>
        </view>
        
        <view class="breakdown-loss">
          <text class="loss-label">总损失（×{{record.deathCount}}只）</text>
          <text class="loss-value">¥{{record.formattedTotalLoss}}</text>
        </view>
      </view>
      
      <!-- 兼容旧数据：简单显示 -->
      <view class="cost-grid" wx:else>
        <view class="cost-item">
          <text class="cost-label">总损失</text>
          <text class="cost-value danger">¥{{record.formattedTotalLoss}}</text>
        </view>
        <view class="cost-item">
          <text class="cost-label">单只损失</text>
          <text class="cost-value">¥{{record.formattedCostPerAnimal}}</text>
        </view>
        <view class="cost-item" wx:if="{{record.formattedTreatmentCost && record.formattedTreatmentCost !== '0.00'}}">
          <text class="cost-label">治疗成本</text>
          <text class="cost-value">¥{{record.formattedTreatmentCost}}</text>
        </view>
      </view>
    </view>

    <!-- 备注说明 -->
    <view class="detail-section" wx:if="{{record.description}}">
      <view class="section-title">备注说明</view>
      <view class="description-card">
        <text class="description-text">{{record.description}}</text>
      </view>
    </view>

    <!-- 修正信息 -->
    <view class="detail-section" wx:if="{{record.isCorrected}}">
      <view class="section-title">修正信息</view>
      <view class="info-card correction-card">
        <!-- 诊断对比 -->
        <view class="diagnosis-comparison" wx:if="{{record.deathCause && record.correctedCause}}">
          <view class="original-diagnosis">
            <text class="diagnosis-label">原诊断：</text>
            <text class="diagnosis-value original">{{record.deathCause}}</text>
          </view>
          <view class="correction-arrow">↓</view>
          <view class="corrected-diagnosis">
            <text class="diagnosis-label">修正为：</text>
            <text class="diagnosis-value corrected">{{record.correctedCause}}</text>
          </view>
        </view>
        
        <!-- 修正详情 -->
        <view class="divider-line" wx:if="{{record.correctionReason}}"></view>
        <view class="info-row" wx:if="{{record.correctionReason}}">
          <text class="info-label">修正依据：</text>
          <text class="info-value">{{record.correctionReason}}</text>
        </view>
        <view class="divider-line" wx:if="{{record.correctedByName || record.correctedBy}}"></view>
        <view class="info-row" wx:if="{{record.correctedByName || record.correctedBy}}">
          <text class="info-label">修正人：</text>
          <text class="info-value">{{record.correctedByName || record.correctedBy}}</text>
        </view>
        <view class="divider-line" wx:if="{{record.correctedAt}}"></view>
        <view class="info-row" wx:if="{{record.correctedAt}}">
          <text class="info-label">修正时间：</text>
          <text class="info-value">{{record.correctedAt}}</text>
        </view>
      </view>
    </view>
  </view>
</bottom-popup>

