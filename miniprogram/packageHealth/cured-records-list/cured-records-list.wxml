<!-- miniprogram/packageHealth/cured-records-list/cured-records-list.wxml -->
<view class="cured-records-page">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navigation-bar 
    title="æ²»æ„ˆè®°å½•" 
    showBack="{{true}}" 
    fallbackUrl="/pages/health/health" 
  />

  <!-- å ä½åŒºåŸŸ - å¢åŠ å®‰å…¨è¾¹è· -->
  <view style="height: calc(var(--navbar-height, 132rpx) + 32rpx);"></view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="60rpx" text="åŠ è½½ä¸­..." />
  </view>

  <!-- å†…å®¹åŒº -->
  <view class="page-content" wx:else>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-section">
      <view class="stats-grid">
        <view class="stat-card success">
          <view class="stat-info">
            <text class="stat-label">ç´¯è®¡æ²»æ„ˆ</text>
            <text class="stat-value">{{stats.totalCured}}</text>
          </view>
        </view>

        <view class="stat-card primary">
          <view class="stat-info">
            <text class="stat-label">æ²»ç–—æˆæœ¬</text>
            <text class="stat-value">Â¥{{stats.totalCost}}</text>
          </view>
        </view>

        <view class="stat-card warning">
          <view class="stat-info">
            <text class="stat-label">å¹³å‡æˆæœ¬</text>
            <text class="stat-value">Â¥{{stats.avgCostPerAnimal}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-container" wx:if="{{records.length === 0}}">
      <t-empty>
        <view slot="description" class="empty-tip">
          <text class="tip-title">æš‚æ— æ²»æ„ˆè®°å½•</text>
          <text class="tip-subtitle">è¯·åœ¨æ²»ç–—è®°å½•ä¸­ç‚¹å‡»"è®°å½•æ²»æ„ˆ"æŒ‰é’®</text>
          <text class="tip-subtitle">æ²»æ„ˆåçš„è®°å½•å°†åœ¨æ­¤å¤„æ˜¾ç¤º</text>
        </view>
      </t-empty>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view class="records-list" wx:if="{{records.length > 0}}">
      <view 
        class="record-card"
        wx:for="{{records}}"
        wx:key="_id"
        bind:tap="onRecordTap"
        data-id="{{item._id}}"
      >
        <!-- è®°å½•å¤´éƒ¨ -->
        <view class="record-header">
          <view class="record-title-row">
            <text class="record-name">{{item.diagnosis.confirmed || item.diagnosis.preliminary}}</text>
            <t-tag 
              theme="success" 
              size="small" 
              class="status-tag"
            >
              å·²æ²»æ„ˆ
            </t-tag>
          </view>
        </view>

        <!-- è®°å½•å†…å®¹ -->
        <view class="record-content">
          <!-- ç¬¬ä¸€è¡Œï¼šæ²»ç–—ç¼–å· -->
          <view class="info-row" wx:if="{{item.treatmentNumber}}">
            <view class="info-group full-width">
              <text class="info-label">ç¼–å·ï¼š</text>
              <text class="info-value">{{item.treatmentNumber}}</text>
            </view>
          </view>
          
          <!-- ä¿¡æ¯è¡Œï¼šæ‰¹æ¬¡ + æ²»æ„ˆæ•°é‡ + æ²»ç–—æ•°é‡ -->
          <view class="info-row">
            <view class="info-group">
              <text class="info-label">æ‰¹æ¬¡ï¼š</text>
              <text class="info-value">{{item.batchNumber || item.batchId}}</text>
            </view>
            <view class="info-group">
              <text class="info-label">æ²»æ„ˆï¼š</text>
              <text class="info-value cured-count">{{item.outcome.curedCount}} åª</text>
            </view>
            <view class="info-group" wx:if="{{item.outcome.totalTreated}}">
              <text class="info-label">æ²»ç–—ï¼š</text>
              <text class="info-value">{{item.outcome.totalTreated}} åª</text>
            </view>
          </view>

          <!-- åº•éƒ¨ï¼šæ—¥æœŸ + è®°å½•è€… -->
          <view class="record-footer">
            <view class="footer-left">
              <text class="date-text">{{item.treatmentDate}}</text>
              <text class="operator-text" wx:if="{{item.operatorName}}">{{item.operatorName}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ========== æ²»ç–—è¯¦æƒ…åº•éƒ¨å¼¹çª— ========== -->
  <!-- é®ç½©å±‚ -->
  <view 
    class="detail-mask" 
    wx:if="{{showDetailDialog}}"
    bind:tap="closeDetailDialog"
    catchtouchmove="preventTouchMove"
  ></view>
  
  <!-- å¼¹çª—å†…å®¹ -->
  <view class="detail-popup {{showDetailDialog ? 'show' : ''}}" wx:if="{{showDetailDialog && selectedRecord}}">
    <!-- æ ‡é¢˜æ  -->
    <view class="popup-header">
      <text class="popup-title">æ²»ç–—è¯¦æƒ…</text>
      <view class="close-btn" bind:tap="closeDetailDialog">
        <text class="icon-close">Ã—</text>
      </view>
    </view>
    
    <!-- å†…å®¹åŒºåŸŸ -->
    <scroll-view class="popup-content" scroll-y>
      <!-- è¯Šæ–­ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="section-title">è¯Šæ–­ä¿¡æ¯</view>
        <view class="info-card">
          <view class="info-row" wx:if="{{selectedRecord.treatmentNumber}}">
            <text class="info-label">æ²»ç–—ç¼–å·</text>
            <text class="info-value">{{selectedRecord.treatmentNumber}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">è¯Šæ–­ç»“æœ</text>
            <text class="info-value">{{selectedRecord.diagnosis.confirmed || selectedRecord.diagnosis.preliminary}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">é¹…ç¾¤æ‰¹æ¬¡</text>
            <text class="info-value">{{selectedRecord.batchNumber || selectedRecord.batchId}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ²»ç–—ç±»å‹</text>
            <text class="info-value">{{selectedRecord.treatmentType === 'medication' ? 'è¯ç‰©æ²»ç–—' : 'è§‚å¯Ÿè®°å½•'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ²»ç–—æ—¥æœŸ</text>
            <text class="info-value">{{selectedRecord.treatmentDate}}</text>
          </view>
        </view>
      </view>

      <!-- æ²»æ„ˆç»“æœ -->
      <view class="detail-section">
        <view class="section-title">æ²»æ„ˆç»“æœ</view>
        <view class="cure-summary">
          <view class="cure-stat-item primary">
            <text class="stat-label">æ²»æ„ˆæ•°é‡</text>
            <text class="stat-value">{{selectedRecord.outcome.curedCount}} åª</text>
          </view>
          <view class="cure-stat-item" wx:if="{{selectedRecord.outcome.totalTreated > selectedRecord.outcome.curedCount}}">
            <text class="stat-label">æ€»æ²»ç–—æ•°</text>
            <text class="stat-value">{{selectedRecord.outcome.totalTreated}} åª</text>
          </view>
        </view>
      </view>

      <!-- æ²»æ„ˆæˆæœ¬ -->
      <view class="detail-section">
        <view class="section-title">æ²»æ„ˆæˆæœ¬</view>
        <view class="cost-grid">
          <view class="cost-item">
            <text class="cost-label">æ²»æ„ˆæ€»æˆæœ¬</text>
            <text class="cost-value primary">Â¥{{selectedRecord.formattedCuredCost}}</text>
          </view>
          <view class="cost-item" wx:if="{{selectedRecord.formattedMedicationCost > 0}}">
            <text class="cost-label">è¯ç‰©æˆæœ¬</text>
            <text class="cost-value">Â¥{{selectedRecord.formattedMedicationCost}}</text>
          </view>
          <view class="cost-item">
            <text class="cost-label">å•åªæˆæœ¬</text>
            <text class="cost-value">Â¥{{selectedRecord.formattedCostPerAnimal}}</text>
          </view>
        </view>
      </view>

      <!-- æ²»ç–—æ–¹æ¡ˆ -->
      <view class="detail-section" wx:if="{{selectedRecord.treatmentPlan.primary}}">
        <view class="section-title">æ²»ç–—æ–¹æ¡ˆ</view>
        <view class="plan-card">
          <text class="plan-text">{{selectedRecord.treatmentPlan.primary}}</text>
        </view>
      </view>

      <!-- ç”¨è¯è®°å½• -->
      <view class="detail-section" wx:if="{{selectedRecord.medications && selectedRecord.medications.length > 0}}">
        <view class="section-title">ç”¨è¯è®°å½•</view>
        <view class="medication-list">
          <view class="medication-item" wx:for="{{selectedRecord.medications}}" wx:key="index">
            <view class="med-icon">ğŸ’Š</view>
            <view class="med-info">
              <text class="med-name">{{item.name}}</text>
              <text class="med-spec">{{item.quantity}}{{item.unit}}</text>
              <text class="med-dosage" wx:if="{{item.dosage}}">{{item.dosage}}</text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>
</view>

