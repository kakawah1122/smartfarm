<!-- treatment-record.wxml - 治疗记录页面 -->
<view class="page treatment-record-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="治疗记录"
    show-back="true"
    bind:back="goBack"
  />

  <view class="page-content">
    <!-- 基本信息 -->
    <view class="form-section">
      <view class="section-title">基本信息</view>
      
      <!-- 治疗批次 -->
      <view class="form-item">
        <view class="form-label required">治疗批次</view>
        <t-cell 
          title="{{formData.batchId || '请选择治疗批次'}}"
          arrow
          bind:click="showBatchSelector"
          t-class="{{formErrors.batchId ? 'form-cell-error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.batchId}}">{{formErrors.batchId}}</view>
      </view>

      <!-- 诊断结果 -->
      <view class="form-item">
        <view class="form-label-row">
          <view class="form-label required">诊断结果</view>
          <t-tag 
            wx:if="{{isDiagnosisCorrected}}" 
            theme="success" 
            variant="light" 
            size="small"
          >
            已修正
          </t-tag>
        </view>
        <t-input
          value="{{formData.diagnosis}}"
          placeholder="请输入诊断结果"
          data-field="diagnosis"
          bind:change="onFormInput"
          status="{{formErrors.diagnosis ? 'error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.diagnosis}}">{{formErrors.diagnosis}}</view>
        
        <!-- AI诊断置信度显示 -->
        <view class="diagnosis-confidence" wx:if="{{formData.diagnosisConfidence > 0}}">
          <text class="confidence-label">AI诊断置信度：</text>
          <text class="confidence-value {{formData.diagnosisConfidence >= 80 ? 'high' : formData.diagnosisConfidence >= 60 ? 'medium' : 'low'}}">
            {{formData.diagnosisConfidence}}%
          </text>
        </view>
      </view>

      <!-- 治疗类型 -->
      <view class="form-item">
        <view class="form-label">治疗类型</view>
        <view class="treatment-type-grid">
          <view 
            class="treatment-type-item {{formData.treatmentType === item.value ? 'active' : ''}}"
            wx:for="{{treatmentTypeOptions}}"
            wx:key="value"
            data-type="{{item.value}}"
            bind:tap="selectTreatmentType"
          >
            <text class="type-name">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- 治疗日期 -->
      <view class="form-item">
        <view class="form-label required">治疗日期</view>
        <picker 
          mode="date" 
          value="{{formData.treatmentDate}}"
          data-field="treatmentDate"
          bind:change="onDateChange"
        >
          <t-input
            value="{{formData.treatmentDate}}"
            placeholder="请选择治疗开始日期"
            readonly
            suffix-icon="calendar"
            status="{{formErrors.treatmentDate ? 'error' : ''}}"
          />
        </picker>
        <view class="error-text" wx:if="{{formErrors.treatmentDate}}">{{formErrors.treatmentDate}}</view>
      </view>
    </view>

    <!-- 治疗方案 -->
    <view class="form-section">
      <view class="section-title">
        <text wx:if="{{treatmentPlanSource === 'veterinarian'}}">兽医建议治疗方案</text>
        <text wx:elif="{{treatmentPlanSource === 'ai'}}">AI建议治疗方案</text>
        <text wx:else>治疗方案</text>
      </view>
      
      <view class="form-item">
        <t-textarea
          value="{{treatmentPlan.primary}}"
          placeholder="请输入治疗方案"
          maxlength="200"
          data-field="primary"
          bind:change="onTreatmentPlanInput"
        />
        <view class="error-text" wx:if="{{formErrors.treatmentPlan}}">{{formErrors.treatmentPlan}}</view>
      </view>
    </view>

    <!-- 用药管理 - 原生实现 -->
    <view class="form-section">
      <view class="section-title">用药管理</view>
      
      <view class="form-item">
        <picker 
          mode="selector" 
          range="{{filteredMaterials}}" 
          range-key="name"
          value="{{selectedMaterialIndex}}"
          bindchange="onMaterialPickerChange"
        >
          <view class="native-picker">
            {{selectedMaterial ? selectedMaterial.name : (formData.treatmentType === 'isolation' ? '请选择营养品' : '请选择药品或营养品')}}
            <text class="picker-arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-item" wx:if="{{selectedMaterial}}">
        <view class="form-label required">领取数量</view>
        <t-input
          value="{{medicationQuantity}}"
          placeholder="请输入领取数量"
          type="digit"
          bindinput="onMedicationQuantityInput"
        />
        <view class="stock-info" wx:if="{{selectedMaterial}}">
          库存：{{selectedMaterial.currentStock}}{{selectedMaterial.unit}}
        </view>
      </view>
      
      <view class="form-item" wx:if="{{selectedMaterial}}">
        <view class="form-label">用法用量</view>
        <t-input
          value="{{medicationDosage}}"
          placeholder="如：10mg/kg 每日2次 连用7天（可选）"
          bindinput="onMedicationDosageInput"
        />
      </view>
    </view>

    <!-- 备注信息 -->
    <view class="form-section">
      <view class="section-title">备注信息</view>
      <view class="form-item">
        <t-textarea
          value="{{formData.notes}}"
          placeholder="请输入治疗备注（可选）"
          maxlength="300"
          data-field="notes"
          bind:change="onFormInput"
        />
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <t-button 
        theme="light" 
        size="large" 
        bind:tap="resetForm"
        disabled="{{submitting}}"
        wx:if="{{!isEditMode}}"
      >
        重置
      </t-button>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="submitForm"
        loading="{{submitting}}"
      >
        {{isDraft ? '提交治疗方案' : (isEditMode ? '保存修改' : '保存记录')}}
      </t-button>
    </view>
  </view>

</view>
