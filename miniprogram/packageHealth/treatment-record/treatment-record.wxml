<!-- treatment-record.wxml - 治疗记录页面 -->
<view class="page treatment-record-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="治疗记录"
    show-back="true"
    bind:back="goBack"
  />

  <view class="page-content">
    
    <!-- ========== ✅ 查看模式（治疗进展跟进） ========== -->
    <block wx:if="{{viewMode}}">
      <!-- 治疗基本信息（只读） -->
      <view class="view-section">
        <view class="section-title">基本信息</view>
        <view class="info-card">
          <view class="info-row">
            <text class="info-label">治疗批次</text>
            <text class="info-value">{{formData.batchId}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">诊断结果</text>
            <text class="info-value">{{formData.diagnosis}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">治疗类型</text>
            <text class="info-value">{{formData.treatmentType === 'medication' ? '药物治疗' : '隔离观察'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">治疗日期</text>
            <text class="info-value">{{formData.treatmentDate}}</text>
          </view>
        </view>
      </view>

      <!-- 治疗方案（只读） -->
      <view class="view-section">
        <view class="section-title">治疗方案</view>
        <view class="plan-card">
          <text class="plan-text">{{treatmentPlan.primary || '暂无治疗方案'}}</text>
        </view>
      </view>

      <!-- 用药历史 -->
      <view class="view-section medication-history-section">
        <view class="section-title">用药历史</view>
        
        <!-- 用药记录 -->
        <view class="medication-records" wx:if="{{medications.length > 0}}">
          <view class="records-list">
            <view class="record-item" wx:for="{{medications}}" wx:key="index">
              <view class="record-icon">💊</view>
              <view class="record-info">
                <view class="record-header">
                  <text class="record-name">{{item.name}}</text>
                  <text class="record-spec">{{item.quantity}}{{item.unit}}</text>
                </view>
                <text class="record-dosage" wx:if="{{item.dosage}}">{{item.dosage}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="empty-records" wx:else>
          <text class="empty-text">暂无用药记录</text>
        </view>

        <!-- 操作按钮 -->
        <view class="action-buttons">
          <t-button 
            theme="primary" 
            size="large" 
            bind:tap="showContinueTreatmentOptions"
            disabled="{{treatmentProgress.remainingCount <= 0}}"
            block
          >
            进一步治疗
          </t-button>
          <t-button 
            theme="success" 
            size="large" 
            bind:tap="showProgressDialog"
            data-type="cured"
            disabled="{{treatmentProgress.remainingCount <= 0}}"
            block
          >
            记录治愈
          </t-button>
          <t-button 
            theme="danger" 
            size="large" 
            bind:tap="showProgressDialog"
            data-type="died"
            disabled="{{treatmentProgress.remainingCount <= 0}}"
            block
          >
            记录死亡
          </t-button>
        </view>
      </view>

      <!-- 备注 -->
      <view class="view-section" wx:if="{{formData.notes}}">
        <view class="section-title">备注信息</view>
        <view class="notes-card">
          <text class="notes-text">{{formData.notes}}</text>
        </view>
      </view>
    </block>

    <!-- ========== 编辑/创建模式 ========== -->
    <block wx:else>
    <!-- 基本信息 -->
    <view class="form-section">
      <view class="section-title">基本信息</view>
      
      <!-- 治疗批次 -->
      <view class="form-item">
        <view class="form-label required">治疗批次</view>
        <t-cell 
          title="{{formData.batchId || '请选择治疗批次'}}"
          arrow
          bind:click="showBatchSelector"
          t-class="{{formErrors.batchId ? 'form-cell-error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.batchId}}">{{formErrors.batchId}}</view>
      </view>

      <!-- 诊断结果 -->
      <view class="form-item">
        <view class="form-label-row">
          <view class="form-label required">诊断结果</view>
          <t-tag 
            wx:if="{{isDiagnosisCorrected}}" 
            theme="success" 
            variant="light" 
            size="small"
          >
            已修正
          </t-tag>
        </view>
        <t-input
          value="{{formData.diagnosis}}"
          placeholder="请输入诊断结果"
          data-field="diagnosis"
          bind:change="onFormInput"
          status="{{formErrors.diagnosis ? 'error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.diagnosis}}">{{formErrors.diagnosis}}</view>
        
        <!-- AI诊断置信度显示 -->
        <view class="diagnosis-confidence" wx:if="{{formData.diagnosisConfidence > 0}}">
          <text class="confidence-label">AI诊断置信度：</text>
          <text class="confidence-value {{formData.diagnosisConfidence >= 80 ? 'high' : formData.diagnosisConfidence >= 60 ? 'medium' : 'low'}}">
            {{formData.diagnosisConfidence}}%
          </text>
        </view>
      </view>

      <!-- 治疗类型 -->
      <view class="form-item">
        <view class="form-label">治疗类型</view>
        <view class="treatment-type-grid">
          <view 
            class="treatment-type-item {{formData.treatmentType === item.value ? 'active' : ''}}"
            wx:for="{{treatmentTypeOptions}}"
            wx:key="value"
            data-type="{{item.value}}"
            bind:tap="selectTreatmentType"
          >
            <text class="type-name">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- 治疗日期 -->
      <view class="form-item">
        <view class="form-label required">治疗日期</view>
        <picker 
          mode="date" 
          value="{{formData.treatmentDate}}"
          data-field="treatmentDate"
          bind:change="onDateChange"
        >
          <t-input
            value="{{formData.treatmentDate}}"
            placeholder="请选择治疗开始日期"
            readonly
            suffix-icon="calendar"
            status="{{formErrors.treatmentDate ? 'error' : ''}}"
          />
        </picker>
        <view class="error-text" wx:if="{{formErrors.treatmentDate}}">{{formErrors.treatmentDate}}</view>
      </view>
    </view>

    <!-- 治疗方案 -->
    <view class="form-section">
      <view class="section-title">
        <text wx:if="{{treatmentPlanSource === 'veterinarian'}}">兽医建议治疗方案</text>
        <text wx:elif="{{treatmentPlanSource === 'ai'}}">AI建议措施</text>
        <text wx:else>治疗方案</text>
      </view>
      
      <view class="form-item">
        <t-textarea
          value="{{treatmentPlan.primary}}"
          placeholder="请输入治疗方案"
          maxlength="200"
          data-field="primary"
          bind:change="onTreatmentPlanInput"
        />
        <view class="error-text" wx:if="{{formErrors.treatmentPlan}}">{{formErrors.treatmentPlan}}</view>
      </view>
    </view>

    <!-- ✅ AI用药建议（仅显示） -->
    <view class="form-section" wx:if="{{aiMedicationSuggestions.length > 0}}">
      <view class="section-title">AI用药建议</view>
      <view class="ai-medication-suggestions">
        <view class="suggestion-item" wx:for="{{aiMedicationSuggestions}}" wx:key="index">
          <view class="suggestion-header">
            <text class="med-name">💊 {{item.name}}</text>
          </view>
          <view class="suggestion-details">
            <view class="detail-row" wx:if="{{item.dosage}}">
              <text class="detail-label">用量：</text>
              <text class="detail-value">{{item.dosage}}</text>
            </view>
            <view class="detail-row" wx:if="{{item.route}}">
              <text class="detail-label">途径：</text>
              <text class="detail-value">{{item.route}}</text>
            </view>
            <view class="detail-row" wx:if="{{item.frequency}}">
              <text class="detail-label">频次：</text>
              <text class="detail-value">{{item.frequency}}</text>
            </view>
            <view class="detail-row" wx:if="{{item.duration}}">
              <text class="detail-label">疗程：</text>
              <text class="detail-value">{{item.duration}}</text>
            </view>
            <view class="detail-row" wx:if="{{item.notes}}">
              <text class="detail-label">备注：</text>
              <text class="detail-value">{{item.notes}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="ai-suggestion-hint">
        <text class="hint-icon">💡</text>
        <text class="hint-text">以上为AI建议，实际用药请从下方库存中选择</text>
      </view>
    </view>

    <!-- ✅ 用药管理 - 多选联合用药 -->
    <view class="form-section medication-multi-select-section">
      <view class="section-title">用药管理</view>
      
      <!-- 选择药品 -->
      <view class="form-item">
        <view class="form-label">选择药品</view>
        <picker 
          mode="selector" 
          range="{{filteredMaterials}}" 
          range-key="name"
          value="{{currentMedicationForm.materialIndex}}"
          bindchange="onInitialMedicationChange"
        >
          <view class="native-picker">
            {{formData.treatmentType === 'isolation' ? '请选择营养品' : '请选择药品或营养品'}}
            <text class="picker-arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <!-- 已选择的药品列表 -->
      <view class="selected-medications-list" wx:if="{{initialMedications.length > 0}}">
        <view class="medication-card-new" style="padding: 32rpx; margin-bottom: 16rpx; background: #fff; border-radius: 16rpx; border: 2rpx solid #e8eaed;" wx:for="{{initialMedications}}" wx:key="materialId">
          <!-- 头部：药品名称和删除按钮 -->
          <view class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20rpx; padding-bottom: 16rpx; border-bottom: 2rpx solid #f5f6f7;">
            <view class="drug-info" style="flex: 1;">
              <text class="drug-name" style="font-size: 30rpx; font-weight: normal; color: #1a1a1a; display: block;">{{item.materialName}}</text>
            </view>
            <view class="delete-icon" style="width: 56rpx; height: 56rpx; display: flex; align-items: center; justify-content: center; background: #fff1f0; border-radius: 50%; margin-left: 16rpx;" bind:tap="removeInitialMedication" data-index="{{index}}">
              <text class="icon-close" style="font-size: 56rpx; color: #ff4d4f; line-height: 1; font-weight: 300;">×</text>
            </view>
          </view>
          
          <!-- 药品信息输入 -->
          <view class="medication-inputs-simple">
            <!-- 数量行 -->
            <view class="input-row-simple" style="display: flex; align-items: center; margin-bottom: 20rpx;">
              <text class="label-simple" style="width: 90rpx; font-size: 28rpx; font-weight: normal; color: #1a1a1a; margin-right: 16rpx;">数量</text>
              <input
                class="input-field-simple"
                style="flex: 1; height: 70rpx; padding: 0 24rpx; font-size: 28rpx; color: #1a1a1a; background: #f7f8fa; border-radius: 12rpx; border: 2rpx solid #e8eaed;"
                value="{{item.quantity}}"
                placeholder="请输入数量（库存: {{item.currentStock}}{{item.unit}}）"
                type="digit"
                data-index="{{index}}"
                data-field="quantity"
                bind:input="onInitialMedicationInput"
              />
              <text class="unit-simple" style="font-size: 26rpx; color: #646566; margin-left: 16rpx;">{{item.unit}}</text>
            </view>
            
            <!-- 用法行 -->
            <view class="input-row-simple" style="display: flex; align-items: center;">
              <text class="label-simple" style="width: 90rpx; font-size: 28rpx; font-weight: normal; color: #1a1a1a; margin-right: 16rpx;">用法</text>
              <input
                class="input-field-simple full-width"
                style="flex: 1; height: 70rpx; padding: 0 24rpx; font-size: 28rpx; color: #1a1a1a; background: #f7f8fa; border-radius: 12rpx; border: 2rpx solid #e8eaed;"
                value="{{item.dosage}}"
                placeholder="如：10mg/kg 每日2次"
                data-index="{{index}}"
                data-field="dosage"
                bind:input="onInitialMedicationInput"
              />
            </view>
          </view>
        </view>
      </view>
      
      <!-- 空状态提示 -->
      <view class="empty-medications" wx:else>
        <text class="empty-text">暂无选择药品，请选择并添加</text>
      </view>
    </view>

    <!-- 备注信息 -->
    <view class="form-section">
      <view class="section-title">备注信息</view>
      <view class="form-item">
        <t-textarea
          value="{{formData.notes}}"
          placeholder="请输入治疗备注（可选）"
          maxlength="300"
          data-field="notes"
          bind:change="onFormInput"
        />
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <t-button 
        theme="light" 
        size="large" 
        bind:tap="resetForm"
        disabled="{{submitting}}"
        wx:if="{{!isEditMode}}"
      >
        重置
      </t-button>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="submitForm"
        loading="{{submitting}}"
      >
        {{isDraft ? '提交治疗方案' : (isEditMode ? '保存修改' : '保存记录')}}
      </t-button>
    </view>
    </block>
    <!-- ========== 编辑/创建模式结束 ========== -->
  </view>

  <!-- ========== ✅ 治疗进展自定义弹窗 ========== -->
  <!-- 遮罩层 -->
  <view 
    class="progress-mask" 
    wx:if="{{showProgressDialog}}"
    bind:tap="closeProgressDialog"
    catchtouchmove="preventTouchMove"
  ></view>
  
  <!-- 弹窗内容 -->
  <view class="progress-popup {{showProgressDialog ? 'show' : ''}}" wx:if="{{showProgressDialog}}">
    <!-- 标题栏 -->
    <view class="popup-header">
      <text class="popup-title">{{progressDialogType === 'cured' ? '记录治愈' : '记录死亡'}}</text>
      <view class="close-btn" bind:tap="closeProgressDialog">
        <text class="icon-close">×</text>
      </view>
    </view>
    
    <!-- 内容区域 -->
    <scroll-view class="popup-content" scroll-y>
      <!-- 剩余数量提示 -->
      <view class="dialog-hint">
        <text class="hint-text">当前剩余治疗数：</text>
        <text class="hint-value">{{treatmentProgress.remainingCount}} 只</text>
      </view>

      <!-- 数量输入 -->
      <view class="dialog-field">
        <view class="field-label required">
          {{progressDialogType === 'cured' ? '治愈数量' : '死亡数量'}}
        </view>
        <view class="count-input-row">
          <input
            class="count-input"
            value="{{progressForm.count}}"
            placeholder="{{progressDialogType === 'cured' ? '输入治愈的只数' : '输入死亡的只数'}}"
            type="digit"
            data-field="count"
            bind:input="onProgressFormInput"
          />
          <view class="all-btn" bind:tap="fillAllCount">
            <text>全部</text>
          </view>
        </view>
        <text class="field-hint">可输入1-{{treatmentProgress.remainingCount}}只</text>
      </view>

      <!-- 死亡原因（仅死亡时显示） -->
      <view class="dialog-field" wx:if="{{progressDialogType === 'died'}}">
        <view class="field-label">死亡原因</view>
        <textarea
          class="field-textarea"
          value="{{progressForm.deathCause}}"
          placeholder="请填写死亡原因（可选）"
          maxlength="200"
          data-field="deathCause"
          bind:input="onProgressFormInput"
        />
      </view>

      <!-- 备注（可选） -->
      <view class="dialog-field">
        <view class="field-label">备注</view>
        <textarea
          class="field-textarea"
          value="{{progressForm.notes}}"
          placeholder="补充说明（可选）"
          maxlength="200"
          data-field="notes"
          bind:input="onProgressFormInput"
        />
      </view>
    </scroll-view>
    
    <!-- 底部按钮 -->
    <view class="popup-footer">
      <view class="footer-btn cancel-btn" bind:tap="closeProgressDialog">
        <text>取消</text>
      </view>
      <view class="footer-btn confirm-btn" bind:tap="submitProgress">
        <text>确认</text>
      </view>
    </view>
  </view>

  <!-- ========== ✅ 进一步治疗一体化底部弹窗 ========== -->
  <!-- 遮罩层 -->
  <view 
    class="treatment-mask" 
    wx:if="{{showContinueTreatmentDialog}}"
    bind:tap="closeContinueTreatmentDialog"
  ></view>
  
  <!-- 底部弹窗 -->
  <view class="treatment-sheet {{showContinueTreatmentDialog ? 'show' : ''}}">
    <view class="sheet-header">
      <text class="sheet-title">进一步治疗</text>
      <view class="close-btn" bind:tap="closeContinueTreatmentDialog">
        <t-icon name="close" size="48rpx" />
      </view>
    </view>
    
    <scroll-view scroll-y class="sheet-scroll">
      <!-- 治疗笔记 -->
      <view class="form-section-inline">
        <view class="section-title-inline">
          <text class="title-icon">📝</text>
          <text class="title-text">治疗笔记</text>
          <text class="title-optional">（可选）</text>
        </view>
        <t-textarea
          value="{{noteForm.content}}"
          placeholder="记录治疗观察、病情变化、食欲情况等"
          maxlength="500"
          data-field="content"
          bind:change="onNoteFormInput"
        />
      </view>
      
      <!-- 追加用药 -->
      <view class="form-section-inline">
        <view class="section-title-inline">
          <text class="title-icon">💊</text>
          <text class="title-text">追加用药</text>
          <text class="title-optional">（可选，支持联合用药）</text>
        </view>
        
        <!-- ✅ 已选择的药品列表（统一样式） -->
        <view class="medication-card-new" style="padding: 32rpx; margin-bottom: 16rpx; background: #fff; border-radius: 16rpx; border: 2rpx solid #e8eaed;" wx:for="{{selectedMedications}}" wx:key="materialId">
          <!-- 头部：药品名称和删除按钮 -->
          <view class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20rpx; padding-bottom: 16rpx; border-bottom: 2rpx solid #f5f6f7;">
            <view class="drug-info" style="flex: 1;">
              <text class="drug-name" style="font-size: 30rpx; font-weight: normal; color: #1a1a1a; display: block;">{{item.materialName}}</text>
            </view>
            <view class="delete-icon" style="width: 56rpx; height: 56rpx; display: flex; align-items: center; justify-content: center; background: #fff1f0; border-radius: 50%; margin-left: 16rpx;" bind:tap="removeMedication" data-index="{{index}}">
              <text class="icon-close" style="font-size: 56rpx; color: #ff4d4f; line-height: 1; font-weight: 300;">×</text>
            </view>
          </view>

          <!-- 药品信息输入 -->
          <view class="medication-inputs-simple">
            <!-- 数量行 -->
            <view class="input-row-simple" style="display: flex; align-items: center; margin-bottom: 20rpx;">
              <text class="label-simple" style="width: 90rpx; font-size: 28rpx; font-weight: normal; color: #1a1a1a; margin-right: 16rpx;">数量</text>
              <input
                class="input-field-simple"
                style="flex: 1; height: 70rpx; padding: 0 24rpx; font-size: 28rpx; color: #1a1a1a; background: #f7f8fa; border-radius: 12rpx; border: 2rpx solid #e8eaed;"
                value="{{item.quantity}}"
                placeholder="请输入数量（库存: {{item.currentStock}}{{item.unit}}）"
                type="digit"
                data-index="{{index}}"
                data-field="quantity"
                bind:input="onSelectedMedicationInput"
              />
              <text class="unit-simple" style="font-size: 26rpx; color: #646566; margin-left: 16rpx;">{{item.unit}}</text>
            </view>

            <!-- 用法行 -->
            <view class="input-row-simple" style="display: flex; align-items: center;">
              <text class="label-simple" style="width: 90rpx; font-size: 28rpx; font-weight: normal; color: #1a1a1a; margin-right: 16rpx;">用法</text>
              <input
                class="input-field-simple full-width"
                style="flex: 1; height: 70rpx; padding: 0 24rpx; font-size: 28rpx; color: #1a1a1a; background: #f7f8fa; border-radius: 12rpx; border: 2rpx solid #e8eaed;"
                value="{{item.dosage}}"
                placeholder="如：10mg/kg 每日2次"
                data-index="{{index}}"
                data-field="dosage"
                bind:input="onSelectedMedicationInput"
              />
            </view>
          </view>
        </view>
        
        <!-- ✅ 添加药品区域（去掉按钮） -->
        <view class="add-medication-area">
          <view class="form-item-inline">
            <view class="form-label-inline">
              <text>选择药品/营养品</text>
              <text class="add-hint" wx:if="{{selectedMedications.length > 0}}">（继续添加）</text>
            </view>
            <picker 
              mode="selector" 
              range="{{filteredMaterials}}" 
              range-key="name"
              bindchange="onAddMedicationMaterialChange"
            >
              <view class="native-picker">
                请选择药品或营养品
                <text class="picker-arrow">▼</text>
              </view>
            </picker>
          </view>
        </view>
      </view>
      
      <view class="form-hint-inline">
        <text class="hint-icon">💡</text>
        <text class="hint-text">至少填写一项内容，会记录在治疗历史中</text>
      </view>
    </scroll-view>
    
    <!-- 底部按钮 -->
    <view class="sheet-footer">
      <t-button 
        theme="primary" 
        size="large" 
        block
        bind:tap="submitContinueTreatment"
      >
        确认提交
      </t-button>
    </view>
  </view>

</view>
