<!-- treatment-record.wxml - æ²»ç–—è®°å½•é¡µé¢ -->
<view class="page treatment-record-page">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar 
    title="æ²»ç–—è®°å½•"
    show-back="true"
    bind:back="goBack"
  />

  <view class="page-content">
    
    <!-- ========== âœ… æŸ¥çœ‹æ¨¡å¼ï¼ˆæ²»ç–—è¿›å±•è·Ÿè¿›ï¼‰ ========== -->
    <block wx:if="{{viewMode}}">
      <!-- æ²»ç–—åŸºæœ¬ä¿¡æ¯ï¼ˆåªè¯»ï¼‰ -->
      <view class="view-section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="info-card">
          <view class="info-row">
            <text class="info-label">æ²»ç–—æ‰¹æ¬¡</text>
            <text class="info-value">{{formData.batchId}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">è¯Šæ–­ç»“æœ</text>
            <text class="info-value">{{formData.diagnosis}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ²»ç–—ç±»å‹</text>
            <text class="info-value">{{formData.treatmentType === 'medication' ? 'è¯ç‰©æ²»ç–—' : 'éš”ç¦»è§‚å¯Ÿ'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ²»ç–—æ—¥æœŸ</text>
            <text class="info-value">{{formData.treatmentDate}}</text>
          </view>
        </view>
      </view>

      <!-- æ²»ç–—æ–¹æ¡ˆï¼ˆåªè¯»ï¼‰ -->
      <view class="view-section">
        <view class="section-title">æ²»ç–—æ–¹æ¡ˆ</view>
        <view class="plan-card">
          <text class="plan-text">{{treatmentPlan.primary || 'æš‚æ— æ²»ç–—æ–¹æ¡ˆ'}}</text>
        </view>
      </view>

      <!-- ç”¨è¯æƒ…å†µï¼ˆåªè¯»ï¼‰ -->
      <view class="view-section" wx:if="{{medications.length > 0}}">
        <view class="section-title">ç”¨è¯æƒ…å†µ</view>
        <view class="medications-list">
          <view class="medication-item" wx:for="{{medications}}" wx:key="index">
            <view class="med-name">{{item.name}}</view>
            <view class="med-detail">
              <text wx:if="{{item.quantity}}">æ•°é‡ï¼š{{item.quantity}}{{item.unit}}</text>
              <text wx:if="{{item.dosage}}">ã€€ç”¨æ³•ï¼š{{item.dosage}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ²»ç–—è¿›å±•è·Ÿè¿› -->
      <view class="view-section progress-section">
        <view class="section-title">æ²»ç–—è¿›å±•</view>
        
        <view class="progress-card">
          <!-- æ²»ç–—å¤©æ•° -->
          <view class="progress-header">
            <text class="treatment-days">å·²æ²»ç–— {{treatmentProgress.treatmentDays}} å¤©</text>
            <t-tag theme="primary" size="small">è¿›è¡Œä¸­</t-tag>
          </view>

          <!-- ç”¨è¯è®°å½• -->
          <view class="medication-records" wx:if="{{medications.length > 0}}">
            <view class="records-title">ç”¨è¯è®°å½•</view>
            <view class="records-list">
              <view class="record-item" wx:for="{{medications}}" wx:key="index">
                <view class="record-icon">ğŸ’Š</view>
                <view class="record-info">
                  <text class="record-name">{{item.name}}</text>
                  <text class="record-spec">{{item.quantity}}{{item.unit}}</text>
                </view>
                <view class="record-dosage" wx:if="{{item.dosage}}">
                  <text>{{item.dosage}}</text>
                </view>
              </view>
            </view>
          </view>

          <!-- è¿›åº¦ç»Ÿè®¡ -->
          <view class="progress-stats">
            <view class="stat-item">
              <text class="stat-label">æ²»ç–—æ€»æ•°</text>
              <text class="stat-value total">{{treatmentProgress.totalTreated}} åª</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">å·²æ²»æ„ˆ</text>
              <text class="stat-value cured">{{treatmentProgress.curedCount}} åª</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">æ­»äº¡</text>
              <text class="stat-value died">{{treatmentProgress.deathCount}} åª</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">ç»§ç»­æ²»ç–—</text>
              <text class="stat-value remaining">{{treatmentProgress.remainingCount}} åª</text>
            </view>
          </view>

          <!-- è¿›åº¦æ¡ -->
          <view class="progress-bar">
            <view class="bar-cured" style="width: {{treatmentProgress.cureRate}}%"></view>
            <view class="bar-died" style="width: {{treatmentProgress.mortalityRate}}%"></view>
          </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="progress-actions">
            <t-button 
              theme="success" 
              size="large" 
              bind:tap="showProgressDialog"
              data-type="cured"
              disabled="{{treatmentProgress.remainingCount <= 0}}"
              block
            >
              è®°å½•æ²»æ„ˆ
            </t-button>
            <t-button 
              theme="danger" 
              size="large" 
              bind:tap="showProgressDialog"
              data-type="died"
              disabled="{{treatmentProgress.remainingCount <= 0}}"
              block
            >
              è®°å½•æ­»äº¡
            </t-button>
          </view>
        </view>
      </view>

      <!-- å¤‡æ³¨ -->
      <view class="view-section" wx:if="{{formData.notes}}">
        <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
        <view class="notes-card">
          <text class="notes-text">{{formData.notes}}</text>
        </view>
      </view>
    </block>

    <!-- ========== ç¼–è¾‘/åˆ›å»ºæ¨¡å¼ ========== -->
    <block wx:else>
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      
      <!-- æ²»ç–—æ‰¹æ¬¡ -->
      <view class="form-item">
        <view class="form-label required">æ²»ç–—æ‰¹æ¬¡</view>
        <t-cell 
          title="{{formData.batchId || 'è¯·é€‰æ‹©æ²»ç–—æ‰¹æ¬¡'}}"
          arrow
          bind:click="showBatchSelector"
          t-class="{{formErrors.batchId ? 'form-cell-error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.batchId}}">{{formErrors.batchId}}</view>
      </view>

      <!-- è¯Šæ–­ç»“æœ -->
      <view class="form-item">
        <view class="form-label-row">
          <view class="form-label required">è¯Šæ–­ç»“æœ</view>
          <t-tag 
            wx:if="{{isDiagnosisCorrected}}" 
            theme="success" 
            variant="light" 
            size="small"
          >
            å·²ä¿®æ­£
          </t-tag>
        </view>
        <t-input
          value="{{formData.diagnosis}}"
          placeholder="è¯·è¾“å…¥è¯Šæ–­ç»“æœ"
          data-field="diagnosis"
          bind:change="onFormInput"
          status="{{formErrors.diagnosis ? 'error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.diagnosis}}">{{formErrors.diagnosis}}</view>
        
        <!-- AIè¯Šæ–­ç½®ä¿¡åº¦æ˜¾ç¤º -->
        <view class="diagnosis-confidence" wx:if="{{formData.diagnosisConfidence > 0}}">
          <text class="confidence-label">AIè¯Šæ–­ç½®ä¿¡åº¦ï¼š</text>
          <text class="confidence-value {{formData.diagnosisConfidence >= 80 ? 'high' : formData.diagnosisConfidence >= 60 ? 'medium' : 'low'}}">
            {{formData.diagnosisConfidence}}%
          </text>
        </view>
      </view>

      <!-- æ²»ç–—ç±»å‹ -->
      <view class="form-item">
        <view class="form-label">æ²»ç–—ç±»å‹</view>
        <view class="treatment-type-grid">
          <view 
            class="treatment-type-item {{formData.treatmentType === item.value ? 'active' : ''}}"
            wx:for="{{treatmentTypeOptions}}"
            wx:key="value"
            data-type="{{item.value}}"
            bind:tap="selectTreatmentType"
          >
            <text class="type-name">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- æ²»ç–—æ—¥æœŸ -->
      <view class="form-item">
        <view class="form-label required">æ²»ç–—æ—¥æœŸ</view>
        <picker 
          mode="date" 
          value="{{formData.treatmentDate}}"
          data-field="treatmentDate"
          bind:change="onDateChange"
        >
          <t-input
            value="{{formData.treatmentDate}}"
            placeholder="è¯·é€‰æ‹©æ²»ç–—å¼€å§‹æ—¥æœŸ"
            readonly
            suffix-icon="calendar"
            status="{{formErrors.treatmentDate ? 'error' : ''}}"
          />
        </picker>
        <view class="error-text" wx:if="{{formErrors.treatmentDate}}">{{formErrors.treatmentDate}}</view>
      </view>
    </view>

    <!-- æ²»ç–—æ–¹æ¡ˆ -->
    <view class="form-section">
      <view class="section-title">
        <text wx:if="{{treatmentPlanSource === 'veterinarian'}}">å…½åŒ»å»ºè®®æ²»ç–—æ–¹æ¡ˆ</text>
        <text wx:elif="{{treatmentPlanSource === 'ai'}}">AIå»ºè®®æ²»ç–—æ–¹æ¡ˆ</text>
        <text wx:else>æ²»ç–—æ–¹æ¡ˆ</text>
      </view>
      
      <view class="form-item">
        <t-textarea
          value="{{treatmentPlan.primary}}"
          placeholder="è¯·è¾“å…¥æ²»ç–—æ–¹æ¡ˆ"
          maxlength="200"
          data-field="primary"
          bind:change="onTreatmentPlanInput"
        />
        <view class="error-text" wx:if="{{formErrors.treatmentPlan}}">{{formErrors.treatmentPlan}}</view>
      </view>
    </view>

    <!-- ç”¨è¯ç®¡ç† - åŸç”Ÿå®ç° -->
    <view class="form-section">
      <view class="section-title">ç”¨è¯ç®¡ç†</view>
      
      <view class="form-item">
        <picker 
          mode="selector" 
          range="{{filteredMaterials}}" 
          range-key="name"
          value="{{selectedMaterialIndex}}"
          bindchange="onMaterialPickerChange"
        >
          <view class="native-picker">
            {{selectedMaterial ? selectedMaterial.name : (formData.treatmentType === 'isolation' ? 'è¯·é€‰æ‹©è¥å…»å“' : 'è¯·é€‰æ‹©è¯å“æˆ–è¥å…»å“')}}
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-item" wx:if="{{selectedMaterial}}">
        <view class="form-label required">é¢†å–æ•°é‡</view>
        <t-input
          value="{{medicationQuantity}}"
          placeholder="è¯·è¾“å…¥é¢†å–æ•°é‡"
          type="digit"
          bindinput="onMedicationQuantityInput"
        />
        <view class="stock-info" wx:if="{{selectedMaterial}}">
          åº“å­˜ï¼š{{selectedMaterial.currentStock}}{{selectedMaterial.unit}}
        </view>
      </view>
      
      <view class="form-item" wx:if="{{selectedMaterial}}">
        <view class="form-label">ç”¨æ³•ç”¨é‡</view>
        <t-input
          value="{{medicationDosage}}"
          placeholder="å¦‚ï¼š10mg/kg æ¯æ—¥2æ¬¡ è¿ç”¨7å¤©ï¼ˆå¯é€‰ï¼‰"
          bindinput="onMedicationDosageInput"
        />
      </view>
    </view>

    <!-- å¤‡æ³¨ä¿¡æ¯ -->
    <view class="form-section">
      <view class="section-title">å¤‡æ³¨ä¿¡æ¯</view>
      <view class="form-item">
        <t-textarea
          value="{{formData.notes}}"
          placeholder="è¯·è¾“å…¥æ²»ç–—å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
          maxlength="300"
          data-field="notes"
          bind:change="onFormInput"
        />
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <t-button 
        theme="light" 
        size="large" 
        bind:tap="resetForm"
        disabled="{{submitting}}"
        wx:if="{{!isEditMode}}"
      >
        é‡ç½®
      </t-button>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="submitForm"
        loading="{{submitting}}"
      >
        {{isDraft ? 'æäº¤æ²»ç–—æ–¹æ¡ˆ' : (isEditMode ? 'ä¿å­˜ä¿®æ”¹' : 'ä¿å­˜è®°å½•')}}
      </t-button>
    </view>
    </block>
    <!-- ========== ç¼–è¾‘/åˆ›å»ºæ¨¡å¼ç»“æŸ ========== -->
  </view>

  <!-- ========== âœ… æ²»ç–—è¿›å±•å¯¹è¯æ¡† ========== -->
  <t-dialog
    visible="{{showProgressDialog}}"
    title="{{progressDialogType === 'cured' ? 'è®°å½•æ²»æ„ˆ' : 'è®°å½•æ­»äº¡'}}"
    confirm-btn="ç¡®è®¤"
    cancel-btn="å–æ¶ˆ"
    bind:confirm="submitProgress"
    bind:cancel="closeProgressDialog"
  >
    <view class="progress-dialog-content">
      <!-- å‰©ä½™æ•°é‡æç¤º -->
      <view class="dialog-hint">
        <text class="hint-text">å½“å‰å‰©ä½™æ²»ç–—æ•°ï¼š</text>
        <text class="hint-value">{{treatmentProgress.remainingCount}} åª</text>
      </view>

      <!-- æ•°é‡è¾“å…¥ -->
      <view class="dialog-field">
        <view class="field-label required">
          {{progressDialogType === 'cured' ? 'æ²»æ„ˆæ•°é‡' : 'æ­»äº¡æ•°é‡'}}
        </view>
        <t-input
          value="{{progressForm.count}}"
          placeholder="è¯·è¾“å…¥æ•°é‡"
          type="digit"
          data-field="count"
          bind:change="onProgressFormInput"
        />
      </view>

      <!-- æ­»äº¡åŸå› ï¼ˆä»…æ­»äº¡æ—¶æ˜¾ç¤ºï¼‰ -->
      <view class="dialog-field" wx:if="{{progressDialogType === 'died'}}">
        <view class="field-label required">æ­»äº¡åŸå› </view>
        <t-textarea
          value="{{progressForm.deathCause}}"
          placeholder="è¯·å¡«å†™æ­»äº¡åŸå› "
          maxlength="200"
          data-field="deathCause"
          bind:change="onProgressFormInput"
        />
      </view>

      <!-- å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰ -->
      <view class="dialog-field">
        <view class="field-label">å¤‡æ³¨</view>
        <t-textarea
          value="{{progressForm.notes}}"
          placeholder="è¡¥å……è¯´æ˜ï¼ˆå¯é€‰ï¼‰"
          maxlength="200"
          data-field="notes"
          bind:change="onProgressFormInput"
        />
      </view>
    </view>
  </t-dialog>

</view>
