<!-- treatment-record.wxml - 治疗记录页面 -->
<view class="page treatment-record-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="治疗记录"
    show-back="true"
    bind:back="goBack"
  />

  <view class="page-content">
    
    <!-- ========== ✅ 查看模式（治疗进展跟进） ========== -->
    <block wx:if="{{viewMode}}">
      <!-- 治疗基本信息（只读） -->
      <view class="view-section">
        <view class="section-title">基本信息</view>
        <view class="info-card">
          <view class="info-row">
            <text class="info-label">治疗批次</text>
            <text class="info-value">{{formData.batchId}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">诊断结果</text>
            <text class="info-value">{{formData.diagnosis}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">治疗类型</text>
            <text class="info-value">{{formData.treatmentType === 'medication' ? '药物治疗' : '隔离观察'}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">治疗日期</text>
            <text class="info-value">{{formData.treatmentDate}}</text>
          </view>
        </view>
      </view>

      <!-- 治疗方案（只读） -->
      <view class="view-section">
        <view class="section-title">治疗方案</view>
        <view class="plan-card">
          <text class="plan-text">{{treatmentPlan.primary || '暂无治疗方案'}}</text>
        </view>
      </view>

      <!-- 用药情况（只读） -->
      <view class="view-section" wx:if="{{medications.length > 0}}">
        <view class="section-title">用药情况</view>
        <view class="medications-list">
          <view class="medication-item" wx:for="{{medications}}" wx:key="index">
            <view class="med-name">{{item.name}}</view>
            <view class="med-detail">
              <text wx:if="{{item.quantity}}">数量：{{item.quantity}}{{item.unit}}</text>
              <text wx:if="{{item.dosage}}">　用法：{{item.dosage}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 治疗进展跟进 -->
      <view class="view-section progress-section">
        <view class="section-title">治疗进展</view>
        
        <view class="progress-card">
          <!-- 治疗天数 -->
          <view class="progress-header">
            <text class="treatment-days">已治疗 {{treatmentProgress.treatmentDays}} 天</text>
            <t-tag theme="primary" size="small">进行中</t-tag>
          </view>

          <!-- 进度统计 -->
          <view class="progress-stats">
            <view class="stat-item">
              <text class="stat-label">治疗总数</text>
              <text class="stat-value total">{{treatmentProgress.totalTreated}} 只</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">已治愈</text>
              <text class="stat-value cured">{{treatmentProgress.curedCount}} 只</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">死亡</text>
              <text class="stat-value died">{{treatmentProgress.deathCount}} 只</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">继续治疗</text>
              <text class="stat-value remaining">{{treatmentProgress.remainingCount}} 只</text>
            </view>
          </view>

          <!-- 进度条 -->
          <view class="progress-bar">
            <view class="bar-cured" style="width: {{treatmentProgress.cureRate}}%"></view>
            <view class="bar-died" style="width: {{treatmentProgress.mortalityRate}}%"></view>
          </view>

          <!-- 操作按钮 -->
          <view class="progress-actions">
            <t-button 
              theme="success" 
              size="large" 
              bind:tap="showProgressDialog"
              data-type="cured"
              disabled="{{treatmentProgress.remainingCount <= 0}}"
              block
            >
              记录治愈
            </t-button>
            <t-button 
              theme="danger" 
              size="large" 
              bind:tap="showProgressDialog"
              data-type="died"
              disabled="{{treatmentProgress.remainingCount <= 0}}"
              block
            >
              记录死亡
            </t-button>
          </view>
        </view>
      </view>

      <!-- 备注 -->
      <view class="view-section" wx:if="{{formData.notes}}">
        <view class="section-title">备注信息</view>
        <view class="notes-card">
          <text class="notes-text">{{formData.notes}}</text>
        </view>
      </view>
    </block>

    <!-- ========== 编辑/创建模式 ========== -->
    <block wx:else>
    <!-- 基本信息 -->
    <view class="form-section">
      <view class="section-title">基本信息</view>
      
      <!-- 治疗批次 -->
      <view class="form-item">
        <view class="form-label required">治疗批次</view>
        <t-cell 
          title="{{formData.batchId || '请选择治疗批次'}}"
          arrow
          bind:click="showBatchSelector"
          t-class="{{formErrors.batchId ? 'form-cell-error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.batchId}}">{{formErrors.batchId}}</view>
      </view>

      <!-- 诊断结果 -->
      <view class="form-item">
        <view class="form-label-row">
          <view class="form-label required">诊断结果</view>
          <t-tag 
            wx:if="{{isDiagnosisCorrected}}" 
            theme="success" 
            variant="light" 
            size="small"
          >
            已修正
          </t-tag>
        </view>
        <t-input
          value="{{formData.diagnosis}}"
          placeholder="请输入诊断结果"
          data-field="diagnosis"
          bind:change="onFormInput"
          status="{{formErrors.diagnosis ? 'error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.diagnosis}}">{{formErrors.diagnosis}}</view>
        
        <!-- AI诊断置信度显示 -->
        <view class="diagnosis-confidence" wx:if="{{formData.diagnosisConfidence > 0}}">
          <text class="confidence-label">AI诊断置信度：</text>
          <text class="confidence-value {{formData.diagnosisConfidence >= 80 ? 'high' : formData.diagnosisConfidence >= 60 ? 'medium' : 'low'}}">
            {{formData.diagnosisConfidence}}%
          </text>
        </view>
      </view>

      <!-- 治疗类型 -->
      <view class="form-item">
        <view class="form-label">治疗类型</view>
        <view class="treatment-type-grid">
          <view 
            class="treatment-type-item {{formData.treatmentType === item.value ? 'active' : ''}}"
            wx:for="{{treatmentTypeOptions}}"
            wx:key="value"
            data-type="{{item.value}}"
            bind:tap="selectTreatmentType"
          >
            <text class="type-name">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- 治疗日期 -->
      <view class="form-item">
        <view class="form-label required">治疗日期</view>
        <picker 
          mode="date" 
          value="{{formData.treatmentDate}}"
          data-field="treatmentDate"
          bind:change="onDateChange"
        >
          <t-input
            value="{{formData.treatmentDate}}"
            placeholder="请选择治疗开始日期"
            readonly
            suffix-icon="calendar"
            status="{{formErrors.treatmentDate ? 'error' : ''}}"
          />
        </picker>
        <view class="error-text" wx:if="{{formErrors.treatmentDate}}">{{formErrors.treatmentDate}}</view>
      </view>
    </view>

    <!-- 治疗方案 -->
    <view class="form-section">
      <view class="section-title">
        <text wx:if="{{treatmentPlanSource === 'veterinarian'}}">兽医建议治疗方案</text>
        <text wx:elif="{{treatmentPlanSource === 'ai'}}">AI建议治疗方案</text>
        <text wx:else>治疗方案</text>
      </view>
      
      <view class="form-item">
        <t-textarea
          value="{{treatmentPlan.primary}}"
          placeholder="请输入治疗方案"
          maxlength="200"
          data-field="primary"
          bind:change="onTreatmentPlanInput"
        />
        <view class="error-text" wx:if="{{formErrors.treatmentPlan}}">{{formErrors.treatmentPlan}}</view>
      </view>
    </view>

    <!-- 用药管理 - 原生实现 -->
    <view class="form-section">
      <view class="section-title">用药管理</view>
      
      <view class="form-item">
        <picker 
          mode="selector" 
          range="{{filteredMaterials}}" 
          range-key="name"
          value="{{selectedMaterialIndex}}"
          bindchange="onMaterialPickerChange"
        >
          <view class="native-picker">
            {{selectedMaterial ? selectedMaterial.name : (formData.treatmentType === 'isolation' ? '请选择营养品' : '请选择药品或营养品')}}
            <text class="picker-arrow">▼</text>
          </view>
        </picker>
      </view>
      
      <view class="form-item" wx:if="{{selectedMaterial}}">
        <view class="form-label required">领取数量</view>
        <t-input
          value="{{medicationQuantity}}"
          placeholder="请输入领取数量"
          type="digit"
          bindinput="onMedicationQuantityInput"
        />
        <view class="stock-info" wx:if="{{selectedMaterial}}">
          库存：{{selectedMaterial.currentStock}}{{selectedMaterial.unit}}
        </view>
      </view>
      
      <view class="form-item" wx:if="{{selectedMaterial}}">
        <view class="form-label">用法用量</view>
        <t-input
          value="{{medicationDosage}}"
          placeholder="如：10mg/kg 每日2次 连用7天（可选）"
          bindinput="onMedicationDosageInput"
        />
      </view>
    </view>

    <!-- 备注信息 -->
    <view class="form-section">
      <view class="section-title">备注信息</view>
      <view class="form-item">
        <t-textarea
          value="{{formData.notes}}"
          placeholder="请输入治疗备注（可选）"
          maxlength="300"
          data-field="notes"
          bind:change="onFormInput"
        />
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <t-button 
        theme="light" 
        size="large" 
        bind:tap="resetForm"
        disabled="{{submitting}}"
        wx:if="{{!isEditMode}}"
      >
        重置
      </t-button>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="submitForm"
        loading="{{submitting}}"
      >
        {{isDraft ? '提交治疗方案' : (isEditMode ? '保存修改' : '保存记录')}}
      </t-button>
    </view>
    </block>
    <!-- ========== 编辑/创建模式结束 ========== -->
  </view>

  <!-- ========== ✅ 治疗进展对话框 ========== -->
  <t-dialog
    visible="{{showProgressDialog}}"
    title="{{progressDialogType === 'cured' ? '记录治愈' : '记录死亡'}}"
    confirm-btn="确认"
    cancel-btn="取消"
    bind:confirm="submitProgress"
    bind:cancel="closeProgressDialog"
  >
    <view class="progress-dialog-content">
      <!-- 剩余数量提示 -->
      <view class="dialog-hint">
        <text class="hint-text">当前剩余治疗数：</text>
        <text class="hint-value">{{treatmentProgress.remainingCount}} 只</text>
      </view>

      <!-- 数量输入 -->
      <view class="dialog-field">
        <view class="field-label required">
          {{progressDialogType === 'cured' ? '治愈数量' : '死亡数量'}}
        </view>
        <t-input
          value="{{progressForm.count}}"
          placeholder="请输入数量"
          type="digit"
          data-field="count"
          bind:change="onProgressFormInput"
        />
      </view>

      <!-- 死亡原因（仅死亡时显示） -->
      <view class="dialog-field" wx:if="{{progressDialogType === 'died'}}">
        <view class="field-label required">死亡原因</view>
        <t-textarea
          value="{{progressForm.deathCause}}"
          placeholder="请填写死亡原因"
          maxlength="200"
          data-field="deathCause"
          bind:change="onProgressFormInput"
        />
      </view>

      <!-- 备注（可选） -->
      <view class="dialog-field">
        <view class="field-label">备注</view>
        <t-textarea
          value="{{progressForm.notes}}"
          placeholder="补充说明（可选）"
          maxlength="200"
          data-field="notes"
          bind:change="onProgressFormInput"
        />
      </view>
    </view>
  </t-dialog>

</view>
