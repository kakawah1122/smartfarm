<view class="detail-page">
  
  <!-- 自定义导航栏 -->
  <navigation-bar title="死亡记录详情" showBack="{{true}}" />
  
  <!-- 加载中 -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="40rpx" text="加载中..." />
  </view>

  <!-- 详情内容 -->
  <view class="detail-content" wx:else>
    
    <!-- 状态标识卡片 -->
    <view class="status-card {{record.isCorrected ? 'corrected' : 'pending'}}">
      <view class="status-icon">
        <t-icon 
          name="{{record.isCorrected ? 'check-circle' : 'error-circle'}}" 
          size="64rpx" 
          color="{{record.isCorrected ? '#00a870' : '#ed7b2f'}}" 
        />
      </view>
      <view class="status-text">
        <text class="status-title">{{record.isCorrected ? '诊断已确认' : '待确认诊断'}}</text>
        <text class="status-subtitle">{{record.isCorrected ? '兽医已审核并确认' : 'AI诊断结果，建议专业人员确认'}}</text>
      </view>
    </view>

    <!-- 基本信息卡片 -->
    <view class="info-card">
      <view class="card-title">
        <t-icon name="calendar" size="32rpx" color="#0052d9" />
        <text class="title-text">基本信息</text>
      </view>
      
      <view class="info-rows">
        <view class="info-row">
          <text class="info-label">记录日期</text>
          <text class="info-value">{{record.deathDate}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">批次号</text>
          <text class="info-value">{{record.batchNumber || '未知'}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">死亡数量</text>
          <text class="info-value highlight">{{record.deathCount}} 只</text>
        </view>
        <view class="info-row">
          <text class="info-label">财务损失</text>
          <text class="info-value loss">¥{{record.financeLoss || 0}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">单位成本</text>
          <text class="info-value">¥{{record.unitCost || 0}}/只</text>
        </view>
      </view>
    </view>

    <!-- AI诊断结果卡片 -->
    <view class="info-card diagnosis-card">
      <view class="card-title">
        <t-icon name="logo-wechat" size="32rpx" color="#0052d9" />
        <text class="title-text">AI诊断结果</text>
        <t-tag theme="primary" size="small">AI分析</t-tag>
      </view>
      
      <!-- 主要死因 -->
      <view class="diagnosis-result">
        <view class="result-header">
          <text class="result-title">主要死因</text>
          <view class="confidence-badge" wx:if="{{diagnosisResult.primaryCause}}">
            <text class="confidence-number">{{diagnosisResult.primaryCause.confidence || diagnosisResult.primaryDiagnosis.confidence}}</text>
            <text class="confidence-unit">%</text>
          </view>
        </view>
        <text class="disease-name">{{record.deathCause}}</text>
        <text class="reasoning" wx:if="{{diagnosisResult.primaryCause}}">{{diagnosisResult.primaryCause.reasoning || diagnosisResult.primaryDiagnosis.reasoning}}</text>
      </view>

      <!-- 鉴别诊断 -->
      <view class="differential-section" wx:if="{{diagnosisResult.differentialCauses && diagnosisResult.differentialCauses.length > 0}}">
        <text class="section-title">可能死因</text>
        <view class="differential-list">
          <view 
            class="diff-item"
            wx:for="{{diagnosisResult.differentialCauses}}" 
            wx:key="index"
          >
            <text class="diff-disease">{{item.disease}}</text>
            <text class="diff-confidence">{{item.confidence}}%</text>
          </view>
        </view>
      </view>

      <!-- 预防建议 -->
      <view class="prevention-section" wx:if="{{diagnosisResult.preventionAdvice || diagnosisResult.preventionMeasures}}">
        <text class="section-title">预防建议</text>
        <view class="prevention-list">
          <view 
            class="prevention-item"
            wx:for="{{diagnosisResult.preventionAdvice || diagnosisResult.preventionMeasures}}" 
            wx:key="index"
          >
            <view class="item-dot"></view>
            <text class="item-text">{{item}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 剖检信息卡片 -->
    <view class="info-card autopsy-card" wx:if="{{record.autopsyFindings || (record.autopsyImages && record.autopsyImages.length > 0)}}">
      <view class="card-title">
        <t-icon name="file-icon" size="32rpx" color="#e34d59" />
        <text class="title-text">剖检信息</text>
      </view>
      
      <!-- 剖检照片 -->
      <view class="autopsy-images" wx:if="{{record.autopsyImages && record.autopsyImages.length > 0}}">
        <text class="subsection-title">剖检照片</text>
        <view class="images-grid">
          <view 
            class="image-item"
            wx:for="{{record.autopsyImages}}" 
            wx:key="index"
            bind:tap="onPreviewImage"
            data-index="{{index}}"
          >
            <t-image 
              src="{{item}}"
              mode="aspectFill"
              width="200rpx"
              height="200rpx"
            />
          </view>
        </view>
      </view>

      <!-- 剖检所见 -->
      <view class="autopsy-findings" wx:if="{{record.autopsyFindings}}">
        <text class="subsection-title">观察到的异常</text>
        <view class="findings-content">
          <view class="abnormalities" wx:if="{{record.autopsyFindings.abnormalities && record.autopsyFindings.abnormalities.length > 0}}">
            <view 
              class="abnormality-tag"
              wx:for="{{record.autopsyFindings.abnormalities}}" 
              wx:key="index"
            >
              {{item}}
            </view>
          </view>
          <text class="findings-description" wx:if="{{record.autopsyFindings.description}}">{{record.autopsyFindings.description}}</text>
        </view>
      </view>
    </view>

    <!-- 修正记录卡片 -->
    <view class="info-card correction-card" wx:if="{{record.isCorrected}}">
      <view class="card-title">
        <t-icon name="check-circle" size="32rpx" color="#00a870" />
        <text class="title-text">诊断修正记录</text>
        <t-tag theme="success" size="small">已确认</t-tag>
      </view>
      
      <view class="correction-info">
        <view class="info-row">
          <text class="info-label">修正后死因</text>
          <text class="info-value corrected">{{record.correctedCause}}</text>
        </view>
        <view class="info-row" wx:if="{{record.aiAccuracyRating}}">
          <text class="info-label">AI准确性评分</text>
          <view class="rating-display">
            <text 
              class="star-display {{record.aiAccuracyRating >= item ? 'active' : ''}}"
              wx:for="{{[1,2,3,4,5]}}" 
              wx:key="index"
            >{{record.aiAccuracyRating >= item ? '★' : '☆'}}</text>
            <text class="rating-text">{{ratingHints[record.aiAccuracyRating - 1] || ''}}</text>
          </view>
        </view>
        <view class="info-row" wx:if="{{record.correctionReason}}">
          <text class="info-label">兽医诊断</text>
          <text class="info-value reason">{{record.correctionReason}}</text>
        </view>
        <view class="info-row" wx:if="{{record.correctedByName}}">
          <text class="info-label">修正人</text>
          <text class="info-value">{{record.correctedByName}}</text>
        </view>
        <view class="info-row" wx:if="{{record.correctedAt}}">
          <text class="info-label">修正时间</text>
          <text class="info-value">{{record.correctedAt}}</text>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <t-button 
        theme="primary" 
        size="large" 
        block
        bind:tap="onCorrectDiagnosis"
        wx:if="{{!record.isCorrected}}"
      >
        修正诊断
      </t-button>
      
      <t-button 
        theme="default" 
        size="large" 
        block
        bind:tap="onConfirmDiagnosis"
        wx:if="{{!record.isCorrected}}"
      >
        确认AI诊断无误
      </t-button>

      <t-button 
        theme="light" 
        size="large" 
        block
        bind:tap="onReCorrect"
        wx:if="{{record.isCorrected}}"
      >
        重新修正
      </t-button>
    </view>

  </view>

  <!-- 修正诊断弹窗 - 自定义实现 -->
  <view class="correction-dialog-wrapper" wx:if="{{showCorrectionDialog}}">
    <!-- 遮罩层 -->
    <view class="dialog-mask" catchtap="onCancelCorrection"></view>
    
    <!-- 弹窗内容 -->
    <view class="correction-popup" catchtouchmove="{{true}}">
      <!-- 标题栏 -->
      <view class="popup-header">
        <view class="popup-title">修正诊断</view>
        <view class="popup-close" bind:tap="onCancelCorrection">
          <t-icon name="close" size="40rpx" color="#999" />
        </view>
      </view>

      <!-- 表单内容 -->
      <scroll-view scroll-y class="popup-content">
        <view class="correction-form">
          
          <!-- 修正后的死因 -->
          <view class="form-item">
            <text class="form-label">修正后的死因<text class="required">*</text></text>
            <input 
              class="form-input"
              placeholder="{{originalCause || '请输入正确的死因'}}"
              value="{{correctionForm.correctedCause}}"
              bindinput="onCorrectedCauseChange"
            />
          </view>

          <!-- AI准确性评分 -->
          <view class="form-item">
            <text class="form-label">AI准确性评分<text class="required">*</text></text>
            <view class="rating-input">
              <view class="custom-rating">
                <text 
                  class="star-item {{correctionForm.aiAccuracyRating >= item ? 'active' : ''}}"
                  wx:for="{{[1,2,3,4,5]}}" 
                  wx:key="index"
                  data-rating="{{item}}"
                  bind:tap="onRatingChange"
                >{{correctionForm.aiAccuracyRating >= item ? '★' : '☆'}}</text>
              </view>
              <text class="rating-hint">{{ratingHints[correctionForm.aiAccuracyRating - 1] || '请评分'}}</text>
            </view>
          </view>

          <!-- 兽医诊断 -->
          <view class="form-item">
            <text class="form-label">兽医诊断<text class="required">*</text></text>
            <textarea 
              class="form-textarea"
              placeholder="请详细说明诊断依据和理由，例如：经剖检发现肝脏病变特征不符合AI诊断，结合临床症状和病理变化，确诊为..."
              value="{{correctionForm.veterinarianDiagnosis}}"
              maxlength="500"
              bindinput="onVeterinarianDiagnosisChange"
              auto-height
            />
            <view class="char-count">{{correctionForm.veterinarianDiagnosis.length}}/500</view>
          </view>

        </view>
      </scroll-view>

      <!-- 底部按钮 -->
      <view class="popup-footer">
        <view class="footer-buttons">
          <button class="btn btn-cancel" bind:tap="onCancelCorrection">取消</button>
          <button class="btn btn-confirm" bind:tap="onSubmitCorrection">提交修正</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部安全区域 -->
  <view class="safe-area-bottom"></view>

</view>

