<view class="detail-page">
  
  <!-- 自定义导航栏 -->
  <navigation-bar title="死亡记录详情" showBack="{{true}}" bind:back="goBack" />
  
  <!-- 加载中 -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="40rpx" text="加载中..." />
  </view>

  <!-- 详情内容 -->
  <view class="detail-content" wx:else>
    
    <!-- 状态标识卡片（仅 AI 死因剖析来源显示）-->
    <view class="status-card {{record.isCorrected ? 'corrected' : 'pending'}}" wx:if="{{record.source === 'ai_diagnosis'}}">
      <view class="status-icon">
        <t-icon 
          name="{{record.isCorrected ? 'check-circle' : 'error-circle'}}" 
          size="64rpx" 
          color="{{record.isCorrected ? '#00a870' : '#ed7b2f'}}" 
        />
      </view>
      <view class="status-text">
        <text class="status-title">{{record.isCorrected ? '诊断已确认' : '待确认诊断'}}</text>
        <text class="status-subtitle">{{record.isCorrected ? '兽医已审核并确认' : 'AI诊断结果，建议专业人员确认'}}</text>
      </view>
    </view>

    <!-- 基本信息卡片 -->
    <view class="info-card">
      <view class="card-title">
        <t-icon name="calendar" size="32rpx" color="#0052d9" />
        <text class="title-text">基本信息</text>
      </view>
      
      <view class="info-rows">
        <view class="info-row">
          <text class="info-label">记录日期</text>
          <text class="info-value">{{record.deathDate}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">批次号</text>
          <text class="info-value">{{record.batchNumber || '未知'}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">死亡数量</text>
          <text class="info-value highlight">{{record.deathCount}} 只</text>
        </view>
      </view>
    </view>

    <!-- 成本分解卡片 -->
    <view class="info-card cost-breakdown-card">
      <view class="card-title">
        <t-icon name="chart-pie" size="32rpx" color="#0052d9" />
        <text class="title-text">成本分解</text>
        <t-tag theme="primary" size="small" wx:if="{{record.costBreakdown}}">综合平均成本</t-tag>
      </view>
      
      <!-- 成本明细 -->
      <view class="cost-breakdown-list" wx:if="{{record.costBreakdown}}">
        <view class="breakdown-item">
          <view class="item-label">
            <view class="label-dot" style="background: #0052d9;"></view>
            <text class="label-text">鹅苗成本</text>
          </view>
          <text class="item-value">¥{{record.costBreakdown.entryUnitCost || '0.00'}}</text>
        </view>
        <view class="breakdown-item" wx:if="{{record.costBreakdown.breedingCost && record.costBreakdown.breedingCost !== '0.00'}}">
          <view class="item-label">
            <view class="label-dot" style="background: #00a870;"></view>
            <text class="label-text">饲养成本</text>
          </view>
          <text class="item-value">¥{{record.costBreakdown.breedingCost}}</text>
        </view>
        <view class="breakdown-item" wx:if="{{record.costBreakdown.preventionCost && record.costBreakdown.preventionCost !== '0.00'}}">
          <view class="item-label">
            <view class="label-dot" style="background: #ed7b2f;"></view>
            <text class="label-text">预防成本</text>
          </view>
          <text class="item-value">¥{{record.costBreakdown.preventionCost}}</text>
        </view>
        <view class="breakdown-item" wx:if="{{record.costBreakdown.treatmentCost && record.costBreakdown.treatmentCost !== '0.00'}}">
          <view class="item-label">
            <view class="label-dot" style="background: #e34d59;"></view>
            <text class="label-text">治疗成本</text>
          </view>
          <text class="item-value">¥{{record.costBreakdown.treatmentCost}}</text>
        </view>
        
        <view class="breakdown-divider"></view>
        
        <!-- 单只成本合计 -->
        <view class="breakdown-item total-item">
          <text class="item-label-total">单只综合成本</text>
          <text class="item-value-total">¥{{record.unitCostDisplay || '0.00'}}</text>
        </view>
        
        <!-- 总损失 -->
        <view class="breakdown-item total-loss-item">
          <text class="item-label-total">总损失（×{{record.deathCount}}只）</text>
          <text class="item-value-loss">¥{{record.financeLossDisplay || '0.00'}}</text>
        </view>
      </view>
      
      <!-- 兼容旧数据：没有成本分解时显示原有样式 -->
      <view class="info-rows" wx:else>
        <view class="info-row">
          <text class="info-label">单位成本</text>
          <text class="info-value">¥{{record.unitCostDisplay || '0.00'}}/只</text>
        </view>
        <view class="info-row" wx:if="{{record.treatmentCost && record.treatmentCost > 0}}">
          <text class="info-label">治疗成本</text>
          <text class="info-value treatment-cost">¥{{record.treatmentCostDisplay || '0.00'}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">财务损失</text>
          <text class="info-value loss">¥{{record.financeLossDisplay || '0.00'}}</text>
        </view>
      </view>
    </view>

    <!-- 治疗信息卡片 -->
    <view class="info-card treatment-card" wx:if="{{record.treatmentRecordId && (record.medications && record.medications.length > 0)}}">
      <view class="card-title">
        <t-icon name="root-list" size="32rpx" color="#0052d9" />
        <text class="title-text">治疗用药</text>
        <t-tag theme="warning" size="small">治疗期间死亡</t-tag>
      </view>
      
      <view class="medications-list">
        <view class="medication-item" wx:for="{{record.medications}}" wx:key="index">
          <view class="medication-header">
            <text class="medication-name">{{item.name}}</text>
            <text class="medication-quantity">×{{item.quantity}}{{item.unit || ''}}</text>
          </view>
          <view class="medication-info" wx:if="{{item.dosage || item.frequency}}">
            <text class="info-text" wx:if="{{item.dosage}}">用量: {{item.dosage}}</text>
            <text class="info-text" wx:if="{{item.frequency}}">频次: {{item.frequency}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- AI诊断结果卡片 -->
    <view class="info-card diagnosis-card">
      <view class="card-title">
        <t-icon name="logo-wechat" size="32rpx" color="#0052d9" />
        <text class="title-text">AI诊断结果</text>
        <t-tag theme="primary" size="small">AI分析</t-tag>
      </view>
      
      <!-- 主要死因 -->
      <view class="diagnosis-result">
        <view class="result-header">
          <text class="result-title">主要死因</text>
          <view class="confidence-badge" wx:if="{{primaryResult}}">
            <text class="confidence-number">{{primaryResult.confidence || 0}}</text>
            <text class="confidence-unit">%</text>
          </view>
        </view>
        <text class="disease-name">{{record.displayDeathCause}}</text>
        <text class="reasoning" wx:if="{{primaryResult && primaryResult.reasoning}}">{{primaryResult.reasoning}}</text>
      </view>

      <!-- 鉴别诊断 -->
      <view class="differential-section" wx:if="{{differentialList.length > 0}}">
        <text class="section-title">可能死因</text>
        <view class="differential-list">
          <view 
            class="diff-item"
            wx:for="{{differentialList}}" 
            wx:key="index"
          >
            <text class="diff-disease">{{item.disease}}</text>
            <text class="diff-confidence">{{item.confidence}}%</text>
          </view>
        </view>
      </view>

      <!-- 预防建议 -->
      <view class="prevention-section" wx:if="{{preventionList.length > 0}}">
        <text class="section-title">预防建议</text>
        <view class="prevention-list">
          <view 
            class="prevention-item"
            wx:for="{{preventionList}}" 
            wx:key="index"
          >
            <view class="item-dot"></view>
            <text class="item-text">{{item}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 剖检信息卡片 -->
    <view class="info-card autopsy-card" wx:if="{{record.autopsyFindings || (record.autopsyImages && record.autopsyImages.length > 0)}}">
      <view class="card-title">
        <t-icon name="file-icon" size="32rpx" color="#e34d59" />
        <text class="title-text">剖检信息</text>
      </view>
      
      <!-- 剖检照片 -->
      <view class="autopsy-images" wx:if="{{record.autopsyImages && record.autopsyImages.length > 0}}">
        <text class="subsection-title">剖检照片</text>
        <view class="images-grid">
          <view 
            class="image-item"
            wx:for="{{record.autopsyImages}}" 
            wx:key="index"
            bind:tap="onPreviewImage"
            data-index="{{index}}"
          >
            <t-image 
              src="{{item}}"
              mode="aspectFill"
              width="200rpx"
              height="200rpx"
            />
          </view>
        </view>
      </view>

      <!-- 剖检所见 -->
      <view class="autopsy-findings" wx:if="{{hasStructuredAutopsyFindings || record.displayFindings}}">
        <text class="subsection-title">观察到的异常</text>
        <view class="findings-content">
          <view class="abnormalities" wx:if="{{record.autopsyFindings && record.autopsyFindings.abnormalities && record.autopsyFindings.abnormalities.length > 0}}">
            <view 
              class="abnormality-tag"
              wx:for="{{record.autopsyFindings.abnormalities}}" 
              wx:key="index"
            >
              {{item}}
            </view>
          </view>
          <text class="findings-description" wx:if="{{record.displayFindings}}">{{record.displayFindings}}</text>
        </view>
      </view>
    </view>

    <!-- 修正记录卡片 -->
    <view class="info-card correction-card" wx:if="{{record.isCorrected}}">
      <view class="card-title">
        <t-icon name="check-circle" size="32rpx" color="#00a870" />
        <text class="title-text">诊断修正记录</text>
        <t-tag theme="success" size="small">已确认</t-tag>
      </view>
      
      <view class="correction-info">
        <view class="info-row">
          <text class="info-label">修正后死因</text>
          <text class="info-value corrected">{{record.correctedCause}}</text>
        </view>
        <view class="info-row" wx:if="{{record.aiAccuracyRating}}">
          <text class="info-label">AI准确性评分</text>
          <view class="rating-display">
            <text 
              class="star-display {{record.aiAccuracyRating >= item ? 'active' : ''}}"
              wx:for="{{[1,2,3,4,5]}}" 
              wx:key="index"
            >{{record.aiAccuracyRating >= item ? '★' : '☆'}}</text>
            <text class="rating-text">{{ratingHints[record.aiAccuracyRating - 1] || ''}}</text>
          </view>
        </view>
        <view class="info-row" wx:if="{{record.correctionReason}}">
          <text class="info-label">兽医诊断</text>
          <text class="info-value reason">{{record.correctionReason}}</text>
        </view>
        <view class="info-row" wx:if="{{record.correctedByName}}">
          <text class="info-label">修正人</text>
          <text class="info-value">{{record.correctedByName}}</text>
        </view>
        <view class="info-row" wx:if="{{record.correctedAt}}">
          <text class="info-label">修正时间</text>
          <text class="info-value">{{record.correctedAt}}</text>
        </view>
      </view>
    </view>

    <!-- 操作按钮（仅 AI 死因剖析来源显示）-->
    <view class="action-buttons" wx:if="{{record.source === 'ai_diagnosis'}}">
      <t-button 
        theme="primary" 
        size="large" 
        block
        bind:tap="onCorrectDiagnosis"
        wx:if="{{!record.isCorrected}}"
      >
        修正诊断
      </t-button>
      
      <t-button 
        theme="default" 
        size="large" 
        block
        bind:tap="onConfirmDiagnosis"
        wx:if="{{!record.isCorrected}}"
      >
        确认AI诊断无误
      </t-button>

      <t-button 
        theme="light" 
        size="large" 
        block
        bind:tap="onReCorrect"
        wx:if="{{record.isCorrected}}"
      >
        重新修正
      </t-button>
    </view>
    
    <!-- 治疗来源的提示信息 -->
    <view class="treatment-source-tip" wx:if="{{record.source === 'treatment'}}">
      <t-notice-bar visible theme="info" content="此记录来自治疗进展，诊断已在治疗前确认，无需再次修正。" />
    </view>

  </view>

  <!-- 修正诊断弹窗 - 自定义实现 -->
  <view class="correction-dialog-wrapper" wx:if="{{showCorrectionDialog}}">
    <!-- 遮罩层 -->
    <view class="dialog-mask" catchtap="onCancelCorrection"></view>
    
    <!-- 弹窗内容 -->
    <view class="correction-popup" catchtouchmove="{{true}}">
      <!-- 标题栏 -->
      <view class="popup-header">
        <view class="popup-title">修正诊断</view>
        <view class="popup-close" bind:tap="onCancelCorrection">
          <text class="popup-close-text">×</text>
        </view>
      </view>

      <!-- 表单内容 -->
      <scroll-view scroll-y class="popup-content">
        <view class="correction-form">
          
          <!-- 修正后的死因 -->
          <view class="form-item">
            <text class="form-label">修正后的死因<text class="required">*</text></text>
            <input 
              class="form-input"
              placeholder="{{originalCause || '请输入正确的死因'}}"
              value="{{correctionForm.correctedCause}}"
              bindinput="onCorrectedCauseChange"
            />
          </view>

          <!-- AI准确性评分 -->
          <view class="form-item">
            <text class="form-label">AI准确性评分<text class="required">*</text></text>
            <view class="rating-input">
              <view class="custom-rating">
                <text 
                  class="star-item {{correctionForm.aiAccuracyRating >= item ? 'active' : ''}}"
                  wx:for="{{[1,2,3,4,5]}}" 
                  wx:key="index"
                  data-rating="{{item}}"
                  bind:tap="onRatingChange"
                >{{correctionForm.aiAccuracyRating >= item ? '★' : '☆'}}</text>
              </view>
              <text class="rating-hint">{{ratingHints[correctionForm.aiAccuracyRating - 1] || '请评分'}}</text>
            </view>
          </view>

          <!-- 兽医诊断 -->
          <view class="form-item">
            <text class="form-label">兽医诊断<text class="required">*</text></text>
            <textarea 
              class="form-textarea"
              placeholder="请详细说明诊断依据和理由，例如：经剖检发现肝脏病变特征不符合AI诊断，结合临床症状和病理变化，确诊为..."
              value="{{correctionForm.veterinarianDiagnosis}}"
              maxlength="500"
              bindinput="onVeterinarianDiagnosisChange"
              auto-height
            />
            <view class="char-count">{{correctionForm.veterinarianDiagnosis.length}}/500</view>
          </view>

        </view>
      </scroll-view>

      <!-- 底部按钮 -->
      <view class="popup-footer">
        <view class="footer-buttons">
          <button class="btn btn-cancel" bind:tap="onCancelCorrection">取消</button>
          <button class="btn btn-confirm" bind:tap="onSubmitCorrection">提交修正</button>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部安全区域 -->
  <view class="safe-area-bottom"></view>

</view>

