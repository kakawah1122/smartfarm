<!-- miniprogram/packageHealth/medication-records-list/medication-records-list.wxml -->
<view class="medication-records-page">
  
  <!-- 自定义导航栏 -->
  <navigation-bar 
    title="防疫用药记录" 
    showBack="{{true}}" 
    fallbackUrl="/pages/health/health" 
    bind:back="goBack"
  />
  
  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="60rpx" text="加载中..." />
  </view>

  <!-- 内容区 -->
  <view class="page-content" wx:else>
    
    <!-- 统计卡片 -->
    <view class="stats-section">
      <view class="stats-grid stats-grid-two">
        <view class="stat-card primary">
          <view class="stat-info">
            <text class="stat-label">总记录</text>
            <text class="stat-value">{{stats.totalCount}}</text>
          </view>
        </view>

        <view class="stat-card warning">
          <view class="stat-info">
            <text class="stat-label">总成本</text>
            <text class="stat-value">¥{{stats.totalCost}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-container" wx:if="{{recordsByBatch.length === 0}}">
      <t-empty>
        <view slot="description" class="empty-tip">
          <text class="tip-title">暂无用药记录</text>
          <text class="tip-subtitle">完成用药任务后，记录将在此处显示</text>
        </view>
      </t-empty>
    </view>

    <!-- 按批次分组的记录列表 -->
    <view class="records-list" wx:if="{{recordsByBatch.length > 0}}">
      <view 
        wx:for="{{recordsByBatch}}" 
        wx:key="batchNumber" 
        class="batch-group"
      >
        <!-- 批次组头部 -->
        <view class="batch-group-header">
          <view class="batch-group-info">
            <text class="batch-group-title">{{item.batchNumber}}</text>
          </view>
          <view class="batch-record-count">{{item.records.length}}条记录</view>
        </view>
        
        <!-- 该批次的记录列表 -->
        <view class="batch-records-list">
          <view 
            class="record-card"
            wx:for="{{item.records}}"
            wx:for-item="record"
            wx:key="_id"
            bind:tap="onRecordTap"
            data-id="{{record._id}}"
          >
            <!-- 记录头部 -->
            <view class="record-header">
              <view class="record-title-row">
                <text class="record-name">防疫用药</text>
                <t-tag 
                  theme="warning"
                  size="small" 
                  class="status-tag"
                >
                  用药
                </t-tag>
              </view>
            </view>

            <!-- 记录内容 -->
            <view class="record-content">
              <!-- 第一行：批次 + 成本 -->
              <view class="info-row">
                <view class="info-group info-group-batch">
                  <text class="info-label">批次：</text>
                  <text class="info-value">{{record.batchNumber || record.batchId}}</text>
                </view>
                <view class="info-group info-group-cost">
                  <text class="info-label">成本：</text>
                  <text class="info-value cost-value">¥{{record.formattedTotalCost || '0.00'}}</text>
                </view>
              </view>

              <!-- 第二行：效果评估 -->
              <view class="info-row">
                <view class="info-group info-group-full">
                  <text class="info-label">效果：</text>
                  <text class="info-value {{record.effectiveness === 'pending' || !record.effectiveness ? 'pending-value' : 'effectiveness-value'}}">{{record.effectiveness === 'excellent' ? '优秀' : (record.effectiveness === 'good' ? '良好' : (record.effectiveness === 'fair' ? '一般' : (record.effectiveness === 'poor' ? '较差' : (record.effectiveness === 'pending' || !record.effectiveness ? '待评估' : record.effectiveness))))}}</text>
                </view>
              </view>

              <!-- 底部：日期 + 操作者 -->
              <view class="record-footer">
                <view class="footer-left">
                  <text class="date-text">{{record.preventionDate}}</text>
                  <text class="operator-text" wx:if="{{record.operatorName}}">{{record.operatorName}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ========== 详情底部弹窗 ========== -->
  <!-- 遮罩层 -->
  <view 
    class="detail-mask" 
    wx:if="{{showDetailDialog}}"
    bind:tap="closeDetailDialog"
    catchtouchmove="preventTouchMove"
  ></view>
  
  <!-- 弹窗内容 -->
  <view class="detail-popup {{showDetailDialog ? 'show' : ''}}" wx:if="{{showDetailDialog && selectedRecord}}">
    <!-- 标题栏 -->
    <view class="popup-header">
      <text class="popup-title">用药详情</text>
      <view class="close-btn" bind:tap="closeDetailDialog">
        <text class="icon-close">×</text>
      </view>
    </view>
    
    <!-- 内容区域 -->
    <scroll-view class="popup-content" scroll-y>
      <!-- 基本信息 -->
      <view class="detail-section">
        <view class="section-title">基本信息</view>
        <view class="info-card">
          <view class="info-row">
            <text class="info-label">类型</text>
            <text class="info-value">防疫用药</text>
          </view>
          <view class="info-row">
            <text class="info-label">批次</text>
            <text class="info-value">{{selectedRecord.batchNumber || selectedRecord.batchId}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">日期</text>
            <text class="info-value">{{selectedRecord.preventionDate}}</text>
          </view>
          
          <!-- 用药信息 -->
          <block wx:if="{{selectedRecord.medicationInfo}}">
            <view class="info-row" wx:if="{{selectedRecord.medicationInfo.name}}">
              <text class="info-label">药品名称</text>
              <text class="info-value">{{selectedRecord.medicationInfo.name}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">用量</text>
              <text class="info-value">{{(selectedRecord.medicationInfo.dosage && selectedRecord.medicationInfo.dosage !== '/' && selectedRecord.medicationInfo.dosage !== '') ? selectedRecord.medicationInfo.dosage : '未填写'}}</text>
            </view>
            <view class="info-row" wx:if="{{selectedRecord.medicationInfo.method}}">
              <text class="info-label">给药方式</text>
              <text class="info-value">{{selectedRecord.medicationInfo.method}}</text>
            </view>
            <view class="info-row" wx:if="{{selectedRecord.medicationInfo.duration}}">
              <text class="info-label">用药天数</text>
              <text class="info-value">{{selectedRecord.medicationInfo.duration}} 天</text>
            </view>
            <view class="info-row" wx:if="{{selectedRecord.medicationInfo.animalCount}}">
              <text class="info-label">鹅只数量</text>
              <text class="info-value">{{selectedRecord.medicationInfo.animalCount}} 只</text>
            </view>
          </block>
        </view>
      </view>

      <!-- 费用信息 -->
      <view class="detail-section" wx:if="{{selectedRecord.costInfo && selectedRecord.formattedTotalCost !== '0.00'}}">
        <view class="section-title">费用信息</view>
        <view class="cost-grid">
          <view class="cost-item">
            <text class="cost-label">总费用</text>
            <text class="cost-value primary">¥{{selectedRecord.formattedTotalCost}}</text>
          </view>
        </view>
      </view>

      <!-- 效果评估 -->
      <view class="detail-section">
        <view class="section-title">效果评估</view>
        <view class="info-card">
          <view class="info-row">
            <text class="info-label">评估结果</text>
            <text class="info-value {{(!selectedRecord.effectiveness || selectedRecord.effectiveness === 'pending') ? 'pending-text' : ''}}">{{selectedRecord.effectiveness === 'excellent' ? '优秀' : (selectedRecord.effectiveness === 'good' ? '良好' : (selectedRecord.effectiveness === 'fair' ? '一般' : (selectedRecord.effectiveness === 'poor' ? '较差' : '待评估')))}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedRecord.effectivenessNote}}">
            <text class="info-label">评估说明</text>
            <text class="info-value">{{selectedRecord.effectivenessNote}}</text>
          </view>
          <view class="info-row" wx:if="{{selectedRecord.evaluationDate}}">
            <text class="info-label">评估时间</text>
            <text class="info-value">{{selectedRecord.evaluationDate}}</text>
          </view>
        </view>
      </view>

      <!-- 备注说明 -->
      <view class="detail-section" wx:if="{{selectedRecord.notes}}">
        <view class="section-title">备注说明</view>
        <view class="description-card">
          <text class="description-text">{{selectedRecord.notes}}</text>
        </view>
      </view>
    </scroll-view>
    
    <!-- 底部按钮区域 -->
    <view class="popup-footer" wx:if="{{selectedRecord.effectiveness !== 'excellent' && selectedRecord.effectiveness !== 'good' && selectedRecord.effectiveness !== 'fair' && selectedRecord.effectiveness !== 'poor'}}">
      <view class="custom-button" bindtap="showEvaluationForm">
        进行效果评估
      </view>
    </view>
  </view>

  <!-- ========== 效果评估表单弹窗 ========== -->
  <view class="detail-mask" 
    wx:if="{{showEvaluationDialog}}"
    bind:tap="closeEvaluationForm"
    catchtouchmove="preventTouchMove"
  ></view>
  
  <view class="detail-popup {{showEvaluationDialog ? 'show' : ''}}" wx:if="{{showEvaluationDialog}}">
    <view class="popup-header">
      <text class="popup-title">效果评估</text>
      <view class="close-btn" bind:tap="closeEvaluationForm">
        <text class="icon-close">×</text>
      </view>
    </view>
    
    <scroll-view class="popup-content" scroll-y>
      <view class="form-section">
        <view class="form-row">
          <text class="form-label required">评估结果</text>
          <picker 
            mode="selector" 
            range="{{effectivenessOptions}}"
            range-key="label"
            value="{{evaluationFormData.effectivenessIndex}}"
            bindchange="onEffectivenessChange"
          >
            <view class="form-input picker-input">
              {{effectivenessOptions[evaluationFormData.effectivenessIndex].label}}
            </view>
          </picker>
        </view>
        
        <view class="form-row">
          <text class="form-label">评估说明</text>
          <textarea 
            class="form-textarea" 
            placeholder="请输入评估说明（可选）"
            value="{{evaluationFormData.note}}"
            bindinput="onEvaluationNoteInput"
            maxlength="200"
            auto-height
          />
        </view>
      </view>
      
      <view class="form-actions">
        <t-button 
          theme="light" 
          size="large" 
          block
          bind:tap="closeEvaluationForm"
        >
          取消
        </t-button>
        <t-button 
          theme="primary" 
          size="large" 
          block
          bind:tap="submitEvaluation"
        >
          提交评估
        </t-button>
      </view>
    </scroll-view>
  </view>
</view>

