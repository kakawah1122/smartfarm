<!-- health-inspection.wxml - 健康巡检页面 -->
<view class="page health-inspection-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="健康巡检"
    show-back="true"
    bind:back="goBack"
  />

  <view class="page-container">
    <!-- 基本信息表单 -->
    <view class="form-section">
      <view class="section-title">基本信息</view>
      
      <!-- 批次选择 -->
      <view class="form-item">
        <view class="form-label required">巡检批次</view>
        <t-cell 
          title="{{formData.batchId || '请选择巡检批次'}}"
          arrow
          bind:click="showBatchSelector"
          t-class="{{formErrors.batchId ? 'form-cell-error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.batchId}}">{{formErrors.batchId}}</view>
      </view>

      <!-- 巡检位置 -->
      <view class="form-item">
        <view class="form-label required">巡检位置</view>
        <t-input
          value="{{formData.locationId}}"
          placeholder="请输入巡检位置"
          data-field="locationId"
          bind:change="onFormInput"
          status="{{formErrors.locationId ? 'error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.locationId}}">{{formErrors.locationId}}</view>
      </view>

      <!-- 检查员 -->
      <view class="form-item">
        <view class="form-label required">检查员</view>
        <t-input
          value="{{formData.inspector}}"
          placeholder="请输入检查员姓名"
          data-field="inspector"
          bind:change="onFormInput"
          status="{{formErrors.inspector ? 'error' : ''}}"
        />
        <view class="error-text" wx:if="{{formErrors.inspector}}">{{formErrors.inspector}}</view>
      </view>

      <!-- 日期时间 -->
      <view class="form-row">
        <view class="form-item half">
          <view class="form-label required">巡检日期</view>
          <picker 
            mode="date" 
            value="{{formData.inspectionDate}}"
            data-field="inspectionDate"
            bind:change="onDateChange"
          >
            <t-input
              value="{{formData.inspectionDate}}"
              placeholder="选择日期"
              readonly
              suffix-icon="calendar"
              status="{{formErrors.inspectionDate ? 'error' : ''}}"
            />
          </picker>
        </view>
        
        <view class="form-item half">
          <view class="form-label">巡检时间</view>
          <picker 
            mode="time" 
            value="{{formData.inspectionTime}}"
            data-field="inspectionTime"
            bind:change="onTimeChange"
          >
            <t-input
              value="{{formData.inspectionTime}}"
              placeholder="选择时间"
              readonly
              suffix-icon="time"
            />
          </picker>
        </view>
      </view>

      <!-- 巡检数量 -->
      <view class="form-item">
        <view class="form-label required">巡检数量</view>
        <t-input
          value="{{formData.totalInspected}}"
          placeholder="请输入巡检个体数量"
          type="number"
          data-field="totalInspected"
          bind:input="onNumberInput"
          status="{{formErrors.totalInspected ? 'error' : ''}}"
          suffix="只"
        />
        <view class="error-text" wx:if="{{formErrors.totalInspected}}">{{formErrors.totalInspected}}</view>
      </view>
    </view>

    <!-- 巡检项目 -->
    <view class="inspection-section">
      <view class="section-header">
        <view class="section-title">巡检项目</view>
        <view class="quick-actions">
          <t-button size="small" theme="light" bind:tap="markAllNormal">全部正常</t-button>
        </view>
      </view>

      <!-- 类别选择器 -->
      <view class="category-tabs">
        <scroll-view class="category-scroll" scroll-x>
          <view class="category-list">
            <view 
              class="category-item {{activeCategory === item.id ? 'active' : ''}}"
              wx:for="{{inspectionCategories}}"
              wx:key="id"
              data-category="{{item.id}}"
              bind:tap="onCategoryChange"
              style="border-color: {{item.color}}"
            >
              <t-icon name="{{item.icon}}" size="20" color="{{activeCategory === item.id ? '#fff' : item.color}}" />
              <text>{{item.name}}</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- 巡检项目列表 -->
      <view class="inspection-items">
        <view 
          class="inspection-item {{item.checked ? 'checked' : 'unchecked'}} result-{{item.result}}"
          wx:for="{{inspectionItems}}"
          wx:for-item="item"
          wx:key="id"
          wx:if="{{item.category === activeCategory}}"
        >
          <!-- 项目选择 -->
          <view class="item-header">
            <view class="item-check" data-item-id="{{item.id}}" bind:tap="onItemToggle">
              <t-icon 
                name="{{item.checked ? 'check-circle-filled' : 'circle'}}" 
                size="20" 
                color="{{item.checked ? '#0052d9' : '#c8c9cc'}}" 
              />
            </view>
            <view class="item-info">
              <text class="item-name">{{item.name}}</text>
              <text class="item-status" wx:if="{{item.result === 'normal'}}">✅ 正常</text>
              <text class="item-status abnormal" wx:if="{{item.result === 'abnormal'}}">⚠️ 异常</text>
            </view>
          </view>

          <!-- 结果选择 -->
          <view class="item-actions" wx:if="{{item.checked}}">
            <t-button 
              size="small" 
              theme="{{item.result === 'normal' ? 'primary' : 'light'}}"
              data-item-id="{{item.id}}"
              data-result="normal"
              bind:tap="onItemResultChange"
            >
              正常
            </t-button>
            <t-button 
              size="small" 
              theme="{{item.result === 'abnormal' ? 'danger' : 'light'}}"
              data-item-id="{{item.id}}"
              data-result="abnormal"
              bind:tap="onItemResultChange"
            >
              异常
            </t-button>
          </view>
        </view>
      </view>
    </view>

    <!-- 异常情况汇总 -->
    <view class="abnormal-summary" wx:if="{{abnormalFindings.length > 0}}">
      <view class="section-title">异常情况汇总 ({{abnormalFindings.length}}项)</view>
      
      <view class="abnormal-list">
        <view 
          class="abnormal-item severity-{{item.severity}}"
          wx:for="{{abnormalFindings}}"
          wx:key="id"
        >
          <view class="abnormal-header">
            <view class="abnormal-title">{{item.itemName}}</view>
            <view class="abnormal-count">{{item.affectedCount}}只</view>
            <view class="abnormal-delete" data-finding-id="{{item.id}}" bind:tap="deleteAbnormalFinding">
              <t-icon name="delete" size="16" color="#e34d59" />
            </view>
          </view>
          <view class="abnormal-description">{{item.description}}</view>
          <view class="abnormal-severity">
            严重程度：
            <text class="severity-text severity-{{item.severity}}">
              {{item.severity === 'mild' ? '轻微' : item.severity === 'moderate' ? '中等' : '严重'}}
            </text>
          </view>
        </view>
      </view>

      <!-- 异常统计 -->
      <view class="abnormal-stats">
        <view class="stat-item">
          <text class="stat-label">异常个体总数</text>
          <text class="stat-value">{{formData.abnormalCount}}只</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">异常发现率</text>
          <text class="stat-value">{{calculatedStats.abnormalDiscoveryRate}}%</text>
        </view>
      </view>
    </view>

    <!-- 备注信息 -->
    <view class="form-section">
      <view class="section-title">备注信息</view>
      <view class="form-item">
        <t-textarea
          value="{{formData.notes}}"
          placeholder="请输入巡检备注（可选）"
          maxlength="300"
          data-field="notes"
          bind:change="onFormInput"
        />
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <t-button 
        theme="light" 
        size="large" 
        bind:tap="resetForm"
        disabled="{{submitting}}"
      >
        重置
      </t-button>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="submitForm"
        loading="{{submitting}}"
      >
        完成巡检
      </t-button>
    </view>

    <!-- 底部安全区域 -->
    <view style="height: 120rpx;"></view>
  </view>

  <!-- 异常记录对话框 -->
  <t-dialog
    visible="{{showAbnormalDialog}}"
    title="记录异常情况"
    confirm-btn="保存"
    cancel-btn="取消"
    bind:confirm="saveAbnormalFinding"
    bind:cancel="cancelAbnormalFinding"
  >
    <view class="abnormal-dialog-content">
      <view class="dialog-item">
        <view class="dialog-label">异常项目</view>
        <text class="dialog-value">{{currentAbnormalItem.name}}</text>
      </view>
      
      <view class="dialog-item">
        <view class="dialog-label required">异常描述</view>
        <t-textarea
          value="{{abnormalForm.description}}"
          placeholder="请详细描述异常情况"
          maxlength="100"
          data-field="description"
          bind:change="onAbnormalFormInput"
        />
      </view>
      
      <view class="dialog-item">
        <view class="dialog-label required">受影响数量</view>
        <t-input
          value="{{abnormalForm.affectedCount}}"
          placeholder="请输入受影响数量"
          type="number"
          data-field="affectedCount"
          bind:input="onAbnormalFormInput"
          suffix="只"
        />
      </view>
      
      <view class="dialog-item">
        <view class="dialog-label">严重程度</view>
        <view class="severity-options">
          <view 
            class="severity-option {{abnormalForm.severity === 'mild' ? 'active' : ''}}"
            data-severity="mild"
            bind:tap="onAbnormalSeverityChange"
          >
            轻微
          </view>
          <view 
            class="severity-option {{abnormalForm.severity === 'moderate' ? 'active' : ''}}"
            data-severity="moderate"
            bind:tap="onAbnormalSeverityChange"
          >
            中等
          </view>
          <view 
            class="severity-option {{abnormalForm.severity === 'severe' ? 'active' : ''}}"
            data-severity="severe"
            bind:tap="onAbnormalSeverityChange"
          >
            严重
          </view>
        </view>
      </view>
    </view>
  </t-dialog>
</view>
