<!-- miniprogram/packageHealth/abnormal-record-detail/abnormal-record-detail.wxml -->
<view class="abnormal-record-detail-page">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navigation-bar title="å¼‚å¸¸è®°å½•è¯¦æƒ…" />

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="60rpx" text="åŠ è½½ä¸­..." />
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="page-content" wx:if="{{!loading && record}}">
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <view class="section-title">
        <t-icon name="folder" size="32rpx" color="#0052d9" />
        <text class="title-text">åŸºæœ¬ä¿¡æ¯</text>
      </view>
      <view class="info-rows">
        <view class="info-row">
          <text class="info-label">æ‰¹æ¬¡å·</text>
          <text class="info-value" user-select="true">{{record.batchNumber}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">å—å½±å“æ•°é‡</text>
          <text class="info-value highlight" user-select="true">{{record.affectedCount}} åª</text>
        </view>
        <view class="info-row">
          <text class="info-label">è®°å½•æ—¥æœŸ</text>
          <text class="info-value" user-select="true">{{record.checkDate}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">çŠ¶æ€</text>
          <t-tag 
            theme="{{record.status === 'abnormal' ? 'warning' : (record.status === 'treating' ? 'primary' : 'success')}}" 
            size="small"
          >
            {{record.status === 'abnormal' ? 'å¾…å¤„ç†' : (record.status === 'treating' ? 'æ²»ç–—ä¸­' : 'å·²éš”ç¦»')}}
          </t-tag>
        </view>
      </view>
    </view>

    <!-- AIè¯Šæ–­ -->
    <view class="info-section">
      <view class="section-title">
        <t-icon name="chart-bubble" size="32rpx" color="#00a870" />
        <text class="title-text">AIè¯Šæ–­</text>
        <t-tag theme="success" size="small">ç½®ä¿¡åº¦ {{record.diagnosisConfidence}}%</t-tag>
      </view>
      <view class="diagnosis-content">
        <view class="diagnosis-name-row">
          <text class="diagnosis-name" user-select="true">{{record.diagnosis}}</text>
          <t-tag 
            theme="{{record.severity === 'severe' ? 'danger' : (record.severity === 'moderate' ? 'warning' : 'primary')}}" 
            size="small"
          >
            {{record.severity === 'severe' ? 'ä¸¥é‡' : (record.severity === 'moderate' ? 'ä¸­åº¦' : 'è½»åº¦')}}
          </t-tag>
          <t-tag 
            theme="{{record.urgency === 'high' ? 'danger' : (record.urgency === 'medium' ? 'warning' : 'primary')}}" 
            size="small"
          >
            {{record.urgency === 'high' ? 'å±æ€¥' : (record.urgency === 'medium' ? 'ç´§æ€¥' : 'ä¸€èˆ¬')}}
          </t-tag>
        </view>

        <!-- è¯Šæ–­è¯¦æƒ… -->
        <view class="diagnosis-details" wx:if="{{record.diagnosisDetails}}">
          <!-- è¯Šæ–­ä¾æ® -->
          <view class="detail-item" wx:if="{{record.diagnosisDetails.reasoning}}">
            <view class="detail-label">
              <t-icon name="check-circle" size="24rpx" color="#0052d9" />
              <text class="label-text">è¯Šæ–­ä¾æ®</text>
            </view>
            <text class="detail-value" user-select="true">{{record.diagnosisDetails.reasoning}}</text>
          </view>

          <!-- ç—…åŸä½“ -->
          <view class="detail-item" wx:if="{{record.diagnosisDetails.pathogen}}">
            <view class="detail-label">
              <t-icon name="info-circle" size="24rpx" color="#ed7b2f" />
              <text class="label-text">ç—…åŸä½“</text>
            </view>
            <text class="detail-value" user-select="true">{{record.diagnosisDetails.pathogen}}</text>
          </view>

          <!-- ä¼ æ’­é€”å¾„ -->
          <view class="detail-item" wx:if="{{record.diagnosisDetails.transmission}}">
            <view class="detail-label">
              <t-icon name="arrow-triangle-down" size="24rpx" color="#00a870" />
              <text class="label-text">ä¼ æ’­é€”å¾„</text>
            </view>
            <text class="detail-value" user-select="true">{{record.diagnosisDetails.transmission}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç—‡çŠ¶æè¿° -->
    <view class="info-section" wx:if="{{record.symptoms}}">
      <view class="section-title">
        <t-icon name="file-icon" size="32rpx" color="#ed7b2f" />
        <text class="title-text">ç—‡çŠ¶æè¿°</text>
      </view>
      <view class="symptoms-content">
        <text class="symptoms-text" user-select="true">{{record.symptoms}}</text>
      </view>
    </view>

    <!-- AIå»ºè®® -->
    <view class="info-section" wx:if="{{record.aiRecommendation}}">
      <view class="section-title">
        <t-icon name="lightbulb" size="32rpx" color="#0052d9" />
        <text class="title-text">AIæ²»ç–—å»ºè®®</text>
      </view>
      <view class="recommendation-content">
        
        <!-- ç«‹å³æªæ–½ -->
        <view class="recommendation-section" wx:if="{{record.aiRecommendation.immediate}}">
          <view class="section-subtitle">
            <text class="subtitle-icon">ğŸš¨</text>
            <text class="subtitle-text">ç«‹å³æªæ–½</text>
          </view>
          <view class="measure-list">
            <view class="measure-item" wx:for="{{record.aiRecommendation.immediate}}" wx:key="index">
              <text class="measure-dot">â€¢</text>
              <text class="measure-text" user-select="true">{{item}}</text>
            </view>
          </view>
        </view>

        <!-- ç”¨è¯æ–¹æ¡ˆ -->
        <view class="recommendation-section" wx:if="{{record.aiRecommendation.medication}}">
          <view class="section-subtitle">
            <text class="subtitle-icon">ğŸ’Š</text>
            <text class="subtitle-text">ç”¨è¯æ–¹æ¡ˆ</text>
          </view>
          <view class="medication-list">
            <view class="medication-card" wx:for="{{record.aiRecommendation.medication}}" wx:key="index">
              <view class="medication-name" user-select="true">{{item.name}}</view>
              <view class="medication-details">
                <view class="detail-row">
                  <text class="detail-label">ç”¨é‡ï¼š</text>
                  <text class="detail-value" user-select="true">{{item.dosage}}</text>
                </view>
                <view class="detail-row">
                  <text class="detail-label">é¢‘æ¬¡ï¼š</text>
                  <text class="detail-value" user-select="true">{{item.frequency}}</text>
                </view>
                <view class="detail-row">
                  <text class="detail-label">ç–—ç¨‹ï¼š</text>
                  <text class="detail-value" user-select="true">{{item.duration}}</text>
                </view>
                <view class="detail-row">
                  <text class="detail-label">é€”å¾„ï¼š</text>
                  <text class="detail-value" user-select="true">{{item.route}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- æ”¯æŒæ€§æªæ–½ -->
        <view class="recommendation-section" wx:if="{{record.aiRecommendation.supportive}}">
          <view class="section-subtitle">
            <text class="subtitle-icon">ğŸ©¹</text>
            <text class="subtitle-text">æ”¯æŒæ€§æªæ–½</text>
          </view>
          <view class="measure-list">
            <view class="measure-item" wx:for="{{record.aiRecommendation.supportive}}" wx:key="index">
              <text class="measure-dot">â€¢</text>
              <text class="measure-text" user-select="true">{{item}}</text>
            </view>
          </view>
        </view>

        <!-- è·Ÿè¿›è§‚å¯Ÿ -->
        <view class="recommendation-section" wx:if="{{record.aiRecommendation.followUp}}">
          <view class="section-subtitle">
            <text class="subtitle-icon">ğŸ“‹</text>
            <text class="subtitle-text">è·Ÿè¿›è§‚å¯Ÿ</text>
          </view>
          <view class="followup-content">
            <view class="followup-timeline" wx:if="{{record.aiRecommendation.followUp.timeline}}">
              <text class="timeline-text" user-select="true">{{record.aiRecommendation.followUp.timeline}}</text>
            </view>
            <view class="followup-indicators" wx:if="{{record.aiRecommendation.followUp.indicators}}">
              <text class="indicators-title">è§‚å¯ŸæŒ‡æ ‡ï¼š</text>
              <view class="measure-list">
                <view class="measure-item" wx:for="{{record.aiRecommendation.followUp.indicators}}" wx:key="index">
                  <text class="measure-dot">âœ“</text>
                  <text class="measure-text" user-select="true">{{item}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

      </view>
    </view>

    <!-- ä¿®æ­£è®°å½•å¡ç‰‡ -->
    <view class="info-section correction-card" wx:if="{{record.isCorrected}}">
      <view class="section-title">
        <t-icon name="check-circle" size="32rpx" color="#00a870" />
        <text class="title-text">è¯Šæ–­ä¿®æ­£è®°å½•</text>
        <t-tag theme="success" size="small">å·²ç¡®è®¤</t-tag>
      </view>
      
      <view class="correction-info">
        <view class="info-row">
          <text class="info-label">ä¿®æ­£åè¯Šæ–­</text>
          <text class="info-value corrected" user-select="true">{{record.correctedDiagnosis}}</text>
        </view>
        <view class="info-row" wx:if="{{record.aiAccuracyRating}}">
          <text class="info-label">AIå‡†ç¡®æ€§è¯„åˆ†</text>
          <view class="rating-display">
            <text 
              class="star-display {{record.aiAccuracyRating >= item ? 'active' : ''}}"
              wx:for="{{[1,2,3,4,5]}}" 
              wx:key="index"
            >{{record.aiAccuracyRating >= item ? 'â˜…' : 'â˜†'}}</text>
            <text class="rating-text">{{ratingHints[record.aiAccuracyRating - 1] || ''}}</text>
          </view>
        </view>
        <view class="info-row" wx:if="{{record.correctionReason}}">
          <text class="info-label">å…½åŒ»è¯Šæ–­ä¾æ®</text>
          <text class="info-value reason" user-select="true">{{record.correctionReason}}</text>
        </view>
        <view class="info-row" wx:if="{{record.correctedByName}}">
          <text class="info-label">ä¿®æ­£äºº</text>
          <text class="info-value">{{record.correctedByName}}</text>
        </view>
        <view class="info-row" wx:if="{{record.correctedAt}}">
          <text class="info-label">ä¿®æ­£æ—¶é—´</text>
          <text class="info-value">{{record.correctedAt}}</text>
        </view>
      </view>
    </view>

    <!-- å›¾ç‰‡ -->
    <view class="info-section" wx:if="{{record.images && record.images.length > 0}}">
      <view class="section-title">
        <t-icon name="image" size="32rpx" color="#0052d9" />
        <text class="title-text">ç›¸å…³å›¾ç‰‡</text>
      </view>
      <view class="images-grid">
        <view 
          class="image-item"
          wx:for="{{record.images}}"
          wx:key="index"
          bind:tap="previewImage"
          data-url="{{item}}"
        >
          <t-image 
            src="{{item}}"
            mode="aspectFill"
            width="200rpx"
            height="200rpx"
          />
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="action-buttons" wx:if="{{record.status === 'abnormal'}}">
      <view class="buttons-row">
        <!-- æœªä¿®æ­£æ—¶æ˜¾ç¤ºä¿®æ­£æŒ‰é’® -->
        <t-button 
          theme="light" 
          size="large" 
          bind:tap="correctDiagnosis" 
          wx:if="{{!record.isCorrected}}"
          block
        >
          ä¿®æ­£ç»“æœ
        </t-button>
        <!-- å·²ä¿®æ­£æ—¶æ˜¾ç¤ºé‡æ–°ä¿®æ­£æŒ‰é’® -->
        <t-button 
          theme="light" 
          size="large" 
          bind:tap="correctDiagnosis" 
          wx:if="{{record.isCorrected}}"
          block
        >
          é‡æ–°ä¿®æ­£
        </t-button>
        <t-button 
          theme="primary" 
          size="large" 
          bind:tap="showTreatmentPlanDialog"
          block
        >
          åˆ¶å®šæ²»ç–—æ–¹æ¡ˆ
        </t-button>
      </view>
    </view>

    <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
    <view class="safe-area-bottom"></view>

  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-container" wx:if="{{!loading && !record}}">
    <t-empty icon="error-circle" description="è®°å½•ä¸å­˜åœ¨" />
  </view>

  <!-- æ²»ç–—æ–¹æ¡ˆé€‰æ‹©å¯¹è¯æ¡† -->
  <t-dialog
    visible="{{showTreatmentDialog}}"
    title="é€‰æ‹©æ²»ç–—æ–¹å¼"
    confirm-btn="ç¡®å®š"
    cancel-btn="å–æ¶ˆ"
    bind:confirm="confirmTreatmentPlan"
    bind:cancel="cancelTreatmentPlan"
  >
    <view class="treatment-options">
      <view
        class="treatment-option {{selectedTreatmentType === 'medication' ? 'active' : ''}}"
        bind:tap="selectTreatmentType"
        data-type="medication"
      >
        <t-icon name="service" size="32" color="{{selectedTreatmentType === 'medication' ? '#0052d9' : '#666'}}" />
        <text class="option-name">è¯ç‰©æ²»ç–—</text>
        <text class="option-desc">åˆ›å»ºæ²»ç–—è®°å½•ï¼Œè·Ÿè¸ªç”¨è¯è¿›å±•</text>
      </view>
      
      <view
        class="treatment-option {{selectedTreatmentType === 'isolation' ? 'active' : ''}}"
        bind:tap="selectTreatmentType"
        data-type="isolation"
      >
        <t-icon name="location" size="32" color="{{selectedTreatmentType === 'isolation' ? '#0052d9' : '#666'}}" />
        <text class="option-name">éš”ç¦»è§‚å¯Ÿ</text>
        <text class="option-desc">éš”ç¦»æ‚£ç—…ä¸ªä½“ï¼Œå¯†åˆ‡è§‚å¯Ÿ</text>
      </view>
    </view>
  </t-dialog>

  <!-- ä¿®æ­£è¯Šæ–­å¼¹çª— -->
  <view class="correction-dialog-wrapper" wx:if="{{showCorrectionDialog}}">
    <!-- é®ç½©å±‚ -->
    <view class="dialog-mask" catchtap="onCancelCorrection"></view>
    
    <!-- å¼¹çª—å†…å®¹ -->
    <view class="correction-popup" catchtouchmove="preventMove">
      <!-- æ ‡é¢˜æ  -->
      <view class="popup-header">
        <view class="popup-title">ä¿®æ­£è¯Šæ–­</view>
        <view class="popup-close" bind:tap="onCancelCorrection">
          <t-icon name="close" size="40rpx" color="#999" />
        </view>
      </view>

      <!-- è¡¨å•å†…å®¹ -->
      <scroll-view scroll-y class="popup-content">
        <view class="correction-form">
          
          <!-- ä¿®æ­£åçš„è¯Šæ–­ -->
          <view class="form-item">
            <text class="form-label">ä¿®æ­£åçš„è¯Šæ–­<text class="required">*</text></text>
            <input 
              class="form-input"
              placeholder="{{originalDiagnosis || 'è¯·è¾“å…¥æ­£ç¡®çš„è¯Šæ–­'}}"
              value="{{correctionForm.correctedDiagnosis}}"
              bindinput="onCorrectedDiagnosisChange"
            />
          </view>

          <!-- å…½åŒ»è¯Šæ–­ä¾æ® -->
          <view class="form-item">
            <text class="form-label">å…½åŒ»è¯Šæ–­ä¾æ®<text class="required">*</text></text>
            <textarea
              class="form-textarea"
              placeholder="è¯·è¾“å…¥æ‚¨çš„ä¸“ä¸šè¯Šæ–­ä¾æ®å’Œç†ç”±"
              value="{{correctionForm.veterinarianDiagnosis}}"
              bindinput="onVeterinarianDiagnosisChange"
              maxlength="500"
              auto-height
            />
          </view>

          <!-- AIå‡†ç¡®æ€§è¯„åˆ† -->
          <view class="form-item">
            <text class="form-label">AIå‡†ç¡®æ€§è¯„åˆ†<text class="required">*</text></text>
            <view class="rating-stars">
              <view 
                class="star {{correctionForm.aiAccuracyRating >= item ? 'active' : ''}}"
                wx:for="{{[1,2,3,4,5]}}" 
                wx:key="index"
                bind:tap="onRatingChange"
                data-rating="{{item}}"
              >
                {{correctionForm.aiAccuracyRating >= item ? 'â˜…' : 'â˜†'}}
              </view>
            </view>
            <text class="rating-hint" wx:if="{{correctionForm.aiAccuracyRating > 0}}">
              {{ratingHints[correctionForm.aiAccuracyRating - 1]}}
            </text>
          </view>

          <view class="form-tip">
            <t-icon name="info-circle" size="28rpx" color="#0052d9" />
            <text class="tip-text">æ‚¨çš„ä¿®æ­£å°†å¸®åŠ©AIç³»ç»Ÿå­¦ä¹ å’Œæ”¹è¿›è¯Šæ–­èƒ½åŠ›</text>
          </view>

        </view>
      </scroll-view>

      <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
      <view class="popup-footer">
        <view class="footer-buttons">
          <button class="btn btn-secondary" bind:tap="onCancelCorrection">å–æ¶ˆ</button>
          <button class="btn btn-primary" bind:tap="onSubmitCorrection">æäº¤ä¿®æ­£</button>
        </view>
      </view>
    </view>
  </view>

</view>
