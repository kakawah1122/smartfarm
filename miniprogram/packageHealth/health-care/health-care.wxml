<!-- health-care.wxml - 保健管理页面 -->
<view class="page health-care-page">
  <!-- 导航栏 -->
  <navigation-bar 
    title="保健管理"
    show-back="true"
    bind:back="goBack"
  />

  <view class="page-container">
    <!-- 表单内容 -->
    <view class="form-container">
      
      <!-- 基本信息 -->
      <view class="form-section">
        <view class="section-title">基本信息</view>
        
        <!-- 目标批次 -->
        <view class="form-item">
          <view class="form-label required">目标批次</view>
          <t-cell 
            title="{{formData.batchId || '请选择目标批次'}}"
            arrow
            bind:click="showBatchSelector"
            t-class="{{formErrors.batchId ? 'form-cell-error' : ''}}"
          />
          <view class="error-text" wx:if="{{formErrors.batchId}}">{{formErrors.batchId}}</view>
        </view>

        <!-- 保健类型 -->
        <view class="form-section">
          <view class="section-title">保健类型</view>
          <view class="care-type-grid">
            <view 
              class="care-type-item {{formData.careType === item.value ? 'active' : ''}}"
              wx:for="{{careTypeOptions}}"
              wx:key="value"
              data-type="{{item.value}}"
              bind:tap="showCareTypeSelector"
            >
              <view class="care-type-icon">
                <t-icon name="{{item.icon}}" size="24" />
              </view>
              <view class="care-type-info">
                <text class="care-type-name">{{item.label}}</text>
                <text class="care-type-desc">{{item.desc}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 位置信息 -->
        <view class="form-item">
          <view class="form-label">实施位置</view>
          <t-input
            value="{{formData.locationId}}"
            placeholder="请输入实施位置"
            data-field="locationId"
            bind:change="onFormInput"
          />
        </view>
      </view>

      <!-- 保健方案 -->
      <view class="form-section">
        <view class="section-title">保健方案</view>
        
        <!-- 保健品名称 -->
        <view class="form-item">
          <view class="form-label required">保健品名称</view>
          <view class="input-with-action">
            <t-input
              value="{{formData.supplement}}"
              placeholder="请输入保健品名称"
              data-field="supplement"
              bind:change="onFormInput"
              status="{{formErrors.supplement ? 'error' : ''}}"
            />
            <t-button size="small" theme="light" bind:tap="showSupplementSelector">
              推荐
            </t-button>
          </view>
          <view class="error-text" wx:if="{{formErrors.supplement}}">{{formErrors.supplement}}</view>
        </view>

        <!-- 用法用量 -->
        <view class="form-item">
          <view class="form-label required">用法用量</view>
          <t-input
            value="{{formData.dosage}}"
            placeholder="如：2g/100只、按说明使用等"
            data-field="dosage"
            bind:change="onFormInput"
            status="{{formErrors.dosage ? 'error' : ''}}"
          />
          <view class="error-text" wx:if="{{formErrors.dosage}}">{{formErrors.dosage}}</view>
        </view>

        <!-- 给药方式 -->
        <view class="form-item">
          <view class="form-label">给药方式</view>
          <t-cell 
            title="{{selectedMethodLabel}}"
            arrow
            bind:click="showMethodSelector"
          />
        </view>

        <!-- 使用天数 -->
        <view class="form-item">
          <view class="form-label required">使用天数</view>
          <t-input
            value="{{formData.duration}}"
            placeholder="请输入连续使用天数"
            type="number"
            data-field="duration"
            bind:input="onNumberInput"
            status="{{formErrors.duration ? 'error' : ''}}"
            suffix="天"
          />
          <view class="error-text" wx:if="{{formErrors.duration}}">{{formErrors.duration}}</view>
        </view>

        <!-- 保健目的 -->
        <view class="form-item">
          <view class="form-label required">保健目的</view>
          <t-input
            value="{{formData.purpose}}"
            placeholder="如：增强免疫力、促进生长等"
            data-field="purpose"
            bind:change="onFormInput"
            status="{{formErrors.purpose ? 'error' : ''}}"
          />
          <view class="error-text" wx:if="{{formErrors.purpose}}">{{formErrors.purpose}}</view>
        </view>
      </view>

      <!-- 实施信息 -->
      <view class="form-section">
        <view class="section-title">实施信息</view>
        
        <!-- 目标数量 -->
        <view class="form-item">
          <view class="form-label required">目标数量</view>
          <t-input
            value="{{formData.targetCount}}"
            placeholder="请输入目标保健数量"
            type="number"
            data-field="targetCount"
            bind:input="onNumberInput"
            status="{{formErrors.targetCount ? 'error' : ''}}"
            suffix="只"
          />
          <view class="error-text" wx:if="{{formErrors.targetCount}}">{{formErrors.targetCount}}</view>
        </view>

        <!-- 实际数量 -->
        <view class="form-item">
          <view class="form-label">实际数量</view>
          <t-input
            value="{{formData.actualCount}}"
            placeholder="请输入实际保健数量"
            type="number"
            data-field="actualCount"
            bind:input="onNumberInput"
            status="{{formErrors.actualCount ? 'error' : ''}}"
            suffix="只"
          />
          <view class="error-text" wx:if="{{formErrors.actualCount}}">{{formErrors.actualCount}}</view>
        </view>

        <!-- 执行日期 -->
        <view class="form-item">
          <view class="form-label required">执行日期</view>
          <picker 
            mode="date" 
            value="{{formData.executionDate}}"
            data-field="executionDate"
            bind:change="onDateChange"
          >
            <t-input
              value="{{formData.executionDate}}"
              placeholder="请选择执行日期"
              readonly
              suffix-icon="calendar"
              status="{{formErrors.executionDate ? 'error' : ''}}"
            />
          </picker>
          <view class="error-text" wx:if="{{formErrors.executionDate}}">{{formErrors.executionDate}}</view>
        </view>

        <!-- 执行时间 -->
        <view class="form-item">
          <view class="form-label">执行时间</view>
          <picker 
            mode="time" 
            value="{{formData.executionTime}}"
            data-field="executionTime"
            bind:change="onTimeChange"
          >
            <t-input
              value="{{formData.executionTime}}"
              placeholder="请选择执行时间"
              readonly
              suffix-icon="time"
            />
          </picker>
        </view>

        <!-- 操作员 -->
        <view class="form-item">
          <view class="form-label required">操作员</view>
          <t-input
            value="{{formData.operator}}"
            placeholder="请输入操作员姓名"
            data-field="operator"
            bind:change="onFormInput"
            status="{{formErrors.operator ? 'error' : ''}}"
          />
          <view class="error-text" wx:if="{{formErrors.operator}}">{{formErrors.operator}}</view>
        </view>

        <!-- 成本费用 -->
        <view class="form-item">
          <view class="form-label">成本费用</view>
          <t-input
            value="{{formData.cost}}"
            placeholder="请输入保健成本"
            type="digit"
            data-field="cost"
            bind:input="onNumberInput"
            prefix-icon="wallet"
            suffix="元"
          />
        </view>
      </view>

      <!-- 效果评估 -->
      <view class="form-section">
        <view class="section-title">效果评估</view>
        
        <!-- 保健效果 -->
        <view class="form-item">
          <view class="form-label">保健效果</view>
          <t-cell 
            title="{{selectedEffectivenessLabel}}"
            arrow
            bind:click="showEffectivenessSelector"
          />
        </view>

        <!-- 下次保健时间 -->
        <view class="form-item">
          <view class="form-label">下次保健</view>
          <picker 
            mode="date" 
            value="{{formData.nextSchedule}}"
            data-field="nextSchedule"
            bind:change="onDateChange"
          >
            <t-input
              value="{{formData.nextSchedule}}"
              placeholder="请选择下次保健时间（可选）"
              readonly
              suffix-icon="calendar"
            />
          </picker>
        </view>

        <!-- 备注 -->
        <view class="form-item">
          <view class="form-label">备注信息</view>
          <t-textarea
            value="{{formData.notes}}"
            placeholder="请输入备注信息（可选）"
            maxlength="200"
            data-field="notes"
            bind:change="onFormInput"
          />
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <t-button 
        theme="light" 
        size="large" 
        bind:tap="resetForm"
        disabled="{{submitting}}"
      >
        重置
      </t-button>
      <t-button 
        theme="primary" 
        size="large" 
        bind:tap="submitForm"
        loading="{{submitting}}"
      >
        保存记录
      </t-button>
    </view>

    <!-- 底部安全区域 -->
    <view style="height: 120rpx;"></view>
  </view>

  <!-- 保健类型选择器 -->
  <t-picker
    visible="{{showCareTypePicker}}"
    value="{{[selectedCareTypeIndex]}}"
    data-source="{{careTypeOptions}}"
    bind:change="onCareTypePickerChange"
    bind:cancel="onCareTypePickerCancel"
    title="选择保健类型"
  >
    <t-picker-item
      wx:for="{{careTypeOptions}}"
      wx:key="value"
      label="{{item.label}}"
      value="{{index}}"
    />
  </t-picker>

  <!-- 给药方式选择器 -->
  <t-picker
    visible="{{showMethodPicker}}"
    value="{{[selectedMethodIndex]}}"
    data-source="{{methodOptions}}"
    bind:change="onMethodPickerChange"
    bind:cancel="onMethodPickerCancel"
    title="选择给药方式"
  >
    <t-picker-item
      wx:for="{{methodOptions}}"
      wx:key="value"
      label="{{item.label}}"
      value="{{index}}"
    />
  </t-picker>

  <!-- 效果评估选择器 -->
  <t-picker
    visible="{{showEffectivenessPicker}}"
    value="{{[selectedEffectivenessIndex]}}"
    data-source="{{effectivenessOptions}}"
    bind:change="onEffectivenessPickerChange"
    bind:cancel="onEffectivenessPickerCancel"
    title="选择保健效果"
  >
    <t-picker-item
      wx:for="{{effectivenessOptions}}"
      wx:key="value"
      label="{{item.label}}"
      value="{{index}}"
    />
  </t-picker>
</view>
