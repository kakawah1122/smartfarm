<view class="page-container">
  <!-- 新式导航栏 -->
  <navigation-bar 
    title="财务管理"
    show-back="true"
    show-menu="true"
    show-record="false"
    bind:back="goBack"
    bind:menu="onMenuTap"
  />

  <!-- 内容区域 -->
  <view class="content-wrapper">
  <scroll-view class="scroll-container" scroll-y>
    <!-- 财务概览卡片 -->
    <view class="card overview-card">
      <view class="card-content overview-card-content">
        <view class="overview-header">
          <text class="overview-title">财务概览</text>
          <view class="filter-container">
            <!-- 第一级：时间维度类型选择 -->
            <picker 
              mode="selector" 
              range="{{filterTypeOptions}}" 
              range-key="label"
              value="{{filterTypeIndex}}"
              bind:change="onFilterTypeChange"
            >
              <text class="period-filter-text">{{filterTypeLabel}}</text>
            </picker>
            
            <!-- 第二级：具体时间选择 -->
            <!-- 月度选择 -->
            <view wx:if="{{filterType === 'month'}}" class="custom-date-container">
              <picker 
                mode="selector"
                range="{{monthOptions}}"
                range-key="label"
                value="{{selectedMonthIndex}}"
                bind:change="onMonthChange"
              >
                <text class="custom-date-text">{{monthOptions[selectedMonthIndex].label}}</text>
              </picker>
            </view>
            
            <!-- 季度选择 -->
            <view wx:if="{{filterType === 'quarter'}}" class="custom-date-container">
              <picker 
                mode="selector"
                range="{{quarterOptions}}"
                range-key="label"
                value="{{selectedQuarterIndex}}"
                bind:change="onQuarterChange"
              >
                <text class="custom-date-text">{{quarterOptions[selectedQuarterIndex].label}}</text>
              </picker>
            </view>
            
            <!-- 年度选择 -->
            <view wx:if="{{filterType === 'year'}}" class="custom-date-container">
              <picker 
                mode="selector"
                range="{{yearOptions}}"
                range-key="label"
                value="{{selectedYearIndex}}"
                bind:change="onYearChange"
              >
                <text class="custom-date-text">{{yearOptions[selectedYearIndex].label}}</text>
              </picker>
            </view>
            
            <!-- 自定义日期选择 -->
            <view wx:if="{{filterType === 'custom'}}" class="custom-date-container">
              <picker 
                mode="date"
                value="{{customStartDate}}"
                bind:change="onCustomStartDateChange"
              >
                <text class="custom-date-text">{{customStartDate || '开始日期'}}</text>
              </picker>
              <text class="date-separator">至</text>
              <picker 
                mode="date"
                value="{{customEndDate}}"
                bind:change="onCustomEndDateChange"
              >
                <text class="custom-date-text">{{customEndDate || '结束日期'}}</text>
              </picker>
            </view>
          </view>
        </view>
        
        <!-- 收支对比 -->
        <view class="comparison-section">
          <view class="comparison-data">
            <view class="data-item">
              <view class="data-value-wrapper">
                <text class="data-value danger">{{overview.income}}</text>
                <text class="data-unit">万</text>
              </view>
              <text class="data-label">总收入</text>
            </view>
            <view class="data-item">
              <view class="data-value-wrapper">
                <text class="data-value {{overview.profitColorClass}}">{{overview.profit}}</text>
                <text class="data-unit">万</text>
              </view>
              <text class="data-label">净利润</text>
            </view>
            <view class="data-item">
              <view class="data-value-wrapper">
                <text class="data-value {{overview.expenseColorClass}}">{{overview.expense}}</text>
                <text class="data-unit">万</text>
              </view>
              <text class="data-label">总支出</text>
            </view>
          </view>
        </view>

        <!-- 成本构成 -->
        <view class="cost-grid">
          <view class="cost-item cost-item-feed">
            <text class="cost-label">饲料成本</text>
            <text class="cost-value">¥{{overview.feedCost}}万</text>
            <text class="cost-percent">占支出 {{overview.feedPercent}}%</text>
          </view>
          <view class="cost-item cost-item-gosling">
            <text class="cost-label">鹅苗成本</text>
            <text class="cost-value">¥{{overview.goslingCost}}万</text>
            <text class="cost-percent">占支出 {{overview.goslingPercent}}%</text>
          </view>
          <view class="cost-item cost-item-medical">
            <text class="cost-label">医疗费用</text>
            <text class="cost-value">¥{{overview.medicalCost}}万</text>
            <text class="cost-percent">占支出 {{overview.medicalPercent}}%</text>
          </view>
          <view class="cost-item cost-item-other">
            <text class="cost-label">其他费用</text>
            <text class="cost-value">¥{{overview.otherCost}}万</text>
            <text class="cost-percent">占支出 {{overview.otherPercent}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Tab 切换 -->
    <t-tabs value="{{activeTab}}" bind:change="onTabChange" theme="line" t-class="finance-tabs">
      <t-tab-panel label="收支明细" value="records" />
      <t-tab-panel label="AI财务分析" value="reports" />
      <t-tab-panel label="审批管理" value="approval" />
    </t-tabs>

    <!-- 收支明细页面 -->
    <view wx:if="{{activeTab === 'records'}}" class="tab-content">
      <!-- 交易记录 -->
      <view class="card tab-content-card">
        <view class="card-content">
          <view class="card-header">
            <text class="card-title">最近交易记录</text>
            <text class="view-all-btn" bind:tap="viewAllRecords">查看全部</text>
          </view>
          <view class="records-list">
            <view 
              wx:for="{{displayRecords}}" 
              wx:key="id"
              class="record-item-card"
              bind:tap="viewRecordDetail"
              data-item="{{item}}"
            >
              <view class="record-left">
                <view class="record-content">
                  <view class="record-title">{{item.title}}</view>
                  <view class="record-desc">{{item.description}}</view>
                  <view class="record-footer">
                    <text class="record-time">{{item.date}}</text>
                  </view>
                </view>
              </view>
              <view class="record-right">
                <view class="record-amount {{item.type}}">
                  {{item.type === 'income' ? '+' : '-'}}¥{{item.amount}}
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- AI财务分析页面 -->
    <view wx:if="{{activeTab === 'reports'}}" class="tab-content">
      <view class="card">
        <view class="card-content">
          <view class="card-header">
            <text class="card-title">AI财务分析</text>
          </view>
          <ai-finance-analysis 
            finance-data="{{rawFinanceData}}"
            date-range="{{rawFinanceData ? rawFinanceData.dateRange : null}}"
            production-data="{{productionData}}"
            health-data="{{healthData}}"
            goose-price-data="{{goosePriceData}}"
            bind:analysisComplete="onAnalysisComplete"
            bind:analysisError="onAnalysisError"
          />
        </view>
      </view>
    </view>

    <!-- 审批管理页面 -->
    <view wx:if="{{activeTab === 'approval'}}" class="tab-content">
      <view class="card">
        <view class="card-content">
          <view class="card-header">
            <text class="card-title">待审批事项</text>
          </view>
          
          <view class="approval-list">
            <view 
              wx:for="{{approvalItems}}" 
              wx:key="id"
              class="approval-item"
              bind:tap="viewApprovalDetail"
              data-item="{{item}}"
            >
              <view class="approval-left">
                <view class="approval-content">
                  <view class="approval-title">{{item.applicant}} - {{item.title}}</view>
                  <view class="approval-desc">{{item.description}}</view>
                  <view class="approval-footer">
                    <text class="approval-time">提交时间：{{item.submitTime}}</text>
                  </view>
                </view>
              </view>
              <view class="approval-right">
                <view class="approval-amount">
                  ¥{{item.amount}}
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 快捷操作 -->
    <view class="card quick-actions-card">
      <view class="card-content">
        <view class="card-header">
          <text class="card-title">快捷操作</text>
        </view>
        <view class="actions-grid">
          <t-button theme="primary" size="large" bind:tap="addManualRecord" class="action-button primary-button">
              手动记账
            </t-button>
          <t-button theme="light" size="large" bind:tap="exportReport" class="action-button light-button">
              导出报表
            </t-button>
        </view>
      </view>
    </view>

      <!-- 底部安全区域占位 -->
      <view class="safe-area"></view>
  </scroll-view>
  </view>
  
  <!-- 交易详情弹窗组件 -->
  <finance-record-detail
    visible="{{showDetailPopup}}"
    record="{{selectedRecord}}"
    bind:close="closeDetailPopup"
  />
  
  <!-- 审批详情弹窗 -->
  <bottom-popup
    visible="{{showApprovalPopup}}"
    title="审批详情"
    show-close="{{true}}"
    show-actions="{{true}}"
    cancel-text="拒绝"
    confirm-text="通过"
    bind:close="closeApprovalPopup"
    bind:cancel="handleRejectApproval"
    bind:confirm="handleApproveApproval"
    bind:visiblechange="onApprovalPopupVisibleChange"
  >
    <view wx:if="{{selectedApprovalItem}}" class="approval-detail-content">
      <view class="info-card">
        <view class="card-content">
          <view class="info-row">
            <text class="info-label">申请人：</text>
            <text class="info-value">{{selectedApprovalItem.applicant}}</text>
          </view>
          <view class="divider-line"></view>
          
          <view class="info-row">
            <text class="info-label">申请类型：</text>
            <text class="info-value">{{selectedApprovalItem.title}}</text>
          </view>
          <view class="divider-line"></view>
          
          <block wx:if="{{selectedApprovalItem.description}}">
            <view class="info-row">
              <text class="info-label">说明：</text>
              <text class="info-value note-text">{{selectedApprovalItem.description}}</text>
            </view>
            <view class="divider-line"></view>
          </block>
          
          <view class="info-row">
            <text class="info-label">申请金额：</text>
            <text class="info-value amount-text expense">-¥{{selectedApprovalItem.amount}}</text>
          </view>
          <view class="divider-line"></view>
          
          <view class="info-row">
            <text class="info-label">提交时间：</text>
            <text class="info-value">{{selectedApprovalItem.submitTime}}</text>
          </view>
        </view>
      </view>
    </view>
  </bottom-popup>
  
  <!-- 拒绝原因输入弹窗 -->
  <bottom-popup
    visible="{{showRejectReasonPopup}}"
    title="拒绝审批"
    show-close="{{true}}"
    show-actions="{{true}}"
    cancel-text="取消"
    confirm-text="确认拒绝"
    bind:close="closeRejectReasonPopup"
    bind:cancel="closeRejectReasonPopup"
    bind:confirm="confirmRejectApproval"
  >
    <view class="reject-reason-content">
      <view class="reject-warning">
        <text>确定要拒绝此申请吗？请填写拒绝原因。</text>
      </view>
      <view class="form-item">
        <text class="form-label">拒绝原因 *</text>
        <t-textarea
          value="{{rejectReason}}"
          placeholder="请输入拒绝原因"
          maxlength="200"
          bind:change="onRejectReasonChange"
          class="reject-reason-textarea"
        />
      </view>
    </view>
  </bottom-popup>
</view>
