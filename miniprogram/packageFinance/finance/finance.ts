// finance.ts
// @ts-nocheck
import { createPageWithNavbar } from '../../utils/navigation'
import CloudApi from '../../utils/cloud-api'
import { logger } from '../../utils/logger'

type FinanceOverviewResponse = {
  income?: { total?: number; growth?: string }
  expense?: { total?: number }
  profit?: { total?: number; growth?: string }
  costBreakdown?: {
    feedCost?: number
    goslingCost?: number
    medicalCost?: number
    otherCost?: number
  }
}

type FinanceRecordsApiResult = {
  records?: FinanceRecordSourceItem[]
}

type FinanceRecordSourceItem = {
  id?: string
  _id?: string
  recordId?: string
  type: 'income' | 'expense'
  source: 'finance' | 'exit' | 'entry' | 'feed' | 'purchase' | string
  description?: string
  amount?: number
  createTime?: string
  date?: string
  batchNumber?: string
  costType?: string
  revenueType?: string
  isReimbursement?: boolean
  reimbursement?: {
    type?: string
    typeName?: string
    description?: string
    status?: 'pending' | 'approved' | 'rejected'
  }
  rawRecord?: Record<string, unknown>
  [key: string]: unknown}

type FinanceRecordDisplayItem = {
  id: string
  type: 'income' | 'expense'
  title: string
  description: string
  amount: string
  date: string
  source: string
  autoGenerated: boolean
  relatedInfo: string
  rawRecord: Record<string, unknown>
  timestamp: number
  status?: string
  statusTheme?: string
}

type FinanceApprovalListResponse = {
  records: FinanceApprovalRecord[]
}

type FinanceApprovalRecord = {
  _id?: string
  recordId?: string
  operatorName?: string
  operator?: string
  amount?: number
  createTime?: string
  description?: string
  reimbursement?: {
    type?: string
    typeName?: string
    reason?: string
  }
}

// æ·»åŠ CustomEventç±»å‹å®šä¹‰
type CustomEvent = WechatMiniprogram.CustomEvent

// é”™è¯¯ç±»å‹
interface ErrorWithMessage {
  message?: string
  errMsg?: string
}

type FinancialSummaryResponse = {
  growth?: {
    revenueGrowth?: string
  }
  currentPeriod?: {
    profit?: number
    revenue?: {
      totalRevenue?: number
    }
  }
}

// åˆ†é¡µé…ç½®
const PAGE_SIZE = 20;

const pageConfig: PageConfigWithLifecycle & { [key: string]: unknown } = {
  options: {
    styleIsolation: 'shared'
  },
  
  // âœ… æ€§èƒ½ä¼˜åŒ–ï¼šå®šæ—¶å™¨ç®¡ç†
  _timerIds: [] as number[],
  
  /**
   * âœ… å®‰å…¨è®¾ç½®å®šæ—¶å™¨ï¼ˆè‡ªåŠ¨è·Ÿè¸ªIDï¼‰
   */
  _safeSetTimeout(callback: () => void, delay: number): number {
    const timerId = setTimeout(() => {
      const index = this._timerIds.indexOf(timerId as unknown as number)
      if (index > -1) {
        this._timerIds.splice(index, 1)
      }
      callback()
    }, delay) as unknown as number
    this._timerIds.push(timerId)
    return timerId
  },
  
  /**
   * âœ… æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
   */
  _clearAllTimers() {
    this._timerIds.forEach((id: number) => clearTimeout(id))
    this._timerIds = []
  },
  
  data: {
    activeTab: 'records',
    
    // åˆ†æå†å²è¯¦æƒ…å¼¹çª—ï¼ˆä»…ç”¨äºä»å…¨éƒ¨å†å²é¡µé¢è·³è½¬å›æ¥æ—¶ï¼‰
    showAnalysisDetailPopup: false,
    selectedAnalysisItem: null as unknown,
    
    // æ—¶é—´ç­›é€‰ - ç¬¬ä¸€çº§ï¼šç±»å‹é€‰æ‹©
    filterType: 'all', // 'all', 'month', 'quarter', 'year', 'custom'
    filterTypeLabel: 'å…¨éƒ¨',
    filterTypeIndex: 0,
    filterTypeOptions: [
      {label: 'å…¨éƒ¨', value: 'all'},
      {label: 'æœˆåº¦', value: 'month'},
      {label: 'å­£åº¦', value: 'quarter'},
      {label: 'å¹´åº¦', value: 'year'},
      {label: 'è‡ªå®šä¹‰', value: 'custom'}
    ],
    
    // ç¬¬äºŒçº§ï¼šå…·ä½“æ—¶é—´é€‰æ‹©
    selectedMonth: '', // æ ¼å¼ï¼š2025-11
    selectedMonthIndex: 0,
    monthOptions: [] as {label: string, value: string}[], // æœ€è¿‘12ä¸ªæœˆ
    
    selectedQuarter: '', // æ ¼å¼ï¼š2025-Q4
    selectedQuarterIndex: 0,
    quarterOptions: [] as {label: string, value: string}[], // æœ€è¿‘8ä¸ªå­£åº¦
    
    selectedYear: '', // æ ¼å¼ï¼š2025
    selectedYearIndex: 0,
    yearOptions: [] as {label: string, value: string}[], // æœ€è¿‘5å¹´
    
    // è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
    customStartDate: '',
    customEndDate: '',
    
    // è´¢åŠ¡æ¦‚è§ˆ
    overview: {
      income: '0',
      expense: '0',
      profit: '0',
      profitColorClass: 'danger', // å‡€åˆ©æ¶¦é¢œè‰²ç±»ï¼šè´Ÿæ•°ä¸ºsuccess(ç»¿è‰²)ï¼Œæ­£æ•°ä¸ºdanger(çº¢è‰²)
      growthRate: '0',
      feedCost: '0',
      feedPercent: '0',
      goslingCost: '0',
      goslingPercent: '0',
      medicalCost: '0',
      medicalPercent: '0',
      otherCost: '0',
      otherPercent: '0'
    },
    
    // åŸå§‹è´¢åŠ¡æ•°æ®ï¼ˆç”¨äºAIåˆ†æï¼‰
    rawFinanceData: null as unknown,
    
    // AIåˆ†ææ‰€éœ€çš„å…¶ä»–æ¨¡å—æ•°æ®ï¼ˆé¿å…åœ¨ç»„ä»¶ä¸­é‡å¤è°ƒç”¨äº‘å‡½æ•°ï¼‰
    productionData: null as unknown,
    healthData: null as unknown,
    goosePriceData: null as unknown,
    
    // ç­›é€‰æ¡ä»¶
    filters: {
      type: 'å…¨éƒ¨ç±»å‹',
      period: 'æœ€è¿‘7å¤©'
    },
    typeOptions: [
      {label: 'å…¨éƒ¨ç±»å‹', value: 'å…¨éƒ¨ç±»å‹'},
      {label: 'æ”¶å…¥', value: 'æ”¶å…¥'},
      {label: 'æ”¯å‡º', value: 'æ”¯å‡º'}
    ],
    periodOptions: [
      {label: 'æœ€è¿‘7å¤©', value: 'æœ€è¿‘7å¤©'},
      {label: 'æœ€è¿‘30å¤©', value: 'æœ€è¿‘30å¤©'},
      {label: 'æœ¬æœˆ', value: 'æœ¬æœˆ'}
    ],
    
    // è´¢åŠ¡è®°å½•ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
    records: [],
    
    // è´¢åŠ¡æŠ¥è¡¨ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
    reports: {
      yearGrowth: '0',
      profitRate: '0'
    },
    
    // å®¡æ‰¹äº‹é¡¹ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
    approvalItems: [],
    
    // å®¡æ‰¹å†å²å·²æ”¹ä¸ºæŒ‰é’®è·³è½¬ï¼Œä¸éœ€è¦åœ¨ä¸»é¡µåŠ è½½
    // approvalHistory: [] as unknown[],
    
    filteredRecords: [],
    
    // æ˜¾ç¤ºçš„è®°å½•åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºå‰5æ¡ï¼‰
    displayRecords: [],
    
    // äº¤æ˜“è¯¦æƒ…å¼¹çª—
    showDetailPopup: false,
    selectedRecord: null as unknown,
    
    // å®¡æ‰¹è¯¦æƒ…å¼¹çª—
    showApprovalPopup: false,
    selectedApprovalItem: null as unknown,
    
    // æ‹’ç»åŸå› è¾“å…¥å¼¹çª—
    showRejectReasonPopup: false,
    rejectReason: '',
    
    // æ€§èƒ½ä¼˜åŒ–ç›¸å…³
    isFirstLoad: true,
    tabLoadStatus: {
      records: false,
      approval: false,
      reports: false,
      aiAnalysis: false
    },
    recordsPagination: {
      page: 1,
      hasMore: true,
      loading: false
    },
    dataCache: {
      lastUpdateTime: 0,
      cacheTimeout: 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜
    }
  },

  onLoad() {
    // ğŸ¯ æ€§èƒ½ä¼˜åŒ–ï¼šåˆ†æ­¥åŠ è½½
    const startTime = Date.now()
    logger.info('è´¢åŠ¡é¡µé¢å¼€å§‹åŠ è½½')
    
    // åˆå§‹åŒ–æ—¶é—´é€‰é¡¹ï¼ˆåŒæ­¥æ“ä½œï¼‰
    this.initTimeOptions()
    
    // åˆå§‹åŒ–ç­›é€‰è®°å½•
    this.setData({
      filteredRecords: [],
      displayRecords: [],
      isFirstLoad: true
    })
    
    // ğŸ¯ ä¼˜åŒ–ï¼šåªåŠ è½½æ¦‚è§ˆæ•°æ®ï¼ˆå¿«é€Ÿæ˜¾ç¤ºé¦–å±ï¼‰
    this.loadFinanceData().then(() => {
      logger.info(`æ¦‚è§ˆæ•°æ®åŠ è½½å®Œæˆï¼Œè€—æ—¶ï¼š${Date.now() - startTime}ms`)
      
      // å»¶è¿Ÿ100msååŠ è½½å½“å‰tabæ•°æ®
      this._safeSetTimeout(() => {
        this.loadCurrentTabData()
      }, 100)
    })
  },
  
  // ğŸ¯ ä¼˜åŒ–ï¼šonShowæ™ºèƒ½åˆ·æ–°
  onShow() {
    // åªåœ¨éé¦–æ¬¡åŠ è½½ä¸”ç¼“å­˜è¿‡æœŸæ—¶åˆ·æ–°
    if (!this.data.isFirstLoad) {
      const now = Date.now()
      const { lastUpdateTime, cacheTimeout } = this.data.dataCache
      
      if (now - lastUpdateTime > cacheTimeout) {
        // åªåˆ·æ–°å½“å‰tabæ•°æ®
        this.refreshCurrentTab()
      }
    }
    
    // æ¸…é™¤é¦–æ¬¡åŠ è½½æ ‡è®°
    if (this.data.isFirstLoad) {
      this.setData({ isFirstLoad: false })
    }
  },
  
  // âœ… é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
  onUnload() {
    this._clearAllTimers()
  },
  
  // ğŸ¯ ä¼˜åŒ–ï¼šæŒ‰éœ€åŠ è½½å½“å‰tabæ•°æ®
  loadCurrentTabData() {
    const activeTab = this.data.activeTab
    
    // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
    if (this.data.tabLoadStatus[activeTab]) {
      return
    }
    
    switch(activeTab) {
      case 'records':
        this.loadFinanceRecords()
        break
      case 'approval':
        this.loadApprovalItems()
        break
      case 'reports':
        this.loadFinancialReports()
        break
      case 'aiAnalysis':
        this.loadModuleDataForAI()
        break
    }
    
    // æ ‡è®°å·²åŠ è½½
    this.setData({
      [`tabLoadStatus.${activeTab}`]: true,
      'dataCache.lastUpdateTime': Date.now()
    })
  },
  
  // åˆ·æ–°å½“å‰tabæ•°æ®
  refreshCurrentTab() {
    const activeTab = this.data.activeTab
    
    // é‡ç½®tabåŠ è½½çŠ¶æ€
    this.setData({
      [`tabLoadStatus.${activeTab}`]: false
    })
    
    // é‡æ–°åŠ è½½
    this.loadCurrentTabData()
  },
  
  // åˆå§‹åŒ–æ—¶é—´é€‰é¡¹
  initTimeOptions() {
    const now = new Date()
    const currentYear = now.getFullYear()
    const currentMonth = now.getMonth()
    const currentQuarter = Math.floor(currentMonth / 3)
    
    // ç”Ÿæˆæœ€è¿‘12ä¸ªæœˆçš„é€‰é¡¹
    const monthOptions: {label: string, value: string}[] = []
    for (let i = 0; i < 12; i++) {
      const date = new Date(currentYear, currentMonth - i, 1)
      const year = date.getFullYear()
      const month = date.getMonth() + 1
      const value = `${year}-${month.toString().padStart(2, '0')}`
      const label = `${year}å¹´${month}æœˆ`
      monthOptions.push({label, value})
    }
    
    // ç”Ÿæˆæœ€è¿‘8ä¸ªå­£åº¦çš„é€‰é¡¹
    const quarterOptions: {label: string, value: string}[] = []
    for (let i = 0; i < 8; i++) {
      const totalQuarters = currentYear * 4 + currentQuarter - i
      const year = Math.floor(totalQuarters / 4)
      const quarter = (totalQuarters % 4) + 1
      const value = `${year}-Q${quarter}`
      const label = `${year}å¹´ç¬¬${quarter}å­£åº¦`
      quarterOptions.push({label, value})
    }
    
    // ç”Ÿæˆæœ€è¿‘5å¹´çš„é€‰é¡¹
    const yearOptions: {label: string, value: string}[] = []
    for (let i = 0; i < 5; i++) {
      const year = currentYear - i
      const value = year.toString()
      const label = `${year}å¹´`
      yearOptions.push({label, value})
    }
    
    this.setData({
      monthOptions,
      quarterOptions,
      yearOptions,
      selectedMonth: monthOptions[0].value,
      selectedQuarter: quarterOptions[0].value,
      selectedYear: yearOptions[0].value
    })
  },

  // è¿”å›ä¸Šä¸€é¡µ
  goBack() {
    wx.navigateBack({
      fail: () => {
        wx.switchTab({
          url: '/pages/profile/profile'
        })
      }
    })
  },

  // èœå•ç‚¹å‡»
  onMenuTap() {
    // å¯ä»¥æ·»åŠ æ›´å¤šèœå•é€‰é¡¹
  },

  // æ—¶é—´ç­›é€‰ç±»å‹é€‰æ‹©ï¼ˆç¬¬ä¸€çº§ï¼‰
  onFilterTypeChange(e: WechatMiniprogram.CustomEvent) {
    const selectedIndex = e.detail.value || 0
    const selectedOption = this.data.filterTypeOptions[selectedIndex]
    
    if (selectedOption) {
      this.setData({
        filterType: selectedOption.value,
        filterTypeLabel: selectedOption.label,
        filterTypeIndex: selectedIndex
      })
      
      // éè‡ªå®šä¹‰æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
      if (selectedOption.value !== 'custom') {
        this.loadFinanceData()
        this.loadFinanceRecords()
        this.loadFinancialReports()
      }
    }
  },
  
  // æœˆåº¦é€‰æ‹©å˜åŒ–ï¼ˆç¬¬äºŒçº§ï¼‰
  onMonthChange(e: WechatMiniprogram.CustomEvent) {
    const index = e.detail.value
    const selected = this.data.monthOptions[index]
    this.setData({
      selectedMonth: selected.value,
      selectedMonthIndex: index
    })
    this.loadFinanceData()
    this.loadFinanceRecords()
    this.loadFinancialReports()
  },
  
  // å­£åº¦é€‰æ‹©å˜åŒ–ï¼ˆç¬¬äºŒçº§ï¼‰
  onQuarterChange(e: WechatMiniprogram.CustomEvent) {
    const index = e.detail.value
    const selected = this.data.quarterOptions[index]
    this.setData({
      selectedQuarter: selected.value,
      selectedQuarterIndex: index
    })
    this.loadFinanceData()
    this.loadFinanceRecords()
    this.loadFinancialReports()
  },
  
  // å¹´åº¦é€‰æ‹©å˜åŒ–ï¼ˆç¬¬äºŒçº§ï¼‰
  onYearChange(e: WechatMiniprogram.CustomEvent) {
    const index = e.detail.value
    const selected = this.data.yearOptions[index]
    this.setData({
      selectedYear: selected.value,
      selectedYearIndex: index
    })
    this.loadFinanceData()
    this.loadFinanceRecords()
    this.loadFinancialReports()
  },
  
  // è‡ªå®šä¹‰å¼€å§‹æ—¥æœŸå˜åŒ–
  onStartDateChange(e: WechatMiniprogram.CustomEvent) {
    this.setData({
      customStartDate: e.detail.value
    })
    
    // å¦‚æœç»“æŸæ—¥æœŸä¹Ÿå·²é€‰æ‹©ï¼Œåˆ™åŠ è½½æ•°æ®
    if (this.data.customEndDate) {
      this.loadFinanceData()
      this.loadFinanceRecords()
      this.loadFinancialReports()
    }
  },
  
  // è‡ªå®šä¹‰ç»“æŸæ—¥æœŸå˜åŒ–
  onEndDateChange(e: WechatMiniprogram.CustomEvent) {
    this.setData({
      customEndDate: e.detail.value
    })
    
    // å¦‚æœå¼€å§‹æ—¥æœŸä¹Ÿå·²é€‰æ‹©ï¼Œåˆ™åŠ è½½æ•°æ®
    if (this.data.customStartDate) {
      this.loadFinanceData()
      this.loadFinanceRecords()
      this.loadFinancialReports()
    }
  },

  // è·å–å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´
  getDateRange() {
    switch (this.data.filterType) {
      case 'all':
        // å…¨éƒ¨ï¼šä¸è®¾ç½®æ—¶é—´èŒƒå›´
        return undefined
        
      case 'month':
        // æœˆåº¦ï¼šæ ¹æ®é€‰æ‹©çš„æœˆä»½
        if (this.data.selectedMonth) {
          const [year, month] = this.data.selectedMonth.split('-').map(Number)
          const startDate = new Date(year, month - 1, 1, 0, 0, 0, 0)
          const endDate = new Date(year, month, 0, 23, 59, 59, 999)
          return {
            start: startDate.toISOString(),
            end: endDate.toISOString()
          }
        }
        break
        
      case 'quarter':
        // å­£åº¦ï¼šæ ¹æ®é€‰æ‹©çš„å­£åº¦
        if (this.data.selectedQuarter) {
          const [year, q] = this.data.selectedQuarter.split('-Q').map(Number)
          const startMonth = (q - 1) * 3
          const startDate = new Date(year, startMonth, 1, 0, 0, 0, 0)
          const endDate = new Date(year, startMonth + 3, 0, 23, 59, 59, 999)
          return {
            start: startDate.toISOString(),
            end: endDate.toISOString()
          }
        }
        break
        
      case 'year':
        // å¹´åº¦ï¼šæ ¹æ®é€‰æ‹©çš„å¹´ä»½
        if (this.data.selectedYear) {
          const year = Number(this.data.selectedYear)
          const startDate = new Date(year, 0, 1, 0, 0, 0, 0)
          const endDate = new Date(year, 11, 31, 23, 59, 59, 999)
          return {
            start: startDate.toISOString(),
            end: endDate.toISOString()
          }
        }
        break
        
      case 'custom':
        // è‡ªå®šä¹‰ï¼šæ ¹æ®é€‰æ‹©çš„å¼€å§‹å’Œç»“æŸæ—¥æœŸ
        if (this.data.customStartDate && this.data.customEndDate) {
          const startDate = new Date(this.data.customStartDate)
          startDate.setHours(0, 0, 0, 0)
          const endDate = new Date(this.data.customEndDate)
          endDate.setHours(23, 59, 59, 999)
          return {
            start: startDate.toISOString(),
            end: endDate.toISOString()
          }
        }
        break
    }
    
    // é»˜è®¤è¿”å› undefinedï¼ˆä¸é™åˆ¶æ—¶é—´ï¼‰
    return undefined
  },

  // Tabåˆ‡æ¢ - TDesign 
  onTabChange(e: WechatMiniprogram.CustomEvent) {
    const { value } = e.detail
    this.setData({
      activeTab: value
    }, () => {
      // åˆ‡æ¢ååŠ è½½å¯¹åº”tabçš„æ•°æ®
      this.loadCurrentTabData()
    })
  },

  // åˆ‡æ¢Tabçš„æ—§æ–¹æ³•ä¿æŒå…¼å®¹
  switchTab(e: WechatMiniprogram.CustomEvent) {
    const { tab } = e.currentTarget.dataset
    this.setData({
      activeTab: tab
    }, () => {
      // åˆ‡æ¢ååŠ è½½å¯¹åº”tabçš„æ•°æ®
      this.loadCurrentTabData()
    })
  },

  // ç±»å‹ç­›é€‰
  onTypeFilterChange(e: WechatMiniprogram.CustomEvent) {
    this.setData({
      'filters.type': e.detail.value
    })
    this.filterRecords()
  },

  // æ—¶é—´ç­›é€‰
  onPeriodFilterChange(e: WechatMiniprogram.CustomEvent) {
    this.setData({
      'filters.period': e.detail.value
    })
    this.filterRecords()
  },

  // ç­›é€‰è®°å½•
  filterRecords() {
    let filtered = [...this.data.records]
    
    // æŒ‰ç±»å‹ç­›é€‰
    if (this.data.filters.type !== 'å…¨éƒ¨ç±»å‹') {
      const typeMap: unknown = { 'æ”¶å…¥': 'income', 'æ”¯å‡º': 'expense' }
      filtered = filtered.filter(record => 
        record.type === typeMap[this.data.filters.type]
      )
    }
    
    // æŒ‰æ—¶é—´ç­›é€‰
    if (this.data.filters.period !== 'å…¨éƒ¨æ—¶é—´') {
      const now = new Date()
      let startTimestamp: number
      
      switch (this.data.filters.period) {
        case 'æœ€è¿‘7å¤©':
          startTimestamp = now.getTime() - 7 * 24 * 60 * 60 * 1000
          break
        case 'æœ€è¿‘30å¤©':
          startTimestamp = now.getTime() - 30 * 24 * 60 * 60 * 1000
          break
        case 'æœ¬æœˆ':
          startTimestamp = new Date(now.getFullYear(), now.getMonth(), 1).getTime()
          break
        default:
          startTimestamp = 0 // ä¸é™åˆ¶
      }
      
      filtered = filtered.filter(record => {
        // ä½¿ç”¨æ—¶é—´æˆ³è¿›è¡Œç­›é€‰
        const recordTimestamp = (record as { timestamp?: number; date: string }).timestamp || this.parseDate(record.date).getTime()
        return recordTimestamp >= startTimestamp
      })
    }
    
    this.setData({
      filteredRecords: filtered
    })
    
    // æ›´æ–°æ˜¾ç¤ºè®°å½•
    this.updateDisplayRecords()
  },

  // æ›´æ–°æ˜¾ç¤ºè®°å½•ï¼ˆåªæ˜¾ç¤ºå‰5æ¡ï¼‰
  updateDisplayRecords() {
    const { filteredRecords } = this.data
    const displayRecords = filteredRecords.slice(0, 5)
    
    this.setData({
      displayRecords: displayRecords
    })
  },

  // è·³è½¬åˆ°è¯¦ç»†è®°å½•é¡µé¢
  viewAllRecords() {
    wx.navigateTo({
      url: '/packageFinance/finance-record-list/finance-record-list'
    })
  },

  // åŠ è½½è´¢åŠ¡æ•°æ®
  async loadFinanceData() {
    wx.showLoading({
      title: 'åŠ è½½ä¸­...'
    })
    
    try {
      // è·å–å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´
      const dateRange = this.getDateRange()
    
      // è°ƒç”¨äº‘å‡½æ•°åŠ è½½è´¢åŠ¡æ•°æ®
      const result = await CloudApi.callFunction<FinanceOverviewResponse>(
        'finance-management',
        {
          action: 'get_finance_overview',
          dateRange: dateRange,
          batchId: null  // è´¢åŠ¡æ¦‚è§ˆä¸æŒ‰æ‰¹æ¬¡ç­›é€‰
        },
        {
          showError: false
        }
      )

      wx.hideLoading()

      if (result.success && result.data) {
        // å¤„ç†è´¢åŠ¡æ•°æ®
        this.processFinanceData(result.data)
      } else {
        throw new Error(result.error || 'åŠ è½½å¤±è´¥')
      }
    } catch (error) {
      wx.hideLoading()
      wx.showToast({
        title: (error as Error)?.message || 'åŠ è½½æ•°æ®å¤±è´¥',
        icon: 'none'
    })
    }
  },
  
  // å¤„ç†è´¢åŠ¡æ•°æ®
  processFinanceData(data: FinanceOverviewResponse) {
    const income = data.income?.total || 0
    const expense = data.expense?.total || 0
    const profit = data.profit?.total || 0
    const costBreakdown = data.costBreakdown || {}

    // è½¬æ¢ä¸ºä¸‡å…ƒå•ä½æ˜¾ç¤ºï¼ˆä¿ç•™ä¸¤ä½å°æ•°ï¼Œå»æ‰æœ«å°¾çš„0ï¼‰
    const formatToWan = (value: number) => {
      const wan = value / 10000
      // ä¿ç•™ä¸¤ä½å°æ•°ï¼Œç„¶åå»æ‰æœ«å°¾çš„0
      return parseFloat(wan.toFixed(2)).toString()
    }

    // è®¡ç®—å‡€åˆ©æ¶¦é¢œè‰²ç±»ï¼šè´Ÿæ•°ä¸ºç»¿è‰²(success)ï¼Œæ­£æ•°ä¸ºçº¢è‰²(danger)
    const profitColorClass = parseFloat(formatToWan(profit)) < 0 ? 'success' : 'danger'

    // è®¡ç®—æˆæœ¬å æ¯”
    const totalExpense = expense || 0
    const calculatePercent = (cost: number) => {
      return totalExpense > 0 ? ((cost / totalExpense) * 100).toFixed(1) : '0'
    }

    // è·å–å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´
    const dateRange = this.getDateRange()

    // ä¿å­˜åŸå§‹è´¢åŠ¡æ•°æ®ï¼ˆç”¨äºAIåˆ†æï¼‰
    const rawFinanceData = {
      income: data.income || {},
      expense: data.expense || {},
      profit: data.profit || {},
      costBreakdown: costBreakdown,
      dateRange: dateRange || null  // ç¡®ä¿æ˜¯ null è€Œä¸æ˜¯ undefined
    }

    this.setData({
      overview: {
        income: formatToWan(income),
        expense: formatToWan(expense),
        profit: formatToWan(profit),
        profitColorClass: profitColorClass,
        expenseColorClass: 'danger', // æ€»æ”¯å‡ºæ˜¾ç¤ºçº¢è‰²
        growthRate: data.profit?.growth || '0',
        feedCost: formatToWan(costBreakdown.feedCost || 0),
        feedPercent: calculatePercent(costBreakdown.feedCost || 0),
        goslingCost: formatToWan(costBreakdown.goslingCost || 0),
        goslingPercent: calculatePercent(costBreakdown.goslingCost || 0),
        medicalCost: formatToWan(costBreakdown.medicalCost || 0),
        medicalPercent: calculatePercent(costBreakdown.medicalCost || 0),
        otherCost: formatToWan(costBreakdown.otherCost || 0),
        otherPercent: calculatePercent(costBreakdown.otherCost || 0)
      },
      rawFinanceData: rawFinanceData
    })
  },

  // åŠ è½½è´¢åŠ¡è®°å½•ï¼ˆæ”¶å…¥å’Œæ”¯å‡ºï¼ŒåŒ…æ‹¬ä¸šåŠ¡è®°å½•ï¼‰
  async loadFinanceRecords() {
    try {
      // è·å–å½“å‰é€‰æ‹©çš„æ—¶é—´èŒƒå›´
      let dateRange = this.getDateRange()
      
      // å¦‚æœæ²¡æœ‰è®¾ç½®æ—¥æœŸèŒƒå›´ï¼ˆfilterType === 'all'ï¼‰ï¼Œä½¿ç”¨ä¸ finance-record-list.ts ç›¸åŒçš„é€»è¾‘ï¼šä»Šå¹´èŒƒå›´
      if (!dateRange) {
        const now = new Date()
        const startDate = new Date(now.getFullYear(), 0, 1).toISOString() // ä»Šå¹´å¼€å§‹
        const endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59).toISOString() // ä»Šå¹´ç»“æŸ
        dateRange = { start: startDate, end: endDate }
      }

      // ä½¿ç”¨æ–°çš„æ¥å£è·å–æ‰€æœ‰è´¢åŠ¡ç›¸å…³è®°å½•ï¼ˆåŒ…æ‹¬ä¸šåŠ¡è®°å½•ï¼‰
      const result = await CloudApi.callFunction<FinanceRecordsApiResult>(
        'finance-management',
        {
          action: 'get_all_finance_records',
          page: 1,
          pageSize: 200, // å¢åŠ æ•°é‡ä»¥è·å–æ›´å¤šè®°å½•
          dateRange: dateRange,
          batchId: null  // è´¢åŠ¡æ¦‚è§ˆä¸æŒ‰æ‰¹æ¬¡ç­›é€‰
        },
        {
          showError: false
        }
      )

      if (!result.success) {
        throw new Error(result.error || 'åŠ è½½å¤±è´¥')
      }

      const records: FinanceRecordDisplayItem[] = []
      const allRecords = result.data?.records || []

      // å¤„ç†æ‰€æœ‰è®°å½•ï¼ˆä¸ finance-record-list.ts ä¿æŒå®Œå…¨ä¸€è‡´ï¼‰
      allRecords.forEach((record: FinanceRecordSourceItem) => {
        // æ ¹æ®æ¥æºç±»å‹æ ¼å¼åŒ–è®°å½•
        let title = ''
        let description = record.description || ''
        let autoGenerated = false
        let relatedInfo = 'æ‰‹åŠ¨å½•å…¥'
        
        // ç¡®ä¿ rawRecord åŒ…å«å®Œæ•´çš„åŸå§‹æ•°æ®ï¼ˆä¸ finance-record-list.ts ä¸€è‡´ï¼‰
        let rawRecord = record.rawRecord || record
        
        // å¯¹äºä¸šåŠ¡è®°å½•ï¼Œç¡®ä¿ rawRecord åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
        if (record.source === 'exit' || record.source === 'entry' || record.source === 'feed' || record.source === 'purchase') {
          if (!record.rawRecord) {
            rawRecord = {
              ...record,
              batchNumber: record.batchNumber,
              customer: record.customer,
              supplier: record.supplier,
              quantity: record.quantity,
              breed: record.breed,
              exitNumber: record.exitNumber,
              amount: record.materialAmount || record.feedAmount || record.amount,
              unit: record.unit,
              materialName: record.materialName,
              name: record.name
            }
          }
        }

        if (record.source === 'finance') {
          // è´¢åŠ¡è®°å½•
          if (record.isReimbursement && record.reimbursement) {
            // æŠ¥é”€è®°å½•
            title = this.getReimbursementTitle(record.reimbursement.type)
            description = record.description || record.reimbursement.description || ''
            if (record.reimbursement.status === 'approved') {
              autoGenerated = false
              relatedInfo = 'å·²å®¡æ‰¹æŠ¥é”€'
            } else {
              // ä¸åº”è¯¥å‡ºç°æœªå®¡æ‰¹çš„æŠ¥é”€è®°å½•ï¼Œä½†ä»¥é˜²ä¸‡ä¸€
              autoGenerated = false
              relatedInfo = 'æŠ¥é”€ç”³è¯·'
            }
          } else {
            // å¤„ç†å¥åº·ç®¡ç†ç›¸å…³çš„è´¢åŠ¡è®°å½•
            if (record.description) {
              // ä¼˜åŒ–æè¿°æ ¼å¼ï¼Œé¿å…æ˜¾ç¤ºundefined
              let cleanDesc = record.description
                .replace('é¢„é˜²ä»»åŠ¡ï¼šundefined', '')
                .replace('é¢„é˜²ä»»åŠ¡ï¼š', '')
                .replace('undefined', '')
                .trim()
              
              if (record.description.includes('ç–«è‹—æ¥ç§')) {
                title = 'ç–«è‹—æ¥ç§'
                // æå–ç–«è‹—åç§°
                const vaccineMatch = cleanDesc.match(/ç–«è‹—æ¥ç§ - (.+)/)
                if (vaccineMatch) {
                  description = vaccineMatch[1]
                } else {
                  description = cleanDesc || 'ç–«è‹—æ¥ç§è´¹ç”¨'
                }
              } else if (record.description.includes('æ¶ˆæ¯’ç®¡ç†')) {
                title = 'æ¶ˆæ¯’ç®¡ç†'
                description = cleanDesc || 'æ¶ˆæ¯’è´¹ç”¨'
              } else if (record.description.includes('ç”¨è¯ç®¡ç†')) {
                title = 'ç”¨è¯ç®¡ç†'
                description = cleanDesc || 'ç”¨è¯è´¹ç”¨'
              } else if (record.costType === 'health') {
                // å¥åº·ç›¸å…³è´¹ç”¨
                title = 'åŒ»ç–—è´¹ç”¨'
                description = cleanDesc || 'å¥åº·ç®¡ç†è´¹ç”¨'
              } else {
                // æ™®é€šè´¹ç”¨è®°å½•
                title = this.getCostTitle(record.costType, record.description)
                description = cleanDesc
              }
            } else {
              // æ™®é€šè´¹ç”¨è®°å½•
              title = this.getCostTitle(record.costType, record.description)
              description = ''
            }
          }
          autoGenerated = !!record.relatedRecordId
          relatedInfo = record.relatedRecordId ? 'å…³è”è®°å½•' : 'æ‰‹åŠ¨å½•å…¥'
        } else if (record.source === 'exit') {
          // å‡ºæ è®°å½•ï¼ˆé”€å”®æ”¶å…¥ï¼‰
          title = 'æˆé¹…é”€å”®æ”¶å…¥'
          description = record.description || `æ‰¹æ¬¡ï¼š${record.batchNumber || ''} - å®¢æˆ·ï¼š${rawRecord?.customer || 'æœªçŸ¥'}`
          autoGenerated = true
          relatedInfo = 'è‡ªåŠ¨ç”Ÿæˆ-å‡ºæ è®°å½•'
        } else if (record.source === 'entry') {
          // å…¥æ è®°å½•ï¼ˆé‡‡è´­æˆæœ¬ï¼‰
          title = 'å…¥æ é‡‡è´­'
          description = record.description || `æ‰¹æ¬¡ï¼š${record.batchNumber || ''}`
          autoGenerated = true
          relatedInfo = 'è‡ªåŠ¨ç”Ÿæˆ-å…¥æ è®°å½•'
        } else if (record.source === 'feed') {
          // æŠ•å–‚è®°å½•ï¼ˆé¥²æ–™æˆæœ¬ï¼‰
          title = 'é¥²æ–™æˆæœ¬'
          description = record.description || `æ‰¹æ¬¡ï¼š${record.batchNumber || ''}`
          autoGenerated = true
          relatedInfo = 'è‡ªåŠ¨ç”Ÿæˆ-æŠ•å–‚è®°å½•'
        } else if (record.source === 'purchase') {
          // é‡‡è´­è®°å½•ï¼ˆç‰©æ–™é‡‡è´­ï¼‰
          if (record.costType === 'feed') {
            title = 'é¥²æ–™æˆæœ¬'
          } else if (record.costType === 'health') {
            title = 'åŒ»ç–—è´¹ç”¨'
          } else {
            title = 'å…¶ä»–è´¹ç”¨'
          }
          description = record.description || 'ç‰©æ–™é‡‡è´­'
          autoGenerated = true
          relatedInfo = 'è‡ªåŠ¨ç”Ÿæˆ-é‡‡è´­è®°å½•'
        }

        // è·å–åŸå§‹æ—¶é—´æˆ³ç”¨äºæ’åº
        const rawDate = record.createTime || record.date
        let timestamp: number
        
        // å¦‚æœ rawDate æ˜¯æ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
        if (typeof rawDate === 'number') {
          timestamp = rawDate
        } else {
          // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè§£ææ—¥æœŸ
          const parsedDate = this.parseDate(rawDate)
          timestamp = parsedDate.getTime()
          
          // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
          if (isNaN(timestamp)) {
            timestamp = Date.now()
          }
        }
        
        records.push({
          id: record.id || record._id || record.recordId || `${record.source}_${record.createTime || record.date || Date.now()}`,
          type: record.type,
          title: title,
          description: description,
          amount: this.formatAmount(record.amount || 0),
          date: this.formatDate(record.createTime || record.date || ''),
          timestamp: timestamp, // ä¿å­˜æ—¶é—´æˆ³ç”¨äºæ’åº
          status: record.status === 'confirmed' ? (record.type === 'income' ? 'å·²å…¥è´¦' : 'å·²æ”¯å‡º') : 'å¾…ç¡®è®¤',
          statusTheme: record.status === 'confirmed' ? (record.type === 'income' ? 'success' : 'danger') : 'warning',
          autoGenerated: autoGenerated,
          relatedInfo: relatedInfo,
          source: record.source, // è®°å½•æ¥æº
          rawRecord: rawRecord // ä½¿ç”¨å¤„ç†åçš„å®Œæ•´ rawRecordï¼ˆä¸ finance-record-list.ts ä¸€è‡´ï¼‰
        })
      })

      // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sortedRecords = records.sort((a: unknown, b: unknown) => {
        const timestampA = (a as Record<string, unknown>).timestamp as number
        const timestampB = (b as Record<string, unknown>).timestamp as number
        return timestampB - timestampA
      })

      // æ›´æ–°è®°å½•åˆ—è¡¨
      this.setData({
        records: sortedRecords
      })
      
      // åº”ç”¨ç­›é€‰æ¡ä»¶
      this.filterRecords()
    } catch (error: unknown) {
      logger.error('åŠ è½½è´¢åŠ¡æ•°æ®å¤±è´¥:', error)
      wx.showToast({
        title: (error as Error).message || 'åŠ è½½å¤±è´¥',
        icon: 'none'
      })
    }
  },

  // è·å–æ”¶å…¥æ ‡é¢˜
  getRevenueTitle(revenueType: string, description: string): string {
    const typeMap: unknown = {
      'sales': 'é”€å”®æ”¶å…¥',
      'subsidy': 'è¡¥è´´æ”¶å…¥',
      'other': 'å…¶ä»–æ”¶å…¥'
    }
    return typeMap[revenueType] || description || 'æ”¶å…¥è®°å½•'
  },

  // è·å–æ”¯å‡ºæ ‡é¢˜
  getCostTitle(costType: string, description: string): string {
    const typeMap: unknown = {
      'feed': 'é¥²æ–™æˆæœ¬',
      'health': 'åŒ»ç–—è´¹ç”¨',
      'labor': 'å…¶ä»–è´¹ç”¨',     // äººå·¥å½’å…¥å…¶ä»–è´¹ç”¨
      'facility': 'è®¾æ–½æˆæœ¬',  // è®¾æ–½æˆæœ¬å•ç‹¬æ˜¾ç¤º
      'other': 'å…¶ä»–è´¹ç”¨',     // å…¶ä»–å½’å…¥å…¶ä»–è´¹ç”¨
      'loss': 'æŸå¤±è´¹ç”¨',
      'death_loss': 'æ­»äº¡æŸå¤±',
      'treatment': 'æ²»ç–—è´¹ç”¨'
    }
    return typeMap[costType] || description || 'æ”¯å‡ºè®°å½•'
  },

  // è·å–æŠ¥é”€ç±»å‹æ ‡é¢˜
  getReimbursementTypeTitle(reimbursementType: string): string {
    const typeMap: unknown = {
      'feed': 'é¥²æ–™é‡‡è´­',
      'medicine': 'å…½è¯é‡‡è´­',
      'vaccine': 'é˜²ç–«è´¹ç”¨',
      'equipment': 'è®¾å¤‡ç»´ä¿®',
      'transport': 'è¿è¾“è´¹ç”¨',
      'utilities': 'æ°´ç”µè´¹',
      'labor': 'åŠ³åŠ¡è´¹ç”¨',
      'other': 'å…¶ä»–è´¹ç”¨'
    }
    return typeMap[reimbursementType] || 'å…¶ä»–è´¹ç”¨'
  },

  // è·å–æŠ¥é”€æ ‡é¢˜ï¼ˆåˆ«åæ–¹æ³•ï¼Œå…¼å®¹æ€§ï¼‰
  getReimbursementTitle(reimbursementType: string): string {
    return this.getReimbursementTypeTitle(reimbursementType)
  },

  // æ ¼å¼åŒ–é‡‘é¢
  formatAmount(amount: number): string {
    return amount ? amount.toLocaleString('zh-CN', { maximumFractionDigits: 0 }) : '0'
  },

  // å®‰å…¨è§£ææ—¥æœŸï¼ˆå…¼å®¹å¤šç§æ ¼å¼ï¼‰
  parseDate(dateStr: string): Date {
    if (!dateStr) return new Date()
    
    // å¦‚æœå·²ç»æ˜¯ ISO æ ¼å¼ï¼Œç›´æ¥è§£æ
    if (dateStr.includes('T')) {
      return new Date(dateStr)
    }
    
    // å¤„ç† "yyyy-MM-dd HH:mm" æ ¼å¼ï¼Œè½¬æ¢ä¸º iOS æ”¯æŒçš„æ ¼å¼
    if (dateStr.includes('-') && dateStr.includes(' ')) {
      // å°† "2025-11-06 12:43" è½¬æ¢ä¸º "2025/11/06 12:43"
      const normalized = dateStr.replace(/-/g, '/')
      return new Date(normalized)
    }
    
    // å¤„ç† "yyyy-MM-dd" æ ¼å¼
    if (dateStr.includes('-') && !dateStr.includes(' ')) {
      return new Date(dateStr)
    }
    
    // å¤„ç† "yyyy/MM/dd HH:mm" æ ¼å¼ï¼ˆiOS æ”¯æŒï¼‰
    if (dateStr.includes('/')) {
      return new Date(dateStr)
    }
    
    // é»˜è®¤å°è¯•è§£æ
    return new Date(dateStr)
  },

  // æ ¼å¼åŒ–æ—¥æœŸï¼ˆç»Ÿä¸€è¾“å‡ºæ ¼å¼ï¼šyyyy/MM/dd HH:mmï¼‰
  formatDate(dateStr: string | number): string {
    if (!dateStr) return ''
    
    let date: Date
    
    // å¦‚æœæ˜¯æ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œç›´æ¥åˆ›å»ºæ—¥æœŸå¯¹è±¡
    if (typeof dateStr === 'number') {
      date = new Date(dateStr)
    } else {
      // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ parseDate è§£æ
      date = this.parseDate(dateStr)
    }
    
    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
    if (isNaN(date.getTime())) {
      return String(dateStr) // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›åŸå­—ç¬¦ä¸²
    }
    
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    const hours = String(date.getHours()).padStart(2, '0')
    const minutes = String(date.getMinutes()).padStart(2, '0')
    return `${year}/${month}/${day} ${hours}:${minutes}`
  },

  // æ ¼å¼åŒ–æ—¥æœŸï¼ˆåªæ˜¾ç¤ºå¹´æœˆæ—¥ï¼‰
  formatDateOnly(dateStr: string | number): string {
    if (!dateStr) return ''
    
    let date: Date
    
    // å¦‚æœæ˜¯æ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰ï¼Œç›´æ¥åˆ›å»ºæ—¥æœŸå¯¹è±¡
    if (typeof dateStr === 'number') {
      date = new Date(dateStr)
    } else {
      // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œä½¿ç”¨ parseDate è§£æ
      date = this.parseDate(dateStr)
    }
    
    // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
    if (isNaN(date.getTime())) {
      return String(dateStr) // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›åŸå­—ç¬¦ä¸²
    }
    
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    return `${year}/${month}/${day}`
  },

  // åŠ è½½å®¡æ‰¹äº‹é¡¹
  async loadApprovalItems() {
    try {
      const result = await CloudApi.callFunction<FinanceApprovalListResponse>(
        'finance-management',
        {
          action: 'get_pending_reimbursements',
          page: 1,
          pageSize: 20
        },
        {
          showError: false
        }
      )

      if (result.success && result.data?.records) {
        const approvalItems = result.data.records.map((record) => {
          // è·å–ç”³è¯·äººä¿¡æ¯
          const applicant = record.operatorName || record.operator || 'æœªçŸ¥'
          
          // è·å–æŠ¥é”€ç±»å‹åç§°
          const typeName = record.reimbursement?.typeName || this.getReimbursementTypeTitle(record.reimbursement?.type) || 'æŠ¥é”€ç”³è¯·'
          
          return {
            id: record._id || record.recordId,
            type: 'expense',
            applicant: applicant,
            title: typeName, // ä½¿ç”¨æŠ¥é”€ç±»å‹åç§°
            description: record.reimbursement?.reason || record.description || '',
            amount: this.formatAmount(record.amount),
            submitTime: this.formatSubmitTime(record.createTime)
          }
        })

        this.setData({
          approvalItems: approvalItems
        })
      } else {
        this.setData({
          approvalItems: []
        })
      }
    } catch (error: unknown) {
      logger.error('åŠ è½½å®¡æ‰¹äº‹é¡¹å¤±è´¥:', error)
      // æƒé™ä¸è¶³æ—¶ä¸æ˜¾ç¤ºé”™è¯¯
      if (!error.message?.includes('æ— æƒé™')) {
        this.setData({
          approvalItems: []
        })
      }
    }
  },

  // æ ¼å¼åŒ–æäº¤æ—¶é—´ï¼ˆæ˜¾ç¤ºå¹´æœˆæ—¥ï¼‰
  formatSubmitTime(dateStr: string): string {
    return this.formatDateOnly(dateStr)
  },

  // åŠ è½½è´¢åŠ¡æŠ¥è¡¨
  async loadFinancialReports() {
    try {
      const now = new Date()
      const currentYear = now.getFullYear()
      const currentMonth = now.getMonth()
      
      // è·å–æœ¬æœˆæ•°æ®
      const currentStart = new Date(currentYear, currentMonth, 1).toISOString()
      const currentEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59).toISOString()
      
      // è·å–å»å¹´åŒæœŸæ•°æ®
      const lastYearStart = new Date(currentYear - 1, currentMonth, 1).toISOString()
      const lastYearEnd = new Date(currentYear - 1, currentMonth + 1, 0, 23, 59, 59).toISOString()

      const [currentResult] = await Promise.all([
        CloudApi.callFunction<FinancialSummaryResponse>(
          'finance-management',
          {
            action: 'get_financial_summary',
            dateRange: { start: currentStart, end: currentEnd }
          },
          {
            showError: false
          }
        ),
        CloudApi.callFunction<FinancialSummaryResponse>(
          'finance-management',
          {
            action: 'get_financial_summary',
            dateRange: { start: lastYearStart, end: lastYearEnd }
          },
          {
            showError: false
          }
        )
      ])

      let yearGrowth = '0'
      let profitRate = '0'

      if (currentResult.success && currentResult.data?.growth) {
        yearGrowth = currentResult.data.growth.revenueGrowth || '0'
      }

      if (currentResult.success && currentResult.data?.currentPeriod) {
        const profit = currentResult.data.currentPeriod.profit || 0
        const revenue = currentResult.data.currentPeriod.revenue?.totalRevenue || 0
        if (revenue > 0) {
          profitRate = ((profit / revenue) * 100).toFixed(1)
        }
      }

      this.setData({
        reports: {
          yearGrowth: yearGrowth,
          profitRate: profitRate
        }
      })
    } catch (error: unknown) {
      logger.error('åŠ è½½è´¢åŠ¡æŠ¥è¡¨å¤±è´¥:', error)
      this.setData({
        reports: {
          yearGrowth: '0',
          profitRate: '0'
        }
      })
    }
  },

  // æŸ¥çœ‹è®°å½•è¯¦æƒ…
  viewRecordDetail(e: CustomEvent) {
    const { item } = e.currentTarget.dataset
    this.setData({
      selectedRecord: item,
      showDetailPopup: true
    })
  },
  
  // å…³é—­è¯¦æƒ…å¼¹çª—
  closeDetailPopup() {
    this.setData({
      showDetailPopup: false
    })
    // å»¶è¿Ÿæ¸…ç©ºæ•°æ®ï¼Œé¿å…å¼¹çª—å…³é—­åŠ¨ç”»æ—¶æ•°æ®é—ªçƒ
    this._safeSetTimeout(() => {
      this.setData({
        selectedRecord: null
      })
    }, 300)
  },

  // æŸ¥çœ‹å®¡æ‰¹è¯¦æƒ…
  viewApprovalDetail(e: CustomEvent) {
    const { item } = e.currentTarget.dataset
    this.setData({
      selectedApprovalItem: item,
      showApprovalPopup: true
    })
  },
  
  // å…³é—­å®¡æ‰¹å¼¹çª—
  closeApprovalPopup() {
    this.setData({
      showApprovalPopup: false
    })
    // å»¶è¿Ÿæ¸…ç©ºæ•°æ®ï¼Œé¿å…å¼¹çª—å…³é—­åŠ¨ç”»æ—¶æ•°æ®é—ªçƒ
    this._safeSetTimeout(() => {
      this.setData({
        selectedApprovalItem: null
      })
    }, 300)
  },
  
  // å®¡æ‰¹å¼¹çª—å¯è§æ€§å˜åŒ–
  onApprovalPopupVisibleChange(e: CustomEvent) {
    if (!e.detail.visible) {
      this.closeApprovalPopup()
    }
  },
  
  // å¤„ç†é€šè¿‡å®¡æ‰¹
  handleApproveApproval() {
    if (this.data.selectedApprovalItem) {
      this.approveApproval({ 
        currentTarget: { 
          dataset: { id: this.data.selectedApprovalItem.id } 
        } 
      })
      this.closeApprovalPopup()
    }
  },
  
  // å¤„ç†æ‹’ç»å®¡æ‰¹ - æ˜¾ç¤ºæ‹’ç»åŸå› è¾“å…¥å¼¹çª—
  handleRejectApproval() {
    if (this.data.selectedApprovalItem) {
      // ä¿å­˜å½“å‰é€‰ä¸­çš„å®¡æ‰¹é¡¹ï¼Œé¿å…è¢«æ¸…ç©º
      const currentItem = { ...this.data.selectedApprovalItem }
      // å…³é—­å®¡æ‰¹è¯¦æƒ…å¼¹çª—
      this.setData({
        showApprovalPopup: false,
        // åŒæ—¶è®¾ç½®æ‹’ç»åŸå› å¼¹çª—å’Œä¿ç•™å®¡æ‰¹é¡¹æ•°æ®
        showRejectReasonPopup: true,
        rejectReason: '',
        selectedApprovalItem: currentItem // ç¡®ä¿æ•°æ®ä¿ç•™
      })
    } else {
      wx.showToast({
        title: 'å®¡æ‰¹ä¿¡æ¯ä¸å­˜åœ¨',
        icon: 'none'
      })
    }
  },
  
  // å…³é—­æ‹’ç»åŸå› è¾“å…¥å¼¹çª—
  closeRejectReasonPopup() {
    this.setData({
      showRejectReasonPopup: false,
      rejectReason: ''
    })
    // å»¶è¿Ÿæ¸…ç©ºå®¡æ‰¹é¡¹æ•°æ®
    this._safeSetTimeout(() => {
      this.setData({
        selectedApprovalItem: null
      })
    }, 300)
  },
  
  // æ‹’ç»åŸå› è¾“å…¥å˜åŒ–
  onRejectReasonChange(e: CustomEvent) {
    this.setData({
      rejectReason: e.detail.value ?? ''
    })
  },
  
  // ç¡®è®¤æ‹’ç»å®¡æ‰¹
  async confirmRejectApproval() {
    const reason = this.data.rejectReason.trim()
    if (!reason) {
      wx.showToast({
        title: 'è¯·å¡«å†™æ‹’ç»åŸå› ',
        icon: 'none'
      })
      return
    }
    
    if (!this.data.selectedApprovalItem) {
      wx.showToast({
        title: 'å®¡æ‰¹ä¿¡æ¯å·²ä¸¢å¤±ï¼Œè¯·é‡æ–°æ“ä½œ',
        icon: 'none'
      })
      return
    }
    
    const id = this.data.selectedApprovalItem.id
    if (!id) {
      wx.showToast({
        title: 'å®¡æ‰¹IDä¸å­˜åœ¨',
        icon: 'none'
      })
      return
    }
    
    try {
      wx.showLoading({ title: 'å¤„ç†ä¸­...' })
      const result = await CloudApi.callFunction<unknown>(
        'finance-management',
        {
          action: 'reject_reimbursement',
          reimbursementId: id,
          reason: reason
        },
        {
          loading: false,
          showError: false
        }
      )
      wx.hideLoading()
      
      if (result.success) {
        wx.showToast({
          title: 'ç”³è¯·å·²æ‹’ç»',
          icon: 'success'
        })
        // å…³é—­æ‹’ç»åŸå› å¼¹çª—
        this.closeRejectReasonPopup()
        // é‡æ–°åŠ è½½å®¡æ‰¹åˆ—è¡¨ã€è´¢åŠ¡æ¦‚è§ˆå’Œè´¢åŠ¡è®°å½•
        await Promise.all([
          this.loadApprovalItems(),
          this.loadFinanceData(),
          this.loadFinanceRecords()
        ])
      } else {
        throw new Error(result.error || 'æ‹’ç»å¤±è´¥')
      }
    } catch (error: unknown) {
      wx.hideLoading()
      wx.showToast({
        title: error.message || 'æ‹’ç»å¤±è´¥',
        icon: 'none',
        duration: 2000
      })
    }
  },

  // é€šè¿‡å®¡æ‰¹
  async approveApproval(e: CustomEvent) {
    const { id } = e.currentTarget.dataset
    wx.showModal({
      title: 'ç¡®è®¤æ“ä½œ',
      content: 'ç¡®è®¤é€šè¿‡æ­¤ç”³è¯·ï¼Ÿ',
      success: async (res) => {
        if (res.confirm) {
          try {
            wx.showLoading({ title: 'å¤„ç†ä¸­...' })
            const result = await CloudApi.callFunction<unknown>(
              'finance-management',
              {
                action: 'approve_reimbursement',
                reimbursementId: id
              },
              {
                loading: false,
                showError: false
              }
            )
            wx.hideLoading()
            
            if (result.success) {
              wx.showToast({
                title: 'ç”³è¯·å·²é€šè¿‡',
                icon: 'success'
              })
              // é‡æ–°åŠ è½½å®¡æ‰¹åˆ—è¡¨ã€è´¢åŠ¡æ¦‚è§ˆå’Œè´¢åŠ¡è®°å½•
              // å®¡æ‰¹é€šè¿‡åï¼ŒæŠ¥é”€è®°å½•ä¼šä»å¾…å®¡æ‰¹å˜ä¸ºå·²é€šè¿‡ï¼Œå½±å“è´¢åŠ¡ç»Ÿè®¡
              await Promise.all([
                this.loadApprovalItems(),
                this.loadFinanceData(),
                this.loadFinanceRecords()
              ])
            } else {
              throw new Error(result.error || 'å®¡æ‰¹å¤±è´¥')
            }
          } catch (error: unknown) {
            wx.hideLoading()
            wx.showToast({
              title: error.message || 'å®¡æ‰¹å¤±è´¥',
              icon: 'none'
            })
          }
        }
      }
    })
  },

  // æ‹’ç»å®¡æ‰¹ï¼ˆä¿ç•™æ­¤æ–¹æ³•ä»¥å…¼å®¹å…¶ä»–è°ƒç”¨ï¼‰
  async rejectApproval(e: CustomEvent) {
    const { id } = e.currentTarget.dataset
    // è®¾ç½®å½“å‰é€‰ä¸­çš„å®¡æ‰¹é¡¹
    const item = this.data.approvalItems.find((item: unknown) => item.id === id)
    if (item) {
      this.setData({
        selectedApprovalItem: item,
        showRejectReasonPopup: true,
        rejectReason: ''
      })
    }
  },

  // æ‰‹åŠ¨è®°è´¦
  addManualRecord() {
    wx.navigateTo({
      url: '/packageFinance/manual-record-form/manual-record-form'
    })
  },


  // åŠ è½½AIåˆ†ææ‰€éœ€çš„æ¨¡å—æ•°æ®ï¼ˆåœ¨é¡µé¢çº§åŠ è½½ï¼Œé¿å…ç»„ä»¶å†…é‡å¤è°ƒç”¨äº‘å‡½æ•°ï¼‰
  async loadModuleDataForAI() {
    
    try {
      // å¹¶è¡ŒåŠ è½½ç”Ÿäº§ã€å¥åº·æ•°æ®ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰
      const [productionData, healthData] = await Promise.all([
        // åŠ è½½ç”Ÿäº§æ•°æ®
        CloudApi.callFunction<unknown>(
          'production-dashboard',
          { action: 'overview' },
          {
            showError: false
          }
        ).then(res => {
          if (res.success && res.data) {
            return res.data
          }
          return null
        }).catch(err => {
          logger.warn('ç”Ÿäº§æ•°æ®åŠ è½½å¤±è´¥:', err)
          return null
        }),
        
        // åŠ è½½å¥åº·æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        wx.cloud.database().collection('health_death_records')
          .where({ isDeleted: false })
          .orderBy('deathDate', 'desc')
          .limit(3)
          .get()
          .then((res: unknown) => {
            return {
              recentDeaths: res.data || [],
              totalDeaths: (res.data || []).reduce((sum: number, r: unknown) => sum + (r.deathCount || 0), 0)
            }
          })
          .catch((err: unknown) => {
            logger.warn('å¥åº·æ•°æ®åŠ è½½å¤±è´¥:', err)
            return null
          })
      ])
      
      // é¹…ä»·æ•°æ®ï¼šå°è¯•ä»å…¨å±€çŠ¶æ€è·å–
      let goosePriceData = null
      try {
        const app = getApp<unknown>()
        if (app.globalData && app.globalData.goosePrice) {
          goosePriceData = app.globalData.goosePrice
        }
      } catch (e) {
        logger.warn('è·å–é¹…ä»·æ•°æ®å¤±è´¥:', e)
      }
      
      // æ›´æ–°åˆ°é¡µé¢æ•°æ®
      this.setData({
        productionData,
        healthData,
        goosePriceData
      })
      
      return {
        production: productionData,
        health: !!healthData,
        goosePrice: !!goosePriceData
      }
    } catch (error) {
      logger.error('åŠ è½½æ¨¡å—æ•°æ®å¤±è´¥:', error)
      return {
        production: null,
        health: false,
        goosePrice: false
      }
    }
  },

  // AIåˆ†æå®Œæˆäº‹ä»¶
  onAnalysisComplete(_e: unknown) {
    // AIè´¢åŠ¡åˆ†æå®Œæˆï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†åˆ†æç»“æœ
  },

  // AIåˆ†æé”™è¯¯äº‹ä»¶
  onAnalysisError(e: CustomEvent) {
    logger.error('AIè´¢åŠ¡åˆ†æé”™è¯¯:', e.detail.error)
    wx.showToast({
      title: 'åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•',
      icon: 'none'
    })
  },
  
  // åŠ è½½åˆ†æå†å²
  async loadAnalysisHistory() {
    try {
      const db = wx.cloud.database()
      const result = await db.collection('finance_analysis_history')
        .where({
          _openid: '{openid}'
        })
        .orderBy('createTime', 'desc')
        .limit(5)  // åªæ˜¾ç¤ºæœ€è¿‘5æ¡
        .get()
      
      const historyList = (result.data || []).map((item: unknown) => ({
        ...item,
        formattedDate: new Date(item.createTime).toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }),
        summary: this.extractSummary(item.analysisResult)
      }))
      
      this.setData({
        analysisHistory: historyList
      })
    } catch (error) {
      logger.error('åŠ è½½åˆ†æå†å²å¤±è´¥:', error)
    }
  },
  
  // æå–åˆ†ææ‘˜è¦
  extractSummary(result: unknown): string {
    if (!result) return 'æš‚æ— æ‘˜è¦'
    
    if (result.format === 'text') {
      return (result.rawText || '').substring(0, 50) + '...'
    }
    
    // JSONæ ¼å¼ï¼Œæå–å…³é”®ä¿¡æ¯
    const summaries = []
    
    if (result.profitability?.summary) {
      summaries.push(result.profitability.summary)
    }
    
    if (result.costStructure?.summary) {
      summaries.push(result.costStructure.summary)
    }
    
    if (result.suggestions?.summary) {
      summaries.push(result.suggestions.summary)
    }
    
    return summaries.length > 0 
      ? summaries.join('ï¼›').substring(0, 80) + '...'
      : 'åˆ†æå®Œæˆ'
  },
  
  // åˆ·æ–°åˆ†æå†å²ï¼ˆç°åœ¨åªæ˜¯ä¸€ä¸ªå ä½å‡½æ•°ï¼Œå› ä¸ºå†å²å·²æ”¹ä¸ºæŒ‰é’®è·³è½¬ï¼‰
  refreshAnalysisHistory() {
    // ä¸éœ€è¦åœ¨ä¸»é¡µåŠ è½½å†å²ï¼Œç”¨æˆ·å¯ä»¥ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹
    // this.loadAnalysisHistory()
  },
  
  // æ˜¾ç¤ºåˆ†æè¯¦æƒ…
  showAnalysisDetail(e: CustomEvent) {
    const item = e.currentTarget.dataset.item
    this.setData({
      selectedAnalysisItem: item,
      showAnalysisDetailPopup: true
    })
  },
  
  // å…³é—­åˆ†æè¯¦æƒ…å¼¹çª—
  closeAnalysisDetailPopup() {
    this.setData({
      showAnalysisDetailPopup: false
    })
    // å»¶è¿Ÿæ¸…ç©ºæ•°æ®ï¼Œé¿å…åŠ¨ç”»æ—¶é—ªçƒ
    this._safeSetTimeout(() => {
      this.setData({
        selectedAnalysisItem: null
      })
    }, 300)
  },
  
  // æŸ¥çœ‹å…¨éƒ¨åˆ†æå†å²
  viewAllAnalysisHistory() {
    wx.navigateTo({
      url: '/packageFinance/all-analysis-history/all-analysis-history'
    })
  },
  
  // åŠ è½½å®¡æ‰¹å†å²
  async loadApprovalHistory() {
    try {
      const result = await CloudApi.callFunction<unknown>(
        'finance-management',
        {
          action: 'get_all_reimbursements', // è·å–æ‰€æœ‰æŠ¥é”€è®°å½•ï¼ˆå·²å®¡æ‰¹çš„ï¼‰
          page: 1,
          pageSize: 5, // åªæ˜¾ç¤ºæœ€è¿‘5æ¡
          status: 'all' // è·å–æ‰€æœ‰çŠ¶æ€
        },
        {
          showError: false
        }
      )

      if (result.success && result.data?.records) {
        const approvalHistory = result.data.records
          .filter((record: unknown) => 
            record.reimbursement?.status === 'approved' || 
            record.reimbursement?.status === 'rejected'
          )
          .slice(0, 5) // åªå–å‰5æ¡
          .map((record: unknown) => {
            // è·å–ç”³è¯·äººä¿¡æ¯
            const applicant = record.operatorName || record.operator || 'æœªçŸ¥'
            
            // è·å–æŠ¥é”€ç±»å‹åç§°
            const typeName = record.reimbursement?.typeName || 
                           this.getReimbursementTypeTitle(record.reimbursement?.type) || 
                           'æŠ¥é”€ç”³è¯·'
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const date = record.reimbursement?.approvedAt || record.reimbursement?.rejectedAt || record.createTime
            const formattedDate = date ? new Date(date).toLocaleString('zh-CN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            }) : 'æœªçŸ¥æ—¶é—´'
            
            return {
              id: record._id || record.recordId,
              type: 'expense',
              applicant: applicant,
              title: typeName,
              description: record.reimbursement?.reason || record.description || '',
              amount: this.formatAmount(record.amount),
              status: record.reimbursement?.status || 'pending',
              formattedDate: formattedDate,
              rejectReason: record.reimbursement?.rejectReason || '',
              approvedBy: record.reimbursement?.approvedBy || '',
              rejectedBy: record.reimbursement?.rejectedBy || ''
            }
          })

        this.setData({
          approvalHistory: approvalHistory
        })
      } else {
        this.setData({
          approvalHistory: []
        })
      }
    } catch (error: unknown) {
      logger.error('åŠ è½½å®¡æ‰¹å†å²å¤±è´¥:', error)
      this.setData({
        approvalHistory: []
      })
    }
  },
  
  // æŸ¥çœ‹å…¨éƒ¨å®¡æ‰¹å†å²
  viewAllApprovalHistory() {
    wx.navigateTo({
      url: '/packageFinance/all-approval-history/all-approval-history'
    })
  },
  
  // æŸ¥çœ‹å®¡æ‰¹å†å²è¯¦æƒ…
  viewApprovalHistoryDetail(e: CustomEvent) {
    const { item } = e.currentTarget.dataset
    this.setData({
      selectedApprovalItem: item,
      showApprovalPopup: true
    })
  },

  // å®¡æ‰¹æ“ä½œ - é€‚é… TDesign æ»‘åŠ¨æ“ä½œ
  onApprovalAction(e: CustomEvent) {
    const { action } = e.detail
    const { item } = e.currentTarget.dataset
    
    if (action.text === 'é€šè¿‡') {
      this.approveApproval({ currentTarget: { dataset: { id: item.id } } })
    } else if (action.text === 'æ‹’ç»') {
      this.rejectApproval({ currentTarget: { dataset: { id: item.id } } })
    }
  }
}

// ä½¿ç”¨å¯¼èˆªæ é€‚é…å·¥å…·åˆ›å»ºé¡µé¢
Page(createPageWithNavbar(pageConfig))
