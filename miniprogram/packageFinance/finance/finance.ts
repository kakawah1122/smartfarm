// finance.ts
import { createPageWithNavbar } from '../../utils/navigation'

const pageConfig = {
  options: {
    styleIsolation: 'shared'
  },
  data: {
    selectedMonth: '2024å¹´3æœˆ',
    monthOptions: [
      {label: '2024å¹´3æœˆ', value: '2024å¹´3æœˆ'},
      {label: '2024å¹´2æœˆ', value: '2024å¹´2æœˆ'},
      {label: '2024å¹´1æœˆ', value: '2024å¹´1æœˆ'}
    ],
    activeTab: 'records',
    
    // è´¢åŠ¡æ¦‚è§ˆ
    overview: {
      income: '21.2',
      expense: '16.8',
      profit: '4.4',
      growthRate: '32.1',
      feedCost: '8.2',
      feedPercent: '48.8',
      laborCost: '4.5',
      laborPercent: '26.8',
      medicalCost: '2.1',
      medicalPercent: '12.5',
      otherCost: '2.0',
      otherPercent: '11.9'
    },
    
  // AIè´¢åŠ¡åˆ†æ
  aiAnalysis: {
    loading: false,
    result: null as any,
    error: null as string | null,
    lastUpdateTime: null as string | null
  },
    
    // ç­›é€‰æ¡ä»¶
    filters: {
      type: 'å…¨éƒ¨ç±»å‹',
      period: 'æœ€è¿‘7å¤©'
    },
    typeOptions: [
      {label: 'å…¨éƒ¨ç±»å‹', value: 'å…¨éƒ¨ç±»å‹'},
      {label: 'æ”¶å…¥', value: 'æ”¶å…¥'},
      {label: 'æ”¯å‡º', value: 'æ”¯å‡º'}
    ],
    periodOptions: [
      {label: 'æœ€è¿‘7å¤©', value: 'æœ€è¿‘7å¤©'},
      {label: 'æœ€è¿‘30å¤©', value: 'æœ€è¿‘30å¤©'},
      {label: 'æœ¬æœˆ', value: 'æœ¬æœˆ'}
    ],
    
    // è´¢åŠ¡è®°å½•
    records: [
      {
        id: 1,
        type: 'income',
        icon: 'ğŸ’°',
        title: 'æˆé¹…é”€å”®æ”¶å…¥',
        description: 'å®¢æˆ·ï¼šè‹å·å†œè´¸å¸‚åœº â€¢ 120ç¾½',
        amount: '18,000',
        date: '2024-03-15 14:30',
        relatedInfo: 'å‡ºæ è®°å½•å…³è”',
        status: 'å·²å…¥è´¦',
        statusTheme: 'success',
        autoGenerated: true
      },
      {
        id: 2,
        type: 'expense',
        icon: 'ğŸ›’',
        title: 'ä¼˜è´¨é¹…ç”¨é¥²æ–™é‡‡è´­',
        description: 'ä¾›åº”å•†ï¼šæ­£å¤§é›†å›¢ â€¢ 1.5å¨',
        amount: '4,500',
        date: '2024-03-15 10:20',
        relatedInfo: 'ç‰©æ–™é‡‡è´­å…³è”',
        status: 'å·²æ”¯å‡º',
        statusTheme: 'danger',
        autoGenerated: true
      },
      {
        id: 3,
        type: 'expense',
        icon: 'ğŸ¦¢',
        title: 'ç™½é¹…è‹—é‡‡è´­æ”¯å‡º',
        description: 'ä¾›åº”å•†ï¼šæ±Ÿè‹é¹…ä¸š â€¢ 200ç¾½',
        amount: '1,640',
        date: '2024-03-14 16:45',
        relatedInfo: 'å…¥æ è®°å½•å…³è”',
        status: 'å·²æ”¯å‡º',
        statusTheme: 'danger',
        autoGenerated: true
      },
      {
        id: 4,
        type: 'expense',
        icon: 'ğŸ’Š',
        title: 'ç–«è‹—è¯å“æ”¯å‡º',
        description: 'ç¦½æµæ„Ÿç–«è‹— â€¢ æ²»ç–—ç”¨è¯',
        amount: '750',
        date: '2024-03-13 11:15',
        relatedInfo: 'å¥åº·è®°å½•å…³è”',
        status: 'å·²æ”¯å‡º',
        statusTheme: 'danger',
        autoGenerated: true
      },
      {
        id: 5,
        type: 'expense',
        icon: 'âš¡',
        title: 'æ°´ç”µè´¹æ”¯å‡º',
        description: 'å…»æ®–åœº3æœˆä»½æ°´ç”µè´¹',
        amount: '1,280',
        date: '2024-03-12 18:30',
        relatedInfo: 'å¼ ä¸‰å½•å…¥',
        status: 'æ‰‹åŠ¨è®°å½•',
        statusTheme: 'default',
        autoGenerated: false
      }
    ],
    
    // è´¢åŠ¡æŠ¥è¡¨
    reports: {
      yearGrowth: '24.5',
      profitRate: '20.7'
    },
    
    // å®¡æ‰¹äº‹é¡¹
    approvalItems: [
      {
        id: 1,
        type: 'expense',
        icon: 'ğŸ“‹',
        applicant: 'æå››',
        title: 'å·®æ—…è´¹æŠ¥é”€',
        description: 'å»è‹å·é¹…è‹—å¸‚åœºè€ƒå¯Ÿè´¹ç”¨',
        amount: '280',
        submitTime: 'ä»Šå¤© 14:30'
      },
      {
        id: 2,
        type: 'purchase',
        icon: 'ğŸ›’',
        applicant: 'ç‹äº”',
        title: 'é¥²æ–™é‡‡è´­ç”³è¯·',
        description: 'ä¼˜è´¨é¹…ç”¨é¥²æ–™ 2å¨',
        amount: '6,000',
        submitTime: 'ä»Šå¤© 11:20'
      }
    ],
    
    filteredRecords: []
  },

  onLoad() {
    this.setData({
      filteredRecords: this.data.records
    })
  },

  // è¿”å›ä¸Šä¸€é¡µ
  goBack() {
    wx.navigateBack({
      fail: () => {
        wx.switchTab({
          url: '/pages/profile/profile'
        })
      }
    })
  },

  // æœˆä»½é€‰æ‹©
  onMonthChange(e: any) {
    this.setData({
      selectedMonth: e.detail.value
    })
    this.loadFinanceData()
  },

  // Tabåˆ‡æ¢ - TDesign æ ¼å¼
  onTabChange(e: any) {
    const { value } = e.detail
    this.setData({
      activeTab: value
    })
  },

  // åˆ‡æ¢Tabçš„æ—§æ–¹æ³•ä¿æŒå…¼å®¹
  switchTab(e: any) {
    const { tab } = e.currentTarget.dataset
    this.setData({
      activeTab: tab
    })
  },

  // ç±»å‹ç­›é€‰
  onTypeFilterChange(e: any) {
    this.setData({
      'filters.type': e.detail.value
    })
    this.filterRecords()
  },

  // æ—¶é—´ç­›é€‰
  onPeriodFilterChange(e: any) {
    this.setData({
      'filters.period': e.detail.value
    })
    this.filterRecords()
  },

  // ç­›é€‰è®°å½•
  filterRecords() {
    let filtered = this.data.records
    
    // æŒ‰ç±»å‹ç­›é€‰
    if (this.data.filters.type !== 'å…¨éƒ¨ç±»å‹') {
      const typeMap = { 'æ”¶å…¥': 'income', 'æ”¯å‡º': 'expense' }
      filtered = filtered.filter(record => 
        record.type === typeMap[this.data.filters.type as keyof typeof typeMap]
      )
    }
    
    // æŒ‰æ—¶é—´ç­›é€‰ (è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æŒ‰æ—¥æœŸç­›é€‰)
    
    this.setData({
      filteredRecords: filtered
    })
  },

  // åŠ è½½è´¢åŠ¡æ•°æ®
  loadFinanceData() {
    wx.showLoading({
      title: 'åŠ è½½ä¸­...'
    })
    
    // è°ƒç”¨äº‘å‡½æ•°åŠ è½½è´¢åŠ¡æ•°æ®
    wx.cloud.callFunction({
      name: 'finance-management',
      data: {
        action: 'getFinanceData',
        month: this.data.selectedMonth
      }
    }).then(result => {
      wx.hideLoading()
      if (result.result && result.result.success) {
        // å¤„ç†è´¢åŠ¡æ•°æ®
        this.processFinanceData(result.result.data)
      }
    }).catch(error => {
      wx.hideLoading()
      // å·²ç§»é™¤è°ƒè¯•æ—¥å¿—
    })
  },
  
  // å¤„ç†è´¢åŠ¡æ•°æ®
  processFinanceData(data: any) {
    // æ ¹æ®é€‰æ‹©çš„æœˆä»½å¤„ç†å¯¹åº”æ•°æ®
  },

  // ========== AIè´¢åŠ¡åˆ†æåŠŸèƒ½ ==========
  
  // ç”ŸæˆAIè´¢åŠ¡åˆ†æ
  async generateFinancialAnalysis() {
    try {
      this.setData({ 
        'aiAnalysis.loading': true,
        'aiAnalysis.error': null
      })
      
      // æ”¶é›†è´¢åŠ¡æ•°æ®
      const financialData = this.collectFinancialData()
      
      // æ„å»ºåˆ†ææç¤ºè¯
      const prompt = this.buildFinancialAnalysisPrompt(financialData)
      
      // è°ƒç”¨AIäº‘å‡½æ•°
      const result = await wx.cloud.callFunction({
        name: 'ai-multi-model',
        data: {
          task: 'financial_analysis',
          content: prompt,
          options: {
            model: 'glm-4-flash', // ä½¿ç”¨GLM-4è¿›è¡Œè´¢åŠ¡åˆ†æ
            temperature: 0.3,
            maxTokens: 2000
          }
        }
      })
      
      if (result.result.success) {
        const analysisResult = this.parseFinancialAnalysisResult(result.result.data.content)
        
        this.setData({
          'aiAnalysis.loading': false,
          'aiAnalysis.result': analysisResult,
          'aiAnalysis.lastUpdateTime': new Date().toLocaleString('zh-CN')
        })
        
        // è§¦è§‰åé¦ˆ
        wx.vibrateShort()
        
        wx.showToast({
          title: 'AIåˆ†æå®Œæˆ',
          icon: 'success'
        })
      } else {
        throw new Error(result.result.error || 'AIåˆ†æå¤±è´¥')
      }
      
    } catch (error) {
      // å·²ç§»é™¤è°ƒè¯•æ—¥å¿—
      // æä¾›å¤‡ç”¨åˆ†æç»“æœ
      const fallbackResult = this.generateFallbackAnalysis()
      
      this.setData({
        'aiAnalysis.loading': false,
        'aiAnalysis.result': fallbackResult,
        'aiAnalysis.error': 'ä½¿ç”¨ç¦»çº¿åˆ†ææ¨¡å¼'
      })
      
      wx.showToast({
        title: 'ä½¿ç”¨ç¦»çº¿åˆ†æ',
        icon: 'none'
      })
    }
  },
  
  // æ”¶é›†è´¢åŠ¡æ•°æ®
  collectFinancialData() {
    const { overview, records } = this.data
    
    // è®¡ç®—è¿‘æœŸæ•°æ®ç»Ÿè®¡
    const recentRecords = records.filter(record => {
      const recordDate = new Date(record.date)
      const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
      return recordDate >= sevenDaysAgo
    })
    
    // æ”¶å…¥æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡
    const incomeRecords = recentRecords.filter(r => r.type === 'income')
    const expenseRecords = recentRecords.filter(r => r.type === 'expense')
    
    // æŒ‰ç±»åˆ«ç»Ÿè®¡æ”¯å‡º
    const expenseCategories = {}
    expenseRecords.forEach(record => {
      const category = record.category || 'å…¶ä»–'
      expenseCategories[category] = (expenseCategories[category] || 0) + parseFloat(record.amount)
    })
    
    return {
      overview,
      recentIncome: incomeRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0),
      recentExpense: expenseRecords.reduce((sum, r) => sum + parseFloat(r.amount), 0),
      expenseCategories,
      recordCount: records.length,
      recentRecordCount: recentRecords.length,
      profitMargin: ((parseFloat(overview.totalIncome) - parseFloat(overview.totalExpense)) / parseFloat(overview.totalIncome) * 100).toFixed(1)
    }
  },
  
  // æ„å»ºè´¢åŠ¡åˆ†ææç¤ºè¯
  buildFinancialAnalysisPrompt(financialData: any): string {
    return `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å…»æ®–ä¸šè´¢åŠ¡é¡¾é—®ï¼Œè¯·åŸºäºä»¥ä¸‹è´¢åŠ¡æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æï¼Œå¹¶æä¾›ä¸“ä¸šçš„è´¢åŠ¡ç®¡ç†å»ºè®®ã€‚è¯·ä»¥JSONæ ¼å¼å›å¤ï¼ŒåŒ…å«ä»¥ä¸‹ç»“æ„ï¼š

{
  "healthScore": æ•°å€¼(0-100),
  "healthLevel": "excellent|good|average|poor",
  "healthIndicators": [
    {"category": "ç°é‡‘æµ", "score": æ•°å€¼, "level": "excellent|good|average|poor"},
    {"category": "ç›ˆåˆ©èƒ½åŠ›", "score": æ•°å€¼, "level": "excellent|good|average|poor"},
    {"category": "æˆæœ¬æ§åˆ¶", "score": æ•°å€¼, "level": "excellent|good|average|poor"},
    {"category": "å¢é•¿æ½œåŠ›", "score": æ•°å€¼, "level": "excellent|good|average|poor"}
  ],
  "costOptimization": [
    {
      "category": "åˆ†ç±»åç§°",
      "potentialSaving": "é¢„è®¡èŠ‚çœé‡‘é¢",
      "recommendation": "ä¼˜åŒ–å»ºè®®",
      "expectedImpact": "é¢„æœŸæ•ˆæœæè¿°",
      "timeline": "å®æ–½å‘¨æœŸ"
    }
  ],
  "monthlyForecast": [
    {
      "month": "æœˆä»½åç§°",
      "income": "é¢„æµ‹æ”¶å…¥(ä¸‡å…ƒ)",
      "expense": "é¢„æµ‹æ”¯å‡º(ä¸‡å…ƒ)", 
      "profit": "é¢„æµ‹å‡€åˆ©æ¶¦(ä¸‡å…ƒ)",
      "trendDirection": "up|down|stable",
      "trendText": "è¶‹åŠ¿æè¿°"
    }
  ],
  "forecastConfidence": æ•°å€¼(0-100),
  "investmentOpportunities": [
    {
      "type": "æŠ•èµ„ç±»å‹",
      "description": "æŠ•èµ„æè¿°",
      "requiredInvestment": "æ‰€éœ€æŠ•èµ„é‡‘é¢(ä¸‡å…ƒ)",
      "expectedROI": é¢„æœŸå›æŠ¥ç‡ç™¾åˆ†æ¯”,
      "paybackPeriod": "å›æ”¶å‘¨æœŸ",
      "riskLevel": "low|medium|high",
      "riskLevelText": "é£é™©ç­‰çº§æ–‡æœ¬"
    }
  ],
  "riskAlerts": [
    {
      "severity": "high|medium|low",
      "icon": "å›¾æ ‡",
      "title": "é£é™©æ ‡é¢˜",
      "description": "é£é™©æè¿°",
      "suggestion": "å»ºè®®æªæ–½"
    }
  ]
}

## å½“å‰è´¢åŠ¡æ•°æ®åˆ†æï¼š

**æ€»ä½“è´¢åŠ¡çŠ¶å†µï¼š**
- æœˆæ”¶å…¥ï¼šÂ¥${financialData.overview.totalIncome}ä¸‡
- æœˆæ”¯å‡ºï¼šÂ¥${financialData.overview.totalExpense}ä¸‡
- å‡€åˆ©æ¶¦ï¼šÂ¥${financialData.overview.profit}ä¸‡
- åˆ©æ¶¦ç‡ï¼š${financialData.profitMargin}%

**æˆæœ¬ç»“æ„åˆ†æï¼š**
- é¥²æ–™æˆæœ¬ï¼šÂ¥${financialData.overview.feedCost}ä¸‡ (å æ¯”${financialData.overview.feedPercent}%)
- äººå·¥æˆæœ¬ï¼šÂ¥${financialData.overview.laborCost}ä¸‡ (å æ¯”${financialData.overview.laborPercent}%)
- åŒ»ç–—æˆæœ¬ï¼šÂ¥${financialData.overview.medicalCost}ä¸‡ (å æ¯”${financialData.overview.medicalPercent}%)
- å…¶ä»–æˆæœ¬ï¼šÂ¥${financialData.overview.otherCost}ä¸‡ (å æ¯”${financialData.overview.otherPercent}%)

**è¿‘æœŸè´¢åŠ¡è¶‹åŠ¿ï¼š**
- è¿‘7å¤©æ”¶å…¥ï¼šÂ¥${(financialData.recentIncome/10000).toFixed(2)}ä¸‡
- è¿‘7å¤©æ”¯å‡ºï¼šÂ¥${(financialData.recentExpense/10000).toFixed(2)}ä¸‡
- è®°å½•æ•°é‡ï¼š${financialData.recordCount}æ¡
- è¿‘æœŸè®°å½•ï¼š${financialData.recentRecordCount}æ¡

**æ”¯å‡ºåˆ†ç±»æ˜ç»†ï¼š**
${Object.entries(financialData.expenseCategories).map(([category, amount]: [string, any]) => 
  `- ${category}ï¼šÂ¥${(amount/10000).toFixed(2)}ä¸‡`
).join('\n')}

è¯·åŸºäºä»¥ä¸Šæ•°æ®è¿›è¡Œä¸“ä¸šçš„è´¢åŠ¡å¥åº·åº¦è¯„ä¼°ï¼Œæä¾›æˆæœ¬ä¼˜åŒ–å»ºè®®ï¼Œè¿›è¡Œç›ˆåˆ©é¢„æµ‹ï¼Œç»™å‡ºæŠ•èµ„å»ºè®®ï¼Œå¹¶è¯†åˆ«æ½œåœ¨çš„è´¢åŠ¡é£é™©ã€‚åˆ†æåº”è¯¥å…·ä½“ã€å®ç”¨ï¼Œé’ˆå¯¹é¹…ç±»å…»æ®–ä¸šçš„ç‰¹ç‚¹ã€‚`
  },
  
  // è§£æAIè´¢åŠ¡åˆ†æç»“æœ
  parseFinancialAnalysisResult(content: string): any {
    try {
      // å°è¯•æå–JSON
      const jsonMatch = content.match(/\{[\s\S]*\}/)
      if (jsonMatch) {
        const result = JSON.parse(jsonMatch[0])
        
        // æ•°æ®éªŒè¯å’Œå¤„ç†
        return {
          healthScore: result.healthScore || 75,
          healthLevel: result.healthLevel || 'good',
          healthIndicators: result.healthIndicators || [],
          costOptimization: result.costOptimization || [],
          monthlyForecast: result.monthlyForecast || [],
          forecastConfidence: result.forecastConfidence || 80,
          investmentOpportunities: result.investmentOpportunities || [],
          riskAlerts: result.riskAlerts || []
        }
      }
    } catch (error) {
      // å·²ç§»é™¤è°ƒè¯•æ—¥å¿—
    }
    
    // è§£æå¤±è´¥æ—¶è¿”å›å¤‡ç”¨ç»“æœ
    return this.generateFallbackAnalysis()
  },
  
  // ç”Ÿæˆå¤‡ç”¨è´¢åŠ¡åˆ†æç»“æœ
  generateFallbackAnalysis(): any {
    const { overview } = this.data
    const profitMargin = parseFloat(overview.profit) / parseFloat(overview.totalIncome) * 100
    
    return {
      healthScore: profitMargin > 20 ? 85 : profitMargin > 10 ? 70 : profitMargin > 0 ? 60 : 45,
      healthLevel: profitMargin > 20 ? 'excellent' : profitMargin > 10 ? 'good' : profitMargin > 0 ? 'average' : 'poor',
      healthIndicators: [
        {
          category: 'ç°é‡‘æµ',
          score: profitMargin > 0 ? 75 : 40,
          level: profitMargin > 0 ? 'good' : 'poor'
        },
        {
          category: 'ç›ˆåˆ©èƒ½åŠ›',
          score: Math.max(30, Math.min(90, profitMargin * 3)),
          level: profitMargin > 15 ? 'excellent' : profitMargin > 8 ? 'good' : profitMargin > 0 ? 'average' : 'poor'
        },
        {
          category: 'æˆæœ¬æ§åˆ¶',
          score: parseFloat(overview.feedPercent) < 60 ? 80 : 60,
          level: parseFloat(overview.feedPercent) < 60 ? 'good' : 'average'
        },
        {
          category: 'å¢é•¿æ½œåŠ›',
          score: 70,
          level: 'good'
        }
      ],
      costOptimization: [
        {
          category: 'é¥²æ–™é‡‡è´­',
          potentialSaving: '1.2',
          recommendation: 'å»ºè®®æ‰¹é‡é‡‡è´­ä¼˜è´¨é¥²æ–™ï¼Œé€‰æ‹©æ€§ä»·æ¯”æ›´é«˜çš„ä¾›åº”å•†',
          expectedImpact: 'é™ä½é¥²æ–™æˆæœ¬8-12%',
          timeline: '1-2ä¸ªæœˆ'
        },
        {
          category: 'èƒ½æºç®¡ç†',
          potentialSaving: '0.8',
          recommendation: 'ä¼˜åŒ–å…»æ®–ç¯å¢ƒæ§åˆ¶ç³»ç»Ÿï¼Œå‡å°‘ä¸å¿…è¦çš„èƒ½è€—',
          expectedImpact: 'èŠ‚çœç”µè´¹å’Œç‡ƒæ–™æˆæœ¬',
          timeline: 'å³æ—¶æ‰§è¡Œ'
        }
      ],
      monthlyForecast: [
        {
          month: 'ä¸‹ä¸ªæœˆ',
          income: (parseFloat(overview.totalIncome) * 1.05).toFixed(1),
          expense: (parseFloat(overview.totalExpense) * 1.02).toFixed(1),
          profit: (parseFloat(overview.profit) * 1.15).toFixed(1),
          trendDirection: 'up',
          trendText: 'ç¨³æ­¥å¢é•¿'
        },
        {
          month: 'ä¸¤ä¸ªæœˆå',
          income: (parseFloat(overview.totalIncome) * 1.08).toFixed(1),
          expense: (parseFloat(overview.totalExpense) * 1.03).toFixed(1),
          profit: (parseFloat(overview.profit) * 1.25).toFixed(1),
          trendDirection: 'up',
          trendText: 'æŒç»­å‘å¥½'
        },
        {
          month: 'ä¸‰ä¸ªæœˆå',
          income: (parseFloat(overview.totalIncome) * 1.12).toFixed(1),
          expense: (parseFloat(overview.totalExpense) * 1.05).toFixed(1),
          profit: (parseFloat(overview.profit) * 1.35).toFixed(1),
          trendDirection: 'up',
          trendText: 'æ˜¾è‘—æå‡'
        }
      ],
      forecastConfidence: 75,
      investmentOpportunities: [
        {
          type: 'è®¾å¤‡å‡çº§',
          description: 'æŠ•èµ„è‡ªåŠ¨åŒ–å–‚å…»è®¾å¤‡ï¼Œæé«˜å…»æ®–æ•ˆç‡',
          requiredInvestment: '5.0',
          expectedROI: 35,
          paybackPeriod: '18ä¸ªæœˆ',
          riskLevel: 'low',
          riskLevelText: 'ä½é£é™©'
        },
        {
          type: 'è§„æ¨¡æ‰©å¼ ',
          description: 'æ–°å»ºå…»æ®–åŒºåŸŸï¼Œæ‰©å¤§å…»æ®–è§„æ¨¡',
          requiredInvestment: '12.0',
          expectedROI: 28,
          paybackPeriod: '24ä¸ªæœˆ',
          riskLevel: 'medium',
          riskLevelText: 'ä¸­ç­‰é£é™©'
        }
      ],
      riskAlerts: profitMargin < 5 ? [
        {
          severity: 'high',
          icon: 'ğŸš¨',
          title: 'ç›ˆåˆ©èƒ½åŠ›åä½',
          description: 'å½“å‰åˆ©æ¶¦ç‡è¾ƒä½ï¼Œå­˜åœ¨ç»è¥é£é™©',
          suggestion: 'ä¼˜åŒ–æˆæœ¬ç»“æ„ï¼Œæé«˜äº§å“ä»·å€¼'
        }
      ] : []
    }
  },

  // æŸ¥çœ‹è®°å½•è¯¦æƒ…
  viewRecordDetail(e: any) {
    const { item } = e.currentTarget.dataset
    wx.showModal({
      title: 'äº¤æ˜“è¯¦æƒ…',
      content: `${item.title}\n\n${item.description}\n\né‡‘é¢ï¼šÂ¥${item.amount}\næ—¶é—´ï¼š${item.date}`,
      showCancel: false
    })
  },

  // é€šè¿‡å®¡æ‰¹
  approveApproval(e: any) {
    const { id } = e.currentTarget.dataset
    wx.showModal({
      title: 'ç¡®è®¤æ“ä½œ',
      content: 'ç¡®è®¤é€šè¿‡æ­¤ç”³è¯·ï¼Ÿ',
      success: (res) => {
        if (res.confirm) {
          this.removeApprovalItem(id)
          wx.showToast({
            title: 'ç”³è¯·å·²é€šè¿‡',
            icon: 'success'
          })
        }
      }
    })
  },

  // æ‹’ç»å®¡æ‰¹
  rejectApproval(e: any) {
    const { id } = e.currentTarget.dataset
    wx.showModal({
      title: 'ç¡®è®¤æ“ä½œ',
      content: 'ç¡®è®¤æ‹’ç»æ­¤ç”³è¯·ï¼Ÿ',
      success: (res) => {
        if (res.confirm) {
          this.removeApprovalItem(id)
          wx.showToast({
            title: 'ç”³è¯·å·²æ‹’ç»',
            icon: 'success'
          })
        }
      }
    })
  },

  // ç§»é™¤å®¡æ‰¹é¡¹
  removeApprovalItem(id: number) {
    const approvalItems = this.data.approvalItems.filter(item => item.id !== id)
    this.setData({
      approvalItems
    })
  },

  // æ‰‹åŠ¨è®°è´¦
  addManualRecord() {
    wx.showToast({
      title: 'åŠŸèƒ½å¼€å‘ä¸­',
      icon: 'none'
    })
  },

  // å¯¼å‡ºæŠ¥è¡¨
  exportReport() {
    wx.showLoading({
      title: 'å¯¼å‡ºä¸­...'
    })
    
    setTimeout(() => {
      wx.hideLoading()
      wx.showToast({
        title: 'æŠ¥è¡¨å·²å¯¼å‡º',
        icon: 'success'
      })
    }, 1500)
  },

  // å®¡æ‰¹æ“ä½œ - é€‚é… TDesign æ»‘åŠ¨æ“ä½œ
  onApprovalAction(e: any) {
    const { action } = e.detail
    const { item } = e.currentTarget.dataset
    
    if (action.text === 'é€šè¿‡') {
      this.approveApproval({ currentTarget: { dataset: { id: item.id } } })
    } else if (action.text === 'æ‹’ç»') {
      this.rejectApproval({ currentTarget: { dataset: { id: item.id } } })
    }
  }
}

// ä½¿ç”¨å¯¼èˆªæ é€‚é…å·¥å…·åˆ›å»ºé¡µé¢
Page(createPageWithNavbar(pageConfig))
