# 饲养成本管理 - 数据库配置

## 📋 数据库集合配置指南

根据项目规则，饲养成本管理系统需要创建 **1个新的数据库集合**。

---

## 新增集合：feed_usage_records

### 集合用途
存储饲料投喂记录，用于计算饲养成本和进行成本分析。

### 📝 创建集合

#### 在微信云开发控制台操作：

1. 登录 [微信云开发控制台](https://console.cloud.tencent.com/)
2. 选择对应的环境 → 进入"数据库"模块
3. 点击"添加集合"按钮
4. 填写集合信息：
   - **集合名称**：`feed_usage_records`
   - **权限类型**：选择 **"所有用户可读、创建者可读写"**
     - 养殖场成员可查看所有投喂记录，只能修改自己创建的记录

---

### 📊 添加索引

创建集合后，点击"索引"标签页，按以下配置添加索引：

#### 索引1：批次和记录日期索引
**用途：** 快速查询特定批次的投喂记录，按日期倒序排列

- **索引名称**：`batchId_1_recordDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`batchId`，排序：**升序**
  - 字段：`recordDate`，排序：**降序**

#### 索引2：批次号和记录日期索引
**用途：** 通过批次号快速查询投喂记录

- **索引名称**：`batchNumber_1_recordDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`batchNumber`，排序：**升序**
  - 字段：`recordDate`，排序：**降序**

#### 索引3：养殖场和记录日期索引
**用途：** 养殖场维度的投喂记录查询和统计

- **索引名称**：`farmId_1_recordDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`farmId`，排序：**升序**
  - 字段：`recordDate`，排序：**降序**

#### 索引4：物料和记录日期索引
**用途：** 统计特定饲料的使用情况

- **索引名称**：`materialId_1_recordDate_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`materialId`，排序：**升序**
  - 字段：`recordDate`，排序：**降序**

#### 索引5：用户和创建时间索引
**用途：** 查询用户的操作记录

- **索引名称**：`userId_1_createTime_-1`
- **索引属性**：非唯一
- **索引字段**：
  - 字段：`userId`，排序：**升序**
  - 字段：`createTime`，排序：**降序**

---

### 🔑 关键字段说明

| 字段名 | 类型 | 必填 | 说明 | 示例值 |
|--------|------|------|------|--------|
| `batchId` | String | ✅ | 批次ID（关联 prod_batch_entries._id） | "65a1b2c3d4e5f6..." |
| `batchNumber` | String | ✅ | 批次号（冗余存储，便于查询） | "A001" |
| `farmId` | String | ✅ | 养殖场ID | "farm_001" |
| `recordDate` | String | ✅ | 投喂日期（格式：YYYY-MM-DD） | "2025-10-29" |
| `materialId` | String | ✅ | 饲料物料ID（关联 prod_materials._id） | "65a1b2c3d4e5f7..." |
| `materialName` | String | ✅ | 饲料名称（冗余存储） | "育肥饲料A" |
| `quantity` | Number | ✅ | 投喂数量 | 500 |
| `unit` | String | ✅ | 单位 | "kg" |
| `unitPrice` | Number | ✅ | 单价（元/单位） | 3.50 |
| `totalCost` | Number | ✅ | 总成本（元） | 1750.00 |
| `currentStock` | Number | ✅ | 记录时的存栏数 | 980 |
| `costPerBird` | Number | ✅ | 单只成本（元/只） | 1.79 |
| `dayAge` | Number | ❌ | 日龄（天） | 45 |
| `notes` | String | ❌ | 备注 | "本周10月23-29日投喂记录" |
| `userId` | String | ✅ | 操作用户openid | "_openid_xxx" |
| `operator` | String | ✅ | 操作人姓名 | "张三" |
| `createTime` | Date | ✅ | 创建时间 | ISODate("2025-10-29T10:30:00Z") |
| `updateTime` | Date | ❌ | 更新时间 | ISODate("2025-10-29T15:20:00Z") |

---

## 🔐 权限配置详解

### 选择理由
选择 **"所有用户可读、创建者可读写"** 的原因：

1. **团队协作需求**
   - 养殖场成员需要查看所有投喂记录
   - 了解不同批次的饲料消耗情况
   - 进行成本对比分析

2. **数据安全性**
   - 只有创建者可以修改自己的记录
   - 防止误操作或恶意修改他人数据
   - 保证数据的完整性和可追溯性

3. **符合项目规范**
   - 与其他生产管理集合（prod_batch_entries、prod_material_records）保持一致
   - 遵循项目统一的权限管理策略

---

## 📈 索引设计说明

### 索引设计原则

1. **高频查询优化**
   - `batchId + recordDate`：批次维度查询（最常用）
   - `batchNumber + recordDate`：通过批次号查询
   - `farmId + recordDate`：养殖场维度统计

2. **成本分析需求**
   - `materialId + recordDate`：特定饲料使用分析
   - 支持时间范围查询（日期降序）

3. **审计和追溯**
   - `userId + createTime`：用户操作记录查询

### 索引选择性分析

| 索引 | 选择性 | 使用场景 | 优先级 |
|------|--------|----------|--------|
| batchId_1_recordDate_-1 | 高 | 批次成本查询 | ⭐⭐⭐⭐⭐ |
| batchNumber_1_recordDate_-1 | 高 | 批次号查询 | ⭐⭐⭐⭐ |
| farmId_1_recordDate_-1 | 中 | 养殖场统计 | ⭐⭐⭐⭐ |
| materialId_1_recordDate_-1 | 中 | 饲料分析 | ⭐⭐⭐ |
| userId_1_createTime_-1 | 低 | 审计追溯 | ⭐⭐ |

---

## 🔄 与其他集合的关联关系

### 关联图

```
feed_usage_records (饲料投喂记录)
    │
    ├─→ prod_batch_entries (入栏记录)
    │   └── 关联字段：batchId, batchNumber
    │
    ├─→ prod_materials (物料库存)
    │   └── 关联字段：materialId, materialName
    │
    ├─→ wx_users (用户信息)
    │   └── 关联字段：userId
    │
    └─→ health_death_records (死亡记录)
        └── 用于计算存栏数：currentStock
```

### 数据一致性保证

1. **批次关联**
   - 记录时验证 batchId 存在
   - 冗余存储 batchNumber 提高查询效率

2. **物料关联**
   - 记录时验证 materialId 存在
   - 冗余存储 materialName、unitPrice

3. **存栏数计算**
   - 实时计算 = 入栏数 - 出栏数 - 死亡数
   - 记录时存储 currentStock 快照

---

## ⚠️ 注意事项

### 1. 创建顺序
确保以下集合已存在，再创建 `feed_usage_records`：
- ✅ `prod_batch_entries` （入栏记录）
- ✅ `prod_materials` （物料库存）
- ✅ `wx_users` （用户信息）
- ✅ `health_death_records` （死亡记录）

### 2. 数据完整性
- 所有必填字段（✅标记）必须有值
- `totalCost = quantity × unitPrice`
- `costPerBird = totalCost ÷ currentStock`

### 3. 日期格式统一
- `recordDate`：字符串格式 "YYYY-MM-DD"
- `createTime`：Date 对象（ISO 8601格式）

### 4. 索引创建时间
- 建议在数据量 < 1000 时创建索引
- 大数据量下创建索引可能需要较长时间

---

## ✅ 配置检查清单

配置完成后，请逐项检查：

- [ ] 集合 `feed_usage_records` 已创建
- [ ] 权限设置为"所有用户可读、创建者可读写"
- [ ] 索引1：`batchId_1_recordDate_-1` 已创建
- [ ] 索引2：`batchNumber_1_recordDate_-1` 已创建
- [ ] 索引3：`farmId_1_recordDate_-1` 已创建
- [ ] 索引4：`materialId_1_recordDate_-1` 已创建
- [ ] 索引5：`userId_1_createTime_-1` 已创建
- [ ] 在小程序中测试投喂记录功能
- [ ] 验证数据查询性能

---

## 🧪 测试验证

### 1. 权限测试
```javascript
// 小程序端测试代码
// 测试1：查询所有记录（应该成功）
const result1 = await db.collection('feed_usage_records')
  .where({ farmId: 'your_farm_id' })
  .get()

// 测试2：修改他人记录（应该失败）
const result2 = await db.collection('feed_usage_records')
  .doc('other_user_record_id')
  .update({ quantity: 100 })

// 测试3：修改自己的记录（应该成功）
const result3 = await db.collection('feed_usage_records')
  .doc('my_record_id')
  .update({ quantity: 100 })
```

### 2. 索引效果测试
```javascript
// 查询特定批次的投喂记录
const result = await db.collection('feed_usage_records')
  .where({
    batchId: 'your_batch_id'
  })
  .orderBy('recordDate', 'desc')
  .limit(20)
  .get()

// 检查查询耗时，应 < 200ms
console.log('查询耗时:', result.stats.executionTime, 'ms')
```

---

## 📚 相关云函数

已使用此集合的云函数：
- `cloudfunctions/production-material/index.js`
  - `recordFeedUsage` - 记录饲料投喂
  - `listFeedUsage` - 查询投喂记录
  - `getBatchFeedCost` - 批次成本统计
  - `getFeedCostAnalysis` - 成本分析
  - `updateFeedUsage` - 更新记录
  - `deleteFeedUsage` - 删除记录

---

## 🔗 相关文档

- [DATABASE_CONFIG_GUIDE.md](./DATABASE_CONFIG_GUIDE.md) - 完整数据库配置指南
- [饲养成本管理-快速使用指南.md](./饲养成本管理-快速使用指南.md) - 功能使用说明
- [cloudfunctions/production-material/index.js](./cloudfunctions/production-material/index.js) - 云函数实现

---

**配置版本**：v1.0  
**创建时间**：2025-10-29  
**适用项目**：鹅数通智慧养鹅小程序  
**预计配置时间**：10-15分钟

---

## 💡 快速配置指令

如果你熟悉数据库配置，可以使用以下快速指令：

```bash
# 集合配置
集合名称: feed_usage_records
权限类型: 所有用户可读、创建者可读写

# 索引配置（按顺序创建）
索引1: batchId↑ + recordDate↓  (非唯一)
索引2: batchNumber↑ + recordDate↓  (非唯一)
索引3: farmId↑ + recordDate↓  (非唯一)
索引4: materialId↑ + recordDate↓  (非唯一)
索引5: userId↑ + createTime↓  (非唯一)
```

---

🎉 **配置完成后，即可开始使用饲养成本管理功能！**

