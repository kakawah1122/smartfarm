# 财务管理现金流视角说明

## 设计理念

财务管理页面完全站在**现金流**的角度构建，回答一个核心问题：

> **这个时间段内，我花了多少钱？收了多少钱？**

## 核心功能

### 1. 时间维度筛选

**筛选器选项**：
- 本月
- 本季度
- 本年
- 自定义（待实现）

**筛选逻辑**：
```typescript
// 本月：当月1号 00:00 - 当月最后一天 23:59
// 本季度：当前季度第一天 - 当前季度最后一天
// 本年：1月1日 - 12月31日
```

### 2. 成本统计（现金流）

**4个成本卡片**：

| 成本类型 | 统计来源 | 说明 |
|---------|---------|------|
| **饲料成本** | 饲料采购记录 | 这个时段买了多少饲料 |
| **鹅苗成本** | 入栏采购记录 | 这个时段买了多少鹅苗 |
| **医疗费用** | 药品采购记录 | 这个时段买了多少药品 |
| **其他费用** | 报销+其他采购 | 报销、人工、设备等支出 |

**数据来源**：
- `PROD_MATERIAL_RECORDS` (type='purchase')
- `PROD_BATCH_ENTRIES`
- `FINANCE_COST_RECORDS`

### 3. 财务记录列表

**显示的记录**：
- ✅ 物料采购（饲料、药品、其他）
- ✅ 入栏采购（鹅苗）
- ✅ 出栏销售（成鹅）
- ✅ 报销记录（差旅、招待等）

**不显示的记录**：
- ❌ 投喂记录（库存流转，不涉及现金）
- ❌ 治疗用药记录（库存流转，不涉及现金）

## 业务逻辑

### 采购 vs 使用

**现金流视角（财务管理）**：
```
2025-11-01: 买了1吨饲料 → 现金流出 10000元 ✅
2025-11-05: 投喂了200kg → 库存流转（不记录）❌
```

**成本核算视角（待实现，在其他模块）**：
```
QY-20251017批次:
  - 实际投喂了500kg → 成本 5000元
  - 实际用药了2瓶 → 成本 240元
```

### 为什么不显示投喂和治疗记录？

**原因**：投喂和治疗是**库存流转**，不涉及现金流动。

**举例**：
1. 11月1日：买1吨饲料，10000元 → 现金流出 ✅
2. 11月5日：投喂200kg → 只是从仓库拿出来喂鹅，没有花钱 ❌
3. 11月10日：又投喂300kg → 还是从仓库拿，没有花钱 ❌

**如果显示投喂记录会怎样**？
```
财务记录：
- 11月1日：饲料采购 -10000元
- 11月5日：饲料投喂 -2000元
- 11月10日：饲料投喂 -3000元
总支出：15000元 ❌ 错误！实际只花了10000元
```

## 数据流说明

### 完整的业务流程

```
[采购] → [入库] → [使用] → [出栏]
  ↓        ↓        ↓        ↓
 现金流   库存增   库存减   现金流
  ✅       ❌       ❌       ✅
```

### 示例：一批药品的生命周期

```
2025-11-01: 采购 10瓶浆膜清，1200元
            → 现金流出 1200元 ✅ 记录在财务管理

2025-11-05: QY-20251017批次治疗用了2瓶
            → 库存-2，成本240元 ❌ 不记录在财务管理
            
2025-11-12: QY-20251020批次治疗用了3瓶
            → 库存-3，成本360元 ❌ 不记录在财务管理
```

**财务管理统计（按时间）**：
- 2025年11月支出：1200元（采购）

**批次成本分析（待在其他模块实现）**：
- QY-20251017：240元（实际用药）
- QY-20251020：360元（实际用药）

## 修改历史

### 2025-11-07 修改内容

#### 1. 从批次筛选改为时间筛选

**修改前**：
```typescript
selectedBatchId: ''
selectedBatchLabel: '所有批次'
batchOptions: []
```

**修改后**：
```typescript
selectedPeriod: 'month'
selectedPeriodLabel: '本月'
periodOptions: [
  {label: '本月', value: 'month'},
  {label: '本季度', value: 'quarter'},
  {label: '本年', value: 'year'},
  {label: '自定义', value: 'custom'}
]
```

#### 2. 移除批次成本分析页面

**原因**：
- 财务管理专注于现金流
- 批次成本分析属于成本核算视角
- 应该在生产管理或独立模块中实现

**删除的文件**：
- `miniprogram/packageFinance/batch-cost-analysis/` 整个文件夹
- 相关的入口按钮和样式
- 云函数中的 `getBatchCostAnalysis` 函数

## 云函数接口

### get_finance_overview

**请求参数**：
```javascript
{
  action: 'get_finance_overview',
  dateRange: {
    start: '2025-11-01T00:00:00.000Z',
    end: '2025-11-30T23:59:59.999Z'
  },
  batchId: null  // 财务概览不按批次筛选
}
```

**返回数据**：
```javascript
{
  success: true,
  data: {
    income: { total: 34000 },
    expense: { total: 112000 },
    profit: { total: -78000 },
    costBreakdown: {
      feedCost: 2000,      // 饲料采购
      goslingCost: 110000, // 鹅苗采购
      medicalCost: 200,    // 药品采购
      otherCost: 100       // 报销等
    }
  }
}
```

### get_all_finance_records

**请求参数**：
```javascript
{
  action: 'get_all_finance_records',
  dateRange: {
    start: '2025-11-01T00:00:00.000Z',
    end: '2025-11-30T23:59:59.999Z'
  },
  batchId: null,  // 不按批次筛选
  page: 1,
  pageSize: 200
}
```

**返回数据**：
```javascript
{
  success: true,
  data: {
    records: [
      {
        id: 'purchase_xxx',
        type: 'expense',
        source: 'purchase',
        costType: 'health',
        amount: 1200,
        description: '药品采购 - 浆膜清 - 供应商 - 10瓶',
        date: '2025-11-01'
      },
      // ... 更多记录
    ],
    pagination: { page: 1, pageSize: 200, total: 15 }
  }
}
```

## 前端实现

### 关键文件

| 文件 | 作用 |
|------|------|
| `finance.ts` | 页面逻辑，时间筛选，数据加载 |
| `finance.wxml` | 页面结构，时间选择器，成本卡片 |
| `finance.scss` | 页面样式 |

### 关键方法

```typescript
// 时间选择器变化
onPeriodPickerChange(e: any)

// 获取当前选择的时间范围
getDateRange(): { start: string, end: string }

// 加载财务数据（成本卡片）
loadFinanceData()

// 加载财务记录（记录列表）
loadFinanceRecords()
```

## 未来规划

### 批次成本分析功能

**实现位置**：建议在以下地方实现

1. **生产管理模块**
   - 批次详情页面
   - 显示该批次的实际成本和利润
   - 包含投喂记录、治疗记录等

2. **独立的批次分析模块**
   - 专门的批次成本对比页面
   - 多批次成本对比
   - 成本趋势分析

### 自定义日期功能

**待实现**：
- 日期选择对话框
- 自定义开始和结束日期
- 保存用户的日期选择

### 数据导出功能

**待实现**：
- 导出财务报表
- 生成PDF/Excel
- 分享和打印

## 常见问题

### Q1: 为什么投喂记录不在财务管理中显示？

**A**: 因为投喂是库存流转，不涉及现金流动。饲料在采购时已经记录过现金流出了，投喂时只是从仓库拿出来使用，不需要再次记录。

### Q2: 如何查看某个批次用了多少饲料和药品？

**A**: 这属于成本核算功能，应该在生产管理模块的批次详情中查看，或者等待批次成本分析功能在其他模块实现。

### Q3: 医疗费用为什么是采购金额而不是使用金额？

**A**: 因为财务管理是现金流视角，记录的是实际花钱的时间和金额。买药时花了钱，所以记录采购。用药时没有花钱，所以不记录。

### Q4: 成本卡片的数据会重复计算吗？

**A**: 不会。所有成本卡片统计的都是采购记录，每笔采购只会统计一次。投喂和治疗记录不在财务管理中统计，所以不会重复。

## 总结

### 核心原则

✅ **财务管理 = 现金流**
- 只统计有现金流动的事件
- 采购记录：有现金流出 ✅
- 投喂记录：没有现金流动 ❌
- 治疗记录：没有现金流动 ❌

✅ **时间维度筛选**
- 按月、季度、年统计
- 符合财务管理习惯
- 清晰直观

✅ **简洁明了**
- 4个成本卡片
- 清晰的财务记录列表
- 专注于现金流分析

### 与其他功能的区分

| 功能 | 视角 | 筛选维度 | 统计内容 |
|------|------|---------|---------|
| **财务管理** | 现金流 | 时间 | 采购金额 |
| **批次成本分析** | 成本核算 | 批次 | 实际消耗 |
| **生产管理** | 业务运营 | 批次 | 投喂、治疗记录 |

各司其职，互不干扰，清晰明了。

