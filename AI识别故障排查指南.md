# AI智能识别故障排查指南

## 问题现象
真机调试时显示"识别失败，请重试"

## 排查步骤

### 1. 检查云函数部署状态 ✅

#### 操作步骤：
1. 打开微信开发者工具
2. 右键 `cloudfunctions/ai-multi-model` 文件夹
3. 选择 **"上传并部署：云端安装依赖"**
4. 等待部署完成（约1-2分钟）

#### 验证方法：
- 云函数列表中应该显示 `ai-multi-model`
- 状态应该是 **"正常"**
- 部署时间是最新的

---

### 2. 检查环境变量配置 🔑

#### 操作步骤：
1. 进入 **云开发控制台**
2. 点击 **云函数** → **ai-multi-model**
3. 点击 **配置** 标签
4. 检查 **环境变量**

#### 必需的环境变量：
```
QWEN_API_KEY = sk-xxxxxxxxxxxxx
```

#### 如何获取API Key：
1. 访问 [阿里云百炼平台](https://bailian.console.aliyun.com/)
2. 登录/注册账号
3. 进入 **API-KEY管理**
4. 创建新的API Key
5. 复制完整的Key（以 `sk-` 开头）

#### ⚠️ 注意事项：
- API Key不要有多余的空格
- 配置后需要 **重启云函数** 才能生效
- 确保账号有足够的免费额度

---

### 3. 查看云函数日志 📝

#### 操作步骤：
1. 进入 **云开发控制台**
2. 点击 **云函数** → **ai-multi-model**
3. 点击 **日志** 标签
4. 查看最近的调用记录

#### 关键日志信息：

**✅ 正常流程：**
```
====== 开始图像识别 ======
预期范围: {min: 50, max: 1000}
图片参数: 1个文件ID
📸 开始处理1张图片，模型: qwen-vl-max
获取云存储临时URL...
✅ 图片1成功: https://...
开始调用AI模型...
AI模型调用结果: 成功
✅ JSON解析成功，识别数量: 123
```

**❌ 常见错误：**

1. **API Key未配置**
```
错误: Bearer undefined
→ 解决: 配置QWEN_API_KEY环境变量
```

2. **API Key无效**
```
错误: Invalid API key
→ 解决: 检查API Key是否正确，是否已激活
```

3. **图片过大**
```
错误: 图片文件过大: 8.5MB（限制5MB）
→ 解决: 代码已有压缩逻辑，检查压缩是否生效
```

4. **网络超时**
```
错误: timeout of 60000ms exceeded
→ 解决: 检查网络连接，或增加超时时间
```

5. **模型调用失败**
```
错误: 通义千问调用失败
→ 解决: 检查API配额，查看详细错误码
```

---

### 4. 真机调试步骤 📱

#### 操作步骤：
1. 确保手机和电脑在同一网络
2. 打开微信开发者工具的 **调试器**
3. 切换到 **Console** 标签
4. 在真机上操作：
   - 点击 "AI智能盘点"
   - 拍照或选择照片
   - 点击 "开始识别"

#### 关键日志：

**前端日志（Console）：**
```javascript
开始上传图片到云存储...
图片上传成功，fileID: cloud://xxx.jpg
开始调用AI识别...
AI识别返回结果: {success: true, data: {...}}
识别成功，数量: 123
```

**如果失败，查看：**
```javascript
❌ analyzeImage异常: Error: ...
// 查看具体错误信息
```

---

### 5. 常见问题解决方案

#### 问题1: "缺少图片参数"
**原因：** 图片上传失败或fileID为空  
**解决：**
- 检查云存储权限
- 查看控制台是否有上传错误
- 确认图片大小不超过5MB

#### 问题2: "API调用失败，请检查配置"
**原因：** QWEN_API_KEY未配置或错误  
**解决：**
1. 重新配置API Key
2. 重启云函数
3. 清除缓存重新部署

#### 问题3: "请求超时，请重试"
**原因：** 网络慢或图片太大  
**解决：**
- 使用WiFi网络
- 确保图片压缩生效
- 尝试拍摄更小的图片

#### 问题4: "所有图片获取临时URL失败"
**原因：** 云存储文件不存在或权限问题  
**解决：**
1. 检查云存储配置
2. 确认文件确实上传成功
3. 检查云函数的云存储权限

---

### 6. 手动测试云函数

在云开发控制台中手动测试：

```json
{
  "action": "image_recognition",
  "images": ["cloud://test-xxx.6a6c7-xxx/ai-count/test.jpg"],
  "location": "测试区域",
  "expectedRange": {
    "min": 50,
    "max": 1000
  }
}
```

如果手动测试成功，说明云函数本身没问题，问题可能在前端。

---

### 7. 完整的检查清单

- [ ] 云函数已正确部署
- [ ] 环境变量 QWEN_API_KEY 已配置
- [ ] 云函数状态正常
- [ ] 图片能正常上传到云存储
- [ ] 云函数日志没有错误
- [ ] 前端console没有错误
- [ ] 网络连接正常
- [ ] API有足够的免费额度

---

## 快速验证命令

### 查看当前代码状态
```bash
# 查看是否有未提交的修改
git status

# 查看云函数配置
cat cloudfunctions/ai-multi-model/package.json
```

### 重新部署
```bash
# 运行部署脚本
sh deploy-ai-multi-model.sh
```

---

## 联系支持

如果以上步骤都无法解决问题，请提供：

1. **云函数日志截图**（完整的错误堆栈）
2. **前端Console日志**（包含错误信息）
3. **环境变量配置**（隐藏API Key的前后几位）
4. **测试的图片信息**（大小、尺寸）

---

## 附录：常用命令

### 查看云函数日志（实时）
在云开发控制台 → 云函数 → ai-multi-model → 日志

### 清除小程序缓存
微信开发者工具 → 工具 → 清除缓存 → 全部清除

### 重新编译
微信开发者工具 → 编译 → 清除缓存后编译

