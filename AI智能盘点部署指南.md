# AI智能盘点功能 - 部署指南

## 📋 功能概述

AI智能盘点功能允许用户通过拍照识别鹅群数量，支持：
- ✅ 单次拍照识别
- ✅ 多次拍照自动累加（避免重复计数）
- ✅ 密集场景优化识别
- ✅ 异常个体检测
- ✅ 自动生成出栏记录

## 🎯 已完成的工作

### 1. 云函数实现（ai-multi-model）
- [x] 添加 `image_recognition` action
- [x] 设计专门的鹅群计数提示词（Qwen-VL-Max优化）
- [x] 实现JSON解析和兜底方案
- [x] 数据验证和异常检测

### 2. 前端实现（production.ts/wxml）
- [x] 添加累加数据结构（rounds、cumulativeTotal）
- [x] 实现自动累加逻辑（addRecognitionToRounds）
- [x] 添加"继续识别"和"结束盘点"按钮
- [x] 实现图片压缩优化
- [x] 更新UI界面支持单次和累加两种模式

### 3. 用户体验优化
- [x] 图片自动压缩（最大1920x1080，质量85%）
- [x] 累计数据清晰展示
- [x] 引导用户避免重复计数
- [x] 平均置信度计算

## 🚀 部署步骤

### 步骤1：部署云函数

#### 方法A：通过微信开发者工具

1. 打开微信开发者工具
2. 在左侧找到 `cloudfunctions` → `ai-multi-model`
3. 右键点击 `ai-multi-model` → 选择"上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）

#### 方法B：通过命令行

```bash
# 进入云函数目录
cd /Users/kaka/Documents/Sync/小程序/鹅数通/cloudfunctions/ai-multi-model

# 确保依赖已安装
npm install

# 返回项目根目录
cd ../..

# 使用微信开发者工具的CLI工具上传
# （需要先安装微信开发者工具CLI）
```

### 步骤2：验证云函数部署

在微信开发者工具的云开发控制台：

1. 点击"云开发" → "云函数"
2. 找到 `ai-multi-model` 函数
3. 点击"测试"，输入以下测试数据：

```json
{
  "action": "image_recognition",
  "images": [],
  "expectedRange": {
    "min": 50,
    "max": 200
  },
  "location": "测试区域"
}
```

4. 如果返回成功响应（即使识别数量为0也正常，因为没有真实图片），说明部署成功

### 步骤3：前端代码上传

1. 在微信开发者工具中，点击"上传"按钮
2. 输入版本号（如：1.1.0）
3. 输入项目备注："新增AI智能盘点累加功能"
4. 点击"上传"

### 步骤4：提交审核（可选）

如果需要发布到生产环境：

1. 登录微信公众平台（mp.weixin.qq.com）
2. 进入"开发" → "开发管理" → "开发版本"
3. 选择刚上传的版本，点击"提交审核"
4. 填写审核信息

## 🧪 测试指南

### 测试场景1：单次识别

1. 进入"生产管理"页面
2. 切换到"出栏管理" Tab
3. 点击"AI智能盘点"按钮
4. 拍摄一张鹅群照片
5. 等待识别完成（约5-10秒）
6. 验证：
   - ✅ 显示识别数量
   - ✅ 显示置信度
   - ✅ 显示"继续识别"和"结束盘点"按钮

### 测试场景2：多次累加

1. 完成第一次识别后
2. 点击"继续识别"
3. 确认提示："请将已盘点的鹅群转移到其他区域"
4. 拍摄第二批鹅群照片
5. 验证：
   - ✅ 显示"本次识别：XX只"
   - ✅ 显示"累计总数：XX只"
   - ✅ 显示历史记录（第1次、第2次...）
6. 可继续识别更多批次
7. 点击"结束盘点"
8. 验证：
   - ✅ 显示累计统计信息
   - ✅ 成功跳转到出栏表单
   - ✅ 数量自动填充

### 测试场景3：异常检测

1. 拍摄包含卧地或异常鹅只的照片
2. 验证：
   - ✅ 显示"发现X只疑似异常个体"
   - ✅ 显示具体健康问题
   - ✅ 异常个体不计入出栏数量

### 测试场景4：图片质量

1. 测试不同环境：
   - 户外强光
   - 室内弱光
   - 密集场景
2. 验证：
   - ✅ 弱光环境给出"建议补光"提示
   - ✅ 密集场景给出"建议分批拍照"提示
   - ✅ 置信度合理（0.6-0.95）

## 📊 成本监控

### Qwen-VL-Max 成本

- **每次识别成本**：约1.5分/次
- **每日预算**：10元（约600-700次识别）
- **预计实际使用**：20-50次/天

### 监控方法

1. 在云开发控制台查看云函数调用次数
2. 查看 `sys_ai_usage` 集合统计数据
3. 如预算超支，系统自动降级到免费模型（Qwen-Long）

## ⚠️ 注意事项

### 1. 云函数超时设置

确保 `ai-multi-model` 云函数超时设置至少为 **60秒**：

1. 进入云开发控制台
2. 点击"云函数" → `ai-multi-model` → "配置"
3. 设置"超时时间"为 60 秒
4. 点击"保存"

### 2. 权限配置

确保云数据库权限正确：

- `sys_ai_usage`：仅创建者可读写（自动创建）
- `production_exit_records`：需要有写入权限

### 3. API密钥配置

确保环境变量中已配置：

```
QWEN_API_KEY=sk-xxxxxxxxxxxxx
```

如未配置，在云开发控制台：

1. 点击"设置" → "环境变量"
2. 添加变量：
   - 变量名：`QWEN_API_KEY`
   - 变量值：你的通义千问API密钥
3. 保存并重新部署云函数

## 🐛 常见问题

### 问题1：识别超时

**现象**：拍照后一直显示"AI分析中..."，最终超时

**解决方案**：
1. 检查云函数超时设置（应为60秒）
2. 检查网络连接
3. 尝试压缩图片大小

### 问题2：识别数量明显不准

**现象**：识别数量与实际差距>20%

**解决方案**：
1. 重新拍摄，确保光线充足
2. 避免过度密集场景（建议分批拍照）
3. 查看置信度，如<0.7建议重拍

### 问题3：累加后数量错误

**现象**：多次识别后，累计数量不对

**排查步骤**：
1. 检查是否有鹅群重复（物理隔离未做好）
2. 查看各轮次记录是否正确
3. 人工验证每次识别结果

### 问题4：创建出栏记录失败

**现象**：点击"结束盘点"后，跳转出栏表单失败

**解决方案**：
1. 检查 `production-exit` 云函数是否正常
2. 检查权限配置
3. 查看控制台错误日志

## 📈 后续优化建议

### 短期优化（1-2周）

1. **收集真实数据**
   - 收集100+张实际鹅群照片
   - 记录人工计数结果
   - 分析识别误差模式

2. **优化提示词**
   - 根据误差案例调整
   - 针对特定环境优化
   - 提高置信度阈值

### 中期优化（1-2个月）

1. **多角度验证**
   - 支持同一批次拍摄2-3张照片
   - 交叉验证识别结果
   - 取中位数或加权平均

2. **批次数据关联**
   - 自动获取批次存栏数量
   - 预填expectedRange参数
   - 异常识别预警

### 长期优化（3-6个月）

1. **训练专用模型**
   - 收集5000+张标注数据
   - 训练YOLO专用模型
   - 精度提升到±2%

2. **智能报告**
   - 生成盘点PDF报告
   - 包含所有照片和记录
   - 支持导出和打印

## 📞 技术支持

如遇到问题，请联系开发团队或查看：

- 云函数日志：云开发控制台 → 云函数 → 日志
- 前端日志：微信开发者工具 → 调试器 → Console
- 项目文档：`/Users/kaka/Documents/Sync/小程序/鹅数通/docs/`

---

**部署完成时间**：2025年1月（请在此填写实际部署日期）
**部署人员**：（请填写）
**测试状态**：待测试 / 已测试 / 已上线


