# ⚡ 快速操作 - 定时触发器3步

## 🎯 解决方案

**微信云函数最高60秒** → 使用**定时触发器**自动处理

---

## 📋 操作步骤（3步，5分钟）

### 第1步：上传2个云函数 📤

**在微信开发者工具中**：

```
A. 右键 cloudfunctions/process-ai-diagnosis
   → "上传并部署：云端安装依赖"
   → 等待完成

B. 右键 cloudfunctions/ai-diagnosis  
   → "上传并部署：云端安装依赖"
   → 等待完成
```

---

### 第2步：配置定时触发器 ⏰

**打开控制台**：
```
微信开发者工具
→ 顶部菜单"云开发"
→ "云开发控制台"
```

**配置触发器**：
```
1. 左侧菜单：云函数
2. 点击：process-ai-diagnosis
3. 点击标签：触发器
4. 点击按钮：创建触发器
5. 填写：
   名称: auto-process
   周期: 自定义
   Cron: 0 * * * * * *
   (每分钟触发一次)
6. 点击：提交 ✅
```

**Cron表达式**：
```
0 * * * * * *  ← 复制这个
表示：每分钟第0秒触发
```

---

### 第3步：测试 🧪

```
1. 打开 AI诊断页面
2. 上传1张图片
3. 提交诊断
4. 等待 60-90秒（最多2分钟）
5. 看到结果 ✅
```

---

## 🎯 验证成功

### 触发器配置

```
云函数 → process-ai-diagnosis → 触发器
看到：auto-process（已启用）✅
```

### 云函数日志（每分钟都有）

```
====== 模式2: 自动扫描待处理任务 ======
找到 X 个待处理任务
处理完成: 成功 X/X ✅
```

### 前端显示

```
✅ 诊断中...（60-90秒）
✅ 诊断完成！
✅ 显示结果
```

---

## 💡 工作原理

```
前端提交 → ai-diagnosis 创建任务（2秒返回）
              ↓
          数据库: status=processing
              ↓
       定时触发器: 每分钟自动运行
              ↓
   process-ai-diagnosis: 扫描并处理
              ↓
       调用 GEMINI (40秒)
              ↓
       更新状态: completed ✅
              ↓
       前端轮询: 显示结果 🎉
```

**优势**：
- ✅ 无超时问题（无云函数调用链）
- ✅ 自动批量处理
- ✅ 稳定可靠

---

## 📊 时间预期

| 情况 | 时间 |
|------|------|
| 最快 | 45秒 |
| 平均 | 70秒 |
| 最慢 | 110秒 |

**说明**：
- 最快：刚好赶上触发
- 最慢：刚错过触发，等下一分钟

---

## ⚠️ 注意事项

### 1. Cron表达式

必须这样填：
```
0 * * * * * *

❌ 错误：0 0 * * * *（少了2个*）
❌ 错误：* * * * * *（第一个应该是0）
✅ 正确：0 * * * * * *
```

### 2. 触发器启用

创建后确认：
- 状态显示"已启用"
- 不是"已停用"

### 3. 日志确认

触发器生效后：
- 每分钟都有日志
- 即使无任务也会记录

---

## 🆘 常见问题

### Q1: 找不到"触发器"标签？

```
确保点击了 process-ai-diagnosis（进入详情页）
不是只展开文件夹
```

### Q2: 触发器创建后还是失败？

**检查**：
1. 两个云函数都上传了吗？
2. 触发器是"已启用"吗？
3. 等了2分钟吗？（需要生效时间）

### Q3: Cron表达式填错了怎么办？

```
删除触发器 → 重新创建
或点击触发器 → 编辑 → 改正
```

---

## 📝 快速检查清单

- [ ] 上传 process-ai-diagnosis
- [ ] 上传 ai-diagnosis
- [ ] 创建定时触发器（每分钟）
- [ ] 触发器状态"已启用"
- [ ] 等待2分钟
- [ ] 测试1张图片
- [ ] 成功！✅

---

**现在就开始3步操作！** 🚀

5分钟搞定，彻底解决超时问题！

