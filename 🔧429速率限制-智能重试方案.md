# ğŸ”§ 429é€Ÿç‡é™åˆ¶ - æ™ºèƒ½é‡è¯•æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜è¯Šæ–­

### é”™è¯¯ä¿¡æ¯
```
Request failed with status code 429
```

### æ ¹æœ¬åŸå› 
- **HTTP 429 = Too Many Requestsï¼ˆè¯·æ±‚è¿‡äºé¢‘ç¹ï¼‰**
- æ™ºè°±APIçš„å…è´¹é¢åº¦æœ‰é€Ÿç‡é™åˆ¶ï¼ˆQPMé™åˆ¶ï¼‰
- ä¹‹å‰æµ‹è¯•å¤ªé¢‘ç¹ï¼Œè§¦å‘äº†é€Ÿç‡é™åˆ¶

### ğŸ‰ å¥½æ¶ˆæ¯
**ä»400é”™è¯¯å˜æˆ429é”™è¯¯ï¼Œè¯´æ˜GLM-4Vçš„è°ƒç”¨æ–¹å¼æ˜¯æ­£ç¡®çš„ï¼** åªæ˜¯é‡åˆ°äº†é€Ÿç‡é™åˆ¶é—®é¢˜ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ - æ™ºèƒ½é‡è¯•å’ŒFallback

### æ ¸å¿ƒæ€è·¯
1. **ä¸»æ¨¡å‹**: GLM-4Vï¼ˆæ™ºè°±AIå¤šæ¨¡æ€è§†è§‰æ¨¡å‹ï¼‰
2. **å¤‡ç”¨æ¨¡å‹**: Qwen-VLï¼ˆSiliconFlowå¤šæ¨¡æ€æ¨¡å‹ï¼‰
3. **æ™ºèƒ½é‡è¯•**: é‡åˆ°429è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹
4. **ç­‰å¾…æœºåˆ¶**: åœ¨åˆ‡æ¢å‰ç­‰å¾…2ç§’

### ä»£ç å®ç°

#### 1. `ai-multi-model/index.js` - æ·»åŠ 429é”™è¯¯æ£€æµ‹
```javascript
// è°ƒç”¨AIæ¨¡å‹ï¼ˆå¸¦é‡è¯•ï¼‰
async callModel(modelId, messages, options = {}) {
  // ... åŸæœ‰ä»£ç  ...
  
  try {
    // ... APIè°ƒç”¨ ...
  } catch (error) {
    // å¦‚æœæ˜¯429é”™è¯¯ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰ï¼Œæ·»åŠ ç‰¹æ®Šæ ‡è®°
    if (error.response?.status === 429) {
      error.isRateLimited = true
      error.retryAfter = error.response?.headers?.['retry-after'] || 60
    }
    throw error
  }
}
```

#### 2. `handleChatCompletion` - æ™ºèƒ½é‡è¯•é€»è¾‘
```javascript
async function handleChatCompletion(event, manager) {
  try {
    // è·å–æ¨¡å‹é…ç½®
    const modelMapping = TASK_MODEL_MAPPING[actualTaskType]
    
    // å‡†å¤‡å°è¯•çš„æ¨¡å‹åˆ—è¡¨
    const modelsToTry = [modelMapping.primary]
    if (modelMapping.fallback) {
      modelsToTry.push(modelMapping.fallback)
    }

    // ä¾æ¬¡å°è¯•æ¯ä¸ªæ¨¡å‹
    let lastError = null
    for (let i = 0; i < modelsToTry.length; i++) {
      const modelId = modelsToTry[i]
      
      try {
        // è°ƒç”¨æ¨¡å‹
        const result = await manager.callModel(modelId, processedMessages, options)
        
        // æˆåŠŸï¼Œè¿”å›ç»“æœ
        return {
          success: true,
          data: result,
          modelUsed: modelId,
          usedVision,
          fromCache: false
        }
      } catch (error) {
        lastError = error
        
        // å¦‚æœæ˜¯é€Ÿç‡é™åˆ¶ä¸”è¿˜æœ‰å…¶ä»–æ¨¡å‹å¯å°è¯•
        if (error.isRateLimited && i < modelsToTry.length - 1) {
          console.log(`âš ï¸ é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…2ç§’åå°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹...`)
          await new Promise(resolve => setTimeout(resolve, 2000))
          continue
        }
        
        // å°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹
        if (i < modelsToTry.length - 1) {
          continue
        }
        
        // æ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥äº†
        throw error
      }
    }
  } catch (error) {
    // è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯
  }
}
```

### æ¨¡å‹é…ç½®

```javascript
// è§†è§‰è¯Šæ–­ä»»åŠ¡çš„æ¨¡å‹é…ç½®
TASK_MODEL_MAPPING = {
  health_diagnosis_vision: {
    primary: 'glm-4v',      // ä¸»æ¨¡å‹ï¼šæ™ºè°±GLM-4V
    fallback: 'qwen-vl'     // å¤‡ç”¨ï¼šQwen-VL
  }
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä¸Šä¼ äº‘å‡½æ•°
```bash
# åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å³é”® ai-multi-model
é€‰æ‹©ï¼šä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ï¼ˆä¸ä¸Šä¼ node_modulesï¼‰
```

### 2. æµ‹è¯•æµç¨‹

#### åœºæ™¯1ï¼šä¸»æ¨¡å‹å¯ç”¨
```
å¼€å§‹å¤„ç†å¯¹è¯
â†’ å°è¯•æ¨¡å‹ 1/2: glm-4v
â†’ âœ… æ¨¡å‹ glm-4v è°ƒç”¨æˆåŠŸ
â†’ è¿”å›è¯Šæ–­ç»“æœ
```

#### åœºæ™¯2ï¼šä¸»æ¨¡å‹é€Ÿç‡é™åˆ¶
```
å¼€å§‹å¤„ç†å¯¹è¯
â†’ å°è¯•æ¨¡å‹ 1/2: glm-4v
â†’ âŒ æ¨¡å‹ glm-4v å¤±è´¥: 429
â†’ âš ï¸ é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…2ç§’...
â†’ å°è¯•æ¨¡å‹ 2/2: qwen-vl
â†’ âœ… æ¨¡å‹ qwen-vl è°ƒç”¨æˆåŠŸ
â†’ è¿”å›è¯Šæ–­ç»“æœ
```

#### åœºæ™¯3ï¼šæ‰€æœ‰æ¨¡å‹éƒ½å¤±è´¥
```
å¼€å§‹å¤„ç†å¯¹è¯
â†’ å°è¯•æ¨¡å‹ 1/2: glm-4v
â†’ âŒ æ¨¡å‹ glm-4v å¤±è´¥: 429
â†’ å°è¯•æ¨¡å‹ 2/2: qwen-vl
â†’ âŒ æ¨¡å‹ qwen-vl å¤±è´¥: XXX
â†’ è¿”å›é”™è¯¯: æ‰€æœ‰æ¨¡å‹è°ƒç”¨å‡å¤±è´¥
```

---

## ğŸ” æ—¥å¿—ç›‘æ§

### å…³é”®æ—¥å¿—

1. **æ¨¡å‹é€‰æ‹©æ—¥å¿—**
```
å°è¯•æ¨¡å‹ 1/2: glm-4v (æ™ºè°±GLM-4V)
```

2. **é€Ÿç‡é™åˆ¶æ—¥å¿—**
```
âš ï¸ é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…2ç§’åå°è¯•ä¸‹ä¸€ä¸ªæ¨¡å‹...
```

3. **æˆåŠŸæ—¥å¿—**
```
âœ… æ¨¡å‹ glm-4v è°ƒç”¨æˆåŠŸ
```

4. **å¤±è´¥æ—¥å¿—**
```
âŒ æ¨¡å‹ glm-4v å¤±è´¥: Request failed with status code 429
```

### æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—
```
å¾®ä¿¡å¼€å‘è€…å·¥å…·
â†’ äº‘å¼€å‘æ§åˆ¶å°
â†’ äº‘å‡½æ•°
â†’ ai-multi-model
â†’ æ—¥å¿—
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. é¿å…é€Ÿç‡é™åˆ¶
- **å‡å°‘æµ‹è¯•é¢‘ç‡**ï¼šä¸è¦è¿ç»­å¿«é€Ÿæµ‹è¯•
- **ç­‰å¾…æ—¶é—´**ï¼šé‡åˆ°429åè‡³å°‘ç­‰å¾…1åˆ†é’Ÿ
- **å‡çº§å¥—é¤**ï¼šè€ƒè™‘è´­ä¹°æ›´é«˜QPMé™åˆ¶çš„å¥—é¤

### 2. ä¼˜åŒ–è°ƒç”¨ç­–ç•¥
- **ç¼“å­˜è¯Šæ–­ç»“æœ**ï¼ˆå·²å®ç°ï¼‰
- **æ‰¹é‡å¤„ç†**ï¼šå¤šä¸ªç—‡çŠ¶ä¸€èµ·è¯Šæ–­
- **å»¶è¿Ÿè°ƒç”¨**ï¼šéç´§æ€¥è¯Šæ–­å¯å»¶è¿Ÿ

### 3. ç›‘æ§å’Œå‘Šè­¦
- è®°å½•æ¯æ—¥APIè°ƒç”¨æ¬¡æ•°
- ç»Ÿè®¡429é”™è¯¯é¢‘ç‡
- è®¾ç½®é¢åº¦é¢„è­¦

---

## ğŸ“‹ æµ‹è¯•æ¸…å•

- [ ] éƒ¨ç½² `ai-multi-model` äº‘å‡½æ•°
- [ ] ä¸Šä¼ 3å¼ ç—‡çŠ¶å›¾ç‰‡
- [ ] æäº¤AIè¯Šæ–­
- [ ] æŸ¥çœ‹äº‘å‡½æ•°æ—¥å¿—
- [ ] ç¡®è®¤ä½¿ç”¨äº†å“ªä¸ªæ¨¡å‹ï¼ˆglm-4v æˆ– qwen-vlï¼‰
- [ ] æ£€æŸ¥è¯Šæ–­ç»“æœæ˜¯å¦åŒ…å«å›¾ç‰‡åˆ†æ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é€Ÿç‡é™åˆ¶æ¢å¤æ—¶é—´**
   - é€šå¸¸1åˆ†é’Ÿåè‡ªåŠ¨æ¢å¤
   - ä¸¥é‡æƒ…å†µå¯èƒ½éœ€è¦ç­‰å¾…æ›´é•¿æ—¶é—´

2. **å¤‡ç”¨æ¨¡å‹å·®å¼‚**
   - GLM-4V å’Œ Qwen-VL çš„è¯Šæ–­ç»“æœå¯èƒ½ç•¥æœ‰ä¸åŒ
   - éƒ½æ˜¯é«˜è´¨é‡çš„å¤šæ¨¡æ€æ¨¡å‹

3. **é”™è¯¯ä¿¡æ¯ä¼ é€’**
   - å‰ç«¯ä¼šæ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - åŒ…æ‹¬å°è¯•äº†å“ªäº›æ¨¡å‹
   - å¤±è´¥åŸå› 

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### æˆåŠŸç‡æå‡
- **ä¹‹å‰**: é‡åˆ°429ç›´æ¥å¤±è´¥
- **ç°åœ¨**: è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹ï¼ŒæˆåŠŸç‡æ¥è¿‘100%

### ç”¨æˆ·ä½“éªŒ
- **æ— æ„Ÿåˆ‡æ¢**: ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒä½¿ç”¨äº†å“ªä¸ªæ¨¡å‹
- **å¿«é€Ÿå“åº”**: ç­‰å¾…æ—¶é—´ä»…å¢åŠ 2ç§’
- **å‹å¥½æç¤º**: å¤±è´¥æ—¶æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. äº‘å‡½æ•°æ—¥å¿—æˆªå›¾
2. å‰ç«¯é”™è¯¯ä¿¡æ¯
3. è¯Šæ–­ä»»åŠ¡ID
4. ä¸Šä¼ çš„å›¾ç‰‡æ•°é‡

---

**âœ… ç°åœ¨å¯ä»¥é‡æ–°éƒ¨ç½²å¹¶æµ‹è¯•äº†ï¼**

