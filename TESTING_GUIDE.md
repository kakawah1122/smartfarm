# 权限管理系统测试指南

## 🎯 测试目标

验证微信小程序的权限管理系统功能是否正常，包括：
- 管理员自动设置
- 员工邀请机制
- 权限分配与验证
- 功能访问控制

## 📋 测试前准备

### 1. 部署云函数

确保以下云函数已正确部署：

```bash
# 1. 部署更新后的登录云函数
cd cloudfunctions/login
npm install
# 右键选择"上传并部署：云端安装依赖"

# 2. 部署员工管理云函数
cd cloudfunctions/employeeManage
npm install
# 右键选择"上传并部署：云端安装依赖"

# 3. 部署数据清理云函数（用于测试）
cd cloudfunctions/clearTestData
npm install
# 右键选择"上传并部署：云端安装依赖"
```

### 2. 准备测试账号

- **账号A**：用于测试管理员功能
- **账号B**：用于测试员工加入功能
- 确保两个账号都可以正常登录微信小程序

### 3. 测试环境

- 云开发环境正常
- 小程序代码已部署到测试版本
- 网络连接稳定

## 🚀 测试流程

### 步骤1：清除测试数据

1. **使用测试页面清除**
   - 在小程序中访问：个人中心 → 权限测试
   - 点击"清除数据"按钮
   - 确认清除操作

2. **手动清除方式**
   ```javascript
   // 在云开发控制台数据库中手动删除：
   // - users 集合的所有数据
   // - employee_invites 集合的所有数据
   ```

3. **验证清除结果**
   - 检查本地存储已清空
   - 确认登录状态已重置
   - 数据库集合为空

### 步骤2：测试管理员注册

1. **使用账号A重新登录**
   - 打开微信小程序
   - 进入登录页面
   - 完成微信授权登录
   - 填写完整的用户信息

2. **验证管理员权限**
   - 检查用户角色是否为 `admin`
   - 验证权限列表包含 `all`
   - 确认可以访问员工管理功能

3. **测试管理员功能**
   - 进入"个人中心" → "员工管理"
   - 验证可以查看员工列表
   - 确认有"邀请员工"按钮

### 步骤3：测试邀请员工功能

1. **生成邀请码**
   - 点击"邀请员工"按钮
   - 填写员工信息：
     ```
     部门：生产部
     职位：饲养员
     权限：basic, production.view, health.view
     有效期：7天
     ```
   - 生成邀请码并复制

2. **验证邀请记录**
   - 切换到"邀请记录"标签
   - 查看新创建的邀请记录
   - 确认状态为"待使用"

3. **复制邀请码**
   - 保存生成的8位邀请码
   - 准备发送给测试账号B

### 步骤4：测试员工加入功能

1. **使用账号B登录**
   - 切换到另一个微信账号
   - 完成小程序登录流程
   - 填写基本用户信息

2. **通过邀请码加入**
   - 进入"个人中心" → "员工管理"
   - 点击"加入组织"按钮
   - 输入步骤3中获得的邀请码
   - 确认加入操作

3. **验证加入结果**
   - 检查用户角色变为 `employee`
   - 验证权限列表正确
   - 确认部门和职位信息

### 步骤5：测试权限验证

1. **员工权限测试**
   ```
   使用账号B（员工）测试：
   ✅ 可以访问：基础功能、生产查看、健康查看
   ❌ 不能访问：财务管理、员工管理（完整功能）
   ```

2. **管理员权限测试**
   ```
   使用账号A（管理员）测试：
   ✅ 可以访问：所有功能模块
   ✅ 可以管理：员工信息、权限分配
   ```

3. **功能访问控制**
   - 测试菜单显示/隐藏
   - 验证权限提示信息
   - 确认页面访问控制

### 步骤6：测试员工管理功能

1. **查看员工列表**（管理员）
   - 验证显示所有员工
   - 检查员工状态和权限
   - 确认操作按钮可用

2. **编辑员工权限**
   - 选择一个员工进行编辑
   - 修改权限配置
   - 保存并验证生效

3. **员工状态管理**
   - 测试激活/停用功能
   - 验证状态变更效果

### 步骤7：测试邀请码管理

1. **邀请码状态**
   - 使用后的邀请码状态变为"已使用"
   - 记录使用者和使用时间
   - 过期邀请码不能使用

2. **邀请码安全性**
   - 错误邀请码提示
   - 过期邀请码处理
   - 重复使用防护

## 🔍 测试检查点

### 数据库检查

1. **users 集合**
   ```javascript
   // 检查字段：
   {
     role: 'admin' | 'employee' | 'user',
     permissions: ['all'] | ['basic', ...],
     department: string,
     position: string,
     organizationId: string,
     managedBy: string,
     isActive: boolean
   }
   ```

2. **employee_invites 集合**
   ```javascript
   // 检查字段：
   {
     inviteCode: string,
     isUsed: boolean,
     usedBy: string,
     usedTime: Date,
     expireTime: Date
   }
   ```

### 功能检查

- [ ] 第一个用户自动成为管理员
- [ ] 邀请码正确生成和使用
- [ ] 权限验证正确执行
- [ ] 菜单根据权限显示
- [ ] 员工信息正确管理
- [ ] 邀请记录完整追踪

### 用户体验检查

- [ ] 错误提示清晰明确
- [ ] 操作流程顺畅自然
- [ ] 权限不足提示友好
- [ ] 加载状态正确显示
- [ ] 成功反馈及时准确

## 🐛 常见问题排查

### 1. 云函数调用失败

**问题**：调用云函数时报错
**排查**：
- 检查云函数是否正确部署
- 验证云开发环境配置
- 查看云函数日志
- 确认网络连接

**解决**：
```bash
# 重新部署云函数
cd cloudfunctions/[functionName]
npm install
# 右键重新部署
```

### 2. 权限验证异常

**问题**：权限检查不正确
**排查**：
- 检查用户信息完整性
- 验证 permissions 字段格式
- 确认角色设置正确

**解决**：
```javascript
// 在控制台检查用户数据
console.log('用户信息：', app.globalData.userInfo)
console.log('权限列表：', userInfo.permissions)
```

### 3. 邀请码无法使用

**问题**：输入邀请码提示无效
**排查**：
- 确认邀请码格式正确
- 检查是否已过期
- 验证是否已被使用
- 确认大小写匹配

**解决**：
```javascript
// 在数据库中查询邀请码
db.collection('employee_invites').where({
  inviteCode: 'YOUR_CODE'
}).get()
```

### 4. 数据清除失败

**问题**：测试数据无法完全清除
**排查**：
- 检查确认密钥是否正确
- 验证云函数权限
- 确认数据库连接

**解决**：
```javascript
// 手动在云开发控制台删除数据
// 或使用正确的确认密钥：CLEAR_TEST_DATA_2024
```

## 📊 测试报告模板

### 测试环境
- 测试时间：[日期时间]
- 云开发环境：[环境ID]
- 小程序版本：[版本号]
- 测试人员：[姓名]

### 测试结果

| 测试项目 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|---------|---------|------|------|
| 管理员注册 | 第一个用户成为管理员 | [结果] | ✅/❌ | [备注] |
| 邀请码生成 | 成功生成8位邀请码 | [结果] | ✅/❌ | [备注] |
| 员工加入 | 通过邀请码成功加入 | [结果] | ✅/❌ | [备注] |
| 权限验证 | 正确控制功能访问 | [结果] | ✅/❌ | [备注] |
| 员工管理 | 可以管理员工信息 | [结果] | ✅/❌ | [备注] |

### 发现问题
1. [问题描述]
2. [问题描述]

### 改进建议
1. [建议内容]
2. [建议内容]

## 🎉 测试完成检查清单

- [ ] 所有云函数部署成功
- [ ] 管理员权限设置正确
- [ ] 员工邀请流程完整
- [ ] 权限验证功能正常
- [ ] 用户界面友好易用
- [ ] 错误处理机制完善
- [ ] 数据安全机制有效
- [ ] 测试文档记录完整

完成以上所有检查项目后，权限管理系统测试完成！
