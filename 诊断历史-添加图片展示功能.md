# 诊断历史 - 添加图片展示功能

## 📋 需求说明

在诊断历史详情弹窗中显示诊断时上传的图片（症状图片或剖检图片）。

## ✅ 已完成的改动

### 1. 云函数数据优化

#### `cloudfunctions/ai-diagnosis/index.js` (getDiagnosisHistory函数)

**新增字段**（第1022-1024行）：
```javascript
// ✅ 诊断图片（症状图片或剖检图片）
images: record.images || [],
diagnosisType: record.diagnosisType || 'live_diagnosis',
```

**说明**：
- `images`: 图片文件ID数组，存储在云存储中
- `diagnosisType`: 诊断类型
  - `'live_diagnosis'`: 病鹅诊断（症状图片）
  - `'autopsy_analysis'`: 死因剖析（剖检图片）

### 2. 前端页面功能

#### `miniprogram/packageAI/diagnosis-history/diagnosis-history.ts`

**优化 `onViewRecord` 函数**（第171-204行）：
- ✅ 自动将云存储文件ID转换为临时URL
- ✅ 三层保护机制，确保不传递null值给图片组件
- ✅ 错误处理：转换失败时使用原始URL

```typescript
async onViewRecord(e: any) {
  const { record } = e.currentTarget.dataset
  
  // ✅ 处理图片URL - 转换为临时URL
  let processedImages = record.images || []
  
  // 首先过滤掉无效值
  processedImages = processedImages.filter((url: any) => url && typeof url === 'string')
  
  if (processedImages.length > 0) {
    try {
      const tempUrlResult = await wx.cloud.getTempFileURL({
        fileList: processedImages
      })
      
      if (tempUrlResult.fileList && tempUrlResult.fileList.length > 0) {
        processedImages = tempUrlResult.fileList
          .map((item: any) => item.tempFileURL || item.fileID)
          .filter((url: any) => url && typeof url === 'string')
      }
    } catch (urlError) {
      console.warn('图片URL转换失败，使用原始URL:', urlError)
    }
  }
  
  this.setData({
    selectedRecord: {
      ...record,
      images: processedImages
    },
    showDetailDialog: true
  })
}
```

**新增 `onPreviewImage` 函数**（第214-225行）：
- ✅ 点击图片进入全屏预览
- ✅ 支持左右滑动查看所有图片

```typescript
onPreviewImage(e: any) {
  const { url } = e.currentTarget.dataset
  const images = this.data.selectedRecord?.images || []
  
  if (images.length > 0) {
    wx.previewImage({
      current: url,
      urls: images
    })
  }
}
```

#### `miniprogram/packageAI/diagnosis-history/diagnosis-history.wxml`

**新增图片展示区块**（第169-194行）：
```xml
<!-- 诊断图片 -->
<view class="detail-section" wx:if="{{selectedRecord.images && selectedRecord.images.length > 0}}">
  <view class="detail-section-title">
    {{selectedRecord.diagnosisType === 'autopsy_analysis' ? '剖检图片' : '症状图片'}}
    <text class="image-count">({{selectedRecord.images.length}}张)</text>
  </view>
  <view class="diagnosis-images">
    <view 
      class="image-item"
      wx:for="{{selectedRecord.images}}"
      wx:key="index"
      bind:tap="onPreviewImage"
      data-url="{{item}}"
    >
      <t-image 
        src="{{item}}"
        mode="aspectFill"
        width="200rpx"
        height="200rpx"
        shape="round"
        loading="lazy"
        error="加载失败"
      />
    </view>
  </view>
</view>
```

**功能特点**：
- ✅ 根据诊断类型显示不同标题（症状图片 / 剖检图片）
- ✅ 显示图片数量
- ✅ 响应式网格布局
- ✅ 点击图片可全屏预览
- ✅ 懒加载优化性能
- ✅ 错误处理提示

#### `miniprogram/packageAI/diagnosis-history/diagnosis-history.scss`

**新增图片样式**（第460-486行）：
```scss
/* 诊断图片展示 */
.diagnosis-images {
  display: flex;
  flex-wrap: wrap;
  gap: 16rpx;
  padding-top: 12rpx;
}

.image-item {
  width: 200rpx;
  height: 200rpx;
  border-radius: 12rpx;
  overflow: hidden;
  box-shadow: 0 2rpx 8rpx rgba(0, 0, 0, 0.08);
  
  &:active {
    opacity: 0.8;
    transform: scale(0.98);
  }
}

.image-count {
  font-size: 24rpx;
  color: #999;
  font-weight: 400;
  margin-left: 8rpx;
}
```

**样式特点**：
- ✅ 200rpx × 200rpx 正方形网格
- ✅ 16rpx 间距，自动换行
- ✅ 圆角边框 + 阴影效果
- ✅ 点击时轻微缩放反馈
- ✅ 图片数量灰色显示

#### `miniprogram/packageAI/diagnosis-history/diagnosis-history.json`

**新增组件引用**（第13行）：
```json
"t-image": "tdesign-miniprogram/image/image"
```

## 📊 数据流程

```
┌─────────────────────────────┐
│  AI诊断时上传图片           │
│  (症状图片/剖检图片)        │
│  存储到云存储               │
└──────────────┬──────────────┘
               │
               │ 保存文件ID
               ↓
┌─────────────────────────────┐
│  health_ai_diagnosis        │
│  - images: [fileID1,        │
│             fileID2, ...]   │
│  - diagnosisType:           │
│    'live_diagnosis' /       │
│    'autopsy_analysis'       │
└──────────────┬──────────────┘
               │
               │ 查询历史
               ↓
┌─────────────────────────────┐
│  getDiagnosisHistory        │
│  返回 images 数组           │
└──────────────┬──────────────┘
               │
               │ 前端处理
               ↓
┌─────────────────────────────┐
│  onViewRecord               │
│  - 过滤无效值               │
│  - getTempFileURL 转换      │
│  - 再次过滤确保安全         │
└──────────────┬──────────────┘
               │
               │ 显示
               ↓
┌─────────────────────────────┐
│  诊断详情弹窗               │
│  - 网格展示图片             │
│  - 点击全屏预览             │
│  - 左右滑动浏览             │
└─────────────────────────────┘
```

## 🎨 UI展示位置

诊断历史详情弹窗的信息展示顺序（已更新）：

1. **AI诊断结果** (白色背景)
2. **诊断修正记录** (绿色渐变，如果存在)
3. **症状描述** (白色背景)
4. **📷 诊断图片** (白色背景，✨新增)
   - 标题：症状图片(N张) 或 剖检图片(N张)
   - 图片网格：200×200rpx，自动换行
   - 点击全屏预览
5. **建议用药** (白色背景，AI推荐)
6. **实际治疗记录** (蓝色渐变，如果存在)
7. **基本信息** (白色背景)

## 🔧 部署步骤

### 1. 上传云函数

```bash
# 使用微信开发者工具
1. 打开云开发控制台
2. 选择"云函数"
3. 右键 ai-diagnosis → 上传并部署:云端安装依赖
```

### 2. 编译小程序

前端代码会自动编译，无需手动操作。

### 3. 测试验证

#### 测试场景1: 查看有图片的诊断记录
1. 进入"AI诊断" → "诊断历史"
2. 点击任意包含图片的诊断记录
3. ✅ 验证：详情弹窗中显示"症状图片"或"剖检图片"区块
4. ✅ 验证：图片数量显示正确
5. ✅ 验证：图片网格排列整齐

#### 测试场景2: 全屏预览图片
1. 在诊断详情弹窗中点击任意图片
2. ✅ 验证：进入全屏预览模式
3. ✅ 验证：可以左右滑动查看所有图片
4. ✅ 验证：可以双指缩放查看细节

#### 测试场景3: 无图片的诊断记录
1. 查看一个没有上传图片的诊断记录
2. ✅ 验证：不显示"诊断图片"区块
3. ✅ 验证：其他内容正常显示

#### 测试场景4: 图片加载失败
1. 模拟网络异常或图片文件不存在
2. ✅ 验证：显示"加载失败"提示
3. ✅ 验证：不影响其他内容的正常显示

## 🛡️ 安全机制

### 三层图片保护

与异常记录详情页面一致的安全机制：

1. **原始数据过滤**：
   ```typescript
   processedImages = processedImages.filter((url: any) => url && typeof url === 'string')
   ```

2. **转换结果过滤**：
   ```typescript
   processedImages = tempUrlResult.fileList
     .map((item: any) => item.tempFileURL || item.fileID)
     .filter((url: any) => url && typeof url === 'string')
   ```

3. **错误恢复保护**：
   ```typescript
   catch (urlError) {
     console.warn('图片URL转换失败，使用原始URL:', urlError)
     // 继续使用已过滤的原始图片URL
   }
   ```

**效果**：确保任何情况下都不会向 `t-image` 组件传递 `null` 或无效值。

## 📝 数据字段说明

### `health_ai_diagnosis` 集合

```javascript
{
  _id: String,
  diagnosisType: String,  // 'live_diagnosis' 或 'autopsy_analysis'
  images: Array,          // 图片文件ID数组，例如：
                          // ['cloud://xxx.png', 'cloud://yyy.jpg']
  symptomsText: String,
  affectedCount: Number,
  dayAge: Number,
  result: Object,        // AI诊断结果
  createdAt: Date,
  // ... 其他字段
}
```

## 🎯 用户体验提升

1. **完整诊断信息**：
   - 用户可以直接在历史记录中查看当时上传的图片
   - 方便对比症状变化和治疗效果

2. **智能标题**：
   - 自动根据诊断类型显示"症状图片"或"剖检图片"
   - 显示图片数量，一目了然

3. **便捷预览**：
   - 点击图片立即全屏查看
   - 支持左右滑动、双指缩放
   - 查看大图更清晰

4. **性能优化**：
   - 懒加载图片，不影响页面打开速度
   - 网格布局，自适应不同数量的图片

5. **友好提示**：
   - 加载失败时显示提示，不留白屏
   - 没有图片时不显示该区块，界面简洁

## ⚠️ 注意事项

1. **云存储文件ID有效期**：
   - `getTempFileURL` 获取的临时URL有效期为2小时
   - 每次打开详情弹窗都会重新获取，确保可用

2. **图片数量限制**：
   - 建议每次诊断上传3-5张图片
   - 过多图片会影响加载速度

3. **历史数据兼容**：
   - 旧的诊断记录如果没有 `images` 字段，不会显示图片区块
   - 不影响其他内容的正常展示

4. **错误处理**：
   - 图片加载失败会显示提示，但不影响其他功能
   - 控制台会输出警告日志，便于调试

## 📁 修改的文件

1. `cloudfunctions/ai-diagnosis/index.js` - 添加images字段到返回数据
2. `miniprogram/packageAI/diagnosis-history/diagnosis-history.ts` - 图片URL转换和预览
3. `miniprogram/packageAI/diagnosis-history/diagnosis-history.wxml` - 图片展示UI
4. `miniprogram/packageAI/diagnosis-history/diagnosis-history.scss` - 图片展示样式
5. `miniprogram/packageAI/diagnosis-history/diagnosis-history.json` - 添加t-image组件

## ✨ 总结

本次更新为诊断历史详情弹窗添加了完整的图片展示功能：
- ✅ 自动识别诊断类型，显示对应标题
- ✅ 网格布局展示图片，支持点击全屏预览
- ✅ 三层安全保护机制，确保稳定运行
- ✅ 性能优化和友好提示，提升用户体验

现在用户可以在诊断历史中看到完整的诊断信息，包括当时上传的症状图片或剖检图片！🎉

