# AI 诊断 Prompt 升级清单

## ✅ 已完成的优化

### 1. 疾病知识库扩展 ✅
- ✅ 创建独立的疾病知识库文件 `disease-knowledge.js`
- ✅ 从 5 种病扩展到 20+ 种狮头鹅常见病
- ✅ 按日龄分 5 个阶段（0-7、8-21、22-45、46-70、71+天）
- ✅ 每种病标注风险等级（★数量）
- ✅ 增加狮头鹅特异性说明
- ✅ 关键病变用 ⚠️ 标记

### 2. 系统化诊断流程 ✅
- ✅ 建立 6 步诊断流程（Chain-of-Thought）
  1. 日龄定位
  2. 主症分析
  3. 剖检对照
  4. 历史关联
  5. 鉴别诊断
  6. 置信度评估
- ✅ 每步都有明确的判断标准

### 3. 误诊陷阱提醒 ✅
- ✅ 增加 5 大常见误诊陷阱
- ✅ 每个陷阱给出错误示例和正确做法
- ✅ 特别强调狮头鹅品种特异性

### 4. 质量自检清单 ✅
- ✅ 增加 8 项诊断质量检查点
- ✅ 覆盖日龄、症状、剖检、鉴别、历史、置信度等维度

### 5. 提示词格式统一 ✅
- ✅ 病鹅诊断提示词优化
- ✅ 死因剖析提示词优化
- ✅ `getAutopsySystemPromptV2` 统一格式，保留历史学习功能
- ✅ 输出 JSON 结构完善（增加 followUp 等字段）

### 6. 批次上下文优化 ✅
- ✅ 批次快照：一行显示关键信息
- ✅ 高风险提示：自动提取高频病种和AI误判模式
- ✅ 简化描述：突出核心，去除冗余
- ✅ 修正对比：直观显示 AI 初判 vs 兽医确诊
- ✅ 关键学习点：从低评分反馈中自动总结
- ✅ 诊断指引：明确六步流程

---

## 📂 涉及文件

### 新建文件
1. ✅ `cloudfunctions/ai-diagnosis/disease-knowledge.js` - 疾病知识库
2. ✅ `AI_DIAGNOSIS_PROMPT_OPTIMIZATION.md` - 优化方案文档
3. ✅ `PROMPT_UPGRADE_CHECKLIST.md` - 本清单

### 修改文件
1. ✅ `cloudfunctions/ai-diagnosis/index.js`
   - 引入疾病知识库模块
   - 删除旧知识库函数
   - 统一死因剖析提示词格式
   - 优化批次上下文构建逻辑

---

## 🚀 部署步骤

### 第一步：验证文件完整性
```bash
cd "/Users/kaka/Documents/Sync/小程序/鹅数通"
ls -la cloudfunctions/ai-diagnosis/disease-knowledge.js
```

### 第二步：测试云函数
```bash
# 在微信开发者工具中右键 ai-diagnosis 文件夹
# 选择"云函数" -> "上传并部署：云端安装依赖"
```

### 第三步：验证诊断效果
1. 在小程序中进入 AI 诊断页面
2. 选择不同日龄批次（0-7、22-45、71+天）
3. 输入对应阶段的典型症状
4. 检查诊断结果是否：
   - ✓ 正确匹配日龄阶段
   - ✓ 给出鉴别诊断
   - ✓ 提供置信度
   - ✓ 包含治疗建议
   - ✓ 显示批次历史关联

### 第四步：监控诊断准确率
1. 记录前 10 次诊断的准确性
2. 收集兽医修正反馈
3. 对比优化前后的 AI 准确性评分

---

## 📊 预期效果对比

### 优化前
- 疾病覆盖：5 种常见病
- 日龄匹配准确率：~60%
- 鉴别诊断完整性：~40%
- 批次历史利用率：低
- 修正学习能力：弱

### 优化后（目标）
- 疾病覆盖：20+ 种狮头鹅病种
- 日龄匹配准确率：>90%
- 鉴别诊断完整性：>80%
- 批次历史利用率：高（自动关联）
- 修正学习能力：强（Few-Shot Learning）

---

## ⚠️ 注意事项

### 1. 知识库维护
- 定期（每季度）更新疾病知识库
- 根据修正反馈调整高风险病种
- 增加本地区特异性疾病

### 2. Prompt Token 长度
- 当前 Prompt 总长度约 8000-12000 tokens
- 批次历史数据会动态增长
- 建议定期清理超过 30 天的历史记录

### 3. 模型选择
- 推荐使用 `qwen-plus` 或更高版本
- 确保模型支持长上下文（>16K tokens）
- 监控 API 调用成本

### 4. 反馈闭环
- 确保修正记录正确保存到数据库
- 修正原因字段必填（用于学习）
- AI 准确性评分必填（用于筛选高质量案例）

---

## 🔄 持续改进计划

### 近期（1-2 周）
- [ ] 收集 50+ 次诊断数据
- [ ] 统计准确率提升百分比
- [ ] 识别仍存在的误判模式

### 中期（1 个月）
- [ ] 根据反馈调整提示词细节
- [ ] 增加季节性疾病提示
- [ ] 优化批次上下文算法（智能筛选关键信息）

### 长期（3 个月）
- [ ] 建立疾病知识图谱
- [ ] 实现多模态诊断（图片 OCR + 病变识别）
- [ ] 开发诊断质量自动评分系统

---

## 📞 技术支持

如遇问题，请检查：
1. `disease-knowledge.js` 文件是否正确上传到云函数
2. 云函数日志中是否有报错
3. 批次数据是否正确关联
4. 历史案例是否正确查询

**文档创建时间**：2025-10-26  
**最后更新**：2025-10-26  
**版本**：v1.0

