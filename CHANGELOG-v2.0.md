# 📝 更新日志

## v2.0 (2025-11-08)

### 🎯 核心更新：AI批量识别

#### 新增功能

1. **✨ AI批量数据识别**
   - 从单条识别升级到批量识别
   - 一次可识别图片中的所有日期数据（10天以上）
   - 自动提取每个日期的完整价格信息

2. **📊 批量数据预览**
   - 新增批量预览UI，以卡片形式展示所有识别到的记录
   - 显示识别总数量
   - 每条记录独立展示，包含日期、价格区间、平均价

3. **💾 批量数据保存**
   - 一键保存所有识别到的数据
   - 自动处理数据冲突（已存在则更新，不存在则新增）
   - 显示保存进度和结果统计

#### 优化改进

1. **🤖 AI Prompt 优化**
   - 修改系统提示词，要求AI提取所有日期的数据
   - 优化输出格式为批量结构：`{ records: [...] }`
   - 保持向后兼容，支持旧版单条数据格式

2. **🎨 UI/UX 优化**
   - 批量预览界面设计，清晰展示多条记录
   - 添加记录序号和日期高亮
   - 优化按钮文案："确认批量保存（N条）"

3. **⚡ 性能优化**
   - 实时显示保存进度（如"保存中...3/10"）
   - 优化数据解析逻辑，支持批量和单条两种格式
   - 保存完成后自动刷新历史记录

#### 技术改进

1. **类型定义**
   - 新增 `BatchPreviewData` 接口
   - 新增 `ParsedBatchGoosePriceResult` 接口
   - 增强类型安全

2. **函数新增**
   - `buildBatchPreviewData()`: 构建批量预览数据
   - `saveBatchData()`: 批量保存数据到数据库
   - 优化 `parseGoosePriceContent()`: 智能识别单条/批量格式

3. **样式新增**
   - `.batch-preview-section`: 批量预览容器
   - `.batch-records-list`: 记录列表
   - `.batch-record-item`: 单条记录卡片
   - 完整的批量预览样式系统

#### 修复问题

1. **🐛 修复只保存最新一天数据的问题**
   - 问题：AI识别图片中的多天数据，但只保存了最后一天
   - 原因：Prompt 要求只提取最新一行，数据结构只支持单条
   - 解决：重构为批量识别和保存架构

2. **🔄 优化数据清除逻辑**
   - `clearImage()` 现在也会清除批量预览数据
   - `cancelPreview()` 现在会清除所有相关数据

#### 向后兼容

- ✅ 完全兼容旧版单条识别功能
- ✅ AI返回单条数据时，自动切换到单条预览界面
- ✅ 数据库结构无需修改

---

## 使用场景示例

### 场景：首次导入10天历史数据

**之前（v1.0）**：
1. 上传截图
2. AI只识别最新一天（11月8日）
3. 保存
4. 如需其他日期，需要手动逐天录入 ❌

**现在（v2.0）**：
1. 上传截图
2. AI识别所有10天的数据（10月30日 ~ 11月8日）
3. 预览显示："共 10 条记录"
4. 点击"确认批量保存（10条）"
5. ✅ 一次性保存所有数据！

---

## 影响范围

### 修改的文件

**前端**：
- `miniprogram/packageUser/price-management/price-management.ts`
  - 新增批量数据处理逻辑
  - 优化AI识别和数据解析
  - 新增批量保存函数

- `miniprogram/packageUser/price-management/price-management.wxml`
  - 新增批量预览UI

- `miniprogram/packageUser/price-management/price-management.scss`
  - 新增批量预览样式

**文档**：
- `AI批量识别功能说明-v2.0.md`（新增）
- `CHANGELOG-v2.0.md`（新增）

### 未修改的文件

- 云函数：`ai-multi-model`（无需修改）
- 数据库：`goose_prices` 集合（结构不变）
- 其他页面：不受影响

---

## 测试建议

### 1. 基础功能测试
- [ ] 上传包含多天数据的截图
- [ ] 验证AI识别结果是否包含所有日期
- [ ] 检查批量预览界面显示是否正确
- [ ] 确认批量保存是否成功

### 2. 边界情况测试
- [ ] 上传单天数据截图（兼容性测试）
- [ ] 上传无法识别的图片（错误处理）
- [ ] 保存已存在的日期数据（去重测试）
- [ ] 取消预览操作（数据清除测试）

### 3. 数据验证
- [ ] 检查数据库中的记录数量
- [ ] 验证每条记录的数据完整性
- [ ] 查看趋势图是否正确显示
- [ ] 确认历史记录列表更新

---

## 已知问题

无

---

## 后续计划

### v2.1 计划
- [ ] 并发保存优化（提升批量保存速度）
- [ ] 数据校验增强（价格合理性检查）
- [ ] 支持增量识别（只识别新日期）
- [ ] 历史数据导出功能

### v3.0 计划
- [ ] AI价格预测功能（基于历史数据）
- [ ] 价格趋势智能分析
- [ ] 异常价格波动预警

---

## 贡献者

- AI Assistant (Claude Sonnet 4.5)
- User: kaka

---

**更新日期**：2025-11-08
**版本**：v2.0
**状态**：✅ 已完成

