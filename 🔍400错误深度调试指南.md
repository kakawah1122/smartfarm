# 🔍 400错误深度调试指南

## 📋 部署步骤

### 1. 上传云函数
```
微信开发者工具
→ 右键 cloudfunctions/ai-multi-model
→ 上传并部署：云端安装依赖（不上传node_modules）
→ **确保看到"部署成功"提示**
→ 等待1-2分钟
```

### 2. 测试AI诊断
1. 打开小程序AI诊断页面
2. **清除之前上传的图片**
3. **重新上传3张新图片**
4. 填写症状描述
5. 点击"开始AI智能诊断"

### 3. 查看关键日志

打开云开发控制台 → 云函数 → ai-multi-model → 日志

---

## 🔍 关键日志检查点

部署后，在日志中搜索以下关键字：

### ✅ 检查点1: 图片URL格式

搜索：**"消息1 内容1 图片URL"**

**正确的日志应该是**:
```json
{
  "前100字符": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD...",
  "总长度": 123456,
  "是否双重前缀": "✅ 否"
}
```

**如果看到这个就是BUG**:
```json
{
  "前100字符": "data:image/jpeg;base64,data:image/jpeg;base64,/9j...",
  "总长度": 123456,
  "是否双重前缀": "❌ 是！"
}
```

### ✅ 检查点2: 智谱AI详细错误

搜索：**"====== HTTP 400 详细分析 ======"**

应该看到：
```
====== HTTP 400 详细分析 ======
1. 智谱AI返回的错误: { "error": { "code": "xxx", "message": "具体错误信息" } }
2. 请求的模型: glm-4v
3. 请求的消息数量: 2
4. 是否包含图片: true
5. 第一张图片URL前100字符: data:image/jpeg;base64,/9j/...
6. 图片URL长度: 123456
```

**重点关注第1条**: 智谱AI返回的具体错误信息！

### ✅ 检查点3: 图片处理日志

搜索：**"第1张图片处理成功"**

应该看到：
```
第1张图片处理成功, URL前缀: data:image/jpeg;base64,/9j/...
第2张图片处理成功, URL前缀: data:image/jpeg;base64,/9j/...
第3张图片处理成功, URL前缀: data:image/jpeg;base64,/9j/...
```

---

## 🐛 可能的问题和解决方案

### 问题1: 仍然是双重前缀

**症状**: 日志显示 `"是否双重前缀": "❌ 是！"`

**原因**: 云函数没有更新成功

**解决**:
1. 删除云函数重新上传
2. 确认微信开发者工具版本最新
3. 检查本地代码是否已保存

### 问题2: 智谱AI返回特定错误

**可能的错误信息**:

#### 错误A: "invalid image format"
```json
{
  "error": {
    "message": "invalid image format"
  }
}
```
**原因**: 图片格式问题
**解决**: 检查图片是否是JPG/PNG格式

#### 错误B: "image too large"
```json
{
  "error": {
    "message": "image too large"
  }
}
```
**原因**: 图片太大
**解决**: 压缩图片后重新上传

#### 错误C: "invalid model"
```json
{
  "error": {
    "message": "model not found"
  }
}
```
**原因**: 模型名称错误
**解决**: 确认使用 `glm-4v` 而不是 `glm-4-flash`

#### 错误D: "invalid api key"
```json
{
  "error": {
    "message": "invalid api key"
  }
}
```
**原因**: API Key无效
**解决**: 检查环境变量中的 GLM4_API_KEY

### 问题3: 请求体太大

**症状**: 错误信息提到 "payload too large" 或 "request entity too large"

**原因**: 3张图片的总大小超过API限制（通常是10MB）

**解决方案A - 前端压缩**:

修改 `miniprogram/pages/ai-diagnosis/ai-diagnosis.ts` 的 `onChooseImage` 方法：

```typescript
async onChooseImage() {
  try {
    const res = await wx.chooseMedia({
      count: 4,
      mediaType: ['image'],
      sourceType: ['album', 'camera'],
      sizeType: ['compressed'],  // ✅ 添加这个：使用压缩图片
      maxDuration: 30
    })

    if (res.tempFiles && res.tempFiles.length > 0) {
      const uploadPromises = res.tempFiles.map(async (file) => {
        // 如果图片太大，先压缩
        let tempFilePath = file.tempFilePath
        
        // 检查文件大小
        const fileSize = file.size
        if (fileSize > 1024 * 1024) {  // 大于1MB
          // 压缩图片
          const compressRes = await wx.compressImage({
            src: file.tempFilePath,
            quality: 80  // 压缩质量
          })
          tempFilePath = compressRes.tempFilePath
        }

        // 上传到云存储
        const cloudPath = `ai-diagnosis/${Date.now()}_${Math.floor(Math.random() * 10000)}.jpg`
        const uploadRes = await wx.cloud.uploadFile({
          cloudPath,
          filePath: tempFilePath
        })
        
        return uploadRes.fileID
      })

      const fileIDs = await Promise.all(uploadPromises)
      
      this.setData({
        images: [...this.data.images, ...fileIDs].slice(0, 4)
      })

      wx.showToast({
        title: `已上传${fileIDs.length}张图片`,
        icon: 'success'
      })
    }
  } catch (error: any) {
    wx.showToast({
      title: error.message || '选择图片失败',
      icon: 'error'
    })
  }
}
```

**解决方案B - 减少图片数量**:
暂时只上传1-2张最重要的症状图片进行测试

---

## 📞 如何报告问题

如果测试后仍有问题，请提供以下信息：

### 必需信息:

1. **检查点1的截图/日志**
   - 图片URL前100字符
   - 是否双重前缀

2. **检查点2的完整日志**
   - 智谱AI返回的详细错误
   - 特别是 `error.response.data` 的内容

3. **检查点3的日志**
   - 图片处理是否成功
   - URL前缀格式

4. **图片信息**
   - 图片数量
   - 每张图片大小
   - 图片格式(JPG/PNG)

### 可选信息:

- 云函数完整日志（可导出）
- 前端控制台日志
- 诊断任务ID

---

## ✅ 成功的标志

如果修复成功，你会看到：

1. ✅ 日志显示：`"是否双重前缀": "✅ 否"`
2. ✅ 日志显示：`智谱AI调用成功!`
3. ✅ 日志显示：`返回内容长度: xxxx`
4. ✅ 前端显示诊断结果，包含图片分析内容
5. ✅ 没有400或429错误

---

## 🎯 快速检查清单

部署后立即检查：

- [ ] 云函数部署成功（看到"部署成功"提示）
- [ ] 等待1-2分钟（云函数需要时间生效）
- [ ] 重新上传新图片（不要用之前的缓存图片）
- [ ] 查看日志中的"是否双重前缀"
- [ ] 查看智谱AI返回的详细错误
- [ ] 截图所有关键日志

---

**现在重新部署并按照这个指南逐步检查！** 🚀

