# 财务记录业务逻辑说明 - 最终版

## 核心业务逻辑

### 采购 vs 使用

所有物料（饲料、药品等）都遵循"采购-库存-使用"的流程：

```
采购阶段：买入物料 → 现金流出 → 库存增加
   ↓
库存阶段：物料在库房 → 待使用
   ↓
使用阶段：实际消耗 → 成本确认 → 库存减少
```

## 三个不同的视角

### 1. 财务记录列表（业务视角）

**目的**：查看日常业务活动和实际消耗

**显示内容**：
- ✅ **入栏采购**（买鹅苗）：买了100只鹅苗，花了60000元
- ✅ **饲料投喂**（实际使用）：今天喂了200kg饲料，成本2000元
- ✅ **治疗用药**（实际使用）：治疗用了2瓶浆膜清，成本240元
- ✅ **成鹅销售**（卖鹅）：卖了100羽成鹅，收入27000元
- ✅ **报销记录**：差旅费、招待费等
- ❌ ~~饲料采购~~（不显示）
- ❌ ~~药品采购~~（不显示）

**实现函数**：`getAllFinanceRecords`

**逻辑**：
```javascript
// ✅ 显示：入栏、出栏、饲料投喂、治疗用药、报销
// ❌ 不显示：物料采购（饲料、药品等）
```

### 2. 成本汇总（现金流视角）

**目的**：统计实际现金支出和收入

**计算逻辑**：
```
总收入 = 销售收入 + 其他收入
总支出 = 鹅苗采购 + 饲料采购 + 药品采购 + 其他物料采购 + 报销
净利润 = 总收入 - 总支出
```

**重点**：
- ✅ **饲料采购**计入总支出：买了1吨饲料，花了10000元 → 现金流出10000元
- ✅ **药品采购**计入总支出：买了10瓶浆膜清，花了1200元 → 现金流出1200元
- ✅ **不管用没用完，钱已经花了**

**实现函数**：`getCostSumByDateRange`

**代码**：
```javascript
// 统计所有采购记录
let purchaseQuery = db.collection(COLLECTIONS.PROD_MATERIAL_RECORDS)
  .where({
    isDeleted: _.neq(true),
    type: 'purchase'  // 所有采购（包括饲料、药品、其他）
  })
```

### 3. 成本分解（成本核算视角）

**目的**：分析各项成本占比和结构

**计算逻辑**：
```
饲料成本 = 饲料投喂总成本（实际使用）
医疗费用 = 治疗用药总成本（实际使用）
鹅苗成本 = 入栏采购总成本
其他费用 = 报销 + 其他支出
```

**重点**：
- ❌ **饲料采购**不计入饲料成本（会重复）
- ❌ **药品采购**不计入医疗费用（会重复）
- ✅ **只统计实际消耗**

**实现函数**：`getCostBreakdownByDateRange`

**代码**：
```javascript
// 饲料成本：从投喂记录统计
let feedQuery = db.collection(COLLECTIONS.PROD_FEED_USAGE_RECORDS)
  .where({ isDeleted: _.neq(true) })

// 医疗费用：从治疗领用记录统计
let treatmentUseQuery = db.collection(COLLECTIONS.PROD_MATERIAL_RECORDS)
  .where({
    isDeleted: _.neq(true),
    type: 'use',
    relatedModule: 'health_treatment'
  })

// 药品采购不计入医疗费用（避免重复）
if (category === '药品' || category === 'medicine' || category === '营养品') {
  // breakdown.medicalCost += amount  // 已注释，避免重复计算
}
```

## 完整示例

### 场景：一批药品的生命周期

#### 2025-11-01：采购药品
- **操作**：买了10瓶浆膜清，每瓶120元，总计1200元
- **记录**：
  - `PROD_MATERIAL_RECORDS`：`{ type: 'purchase', quantity: 10, totalAmount: 1200 }`
  - `PROD_MATERIALS`：`{ currentStock: 10 }` （库存增加）

#### 2025-11-05：第一次使用
- **操作**：治疗时用了2瓶
- **记录**：
  - `PROD_MATERIAL_RECORDS`：`{ type: 'use', relatedModule: 'health_treatment', quantity: 2, totalAmount: 240 }`
  - `PROD_MATERIALS`：`{ currentStock: 8 }` （库存减少）

#### 2025-11-10：第二次使用
- **操作**：又治疗用了3瓶
- **记录**：
  - `PROD_MATERIAL_RECORDS`：`{ type: 'use', relatedModule: 'health_treatment', quantity: 3, totalAmount: 360 }`
  - `PROD_MATERIALS`：`{ currentStock: 5 }` （库存减少）

### 各个视角的统计结果

#### 1. 财务记录列表（2025-11-01 ~ 2025-11-10）
```
2025-11-05  治疗用药 - 浆膜清 - 2瓶   -¥240
2025-11-10  治疗用药 - 浆膜清 - 3瓶   -¥360
```
❌ **不显示**：药品采购 -¥1200

#### 2. 成本汇总（2025-11-01 ~ 2025-11-10）
```
总支出：¥1200
  - 物料采购：¥1200（药品采购）
```
✅ **统计现金流**：1200元已经花出去了

#### 3. 成本分解（2025-11-01 ~ 2025-11-10）
```
医疗费用：¥600
  - 治疗用药（11-05）：¥240
  - 治疗用药（11-10）：¥360
```
✅ **统计实际消耗**：只计入使用的5瓶（600元），剩余5瓶还在库存

## 关键数据库字段

### PROD_MATERIAL_RECORDS（物料记录）

#### 采购记录
```javascript
{
  type: 'purchase',
  materialId: '...',
  quantity: 10,
  unitPrice: 120,
  totalAmount: 1200,
  supplier: '供应商',
  recordDate: '2025-11-01',
  relatedBatch: 'QY-20251017'  // 可选
}
```

#### 使用记录
```javascript
{
  type: 'use',
  relatedModule: 'health_treatment',  // 关键字段
  relatedId: '治疗记录ID',
  materialId: '...',
  quantity: 2,
  unitPrice: 120,
  totalAmount: 240,
  recordDate: '2025-11-05',
  relatedBatch: 'QY-20251017'  // 可选
}
```

### PROD_MATERIALS（物料信息）
```javascript
{
  name: '浆膜清',
  category: '药品',  // 关键字段：'饲料'、'药品'、'营养品'、'其他'
  currentStock: 5,
  unitPrice: 120,
  ...
}
```

## 代码实现位置

### 1. 财务记录列表
**文件**：`cloudfunctions/finance-management/index.js`
**函数**：`getAllFinanceRecords` （第850行）
**关键修改**：删除了物料采购记录查询（第1054-1060行）

```javascript
// 6. 物料采购记录不在业务财务记录中显示
// 说明：物料采购（饲料、药品等）只记录现金流，不记录业务成本
// 业务成本通过实际消耗记录体现：
// - 饲料：通过饲料投喂记录（feed usage records）
// - 药品：通过治疗领用记录（treatment use records）
// 采购记录仍会在成本汇总统计（getCostSumByDateRange）中计入总支出
```

### 2. 成本汇总
**文件**：`cloudfunctions/finance-management/reimbursement-handler.js`
**函数**：`getCostSumByDateRange` （第639行）
**关键代码**：第721-743行

```javascript
// 4. 从采购记录汇总物料采购成本
let purchaseQuery = db.collection(COLLECTIONS.PROD_MATERIAL_RECORDS)
  .where({
    isDeleted: _.neq(true),
    type: 'purchase'  // 所有采购
  })
```

### 3. 成本分解
**文件**：`cloudfunctions/finance-management/reimbursement-handler.js`
**函数**：`getCostBreakdownByDateRange` （第751行）
**关键代码**：第845-895行

```javascript
// 注意：药品采购不计入成本分解统计，因为会在使用时（治疗领用）计入成本，避免重复计算
for (const record of purchaseResult.data) {
  // ...
  if (category === '药品' || category === 'medicine' || category === '营养品') {
    // 药品采购不计入成本分解统计，避免与治疗用药重复计算
    // breakdown.medicalCost += amount  // 已注释，避免重复计算
  }
  // ...
}
```

## 总结

| 视角 | 显示采购？ | 显示使用？ | 目的 |
|------|----------|----------|------|
| **财务记录列表** | ❌ | ✅ | 查看业务活动 |
| **成本汇总** | ✅ | ✅ | 统计现金流 |
| **成本分解** | ❌ | ✅ | 分析成本结构 |

**核心原则**：
1. **采购 = 现金流**（钱什么时候出去的）
2. **使用 = 成本确认**（什么时候产生的成本）
3. **财务记录列表**：只看业务消耗（用户日常关注）
4. **成本汇总**：统计所有现金流（财务分析）
5. **成本分解**：只算实际消耗（避免重复）

这样设计的好处：
- ✅ 财务记录列表简洁明了，只显示实际业务
- ✅ 成本汇总准确反映现金流
- ✅ 成本分解准确反映成本结构
- ✅ 不会重复计算成本
- ✅ 符合实际业务流程

