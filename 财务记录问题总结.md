# 财务记录问题总结与修复

## 问题1：wx:key 重复警告

### 问题描述
```
Do not set same key "cc84495d690b5ec4024f8dee5c6e8a51" in wx:key.
```

### 原因
财务记录来自多个数据源，不同类型的记录可能使用相同的 `_id`，导致前端列表渲染时出现 wx:key 重复。

### 修复方案
为不同来源的财务记录添加唯一前缀：

| 记录类型 | id前缀 | 示例 |
|---------|-------|------|
| 财务收入记录 | 无 | `record._id` |
| 财务成本记录 | 无 | `record._id` |
| 出栏记录（销售） | `exit_` | `exit_${record._id}` |
| 入栏记录（采购） | `entry_` | `entry_${record._id}` |
| 投喂记录（饲料） | `feed_` | `feed_${record._id}` |
| 物料采购记录 | `purchase_` | `purchase_${record._id}` |
| 治疗领用记录 | `treatment_` | `treatment_${record._id}` |

### 修复文件
- `cloudfunctions/finance-management/index.js` - `getAllFinanceRecords` 函数

## 问题2：为什么显示两条记录（药品采购和治疗用药）

### 用户疑问
"还是记录了两条一样的数据"

### 解释
这是正常的设计逻辑：

1. **药品采购记录**（`其他费用` 或 `药品采购`）：
   - 来源：`PROD_MATERIAL_RECORDS`（type='purchase'）
   - 用途：追踪资金支出（现金流）
   - 时间：采购时记录
   - 金额：采购总金额

2. **治疗用药记录**（`治疗用药`）：
   - 来源：`PROD_MATERIAL_RECORDS`（type='use', relatedModule='health_treatment'）
   - 用途：追踪实际使用成本
   - 时间：治疗时记录
   - 金额：使用数量 × 单价

### 为什么金额一样
如果两条记录金额一样（都是¥240），说明：
- 采购了2件药品，单价120元，总金额240元
- 治疗时使用了2件药品，单价120元，总金额240元

这是因为采购后立即全部使用的情况。

### 成本核算
虽然财务记录中两者都显示，但在**成本分解统计**中：
- 只统计治疗用药成本（实际使用）
- 不统计药品采购成本（避免重复计算）

### 建议
如果用户希望简化显示，可以：
1. 前端添加过滤选项，只显示使用记录
2. 或者只显示采购记录
3. 但不建议同时隐藏两者，会丢失资金流追踪信息

## 问题3：成鹅销售收入计算不对

### 问题描述
用户反馈成鹅销售收入计算结果不正确。

### 原因分析
后端计算逻辑已修复（优先使用前端传递的 `totalRevenue`），但可能存在以下情况：

1. **前端未正确传递 `totalRevenue`**：
   - 检查 `exit-form.ts` 中的 `onSubmit` 函数
   - 确认 `totalRevenue: this.data.totalRevenue` 是否正确传递

2. **历史数据问题**：
   - 旧的出栏记录可能使用错误的计算方式
   - 需要手动修复或重新创建

3. **单价单位混淆**：
   - 单价应该是"元/斤"
   - 总收入 = 总重量（斤）× 单价（元/斤）
   - 而不是：数量（羽）× 单价（元/斤）

### 正确的计算方式
```
总收入 = 总重量 × 单价
例如：100羽 × 9斤/羽 = 900斤
     900斤 × 2元/斤 = 1800元
```

### 修复验证
1. 创建新的出栏记录，检查金额是否正确
2. 检查前端提交数据中是否包含 `totalRevenue` 字段
3. 检查后端是否正确使用 `totalRevenue`

### 调试方法
在 `production-exit/index.js` 的 `createExitRecord` 函数中添加日志：
```javascript
console.log('recordData.totalRevenue:', recordData.totalRevenue)
console.log('recordData.totalWeight:', recordData.totalWeight)
console.log('recordData.unitPrice:', recordData.unitPrice)
console.log('calculated totalRevenue:', totalRevenue)
```

## 修复文件列表

1. `cloudfunctions/finance-management/index.js`
   - 修复了 wx:key 重复问题（添加id前缀）
   - 修复了 `[object Object]` 显示问题

2. `cloudfunctions/production-exit/index.js`
   - 修复了成鹅销售收入计算逻辑
   - 优先使用前端传递的 `totalRevenue`
   - 添加了 `totalWeight` 字段保存

## 验证清单

- [ ] wx:key 重复警告是否消失
- [ ] 药品采购和治疗用药是否正确显示
- [ ] 成鹅销售收入是否正确计算
- [ ] 成本分解统计是否只统计使用成本
- [ ] 前端是否正确传递 `totalRevenue` 字段

## 注意事项

1. **历史数据**：旧的出栏记录可能需要手动修复
2. **前端传值**：确认前端 `totalRevenue` 正确传递
3. **单位统一**：确保单价单位为"元/斤"，总重量单位为"斤"

