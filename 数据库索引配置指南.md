# 📊 数据库索引配置指南

## 🎯 问题说明

系统检测到以下查询缺乏索引支持，可能影响性能：

```javascript
db.collection('goose_prices').where({
  date: _.gte('2025-10-09')
})
.orderBy('date', 'asc')
.get()
```

**使用场景**：
- 鹅价详情页加载历史数据（查询最近30天）
- 鹅价管理页加载历史记录（查询最近90天）
- 趋势图数据加载

**性能影响**：
- ⚠️ 无索引：全表扫描，数据量大时查询变慢
- ✅ 有索引：快速定位，查询速度显著提升

---

## 🔧 索引配置方案

### 推荐索引

**集合**：`goose_prices`

**索引字段**：
- `date`：升序索引

**索引类型**：单字段索引

**索引名称**：`date_1`（建议）

---

## 📝 创建索引步骤

### 方法1：使用云开发控制台（推荐）

#### 步骤 1：进入数据库管理
1. 打开微信开发者工具
2. 点击顶部菜单：**云开发**
3. 进入：**数据库** 管理

#### 步骤 2：选择集合
1. 在左侧集合列表中，找到 `goose_prices`
2. 点击进入该集合

#### 步骤 3：创建索引
1. 点击顶部的 **索引管理** 标签
2. 点击 **添加索引** 按钮
3. 配置索引：
   ```
   索引名称：date_1
   
   索引字段配置：
   ┌──────────────────────────────┐
   │ 字段名    │ 类型  │ 排序方式 │
   ├──────────────────────────────┤
   │ date     │ 字符串 │ 升序(1)  │
   └──────────────────────────────┘
   
   索引属性：
   - [ ] 唯一索引
   - [ ] 稀疏索引
   ```
4. 点击 **确定** 创建

#### 步骤 4：验证索引
1. 在索引列表中查看新创建的索引
2. 状态应显示为：**正常**

---

### 方法2：使用数据库导入工具

#### 创建索引配置文件

**文件名**：`goose_prices.indexes.json`

**内容**：
```json
{
  "indexes": [
    {
      "name": "date_1",
      "keys": {
        "date": 1
      },
      "options": {
        "background": true
      }
    }
  ]
}
```

**说明**：
- `name`: 索引名称
- `keys`: 索引字段，`1` 表示升序，`-1` 表示降序
- `background`: 后台创建，不阻塞其他操作

#### 应用索引
1. 进入云开发控制台 → 数据库
2. 选择 `goose_prices` 集合
3. 点击 **导入** → **导入索引**
4. 上传 `goose_prices.indexes.json` 文件
5. 确认创建

---

## 📈 性能对比

### 测试场景：查询最近30天的数据

**数据量**：100条记录

#### 无索引
```
查询时间：50-100ms
扫描记录数：100条（全表扫描）
返回记录数：30条
```

#### 有索引
```
查询时间：5-10ms
扫描记录数：30条（精确定位）
返回记录数：30条
```

**性能提升**：10倍以上 ⚡

---

## 🔍 查询优化建议

### 1. 利用索引的查询模式（推荐）

✅ **正确示例1**：范围查询 + 升序排序
```javascript
db.collection('goose_prices')
  .where({
    date: db.command.gte('2025-10-09')  // 使用索引
  })
  .orderBy('date', 'asc')  // 使用索引
  .get()
```

✅ **正确示例2**：精确查询
```javascript
db.collection('goose_prices')
  .where({
    date: '2025-11-08'  // 使用索引
  })
  .get()
```

✅ **正确示例3**：范围查询 + 限制条数
```javascript
db.collection('goose_prices')
  .where({
    date: db.command.gte('2025-10-09')
  })
  .orderBy('date', 'asc')
  .limit(30)  // 限制返回条数
  .get()
```

### 2. 避免不使用索引的查询模式

❌ **错误示例1**：降序排序（索引是升序）
```javascript
// 不推荐：排序方向与索引不一致
db.collection('goose_prices')
  .where({
    date: db.command.gte('2025-10-09')
  })
  .orderBy('date', 'desc')  // 无法充分利用索引
  .get()
```

**解决方案**：如果需要降序，可以创建降序索引或在前端反转数组。

❌ **错误示例2**：复杂查询
```javascript
// 不推荐：只按 date 索引，source 不在索引中
db.collection('goose_prices')
  .where({
    date: db.command.gte('2025-10-09'),
    source: 'ai_recognition'
  })
  .orderBy('date', 'asc')
  .get()
```

**解决方案**：如果经常使用此查询，创建组合索引 `{date: 1, source: 1}`。

---

## 🎯 索引策略

### 当前索引方案

**单字段索引**：`date`（升序）

**优点**：
- ✅ 支持按日期范围查询
- ✅ 支持按日期升序排序
- ✅ 占用空间小
- ✅ 维护成本低

**适用查询**：
- 查询最近N天的数据
- 按日期排序
- 精确匹配某个日期

### 未来可能需要的索引

根据实际使用情况，可能需要创建以下索引：

#### 1. 组合索引：date + source
```json
{
  "name": "date_source_1",
  "keys": {
    "date": 1,
    "source": 1
  }
}
```

**使用场景**：
- 查询特定来源（AI识别/手动录入）的最近数据
- 示例：`where({ date: gte(...), source: 'ai_recognition' })`

#### 2. 组合索引：date + updateTime
```json
{
  "name": "date_updateTime_1",
  "keys": {
    "date": 1,
    "updateTime": -1
  }
}
```

**使用场景**：
- 查询最近更新的数据
- 按日期和更新时间排序

---

## ✅ 验证索引是否生效

### 方法1：查看查询性能

**在小程序中添加性能日志**：
```javascript
const startTime = Date.now()

const result = await db.collection('goose_prices')
  .where({
    date: db.command.gte('2025-10-09')
  })
  .orderBy('date', 'asc')
  .get()

const endTime = Date.now()
console.log(`查询耗时: ${endTime - startTime}ms`)
console.log(`扫描记录数: ${result.data.length}`)
```

**预期结果**：
- 创建索引前：50-100ms
- 创建索引后：5-10ms

### 方法2：使用云开发控制台

1. 进入：云开发 → 数据库 → goose_prices
2. 点击：索引管理
3. 查看索引列表，确认 `date_1` 状态为 **正常**
4. 查看索引统计信息（如果有）

---

## 🚨 注意事项

### 1. 索引占用空间
- 每个索引会占用额外的存储空间
- 估计：每1000条记录约占用 10-20KB
- 对于 `goose_prices` 集合（预计几百到几千条记录），影响很小

### 2. 写入性能
- 索引会略微降低写入速度（需要同时更新索引）
- 对于 `goose_prices`（每天只写入少量数据），影响可忽略

### 3. 索引维护
- 索引会自动维护，无需手动更新
- 如果大批量删除数据，可以考虑重建索引

### 4. 索引数量限制
- 微信云开发：每个集合最多 64 个索引
- 目前只需要 1-2 个索引，完全足够

---

## 📊 推荐执行顺序

### 立即执行（优先级：高）

1. ✅ **创建 `date` 索引**
   - 集合：`goose_prices`
   - 字段：`date`（升序）
   - 原因：已有查询需要，立即优化

### 按需执行（优先级：中）

2. 📊 **监控查询性能**
   - 观察查询耗时
   - 收集慢查询日志

3. 🔍 **分析查询模式**
   - 如果经常按 `source` 筛选，创建组合索引
   - 如果数据量超过1000条，评估是否需要更多索引

---

## 🎉 预期效果

创建索引后：

1. **查询速度提升**
   - 鹅价详情页加载更快
   - 趋势图渲染更流畅

2. **用户体验优化**
   - 页面响应更及时
   - 批量操作更高效

3. **系统可扩展性**
   - 支持更多历史数据
   - 为AI预测功能打好基础

---

## 📚 参考资料

- [微信云开发数据库索引文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/index.html)
- [MongoDB索引最佳实践](https://docs.mongodb.com/manual/indexes/)

---

**创建日期**：2025-11-08  
**更新日期**：2025-11-08  
**状态**：待执行

---

**需要帮助？** 如有疑问，请参考此文档或查看云开发官方文档。

