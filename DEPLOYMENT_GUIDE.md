# 健康模块优化部署指南

> **部署日期**：2025-11-01  
> **涉及模块**：健康管理、任务管理、物料管理、AI诊断  
> **预计部署时间**：15-20分钟

---

## 🎯 部署前准备

### 1. 确认代码改动已保存

- [x] 云函数package.json已更新（运行时Nodejs16.13）
- [x] health.ts已优化（删除重复方法，使用utils）
- [x] 云函数调试代码已清理
- [x] WXML模板已修复

### 2. 备份当前环境

**建议**：在云开发控制台创建环境快照
- 进入云开发控制台
- 选择环境 `cloud1-3gdruqkn67e1cbe2`
- 导出当前配置（可选）

---

## 📦 步骤1：部署云函数（15分钟）

### 必须部署的云函数（4个）

打开微信开发者工具 → 云开发 → 云函数，依次部署：

#### 1.1 health-management ⭐⭐⭐（最重要）

```
右键 health-management → 上传并部署：云端安装依赖
```

**改动内容**：
- 运行时：Nodejs8.9 → Nodejs16.13
- 删除123条console语句
- 优化getPreventionDashboard返回完整任务字段

**验证**：查看云函数日志，确认运行环境为Nodejs16.13

---

#### 1.2 breeding-todo ⭐⭐

```
右键 breeding-todo → 上传并部署：云端安装依赖
```

**改动内容**：
- 运行时：Nodejs8.9 → Nodejs16.13
- 删除3条console语句

---

#### 1.3 production-material ⭐

```
右键 production-material → 上传并部署：云端安装依赖
```

**改动内容**：
- 运行时：Nodejs8.9 → Nodejs16.13
- 清理console语句

---

#### 1.4 ai-diagnosis ⭐

```
右键 ai-diagnosis → 上传并部署：云端安装依赖
```

**改动内容**：
- 运行时：Nodejs8.9 → Nodejs16.13
- 清理console语句

---

### 1.5 等待部署完成

- 每个云函数需要1-3分钟
- 等待所有云函数状态变为"部署成功"
- 检查版本号是否更新

---

## 🗄️ 步骤2：配置数据库索引（5分钟）

登录云开发控制台：https://console.cloud.tencent.com/tcb

### 2.1 进入数据库

1. 选择环境：`cloud1-3gdruqkn67e1cbe2`
2. 点击"数据库"模块
3. 找到集合：`task_batch_schedules`

### 2.2 添加索引1

点击"索引"标签 → "添加索引"：

```
索引名称：batchId_1_completed_1_completedAt_-1_userId_1
索引属性：非唯一
索引字段：
  1. batchId - 升序
  2. completed - 升序
  3. completedAt - 降序
  4. userId - 升序
```

### 2.3 添加索引2

```
索引名称：batchId_1_dayAge_1_userId_1
索引属性：非唯一
索引字段：
  1. batchId - 升序
  2. dayAge - 升序
  3. userId - 升序
```

### 2.4 添加索引3

```
索引名称：batchId_1_completed_1_userId_1
索引属性：非唯一
索引字段：
  1. batchId - 升序
  2. completed - 升序
  3. userId - 升序
```

---

## ✅ 步骤3：功能验证（5-10分钟）

### 3.1 基础功能验证

1. **进入健康管理页面**
   - 点击底部Tab"健康"
   - 确认页面正常加载，无报错

2. **测试预防管理Tab**
   - 点击"预防管理"Tab
   - 确认无`SyntaxError: Unexpected token 'const'`错误
   - 确认统计数据正常显示

3. **测试子标签切换**
   - 切换"进行中" - 显示今日任务
   - 切换"即将到来" - 显示未来任务
   - 切换"已完成" - 显示历史记录
   - 切换"统计" - 显示统计数据

### 3.2 任务操作验证

1. **查看任务详情**
   - 点击任务卡片
   - 确认弹窗正常显示
   - 确认任务信息完整

2. **完成普通任务**
   - 点击"完成任务"
   - 确认任务状态更新
   - 确认列表自动刷新

3. **疫苗任务**
   - 点击疫苗任务
   - 填写接种信息
   - 提交成功
   - 确认记录已创建

4. **用药任务**
   - 点击用药任务
   - 选择药品
   - 填写数量
   - 确认库存扣减

### 3.3 性能验证

**打开微信开发者工具Console**：

1. 清空控制台
2. 重新进入健康页面
3. 检查：
   - ✅ 无console调试日志
   - ✅ 无SyntaxError
   - ✅ 无多重查询警告
   - ✅ 页面加载时间<1秒

---

## 🐛 常见问题

### Q1: 仍然报SyntaxError错误

**原因**：云函数未正确部署或运行时未生效

**解决**：
1. 删除云端云函数
2. 重新上传并选择"云端安装依赖"
3. 在控制台检查运行环境是否为Nodejs16.13

### Q2: 任务列表为空

**原因**：缺少task_batch_schedules数据或批次无任务

**解决**：
1. 检查是否有活跃批次
2. 调用breeding-todo.fixBatchTasks创建任务
3. 确认批次日龄是否有对应任务

### Q3: 统计数据为0

**原因**：缺少预防记录或索引未生效

**解决**：
1. 确认health_prevention_records集合有数据
2. 检查索引是否已创建
3. 等待索引生效（约1-2分钟）

### Q4: 页面加载慢

**原因**：索引未配置或数据量过大

**解决**：
1. 添加推荐的数据库索引
2. 检查查询是否使用索引字段
3. 考虑添加分页加载

---

## 📊 监控指标

部署后持续监控以下指标：

### 性能指标
- [ ] 页面加载时间 <1秒
- [ ] 云函数响应时间 <500ms
- [ ] setData调用次数 <5次/页面

### 稳定性指标
- [ ] 无SyntaxError错误
- [ ] 无云函数调用失败
- [ ] 无数据不一致问题

### 用户体验指标
- [ ] 任务完成操作流畅
- [ ] 数据即时刷新
- [ ] 表单提交成功率>95%

---

## 📞 支持

如遇到问题，请检查：

1. **云函数日志**：云开发控制台 → 云函数 → 日志
2. **数据库查询**：检查索引是否命中
3. **前端Console**：查看错误堆栈信息
4. **文档参考**：`DATABASE_INDEX_GUIDE.md`

---

*祝部署顺利！*

