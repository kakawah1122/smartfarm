# 诊断历史修正记录不显示排查脚本

## 立即检查步骤

### 步骤 1：检查数据库中的 diagnosisId 字段

打开云开发控制台 → 数据库 → `health_records` 集合

查找你修正过的异常记录，检查：

```javascript
// 查询示例
{
  batchNumber: "你的批次号",
  status: "abnormal",
  isCorrected: true  // 已修正的记录
}

// 检查记录是否有这个字段：
{
  diagnosisId: "AD2410301234"  // ← 关键：这个字段是否存在？
}
```

**如果没有 `diagnosisId` 字段，这就是问题所在！**

### 步骤 2：检查 AI 诊断记录

打开云开发控制台 → 数据库 → `health_ai_diagnosis` 集合

查找对应的诊断记录：

```javascript
// 使用上面的 diagnosisId 查询
{
  _id: "AD2410301234"
}

// 检查是否有修正信息：
{
  isCorrected: true,
  correctedDiagnosis: "浆膜炎",
  veterinarianDiagnosis: "...",
  aiAccuracyRating: 1
}
```

### 步骤 3：检查云函数日志

1. 打开云开发控制台
2. 云函数 → `health-management`
3. 查看调用日志
4. 找到最近的 `correct_abnormal_diagnosis` 调用
5. 检查是否有输出：
   ```
   ✅ 已同步更新 AI 诊断记录: AD2410301234
   ```

### 步骤 4：检查小程序控制台

打开诊断历史页面，点击记录，查看控制台：

```javascript
===== 查看诊断详情 =====
完整记录数据: {...}
是否已修正: false  // ← 如果是 false，说明没有获取到修正信息
修正后诊断: undefined
```

## 常见问题诊断

### 问题 1：异常记录没有 diagnosisId 字段

**原因：**
- 异常记录是手动创建的，不是从 AI 诊断创建的
- 或者是旧版本创建的记录

**解决方案：**
需要从 AI 诊断创建异常记录，或者手动添加 diagnosisId 字段

### 问题 2：云函数没有正确部署

**验证方法：**
1. 查看云函数最后更新时间
2. 查看云函数代码是否包含同步更新逻辑

### 问题 3：数据关联断裂

**原因：**
- diagnosisId 指向的 AI 诊断记录不存在
- diagnosisId 是错误的ID

## 临时解决方案

### 方案 A：直接在 AI 诊断记录中添加修正信息（手动）

打开云开发控制台 → 数据库 → `health_ai_diagnosis`

找到对应的记录，点击"编辑"，添加以下字段：

```javascript
{
  "isCorrected": true,
  "correctedDiagnosis": "浆膜炎",
  "veterinarianDiagnosis": "脏器发白，浆膜炎。",
  "aiAccuracyRating": 1,
  "correctedByName": "KAKA",
  "correctedAt": "2025-10-30T01:51:00.000Z"
}
```

保存后，刷新诊断历史页面，应该就能看到修正记录了。

### 方案 B：使用云函数脚本批量修复

我可以帮你创建一个云函数脚本，自动查找所有已修正的异常记录，并同步到对应的 AI 诊断记录。

## 下一步行动

请按照步骤 1-4 检查，然后告诉我：

1. ✅/❌ 异常记录是否有 `diagnosisId` 字段？
2. ✅/❌ AI 诊断记录是否有修正信息？
3. ✅/❌ 云函数日志是否有同步成功的消息？
4. ✅/❌ 控制台输出的 `isCorrected` 是 true 还是 false？

根据你的检查结果，我会提供针对性的解决方案。

