# 生产管理系统部署指南

## 📋 模拟数据清理说明

**✅ 已完成模拟数据清理**

为确保生产环境的数据准确性，已对代码进行以下优化：

### 🔄 数据加载策略
- **统计数据**：初始值为 `0`，由云函数返回真实数据覆盖
- **记录列表**：初始为空数组 `[]`，由云函数加载真实数据
- **错误处理**：云函数调用失败时显示友好提示
- **空状态**：无数据时显示引导操作按钮

### 🎯 部署建议

**方案一：先部署云函数（推荐）**
```bash
1. 按照本指南部署所有云函数
2. 创建必要的数据库集合
3. 测试页面功能，此时显示真实数据
4. 如需添加示例数据，可通过表单手动添加
```

**方案二：保留开发体验**
```bash
1. 先不部署云函数，页面显示空状态
2. 可以先测试表单功能和页面交互
3. 逐步部署云函数，观察数据加载过程
4. 最终实现完整的生产环境
```

### 💡 优势特性
- **渐进式加载**：支持云函数未部署时的优雅降级
- **友好提示**：明确告知用户系统状态
- **空状态引导**：提供快速操作入口
- **错误恢复**：网络失败时不影响基本功能

---

## 系统概览

生产管理系统包含以下主要功能模块：

### 功能模块
- **入栏管理**：记录鹅苗入栏信息，包括品种、供应商、数量等
- **出栏管理**：记录成年鹅出栏销售信息，与入栏批次关联
- **物料管理**：采购入库、物料领用、库存管理
- **统计分析**：生产数据统计、趋势分析、预警提醒

### 技术架构
- **前端**：微信小程序 + TDesign UI组件库
- **后端**：微信云开发（Node.js）
- **数据库**：云开发数据库（MongoDB）
- **存储**：云开发云存储

## 云函数部署

### 1. 创建云函数

您需要部署以下5个云函数：

#### 1.1 production-entry（入栏管理）
```bash
# 在微信开发者工具中右键云函数目录
# 选择 "新建Node.js云函数" -> 输入 "production-entry"
# 替换 index.js 和 package.json 内容
```

#### 1.2 production-exit（出栏管理）
```bash
# 新建云函数 "production-exit"
# 替换相应文件内容
```

#### 1.3 production-material（物料管理）
```bash
# 新建云函数 "production-material"
# 替换相应文件内容
```

#### 1.4 production-dashboard（生产仪表盘）
```bash
# 新建云函数 "production-dashboard"
# 替换相应文件内容
```

#### 1.5 production-upload（文件上传）
```bash
# 新建云函数 "production-upload"
# 替换相应文件内容
```

### 2. 部署云函数

在微信开发者工具中：
1. 右键每个云函数文件夹
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成

## 数据库初始化

### 1. 创建数据库集合

在云开发控制台的数据库页面，创建以下集合（用户表已存在，无需重新创建）：

#### 1.1 用户表（users）
**✅ 已存在，无需重新创建**

现有用户表已包含所需字段：
- `_openid`：用户唯一标识
- `nickname, avatarUrl, phone`：基本信息  
- `farmName`：养殖场名称
- `role, permissions`：角色权限控制
- `department, position`：部门职位
- `createTime, lastLoginTime`：时间信息
- `isActive`：用户状态

> 💡 该用户表在微信登录功能中已创建，完全满足生产管理系统需求。

#### 1.2 入栏记录表（entry_records）
**🆕 需要创建**
```json
{
  "_id": "自动生成",
  "userId": "用户openid",
  "batchNumber": "批次号",
  "breed": "品种",
  "quantity": 100,
  "supplier": "供应商",
  "entryDate": "入栏日期",
  "status": "已完成",
  "createTime": "创建时间"
}
```

#### 1.3 出栏记录表（exit_records）
**🆕 需要创建**
```json
{
  "_id": "自动生成",
  "userId": "用户openid",
  "batchNumber": "关联入栏批次",
  "customer": "客户",
  "quantity": 50,
  "avgWeight": 4.5,
  "exitDate": "出栏日期",
  "status": "已交付",
  "createTime": "创建时间"
}
```

#### 1.4 物料表（materials）
**🆕 需要创建**
```json
{
  "_id": "自动生成",
  "materialCode": "物料编码",
  "name": "物料名称",
  "category": "feed/medicine/equipment",
  "unit": "单位",
  "currentStock": 100,
  "safetyStock": 20,
  "isActive": true,
  "createTime": "创建时间"
}
```

#### 1.5 物料记录表（material_records）
**🆕 需要创建**
```json
{
  "_id": "自动生成",
  "userId": "用户openid",
  "materialId": "物料ID",
  "type": "purchase/use",
  "quantity": 10,
  "recordDate": "记录日期",
  "operator": "操作人员",
  "status": "已完成",
  "createTime": "创建时间"
}
```

#### 1.6 库存流水表（inventory_logs）
**🆕 需要创建**
```json
{
  "_id": "自动生成",
  "materialId": "物料ID",
  "recordId": "记录ID",
  "operation": "入库/出库",
  "quantity": 10,
  "beforeStock": 90,
  "afterStock": 100,
  "operationTime": "操作时间"
}
```

#### 1.7 文件记录表（file_records）
**🆕 需要创建**
```json
{
  "_id": "自动生成",
  "userId": "用户openid",
  "fileID": "云存储文件ID",
  "originalName": "原始文件名",
  "category": "文件分类",
  "relatedType": "entry/exit/material",
  "relatedId": "关联记录ID",
  "isActive": true,
  "createTime": "创建时间"
}
```

### 2. 设置数据库权限

在云开发控制台的数据库页面：
1. 点击每个集合的"权限设置"
2. 设置为"仅创建者可读写"或根据需要调整
3. 管理员可以设置为"所有用户可读，仅创建者可写"

## 存储配置

### 1. 云存储设置

在云开发控制台的存储页面：
1. 创建文件夹结构：
   ```
   production/
   ├── entry/        # 入栏相关文件
   ├── exit/         # 出栏相关文件
   ├── material/     # 物料相关文件
   └── general/      # 通用文件
   ```

### 2. 存储权限设置
- 设置为"仅创建者可读写"
- 允许的文件类型：图片、PDF、Word文档
- 文件大小限制：10MB

## 前端集成

### 1. 页面更新

已更新的页面文件：
- `pages/production/production.ts` - 主页面逻辑
- `pages/production/production.wxml` - 页面模板
- `pages/production/production.json` - 页面配置

### 2. 新增表单页面

需要创建的表单页面：

#### 2.1 入栏表单（entry-form）
```typescript
// pages/entry-form/entry-form.ts
Page({
  data: {
    formData: {
      breed: '',
      quantity: '',
      supplier: '',
      unitPrice: '',
      entryDate: new Date().toISOString().split('T')[0],
      operator: '',
      notes: ''
    }
  },
  
  async submitForm() {
    try {
      const result = await wx.cloud.callFunction({
        name: 'production-entry',
        data: {
          action: 'create',
          recordData: this.data.formData
        }
      })
      
      if (result.result.success) {
        wx.showToast({ title: '创建成功' })
        wx.navigateBack()
      } else {
        wx.showToast({ title: result.result.message, icon: 'none' })
      }
    } catch (error) {
      wx.showToast({ title: '创建失败', icon: 'none' })
    }
  }
})
```

#### 2.2 出栏表单（exit-form）
```typescript
// pages/exit-form/exit-form.ts
Page({
  data: {
    formData: {
      batchNumber: '',
      customer: '',
      quantity: '',
      avgWeight: '',
      unitPrice: '',
      exitDate: new Date().toISOString().split('T')[0]
    },
    availableBatches: []
  },
  
  async onLoad() {
    await this.loadAvailableBatches()
  },
  
  async loadAvailableBatches() {
    try {
      const result = await wx.cloud.callFunction({
        name: 'production-exit',
        data: { action: 'available_batches' }
      })
      
      if (result.result.success) {
        this.setData({
          availableBatches: result.result.data
        })
      }
    } catch (error) {
      console.error('加载可用批次失败:', error)
    }
  }
})
```

## 测试和验证

### 1. 功能测试

#### 1.1 入栏管理测试
```javascript
// 在小程序控制台执行
wx.cloud.callFunction({
  name: 'production-entry',
  data: {
    action: 'create',
    recordData: {
      breed: '白鹅苗',
      quantity: 100,
      supplier: '测试供应商',
      unitPrice: 8.2,
      operator: '测试操作员'
    }
  }
}).then(res => console.log(res))
```

#### 1.2 出栏管理测试
```javascript
// 先获取可用批次
wx.cloud.callFunction({
  name: 'production-exit',
  data: { action: 'available_batches' }
}).then(res => console.log(res))
```

#### 1.3 物料管理测试
```javascript
// 创建物料
wx.cloud.callFunction({
  name: 'production-material',
  data: {
    action: 'create_material',
    materialData: {
      name: '优质鹅用饲料',
      category: 'feed',
      unit: 'kg',
      safetyStock: 500
    }
  }
}).then(res => console.log(res))
```

### 2. 性能测试

- 检查页面加载速度
- 测试大数据量下的查询性能
- 验证文件上传功能

## 常见问题和解决方案

### 1. 云函数调用失败
**问题**：调用云函数时返回错误
**解决**：
- 检查云函数是否正确部署
- 验证函数名称是否正确
- 查看云函数日志排查错误

### 2. 数据库权限问题
**问题**：无法读写数据库
**解决**：
- 检查数据库权限设置
- 确认用户已正确登录
- 验证集合名称是否正确

### 3. 文件上传失败
**问题**：图片或文件上传失败
**解决**：
- 检查文件大小是否超限
- 验证文件类型是否支持
- 确认云存储权限配置

### 4. 页面数据不显示
**问题**：页面加载后数据为空
**解决**：
- 检查云函数返回的数据格式
- 验证前端数据绑定是否正确
- 查看浏览器控制台错误信息

## 部署检查清单

- [ ] 5个云函数全部部署成功
- [ ] 6个数据库集合创建完成（用户表已存在）
- [ ] 数据库权限配置正确
- [ ] 云存储文件夹结构创建
- [ ] 存储权限配置完成
- [ ] 前端页面代码更新
- [ ] 表单页面创建完成
- [ ] 功能测试通过
- [ ] 性能测试正常
- [ ] 用户权限验证通过

## 维护和监控

### 1. 日常监控
- 定期检查云函数调用次数和错误率
- 监控数据库存储使用量
- 关注文件存储空间使用情况

### 2. 数据备份
- 定期导出重要数据
- 设置数据库自动备份
- 建立数据恢复流程

### 3. 性能优化
- 优化查询语句
- 添加数据库索引
- 压缩图片文件大小

---

部署完成后，您的生产管理系统将具备完整的入栏、出栏、物料管理功能，并支持数据统计和文件管理。如有问题，请参考本指南或联系技术支持。