# ç”¨æˆ·ç®¡ç†ç­›é€‰ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

åœ¨ç”¨æˆ·ç®¡ç†é¡µé¢ï¼Œç‚¹å‡»"ç®¡ç†å‘˜"é€‰é¡¹å¡æ—¶ï¼Œ**è¶…çº§ç®¡ç†å‘˜**ï¼ˆsuper_adminï¼‰å’Œ**ç»ç†**ï¼ˆmanagerï¼‰è§’è‰²çš„ç”¨æˆ·æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ã€‚

### åŸå› åˆ†æ

ç³»ç»Ÿç»å†äº†è§’è‰²ä½“ç³»å‡çº§ï¼š

**æ—§è§’è‰²ä½“ç³»ï¼š**
- `admin` - ç®¡ç†å‘˜
- `user` - æ™®é€šç”¨æˆ·
- `operator` - æ“ä½œå‘˜

**æ–°è§’è‰²ä½“ç³»ï¼š**
- `super_admin` - è¶…çº§ç®¡ç†å‘˜ï¼ˆç®¡ç†ç±»ï¼‰
- `manager` - ç»ç†ï¼ˆç®¡ç†ç±»ï¼‰
- `veterinarian` - å…½åŒ»ï¼ˆæ™®é€šç”¨æˆ·ç±»ï¼‰
- `employee` - å‘˜å·¥ï¼ˆæ™®é€šç”¨æˆ·ç±»ï¼‰

ä½†æ˜¯ç­›é€‰é€»è¾‘è¿˜åœ¨ä½¿ç”¨æ—§çš„ç²¾ç¡®åŒ¹é…æ–¹å¼ï¼š
- å‰ç«¯ä¼ é€’ `role = 'admin'`
- åç«¯ç²¾ç¡®åŒ¹é… `role = 'admin'`
- **ç»“æœï¼š** åªèƒ½æŸ¥åˆ°æ—§çš„ `admin` è§’è‰²ï¼ŒæŸ¥ä¸åˆ°æ–°çš„ `manager` å’Œ `super_admin`

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹åç«¯äº‘å‡½æ•°ç­›é€‰é€»è¾‘

**æ–‡ä»¶ï¼š** `cloudfunctions/user-management/index.js`

**ä¿®æ”¹å†…å®¹ï¼š**

```javascript
// ä¿®æ”¹å‰ï¼šç²¾ç¡®åŒ¹é…
if (role) query = query.where({ role })

// ä¿®æ”¹åï¼šæ™ºèƒ½åŒ¹é…
if (role === 'admin') {
  // ç®¡ç†å‘˜é€‰é¡¹å¡ï¼šæŸ¥è¯¢æ‰€æœ‰ç®¡ç†ç±»è§’è‰²
  query = query.where({
    role: db.command.in(['manager', 'super_admin', 'admin'])
  })
} else if (role === 'user') {
  // æ™®é€šç”¨æˆ·é€‰é¡¹å¡ï¼šæŸ¥è¯¢æ‰€æœ‰æ™®é€šç”¨æˆ·è§’è‰²
  query = query.where({
    role: db.command.in(['employee', 'veterinarian', 'user', 'operator'])
  })
} else if (role) {
  // å…¶ä»–æƒ…å†µï¼šç²¾ç¡®åŒ¹é…
  query = query.where({ role })
}
```

### å…¼å®¹æ–°æ—§è§’è‰²ä½“ç³»

ä¿®å¤åçš„ç­›é€‰é€»è¾‘åŒæ—¶æ”¯æŒæ–°æ—§è§’è‰²ä½“ç³»ï¼š

| é€‰é¡¹å¡ | æŸ¥è¯¢çš„è§’è‰² | è¯´æ˜ |
|--------|-----------|------|
| ç®¡ç†å‘˜ | `manager`, `super_admin`, `admin` | æ–°æ—§ç®¡ç†ç±»è§’è‰² |
| æ™®é€šç”¨æˆ· | `employee`, `veterinarian`, `user`, `operator` | æ–°æ—§æ™®é€šç”¨æˆ·ç±»è§’è‰² |
| å…¨éƒ¨ç”¨æˆ· | æ‰€æœ‰è§’è‰² | ä¸ç­›é€‰ |
| å·²ç¦ç”¨ | æŒ‰çŠ¶æ€ç­›é€‰ | ä¸æŒ‰è§’è‰²ç­›é€‰ |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. éƒ¨ç½²äº‘å‡½æ•°

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd cloudfunctions/user-management
npm install
```

ç„¶ååœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. å³é”®ç‚¹å‡» `cloudfunctions/user-management` æ–‡ä»¶å¤¹
2. é€‰æ‹©"ä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–"
3. ç­‰å¾…éƒ¨ç½²å®Œæˆ

### 2. éªŒè¯ä¿®å¤æ•ˆæœ

1. æ‰“å¼€å°ç¨‹åº
2. è¿›å…¥"ä¸ªäººä¸­å¿ƒ"
3. ç‚¹å‡»"äººå‘˜ç®¡ç†"
4. åˆ‡æ¢åˆ°"ç®¡ç†å‘˜"é€‰é¡¹å¡
5. ç¡®è®¤å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç®¡ç†å‘˜è´¦æˆ·ï¼ˆåŒ…æ‹¬è¶…çº§ç®¡ç†å‘˜å’Œç»ç†ï¼‰

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
ã€ç®¡ç†å‘˜ã€‘é€‰é¡¹å¡
â””â”€â”€ ç©ºåˆ—è¡¨ âŒ ï¼ˆå› ä¸ºæ²¡æœ‰æ—§çš„ 'admin' è§’è‰²ç”¨æˆ·ï¼‰
```

### ä¿®å¤å

```
ã€ç®¡ç†å‘˜ã€‘é€‰é¡¹å¡
â”œâ”€â”€ è¶…çº§ç®¡ç†å‘˜ âœ…
â”œâ”€â”€ ç»ç† âœ…
â””â”€â”€ æ—§çš„ç®¡ç†å‘˜ âœ…ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
```

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

ä½¿ç”¨ `db.command.in()` è¿›è¡Œå¤šå€¼åŒ¹é…ï¼š

```javascript
// æŸ¥è¯¢å¤šä¸ªè§’è‰²
query = query.where({
  role: db.command.in(['manager', 'super_admin', 'admin'])
})

// ç­‰æ•ˆçš„ SQL
// SELECT * FROM wx_users WHERE role IN ('manager', 'super_admin', 'admin')
```

### å‰ç«¯æ— éœ€ä¿®æ”¹

å‰ç«¯ä»£ç ä¿æŒä¸å˜ï¼Œä»ç„¶ä¼ é€’ `role = 'admin'` æˆ– `role = 'user'`ï¼Œåç«¯æ™ºèƒ½å¤„ç†ï¼š

```typescript
// user-management.ts
switch (this.data.activeTab) {
  case 'admin':
    role = 'admin'  // åç«¯ä¼šè‡ªåŠ¨å±•å¼€ä¸ºå¤šä¸ªè§’è‰²
    break
  case 'user':
    role = 'user'   // åç«¯ä¼šè‡ªåŠ¨å±•å¼€ä¸ºå¤šä¸ªè§’è‰²
    break
}
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `cloudfunctions/user-management/index.js` - äº‘å‡½æ•°ç­›é€‰é€»è¾‘

### æœªä¿®æ”¹çš„æ–‡ä»¶
- `miniprogram/packageUser/user-management/user-management.ts` - å‰ç«¯é€»è¾‘
- `miniprogram/packageUser/user-management/user-management.wxml` - é¡µé¢ç»“æ„
- `miniprogram/packageUser/user-management/user-management.scss` - é¡µé¢æ ·å¼

---

## ğŸ¯ è§’è‰²ä½“ç³»è¯´æ˜

### æ–°è§’è‰²ä½“ç³»ï¼ˆæ¨èä½¿ç”¨ï¼‰

| è§’è‰²ä»£ç  | è§’è‰²åç§° | åˆ†ç±» | æƒé™ |
|---------|---------|------|------|
| `super_admin` | è¶…çº§ç®¡ç†å‘˜ | ç®¡ç†ç±» | æ‰€æœ‰æƒé™ |
| `manager` | ç»ç† | ç®¡ç†ç±» | ç”Ÿäº§ã€å¥åº·ã€è´¢åŠ¡ã€å‘˜å·¥ç®¡ç† |
| `veterinarian` | å…½åŒ» | æ™®é€šç”¨æˆ· | ç”Ÿäº§æŸ¥çœ‹ã€å¥åº·ç®¡ç† |
| `employee` | å‘˜å·¥ | æ™®é€šç”¨æˆ· | åŸºç¡€æƒé™ã€ç”Ÿäº§æŸ¥çœ‹ã€å¥åº·æŸ¥çœ‹ |

### æ—§è§’è‰²ä½“ç³»ï¼ˆå…¼å®¹æ”¯æŒï¼‰

| è§’è‰²ä»£ç  | è§’è‰²åç§° | è¯´æ˜ |
|---------|---------|------|
| `admin` | ç®¡ç†å‘˜ | ç­‰åŒäº manager |
| `user` | æ™®é€šç”¨æˆ· | ç­‰åŒäº employee |
| `operator` | æ“ä½œå‘˜ | ç­‰åŒäº employee |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **éƒ¨ç½²åç”Ÿæ•ˆ**
   - ä¿®æ”¹äº‘å‡½æ•°åå¿…é¡»é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆ
   - å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

2. **å‘ä¸‹å…¼å®¹**
   - ä¿®å¤ä¿æŒäº†å¯¹æ—§è§’è‰²ä½“ç³»çš„å…¼å®¹
   - ä¸ä¼šå½±å“ç°æœ‰ç”¨æˆ·çš„è§’è‰²å’Œæƒé™

3. **æƒé™ä¸€è‡´æ€§**
   - ç¡®ä¿æ—§è§’è‰²ç”¨æˆ·çš„æƒé™ä¸æ–°è§’è‰²å¯¹åº”
   - å»ºè®®é€æ­¥å°†æ—§è§’è‰²è¿ç§»åˆ°æ–°è§’è‰²ä½“ç³»

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### 1. è§’è‰²è¿ç§»

å¦‚æœæ•°æ®åº“ä¸­è¿˜æœ‰æ—§è§’è‰²çš„ç”¨æˆ·ï¼Œå»ºè®®æ‰§è¡Œè§’è‰²è¿ç§»ï¼š

```javascript
// è¿ç§»è„šæœ¬ï¼ˆåœ¨äº‘å‡½æ•°ä¸­æ‰§è¡Œï¼‰
const migrations = {
  'admin': 'manager',
  'user': 'employee',
  'operator': 'employee'
}

// æ‰¹é‡æ›´æ–°ç”¨æˆ·è§’è‰²
for (const [oldRole, newRole] of Object.entries(migrations)) {
  await db.collection('wx_users')
    .where({ role: oldRole })
    .update({
      data: { role: newRole }
    })
}
```

### 2. ç»Ÿè®¡æ•°æ®ä¼˜åŒ–

æ›´æ–°ç»Ÿè®¡é€»è¾‘ä»¥åæ˜ æ–°è§’è‰²ä½“ç³»ï¼š

```javascript
// ç»Ÿè®¡ç®¡ç†å‘˜æ•°é‡
const adminCount = await db.collection('wx_users')
  .where({
    role: db.command.in(['manager', 'super_admin'])
  })
  .count()
```

### 3. UI æ–‡æ¡ˆä¼˜åŒ–

è€ƒè™‘æ›´æ–°é€‰é¡¹å¡åç§°ä»¥åæ˜ æ–°è§’è‰²ä½“ç³»ï¼š

```
å½“å‰ï¼šã€ç®¡ç†å‘˜ã€‘ã€æ™®é€šç”¨æˆ·ã€‘
å»ºè®®ï¼šã€ç®¡ç†ç±»ã€‘ã€å‘˜å·¥ç±»ã€‘
æˆ–è€…ï¼šã€ç®¡ç†å±‚ã€‘ã€æ™®é€šå‘˜å·¥ã€‘
```

---

## âœ… éªŒè¯æ¸…å•

éƒ¨ç½²åè¯·éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š

- [ ] "ç®¡ç†å‘˜"é€‰é¡¹å¡æ˜¾ç¤ºæ‰€æœ‰è¶…çº§ç®¡ç†å‘˜
- [ ] "ç®¡ç†å‘˜"é€‰é¡¹å¡æ˜¾ç¤ºæ‰€æœ‰ç»ç†
- [ ] "ç®¡ç†å‘˜"é€‰é¡¹å¡æ˜¾ç¤ºæ—§çš„ç®¡ç†å‘˜ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] "æ™®é€šç”¨æˆ·"é€‰é¡¹å¡æ˜¾ç¤ºæ‰€æœ‰å‘˜å·¥
- [ ] "æ™®é€šç”¨æˆ·"é€‰é¡¹å¡æ˜¾ç¤ºæ‰€æœ‰å…½åŒ»
- [ ] "æ™®é€šç”¨æˆ·"é€‰é¡¹å¡æ˜¾ç¤ºæ—§çš„æ™®é€šç”¨æˆ·ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] "å…¨éƒ¨ç”¨æˆ·"é€‰é¡¹å¡æ˜¾ç¤ºæ‰€æœ‰è§’è‰²
- [ ] "å·²ç¦ç”¨"é€‰é¡¹å¡åªæ˜¾ç¤ºç¦ç”¨çš„ç”¨æˆ·
- [ ] ç»Ÿè®¡æ•°æ®ï¼ˆç®¡ç†å‘˜æ•°é‡ï¼‰æ­£ç¡®æ˜¾ç¤º

---

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†è§’è‰²ä½“ç³»å‡çº§åç­›é€‰é€»è¾‘ä¸å…¼å®¹çš„é—®é¢˜ï¼š

âœ… **è¶…çº§ç®¡ç†å‘˜ç°åœ¨å¯ä»¥åœ¨"ç®¡ç†å‘˜"é€‰é¡¹å¡ä¸­æ˜¾ç¤º**  
âœ… **ç»ç†ä¹Ÿå¯ä»¥åœ¨"ç®¡ç†å‘˜"é€‰é¡¹å¡ä¸­æ˜¾ç¤º**  
âœ… **ä¿æŒäº†å¯¹æ—§è§’è‰²ä½“ç³»çš„å®Œå…¨å…¼å®¹**  
âœ… **æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç **  
âœ… **æ€§èƒ½ä¸å—å½±å“**

---

*ä¿®å¤æ—¶é—´ï¼š2025-11-06*  
*ç‰ˆæœ¬ï¼šv1.0*

