# 部署指南 - 成本卡片分类修复

## 修复内容

✅ **问题1：饲料成本重复计算**
- 原因：同时统计了投喂记录（库存流转）和采购记录
- 修复：删除投喂记录统计，只保留采购记录

✅ **问题2：其他费用缺少报销等记录**
- 原因：只统计了物料采购中的"其他"类别
- 修复：添加 FINANCE_COST_RECORDS 统计，包含报销、人工、设备等

## 部署步骤

### 方法1：使用微信开发者工具上传

1. **打开微信开发者工具**

2. **选择云函数目录**
   - 在左侧文件树中找到 `cloudfunctions/finance-management`
   - 右键点击 `finance-management` 文件夹

3. **上传并部署**
   - 选择 "上传并部署：云端安装依赖"
   - 等待上传完成

4. **验证部署**
   - 查看云函数列表，确认 `finance-management` 已更新
   - 查看版本号和更新时间

### 方法2：使用命令行（如果 tcb 命令可用）

```bash
cd /Users/kaka/Documents/Sync/小程序/鹅数通/cloudfunctions/finance-management
tcb fn deploy finance-management
```

## 测试步骤

### 1. 清除缓存

**小程序端**：
1. 在微信开发者工具中
2. 点击菜单栏 "工具" -> "清缓存"
3. 选择 "清除数据缓存"
4. 点击 "编译" 重新编译小程序

### 2. 查看财务概览

1. 打开小程序，进入"财务管理"页面
2. 查看4个成本卡片：
   - 饲料成本
   - 鹅苗成本
   - 医疗费用
   - 其他费用

### 3. 验证饲料成本

**测试数据**：
- 假设11月采购了1吨饲料，10000元
- 11月投喂了500kg

**期望结果**：
- 饲料成本应该显示：¥1.0万（10000元）
- **不应该**包含投喂的金额

### 4. 验证医疗费用

**测试数据**：
- 假设11月采购了10瓶药品，1200元
- 11月治疗用了2瓶

**期望结果**：
- 医疗费用应该显示：¥0.1万（1200元）
- **不应该**是¥0.0万

### 5. 验证其他费用

**测试数据**：
- 11月有报销记录：差旅费200元
- 11月有其他支出：设备5000元、人工3000元

**期望结果**：
- 其他费用应该显示：¥0.8万（8200元）
- **应该包含**所有报销、人工、设备等支出

### 6. 验证总支出

**计算公式**：
```
总支出 = 饲料成本 + 鹅苗成本 + 医疗费用 + 其他费用
```

**验证方法**：
1. 记录页面显示的4个成本卡片的金额
2. 手动相加
3. 对比页面顶部显示的"总支出"
4. 两者应该相等

### 7. 切换时间段测试

**测试步骤**：
1. 切换到"本月"，查看数据
2. 切换到"本季度"，查看数据
3. 切换到"本年"，查看数据

**期望结果**：
- 每个时间段的成本卡片数据应该准确反映该时段内的采购和支出
- 不应该包含投喂和治疗用药的金额

## 数据验证

### 手动验证方法

#### 1. 验证饲料成本

在云开发控制台中，查询 `prod_material_records` 表：

```javascript
// 筛选条件
{
  isDeleted: false,
  type: 'purchase',
  recordDate: { $gte: '2025-11-01', $lte: '2025-11-30' }
}
```

筛选出 category 为 '饲料' 的记录，手动计算 totalAmount 总和。

#### 2. 验证医疗费用

同样在 `prod_material_records` 表中：

```javascript
// 筛选条件
{
  isDeleted: false,
  type: 'purchase',
  recordDate: { $gte: '2025-11-01', $lte: '2025-11-30' }
}
```

筛选出 category 为 '药品' 或 '营养品' 的记录，手动计算 totalAmount 总和。

#### 3. 验证其他费用

在 `finance_cost_records` 表中：

```javascript
// 筛选条件
{
  isDeleted: false,
  date: { $gte: '2025-11-01', $lte: '2025-11-30' },
  costType: { $in: ['reimbursement', 'labor', 'facility', 'equipment', 'other'] }
}
```

手动计算 amount 总和。

## 常见问题

### Q1: 成本卡片数据没有变化？

**A**: 请按照以下步骤操作：
1. 确认云函数已成功上传
2. 清除小程序数据缓存
3. 重新编译小程序
4. 完全退出并重新进入财务管理页面

### Q2: 饲料成本比之前少了？

**A**: 这是正常的，因为之前的逻辑重复计算了：
- 之前：采购成本 + 投喂成本（重复）
- 现在：只统计采购成本（正确）

### Q3: 其他费用比之前多了？

**A**: 这是正常的，因为之前遗漏了报销等费用：
- 之前：只统计物料采购中的"其他"
- 现在：物料采购 + 报销 + 人工 + 设备（完整）

### Q4: 总支出和各项成本之和不一致？

**A**: 请检查：
1. 是否有采购记录的 materialId 无效
2. 是否有物料的 category 为空
3. 查看云函数日志，是否有查询错误

## 技术细节

### 修改的文件

`cloudfunctions/finance-management/reimbursement-handler.js`

#### 变更1：删除投喂记录统计（Line 798-821）

**Before**:
```javascript
// 2. 从投喂记录汇总饲料成本
let feedQuery = db.collection(COLLECTIONS.PROD_FEED_USAGE_RECORDS)
  .where({ isDeleted: _.neq(true) })
  // ...
breakdown.feedCost += feedResult.data.reduce((sum, r) => sum + (r.totalCost || 0), 0)
```

**After**:
```javascript
// 2. 投喂记录不在成本统计中（库存流转，不涉及现金流）
// 说明：饲料成本只统计采购记录，投喂只是库存流转
```

#### 变更2：添加财务成本记录统计（Line 909-947）

**新增代码**:
```javascript
// 6. 从财务成本记录汇总（报销、人工、设备等归类为其他费用）
let costRecordQuery = db.collection(COLLECTIONS.FINANCE_COST_RECORDS)
  .where({ isDeleted: _.neq(true) })
  // ... 时间和批次筛选 ...

costRecordResult.data.forEach(record => {
  const amount = record.amount || 0
  const costType = record.costType || 'other'
  
  if (costType === 'feed') {
    breakdown.feedCost += amount
  } else if (costType === 'health' || costType === 'medical') {
    breakdown.medicalCost += amount
  } else {
    // 其他所有类型（报销、人工、设备等）都计入其他费用
    breakdown.otherCost += amount
  }
})
```

### 数据流说明

```
┌────────────────────┐
│  物料采购记录       │
│ PROD_MATERIAL_     │
│ RECORDS            │
│ (type='purchase')  │
└─────────┬──────────┘
          │ category判断
          ├─ 饲料 ────> 饲料成本 ✅
          ├─ 药品 ────> 医疗费用 ✅
          └─ 其他 ────> 其他费用 ✅

┌────────────────────┐
│  财务成本记录       │
│ FINANCE_COST_      │
│ RECORDS            │
└─────────┬──────────┘
          │ costType判断
          ├─ feed ────> 饲料成本 ✅
          ├─ health ──> 医疗费用 ✅
          ├─ medical ─> 医疗费用 ✅
          ├─ reimbursement ─> 其他费用 ✅
          ├─ labor ───> 其他费用 ✅
          ├─ facility > 其他费用 ✅
          └─ other ───> 其他费用 ✅

┌────────────────────┐
│  入栏记录           │
│ PROD_BATCH_        │
│ ENTRIES            │
└─────────┬──────────┘
          └─ totalAmount ─> 鹅苗成本 ✅

❌ 不统计：
  - PROD_FEED_USAGE_RECORDS（投喂记录）
  - PROD_MATERIAL_RECORDS (type='use')（领用记录）
```

## 回滚方案

如果部署后发现问题，可以回滚到之前的版本：

1. 在云开发控制台中，选择云函数 `finance-management`
2. 点击"版本管理"
3. 选择之前的版本，点击"回滚"

## 相关文档

- [成本卡片分类修复说明.md](./成本卡片分类修复说明.md) - 详细的修复说明
- [财务管理现金流视角说明.md](./财务管理现金流视角说明.md) - 财务管理的核心理念

## 总结

### 修复后的成本卡片分类

✅ **饲料成本**：饲料采购记录
✅ **鹅苗成本**：入栏采购记录
✅ **医疗费用**：药品、营养品采购记录
✅ **其他费用**：报销 + 人工 + 设备 + 其他物料采购

### 核心原则

💰 **只统计有现金流动的事件**
- 采购 ✅（花钱）
- 报销 ✅（花钱）
- 投喂 ❌（库存流转）
- 治疗 ❌（库存流转）

每笔支出都有归属，不重复、不遗漏！

