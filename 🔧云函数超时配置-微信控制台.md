# 🔧 云函数超时配置 - 微信控制台

## 🎯 问题

云函数执行成功（34秒），但云函数间调用超时（默认30秒），导致前端显示失败。

---

## ✅ 解决方案：在微信云开发控制台配置超时时间

### 步骤1：打开微信云开发控制台

**方式A：通过开发者工具**
```
微信开发者工具
→ 顶部菜单栏 "云开发"
→ 点击 "云开发控制台"
```

**方式B：直接访问**
```
https://console.cloud.tencent.com/tcb
→ 选择您的环境
```

---

### 步骤2：配置 `ai-multi-model` 云函数超时

```
1. 进入云开发控制台
2. 左侧菜单：云函数 → 函数列表
3. 找到 `ai-multi-model`
4. 点击函数名称进入详情
5. 点击 "函数配置" 标签
6. 找到 "超时时间" 配置项
7. 修改为：120秒（2分钟）
8. 点击 "保存"
```

**配置参数**：
- **超时时间**：`120秒`
- **内存配置**：保持默认 `256MB`
- **环境变量**：已配置（不需要改动）

---

### 步骤3：配置 `process-ai-diagnosis` 云函数超时

```
1. 同样的步骤
2. 找到 `process-ai-diagnosis`
3. 超时时间改为：150秒（2.5分钟）
   （比 ai-multi-model 多30秒，留出余量）
4. 保存
```

---

## 📊 超时时间配置对照表

| 云函数 | 当前超时 | 建议超时 | 原因 |
|--------|----------|----------|------|
| `ai-multi-model` | 默认60秒 | **120秒** | GEMINI需要34-60秒 |
| `process-ai-diagnosis` | 默认60秒 | **150秒** | 调用ai-multi-model + 处理时间 |
| 其他云函数 | 默认60秒 | 保持不变 | 无需修改 |

---

## 🎯 配置完成后

### 立即生效
- 无需重新上传云函数
- 配置保存后立即生效
- 可以直接测试

### 测试流程
```
1. 打开AI诊断页面
2. 上传1张图片
3. 提交诊断
4. 耐心等待60-90秒
5. 应该能成功返回结果 ✅
```

---

## 📱 详细配置截图指引

### 1. 进入云开发控制台

从开发者工具：
```
┌─────────────────────────────┐
│  微信开发者工具               │
│  ┌─────────────────────┐    │
│  │ 云开发 (顶部菜单)    │ ← 点击这里
│  └─────────────────────┘    │
│         ↓                    │
│  云开发控制台 (网页打开)     │
└─────────────────────────────┘
```

### 2. 找到云函数列表

```
云开发控制台
├── 数据库
├── 存储
├── 云函数 ← 点击这里
│   ├── 函数列表
│   │   ├── ai-diagnosis
│   │   ├── ai-multi-model ← 配置这个
│   │   ├── process-ai-diagnosis ← 配置这个
│   │   └── ...
```

### 3. 配置超时时间

```
ai-multi-model 函数详情
├── 函数代码
├── 函数配置 ← 点击这个标签
│   ├── 基础配置
│   │   ├── 超时时间: [60] 秒 ← 改为 [120]
│   │   ├── 内存: [256] MB
│   │   └── 环境变量: (已配置)
│   └── [ 保 存 ] ← 点击保存
```

---

## 🔍 验证配置是否生效

### 查看配置
```
云函数列表
→ ai-multi-model
→ 函数配置
→ 超时时间: 显示 "120秒" ✅
```

### 查看执行日志
```
云函数列表
→ ai-multi-model
→ 日志
→ 查看最新日志
→ 执行时间: 34秒 < 120秒 ✅
```

---

## ⚠️ 注意事项

### 1. 超时时间范围
- 最小：3秒
- 最大：900秒（15分钟）
- 建议：60-180秒

### 2. 计费影响
- 按实际执行时间计费
- 超时配置只是上限
- 不会额外收费

### 3. 两个云函数都要配置
- ✅ `ai-multi-model`: 120秒
- ✅ `process-ai-diagnosis`: 150秒
- **两个都要配置！**

### 4. 配置后无需上传
- 超时配置在控制台
- 不需要重新上传代码
- 立即生效

---

## 🎊 预期效果

**配置前**：
```
执行时间: 34秒
云函数超时: 30秒 ❌
结果: 失败（超时）
```

**配置后**：
```
执行时间: 34秒
云函数超时: 120秒 ✅
结果: 成功
```

---

## 🆘 如果找不到配置入口

### 方式1：直接访问

复制此链接到浏览器：
```
https://console.cloud.tencent.com/tcb/scf/index
```

### 方式2：使用命令行（可选）

如果安装了 `@cloudbase/cli`：
```bash
# 查看云函数配置
tcb fn detail ai-multi-model

# 更新超时配置
tcb fn config update ai-multi-model --timeout 120
```

---

## 📞 遇到问题？

### 问题1：找不到"云开发"菜单

**原因**：可能未开通云开发

**解决**：
```
1. 微信开发者工具
2. 点击 "云开发" 按钮
3. 如果提示开通，按提示操作
4. 已开通则直接打开控制台
```

### 问题2：看不到"超时时间"配置

**原因**：界面版本不同

**解决**：
```
1. 尝试切换到"基础配置"标签
2. 或在"高级配置"中查找
3. 关键字：timeout、超时、时限
```

### 问题3：修改后不生效

**原因**：缓存问题

**解决**：
```
1. 等待2分钟（配置生效需要时间）
2. 重启开发者工具
3. 清除云函数缓存（重新上传）
```

---

## ✨ 完成后的完整配置

### 环境变量（已配置）
```
GEMINI_API_KEY: xxx
GEMINI_BASE_URL: http://146.235.197.36:8000
GLM4_API_KEY: xxx
```

### 超时配置（新增）
```
ai-multi-model: 120秒 ✅
process-ai-diagnosis: 150秒 ✅
```

### 前端优化（已完成）
```
图片压缩: 70% ✅
轮询超时: 120秒 ✅
```

---

**现在请打开云开发控制台配置超时时间！** 🚀

配置完成后，立即测试就能成功了！

