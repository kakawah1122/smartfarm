# 🌤️ 微信小程序天气功能配置指南

## 概述

已为您创建了完整的天气功能，包括：
- ✅ **JWT认证方式**：安全的Ed25519签名认证
- ✅ **专用API Host配置**：正确使用您的专用域名
- ✅ **完整天气数据**：实时天气、预报、预警、空气质量
- ✅ **真实地理位置**：基于微信wx.getLocation的精确定位
- ✅ **前端兼容**：完全匹配您现有的前端代码格式

## 🔧 配置步骤

### 步骤1：生成Ed25519密钥对

在您的终端中执行以下命令：

```bash
# 生成Ed25519私钥
openssl genpkey -algorithm ED25519 -out ed25519-private.pem

# 生成对应的公钥
openssl pkey -pubout -in ed25519-private.pem > ed25519-public.pem
```

这将生成两个文件：
- `ed25519-private.pem`：私钥（用于云函数）
- `ed25519-public.pem`：公钥（需上传到和风天气控制台）

### 步骤2：在和风天气控制台配置JWT认证

1. **登录和风天气控制台**
   - 访问：https://console.qweather.com/
   - 使用您的账号登录

2. **上传公钥**
   - 进入"项目管理"
   - 选择您的项目
   - 点击"凭据"区域的"添加凭据"
   - 选择认证方式："JSON Web Token"
   - 打开`ed25519-public.pem`文件，复制全部内容
   - 粘贴到"公钥"文本框中
   - 输入凭据名称（如："小程序天气JWT"）
   - 点击"保存"

3. **获取关键信息**
   保存成功后，记录以下信息：
   - **项目ID** (PROJECT_ID)：在项目管理页面显示
   - **凭据ID** (CREDENTIAL_ID/KID)：刚创建的凭据ID

### 步骤3：配置云函数

打开文件：`/cloudfunctions/weather/index.js`

在第19-23行，替换以下配置信息：

```javascript
JWT: {
  PROJECT_ID: '替换为您的项目ID',                    // 从控制台获取
  CREDENTIAL_ID: '替换为您的凭据ID',                // 从控制台获取  
  PRIVATE_KEY: `-----BEGIN PRIVATE KEY-----
替换为您的Ed25519私钥内容（去掉第一行和最后一行的BEGIN/END标记）
-----END PRIVATE KEY-----`
}
```

**私钥配置示例：**
```javascript
PRIVATE_KEY: `-----BEGIN PRIVATE KEY-----
MC4CAQAwBQYDK2VwBCIEIJZ8EbgFV8UxCJBJ7HrFoObFYQaFX+QF1Pr6VYnD4mV1
-----END PRIVATE KEY-----`
```

### 步骤4：部署云函数

在微信开发者工具中：

1. **右键点击** `cloudfunctions/weather` 文件夹
2. **选择** "上传并部署：云端安装依赖（推荐）"
3. **等待**部署完成

### 步骤5：测试功能

部署完成后，您的小程序天气功能就可以正常使用了！

## 📋 功能特性

### 🌡️ 实时天气
- 当前温度、湿度、体感温度
- 风向、风力、能见度、气压
- 天气状况和对应emoji图标

### ⏰ 逐时预报
- 未来24小时天气预报
- 每小时温度、天气、降水概率
- 风速和湿度信息

### 📅 逐日预报  
- 未来7天天气预报
- 日最高/最低温度
- 白天/夜间天气状况
- 湿度、紫外线指数、能见度

### ⚠️ 天气预警
- 官方发布的实时天气预警
- 支持多种预警类型和等级
- 红橙黄蓝四级预警显示

### 🌬️ 空气质量
- AQI指数和等级评价
- PM2.5、PM10、O3等污染物数据
- 空气质量健康建议

### 📍 精准定位
- 基于wx.getLocation的真实地理位置
- 自动解析省市区信息
- 支持高精度位置获取

## 🔒 安全特性

- **JWT认证**：使用Ed25519非对称加密算法
- **专用API Host**：避免与其他开发者冲突
- **私钥保护**：私钥仅存储在云函数中，不会泄露
- **Token过期机制**：JWT token有效期1小时，自动刷新

## 🛠️ 故障排查

### 常见错误及解决方案

**1. "JWT生成失败"**
- 检查私钥格式是否正确
- 确保包含完整的BEGIN/END标记
- 验证私钥是否为Ed25519格式

**2. "API Error: 401"**  
- 检查PROJECT_ID和CREDENTIAL_ID是否正确
- 确认公钥已正确上传到控制台
- 验证私钥与公钥是否匹配

**3. "未找到对应的城市信息"**
- 检查wx.getLocation是否获取到有效坐标
- 确认用户已授权位置权限
- 验证坐标是否在支持的地区范围内

**4. "HTTP Error: 403"**
- 确认API Host配置正确
- 检查是否使用了正确的专用域名
- 联系和风天气客服确认账户状态

## 📞 技术支持

如果配置过程中遇到问题：

1. **检查云函数日志**：在微信开发者工具的云开发控制台查看详细错误信息
2. **验证配置信息**：确保所有配置项都已正确填写
3. **测试网络连接**：确认小程序能正常访问网络API

---

**恭喜！🎉 您的微信小程序天气功能已配置完成，可以为用户提供专业、准确的天气服务了！**
