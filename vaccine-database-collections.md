# 疫苗接种功能数据库集合配置

## 概述
疫苗接种功能需要以下新的数据库集合，需要在微信云开发控制台中创建并配置权限。

## 需要创建的集合

### 1. `prevention_records` - 预防记录
**用途**: 存储疫苗接种、预防措施等记录

**权限配置**:
```javascript
{
  "read": "auth.openid != null",
  "write": "auth.openid == resource._openid || get('database').collection('users').where({_openid: auth.openid}).get().data[0].role in ['super_admin', 'manager', 'technician', 'employee']"
}
```

**数据结构示例**:
```javascript
{
  "_id": "record_id",
  "_openid": "user_openid",
  "batchId": "batch_id",
  "batchNumber": "QY-20250101",
  "recordType": "vaccine",
  "preventionType": "vaccination",
  
  // 疫苗信息
  "vaccine": {
    "name": "小鹅瘟高免血清",
    "manufacturer": "生产厂家",
    "batchNumber": "vaccine_batch",
    "dosage": "每只1.2毫升",
    "route": "subcutaneous"
  },
  
  // 兽医信息
  "veterinarian": {
    "name": "兽医姓名",
    "phone": "联系电话"
  },
  
  // 接种信息
  "vaccination": {
    "count": 100,
    "taskId": "task_id",
    "dayAge": 2,
    "notes": "接种备注"
  },
  
  // 费用信息
  "cost": {
    "vaccine": 2000,
    "veterinary": 500,
    "other": 100,
    "total": 2600
  },
  
  // 元数据
  "createdAt": "2025-01-13T10:00:00.000Z",
  "createdBy": "user_openid",
  "updatedAt": "2025-01-13T10:00:00.000Z",
  "status": "completed"
}
```

### 2. `finance_records` - 财务记录
**用途**: 存储所有财务收支记录

**权限配置**:
```javascript
{
  "read": "auth.openid != null && (auth.openid == resource._openid || get('database').collection('users').where({_openid: auth.openid}).get().data[0].role in ['super_admin', 'manager', 'finance'])",
  "write": "auth.openid == resource._openid || get('database').collection('users').where({_openid: auth.openid}).get().data[0].role in ['super_admin', 'manager', 'finance']"
}
```

**数据结构示例**:
```javascript
{
  "_id": "finance_record_id",
  "_openid": "user_openid",
  "type": "expense", // "income" | "expense"
  "category": "medical", // "feed" | "medical" | "facility" | "salary" | "other"
  "subCategory": "vaccine",
  "title": "疫苗接种费用 - 小鹅瘟高免血清",
  "description": "批次：QY-20250101，接种数量：100只",
  "amount": 2600,
  "batchId": "batch_id",
  "batchNumber": "QY-20250101",
  
  // 费用明细
  "costBreakdown": {
    "vaccine": 2000,
    "veterinary": 500,
    "other": 100
  },
  
  // 关联信息
  "relatedRecord": {
    "type": "prevention",
    "recordId": "prevention_record_id",
    "taskId": "task_id"
  },
  
  // 元数据
  "date": "2025-01-13",
  "createdAt": "2025-01-13T10:00:00.000Z",
  "createdBy": "user_openid",
  "status": "confirmed", // "pending" | "confirmed" | "cancelled"
  "autoGenerated": true
}
```

### 3. `overview_stats` - 概览统计
**用途**: 存储批次和月度统计数据

**权限配置**:
```javascript
{
  "read": "auth.openid != null",
  "write": "get('database').collection('users').where({_openid: auth.openid}).get().data[0].role in ['super_admin', 'manager'] || auth.openid == resource._openid"
}
```

**数据结构示例**:
```javascript
{
  "_id": "stats_id",
  "_openid": "user_openid",
  "batchId": "batch_id",
  "month": "2025-01", // YYYY-MM 格式
  
  // 统计数据
  "preventionCount": 15, // 预防记录数量
  "treatmentCount": 3,   // 治疗记录数量
  "deathCount": 0,       // 死亡数量
  "totalExpense": 26000, // 总支出
  "totalIncome": 0,      // 总收入
  
  // 元数据
  "createdAt": "2025-01-13T10:00:00.000Z",
  "updatedAt": "2025-01-13T10:00:00.000Z"
}
```

## 创建步骤

### 方法一：手动创建（推荐）

1. **登录微信云开发控制台**
   - 打开 [https://console.cloud.tencent.com/tcb](https://console.cloud.tencent.com/tcb)
   - 选择你的环境

2. **创建数据库集合**
   - 进入"数据库" → "集合"
   - 点击"新建集合"
   - 分别创建以下集合：
     - `prevention_records`
     - `finance_records`
     - `overview_stats`

3. **配置权限**
   - 点击集合名称进入详情
   - 切换到"权限设置"标签
   - 将上述权限配置代码复制到对应集合

### 方法二：使用脚本创建

运行以下脚本自动创建集合和索引：

```bash
# 在项目根目录执行
npm run create-vaccine-collections
```

## 索引配置

为了提高查询性能，建议为集合创建以下索引：

### `prevention_records` 索引
```javascript
// 批次查询索引
{ "batchId": 1, "createdAt": -1 }

// 任务关联索引
{ "vaccination.taskId": 1 }

// 时间范围查询索引
{ "createdAt": -1 }

// 记录类型索引
{ "recordType": 1, "preventionType": 1 }
```

### `finance_records` 索引
```javascript
// 批次和日期查询索引
{ "batchId": 1, "date": -1 }

// 类型和分类索引
{ "type": 1, "category": 1, "date": -1 }

// 关联记录索引
{ "relatedRecord.recordId": 1 }

// 金额排序索引
{ "amount": -1, "date": -1 }
```

### `overview_stats` 索引
```javascript
// 批次和月份查询索引
{ "batchId": 1, "month": -1 }

// 统计汇总索引
{ "month": -1, "updatedAt": -1 }
```

## 验证集合创建

创建完成后，可以在云函数中运行以下代码验证：

```javascript
// 测试集合访问
const testCollections = async () => {
  const db = cloud.database()
  
  try {
    // 测试 prevention_records
    await db.collection('prevention_records').limit(1).get()
    console.log('✅ prevention_records 集合可访问')
    
    // 测试 finance_records  
    await db.collection('finance_records').limit(1).get()
    console.log('✅ finance_records 集合可访问')
    
    // 测试 overview_stats
    await db.collection('overview_stats').limit(1).get()
    console.log('✅ overview_stats 集合可访问')
    
    return { success: true, message: '所有集合创建成功' }
  } catch (error) {
    console.error('❌ 集合访问失败:', error)
    return { success: false, error: error.message }
  }
}
```

## 注意事项

1. **权限安全**: 财务记录的读取权限较为严格，只有管理员和财务人员可以访问
2. **数据完整性**: 所有记录都包含 `_openid` 字段用于权限控制
3. **关联性**: 预防记录和财务记录通过 `relatedRecord` 字段关联
4. **索引性能**: 根据查询频率创建合适的复合索引
5. **数据备份**: 建议定期备份重要的财务和预防记录数据

## 测试数据

集合创建完成后，可以插入一些测试数据验证功能：

```javascript
// 在云函数中执行
const insertTestData = async () => {
  const db = cloud.database()
  
  // 插入测试预防记录
  await db.collection('prevention_records').add({
    data: {
      batchId: 'test_batch_001',
      batchNumber: 'TEST-001',
      recordType: 'vaccine',
      preventionType: 'vaccination',
      vaccine: {
        name: '测试疫苗',
        manufacturer: '测试厂家',
        dosage: '1ml'
      },
      vaccination: {
        count: 10
      },
      cost: {
        total: 100
      },
      createdAt: new Date(),
      status: 'completed'
    }
  })
  
  console.log('测试数据插入成功')
}
```
