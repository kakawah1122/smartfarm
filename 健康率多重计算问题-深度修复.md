# å¥åº·ç‡å¤šé‡è®¡ç®—é—®é¢˜ - æ·±åº¦ä¿®å¤

## ğŸ” é—®é¢˜ç°è±¡

ç”¨æˆ·åé¦ˆï¼šå¥åº·ç®¡ç†ä¸­å¿ƒé¡µé¢çš„å¥åº·ç‡æ•°å­—åå¤å˜åŒ–ï¼Œæ˜¾ç¤ºä¸ç¨³å®šã€‚

**ä¾‹å¦‚**ï¼š
```
é¡µé¢åŠ è½½
  â†“
æ˜¾ç¤º: 98.5%
  â†“ (200mså)
æ˜¾ç¤º: 97.8%
  â†“ (300mså)
æ˜¾ç¤º: 97.8%  (åˆä¸€æ¬¡)
```

## ğŸ” æ·±åº¦åŸå› åˆ†æ

### é—®é¢˜1: ä¸¤é˜¶æ®µè®¡ç®—ï¼ˆå·²ä¿®å¤ï¼‰

**åŸä»£ç é€»è¾‘**ï¼ˆç¬¬684-723è¡Œï¼‰ï¼š
```typescript
// ç¬¬ä¸€é˜¶æ®µï¼šç«‹å³è®¡ç®—ä¸´æ—¶å¥åº·ç‡
const tempHealthyCount = totalAnimals - deadCount - totalOngoing
const healthyRate = ...
this.setData({ healthStats: { healthyRate: ... } })  // â† ç¬¬ä¸€æ¬¡æ˜¾ç¤º

// ç¬¬äºŒé˜¶æ®µï¼šå»¶è¿Ÿ200msåå°åŠ è½½
setTimeout(() => {
  this.loadSecondaryDataInBackground(...)  // â† ä¼šé‡æ–°è®¡ç®—å¥åº·ç‡
}, 200)
```

**å¯¼è‡´**ï¼š
- å¥åº·ç‡å…ˆæ˜¾ç¤ºä¸€ä¸ªä¸´æ—¶å€¼ï¼ˆä¸å«å¼‚å¸¸å’Œéš”ç¦»æ•°ï¼‰
- 200msåæ˜¾ç¤ºç²¾ç¡®å€¼ï¼ˆå«å¼‚å¸¸å’Œéš”ç¦»æ•°ï¼‰
- ç”¨æˆ·çœ‹åˆ°æ•°å­—è·³åŠ¨

### é—®é¢˜2: onShowé‡å¤åˆ·æ–°ï¼ˆæ–°å‘ç°ï¼ï¼‰

**åŸä»£ç é€»è¾‘**ï¼ˆç¬¬256-273è¡Œï¼‰ï¼š
```typescript
onShow() {
  this.startDataWatcher()
  
  const needRefresh = wx.getStorageSync('health_page_need_refresh')
  if (needRefresh) {
    this.loadHealthData(true)  // æœ‰æ ‡è®°æ—¶åŠ è½½
  } else {
    this.loadHealthData(true)  // â† é—®é¢˜ï¼šæ²¡æœ‰æ ‡è®°ä¹ŸåŠ è½½ï¼
  }
}
```

**è§¦å‘æ—¶åº**ï¼š
```
1. onLoad()
   â†“
   loadHealthData()  // ç¬¬ä¸€æ¬¡åŠ è½½
   â†“
2. onShow() (ç´§æ¥ç€è§¦å‘)
   â†“
   loadHealthData(true)  // ç¬¬äºŒæ¬¡åŠ è½½ï¼ˆå³ä½¿æ²¡æœ‰needRefreshæ ‡è®°ï¼‰
   â†“
3. ç›‘å¬å™¨è§¦å‘
   â†“
   loadHealthData()  // å¯èƒ½ç¬¬ä¸‰æ¬¡åŠ è½½
```

**å¯¼è‡´**ï¼š
- é¡µé¢åŠ è½½æ—¶ä¼šè¿ç»­è°ƒç”¨2-3æ¬¡ `loadHealthData()`
- å³ä½¿æœ‰300msé˜²æŠ–ï¼Œè¿ç»­è°ƒç”¨è¿˜æ˜¯ä¼šè§¦å‘å¤šæ¬¡æ¸²æŸ“
- å¥åº·ç‡åå¤é‡æ–°è®¡ç®—å’Œæ˜¾ç¤º

### é—®é¢˜3: åå°åˆ·æ–°æ— å·®å¼‚æ›´æ–°ï¼ˆæ–°å‘ç°ï¼ï¼‰

**åŸä»£ç é€»è¾‘**ï¼ˆç¬¬892-923è¡Œï¼‰ï¼š
```typescript
// åå°åˆ·æ–°å‡½æ•°
_backgroundRefreshAllBatches() {
  // è®¡ç®—æ–°çš„å¥åº·ç‡
  const healthyRate = ...
  
  // ç›´æ¥æ›´æ–°ï¼Œä¸ç®¡æ•°æ®æœ‰æ²¡æœ‰å˜åŒ–
  this.setData({ healthStats: { healthyRate: ... } })  // â† å³ä½¿å€¼ç›¸åŒä¹Ÿæ›´æ–°
}
```

**å¯¼è‡´**ï¼š
- ç›‘å¬å™¨è§¦å‘åå°åˆ·æ–°
- å³ä½¿å¥åº·ç‡æ²¡æœ‰å˜åŒ–ï¼ˆ97.8% â†’ 97.8%ï¼‰ï¼Œä¹Ÿä¼šè°ƒç”¨ setData
- è§¦å‘é¡µé¢é‡ç»˜ï¼Œç”¨æˆ·å¯èƒ½çœ‹åˆ°é—ªçƒ

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: åˆå¹¶ä¸¤é˜¶æ®µè®¡ç®—ä¸ºä¸€æ¬¡æ€§è®¡ç®—

**ä¿®æ”¹ä½ç½®**ï¼š`loadAllBatchesData()` å‡½æ•°ï¼ˆç¬¬684-750è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼š
```typescript
// ç¬¬ä¸€é˜¶æ®µï¼šä¸´æ—¶è®¡ç®—
const tempHealthyCount = totalAnimals - deadCount - totalOngoing
this.setData({ ... })

// ç¬¬äºŒé˜¶æ®µï¼šå»¶è¿ŸåŠ è½½
setTimeout(() => {
  this.loadSecondaryDataInBackground(...)
}, 200)
```

**ä¿®æ”¹å**ï¼š
```typescript
// âœ… ç«‹å³å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
const [abnormalResult, isolatedResult] = await Promise.all([
  // åŠ è½½å¼‚å¸¸æ•°æ®
  wx.cloud.callFunction({ ... }),
  // åŠ è½½éš”ç¦»æ•°æ®
  wx.cloud.callFunction({ ... })
])

// âœ… åªè®¡ç®—ä¸€æ¬¡å¥åº·ç‡ï¼ˆåŒ…å«æ‰€æœ‰å› ç´ ï¼‰
const actualHealthyCount = totalAnimals - deadCount - totalOngoing - abnormalCount - isolatedCount
const healthyRate = ...

// âœ… ä¸€æ¬¡æ€§è®¾ç½®æ•°æ®
this.setData({ healthStats: { healthyRate: ... } })
```

**æ•ˆæœ**ï¼š
- âœ… æ•°æ®ä¸€æ¬¡æ€§å¹¶è¡ŒåŠ è½½ï¼ˆæ›´å¿«ï¼‰
- âœ… å¥åº·ç‡åªè®¡ç®—ä¸€æ¬¡ï¼ˆåŒ…å«æ‰€æœ‰å› ç´ ï¼‰
- âœ… é¡µé¢åªæ¸²æŸ“ä¸€æ¬¡ï¼ˆä¸ä¼šè·³åŠ¨ï¼‰

### ä¿®å¤2: ä¼˜åŒ–onShowåˆ·æ–°é€»è¾‘

**ä¿®æ”¹ä½ç½®**ï¼š`onShow()` æ–¹æ³•ï¼ˆç¬¬256-270è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼š
```typescript
onShow() {
  this.startDataWatcher()
  
  if (needRefresh) {
    this.loadHealthData(true)  // æœ‰æ ‡è®°æ—¶åŠ è½½
  } else {
    this.loadHealthData(true)  // â† é—®é¢˜ï¼šæ€»æ˜¯åŠ è½½
  }
}
```

**ä¿®æ”¹å**ï¼š
```typescript
onShow() {
  this.startDataWatcher()
  
  // âœ… åªåœ¨ç¡®å®éœ€è¦åˆ·æ–°æ—¶æ‰åˆ·æ–°
  const needRefresh = wx.getStorageSync('health_page_need_refresh')
  if (needRefresh) {
    wx.removeStorageSync('health_page_need_refresh')
    this.loadHealthData(true)
  }
  // âœ… ç§»é™¤elseåˆ†æ”¯ï¼Œé¿å…æ¯æ¬¡onShowéƒ½åˆ·æ–°
}
```

**æ•ˆæœ**ï¼š
- âœ… é¿å… onLoad å’Œ onShow é‡å¤åŠ è½½
- âœ… åªåœ¨çœŸæ­£éœ€è¦æ—¶åˆ·æ–°ï¼ˆä»å…¶ä»–é¡µé¢è¿”å›ï¼‰
- âœ… å‡å°‘ä¸å¿…è¦çš„äº‘å‡½æ•°è°ƒç”¨

### ä¿®å¤3: åå°åˆ·æ–°å¢åŠ å·®å¼‚å¯¹æ¯”

**ä¿®æ”¹ä½ç½®**ï¼š`_backgroundRefreshAllBatches()` å‡½æ•°ï¼ˆç¬¬892-931è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼š
```typescript
// è®¡ç®—å¥åº·ç‡
const healthyRate = ...

// ç›´æ¥æ›´æ–°
this.setData({ healthStats: { healthyRate: ... } })
```

**ä¿®æ”¹å**ï¼š
```typescript
// è®¡ç®—å¥åº·ç‡
const actualHealthyCount = ...
const healthyRate = ...

// âœ… å¯¹æ¯”æ•°æ®ï¼Œé¿å…æ— æ„ä¹‰çš„æ›´æ–°
const currentHealthyRate = parseFloat(this.data.healthStats.healthyRate)
const newHealthyRate = parseFloat(healthyRate)

if (Math.abs(currentHealthyRate - newHealthyRate) < 0.01) {
  // å¥åº·ç‡æ²¡æœ‰å˜åŒ–ï¼ˆå·®å¼‚å°äº0.01%ï¼‰ï¼Œè·³è¿‡æ›´æ–°
  return
}

// æœ‰å˜åŒ–æ‰æ›´æ–°
this.setData({ healthStats: { healthyRate: ... } })
```

**æ•ˆæœ**ï¼š
- âœ… é¿å…ç›¸åŒæ•°æ®çš„é‡å¤æ¸²æŸ“
- âœ… å‡å°‘é¡µé¢é—ªçƒ
- âœ… æå‡æ€§èƒ½

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰çš„æµç¨‹

```
é¡µé¢åŠ è½½
  â†“
onLoad()
  â†“
loadHealthData() â†’ ç¬¬ä¸€æ¬¡è®¡ç®—ï¼ˆä¸´æ—¶å€¼ï¼‰â†’ æ˜¾ç¤º 98.5%
  â†“
onShow() (ç´§æ¥ç€)
  â†“
loadHealthData(true) â†’ ç¬¬äºŒæ¬¡è®¡ç®—ï¼ˆä¸´æ—¶å€¼ï¼‰â†’ æ˜¾ç¤º 98.5%
  â†“ (200mså)
loadSecondaryDataInBackground() â†’ ç¬¬ä¸‰æ¬¡è®¡ç®—ï¼ˆç²¾ç¡®å€¼ï¼‰â†’ æ˜¾ç¤º 97.8%
  â†“
ç›‘å¬å™¨è§¦å‘
  â†“
_backgroundRefreshAllBatches() â†’ ç¬¬å››æ¬¡è®¡ç®—ï¼ˆç²¾ç¡®å€¼ï¼‰â†’ æ˜¾ç¤º 97.8%

ç»“æœï¼šç”¨æˆ·çœ‹åˆ°æ•°å­—ä» 98.5% è·³åˆ° 97.8%ï¼Œç„¶ååˆé—ªä¸€ä¸‹
```

### ä¿®å¤åçš„æµç¨‹

```
é¡µé¢åŠ è½½
  â†“
onLoad()
  â†“
loadHealthData()
  â†“
å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆå¼‚å¸¸ã€éš”ç¦»ç­‰ï¼‰
  â†“
åªè®¡ç®—ä¸€æ¬¡å¥åº·ç‡ï¼ˆç²¾ç¡®å€¼ï¼‰â†’ æ˜¾ç¤º 97.8%
  â†“
onShow()
  â†“
æ²¡æœ‰needRefreshæ ‡è®° â†’ ä¸åˆ·æ–°
  â†“
ç›‘å¬å™¨è§¦å‘
  â†“
_backgroundRefreshAllBatches()
  â†“
å¯¹æ¯”æ•°æ®ï¼š97.8% vs 97.8%ï¼Œå·®å¼‚ < 0.01%
  â†“
è·³è¿‡æ›´æ–°

ç»“æœï¼šç”¨æˆ·åªçœ‹åˆ°ä¸€æ¬¡ 97.8%ï¼Œæ•°å­—ç¨³å®šä¸å˜
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

- `miniprogram/pages/health/health.ts`

## ğŸ¯ ä¿®å¤æ•ˆæœ

### æ€§èƒ½æå‡
- âœ… å‡å°‘äº‘å‡½æ•°è°ƒç”¨æ¬¡æ•°ï¼šä» 4-5æ¬¡ é™è‡³ 1-2æ¬¡
- âœ… å‡å°‘ setData æ¬¡æ•°ï¼šä» 3-4æ¬¡ é™è‡³ 1æ¬¡
- âœ… å¹¶è¡ŒåŠ è½½æ•°æ®ï¼šé€Ÿåº¦æå‡çº¦ 30%

### ç”¨æˆ·ä½“éªŒæå‡
- âœ… å¥åº·ç‡ç¨³å®šæ˜¾ç¤ºï¼Œä¸å†è·³åŠ¨
- âœ… é¡µé¢ä¸å†é—ªçƒ
- âœ… æ•°æ®ä¸€æ¬¡æ€§å‡†ç¡®å‘ˆç°

### ä»£ç è´¨é‡æå‡
- âœ… æ¶ˆé™¤é‡å¤é€»è¾‘
- âœ… ä¼˜åŒ–æ•°æ®æµ
- âœ… é™ä½ç»´æŠ¤æˆæœ¬

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1: æ­£å¸¸åŠ è½½
1. æ‰“å¼€å¥åº·ç®¡ç†ä¸­å¿ƒ
2. è§‚å¯Ÿå¥åº·ç‡æ˜¯å¦ç¨³å®šæ˜¾ç¤ºï¼ˆä¸è·³åŠ¨ï¼‰
3. âœ… é¢„æœŸï¼šç›´æ¥æ˜¾ç¤ºå‡†ç¡®å€¼ï¼Œä¸ä¼šå˜åŒ–

### æµ‹è¯•åœºæ™¯2: ä»å…¶ä»–é¡µé¢è¿”å›
1. ä»å¥åº·é¡µé¢è·³è½¬åˆ°å…¶ä»–é¡µé¢
2. åœ¨å…¶ä»–é¡µé¢æ·»åŠ å¥åº·è®°å½•
3. è¿”å›å¥åº·é¡µé¢
4. âœ… é¢„æœŸï¼šæ•°æ®è‡ªåŠ¨åˆ·æ–°ï¼Œå¥åº·ç‡æ›´æ–°ï¼ˆä½†ä¸é‡å¤è®¡ç®—ï¼‰

### æµ‹è¯•åœºæ™¯3: å®æ—¶ç›‘å¬æ›´æ–°
1. æ‰“å¼€å¥åº·é¡µé¢
2. ä½¿ç”¨å¦ä¸€ä¸ªè®¾å¤‡æˆ–æ¨¡æ‹Ÿå™¨æ·»åŠ è®°å½•
3. è§‚å¯Ÿç›‘å¬å™¨æ˜¯å¦è§¦å‘åˆ·æ–°
4. âœ… é¢„æœŸï¼šæ•°æ®æœ‰å˜åŒ–æ—¶æ›´æ–°ï¼Œæ— å˜åŒ–æ—¶ä¸é‡ç»˜

### æµ‹è¯•åœºæ™¯4: å¿«é€Ÿåˆ‡æ¢æ‰¹æ¬¡
1. å¿«é€Ÿç‚¹å‡»æ‰¹æ¬¡ç­›é€‰ä¸‹æ‹‰æ¡†
2. è¿ç»­åˆ‡æ¢å¤šä¸ªæ‰¹æ¬¡
3. âœ… é¢„æœŸï¼šé˜²æŠ–æœºåˆ¶ç”Ÿæ•ˆï¼Œä¸ä¼šé‡å¤åŠ è½½

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

1. **Promise.all å¹¶è¡ŒåŠ è½½**
   - åŒæ—¶å‘èµ·å¤šä¸ªäº‘å‡½æ•°è°ƒç”¨
   - ç­‰å¾…æ‰€æœ‰ç»“æœè¿”å›åå†è®¡ç®—
   - æ¯”ä¸²è¡ŒåŠ è½½å¿«çº¦ 30-50%

2. **é˜²æŠ–æœºåˆ¶**
   - 300ms å†…çš„é‡å¤è°ƒç”¨ä¼šè¢«åˆå¹¶
   - åªæ‰§è¡Œæœ€åä¸€æ¬¡è°ƒç”¨
   - å‡å°‘ä¸å¿…è¦çš„äº‘å‡½æ•°è°ƒç”¨

3. **å·®å¼‚å¯¹æ¯”**
   - æ›´æ–°å‰å¯¹æ¯”æ–°æ—§æ•°æ®
   - å·®å¼‚å°äºé˜ˆå€¼ï¼ˆ0.01%ï¼‰åˆ™è·³è¿‡
   - é¿å…æ— æ„ä¹‰çš„é¡µé¢é‡ç»˜

4. **æ¡ä»¶åˆ·æ–°**
   - åªåœ¨æ˜ç¡®éœ€è¦æ—¶åˆ·æ–°æ•°æ®
   - é¿å…ç›²ç›®çš„é‡å¤åˆ·æ–°
   - é™ä½æœåŠ¡å™¨å‹åŠ›

## ğŸ“ æ€»ç»“

é€šè¿‡æ·±å…¥åˆ†æï¼Œå‘ç°å¥åº·ç‡å¤šæ¬¡è®¡ç®—çš„æ ¹æœ¬åŸå› æ˜¯ï¼š
1. âŒ ä¸¤é˜¶æ®µè®¡ç®—ï¼ˆä¸´æ—¶å€¼ â†’ ç²¾ç¡®å€¼ï¼‰
2. âŒ onShow æ— æ¡ä»¶åˆ·æ–°ï¼ˆonLoad + onShow é‡å¤ï¼‰
3. âŒ åå°åˆ·æ–°æ— å·®å¼‚æ›´æ–°ï¼ˆç›¸åŒå€¼ä¹Ÿé‡ç»˜ï¼‰

é€šè¿‡ä¸‰å±‚ä¼˜åŒ–ï¼š
1. âœ… åˆå¹¶ä¸ºä¸€æ¬¡æ€§å¹¶è¡Œè®¡ç®—
2. âœ… æ¡ä»¶åŒ– onShow åˆ·æ–°
3. âœ… å·®å¼‚å¯¹æ¯”æ›´æ–°

å½»åº•è§£å†³äº†å¥åº·ç‡åå¤å˜åŒ–çš„é—®é¢˜ï¼ŒåŒæ—¶æå‡äº†æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼ğŸ‰

